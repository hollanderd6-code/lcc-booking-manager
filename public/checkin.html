<!DOCTYPE html>
<html lang=\"fr\" data-theme=\"light\">
<head>
  <meta charset=\"UTF-8\">
  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
  <title>Check-in en ligne – Bookingmanage</title>
  <link href=\"https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap\" rel=\"stylesheet\">
  <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css\">
  <link rel=\"stylesheet\" href=\"/css/style.css\">
  <style>
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-body, #0f172a);
      color: var(--text-primary, #0f172a);
    }
    .checkin-wrapper {
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }
    .checkin-main {
      flex: 1;
      max-width: 960px;
      margin: 32px auto;
      padding: 16px;
    }
    .checkin-card {
      background: #0b1220;
      border-radius: 18px;
      padding: 24px 20px;
      border: 1px solid rgba(148,163,184,0.3);
      box-shadow: 0 18px 45px rgba(15,23,42,0.7);
    }
    .checkin-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 18px;
    }
    .checkin-title {
      font-size: 22px;
      font-weight: 600;
      color: #e5e7eb;
    }
    .checkin-subtitle {
      font-size: 13px;
      color: #9ca3af;
    }
    .brand-badge {
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
      font-size: 12px;
      color:#9ca3af;
    }
    .brand-logo {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(37,99,235,0.12);
      border:1px solid rgba(37,99,235,0.5);
      color:#dbeafe;
      font-weight:600;
    }
    .checkin-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 18px;
    }
    .checkin-section-title {
      font-size: 14px;
      font-weight: 600;
      color: #e5e7eb;
      margin-bottom: 6px;
    }
    .checkin-section-sub {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 10px;
    }
    .field-group {
      margin-bottom: 10px;
    }
    .field-label {
      display:block;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 2px;
      color: #cbd5f5;
    }
    .field-input, .field-select, .field-textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.8);
      color: #e5e7eb;
      padding: 7px 9px;
      font-size: 13px;
      outline: none;
    }
    .field-input:focus, .field-select:focus, .field-textarea:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.4);
    }
    .field-textarea {
      min-height: 70px;
      resize: vertical;
    }
    .inline-fields {
      display:flex;
      gap:8px;
    }
    .inline-fields .field-group {
      flex:1;
    }
    .checkin-footer {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-top:16px;
      flex-wrap:wrap;
    }
    .checkin-legal {
      font-size:11px;
      color:#9ca3af;
    }
    .checkin-actions {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      border-radius:999px;
      padding:7px 14px;
      border:none;
      font-size:13px;
      cursor:pointer;
      font-weight:500;
      text-decoration:none;
    }
    .btn-primary {
      background:#2563eb;
      color:#eff6ff;
    }
    .btn-ghost {
      background:transparent;
      color:#9ca3af;
      border:1px solid rgba(148,163,184,0.6);
    }
    .btn-outline {
      background:transparent;
      color:#bfdbfe;
      border:1px solid rgba(59,130,246,0.8);
    }
    .signature-box {
      border-radius:12px;
      border:1px dashed rgba(148,163,184,0.7);
      padding:8px;
      background:rgba(15,23,42,0.8);
    }
    .signature-canvas-wrapper {
      border-radius:10px;
      background:#020617;
      overflow:hidden;
      border:1px solid rgba(31,41,55,0.9);
    }
    canvas#signatureCanvas {
      width:100%;
      height:160px;
      display:block;
      background:#020617;
      cursor:crosshair;
    }
    .signature-actions {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:6px;
      font-size:11px;
      color:#9ca3af;
    }
    .status-badge {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 10px;
      border-radius:999px;
      background:rgba(22,163,74,0.18);
      color:#bbf7d0;
      font-size:11px;
      border:1px solid rgba(22,163,74,0.8);
    }
    .checkin-success {
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(22,163,74,0.12);
      border:1px solid rgba(22,163,74,0.6);
      color:#bbf7d0;
      font-size:12px;
      display:none;
    }
    @media (max-width: 800px) {
      .checkin-card {
        padding:18px 14px;
        border-radius:0;
        margin:0 -12px;
      }
      .checkin-main {
        margin:0;
      }
      .checkin-grid {
        grid-template-columns: minmax(0, 1fr);
      }
      .checkin-header {
        flex-direction:column;
        align-items:flex-start;
      }
      .brand-badge {
        align-items:flex-start;
      }
    }
  </style>
  <script src="/js/auth-fetch.js"></script>
</head>
<body>
  <div class=\"checkin-wrapper\">
    <div class=\"checkin-main\">
      <div class=\"checkin-card\">
        <div class=\"checkin-header\">
          <div>
            <div class=\"checkin-title\">
              Check-in en ligne
            </div>
            <div class=\"checkin-subtitle\">
              Merci de compléter ces informations pour préparer au mieux votre arrivée.
            </div>
          </div>
          <div class=\"brand-badge\">
            <div class=\"brand-logo\">
              <i class=\"fas fa-calendar-check\"></i>
              <span>Bookingmanage</span>
            </div>
            <span>Votre espace invité sécurisé</span>
          </div>
        </div>

        <form id=\"checkinForm\">
          <div class=\"checkin-grid\">
            <div>
              <div class=\"checkin-section-title\">Vos informations</div>
              <div class=\"checkin-section-sub\">Ces informations restent confidentielles et servent uniquement à votre hôte.</div>

              <div class=\"inline-fields\">
                <div class=\"field-group\">
                  <label class=\"field-label\" for=\"firstName\">Prénom</label>
                  <input id=\"firstName\" class=\"field-input\" required />
                </div>
                <div class=\"field-group\">
                  <label class=\"field-label\" for=\"lastName\">Nom</label>
                  <input id=\"lastName\" class=\"field-input\" required />
                </div>
              </div>

              <div class=\"field-group\">
                <label class=\"field-label\" for=\"email\">Email</label>
                <input id=\"email\" type=\"email\" class=\"field-input\" required />
              </div>

              <div class=\"field-group\">
                <label class=\"field-label\" for=\"phone\">Téléphone</label>
                <input id=\"phone\" class=\"field-input\" placeholder=\"Ex : +33 6 12 34 56 78\" />
              </div>

              <div class=\"field-group\">
                <label class=\"field-label\" for=\"address\">Adresse postale</label>
                <input id=\"address\" class=\"field-input\" />
              </div>

              <div class=\"checkin-section-title\" style=\"margin-top:14px;\">Séjour</div>
              <div class=\"inline-fields\">
                <div class=\"field-group\">
                  <label class=\"field-label\" for=\"arrivalTime\">Heure d'arrivée estimée</label>
                  <input id=\"arrivalTime\" type=\"time\" class=\"field-input\" />
                </div>
                <div class=\"field-group\">
                  <label class=\"field-label\" for=\"guests\">Nombre de voyageurs</label>
                  <input id=\"guests\" type=\"number\" min=\"1\" class=\"field-input\" />
                </div>
              </div>

              <div class=\"field-group\">
                <label class=\"field-label\" for=\"notes\">Informations complémentaires (enfants, animaux, heure tardive…)</label>
                <textarea id=\"notes\" class=\"field-textarea\"></textarea>
              </div>
            </div>

            <div>
              <div class=\"checkin-section-title\">Documents & signature</div>
              <div class=\"checkin-section-sub\">Ces éléments peuvent être demandés par votre hôte pour des raisons légales.</div>

              <div class=\"field-group\">
                <label class=\"field-label\" for=\"idFront\">Pièce d'identité (recto)</label>
                <input id=\"idFront\" type=\"file\" accept=\"image/*,application/pdf\" class=\"field-input\" />
              </div>
              <div class=\"field-group\">
                <label class=\"field-label\" for=\"idBack\">Pièce d'identité (verso)</label>
                <input id=\"idBack\" type=\"file\" accept=\"image/*,application/pdf\" class=\"field-input\" />
              </div>

              <div class=\"signature-box\">
                <div class=\"field-label\" style=\"margin-bottom:4px;\">Signature électronique</div>
                <div class=\"signature-canvas-wrapper\">
                  <canvas id=\"signatureCanvas\"></canvas>
                </div>
                <div class=\"signature-actions\">
                  <span>Signature conforme à votre document d'identité.</span>
                  <button type=\"button\" class=\"btn btn-ghost btn-xs\" id=\"clearSignatureBtn\">
                    <i class=\"fas fa-eraser\"></i>
                    Effacer
                  </button>
                </div>
              </div>

              <div class=\"field-group\" style=\"margin-top:12px;\">
                <label class=\"field-label\" for=\"accept\">
                  <input id=\"accept\" type=\"checkbox\" required style=\"margin-right:6px;\">
                  J'atteste que les informations fournies sont exactes.
                </label>
              </div>

              <div class=\"checkin-success\" id=\"checkinSuccess\">
                <div style=\"display:flex;align-items:center;gap:8px;\">
                  <i class=\"fas fa-circle-check\"></i>
                  <div>
                    Check-in envoyé ! Votre hôte a bien reçu vos informations.
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class=\"checkin-footer\">
            <div class=\"checkin-legal\">
              Votre check-in est transmis à votre hôte via la plateforme Bookingmanage. Aucune donnée n'est partagée avec des tiers.
            </div>
            <div class=\"checkin-actions\">
              <button type=\"button\" class=\"btn btn-outline\" id=\"downloadPdfBtn\">
                <i class=\"fas fa-file-pdf\"></i>
                Télécharger en PDF
              </button>
              <button type=\"submit\" class=\"btn btn-primary\">
                <i class=\"fas fa-paper-plane\"></i>
                Envoyer le check-in
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    (async function checkSubscriptionAccess() {
    const token = localStorage.getItem('lcc_token');
    
    if (!token) {
      window.location.href = '/login.html';
      return;
    }

    try {
      const res = await fetch('/api/subscription/status', {
        headers: { 'Authorization': 'Bearer ' + token }
      });

      if (!res.ok) {
        if (res.status === 401 || res.status === 403) {
          localStorage.removeItem('lcc_token');
          localStorage.removeItem('lcc_user');
          window.location.href = '/login.html';
        }
        return;
      }

      const data = await res.json();

      if (data.status === 'expired' || data.status === 'canceled') {
        window.location.href = '/subscription-expired.html';
        return;
      }

      if (data.status === 'trial' && data.daysRemaining !== null && data.daysRemaining < 0) {
        window.location.href = '/subscription-expired.html';
        return;
      }

    } catch (err) {
      console.error('Erreur vérification abonnement:', err);
    }
  })();
    (function() {
      const canvas = document.getElementById('signatureCanvas');
      const clearBtn = document.getElementById('clearSignatureBtn');
      let isDrawing = false;
      let ctx;

      function resizeCanvas() {
        if (!canvas) return;
        const rect = canvas.getBoundingClientRect();
        const ratio = window.devicePixelRatio || 1;
        canvas.width = rect.width * ratio;
        canvas.height = 160 * ratio;
        ctx = canvas.getContext('2d');
        ctx.scale(ratio, ratio);
        ctx.fillStyle = '#020617';
        ctx.fillRect(0, 0, rect.width, 160);
        ctx.strokeStyle = '#e5e7eb';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
      }

      function startDraw(e) {
        isDrawing = true;
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
      }
      function endDraw() {
        isDrawing = false;
        ctx && ctx.beginPath();
      }
      function draw(e) {
        if (!isDrawing) return;
        const pos = getPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
      }
      function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
          x: clientX - rect.left,
          y: clientY - rect.top
        };
      }

      if (canvas) {
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mouseup', endDraw);
        canvas.addEventListener('mouseleave', endDraw);
        canvas.addEventListener('mousemove', draw);

        canvas.addEventListener('touchstart', function(e) { e.preventDefault(); startDraw(e); }, { passive: false });
        canvas.addEventListener('touchend', function(e) { e.preventDefault(); endDraw(e); }, { passive: false });
        canvas.addEventListener('touchcancel', function(e) { e.preventDefault(); endDraw(e); }, { passive: false });
        canvas.addEventListener('touchmove', function(e) { e.preventDefault(); draw(e); }, { passive: false });
      }

      if (clearBtn && canvas) {
        clearBtn.addEventListener('click', function() {
          resizeCanvas();
        });
      }

      function getReservationIdFromQuery() {
        const params = new URLSearchParams(window.location.search);
        return params.get('res') || null;
      }

      function collectFormData() {
        const form = document.getElementById('checkinForm');
        const formData = new FormData(form);
        const data = {};
        formData.forEach((v, k) => {
          data[k] = v;
        });
        const reservationId = getReservationIdFromQuery();
        data.reservationId = reservationId;
        if (canvas) {
          try {
            data.signature = canvas.toDataURL('image/png');
          } catch (e) {
            console.error(e);
          }
        }
        data.createdAt = new Date().toISOString();
        return data;
      }

      function saveLocally(data) {
        const key = 'LCC_CHECKINS';
        let all = [];
        try {
          const raw = localStorage.getItem(key);
          if (raw) all = JSON.parse(raw);
        } catch (e) {}
        all.push(data);
        localStorage.setItem(key, JSON.stringify(all));
      }

      function sendToApi(data) {
        // Point d'intégration API future : adapter l'URL à ton backend
        fetch('/api/checkin/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        }).catch(function(err) {
          console.warn('API checkin non joignable, données conservées en local.', err);
        });
      }

      const formEl = document.getElementById('checkinForm');
      const successEl = document.getElementById('checkinSuccess');
      const pdfBtn = document.getElementById('downloadPdfBtn');

      if (formEl) {
        formEl.addEventListener('submit', function(e) {
          e.preventDefault();
          const data = collectFormData();
          saveLocally(data);
          sendToApi(data);
          if (successEl) {
            successEl.style.display = 'block';
          }
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      }

      if (pdfBtn) {
        pdfBtn.addEventListener('click', function() {
          window.print();
        });
      }
    })();
  </script>
</body>
</html>
