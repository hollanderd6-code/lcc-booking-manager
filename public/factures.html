<!DOCTYPE html>

<html data-theme="light" lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
<title>Bookingmanage ‚Äì Factures</title>
<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>
<!-- CSS plateforme -->
<link href="/css/style.css" rel="stylesheet"/><link href="/css/bh-shared.css?v=1" rel="stylesheet"/><link href="/css/bottom-bar-enhanced.css" rel="stylesheet"/><link href="/css/menu-plus-fixes.css" rel="stylesheet"/><link href="/css/menu-active-button.css" rel="stylesheet"/>
<link href="/css/messages-badge-fix.css" rel="stylesheet"/>
<link rel="stylesheet" href="/css/messages-badge-red.css">
<link rel="stylesheet" href="/css/messages-badge-desktop.css">  
<style>
  /* DESIGN SYSTEM inspir√© de factures-proprietaires */
  :root {
    --primary: #10B981;
    --primary-dark: #059669;
    --bg-body: #f3f4f6;
    --paper-shadow: 0 10px 15px -3px rgba(0,0,0,0.1),
                    0 4px 6px -2px rgba(0,0,0,0.05);
  }

  html, body {
    margin: 0 !important;
    background: var(--bg-body);
    font-family: 'Inter', sans-serif;
    height: 100%;
    overflow-x: hidden;
  }

  .app-container {
    display: flex;
    min-height: 100vh;
  }

  /* SIDEBAR ‚Äì m√™me look que factures propri√©taires */
  .sidebar {
    width: 260px;
    background: #ffffff;
    border-right: 1px solid #e5e7eb;
    position: fixed;
    top: 0;
    bottom: 0;
    left: 0;
    z-index: 50;
    display: flex;
    flex-direction: column;
  }

  .sidebar-header {
    padding: 24px;
  }

  .sidebar-logo {
    display: flex;
    align-items: center;
    gap: 10px;
    text-decoration: none;
    color: #111827;
    font-weight: 800;
    font-size: 18px;
  }

  .nav-section-title {
    font-size: 11px;
    font-weight: 700;
    color: #9ca3af;
    text-transform: uppercase;
    margin: 24px 24px 8px;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 24px;
    color: #4b5563;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
    border-right: 3px solid transparent;
  }

  .nav-item:hover {
    background: #f9fafb;
    color: #111827;
  }

  .nav-item.active {
    background: #ecfdf5;
    color: #10B981;
    border-right-color: #10B981;
  }

  .nav-item i {
    width: 20px;
    text-align: center;
  }

  /* MAIN CONTENT */
  /* (patched) removed inline .main-content padding override for iOS safe-area */

  .page-kicker {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #9ca3af;
    margin-bottom: 4px;
  }

  .page-title {
    font-size: 24px;
    font-weight: 700;
    color: #111827;
    margin: 0;
  }

  .page-subtitle {
    font-size: 14px;
    color: #6b7280;
    margin-top: 6px;
  }

  .page-content {
    margin-top: 24px;
    max-width: 1400px;
  }

  /* GRID : formulaire √† gauche, aper√ßu √† droite */
  .invoice-grid {
    display: grid;
    grid-template-columns: 420px 1fr;
    gap: 32px;
    align-items: flex-start;
  }

  @media (max-width: 1024px) {
    .sidebar {
      transform: translateX(-100%);
      transition: transform 0.2s ease;
    }
    .sidebar.active {
      transform: translateX(0);
    }
    /* (patched) removed inline .main-content padding override for iOS safe-area */
    .invoice-grid {
      grid-template-columns: 1fr;
    }
  }

  /* FORMULAIRE */
  .card {
    background: #ffffff;
    border-radius: 16px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }

  .card-header {
    padding: 16px 20px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .card-title {
    font-size: 15px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-body {
    padding: 20px;
  }

  .form-section {
    margin-bottom: 24px;
  }

  .form-section-title {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 12px;
    color: #6b7280;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .form-section-title i {
    color: var(--primary);
    font-size: 14px;
  }

  .form-row {
    margin-bottom: 12px;
  }

  .form-row label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 4px;
    color: #374151;
  }

  .form-row input,
  .form-row select {
    width: 100%;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    font-size: 13px;
    box-sizing: border-box;
  }

  .form-row input:focus,
  .form-row select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(16,185,129,0.12);
  }

  .form-row-inline {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
  }

  @media (max-width: 640px) {
    .form-row-inline {
      grid-template-columns: minmax(0, 1fr);
    }
  }

  .checkbox-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 12px 0;
    font-size: 13px;
  }

  .checkbox-row input[type="checkbox"] {
    width: auto;
    margin: 0;
  }

  .form-divider {
    height: 1px;
    background: #e5e7eb;
    margin: 24px 0;
  }

  /* BOUTONS */
  .form-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 24px;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    text-decoration: none;
  }

  .btn-primary {
    background: var(--primary);
    color: #ffffff;
  }

  .btn-primary:hover {
    background: var(--primary-dark);
  }

  .btn-secondary {
    background: #ffffff;
    border: 1px solid #d1d5db;
    color: #374151;
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* APER√áU : feuille A4 */
  .invoice-preview-card {
    background: transparent;
    border: none;
    padding: 0;
  }

  .invoice-preview-header {
    padding: 0 0 12px 0;
    font-weight: 600;
    color: #4b5563;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .invoice-preview-body {
    padding: 0;
    background: transparent;
    display: flex;
    justify-content: center;
    align-items: flex-start;
  }

  .invoice-paper {
    background: #ffffff;
    width: 100%;
    max-width: 800px;
    min-height: 1000px;
    padding: 48px;
    box-shadow: var(--paper-shadow);
    border-radius: 2px;
    position: relative;
    color: #1f2937;
  }

  .invoice-preview-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 400px;
    color: #9ca3af;
    text-align: center;
  }

  .invoice-preview-empty i {
    font-size: 48px;
    opacity: 0.3;
    margin-bottom: 16px;
  }

  /* CONTENU FACTURE */
  .invoice-header {
    text-align: center;
    margin-bottom: 40px;
    padding-bottom: 24px;
    border-bottom: 3px solid #111827;
  }

  .invoice-header h2 {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 8px;
    color: #111827;
  }

  .invoice-number {
    font-size: 14px;
    color: #6b7280;
    margin-top: 4px;
  }

  .invoice-section {
    margin-bottom: 28px;
  }

  .invoice-section h3 {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #6b7280;
    margin-bottom: 12px;
  }

  .invoice-section-content {
    font-size: 14px;
    line-height: 1.6;
    color: #111827;
  }

  .invoice-line {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #f3f4f6;
    font-size: 14px;
  }

  .invoice-line:last-child {
    border-bottom: none;
  }

  .invoice-subtotal {
    display: flex;
    justify-content: space-between;
    padding: 12px 0;
    font-weight: 600;
    margin-top: 12px;
    border-top: 1px solid #e5e7eb;
  }

  .invoice-total {
    display: flex;
    justify-content: space-between;
    padding: 16px 0;
    font-size: 20px;
    font-weight: 700;
    margin-top: 12px;
    border-top: 3px solid #111827;
    color: var(--primary);
  }

  .paid-stamp {
    text-align: center;
    margin: 32px 0;
    padding: 20px;
    background: rgba(16,185,129,0.08);
    border: 3px solid var(--primary);
    border-radius: 12px;
  }

  .paid-stamp h3 {
    color: var(--primary);
    font-size: 22px;
    font-weight: 700;
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }

  .invoice-footer {
    text-align: center;
    font-size: 11px;
    color: #6b7280;
    margin-top: 32px;
    padding-top: 20px;
    border-top: 1px solid #e5e7eb;
  }

  @media print {
    body {
      background: #ffffff !important;
    }
    body * {
      visibility: hidden;
    }
    .invoice-paper,
    .invoice-paper * {
      visibility: visible;
    }
    .invoice-paper {
      position: absolute;
      inset: 0;
      margin: 0;
      box-shadow: none;
      max-width: none;
      width: 210mm;
      min-height: 0;
    }
  }
    /* Style pour le lien actif dans le sidebar */
.nav-item.active {
  background-color: #10B981;  /* couleur verte, comme pour 'Gestion du m√©nage' */
  color: white;
  border-radius: 20px;  /* bord arrondi comme sur l'image */
  padding: 6px 12px;  /* espacement interne pour plus de confort visuel */
}

/* Survol de l'√©l√©ment actif */
.nav-item.active:hover {
  background-color: #34d399;  /* une teinte plus claire en survol */
  transition: background-color 0.3s ease;
}
  </style>
<script src="/js/auth-fetch.js"></script>
<style>
/* ‚úÖ Uniformisation du bouton "Retour au dashboard" (header) */
.main-header .header-actions .btn.btn-ghost{
  border-radius: 999px !important;
  border: 1px solid rgba(148, 163, 184, 0.45) !important;
  background: transparent !important;
  padding: 10px 16px !important;
  font-size: 14px !important;
  font-weight: 600 !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;
  color: inherit !important;
  box-shadow: none !important;
}
.main-header .header-actions .btn.btn-ghost i{
  font-size: 16px !important;
}
.main-header .header-actions .btn.btn-ghost:hover{
  background: rgba(15, 23, 42, 0.06) !important;
}
[data-theme="dark"] .main-header .header-actions .btn.btn-ghost:hover{
  background: rgba(15, 23, 42, 0.90) !important;
}
</style>
<link rel="stylesheet" href="/css/mobile-native-styles.css">
</head>
<body data-back-href="/app.html" data-back-label="Retour au dashboard" data-kicker="Facturation" data-page="factures" data-subtitle="Cr√©ez, √©ditez et exportez vos factures clients." data-title="Factures clients">
<!-- MOBILE HEADER -->
<div class="mobile-header">
<a class="mobile-logo" href="/app.html">
<i class="fas fa-calendar-check"></i>
<span class="mobile-logo-text">Bookingmanage</span>
</a>
<button class="mobile-menu-btn" id="mobileMenuBtn">
<i class="fas fa-bars"></i>
</button>
</div>
<div class="sidebar-overlay" id="sidebarOverlay"></div>
<div class="app-container">
<!-- Sidebar -->
<div id="bhSidebar"></div>
<!-- Main Content -->
<main class="main-content"><div id="bhHeader"></div>
<!-- Header -->
<!-- Page Content -->
<div class="page-content">
<div class="invoice-grid">
<!-- Formulaire -->
<div>
<div class="card">
<div class="card-header">
<div class="card-title">
<i class="fas fa-file-invoice-dollar"></i>
                  Informations de facturation
                </div>
</div>
<div class="card-body">
<!-- Client -->
<div class="form-section">
<div class="form-section-title">
<i class="fas fa-user"></i>
                    Informations client
                  </div>
<div class="form-row">
<label for="clientName">Nom complet *</label>
<input id="clientName" placeholder="Jean Dupont" required="" type="text"/>
</div>
<div class="form-row">
<label for="clientEmail">Email</label>
<input id="clientEmail" placeholder="client@exemple.com" type="email"/>
</div>
<div class="form-row">
<label for="clientAddress">Adresse</label>
<input id="clientAddress" placeholder="12 rue de la R√©publique" type="text"/>
</div>
<div class="form-row-inline">
<div class="form-row">
<label for="clientPostalCode">Code postal</label>
<input id="clientPostalCode" placeholder="75001" type="text"/>
</div>
<div class="form-row">
<label for="clientCity">Ville</label>
<input id="clientCity" placeholder="Paris" type="text"/>
</div>
</div>
<div class="checkbox-row">
<input id="isCompany" type="checkbox"/>
<label for="isCompany">Client professionnel</label>
</div>
<div class="form-row" id="siretGroup" style="display: none;">
<label for="clientSiret">SIRET</label>
<input id="clientSiret" maxlength="17" placeholder="123 456 789 00012" type="text"/>
</div>
</div>
<div class="form-divider"></div>
<!-- S√©jour -->
<div class="form-section">
<div class="form-section-title">
<i class="fas fa-calendar-alt"></i>
                    S√©jour
                  </div>
<div class="form-row">
<label for="propertyName">Logement *</label>
<select id="propertyName" required="">
<option value="">S√©lectionner un logement...</option>
</select>
</div>
<div class="form-row-inline">
<div class="form-row">
<label for="checkinDate">Date d'arriv√©e</label>
<input id="checkinDate" type="date"/>
</div>
<div class="form-row">
<label for="checkoutDate">Date de d√©part</label>
<input id="checkoutDate" type="date"/>
</div>
</div>
</div>
<div class="form-divider"></div>
<!-- Montants -->
<div class="form-section">
<div class="form-section-title">
<i class="fas fa-euro-sign"></i>
                    Montants
                  </div>
<div class="form-row">
<label for="rentAmount">Loyer (prix total en ‚Ç¨)</label>
<input id="rentAmount" min="0" placeholder="1050.00" step="0.01" type="number"/>
</div>
<div class="form-row">
<label for="touristTaxAmount">Taxe de s√©jour (‚Ç¨)</label>
<input id="touristTaxAmount" min="0" placeholder="35.00" step="0.01" type="number"/>
</div>
<div class="form-row">
<label for="cleaningFee">Frais de m√©nage (‚Ç¨)</label>
<input id="cleaningFee" min="0" placeholder="80.00" step="0.01" type="number"/>
</div>
<div class="checkbox-row">
<input id="withVat" type="checkbox"/>
<label for="withVat">Avec TVA</label>
</div>
<div class="form-row" id="vatGroup" style="display: none;">
<label for="vatRate">Taux de TVA</label>
<select id="vatRate">
<option value="10">10%</option>
<option value="20">20%</option>
</select>
</div>
</div>
<!-- Actions -->
<div class="form-actions">
<button class="btn btn-primary" disabled="" id="sendBtn" onclick="sendInvoice()" type="button">
<i class="fas fa-envelope"></i>
                    Envoyer par email
                  </button>
<button class="btn btn-secondary" disabled="" id="pdfBtn" onclick="downloadPDF()" type="button">
<i class="fas fa-file-pdf"></i>
                    T√©l√©charger PDF
                  </button>
</div>
</div>
</div>
</div>
<!-- Aper√ßu -->
<div class="invoice-preview-card">
<div class="invoice-preview-header">
<i class="fas fa-file-invoice"></i>
              Aper√ßu de la facture
            </div>
<div class="invoice-preview-body">
<div class="invoice-paper" id="invoicePreview">
<div class="invoice-preview-empty">
<i class="fas fa-file-invoice"></i>
<div>
<p style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Aucun aper√ßu</p>
<p style="font-size: 14px;">Remplissez le formulaire pour voir l'aper√ßu en temps r√©el</p>
</div>
</div>
</div>
</div>
</div>
</div><!-- /.invoice-grid -->
</div><!-- /.page-content -->
</main>
</div>
<!-- Scripts -->
<script>
    (async function checkSubscriptionAccess() {
      const token = localStorage.getItem('lcc_token');
      
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      try {
        const res = await fetch('/api/subscription/status', {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (!res.ok) {
          if (res.status === 401 || res.status === 403) {
            localStorage.removeItem('lcc_token');
            localStorage.removeItem('lcc_user');
            window.location.href = '/login.html';
          }
          return;
        }

        const data = await res.json();

        if (data.status === 'expired' || data.status === 'canceled') {
          window.location.href = '/subscription-expired.html';
          return;
        }

        if (data.status === 'trial' && data.daysRemaining !== null && data.daysRemaining < 0) {
          window.location.href = '/subscription-expired.html';
          return;
        }

      } catch (err) {
        console.error('Erreur v√©rification abonnement:', err);
      }
    })();

    document.addEventListener('DOMContentLoaded', async function () {
      const token = localStorage.getItem('lcc_token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      let currentInvoiceId = null;
      let invoiceNumber = '';
      const propertiesByName = {};

      // Load user info pour la sidebar
      const user = JSON.parse(localStorage.getItem('lcc_user') || '{}');
      if (user.firstName) {
        const nameEl = document.getElementById('sidebarUserName');
        const avatarEl = document.getElementById('sidebarUserAvatar');
        if (nameEl) nameEl.textContent = user.firstName + ' ' + (user.lastName || '');
        if (avatarEl) avatarEl.textContent = user.firstName.charAt(0).toUpperCase();
      }
      if (user.company) {
        const companyEl = document.getElementById('sidebarUserCompany');
        if (companyEl) companyEl.textContent = user.company;
      }

      // Logout
      document.getElementById('logoutBtn')?.addEventListener('click', function() {
        localStorage.removeItem('lcc_token');
        localStorage.removeItem('lcc_user');
        window.location.href = '/login.html';
      });

      // Mobile menu
      const menuBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      
      if (menuBtn && sidebar && overlay) {
        menuBtn.addEventListener('click', function() {
          sidebar.classList.toggle('active');
          overlay.classList.toggle('active');
          const icon = menuBtn.querySelector('i');
          if (sidebar.classList.contains('active')) {
            icon.classList.remove('fa-bars');
            icon.classList.add('fa-times');
          } else {
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
          }
        });
        
        overlay.addEventListener('click', function() {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          const icon = menuBtn.querySelector('i');
          icon.classList.remove('fa-times');
          icon.classList.add('fa-bars');
        });
      }

      // Toggle SIRET
      document.getElementById('isCompany').addEventListener('change', function() {
        document.getElementById('siretGroup').style.display = this.checked ? 'block' : 'none';
      });

      // Toggle TVA
      document.getElementById('withVat').addEventListener('change', function() {
        document.getElementById('vatGroup').style.display = this.checked ? 'block' : 'none';
        if (document.getElementById('clientName').value && document.getElementById('propertyName').value) {
          generateInvoice();
        }
      });

      // Format SIRET
      document.getElementById('clientSiret').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '').substring(0, 14);
        let formatted = '';
        if (value.length > 0) formatted = value.substring(0, 3);
        if (value.length > 3) formatted += ' ' + value.substring(3, 6);
        if (value.length > 6) formatted += ' ' + value.substring(6, 9);
        if (value.length > 9) formatted += ' ' + value.substring(9, 14);
        e.target.value = formatted;
      });

      // Calcul des nuits
      function calculateNights() {
        const checkin = document.getElementById('checkinDate').value;
        const checkout = document.getElementById('checkoutDate').value;
        if (checkin && checkout) {
          const date1 = new Date(checkin);
          const date2 = new Date(checkout);
          const nights = Math.ceil((date2 - date1) / (1000 * 60 * 60 * 24));
          return nights;
        }
        return 0;
      }

      document.getElementById('checkoutDate').addEventListener('change', calculateNights);
      document.getElementById('checkinDate').addEventListener('change', calculateNights);
     
      function getSelectedPropertyAddress() {
        const select = document.getElementById('propertyName');
        if (!select) return '';

        const selectedOption = select.options[select.selectedIndex];
        let address = selectedOption && selectedOption.dataset.address
          ? selectedOption.dataset.address
          : '';

        if (!address && propertiesByName[select.value]) {
          const prop = propertiesByName[select.value];
          address =
            prop.address ||
            prop.propertyAddress ||
            prop.addressLine ||
            '';
        }

        return address || '';
      }

      // Charger les logements
      async function loadProperties() {
        try {
          const response = await fetch('/api/properties', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          
          if (response.ok) {
            const data = await response.json();
            const select = document.getElementById('propertyName');

            data.properties.forEach(prop => {
              const option = document.createElement('option');
              option.value = prop.name;
              option.textContent = prop.name;
              option.dataset.address = prop.address || '';

              select.appendChild(option);
              propertiesByName[prop.name] = prop;
            });
          } else {
            console.error('Erreur chargement logements:', response.status);
          }
        } catch (err) {
          console.error('Erreur chargement logements:', err);
        }
      }

      // G√©n√©rer l'aper√ßu
      window.generateInvoice = function() {
        const clientName = document.getElementById('clientName').value;
        const propertyName = document.getElementById('propertyName').value;
        const propertyAddress = getSelectedPropertyAddress();

        if (!clientName || !propertyName) {
          return;
        }

        const profile = JSON.parse(localStorage.getItem('lcc_settings_profile') || '{}');
        
        const rentAmount = parseFloat(document.getElementById('rentAmount').value || 0);
        const touristTaxAmount = parseFloat(document.getElementById('touristTaxAmount').value || 0);
        const cleaningFee = parseFloat(document.getElementById('cleaningFee').value || 0);
        const withVat = document.getElementById('withVat').checked;
        const vatRate = withVat ? parseFloat(document.getElementById('vatRate').value) : 0;

        const subtotal = rentAmount + touristTaxAmount + cleaningFee;
        const vatAmount = withVat ? subtotal * (vatRate / 100) : 0;
        const total = subtotal + vatAmount;

        const nights = calculateNights();
        const checkin = document.getElementById('checkinDate').value;
        const checkout = document.getElementById('checkoutDate').value;

        invoiceNumber = invoiceNumber || 'FACT-XXX';

        const preview = `
          <div class="invoice-header">
            <h2>${profile.company || user.company || 'Ma Conciergerie'}</h2>
            <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">
              ${profile.address || ''}
              ${profile.address && (profile.postalCode || profile.city) ? '<br>' : ''}
              ${profile.postalCode || ''} ${profile.city || ''}
              ${profile.siret ? '<br>SIRET: ' + profile.siret : ''}
              ${user.email ? '<br>' + user.email : ''}
            </div>
            <div class="invoice-number" style="margin-top: 16px; font-size: 16px; font-weight: 600;">FACTURE N¬∞ ${invoiceNumber}</div>
            <div class="invoice-number">Date: ${new Date().toLocaleDateString('fr-FR')}</div>
          </div>

          <div class="invoice-section">
            <h3>Facturer √†</h3>
            <div class="invoice-section-content">
              <strong>${clientName}</strong><br>
              ${document.getElementById('clientAddress').value ? document.getElementById('clientAddress').value + '<br>' : ''}
              ${document.getElementById('clientPostalCode').value || ''} ${document.getElementById('clientCity').value || ''}
              ${document.getElementById('isCompany').checked && document.getElementById('clientSiret').value ? '<br>SIRET: ' + document.getElementById('clientSiret').value : ''}
            </div>
          </div>

          <div class="invoice-section">
            <h3>S√©jour</h3>
            <div class="invoice-section-content">
              <strong>${propertyName}</strong>
              ${propertyAddress ? '<br>' + propertyAddress : ''}
              ${checkin && checkout 
                ? '<br>Du ' + new Date(checkin).toLocaleDateString('fr-FR') +
                  ' au ' + new Date(checkout).toLocaleDateString('fr-FR') +
                  (nights ? ' (' + nights + ' ' + (nights > 1 ? 'nuits' : 'nuit') + ')' : '')
                : ''}
            </div>
          </div>

          <div class="invoice-section">
            <h3>D√©tails</h3>
            ${rentAmount > 0 ? '<div class="invoice-line"><span>Loyer</span><span>' + rentAmount.toFixed(2) + ' ‚Ç¨</span></div>' : ''}
            ${touristTaxAmount > 0 ? '<div class="invoice-line"><span>Taxes de s√©jour</span><span>' + touristTaxAmount.toFixed(2) + ' ‚Ç¨</span></div>' : ''}
            ${cleaningFee > 0 ? '<div class="invoice-line"><span>Frais de m√©nage</span><span>' + cleaningFee.toFixed(2) + ' ‚Ç¨</span></div>' : ''}
          </div>

          <div class="invoice-subtotal">
            <span>Sous-total</span>
            <span>${subtotal.toFixed(2)} ‚Ç¨</span>
          </div>
          ${withVat ? '<div class="invoice-line"><span>TVA (' + vatRate + '%)</span><span>' + vatAmount.toFixed(2) + ' ‚Ç¨</span></div>' : ''}

          <div class="invoice-total">
            <span>TOTAL TTC</span>
            <span>${total.toFixed(2)} ‚Ç¨</span>
          </div>

          <div class="paid-stamp">
            <h3><i class="fas fa-check-circle"></i> FACTURE ACQUITT√âE</h3>
          </div>

          <div class="invoice-footer">
            ${!withVat ? 'TVA non applicable - Art. 293B du CGI' : ''}
          </div>
        `;

        document.getElementById('invoicePreview').innerHTML = preview;

        const sendBtn = document.getElementById('sendBtn');
        if (sendBtn) sendBtn.disabled = false;
      };

      // Envoyer la facture
      window.sendInvoice = async function() {
        const clientEmail = document.getElementById('clientEmail').value;
        if (!clientEmail) {
          alert("Veuillez renseigner l'email du client");
          return;
        }

        if (!confirm("Envoyer la facture par email √† " + clientEmail + " ?")) return;

        const data = {
          clientName: document.getElementById('clientName').value,
          clientEmail: clientEmail,
          clientAddress: document.getElementById('clientAddress').value,
          clientPostalCode: document.getElementById('clientPostalCode').value,
          clientCity: document.getElementById('clientCity').value,
          clientSiret: document.getElementById('isCompany').checked ? document.getElementById('clientSiret').value : '',
          propertyName: document.getElementById('propertyName').value,
          propertyAddress: getSelectedPropertyAddress(),
          checkinDate: document.getElementById('checkinDate').value,
          checkoutDate: document.getElementById('checkoutDate').value,
          nights: calculateNights(),
          rentAmount: document.getElementById('rentAmount').value,
          touristTaxAmount: document.getElementById('touristTaxAmount').value,
          cleaningFee: document.getElementById('cleaningFee').value,
          vatRate: document.getElementById('withVat').checked ? document.getElementById('vatRate').value : 0,
          sendEmail: true
        };

        try {
          console.log('üì§ Envoi des donn√©es:', data);
          
          const response = await fetch('/api/invoice/create', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(data)
          });

          console.log('üì• R√©ponse status:', response.status);
          
          const text = await response.text();
          console.log('üì• R√©ponse brute:', text);
          
          let result = null;
          try {
            result = JSON.parse(text);
          } catch (e) {
            console.error('‚ùå Erreur parsing JSON:', e);
            alert("‚ùå Erreur serveur : La r√©ponse n'est pas au bon format.\n\nV√©rifie les logs de la console (F12)");
            return;
          }

          if (response.ok && result) {
            currentInvoiceId = result.invoiceId || null;
            invoiceNumber = result.invoiceNumber || '';

            alert("‚úÖ Facture " + (invoiceNumber || '') + " cr√©√©e et envoy√©e par email !");

            if (invoiceNumber) {
              generateInvoice(); // R√©g√©n√©rer avec le bon num√©ro
            }

            const pdfBtn = document.getElementById('pdfBtn');
            if (pdfBtn) pdfBtn.disabled = false;

            const sendBtn = document.getElementById('sendBtn');
            if (sendBtn) sendBtn.disabled = true;
          } else {
            console.error('‚ùå Erreur API:', result);
            alert("‚ö†Ô∏è Erreur: " + (result.error || 'Erreur inconnue') + "\n\nV√©rifie les logs de la console (F12)");
            const pdfBtn = document.getElementById('pdfBtn');
            if (pdfBtn) pdfBtn.disabled = false;
          }
        } catch (err) {
          console.error('‚ùå Erreur r√©seau:', err);
          alert("‚ùå Erreur technique : " + (err.message || err) + "\n\nV√©rifie les logs de la console (F12)");
        }
      };

      // T√©l√©charger PDF (force le download)
      window.downloadPDF = function() {
        window.print();
      };

      // Auto-update preview
      ['clientName', 'propertyName', 'rentAmount', 'touristTaxAmount', 'cleaningFee', 'vatRate', 'checkinDate', 'checkoutDate'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('input', generateInvoice);
          el.addEventListener('change', generateInvoice);
        }
      });

      // Init
      loadProperties();
    });
  </script>
<script src="/js/bh-layout.js"></script>
<script src="/js/mobile-native-experience.js"></script>
<script src="/js/mobile-tabs-handler.js"></script>
<script src="/js/messages-badge-desktop-mobile.js"></script>
<!-- Socket.io pour le temps r√©el -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>  
</body>
</html>
