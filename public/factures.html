<!DOCTYPE html>

<html data-theme="light" lang="fr" data-theme-v3="1">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
<title>Bookingmanage ‚Äì Factures</title>
<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet"/>
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>
<!-- CSS plateforme -->
<link href="/css/style.css" rel="stylesheet"/>
<link href="/css/bh-theme-v3.css" rel="stylesheet"/><link href="/css/bh-shared.css?v=1" rel="stylesheet"/><link href="/css/bottom-bar-enhanced.css" rel="stylesheet"/><link href="/css/tablet-bottom-bar-fix.css" rel="stylesheet"/><link href="/css/menu-plus-fixes.css" rel="stylesheet"/><link href="/css/menu-active-button.css" rel="stylesheet"/>
<link href="/css/messages-badge-fix.css" rel="stylesheet"/>
<link rel="stylesheet" href="/css/messages-badge-red.css">
<link rel="stylesheet" href="/css/messages-badge-desktop.css">  
<style>
  /* DESIGN SYSTEM inspir√© de factures-proprietaires */
  :root {
    --primary: #10B981;
    --primary-dark: #059669;
    --bg-body: #f3f4f6;
    --paper-shadow: 0 10px 15px -3px rgba(0,0,0,0.1),
                    0 4px 6px -2px rgba(0,0,0,0.05);
  }

  html, body {
    margin: 0 !important;
    background: var(--bg-body);
    font-family: 'Inter', sans-serif;
    height: 100%;
    overflow-x: hidden;
  }

  .app-container {
    display: flex;
    min-height: 100vh;
  }

  /* SIDEBAR ‚Äì m√™me look que factures propri√©taires */
  .sidebar {
    width: 260px;
    background: #ffffff;
    border-right: 1px solid #e5e7eb;
    position: fixed;
    top: 0;
    bottom: 0;
    left: 0;
    z-index: 50;
    display: flex;
    flex-direction: column;
  }

  .sidebar-header {
    padding: 24px;
  }

  .sidebar-logo {
    display: flex;
    align-items: center;
    gap: 10px;
    text-decoration: none;
    color: #111827;
    font-weight: 800;
    font-size: 18px;
  }

  .nav-section-title {
    font-size: 11px;
    font-weight: 700;
    color: #9ca3af;
    text-transform: uppercase;
    margin: 24px 24px 8px;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 24px;
    color: #4b5563;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
    border-right: 3px solid transparent;
  }

  .nav-item:hover {
    background: #f9fafb;
    color: #111827;
  }

  .nav-item.active {
    background: #ecfdf5;
    color: #10B981;
    border-right-color: #10B981;
  }

  .nav-item i {
    width: 20px;
    text-align: center;
  }

  /* MAIN CONTENT */
  /* (patched) removed inline .main-content padding override for iOS safe-area */

  .page-kicker {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #9ca3af;
    margin-bottom: 4px;
  }

  .page-title {
    font-size: 24px;
    font-weight: 700;
    color: #111827;
    margin: 0;
  }

  .page-subtitle {
    font-size: 14px;
    color: #6b7280;
    margin-top: 6px;
  }

  .page-content {
    margin-top: 24px;
    max-width: 1400px;
  }

  /* GRID : formulaire √† gauche, aper√ßu √† droite */
  .invoice-grid {
    display: grid;
    grid-template-columns: 420px 1fr;
    gap: 32px;
    align-items: flex-start;
  }

  @media (max-width: 1024px) {
    .sidebar {
      transform: translateX(-100%);
      transition: transform 0.2s ease;
    }
    .sidebar.active {
      transform: translateX(0);
    }
    /* (patched) removed inline .main-content padding override for iOS safe-area */
    .invoice-grid {
      grid-template-columns: 1fr;
    }
  }

  /* FORMULAIRE */
  .card {
    background: #ffffff;
    border-radius: 16px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }

  .card-header {
    padding: 16px 20px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .card-title {
    font-size: 15px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-body {
    padding: 20px;
  }

  .form-section {
    margin-bottom: 24px;
  }

  .form-section-title {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 12px;
    color: #6b7280;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .form-section-title i {
    color: var(--primary);
    font-size: 14px;
  }

  .form-row {
    margin-bottom: 12px;
  }

  .form-row label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 4px;
    color: #374151;
  }

  .form-row input,
  .form-row select {
    width: 100%;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    font-size: 13px;
    box-sizing: border-box;
  }

  .form-row input:focus,
  .form-row select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(16,185,129,0.12);
  }

  .form-row-inline {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
  }

  @media (max-width: 640px) {
    .form-row-inline {
      grid-template-columns: minmax(0, 1fr);
    }
  }

  .checkbox-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 12px 0;
    font-size: 13px;
  }

  .checkbox-row input[type="checkbox"] {
    width: auto;
    margin: 0;
  }

  .form-divider {
    height: 1px;
    background: #e5e7eb;
    margin: 24px 0;
  }

  /* BOUTONS */
  .form-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 24px;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    text-decoration: none;
  }

  .btn-primary {
    background: var(--primary);
    color: #ffffff;
  }

  .btn-primary:hover {
    background: var(--primary-dark);
  }

  .btn-secondary {
    background: #ffffff;
    border: 1px solid #d1d5db;
    color: #374151;
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* APER√áU : feuille A4 */
  .invoice-preview-card {
    background: transparent;
    border: none;
    padding: 0;
  }

  .invoice-preview-header {
    padding: 0 0 12px 0;
    font-weight: 600;
    color: #4b5563;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .invoice-preview-body {
    padding: 0;
    background: transparent;
    display: flex;
    justify-content: center;
    align-items: flex-start;
  }

  .invoice-paper {
    background: #ffffff;
    width: 100%;
    max-width: 800px;
    min-height: 1000px;
    padding: 48px;
    box-shadow: var(--paper-shadow);
    border-radius: 2px;
    position: relative;
    color: #1f2937;
  }

  .invoice-preview-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 400px;
    color: #9ca3af;
    text-align: center;
  }

  .invoice-preview-empty i {
    font-size: 48px;
    opacity: 0.3;
    margin-bottom: 16px;
  }

  /* CONTENU FACTURE */
  .invoice-header {
    text-align: center;
    margin-bottom: 40px;
    padding-bottom: 24px;
    border-bottom: 3px solid #111827;
  }

  .invoice-header h2 {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 8px;
    color: #111827;
  }

  .invoice-number {
    font-size: 14px;
    color: #6b7280;
    margin-top: 4px;
  }

  .invoice-section {
    margin-bottom: 28px;
  }

  .invoice-section h3 {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #6b7280;
    margin-bottom: 12px;
  }

  .invoice-section-content {
    font-size: 14px;
    line-height: 1.6;
    color: #111827;
  }

  .invoice-line {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #f3f4f6;
    font-size: 14px;
  }

  .invoice-line:last-child {
    border-bottom: none;
  }

  .invoice-subtotal {
    display: flex;
    justify-content: space-between;
    padding: 12px 0;
    font-weight: 600;
    margin-top: 12px;
    border-top: 1px solid #e5e7eb;
  }

  .invoice-total {
    display: flex;
    justify-content: space-between;
    padding: 16px 0;
    font-size: 20px;
    font-weight: 700;
    margin-top: 12px;
    border-top: 3px solid #111827;
    color: var(--primary);
  }

  .paid-stamp {
    text-align: center;
    margin: 32px 0;
    padding: 20px;
    background: rgba(16,185,129,0.08);
    border: 3px solid var(--primary);
    border-radius: 12px;
  }

  .paid-stamp h3 {
    color: var(--primary);
    font-size: 22px;
    font-weight: 700;
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }

  .invoice-footer {
    text-align: center;
    font-size: 11px;
    color: #6b7280;
    margin-top: 32px;
    padding-top: 20px;
    border-top: 1px solid #e5e7eb;
  }

  @media print {
    body {
      background: #ffffff !important;
    }
    body * {
      visibility: hidden;
    }
    .invoice-paper,
    .invoice-paper * {
      visibility: visible;
    }
    .invoice-paper {
      position: absolute;
      inset: 0;
      margin: 0;
      box-shadow: none;
      max-width: none;
      width: 210mm;
      min-height: 0;
    }
  }
    /* Style pour le lien actif dans le sidebar */
.nav-item.active {
  background-color: #10B981;  /* couleur verte, comme pour 'Gestion du m√©nage' */
  color: white;
  border-radius: 20px;  /* bord arrondi comme sur l'image */
  padding: 6px 12px;  /* espacement interne pour plus de confort visuel */
}

/* Survol de l'√©l√©ment actif */
.nav-item.active:hover {
  background-color: #34d399;  /* une teinte plus claire en survol */
  transition: background-color 0.3s ease;
}
  /* ============================================================
   DARK BAR + STICKY HEADER (identical to app.html)
   ============================================================ */
html[data-theme-v3="1"] body { padding-top: 40px !important; }
html[data-theme-v3="1"] .sidebar {
  position: fixed !important; top: 40px !important;
  left: 0 !important; bottom: 0 !important;
  height: auto !important;
  z-index: 30 !important;
}
html[data-theme-v3="1"] header.main-header {
  position: sticky !important;
  top: 0 !important;
  z-index: 50 !important;
  margin-top: 0 !important;
}
html[data-theme-v3="1"] main.main-content {
  padding-top: 0 !important;
  margin-top: 0 !important;
  position: relative !important;
  z-index: 35 !important;
}
html[data-theme-v3="1"] .app-container {
  margin-top: 0 !important;
  padding-top: 0 !important;
}
/* Tuer tout espace parasite entre barre dark et header */
html[data-theme-v3="1"] main.main-content > header.main-header {
  margin-top: 0 !important;
  padding-top: 0 !important;
}

/* ‚îÄ‚îÄ BARRE DARK EN HAUT ‚îÄ‚îÄ */
html[data-theme-v3="1"] .bh-demo-nav {
  position: fixed;
  top: 0; left: 0; right: 0;
  z-index: 9999;
  background: #0D1117;
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 0 16px;
  height: 40px;
  font-family: 'DM Sans', sans-serif;
  font-size: 12px;
  /* Pour le centrage absolu des badges */
  position: fixed;
}
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-label {
  color: rgba(255,255,255,.4);
  font-weight: 500;
  margin-right: 6px;
  letter-spacing: .08em;
  text-transform: uppercase;
  font-size: 11px;
  white-space: nowrap;
}
html[data-theme-v3="1"] .bh-demo-nav a.bh-demo-btn,
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-btn {
  padding: 4px 13px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.15);
  background: transparent;
  color: rgba(255,255,255,.6);
  cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  font-size: 11.5px;
  font-weight: 500;
  transition: all .2s;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  text-decoration: none;
  white-space: nowrap;
}
html[data-theme-v3="1"] .bh-demo-nav a.bh-demo-btn:hover,
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-btn:hover {
  background: rgba(255,255,255,.1);
  color: white;
}
html[data-theme-v3="1"] .bh-demo-nav a.bh-demo-btn.active,
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-btn.active {
  background: #1A7A5E;
  color: white;
  border-color: #1A7A5E;
}
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-right {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-mode-label {
  color: rgba(255,255,255,.4);
  font-size: 10.5px;
  font-weight: 500;
  letter-spacing: .07em;
  text-transform: uppercase;
}
html[data-theme-v3="1"] .bh-theme-toggle {
  width: 44px;
  height: 24px;
  background: rgba(255,255,255,.15);
  border-radius: 999px;
  border: none;
  cursor: pointer;
  position: relative;
  transition: background .2s;
  flex-shrink: 0;
}
html[data-theme-v3="1"] .bh-theme-toggle::after {
  content: '';
  position: absolute;
  top: 3px; left: 3px;
  width: 18px; height: 18px;
  background: white;
  border-radius: 50%;
  transition: transform .2s;
}
html[data-theme-v3="1"][data-theme="dark"] .bh-theme-toggle { background: #1A7A5E; }
html[data-theme-v3="1"][data-theme="dark"] .bh-theme-toggle::after { transform: translateX(20px); }


/* ============================================================
   PAGE FACTURES ‚Äî V3
   ============================================================ */
html[data-theme-v3="1"],
html[data-theme-v3="1"] body {
  overflow: hidden !important;
  height: 100% !important;
  font-family: 'DM Sans', sans-serif !important;
  background: #F5F2EC !important;
}
html[data-theme-v3="1"] .app-container {
  height: calc(100vh - 40px) !important;
  overflow: hidden !important;
}
html[data-theme-v3="1"] main.main-content {
  overflow-y: auto !important;
  height: 100% !important;
  background: #F5F2EC !important;
  padding-top: 70px !important;
}
html[data-theme-v3="1"] header.main-header {
  position: fixed !important;
  top: 40px !important;
  left: 0 !important; right: 0 !important;
  z-index: 50 !important;
  margin-left: 260px !important;
}
@media(max-width:768px){
  html[data-theme-v3="1"] header.main-header { margin-left: 0 !important; }
}
html[data-theme-v3="1"] .sidebar { z-index: 30 !important; }
html[data-theme-v3="1"] .header-actions .btn-ghost,
html[data-theme-v3="1"] .header-actions .btn.btn-ghost { display: none !important; }

/* Back button */
.factures-back-btn {
  display: inline-flex; align-items: center; gap: 8px;
  height: 40px; padding: 0 20px; border: none; border-radius: 12px;
  background: #1A7A5E; color: white; font-family: 'DM Sans', sans-serif;
  font-size: 14px; font-weight: 600; cursor: pointer; transition: background .15s;
  white-space: nowrap; position: fixed; top: calc(40px + 13px); right: 24px; z-index: 200;
}
.factures-back-btn:hover { background: #15624B; }

/* Page content */
html[data-theme-v3="1"] .page-content {
  padding: 24px !important;
  max-width: 1400px;
  margin: 0 auto;
}

/* Cards */
html[data-theme-v3="1"] .card {
  background: #F5F0E8 !important;
  border: 1px solid rgba(200,184,154,.4) !important;
  border-radius: 16px !important;
  box-shadow: none !important;
}
html[data-theme-v3="1"] .card-header {
  background: rgba(245,240,232,.8) !important;
  border-bottom: 1px solid rgba(200,184,154,.35) !important;
  border-radius: 16px 16px 0 0 !important;
}
html[data-theme-v3="1"] .card-title {
  font-family: 'DM Sans', sans-serif !important;
  font-weight: 700 !important; font-size: 14px !important;
  color: #0D1117 !important;
}

/* Invoice preview card */
html[data-theme-v3="1"] .invoice-preview-card {
  background: white !important;
  border: 1px solid rgba(200,184,154,.4) !important;
  border-radius: 16px !important;
  box-shadow: 0 4px 24px rgba(13,17,23,.08) !important;
}

/* Form sections */
html[data-theme-v3="1"] .form-section-title {
  font-family: 'DM Sans', sans-serif !important;
  font-size: 12px !important; font-weight: 700 !important;
  text-transform: uppercase !important; letter-spacing: .06em !important;
  color: #7A8695 !important;
}
html[data-theme-v3="1"] .form-divider {
  border-color: rgba(200,184,154,.4) !important;
}

/* Inputs */
html[data-theme-v3="1"] input[type=text],
html[data-theme-v3="1"] input[type=email],
html[data-theme-v3="1"] input[type=number],
html[data-theme-v3="1"] input[type=date],
html[data-theme-v3="1"] textarea,
html[data-theme-v3="1"] select {
  background: rgba(255,255,255,.7) !important;
  border-color: rgba(13,17,23,.12) !important;
  border-radius: 10px !important;
  font-family: 'DM Sans', sans-serif !important;
}
html[data-theme-v3="1"] input:focus,
html[data-theme-v3="1"] textarea:focus,
html[data-theme-v3="1"] select:focus {
  background: white !important;
  border-color: #1A7A5E !important;
  box-shadow: 0 0 0 3px rgba(26,122,94,.08) !important;
  outline: none !important;
}

/* Buttons */
html[data-theme-v3="1"] .btn-primary,
html[data-theme-v3="1"] button[type=submit] {
  background: #1A7A5E !important;
  border-color: #1A7A5E !important;
  border-radius: 10px !important;
  font-family: 'DM Sans', sans-serif !important;
  font-weight: 600 !important;
}
html[data-theme-v3="1"] .btn-primary:hover { background: #15624B !important; }
html[data-theme-v3="1"] .btn-secondary,
html[data-theme-v3="1"] .btn-ghost {
  border-radius: 10px !important;
  font-family: 'DM Sans', sans-serif !important;
  font-weight: 600 !important;
}
</style>
<script src="/js/auth-fetch.js"></script>
<style>
/* ‚úÖ Uniformisation du bouton "Retour au dashboard" (header) */
.main-header .header-actions .btn.btn-ghost{
  border-radius: 999px !important;
  border: 1px solid rgba(148, 163, 184, 0.45) !important;
  background: transparent !important;
  padding: 10px 16px !important;
  font-size: 14px !important;
  font-weight: 600 !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;
  color: inherit !important;
  box-shadow: none !important;
}
.main-header .header-actions .btn.btn-ghost i{
  font-size: 16px !important;
}
.main-header .header-actions .btn.btn-ghost:hover{
  background: rgba(15, 23, 42, 0.06) !important;
}
[data-theme="dark"] .main-header .header-actions .btn.btn-ghost:hover{
  background: rgba(15, 23, 42, 0.90) !important;
}
</style>
<link rel="stylesheet" href="/css/mobile-native-styles.css">
</head>
<body data-back-href="/app.html" data-back-label="Retour au dashboard" data-kicker="Facturation" data-page="factures" data-subtitle="Cr√©ez, √©ditez et exportez vos factures clients." data-title="Factures clients">

<!-- Dark bar -->
<div class="bh-demo-nav" id="bhTopBar">
  <!-- Connexions centr√©es -->
  <div style="position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:16px;">

    <!-- Airbnb -->
    <div style="display:flex;align-items:center;gap:7px;">
      <i class="fa-brands fa-airbnb" style="font-size:15px;color:#FF5A5F;"></i>
      <span style="color:rgba(255,255,255,.7);font-size:12px;font-weight:500;">Airbnb</span>
      <span id="topbar-status-airbnb" style="font-size:11px;font-weight:600;padding:2px 9px;border-radius:999px;background:rgba(239,68,68,.2);color:#F87171;border:1px solid rgba(239,68,68,.35);">
        <i class="fas fa-circle" style="font-size:7px;margin-right:3px;vertical-align:middle;"></i>Non connect√©
      </span>
    </div>

    <div style="width:1px;height:16px;background:rgba(255,255,255,.1);"></div>

    <!-- Booking.com -->
    <div style="display:flex;align-items:center;gap:7px;">
      <span style="font-size:13px;font-weight:800;color:#003580;">B.</span>
      <span style="color:rgba(255,255,255,.7);font-size:12px;font-weight:500;">Booking.com</span>
      <span id="topbar-status-booking" style="font-size:11px;font-weight:600;padding:2px 9px;border-radius:999px;background:rgba(239,68,68,.2);color:#F87171;border:1px solid rgba(239,68,68,.35);">
        <i class="fas fa-circle" style="font-size:7px;margin-right:3px;vertical-align:middle;"></i>Non connect√©
      </span>
    </div>

    <div style="width:1px;height:16px;background:rgba(255,255,255,.1);"></div>

    <!-- Stripe -->
    <div style="display:flex;align-items:center;gap:7px;">
      <i class="fa-brands fa-stripe-s" style="font-size:17px;color:#6772E5;"></i>
      <span style="color:rgba(255,255,255,.7);font-size:12px;font-weight:500;">Stripe</span>
      <span id="topbar-status-stripe" style="font-size:11px;font-weight:600;padding:2px 9px;border-radius:999px;background:rgba(239,68,68,.2);color:#F87171;border:1px solid rgba(239,68,68,.35);">
        <i class="fas fa-circle" style="font-size:7px;margin-right:3px;vertical-align:middle;"></i>Non connect√©
      </span>
    </div>

  </div>

  <!-- Toggle dark mode (droite) -->
  <div class="bh-demo-right">
    <span class="bh-demo-mode-label">Mode</span>
    <button class="bh-theme-toggle" id="bhThemeToggleDark" onclick="document.documentElement.getAttribute('data-theme')==='dark'?document.documentElement.setAttribute('data-theme','light'):document.documentElement.setAttribute('data-theme','dark')"></button>
  </div>
</div>

<script>
// Mise √† jour des statuts de connexion dans la top bar
(function updateTopBarStatus() {
  function setStatus(id, connected) {
    const el = document.getElementById(id);
    if (!el) return;
    if (connected) {
      el.style.background = 'rgba(34,197,94,.2)';
      el.style.color = '#4ADE80';
      el.style.borderColor = 'rgba(34,197,94,.35)';
      el.innerHTML = '<i class="fas fa-circle" style="font-size:7px;margin-right:3px;vertical-align:middle;"></i>Connect√©';
    } else {
      el.style.background = 'rgba(239,68,68,.2)';
      el.style.color = '#F87171';
      el.style.borderColor = 'rgba(239,68,68,.35)';
      el.innerHTML = '<i class="fas fa-circle" style="font-size:7px;margin-right:3px;vertical-align:middle;"></i>Non connect√©';
    }
  }

  function checkStatuses() {
    try {
      const reservations = JSON.parse(localStorage.getItem('LCC_RESERVATIONS') || '[]');
      const hasAirbnb = reservations.some(r =>
        (r.source || r.platform || '').toLowerCase().includes('airbnb')
      );
      const hasBooking = reservations.some(r =>
        (r.source || r.platform || '').toLowerCase().includes('booking')
      );
      setStatus('topbar-status-airbnb', hasAirbnb);
      setStatus('topbar-status-booking', hasBooking);

      // Stripe : v√©rifie lcc_user ou LCC_PROPERTIES
      const user = JSON.parse(localStorage.getItem('lcc_user') || '{}');
      const properties = JSON.parse(localStorage.getItem('LCC_PROPERTIES') || '[]');
      const hasStripe = !!(
        user.stripeAccountId ||
        user.stripe_account_id ||
        user.stripeConnected ||
        properties.some(p => p.stripeAccountId || p.stripe_account_id)
      );
      setStatus('topbar-status-stripe', hasStripe);
    } catch(e) {
      console.warn('TopBar status error:', e);
    }
  }

  // V√©rifier au chargement
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', checkStatuses);
  } else {
    checkStatuses();
  }

  // Re-v√©rifier apr√®s chargement des donn√©es API (d√©lai)
  setTimeout(checkStatuses, 2000);
  setTimeout(checkStatuses, 5000);

  // Exposer pour appel manuel apr√®s loadData
  window.updateTopBarStatus = checkStatuses;
})();
</script>


<!-- MOBILE HEADER -->
<div class="mobile-header">
<a class="mobile-logo" href="/app.html">
<i class="fas fa-calendar-check"></i>
<span class="mobile-logo-text">Bookingmanage</span>
</a>
<button class="mobile-menu-btn" id="mobileMenuBtn">
<i class="fas fa-bars"></i>
</button>
</div>
<div class="sidebar-overlay" id="sidebarOverlay"></div>
<div class="app-container">
<!-- Sidebar -->
<div id="bhSidebar"></div>
<!-- Main Content -->
<main class="main-content"><div id="bhHeader"></div>
<button class="factures-back-btn" onclick="window.location.href='/app.html'"><i class="fas fa-arrow-left"></i> Tableau de bord</button>
<!-- Header -->
<!-- Page Content -->
<div class="page-content">
<div class="invoice-grid">
<!-- Formulaire -->
<div>
<div class="card">
<div class="card-header">
<div class="card-title">
<i class="fas fa-file-invoice-dollar"></i>
                  Informations de facturation
                </div>
</div>
<div class="card-body">
<!-- Client -->
<div class="form-section">
<div class="form-section-title">
<i class="fas fa-user"></i>
                    Informations client
                  </div>
<div class="form-row">
<label for="clientName">Nom complet *</label>
<input id="clientName" placeholder="Jean Dupont" required="" type="text"/>
</div>
<div class="form-row">
<label for="clientEmail">Email</label>
<input id="clientEmail" placeholder="client@exemple.com" type="email"/>
</div>
<div class="form-row">
<label for="clientAddress">Adresse</label>
<input id="clientAddress" placeholder="12 rue de la R√©publique" type="text"/>
</div>
<div class="form-row-inline">
<div class="form-row">
<label for="clientPostalCode">Code postal</label>
<input id="clientPostalCode" placeholder="75001" type="text"/>
</div>
<div class="form-row">
<label for="clientCity">Ville</label>
<input id="clientCity" placeholder="Paris" type="text"/>
</div>
</div>
<div class="checkbox-row">
<input id="isCompany" type="checkbox"/>
<label for="isCompany">Client professionnel</label>
</div>
<div class="form-row" id="siretGroup" style="display: none;">
<label for="clientSiret">SIRET</label>
<input id="clientSiret" maxlength="17" placeholder="123 456 789 00012" type="text"/>
</div>
</div>
<div class="form-divider"></div>
<!-- S√©jour -->
<div class="form-section">
<div class="form-section-title">
<i class="fas fa-calendar-alt"></i>
                    S√©jour
                  </div>
<div class="form-row">
<label for="propertyName">Logement *</label>
<select id="propertyName" required="">
<option value="">S√©lectionner un logement...</option>
</select>
</div>
<div class="form-row-inline">
<div class="form-row">
<label for="checkinDate">Date d'arriv√©e</label>
<input id="checkinDate" type="date"/>
</div>
<div class="form-row">
<label for="checkoutDate">Date de d√©part</label>
<input id="checkoutDate" type="date"/>
</div>
</div>
</div>
<div class="form-divider"></div>
<!-- Montants -->
<div class="form-section">
<div class="form-section-title">
<i class="fas fa-euro-sign"></i>
                    Montants
                  </div>
<div class="form-row">
<label for="rentAmount">Loyer (prix total en ‚Ç¨)</label>
<input id="rentAmount" min="0" placeholder="1050.00" step="0.01" type="number"/>
</div>
<div class="form-row">
<label for="touristTaxAmount">Taxe de s√©jour (‚Ç¨)</label>
<input id="touristTaxAmount" min="0" placeholder="35.00" step="0.01" type="number"/>
</div>
<div class="form-row">
<label for="cleaningFee">Frais de m√©nage (‚Ç¨)</label>
<input id="cleaningFee" min="0" placeholder="80.00" step="0.01" type="number"/>
</div>
<div class="checkbox-row">
<input id="withVat" type="checkbox"/>
<label for="withVat">Avec TVA</label>
</div>
<div class="form-row" id="vatGroup" style="display: none;">
<label for="vatRate">Taux de TVA</label>
<select id="vatRate">
<option value="10">10%</option>
<option value="20">20%</option>
</select>
</div>
</div>
<!-- Actions -->
<div class="form-actions">
<button class="btn btn-primary" disabled="" id="sendBtn" onclick="sendInvoice()" type="button">
<i class="fas fa-envelope"></i>
                    Envoyer par email
                  </button>
<button class="btn btn-secondary" disabled="" id="pdfBtn" onclick="downloadPDF()" type="button">
<i class="fas fa-file-pdf"></i>
                    T√©l√©charger PDF
                  </button>
</div>
</div>
</div>
</div>
<!-- Aper√ßu -->
<div class="invoice-preview-card">
<div class="invoice-preview-header">
<i class="fas fa-file-invoice"></i>
              Aper√ßu de la facture
            </div>
<div class="invoice-preview-body">
<div class="invoice-paper" id="invoicePreview">
<div class="invoice-preview-empty">
<i class="fas fa-file-invoice"></i>
<div>
<p style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Aucun aper√ßu</p>
<p style="font-size: 14px;">Remplissez le formulaire pour voir l'aper√ßu en temps r√©el</p>
</div>
</div>
</div>
</div>
</div>
</div><!-- /.invoice-grid -->
</div><!-- /.page-content -->
</main>
</div>
<!-- Scripts -->
<script>
    (async function checkSubscriptionAccess() {
      const token = localStorage.getItem('lcc_token');
      
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      try {
        const res = await fetch('/api/subscription/status', {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (!res.ok) {
          if (res.status === 401 || res.status === 403) {
            localStorage.removeItem('lcc_token');
            localStorage.removeItem('lcc_user');
            window.location.href = '/login.html';
          }
          return;
        }

        const data = await res.json();

        if (data.status === 'expired' || data.status === 'canceled') {
          window.location.href = '/subscription-expired.html';
          return;
        }

        if (data.status === 'trial' && data.daysRemaining !== null && data.daysRemaining < 0) {
          window.location.href = '/subscription-expired.html';
          return;
        }

      } catch (err) {
        console.error('Erreur v√©rification abonnement:', err);
      }
    })();

    document.addEventListener('DOMContentLoaded', async function () {
      const token = localStorage.getItem('lcc_token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      let currentInvoiceId = null;
      let invoiceNumber = '';
      const propertiesByName = {};

      // Load user info pour la sidebar
      const user = JSON.parse(localStorage.getItem('lcc_user') || '{}');
      if (user.firstName) {
        const nameEl = document.getElementById('sidebarUserName');
        const avatarEl = document.getElementById('sidebarUserAvatar');
        if (nameEl) nameEl.textContent = user.firstName + ' ' + (user.lastName || '');
        if (avatarEl) avatarEl.textContent = user.firstName.charAt(0).toUpperCase();
      }
      if (user.company) {
        const companyEl = document.getElementById('sidebarUserCompany');
        if (companyEl) companyEl.textContent = user.company;
      }

      // Logout
      document.getElementById('logoutBtn')?.addEventListener('click', function() {
        localStorage.removeItem('lcc_token');
        localStorage.removeItem('lcc_user');
        window.location.href = '/login.html';
      });

      // Mobile menu
      const menuBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      
      if (menuBtn && sidebar && overlay) {
        menuBtn.addEventListener('click', function() {
          sidebar.classList.toggle('active');
          overlay.classList.toggle('active');
          const icon = menuBtn.querySelector('i');
          if (sidebar.classList.contains('active')) {
            icon.classList.remove('fa-bars');
            icon.classList.add('fa-times');
          } else {
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
          }
        });
        
        overlay.addEventListener('click', function() {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          const icon = menuBtn.querySelector('i');
          icon.classList.remove('fa-times');
          icon.classList.add('fa-bars');
        });
      }

      // Toggle SIRET
      document.getElementById('isCompany').addEventListener('change', function() {
        document.getElementById('siretGroup').style.display = this.checked ? 'block' : 'none';
      });

      // Toggle TVA
      document.getElementById('withVat').addEventListener('change', function() {
        document.getElementById('vatGroup').style.display = this.checked ? 'block' : 'none';
        if (document.getElementById('clientName').value && document.getElementById('propertyName').value) {
          generateInvoice();
        }
      });

      // Format SIRET
      document.getElementById('clientSiret').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '').substring(0, 14);
        let formatted = '';
        if (value.length > 0) formatted = value.substring(0, 3);
        if (value.length > 3) formatted += ' ' + value.substring(3, 6);
        if (value.length > 6) formatted += ' ' + value.substring(6, 9);
        if (value.length > 9) formatted += ' ' + value.substring(9, 14);
        e.target.value = formatted;
      });

      // Calcul des nuits
      function calculateNights() {
        const checkin = document.getElementById('checkinDate').value;
        const checkout = document.getElementById('checkoutDate').value;
        if (checkin && checkout) {
          const date1 = new Date(checkin);
          const date2 = new Date(checkout);
          const nights = Math.ceil((date2 - date1) / (1000 * 60 * 60 * 24));
          return nights;
        }
        return 0;
      }

      document.getElementById('checkoutDate').addEventListener('change', calculateNights);
      document.getElementById('checkinDate').addEventListener('change', calculateNights);
     
      function getSelectedPropertyAddress() {
        const select = document.getElementById('propertyName');
        if (!select) return '';

        const selectedOption = select.options[select.selectedIndex];
        let address = selectedOption && selectedOption.dataset.address
          ? selectedOption.dataset.address
          : '';

        if (!address && propertiesByName[select.value]) {
          const prop = propertiesByName[select.value];
          address =
            prop.address ||
            prop.propertyAddress ||
            prop.addressLine ||
            '';
        }

        return address || '';
      }

      // Charger les logements
      async function loadProperties() {
        try {
          const response = await fetch('/api/properties', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          
          if (response.ok) {
            const data = await response.json();
            const select = document.getElementById('propertyName');

            data.properties.forEach(prop => {
              const option = document.createElement('option');
              option.value = prop.name;
              option.textContent = prop.name;
              option.dataset.address = prop.address || '';

              select.appendChild(option);
              propertiesByName[prop.name] = prop;
            });
          } else {
            console.error('Erreur chargement logements:', response.status);
          }
        } catch (err) {
          console.error('Erreur chargement logements:', err);
        }
      }

      // G√©n√©rer l'aper√ßu
      window.generateInvoice = function() {
        const clientName = document.getElementById('clientName').value;
        const propertyName = document.getElementById('propertyName').value;
        const propertyAddress = getSelectedPropertyAddress();

        if (!clientName || !propertyName) {
          return;
        }

        const profile = JSON.parse(localStorage.getItem('lcc_settings_profile') || '{}');
        
        const rentAmount = parseFloat(document.getElementById('rentAmount').value || 0);
        const touristTaxAmount = parseFloat(document.getElementById('touristTaxAmount').value || 0);
        const cleaningFee = parseFloat(document.getElementById('cleaningFee').value || 0);
        const withVat = document.getElementById('withVat').checked;
        const vatRate = withVat ? parseFloat(document.getElementById('vatRate').value) : 0;

        const subtotal = rentAmount + touristTaxAmount + cleaningFee;
        const vatAmount = withVat ? subtotal * (vatRate / 100) : 0;
        const total = subtotal + vatAmount;

        const nights = calculateNights();
        const checkin = document.getElementById('checkinDate').value;
        const checkout = document.getElementById('checkoutDate').value;

        invoiceNumber = invoiceNumber || 'FACT-XXX';

        const preview = `
          <div class="invoice-header">
            <h2>${profile.company || user.company || 'Ma Conciergerie'}</h2>
            <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">
              ${profile.address || ''}
              ${profile.address && (profile.postalCode || profile.city) ? '<br>' : ''}
              ${profile.postalCode || ''} ${profile.city || ''}
              ${profile.siret ? '<br>SIRET: ' + profile.siret : ''}
              ${user.email ? '<br>' + user.email : ''}
            </div>
            <div class="invoice-number" style="margin-top: 16px; font-size: 16px; font-weight: 600;">FACTURE N¬∞ ${invoiceNumber}</div>
            <div class="invoice-number">Date: ${new Date().toLocaleDateString('fr-FR')}</div>
          </div>

          <div class="invoice-section">
            <h3>Facturer √†</h3>
            <div class="invoice-section-content">
              <strong>${clientName}</strong><br>
              ${document.getElementById('clientAddress').value ? document.getElementById('clientAddress').value + '<br>' : ''}
              ${document.getElementById('clientPostalCode').value || ''} ${document.getElementById('clientCity').value || ''}
              ${document.getElementById('isCompany').checked && document.getElementById('clientSiret').value ? '<br>SIRET: ' + document.getElementById('clientSiret').value : ''}
            </div>
          </div>

          <div class="invoice-section">
            <h3>S√©jour</h3>
            <div class="invoice-section-content">
              <strong>${propertyName}</strong>
              ${propertyAddress ? '<br>' + propertyAddress : ''}
              ${checkin && checkout 
                ? '<br>Du ' + new Date(checkin).toLocaleDateString('fr-FR') +
                  ' au ' + new Date(checkout).toLocaleDateString('fr-FR') +
                  (nights ? ' (' + nights + ' ' + (nights > 1 ? 'nuits' : 'nuit') + ')' : '')
                : ''}
            </div>
          </div>

          <div class="invoice-section">
            <h3>D√©tails</h3>
            ${rentAmount > 0 ? '<div class="invoice-line"><span>Loyer</span><span>' + rentAmount.toFixed(2) + ' ‚Ç¨</span></div>' : ''}
            ${touristTaxAmount > 0 ? '<div class="invoice-line"><span>Taxes de s√©jour</span><span>' + touristTaxAmount.toFixed(2) + ' ‚Ç¨</span></div>' : ''}
            ${cleaningFee > 0 ? '<div class="invoice-line"><span>Frais de m√©nage</span><span>' + cleaningFee.toFixed(2) + ' ‚Ç¨</span></div>' : ''}
          </div>

          <div class="invoice-subtotal">
            <span>Sous-total</span>
            <span>${subtotal.toFixed(2)} ‚Ç¨</span>
          </div>
          ${withVat ? '<div class="invoice-line"><span>TVA (' + vatRate + '%)</span><span>' + vatAmount.toFixed(2) + ' ‚Ç¨</span></div>' : ''}

          <div class="invoice-total">
            <span>TOTAL TTC</span>
            <span>${total.toFixed(2)} ‚Ç¨</span>
          </div>

          <div class="paid-stamp">
            <h3><i class="fas fa-check-circle"></i> FACTURE ACQUITT√âE</h3>
          </div>

          <div class="invoice-footer">
            ${!withVat ? 'TVA non applicable - Art. 293B du CGI' : ''}
          </div>
        `;

        document.getElementById('invoicePreview').innerHTML = preview;

        const sendBtn = document.getElementById('sendBtn');
        if (sendBtn) sendBtn.disabled = false;
      };

      // Envoyer la facture
      window.sendInvoice = async function() {
        const clientEmail = document.getElementById('clientEmail').value;
        if (!clientEmail) {
          alert("Veuillez renseigner l'email du client");
          return;
        }

        if (!confirm("Envoyer la facture par email √† " + clientEmail + " ?")) return;

        const data = {
          clientName: document.getElementById('clientName').value,
          clientEmail: clientEmail,
          clientAddress: document.getElementById('clientAddress').value,
          clientPostalCode: document.getElementById('clientPostalCode').value,
          clientCity: document.getElementById('clientCity').value,
          clientSiret: document.getElementById('isCompany').checked ? document.getElementById('clientSiret').value : '',
          propertyName: document.getElementById('propertyName').value,
          propertyAddress: getSelectedPropertyAddress(),
          checkinDate: document.getElementById('checkinDate').value,
          checkoutDate: document.getElementById('checkoutDate').value,
          nights: calculateNights(),
          rentAmount: document.getElementById('rentAmount').value,
          touristTaxAmount: document.getElementById('touristTaxAmount').value,
          cleaningFee: document.getElementById('cleaningFee').value,
          vatRate: document.getElementById('withVat').checked ? document.getElementById('vatRate').value : 0,
          sendEmail: true
        };

        try {
          console.log('üì§ Envoi des donn√©es:', data);
          
          const response = await fetch('/api/invoice/create', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(data)
          });

          console.log('üì• R√©ponse status:', response.status);
          
          const text = await response.text();
          console.log('üì• R√©ponse brute:', text);
          
          let result = null;
          try {
            result = JSON.parse(text);
          } catch (e) {
            console.error('‚ùå Erreur parsing JSON:', e);
            alert("‚ùå Erreur serveur : La r√©ponse n'est pas au bon format.\n\nV√©rifie les logs de la console (F12)");
            return;
          }

          if (response.ok && result) {
            currentInvoiceId = result.invoiceId || null;
            invoiceNumber = result.invoiceNumber || '';

            alert("‚úÖ Facture " + (invoiceNumber || '') + " cr√©√©e et envoy√©e par email !");

            if (invoiceNumber) {
              generateInvoice(); // R√©g√©n√©rer avec le bon num√©ro
            }

            const pdfBtn = document.getElementById('pdfBtn');
            if (pdfBtn) pdfBtn.disabled = false;

            const sendBtn = document.getElementById('sendBtn');
            if (sendBtn) sendBtn.disabled = true;
          } else {
            console.error('‚ùå Erreur API:', result);
            alert("‚ö†Ô∏è Erreur: " + (result.error || 'Erreur inconnue') + "\n\nV√©rifie les logs de la console (F12)");
            const pdfBtn = document.getElementById('pdfBtn');
            if (pdfBtn) pdfBtn.disabled = false;
          }
        } catch (err) {
          console.error('‚ùå Erreur r√©seau:', err);
          alert("‚ùå Erreur technique : " + (err.message || err) + "\n\nV√©rifie les logs de la console (F12)");
        }
      };

      // T√©l√©charger PDF (force le download)
      window.downloadPDF = function() {
        window.print();
      };

      // Auto-update preview
      ['clientName', 'propertyName', 'rentAmount', 'touristTaxAmount', 'cleaningFee', 'vatRate', 'checkinDate', 'checkoutDate'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('input', generateInvoice);
          el.addEventListener('change', generateInvoice);
        }
      });

      // Init
      loadProperties();
    });
  </script>
<script src="/js/bh-layout.js"></script>
<script src="/js/mobile-native-experience.js"></script>
<script src="/js/mobile-tabs-handler.js"></script>
<script src="/js/messages-badge-desktop-mobile.js"></script>
<!-- Socket.io pour le temps r√©el -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style id="factures-mobile-master">
@media (max-width: 768px) {

  /* 1. LAYOUT */
  html, body { overflow-x: hidden !important; }
  html[data-theme-v3="1"] .bh-demo-nav { display: none !important; }
  html[data-theme-v3="1"] body { padding-top: 0 !important; }
  html[data-theme-v3="1"] .sidebar,
  html[data-theme-v3="1"] .sidebar-overlay { display: none !important; }
  html[data-theme-v3="1"] .app-container { margin-left: 0 !important; padding: 0 !important; }
  html[data-theme-v3="1"] .main-content { margin-left: 0 !important; padding: 0 !important; }

  /* 2. MOBILE HEADER */
  .mobile-header {
    display: flex !important;
    position: fixed !important;
    top: 0 !important; left: 0 !important; right: 0 !important;
    height: calc(60px + env(safe-area-inset-top, 0px)) !important;
    z-index: 1100 !important;
    align-items: center !important;
    justify-content: center !important;
    background: rgba(245, 242, 236, 0.97) !important;
    backdrop-filter: blur(12px) !important;
    border-bottom: 1px solid rgba(200, 184, 154, 0.4) !important;
    padding-top: env(safe-area-inset-top, 0px) !important;
  }
  .mobile-menu-btn, #mobileMenuBtn,
  .factures-back-btn, #bhHeader { display: none !important; }

  /* 3. PAGE CONTENT */
  html[data-theme-v3="1"] .page-content {
    padding: 0 14px 90px !important;
    padding-top: calc(60px + env(safe-area-inset-top, 0px) + 16px) !important;
    max-width: 100% !important;
    margin: 0 !important;
    box-sizing: border-box !important;
    width: 100% !important;
  }

  /* 4. INVOICE GRID ‚Äî 1 colonne (formulaire d'abord, aper√ßu dessous) */
  .invoice-grid {
    grid-template-columns: 1fr !important;
    gap: 16px !important;
  }

  /* 5. FORMULAIRE */
  .form-row { margin-bottom: 12px !important; }
  .form-row input,
  .form-row select,
  .form-row textarea {
    width: 100% !important;
    box-sizing: border-box !important;
    font-size: 16px !important;
  }
  .form-row-inline,
  .form-grid-2 {
    display: flex !important;
    flex-direction: column !important;
    gap: 12px !important;
  }
  /* Grid 2 colonnes internes (ex: qt√©/prix) */
  .line-items-grid,
  .invoice-line-grid {
    grid-template-columns: 1fr 80px 80px 32px !important;
    gap: 6px !important;
  }

  /* 6. APER√áU FACTURE */
  .invoice-preview-card {
    border-radius: 16px !important;
    overflow: hidden !important;
  }
  .invoice-preview-body {
    overflow-x: auto !important;
    -webkit-overflow-scrolling: touch !important;
  }
  .invoice-paper {
    min-width: 500px !important;
    padding: 20px !important;
    font-size: 11px !important;
  }

  /* 7. BOUTONS D'ACTION */
  .card-footer,
  .invoice-actions {
    display: flex !important;
    flex-direction: column !important;
    gap: 8px !important;
  }
  .card-footer .btn,
  .invoice-actions .btn {
    width: 100% !important;
    justify-content: center !important;
  }

  /* 8. CARDS */
  html[data-theme-v3="1"] .card {
    border-radius: 16px !important;
    margin-bottom: 14px !important;
  }

  /* 9. BOTTOM TABS */
  .mobile-tabs {
    position: fixed !important;
    bottom: 0 !important; left: 0 !important; right: 0 !important;
    z-index: 1000 !important;
    background: rgba(245, 242, 236, 0.97) !important;
    backdrop-filter: blur(16px) !important;
    border-top: 1px solid rgba(200, 184, 154, 0.4) !important;
    padding-bottom: env(safe-area-inset-bottom, 0px) !important;
  }
}
</style>

</body>
</html>
