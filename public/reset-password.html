<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Réinitialiser votre mot de passe - Boostinghost</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      width: 100%;
      max-width: 460px;
      background: white;
      border-radius: 24px;
      padding: 48px 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 40px;
    }
    
    .logo-icon {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, #10b981, #059669);
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: 800;
      color: white;
      flex-shrink: 0;
    }
    
    .logo-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .logo-title {
      font-size: 22px;
      font-weight: 700;
      color: #111827;
      line-height: 1;
    }
    
    .logo-title .green {
      color: #10b981;
    }
    
    .logo-subtitle {
      font-size: 13px;
      color: #6b7280;
      font-weight: 500;
    }
    
    h1 {
      font-size: 32px;
      font-weight: 800;
      color: #111827;
      margin-bottom: 12px;
      line-height: 1.2;
    }
    
    .subtitle {
      font-size: 16px;
      color: #6b7280;
      margin-bottom: 36px;
      line-height: 1.5;
    }
    
    .form-group {
      margin-bottom: 24px;
    }
    
    label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 10px;
    }
    
    .input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .input-icon {
      position: absolute;
      left: 18px;
      color: #9ca3af;
      font-size: 18px;
      pointer-events: none;
    }
    
    input {
      width: 100%;
      padding: 16px 50px;
      border: 2px solid #e5e7eb;
      border-radius: 14px;
      font-size: 16px;
      font-family: inherit;
      transition: all 0.2s;
      background: white;
      color: #111827;
    }
    
    input::placeholder {
      color: #9ca3af;
    }
    
    input:focus {
      outline: none;
      border-color: #10b981;
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
    }
    
    .toggle-btn {
      position: absolute;
      right: 16px;
      background: none;
      border: none;
      cursor: pointer;
      color: #9ca3af;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s;
      font-size: 18px;
    }
    
    .toggle-btn:hover {
      color: #6b7280;
    }
    
    .toggle-btn:active {
      color: #10b981;
    }
    
    .error {
      display: none;
      background: #fee2e2;
      border: 1px solid #ef4444;
      color: #991b1b;
      padding: 14px 18px;
      border-radius: 12px;
      font-size: 14px;
      margin-bottom: 20px;
      line-height: 1.4;
    }
    
    .error i {
      margin-right: 8px;
    }
    
    .success {
      display: none;
      background: #d1fae5;
      border: 1px solid #10b981;
      color: #065f46;
      padding: 14px 18px;
      border-radius: 12px;
      font-size: 14px;
      margin-bottom: 20px;
      font-weight: 500;
      line-height: 1.4;
    }
    
    .success i {
      margin-right: 8px;
    }
    
    .submit-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      border-radius: 14px;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
    }
    
    .submit-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
    }
    
    .submit-btn:active:not(:disabled) {
      transform: translateY(0);
    }
    
    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .back-link {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 28px;
      color: #10b981;
      text-decoration: none;
      font-size: 15px;
      font-weight: 600;
      transition: color 0.2s;
    }
    
    .back-link:hover {
      color: #059669;
    }
    
    @media (max-width: 640px) {
      .container {
        padding: 36px 28px;
        border-radius: 20px;
      }
      
      h1 {
        font-size: 28px;
      }
      
      .subtitle {
        font-size: 15px;
      }
      
      .logo-icon {
        width: 56px;
        height: 56px;
        font-size: 28px;
      }
      
      input {
        font-size: 16px; /* Empêche le zoom sur iOS */
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <div class="logo-icon">B</div>
      <div class="logo-text">
        <div class="logo-title">
          <span class="green">Boosting</span><span>host</span>
        </div>
        <div class="logo-subtitle">Property Manager</div>
      </div>
    </div>

    <h1>Nouveau mot de passe</h1>
    <p class="subtitle">Choisissez un mot de passe sécurisé pour votre compte.</p>

    <form id="resetPasswordForm">
      <div class="form-group">
        <label for="newPassword">Nouveau mot de passe</label>
        <div class="input-wrapper">
          <i class="fas fa-lock input-icon"></i>
          <input type="password" id="newPassword" placeholder="Minimum 8 caractères" required>
          <button type="button" class="toggle-btn" id="togglePassword">
            <i class="fas fa-eye" id="togglePasswordIcon"></i>
          </button>
        </div>
      </div>

      <div class="form-group">
        <label for="confirmPassword">Confirmer le mot de passe</label>
        <div class="input-wrapper">
          <i class="fas fa-lock input-icon"></i>
          <input type="password" id="confirmPassword" placeholder="Retapez votre mot de passe" required>
          <button type="button" class="toggle-btn" id="toggleConfirm">
            <i class="fas fa-eye" id="toggleConfirmIcon"></i>
          </button>
        </div>
      </div>

      <div id="resetError" class="error">
        <i class="fas fa-exclamation-circle"></i>
        <span id="errorText"></span>
      </div>
      
      <div id="resetSuccess" class="success">
        <i class="fas fa-check-circle"></i>
        Mot de passe réinitialisé ! Redirection...
      </div>

      <button type="submit" class="submit-btn" id="resetSubmit">
        Réinitialiser le mot de passe
      </button>
    </form>

    <a href="/login.html" class="back-link">
      <i class="fas fa-arrow-left"></i>
      Retour à la connexion
    </a>
  </div>
  
  <script>
    const IS_NATIVE = !!(
      window.Capacitor?.isNativePlatform?.() ||
      window.location.protocol === 'capacitor:' ||
      window.location.protocol === 'ionic:'
    );
    const API_BASE = IS_NATIVE ? 'https://lcc-booking-manager.onrender.com' : '';
    
    // Récupérer le token depuis l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const resetToken = urlParams.get('token');
    
    const errorDiv = document.getElementById('resetError');
    const errorText = document.getElementById('errorText');
    const submitBtn = document.getElementById('resetSubmit');
    
    if (!resetToken) {
      errorDiv.style.display = 'block';
      errorText.textContent = 'Token manquant ou invalide. Veuillez refaire une demande de réinitialisation.';
      submitBtn.disabled = true;
    }
    
    // Toggle password visibility
    function setupToggle(toggleBtnId, inputId, iconId) {
      const toggleBtn = document.getElementById(toggleBtnId);
      const input = document.getElementById(inputId);
      const icon = document.getElementById(iconId);
      
      if (toggleBtn && input && icon) {
        toggleBtn.addEventListener('click', () => {
          const type = input.type === 'password' ? 'text' : 'password';
          input.type = type;
          
          if (type === 'text') {
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
          } else {
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
          }
        });
      }
    }
    
    setupToggle('togglePassword', 'newPassword', 'togglePasswordIcon');
    setupToggle('toggleConfirm', 'confirmPassword', 'toggleConfirmIcon');
    
    // Soumettre le formulaire
    const form = document.getElementById('resetPasswordForm');
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const successDiv = document.getElementById('resetSuccess');
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const newPassword = newPasswordInput.value;
      const confirmPassword = confirmPasswordInput.value;
      
      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';
      
      // Validation
      if (newPassword.length < 8) {
        errorDiv.style.display = 'block';
        errorText.textContent = 'Le mot de passe doit contenir au moins 8 caractères.';
        return;
      }
      
      if (newPassword !== confirmPassword) {
        errorDiv.style.display = 'block';
        errorText.textContent = 'Les mots de passe ne correspondent pas.';
        return;
      }
      
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Réinitialisation...';
      
      try {
        const response = await fetch(API_BASE + '/api/auth/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            token: resetToken,
            newPassword: newPassword
          })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          errorDiv.style.display = 'block';
          errorText.textContent = data.error || 'Une erreur est survenue. Veuillez réessayer.';
          submitBtn.disabled = false;
          submitBtn.textContent = 'Réinitialiser le mot de passe';
          return;
        }
        
        // Succès !
        successDiv.style.display = 'block';
        newPasswordInput.value = '';
        confirmPasswordInput.value = '';
        
        // Redirection vers login après 2 secondes
        setTimeout(() => {
          window.location.href = '/login.html';
        }, 2000);
        
      } catch (err) {
        console.error('Erreur reset password:', err);
        errorDiv.style.display = 'block';
        errorText.textContent = 'Erreur de connexion au serveur. Veuillez vérifier votre connexion.';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Réinitialiser le mot de passe';
      }
    });
  </script>
</body>
</html>
