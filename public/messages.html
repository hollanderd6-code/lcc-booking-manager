<!DOCTYPE html>
<html data-theme="light" data-theme-v3="1" lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
<title>Messages ‚Äî Boostinghost</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>
<link href="/css/style.css" rel="stylesheet"/>
<link href="/css/bh-shared.css?v=1" rel="stylesheet"/>
<link href="/css/bh-theme-v3.css" rel="stylesheet"/>
<link href="/css/bottom-bar-enhanced.css" rel="stylesheet"/>
<link href="/css/messages-badge-fix.css" rel="stylesheet"/>
<link rel="stylesheet" href="/css/messages-badge-red.css">
<link rel="stylesheet" href="/css/messages-badge-desktop.css">
<link rel="stylesheet" href="/css/mobile-native-styles.css">
<style>
/* ============================================================
   DARK BAR + STICKY HEADER (identical to app.html)
   ============================================================ */
html[data-theme-v3="1"] body { padding-top: 40px !important; }
html[data-theme-v3="1"] .sidebar {
  position: fixed !important; top: 40px !important;
  left: 0 !important; bottom: 0 !important;
  height: auto !important;
}
html[data-theme-v3="1"] header.main-header {
  position: sticky !important;
  top: 0 !important; /* body a d√©j√† padding-top:40px ‚Äî sticky √† 0 = coll√© sous la barre dark */
  z-index: 50 !important;
  margin-top: 0 !important;
}
html[data-theme-v3="1"] main.main-content {
  padding-top: 0 !important;
  margin-top: 0 !important;
}
html[data-theme-v3="1"] .app-container {
  margin-top: 0 !important;
  padding-top: 0 !important;
}
/* Tuer tout espace parasite entre barre dark et header */
html[data-theme-v3="1"] main.main-content > header.main-header {
  margin-top: 0 !important;
  padding-top: 0 !important;
}

/* ‚îÄ‚îÄ BARRE DARK EN HAUT ‚îÄ‚îÄ */
html[data-theme-v3="1"] .bh-demo-nav {
  position: fixed;
  top: 0; left: 0; right: 0;
  z-index: 9999;
  background: #0D1117;
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 0 16px;
  height: 40px;
  font-family: 'DM Sans', sans-serif;
  font-size: 12px;
  /* Pour le centrage absolu des badges */
  position: fixed;
}
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-label {
  color: rgba(255,255,255,.4);
  font-weight: 500;
  margin-right: 6px;
  letter-spacing: .08em;
  text-transform: uppercase;
  font-size: 11px;
  white-space: nowrap;
}
html[data-theme-v3="1"] .bh-demo-nav a.bh-demo-btn,
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-btn {
  padding: 4px 13px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.15);
  background: transparent;
  color: rgba(255,255,255,.6);
  cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  font-size: 11.5px;
  font-weight: 500;
  transition: all .2s;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  text-decoration: none;
  white-space: nowrap;
}
html[data-theme-v3="1"] .bh-demo-nav a.bh-demo-btn:hover,
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-btn:hover {
  background: rgba(255,255,255,.1);
  color: white;
}
html[data-theme-v3="1"] .bh-demo-nav a.bh-demo-btn.active,
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-btn.active {
  background: #1A7A5E;
  color: white;
  border-color: #1A7A5E;
}
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-right {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-mode-label {
  color: rgba(255,255,255,.4);
  font-size: 10.5px;
  font-weight: 500;
  letter-spacing: .07em;
  text-transform: uppercase;
}
html[data-theme-v3="1"] .bh-theme-toggle {
  width: 44px;
  height: 24px;
  background: rgba(255,255,255,.15);
  border-radius: 999px;
  border: none;
  cursor: pointer;
  position: relative;
  transition: background .2s;
  flex-shrink: 0;
}
html[data-theme-v3="1"] .bh-theme-toggle::after {
  content: '';
  position: absolute;
  top: 3px; left: 3px;
  width: 18px; height: 18px;
  background: white;
  border-radius: 50%;
  transition: transform .2s;
}
html[data-theme-v3="1"][data-theme="dark"] .bh-theme-toggle { background: #1A7A5E; }
html[data-theme-v3="1"][data-theme="dark"] .bh-theme-toggle::after { transform: translateX(20px); }

/* ============================================================
   PAGE MESSAGES ‚Äî REDESIGN V3
   ============================================================ */
html[data-theme-v3="1"] body {
  background: #F5F2EC !important;
  font-family: 'DM Sans', sans-serif !important;
}

html[data-theme-v3="1"] .main-content {
  background: #F5F2EC !important;
  overflow: hidden !important;
}

/* Hide back button */
html[data-theme-v3="1"] .back-btn,
html[data-theme-v3="1"] .btn-back,
html[data-theme-v3="1"] .header-back,
html[data-theme-v3="1"] .page-back-btn {
  display: none !important;
}

/* ‚îÄ‚îÄ Page header ‚îÄ‚îÄ */
.msgs-page-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 24px 12px;
  flex-shrink: 0;
}

.msgs-kicker {
  font-size: 10.5px;
  font-weight: 600;
  letter-spacing: .1em;
  text-transform: uppercase;
  color: rgba(13,17,23,.38);
  margin-bottom: 2px;
}

.msgs-heading {
  font-family: 'Instrument Serif', serif;
  font-size: 26px;
  font-weight: 400;
  color: #0D1117;
  margin: 0;
  line-height: 1.1;
}

.msgs-heading em {
  font-style: italic;
  color: #1A7A5E;
}

.msgs-header-right {
  display: flex;
  align-items: center;
  gap: 8px;
}

.msgs-icon-btn {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  border: 1px solid rgba(0,0,0,.1);
  background: white;
  color: #5A6A7A;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  transition: all .15s;
}

.msgs-icon-btn:hover { background: #eee8df; color: #0D1117; }

.msgs-group-btn {
  background: #1A7A5E;
  color: white;
  border: none;
  border-radius: 10px;
  padding: 0 16px;
  height: 36px;
  font-family: 'DM Sans', sans-serif;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 7px;
  transition: background .15s;
}

.msgs-group-btn:hover { background: #15624B; }

/* ‚îÄ‚îÄ Split container ‚îÄ‚îÄ */
.msgs-split {
  display: flex;
  margin: 0 16px 16px;
  border-radius: 20px;
  overflow: hidden;
  border: 1px solid rgba(0,0,0,.08);
  box-shadow: 0 2px 20px rgba(0,0,0,.06);
  background: white;
  height: calc(100vh - 40px - 80px);
}

/* ‚îÄ‚îÄ Left panel ‚îÄ‚îÄ */
.msgs-left {
  width: 330px;
  min-width: 330px;
  display: flex;
  flex-direction: column;
  border-right: 1px solid rgba(0,0,0,.07);
  background: #FAFAF8;
  overflow: hidden;
}

.msgs-search-wrap {
  padding: 12px 12px 10px;
  flex-shrink: 0;
}

.msgs-search {
  display: flex;
  align-items: center;
  gap: 8px;
  background: white;
  border: 1px solid rgba(0,0,0,.1);
  border-radius: 10px;
  padding: 0 12px;
  height: 36px;
}

.msgs-search i { color: #B0BAC5; font-size: 12px; }

.msgs-search input {
  flex: 1;
  border: none;
  background: transparent;
  font-family: 'DM Sans', sans-serif;
  font-size: 13px;
  color: #0D1117;
  outline: none;
}

.msgs-search input::placeholder { color: #B0BAC5; }

/* Conv list scroll */
#conversationsList {
  flex: 1;
  overflow-y: auto;
  min-height: 0;
}

#conversationsList::-webkit-scrollbar { width: 3px; }
#conversationsList::-webkit-scrollbar-thumb { background: rgba(0,0,0,.08); border-radius: 2px; }

/* ‚îÄ‚îÄ Conversation items ‚Äî override chat-owner.js ‚îÄ‚îÄ */
#conversationsList .conversation-item {
  padding: 11px 14px !important;
  border-radius: 0 !important;
  margin: 0 !important;
  background: transparent !important;
  box-shadow: none !important;
  border: none !important;
  border-bottom: 1px solid rgba(0,0,0,.05) !important;
  cursor: pointer !important;
  display: flex !important;
  align-items: center !important;
  gap: 10px !important;
  flex-wrap: nowrap !important;
  transition: background .12s !important;
}

#conversationsList .conversation-item:hover { background: #F0EBE3 !important; }
#conversationsList .conversation-item.active { background: #E8F4EF !important; border-left: 3px solid #1A7A5E !important; }

/* Avatar */
#conversationsList .conversation-avatar {
  width: 40px !important; height: 40px !important; min-width: 40px !important;
  border-radius: 50% !important; font-size: 15px !important; font-weight: 700 !important;
  display: flex !important; align-items: center !important; justify-content: center !important;
  flex-shrink: 0 !important; color: white !important;
}

/* Content */
#conversationsList .conversation-content {
  flex: 1 !important; min-width: 0 !important;
}

/* Header row */
#conversationsList .conversation-header {
  display: flex !important; align-items: center !important;
  justify-content: space-between !important; margin-bottom: 2px !important;
}

/* Name */
#conversationsList .conversation-info h3 {
  font-size: 13.5px !important; font-weight: 700 !important; color: #0D1117 !important;
  margin: 0 !important; white-space: nowrap !important; overflow: hidden !important;
  text-overflow: ellipsis !important; max-width: 160px !important;
  font-family: 'DM Sans', sans-serif !important;
}

/* Hide phone, meta (property/date/platform), delete button, status badge */
#conversationsList .conversation-phone,
#conversationsList .meta,
#conversationsList .conversation-actions,
#conversationsList .status-badge {
  display: none !important;
}

/* Status area ‚Äî only time + unread */
#conversationsList .conversation-status {
  display: flex !important; flex-direction: column !important;
  align-items: flex-end !important; gap: 4px !important; flex-shrink: 0 !important;
}

#conversationsList .conversation-time {
  font-size: 11px !important; color: #B0BAC5 !important; font-weight: 400 !important;
  white-space: nowrap !important;
}

#conversationsList .unread-badge {
  background: #EF4444 !important; color: white !important;
  width: 20px !important; height: 20px !important; min-width: 20px !important;
  border-radius: 50% !important; display: flex !important; align-items: center !important;
  justify-content: center !important; font-size: 10px !important; font-weight: 700 !important;
}

/* ‚îÄ‚îÄ Preview line (show if exists) ‚îÄ‚îÄ */
#conversationsList .conversation-preview {
  font-size: 12.5px !important; color: #8A96A3 !important;
  white-space: nowrap !important; overflow: hidden !important;
  text-overflow: ellipsis !important; max-width: 200px !important;
  font-family: 'DM Sans', sans-serif !important; margin: 0 !important;
}

/* Empty state */
#conversationsList .empty-state {
  text-align: center; padding: 40px 20px; color: #B0BAC5;
}
#conversationsList .empty-state i { font-size: 36px; display: block; margin-bottom: 12px; opacity: .4; }
#conversationsList .empty-state h3 { font-size: 14px; font-weight: 600; margin-bottom: 6px; color: #6B7A8A; }
#conversationsList .empty-state p { font-size: 13px; }

/* ‚îÄ‚îÄ Right panel ‚îÄ‚îÄ */
.msgs-right {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: white;
  overflow: hidden;
  min-width: 0;
}

/* Placeholder */
#msgsChatPlaceholder {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
  color: #C5CDD5;
}
#msgsChatPlaceholder i { font-size: 48px; opacity: .35; }
#msgsChatPlaceholder p { font-size: 14px; }

/* Chat header */
#msgsChatHeader {
  padding: 13px 18px;
  border-bottom: 1px solid rgba(0,0,0,.07);
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
  background: white;
}

.msgs-chat-avatar {
  width: 38px; height: 38px; min-width: 38px;
  border-radius: 50%;
  background: #1A7A5E;
  color: white;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 14px;
  font-family: 'DM Sans', sans-serif;
}

.msgs-chat-info { flex: 1; min-width: 0; }

.msgs-chat-name {
  font-size: 15px; font-weight: 700; color: #0D1117;
  font-family: 'DM Sans', sans-serif;
  margin-bottom: 2px;
}

.msgs-chat-meta {
  font-size: 12px; color: #8A96A3;
  display: flex; align-items: center; gap: 5px;
}

.msgs-chat-meta .sep { opacity: .4; }

.msgs-chat-actions {
  display: flex; align-items: center; gap: 7px;
}

.msgs-auto-btn {
  border: 1px solid rgba(0,0,0,.12);
  border-radius: 10px; padding: 0 13px; height: 32px;
  font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 600;
  color: #0D1117; background: white; cursor: pointer;
  display: flex; align-items: center; gap: 6px;
  transition: background .15s;
}
.msgs-auto-btn:hover { background: #f5f2ec; }

/* Messages area */
#chatMessages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  background: #F5F2EC !important;
  display: flex;
  flex-direction: column;
  gap: 10px;
  min-height: 0;
}

#chatMessages::-webkit-scrollbar { width: 4px; }
#chatMessages::-webkit-scrollbar-thumb { background: rgba(0,0,0,.1); border-radius: 2px; }

/* Message bubbles */
.chat-message {
  display: flex;
  gap: 10px;
  max-width: 72%;
  animation: fadeInUp .2s ease;
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(6px); }
  to { opacity: 1; transform: translateY(0); }
}

.chat-message.owner {
  align-self: flex-end;
  flex-direction: row-reverse;
}
.chat-message.guest, .chat-message.bot { align-self: flex-start; }

.chat-avatar {
  width: 32px; height: 32px; min-width: 32px;
  border-radius: 50%; background: #1A7A5E; color: white;
  display: flex; align-items: center; justify-content: center;
  font-weight: 600; font-size: 12px; flex-shrink: 0;
}
.chat-message.guest .chat-avatar { background: #3B82F6; }
.chat-message.bot .chat-avatar { background: #8B5CF6; }

.chat-bubble {
  background: white;
  padding: 10px 14px;
  border-radius: 16px 16px 16px 4px;
  box-shadow: 0 1px 3px rgba(0,0,0,.06);
  font-size: 14px;
  line-height: 1.5;
  color: #0D1117;
  word-wrap: break-word;
  white-space: pre-wrap;
}
.chat-message.owner .chat-bubble {
  background: #0D1117 !important;
  color: white !important;
  border-radius: 16px 16px 4px 16px !important;
}
.chat-message.bot .chat-bubble { background: #EDE9FE; }

.chat-sender { font-size: 11px; font-weight: 600; color: #8A96A3; margin-bottom: 3px; }
.chat-time, .chat-meta { font-size: 10px; color: #B0BAC5; margin-top: 4px; }
.chat-message.owner .chat-time { color: rgba(255,255,255,.5); }

/* Input area */
.chat-modal-input {
  padding: 10px 14px;
  border-top: 1px solid rgba(0,0,0,.07);
  background: white;
  display: flex;
  gap: 8px;
  align-items: flex-end;
  flex-shrink: 0;
}

.chat-input {
  flex: 1;
  padding: 9px 14px;
  border: 1px solid rgba(0,0,0,.1);
  border-radius: 20px;
  font-size: 14px;
  font-family: 'DM Sans', sans-serif;
  resize: none;
  max-height: 100px;
  background: #F5F2EC;
  outline: none;
  color: #0D1117;
}
.chat-input:focus { border-color: rgba(26,122,94,.4); background: white; }

.send-btn {
  width: 38px; height: 38px; flex-shrink: 0;
  background: #1A7A5E; color: white; border: none;
  border-radius: 50%; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 15px; transition: background .15s;
}
.send-btn:hover { background: #15624B; }
.send-btn:disabled { opacity: .5; cursor: not-allowed; }

/* Date separator */
.chat-date-sep {
  text-align: center; padding: 6px 0;
  font-size: 11.5px; color: #B0BAC5;
}

/* Old modal ‚Üí transformed to inline */
#chatModal {
  position: static !important;
  display: contents !important;
  background: none !important;
  backdrop-filter: none !important;
  pointer-events: none !important;
}
#chatModal.active {
  display: contents !important;
}
#chatModal .chat-modal {
  display: contents !important;
}
#chatModal .chat-modal-header {
  display: none !important; /* We use our own header */
}

/* Hide legacy elements */
html[data-theme-v3="1"] .stats-section,
html[data-theme-v3="1"] .filters-section,
html[data-theme-v3="1"] .conversations-section {
  display: none !important;
}

html[data-theme-v3="1"] .page-content {
  padding: 0 !important;
  margin: 0 !important;
}
/* ‚îÄ‚îÄ Hide back button from bh-layout.js ‚îÄ‚îÄ */
html[data-theme-v3="1"] .header-actions .btn-ghost,
html[data-theme-v3="1"] .header-actions .btn.btn-ghost {
  display: none !important;
}

/* ‚îÄ‚îÄ Style page title like "Mes messages" ‚îÄ‚îÄ */
html[data-theme-v3="1"] header.main-header .page-title {
  font-family: 'Instrument Serif', serif !important;
  font-size: 26px !important;
  font-weight: 400 !important;
}
html[data-theme-v3="1"] header.main-header .page-kicker {
  font-size: 10.5px !important;
  letter-spacing: .1em !important;
  text-transform: uppercase !important;
  color: rgba(13,17,23,.38) !important;
  font-weight: 600 !important;
}

/* ‚îÄ‚îÄ Header actions layout (refresh + group btn) ‚îÄ‚îÄ */
html[data-theme-v3="1"] .header-actions {
  display: flex !important;
  align-items: center !important;
  gap: 8px !important;
}

/* ‚îÄ‚îÄ Hide emoji bar if it gets injected ‚îÄ‚îÄ */
html[data-theme-v3="1"] [id*="emoji"],
html[data-theme-v3="1"] [class*="emoji"],
html[data-theme-v3="1"] .emoji-picker,
html[data-theme-v3="1"] .emoji-panel {
  display: none !important;
}

/* ‚îÄ‚îÄ Show property in conversation item ‚îÄ‚îÄ */
#conversationsList .conv-property {
  font-size: 11.5px;
  font-weight: 500;
  opacity: .85;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 200px;
  margin-top: 1px;
}

/* Photo attach button */
.msgs-attach-btn {
  width: 36px; height: 36px; flex-shrink: 0;
  border: 1px solid rgba(0,0,0,.1);
  border-radius: 10px; background: white;
  color: #8A96A3; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; transition: all .15s;
}
.msgs-attach-btn:hover { background: #f5f2ec; color: #1A7A5E; }

/* Back to dashboard button ‚Äî same style as Nouvelle r√©servation */
.msgs-back-btn {
  display: inline-flex;
  align-items: center;
  gap: 7px;
  height: 38px;
  padding: 0 18px;
  border: none;
  border-radius: 10px;
  background: #1A7A5E;
  color: white;
  font-family: 'DM Sans', sans-serif;
  font-size: 13.5px;
  font-weight: 600;
  cursor: pointer;
  transition: background .15s;
  white-space: nowrap;
  position: fixed;
  top: calc(40px + 12px);
  right: 24px;
  z-index: 200;
}
.msgs-back-btn:hover { background: #15624B; }
.msgs-back-btn i { font-size: 13px; }

/* Close conversation button */
#chatCloseConvBtn {
  border-color: rgba(0,0,0,.12);
}
#chatCloseConvBtn:hover { background: #FEF2F2; color: #DC2626; border-color: rgba(220,38,38,.3); }
#chatCloseConvBtn i { color: inherit; }

/* Closed conversation items */
#conversationsList .conversation-item.closed-conv {
  opacity: .45 !important;
  filter: grayscale(0.4) !important;
}

/* Image messages */
#chatMessages .chat-bubble img {
  max-width: 240px;
  max-height: 200px;
  border-radius: 10px;
  cursor: pointer;
  display: block;
}
#chatMessages .chat-bubble {
  word-break: break-word;
}
/* Override [IMAGE:...] raw text display */


/* Conversation list background beige */
#conversationsList,
.msgs-left,
.msgs-left .msgs-search-wrap {
  background: #F5F2EC !important;
}
#conversationsList .conversation-item {
  background: #F5F2EC !important;
}
#conversationsList .conversation-item:hover {
  background: #EDE8DE !important;
}
#conversationsList .conversation-item.active {
  background: #E2EDE8 !important;
}
.msgs-search {
  background: #FDFCFA !important;
}
</style>
</head>

<body data-page="messages" data-kicker="Communication" data-title="Messages" data-subtitle="">

<script src="/js/auth-fetch.js"></script>

<script>
(function() {
  'use strict';
  
  console.log('üåê [API FIX] Initialisation...');
  
  // D√©tection native
  const IS_NATIVE = !!(
    window.Capacitor?.isNativePlatform?.() ||
    window.location.protocol === 'capacitor:' ||
    window.location.protocol === 'ionic:'
  );

  // URL de l'API
  const API_BASE_URL = IS_NATIVE 
    ? 'https://lcc-booking-manager.onrender.com' 
    : window.location.origin;

  // Exposer globalement
  window.API_BASE = API_BASE_URL;
  window.API_URL = API_BASE_URL;
  window.IS_NATIVE = IS_NATIVE;

  console.log('üåê [API FIX] IS_NATIVE:', IS_NATIVE);
  console.log('üåê [API FIX] API_BASE:', API_BASE_URL);
  console.log('üåê [API FIX] Protocol:', window.location.protocol);

  // Helper pour construire les URLs
  window.buildApiUrl = function(path) {
    if (path.startsWith('/')) {
      return API_BASE_URL + path;
    }
    return API_BASE_URL + '/' + path;
  };

  // ‚ö° IMPORTANT: Intercepter fetch pour r√©√©crire automatiquement les URLs
  const originalFetch = window.fetch;
  window.fetch = function(input, init) {
    let url = input;
    
    // Si c'est un string qui commence par /api/
    if (typeof input === 'string' && input.startsWith('/api/')) {
      url = window.buildApiUrl(input);
      console.log('üîÑ [API FIX] Rewrite:', input, '‚Üí', url);
    }
    
    return originalFetch(url, init);
  };

  console.log('‚úÖ [API FIX] Activ√© et pr√™t');
})();
</script>

<!-- Mobile header -->
<div class="mobile-header">
  <a class="mobile-logo" href="/app.html"><i class="fas fa-calendar-check"></i><span class="mobile-logo-text">Boostinghost</span></a>
  <button class="mobile-menu-btn" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
</div>
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- Dark bar -->
<div class="bh-demo-nav" id="bhTopBar">
  <!-- Connexions centr√©es -->
  <div style="position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:16px;">

    <!-- Airbnb -->
    <div style="display:flex;align-items:center;gap:7px;">
      <i class="fa-brands fa-airbnb" style="font-size:15px;color:#FF5A5F;"></i>
      <span style="color:rgba(255,255,255,.7);font-size:12px;font-weight:500;">Airbnb</span>
      <span id="topbar-status-airbnb" style="font-size:11px;font-weight:600;padding:2px 9px;border-radius:999px;background:rgba(239,68,68,.2);color:#F87171;border:1px solid rgba(239,68,68,.35);">
        <i class="fas fa-circle" style="font-size:7px;margin-right:3px;vertical-align:middle;"></i>Non connect√©
      </span>
    </div>

    <div style="width:1px;height:16px;background:rgba(255,255,255,.1);"></div>

    <!-- Booking.com -->
    <div style="display:flex;align-items:center;gap:7px;">
      <span style="font-size:13px;font-weight:800;color:#003580;">B.</span>
      <span style="color:rgba(255,255,255,.7);font-size:12px;font-weight:500;">Booking.com</span>
      <span id="topbar-status-booking" style="font-size:11px;font-weight:600;padding:2px 9px;border-radius:999px;background:rgba(239,68,68,.2);color:#F87171;border:1px solid rgba(239,68,68,.35);">
        <i class="fas fa-circle" style="font-size:7px;margin-right:3px;vertical-align:middle;"></i>Non connect√©
      </span>
    </div>

    <div style="width:1px;height:16px;background:rgba(255,255,255,.1);"></div>

    <!-- Stripe -->
    <div style="display:flex;align-items:center;gap:7px;">
      <i class="fa-brands fa-stripe-s" style="font-size:17px;color:#6772E5;"></i>
      <span style="color:rgba(255,255,255,.7);font-size:12px;font-weight:500;">Stripe</span>
      <span id="topbar-status-stripe" style="font-size:11px;font-weight:600;padding:2px 9px;border-radius:999px;background:rgba(239,68,68,.2);color:#F87171;border:1px solid rgba(239,68,68,.35);">
        <i class="fas fa-circle" style="font-size:7px;margin-right:3px;vertical-align:middle;"></i>Non connect√©
      </span>
    </div>

  </div>

  <!-- Toggle dark mode (droite) -->
  <div class="bh-demo-right">
    <span class="bh-demo-mode-label">Mode</span>
    <button class="bh-theme-toggle" id="bhThemeToggleDark" onclick="document.documentElement.getAttribute('data-theme')==='dark'?document.documentElement.setAttribute('data-theme','light'):document.documentElement.setAttribute('data-theme','dark')"></button>
  </div>
</div>

<script>
// Mise √† jour des statuts de connexion dans la top bar
(function updateTopBarStatus() {
  function setStatus(id, connected) {
    const el = document.getElementById(id);
    if (!el) return;
    if (connected) {
      el.style.background = 'rgba(34,197,94,.2)';
      el.style.color = '#4ADE80';
      el.style.borderColor = 'rgba(34,197,94,.35)';
      el.innerHTML = '<i class="fas fa-circle" style="font-size:7px;margin-right:3px;vertical-align:middle;"></i>Connect√©';
    } else {
      el.style.background = 'rgba(239,68,68,.2)';
      el.style.color = '#F87171';
      el.style.borderColor = 'rgba(239,68,68,.35)';
      el.innerHTML = '<i class="fas fa-circle" style="font-size:7px;margin-right:3px;vertical-align:middle;"></i>Non connect√©';
    }
  }

  function checkStatuses() {
    try {
      const reservations = JSON.parse(localStorage.getItem('LCC_RESERVATIONS') || '[]');
      const hasAirbnb = reservations.some(r =>
        (r.source || r.platform || '').toLowerCase().includes('airbnb')
      );
      const hasBooking = reservations.some(r =>
        (r.source || r.platform || '').toLowerCase().includes('booking')
      );
      setStatus('topbar-status-airbnb', hasAirbnb);
      setStatus('topbar-status-booking', hasBooking);

      // Stripe : v√©rifie lcc_user ou LCC_PROPERTIES
      const user = JSON.parse(localStorage.getItem('lcc_user') || '{}');
      const properties = JSON.parse(localStorage.getItem('LCC_PROPERTIES') || '[]');
      const hasStripe = !!(
        user.stripeAccountId ||
        user.stripe_account_id ||
        user.stripeConnected ||
        properties.some(p => p.stripeAccountId || p.stripe_account_id)
      );
      setStatus('topbar-status-stripe', hasStripe);
    } catch(e) {
      console.warn('TopBar status error:', e);
    }
  }

  // V√©rifier au chargement
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', checkStatuses);
  } else {
    checkStatuses();
  }

  // Re-v√©rifier apr√®s chargement des donn√©es API (d√©lai)
  setTimeout(checkStatuses, 2000);
  setTimeout(checkStatuses, 5000);

  // Exposer pour appel manuel apr√®s loadData
  window.updateTopBarStatus = checkStatuses;
})();
</script>

<div class="app-container">
  <div id="bhSidebar"></div>
  <main class="main-content">
    <div id="bhHeader"></div>

    <!-- bhHeaderActions for bh-layout.js (empty) -->
    <div id="bhHeaderActions" style="display:none;"></div>
    
    <!-- Back button injected directly -->
    <button class="msgs-back-btn" id="msgsDirectBackBtn" onclick="window.location.href='/app.html'">
      <i class="fas fa-arrow-left"></i> Tableau de bord
    </button>

    <!-- Legacy hidden containers (JS compatibility) -->
    <div class="page-content" style="display:none!important">
      <div class="stats-section">
        <div class="stat-card"><div class="stat-content"><h3 id="statTotal">0</h3><p>Conversations totales</p></div></div>
        <div class="stat-card"><div class="stat-content"><h3 id="statUnread">0</h3><p>Non lus</p></div></div>
        <div class="stat-card"><div class="stat-content"><h3 id="statActive">0</h3><p>Actives</p></div></div>
      </div>
      <div class="filters-section">
        <div class="filter-group"><select id="filterStatus"><option value="">Tous</option><option selected value="active">Actives</option><option value="pending">En attente</option><option value="closed">Ferm√©es</option></select></div>
        <div class="filter-group"><select id="filterProperty"><option value="">Tous les logements</option></select></div>
      </div>
    </div>

    <!-- SPLIT LAYOUT -->
    <div class="msgs-split">

      <!-- LEFT: conversation list -->
      <div class="msgs-left">
        <div class="msgs-search-wrap">
          <div class="msgs-search">
            <i class="fas fa-search"></i>
            <input id="msgsSearchInput" placeholder="Rechercher un voyageur..." type="text"/>
          </div>
        </div>
        <!-- chat-owner.js writes directly here -->
        <div id="conversationsList">
          <div class="empty-state">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Chargement...</p>
          </div>
        </div>
      </div>

      <!-- RIGHT: chat panel -->
      <div class="msgs-right">

        <!-- Placeholder -->
        <div id="msgsChatPlaceholder">
          <i class="fas fa-comments"></i>
          <p>S√©lectionnez une conversation</p>
        </div>

        <!-- Chat header (shown after selecting conversation) -->
        <div id="msgsChatHeader" style="display:none;">
          <div class="msgs-chat-avatar" id="msgsChatAvatar">?</div>
          <div class="msgs-chat-info">
            <div class="msgs-chat-name" id="chatModalTitle">Conversation</div>
            <div class="msgs-chat-meta">
              <span id="chatPropertyName"></span>
              <span class="sep" id="chatMetaSep1" style="display:none">¬∑</span>
              <span id="chatPlatform"></span>
              <span class="sep" id="chatMetaSep2" style="display:none">¬∑</span>
              <span id="chatCheckinDate"></span>
            </div>
          </div>
          <div class="msgs-chat-actions">
            <button class="msgs-auto-btn" id="chatCloseConvBtn" onclick="closeCurrentConversation()"><i class="fas fa-check-circle"></i> Clore la conversation</button>
            <button class="msgs-icon-btn" id="btnCopyInviteLink" style="display:none" title="Copier le lien"><i class="fas fa-link"></i></button>
            <button class="msgs-icon-btn" id="btnBookingMessage" style="display:none" title="Message Booking"><i class="fas fa-paper-plane"></i></button>
          </div>
        </div>

        <!-- chatMessages: chat-owner.js writes here -->
        <div class="chat-modal-messages" id="chatMessages" style="display:none;"></div>

        <!-- Input: chat-owner.js uses #chatInput and #sendBtn -->
        <div class="chat-modal-input" id="chatInputArea" style="display:none;">
          <button class="msgs-attach-btn" id="photoUploadBtn" title="Envoyer une photo" onclick="if(window.openPhotoUpload) openPhotoUpload();"><i class="fas fa-image"></i></button>
          <textarea class="chat-input" id="chatInput" placeholder="R√©pondre √†‚Ä¶" rows="1"></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMessageOwner()"><i class="fas fa-paper-plane"></i></button>
        </div>

      </div>
    </div>

    <!-- chatModal: kept for chat-owner.js openChat() but invisible/inline -->
    <div id="chatModal" style="position:fixed;top:-9999px;left:-9999px;width:0;height:0;overflow:hidden;opacity:0;pointer-events:none;">
      <div class="chat-modal">
        <div class="chat-modal-header"></div>
      </div>
    </div>

  </main>
</div>

<div class="toast-container" id="toastContainer"></div>
<div class="loading-overlay" id="loadingOverlay" style="display:none;">
  <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><p>Chargement...</p></div>
</div>

<!-- Socket.IO -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<!-- ‚úÖ FONCTIONS HELPERS POUR AFFICHAGE VOYAGEUR -->
<script>
// ============================================
// FONCTIONS HELPERS POUR AFFICHAGE VOYAGEUR
// ============================================

function cleanGuestName(reservation) {
  if (!reservation) return 'Voyageur';
  
  // Si on a le guest_display_name construit par le serveur
  if (reservation.guest_display_name && 
      reservation.guest_display_name !== 'Voyageur' &&
      reservation.guest_display_name.trim() !== '') {
    return reservation.guest_display_name;
  }
  
  // Construire √† partir de guest_first_name et guest_last_name (onboarding)
  if (reservation.guest_first_name) {
    const firstName = reservation.guest_first_name.trim();
    const lastName = reservation.guest_last_name ? reservation.guest_last_name.trim() : '';
    return lastName ? `${firstName} ${lastName}` : firstName;
  }
  
  // Fallback sur guest_name
  const rawName = reservation.guest_name || reservation.guestName;
  if (rawName && rawName !== 'undefined' && rawName !== 'null' && rawName.trim() !== '') {
    const cleaned = rawName.trim().replace(/^\(|\)$/g, '');
    const invalidNames = [
      'not available', 'closed', 'reservation', 'reserved', 'blocked', 
      'unavailable', 'booked', 'not provided', 'n/a', 'unknown', 'guest'
    ];
    
    if (!invalidNames.some(invalid => cleaned.toLowerCase().includes(invalid))) {
      return cleaned;
    }
  }
  
  // Fallback final avec plateforme
  const plat = (reservation.source || reservation.platform || '').toLowerCase();
  if (plat.includes('airbnb')) return 'Voyageur Airbnb';
  if (plat.includes('booking')) return 'Voyageur Booking';
  
  return 'Voyageur';
}  // ‚úÖ ACCOLADE FERMANTE MANQUANTE !

function getGuestInitial(reservation) {
  if (!reservation) return 'V';
  
  // Si on a l'initiale construite par le serveur
  if (reservation.guest_initial && reservation.guest_initial !== 'V') {
    return reservation.guest_initial;
  }
  
  // Extraire du pr√©nom (onboarding)
  if (reservation.guest_first_name && reservation.guest_first_name.trim() !== '') {
    return reservation.guest_first_name.charAt(0).toUpperCase();
  }
  
  // Fallback sur guest_name
  const name = reservation.guest_name || reservation.guestName;
  if (name && name !== 'undefined' && name !== 'null' && name.trim() !== '') {
    return name.charAt(0).toUpperCase();
  }
  
  return 'V';
}

function getGuestPhone(reservation) {
  if (!reservation) return '';
  
  if (reservation.guest_phone && reservation.guest_phone.trim() !== '') {
    return reservation.guest_phone;
  }
  
  if (reservation.guestPhone && reservation.guestPhone.trim() !== '') {
    return reservation.guestPhone;
  }
  
  return '';
}

function formatRelativeTime(date) {
  const now = new Date();
  const diff = Math.floor((now - date) / 1000);
  
  if (diff < 60) return '√Ä l\'instant';
  if (diff < 3600) return `Il y a ${Math.floor(diff / 60)} min`;
  if (diff < 86400) return `Il y a ${Math.floor(diff / 3600)}h`;
  if (diff < 604800) return `Il y a ${Math.floor(diff / 86400)}j`;
  
  return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
}

// Exposer globalement
window.cleanGuestName = cleanGuestName;
window.getGuestInitial = getGuestInitial;
window.getGuestPhone = getGuestPhone;
window.formatRelativeTime = formatRelativeTime;

console.log('‚úÖ Fonctions helpers messages charg√©es');
</script>

<!-- Script -->

<script>
// chat-owner.js INLINED + PATCHED (isMobileDevice always returns false)
// ============================================
// CONFIGURATION & STATE
// ============================================
// D√©tection du mode natif (Capacitor)
const IS_NATIVE = window.Capacitor?.isNativePlatform() || false;
const API_URL = IS_NATIVE 
  ? 'https://lcc-booking-manager.onrender.com'
  : window.location.origin;

console.log('üîå [SOCKET] API_URL:', API_URL, '(Native:', IS_NATIVE + ')');

let socket = null;
let allConversations = [];
let currentConversationId = null;
let userId = null;

// ============================================
// D√âTECTION MOBILE (pour redirection)
// ============================================
function isMobileDevice() {
  return false; // Patched: always desktop mode
}

// ============================================
// INIT
// ============================================
document.addEventListener('DOMContentLoaded', async () => {
  console.log('üí¨ Chat Propri√©taire - Initialisation...');
  
  // R√©cup√©rer le userId
  const rawUser = localStorage.getItem('lcc_user');
  if (rawUser) {
    try {
      const user = JSON.parse(rawUser);
      userId = user.id;
    } catch (e) {
      console.error('Erreur lecture user:', e);
    }
  }
  
  // Charger les propri√©t√©s pour le filtre
  await loadProperties();
  
  // Charger les conversations
  await loadConversations();
  
  // Connecter Socket.IO
  connectSocket();
  
  // Event listeners pour les filtres
  setupFilters();
  
  // Auto-resize textarea
  const chatInput = document.getElementById('chatInput');
  if (chatInput) {
    chatInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    // Send on Enter
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessageOwner();
      }
    });
  }
  
  // Fermer le modal en cliquant sur l'overlay
  const chatModal = document.getElementById('chatModal');
  if (chatModal) {
    chatModal.addEventListener('click', function(e) {
      if (e.target === this) {
        closeChat();
      }
    });
  }
  
  console.log('‚úÖ Chat initialis√©');
});

// ============================================
// CHARGEMENT DES PROPRI√âT√âS
// ============================================
async function loadProperties() {
  try {
    const token = localStorage.getItem('lcc_token');
    console.log("üì§ [CHAT] Fetching properties:", "/api/properties");
    const response = await fetch(`/api/properties`, {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });
    
    // V√©rifier content-type
    const contentType = response.headers.get('content-type') || '';
    if (!contentType.includes('application/json')) {
      console.warn('‚ö†Ô∏è Properties non-JSON');
      return;
    }
    
    if (!response.ok) return;
    
    const data = await response.json();
    const select = document.getElementById('filterProperty');
    
    if (select && data.properties) {
      data.properties.forEach(property => {
        const option = document.createElement('option');
        option.value = property.id;
        option.textContent = property.name;
        select.appendChild(option);
      });
    }
    
  } catch (error) {
    console.error('‚ùå Erreur chargement propri√©t√©s:', error);
  }
}

// ============================================
// CHARGEMENT DES CONVERSATIONS
// ============================================
async function loadConversations() {
  showLoading();
  
  try {
    const token = localStorage.getItem('lcc_token');
    const status = document.getElementById('filterStatus')?.value || '';
    const propertyId = document.getElementById('filterProperty')?.value || '';
    
    let url = `/api/chat/conversations?`;
    if (status) url += `status=${status}&`;
    if (propertyId) url += `property_id=${propertyId}&`;
    
    console.log("üì§ [CHAT] Fetching conversations:", url);
    
    const response = await fetch(url, {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });
    
    if (!response.ok) {
      if (response.status === 401) {
        window.location.href = '/login.html';
        return;
      }
      throw new Error('Erreur chargement conversations');
    }
    
    const data = await response.json();
    allConversations = data.conversations || [];
    
    console.log(`üì¶ ${allConversations.length} conversation(s) charg√©e(s)`);
    
    // Mettre √† jour les stats
    updateStats();
    
    // Afficher les conversations
    renderConversations();
    
  } catch (error) {
    console.error('‚ùå Erreur:', error);
    showToast('Erreur de chargement', 'error');
  } finally {
    hideLoading();
  }
}

// ============================================
// MISE √Ä JOUR DES STATS
// ============================================
function updateStats() {
  const total = allConversations.length;
  const unread = allConversations.reduce((sum, conv) => sum + (parseInt(conv.unread_count) || 0), 0);
  const active = allConversations.filter(conv => conv.status === 'active').length;
  
  // Mettre √† jour les statistiques de la page
  const statTotal = document.getElementById('statTotal');
  const statUnread = document.getElementById('statUnread');
  const statActive = document.getElementById('statActive');
  
  if (statTotal) statTotal.textContent = total;
  if (statUnread) statUnread.textContent = unread;
  if (statActive) statActive.textContent = active;
  
  // Mettre √† jour le badge rouge dans la sidebar (g√©r√© par messages-badge-dynamic.js)
  // On ne touche plus √† ce badge ici, il est g√©r√© automatiquement
  
  // LEGACY: Support de l'ancien badge vert (si encore pr√©sent)
  const oldBadge = document.getElementById('unreadCount');
  if (oldBadge) {
    oldBadge.textContent = unread || '';
  }
}

// ============================================
// AFFICHAGE DES CONVERSATIONS
// ============================================
function renderConversations() {
  const container = document.getElementById('conversationsList');
  if (!container) return;
  
  if (allConversations.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-comments"></i>
        <h3>Aucune conversation</h3>
        <p>Les conversations avec vos voyageurs appara√Ætront ici.</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = allConversations.map(conv => {
    const unreadCount = parseInt(conv.unread_count) || 0;
    const statusClass = conv.status;
    const statusLabel = getStatusLabel(conv.status);
    
    const guestName = cleanGuestName(conv);
    const guestInitial = getGuestInitial(conv);
    const guestPhone = getGuestPhone(conv);
    
    const checkinDate = new Date(conv.reservation_start_date).toLocaleDateString('fr-FR', {
      day: '2-digit',
      month: 'short'
    });
    
    const lastMessageTime = conv.last_message_time 
      ? formatTime(conv.last_message_time)
      : formatTime(conv.created_at);
    
    const platformIcon = getPlatformIcon(conv.platform);
    const platformColor = getPlatformColor(conv.platform);
    
    return `
      <div class="conversation-item" data-conversation-id="${conv.id}" onclick="openChat(${conv.id})">
        <div class="conversation-avatar" style="background: ${conv.property_color || '#10B981'};">
          ${guestInitial}
        </div>
        
        <div class="conversation-content">
          <div class="conversation-header">
            <div class="conversation-info">
              <h3>${guestName}</h3>
              ${guestPhone ? `<span class="conversation-phone">${guestPhone}</span>` : ''}
              <div class="meta">
                <span class="property-badge" style="background: ${conv.property_color || '#10B981'}20; color: ${conv.property_color || '#10B981'};">
                  ${conv.property_name || 'Logement'}
                </span>
                <span><i class="fas fa-calendar"></i> ${checkinDate}</span>
                <span class="platform-badge" style="background-color: ${platformColor}20; color: ${platformColor};">
                  <i class="fas ${platformIcon}"></i>
                  ${conv.platform || 'direct'}
                </span>
              </div>
            </div>
            
            <div class="conversation-status">
              <!-- Bouton de suppression -->
              <div class="conversation-actions">
                <button class="btn-delete-conversation" 
                        onclick="deleteConversation(${conv.id}, event)" 
                        title="Supprimer la conversation">
                  <i class="fas fa-trash"></i>
                  Supprimer
                </button>
              </div>
              
              <div class="conversation-time">${lastMessageTime}</div>
              <div class="status-badge ${statusClass}">${statusLabel}</div>
              ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// ============================================
// FONCTIONS UTILITAIRES
// ============================================
function cleanGuestName(conv) {
  if (!conv) return 'Voyageur';
  
  // Priorit√© 1 : guest_display_name (construit par le serveur)
  if (conv.guest_display_name && 
      conv.guest_display_name !== 'Voyageur' && 
      conv.guest_display_name.trim() !== '') {
    return conv.guest_display_name;
  }
  
  // Priorit√© 2 : Construire depuis guest_first_name + guest_last_name
  if (conv.guest_first_name) {
    const firstName = conv.guest_first_name.trim();
    const lastName = conv.guest_last_name ? conv.guest_last_name.trim() : '';
    return lastName ? `${firstName} ${lastName}` : firstName;
  }
  
  // Priorit√© 3 : Fallback sur guest_name / guestName
  const rawName = conv.guest_name || conv.guestName;
  if (rawName && rawName !== 'undefined' && rawName !== 'null' && rawName.trim() !== '') {
    return rawName.trim();
  }
  
  // Fallback final
  return 'Voyageur';
}

function getGuestInitial(conv) {
  const name = cleanGuestName(conv);
  return name.charAt(0).toUpperCase();
}

function getGuestPhone(conv) {
  if (!conv) return '';
  return conv.guest_phone || conv.guestPhone || '';
}

function getPlatformIcon(platform) {
  const p = (platform || '').toLowerCase();
  if (p.includes('airbnb')) return 'fa-home';  // ‚úÖ Airbnb (fa-airbnb n'existe pas dans Font Awesome free)
  if (p.includes('booking')) return 'fa-bed';
  return 'fa-calendar';
}

function getPlatformColor(platform) {
  const p = (platform || '').toLowerCase();
  if (p.includes('airbnb')) return '#FF5A5F';
  if (p.includes('booking')) return '#003580';
  return '#667eea';
}

function getStatusLabel(status) {
  const labels = {
    'active': 'Active',
    'pending': 'En attente',
    'closed': 'Ferm√©e',
    'archived': 'Archiv√©e'
  };
  return labels[status] || 'Active';
}

// ============================================
// FILTRES
// ============================================
function setupFilters() {
  const statusFilter = document.getElementById('filterStatus');
  const propertyFilter = document.getElementById('filterProperty');
  
  if (statusFilter) {
    statusFilter.addEventListener('change', loadConversations);
  }
  
  if (propertyFilter) {
    propertyFilter.addEventListener('change', loadConversations);
  }
}

// ============================================
// OUVRIR UNE CONVERSATION
// ============================================
async function openChat(conversationId) {
  console.log('üí¨ Ouverture conversation:', conversationId);
  
  // üî• SUR MOBILE : Rediriger vers une page d√©di√©e
  if (isMobileDevice()) {
    // Sauvegarder l'ID de conversation
    sessionStorage.setItem('current_conversation_id', conversationId);
    
    // Rediriger vers la page de chat mobile
    // Pour Capacitor, utiliser le chemin complet
    const chatUrl = IS_NATIVE 
      ? `${window.location.origin}/chat-mobile.html?id=${conversationId}`
      : `/chat-mobile.html?id=${conversationId}`;
    
    console.log('üîÑ Redirection vers:', chatUrl);
    window.location.href = chatUrl;
    return;
  }
  
  // üíª SUR DESKTOP : Garder le modal (comportement actuel)
  currentConversationId = conversationId;
  const conv = allConversations.find(c => c.id == conversationId);
  
  if (!conv) return;
  
  // Mettre √† jour le titre avec le nom du voyageur
  const guestName = cleanGuestName(conv);
  const titleEl = document.getElementById('chatModalTitle');
  if (titleEl) {
    titleEl.textContent = guestName;
  }
  
  // Remplir les infos dans le header
  const propertyNameEl = document.getElementById('chatPropertyName');
  const checkinDateEl = document.getElementById('chatCheckinDate');
  
  if (propertyNameEl) propertyNameEl.textContent = conv.property_name || 'Logement';
  if (checkinDateEl) {
    const checkin = new Date(conv.reservation_start_date).toLocaleDateString('fr-FR');
    checkinDateEl.textContent = checkin;
  }
  
  // Afficher le bouton de copie du lien
  const copyLinkBtn = document.getElementById('btnCopyInviteLink');
  if (copyLinkBtn && conv.chat_token && conv.pin_code) {
    copyLinkBtn.style.display = 'inline-flex';
    copyLinkBtn.onclick = () => copyInviteLink(conv.chat_token, conv.pin_code);
  } else if (copyLinkBtn) {
    copyLinkBtn.style.display = 'none';
  }
  
  // Afficher le bouton Booking si c'est une r√©servation Booking
  const bookingBtn = document.getElementById('btnBookingMessage');
  if (bookingBtn) {
    const isBooking = (conv.platform || '').toLowerCase().includes('booking');
    bookingBtn.style.display = isBooking ? 'inline-flex' : 'none';
    if (isBooking) {
      bookingBtn.onclick = () => openBookingMessageModal(conversationId);
    }
  }
  
  // Afficher la modal
  const modal = document.getElementById('chatModal');
  if (modal) {
    modal.classList.add('active');
  }
  
  // ‚úÖ BLOQUER LE SCROLL DU BODY (FIX iOS)
  document.body.classList.add('modal-open');
  document.body.style.overflow = 'hidden';
  document.body.style.position = 'fixed';
  document.body.style.width = '100%';
  document.body.style.height = '100%';
  document.documentElement.style.overflow = 'hidden';
  
  // Charger les messages
  await loadMessages(conversationId);
  
  // Marquer comme lu
  await markMessagesAsRead(conversationId);
  
  // Rejoindre la room Socket.IO
  if (socket) {
    socket.emit('join_conversation', conversationId);
  }
}

async function markMessagesAsRead(conversationId) {
  try {
    const token = localStorage.getItem('lcc_token');
    await fetch(`/api/chat/mark-read/${conversationId}`, {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });
    
    // Recharger les conversations pour mettre √† jour le badge
    await loadConversations();
  } catch (error) {
    console.error('‚ùå Erreur marquage lu:', error);
  }
}

function closeChat() {
  const modal = document.getElementById('chatModal');
  if (modal) {
    modal.classList.remove('active');
  }
  
  // ‚úÖ D√âBLOQUER LE SCROLL DU BODY (FIX iOS)
  document.body.classList.remove('modal-open');
  document.body.style.overflow = '';
  document.body.style.position = '';
  document.body.style.width = '';
  document.body.style.height = '';
  document.documentElement.style.overflow = '';
  
  if (socket && currentConversationId) {
    socket.emit('leave_conversation', currentConversationId);
  }
  
  currentConversationId = null;
}

// ============================================
// MESSAGES
// ============================================
async function loadMessages(conversationId) {
  try {
    const token = localStorage.getItem('lcc_token');
    const response = await fetch(`/api/chat/messages/${conversationId}`, {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });
    
    if (!response.ok) {
      throw new Error('Erreur chargement messages');
    }
    
    const data = await response.json();
    
    if (data.success && data.messages) {
      displayMessages(data.messages);
    }
  } catch (error) {
    console.error('‚ùå Erreur chargement messages:', error);
    showToast('Erreur de chargement des messages', 'error');
  }
}

function displayMessages(messages) {
  const container = document.getElementById('chatMessages');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (!messages || messages.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-comments"></i>
        <p>Aucun message</p>
      </div>
    `;
    return;
  }
  
  messages.forEach(msg => appendMessage(msg));
  scrollToBottom();
}

function appendMessage(message) {
  const container = document.getElementById('chatMessages');
  if (!container) return;
  
  const isOwner = message.sender_type === 'owner';
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `chat-message ${isOwner ? 'owner' : 'guest'}`;
  
  const avatar = document.createElement('div');
  avatar.className = 'chat-avatar';
  avatar.textContent = isOwner ? 'üè†' : 'üë§';
  
  const contentDiv = document.createElement('div');
  contentDiv.className = 'chat-content';
  
  const sender = document.createElement('div');
  sender.className = 'chat-sender';
  sender.textContent = isOwner ? 'Vous' : 'Voyageur';
  
  const bubble = document.createElement('div');
  bubble.className = 'chat-bubble';
  bubble.textContent = message.message;
  
  // Meta : heure + statut
  const meta = document.createElement('div');
  meta.className = 'chat-meta';
  
  const time = document.createElement('span');
  time.className = 'chat-time';
  time.textContent = formatTime(message.created_at);
  
  const status = document.createElement('span');
  status.className = 'chat-status';
  status.textContent = (message.sender_type === 'owner') ? 'Envoy√©' : '';
  
  meta.appendChild(time);
  meta.appendChild(status);
  
  contentDiv.appendChild(sender);
  contentDiv.appendChild(bubble);
  contentDiv.appendChild(meta);
  
  messageDiv.appendChild(avatar);
  messageDiv.appendChild(contentDiv);
  
  container.appendChild(messageDiv);
  scrollToBottom();
}

async function sendMessageOwner() {
  const input = document.getElementById('chatInput');
  if (!input || !currentConversationId) return;
  
  const message = input.value.trim();
  if (!message) return;
  
  try {
    const token = localStorage.getItem('lcc_token');
    const response = await fetch(API_URL + '/api/chat/send', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({
        conversation_id: currentConversationId,
        message: message,
        sender_type: 'owner'
      })
    });
    
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      console.error('‚ùå Erreur serveur:', errorData);
      throw new Error(errorData.error || 'Erreur envoi message');
    }
    
    input.value = '';
    input.style.height = 'auto';
    // Le message sera ajout√© via Socket.IO
    
  } catch (error) {
    console.error('‚ùå Erreur envoi message:', error);
    showToast('Erreur lors de l\'envoi', 'error');
  }
}

function formatTime(timestamp) {
  const date = new Date(timestamp);
  const now = new Date();
  const isToday = date.toDateString() === now.toDateString();
  
  if (isToday) {
    return date.toLocaleTimeString('fr-FR', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
  } else {
    return date.toLocaleDateString('fr-FR', { 
      day: '2-digit', 
      month: 'short',
      hour: '2-digit',
      minute: '2-digit'
    });
  }
}

function scrollToBottom() {
  const container = document.getElementById('chatMessages');
  if (container) {
    container.scrollTop = container.scrollHeight;
  }
}

// ============================================
// G√âN√âRATION MESSAGE BOOKING
// ============================================
async function openBookingMessageModal(conversationId) {
  try {
    const token = localStorage.getItem('lcc_token');
    const response = await fetch(`/api/chat/generate-booking-message/${conversationId}`, {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });
    
    if (!response.ok) {
      throw new Error('Erreur g√©n√©ration message');
    }
    
    const data = await response.json();
    
    if (data.success && data.message) {
      // Copier dans le presse-papier
      await navigator.clipboard.writeText(data.message);
      
      // Afficher une notification
      showToast('‚úÖ Message copi√© dans le presse-papier !', 'success');
    }
  } catch (error) {
    console.error('‚ùå Erreur g√©n√©ration message:', error);
    showToast('‚ùå Erreur lors de la g√©n√©ration', 'error');
  }
}

// ============================================
// COPIER LE LIEN D'INVITATION
// ============================================
function copyInviteLink(token, pinCode) {
  const chatLink = `${window.location.origin}/chat/${token}`;
  const message = `üéâ Bonjour et merci pour votre r√©servation !

Pour faciliter votre s√©jour et recevoir toutes les informations importantes (acc√®s, livret d'accueil, etc.), merci de cliquer sur le lien ci-dessous :

üîó ${chatLink}

üìå Votre code de v√©rification : ${pinCode}

Vous devrez saisir :
- La date de votre arriv√©e
- La plateforme de r√©servation
- Ce code √† 4 chiffres

Au plaisir de vous accueillir ! üè†`;
  
  navigator.clipboard.writeText(message).then(
    () => {
      showToast('Message copi√© dans le presse-papier !', 'success');
    },
    err => {
      console.error('Erreur copie:', err);
      showToast('Erreur lors de la copie', 'error');
    }
  );
}

// ============================================
// SUPPRESSION DE CONVERSATION
// ============================================
async function deleteConversation(conversationId, event) {
  // Emp√™cher l'ouverture du chat
  event.stopPropagation();
  
  if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette conversation ? Cette action est irr√©versible.')) {
    return;
  }
  
  try {
    const token = localStorage.getItem('lcc_token');
    
    const response = await fetch(`/api/chat/conversations/${conversationId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });
    
    if (!response.ok) {
      const data = await response.json();
      throw new Error(data.error || 'Erreur lors de la suppression');
    }
    
    // Supprimer visuellement avec animation
    const conversationElement = document.querySelector(`[data-conversation-id="${conversationId}"]`);
    if (conversationElement) {
      conversationElement.style.transition = 'all 0.3s ease';
      conversationElement.style.opacity = '0';
      conversationElement.style.transform = 'translateX(-20px)';
      
      setTimeout(() => {
        conversationElement.remove();
        
        // Retirer de allConversations
        allConversations = allConversations.filter(c => c.id !== conversationId);
        
        // Mettre √† jour les stats
        updateStats();
        
        // Si plus aucune conversation, afficher le message vide
        const conversationsList = document.getElementById('conversationsList');
        if (conversationsList && conversationsList.children.length === 0) {
          conversationsList.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-comments"></i>
              <h3>Aucune conversation</h3>
              <p>Les conversations avec vos voyageurs appara√Ætront ici.</p>
            </div>
          `;
        }
      }, 300);
    }
    
    // Toast de confirmation
    showToast('Conversation supprim√©e avec succ√®s', 'success');
    
  } catch (error) {
    console.error('‚ùå Erreur suppression conversation:', error);
    showToast('Erreur: ' + error.message, 'error');
  }
}

// ============================================
// SOCKET.IO
// ============================================
function connectSocket() {
  console.log('üîå [SOCKET] Connexion √†:', API_URL);
  
  // Options Socket.io optimis√©es pour mobile natif
  const socketOptions = {
    transports: ['websocket', 'polling'], // Websocket en premier
    reconnection: true,
    reconnectionDelay: 1000,
    reconnectionDelayMax: 5000,
    reconnectionAttempts: 5,
    timeout: 20000
  };
  
  socket = io(API_URL, socketOptions);
  
  socket.on('connect', () => {
    console.log('‚úÖ Socket connect√©');
    
    // Rejoindre la room utilisateur pour les notifications
    if (userId) {
      socket.emit('join_user_room', userId);
    }
  });
  
  socket.on('connect_error', (error) => {
    console.error('‚ùå [SOCKET] Erreur de connexion:', error.message);
  });
  
  socket.on('new_message', (message) => {
    console.log('üì® Nouveau message re√ßu:', message);
    
    // Si c'est dans la conversation actuelle, afficher le message
    if (currentConversationId && message.conversation_id === currentConversationId) {
      appendMessage(message);
      scrollToBottom();
    }
    
    // Mettre √† jour le compteur de messages non lus
    loadConversations();
  });
  
  socket.on('new_notification', (notification) => {
    console.log('üîî Nouvelle notification:', notification);
    // Afficher une notification toast
    showToast('Nouveau message re√ßu', 'info');
    // Recharger les conversations
    loadConversations();
  });
  
  socket.on('messages_read', ({ conversationId }) => {
    console.log('‚úÖ Messages marqu√©s comme lus:', conversationId);
    // Recharger les conversations
    loadConversations();
  });
  
  socket.on('disconnect', () => {
    console.log('‚ùå Socket d√©connect√©');
  });
}

// ============================================
// LOADING & TOASTS
// ============================================
function showLoading() {
  const overlay = document.getElementById('loadingOverlay');
  if (overlay) {
    overlay.classList.add('active');
  }
}

function hideLoading() {
  const overlay = document.getElementById('loadingOverlay');
  if (overlay) {
    overlay.classList.remove('active');
  }
}

function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  
  // Fallback si pas de container
  if (!container) {
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    toast.style.cssText = `
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
    return;
  }

  const icons = {
    success: 'fa-check-circle',
    error: 'fa-exclamation-circle',
    info: 'fa-info-circle'
  };

  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <i class="fas ${icons[type] || icons.info}"></i>
    <span class="toast-message">${message}</span>
  `;

  container.appendChild(toast);

  setTimeout(() => {
    toast.classList.add('hide');
    setTimeout(() => {
      toast.remove();
    }, 300);
  }, 3500);
}

// ============================================
// GESTION CLAVIER
// ============================================
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && currentConversationId) {
    closeChat();
  }
});

// ============================================
// EXPOSER LES FONCTIONS GLOBALEMENT
// ============================================
window.openChat = openChat;
window.closeChat = closeChat;
window.sendMessageOwner = sendMessageOwner;
window.openBookingMessageModal = openBookingMessageModal;
window.copyInviteLink = copyInviteLink;
window.deleteConversation = deleteConversation;
window.cleanGuestName = cleanGuestName;
window.getGuestInitial = getGuestInitial;
window.getGuestPhone = getGuestPhone;
window.formatRelativeTime = formatTime; // Alias pour compatibilit√©

console.log('‚úÖ Chat owner initialized');

</script>
<!-- Auth + User -->
<script>
    (async function checkSubscriptionAccess() {
    const token = localStorage.getItem('lcc_token');
    
    if (!token) {
      window.location.href = '/login.html';
      return;
    }

   try {
  const res = await fetch('/api/subscription/status', {
    headers: { 'Authorization': 'Bearer ' + token }
  });

      if (!res.ok) {
        if (res.status === 401 || res.status === 403) {
          localStorage.removeItem('lcc_token');
          localStorage.removeItem('lcc_user');
          window.location.href = '/login.html';
        }
        return;
      }

      // ‚ö° V√©rifier content-type avant parsing
      const contentType = res.headers.get('content-type') || '';
      if (!contentType.includes('application/json')) {
        console.warn('‚ö†Ô∏è Subscription non-JSON');
        return;
      }
      const data = await res.json();

      if (data.status === 'expired' || data.status === 'canceled') {
        localStorage.removeItem('lcc_token');
        localStorage.removeItem('lcc_user');
        window.location.href = '/login.html?reason=expired';
        return;
      }
    } catch (err) {
      console.error('Erreur v√©rification abonnement:', err);
    }
    return;
  }

  // ‚úÖ V√©rifier que c'est du JSON
    })();
</script>

<script>
    (function() {
      const token = localStorage.getItem('lcc_token');

      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      const rawUser = localStorage.getItem('lcc_user');
      let user = null;

      try {
        user = rawUser ? JSON.parse(rawUser) : null;
      } catch (e) {
        console.error('Impossible de lire lcc_user', e);
      }

      if (user) {
        const nameEl = document.getElementById('sidebarUserName');
        const companyEl = document.getElementById('sidebarUserCompany');
        const avatarEl = document.getElementById('sidebarUserAvatar');

        if (nameEl) {
          nameEl.textContent = user.firstName
            ? user.firstName + (user.lastName ? ' ' + user.lastName : '')
            : (user.email || 'Mon compte');
        }

        if (companyEl) {
          companyEl.textContent = user.company || 'Mon espace';
        }

        if (avatarEl) {
          const initial = (user.firstName || user.email || '?').trim()[0] || 'U';
          avatarEl.textContent = initial.toUpperCase();
        }
      }

      //       const logoutBtn = document.getElementById('logoutBtn');
      //       if (logoutBtn) {
      //         logoutBtn.addEventListener('click', function () {
      //           localStorage.removeItem('lcc_token');
      //           localStorage.removeItem('lcc_user');
      //           window.location.href = '/login.html';
      //         });
      //       }

      // Mobile menu
      const menuBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebarOverlay');

      if (menuBtn && sidebar && overlay) {
        menuBtn.addEventListener('click', function() {
          sidebar.classList.toggle('active');
          overlay.classList.toggle('active');

          const icon = menuBtn.querySelector('i');
          if (sidebar.classList.contains('active')) {
            icon.classList.remove('fa-bars');
            icon.classList.add('fa-times');
          } else {
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
          }
        });

        overlay.addEventListener('click', function() {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          const icon = menuBtn.querySelector('i');
          icon.classList.remove('fa-times');
          icon.classList.add('fa-bars');
        });

        if (window.innerWidth <= 1024) {
          document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
              sidebar.classList.remove('active');
              overlay.classList.remove('active');
              const icon = menuBtn.querySelector('i');
              icon.classList.remove('fa-times');
              icon.classList.add('fa-bars');
            });
          });
        }
      }

      // Nav active
      const currentPage = document.body.getAttribute('data-page');
      if (currentPage) {
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.remove('active');
        });
        const activeLink = document.querySelector('.nav-item[data-page="messages"]');
        if (activeLink) {
          activeLink.classList.add('active');
        }
      }
    })();
  </script>

  <!-- ‚úÖ NOUVELLE FONCTION : Suppression de conversation -->
  <script>
// ============================================
// FONCTION SUPPRESSION DE CONVERSATION
// ============================================

async function deleteConversation(conversationId, event) {
  // Emp√™cher l'ouverture du chat
  event.stopPropagation();
  
  if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette conversation ? Cette action est irr√©versible.')) {
    return;
  }
  
  try {
    const token = localStorage.getItem('lcc_token');
    const API_URL = window.location.origin;
    
    const response = await fetch(`${API_URL}/api/chat/conversations/${conversationId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });
    
    if (!response.ok) {
      const data = await response.json();
      throw new Error(data.error || 'Erreur lors de la suppression');
    }
    
    // Supprimer visuellement
    const conversationElement = document.querySelector(`[data-conversation-id="${conversationId}"]`);
    if (conversationElement) {
      conversationElement.style.transition = 'all 0.3s ease';
      conversationElement.style.opacity = '0';
      conversationElement.style.transform = 'translateX(-20px)';
      
      setTimeout(() => {
        conversationElement.remove();
        
        // Mettre √† jour les stats
        updateConversationStats();
        
        // Si plus aucune conversation
        const conversationsList = document.getElementById('conversationsList');
        if (conversationsList && conversationsList.children.length === 0) {
          conversationsList.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-inbox"></i>
              <p>Aucune conversation</p>
            </div>
          `;
        }
      }, 300);
    }
    
    // Toast de confirmation
    showToast('Conversation supprim√©e', 'success');
    
  } catch (error) {
    console.error('Erreur suppression conversation:', error);
    showToast('Erreur: ' + error.message, 'error');
  }
}

// Fonction pour afficher les toasts
function showToast(message, type = 'info') {
  const toastContainer = document.getElementById('toastContainer');
  if (!toastContainer) return;
  
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.style.cssText = `
    padding: 16px 20px;
    background: ${type === 'success' ? '#10B981' : '#EF4444'};
    color: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    margin-bottom: 12px;
    animation: slideInRight 0.3s ease;
  `;
  toast.textContent = message;
  
  toastContainer.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOutRight 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Fonction pour mettre √† jour les stats apr√®s suppression
function updateConversationStats() {
  const conversations = document.querySelectorAll('.conversation-item');
  const total = conversations.length;
  
  let unread = 0;
  let active = 0;
  
  conversations.forEach(conv => {
    const unreadBadge = conv.querySelector('.unread-badge');
    if (unreadBadge) {
      unread += parseInt(unreadBadge.textContent) || 0;
    }
    
    const statusBadge = conv.querySelector('.status-badge.active');
    if (statusBadge) {
      active++;
    }
  });
  
  document.getElementById('statTotal').textContent = total;
  document.getElementById('statUnread').textContent = unread;
  document.getElementById('statActive').textContent = active;
}
  </script>

  <!-- Fonctions g√©n√©ration message de r√©servation -->
  <script>
// ============================================
// FONCTIONS G√âN√âRATION MESSAGE DE R√âSERVATION
// ============================================

async function openBookingMessageModal(conversationId) {
  if (!conversationId) {
    alert('Erreur: ID de conversation manquant');
    return;
  }

  try {
    // Cr√©er la modal
    const modal = createBookingMessageModal();
    document.body.appendChild(modal);

    // Afficher loading
    const modalContent = modal.querySelector('.booking-modal-content');
    modalContent.innerHTML = `
      <div style="text-align: center; padding: 48px;">
        <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: var(--primary-color); margin-bottom: 16px;"></i>
        <p style="color: var(--text-secondary);">G√©n√©ration du message...</p>
      </div>
    `;

    // R√©cup√©rer le message
    const token = localStorage.getItem('lcc_token');
    const API_URL = window.location.origin;
    const response = await fetch(`${API_URL}/api/chat/generate-booking-message/${conversationId}`, {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || 'Erreur de g√©n√©ration');
    }

    // Afficher le message
    displayBookingMessage(modalContent, data);

  } catch (error) {
    console.error('Erreur g√©n√©ration message:', error);
    alert('Erreur: ' + error.message);
    closeBookingMessageModal();
  }
}

function createBookingMessageModal() {
  const modal = document.createElement('div');
  modal.id = 'bookingMessageModal';
  modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;z-index:10000;display:flex;align-items:center;justify-content:center;';
  
  modal.innerHTML = `
    <div onclick="closeBookingMessageModal()" style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);"></div>
    <div style="position:relative;background:white;border-radius:16px;width:90%;max-width:600px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:24px;border-bottom:1px solid #e5e7eb;">
        <h2 style="font-size:20px;font-weight:700;color:#111827;display:flex;align-items:center;gap:12px;margin:0;">
          <i class="fas fa-paper-plane"></i>
          Message de r√©servation
        </h2>
        <button onclick="closeBookingMessageModal()" style="width:36px;height:36px;border:none;background:#f9fafb;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="booking-modal-content" style="padding:24px;"></div>
    </div>
  `;
  return modal;
}

function displayBookingMessage(container, data) {
  const { message, hasCleaningPhotos, cleaningPhotoCount, pinCode, links } = data;

  container.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:24px;">
      <div style="display:flex;align-items:center;gap:12px;padding:12px;background:#f9fafb;border-radius:8px;border-left:4px solid #3B82F6;">
        <i class="fas fa-key" style="font-size:20px;color:#3B82F6;"></i>
        <div><strong>Code PIN:</strong> ${pinCode}</div>
      </div>
      ${hasCleaningPhotos ? `
        <div style="display:flex;align-items:center;gap:12px;padding:12px;background:#D1FAE5;border-radius:8px;border-left:4px solid #10B981;">
          <i class="fas fa-check-circle" style="font-size:20px;color:#10B981;"></i>
          <div><strong>Photos de nettoyage:</strong> ${cleaningPhotoCount} photo(s) disponible(s)</div>
        </div>
      ` : `
        <div style="display:flex;align-items:center;gap:12px;padding:12px;background:#FEF3C7;border-radius:8px;border-left:4px solid #F59E0B;">
          <i class="fas fa-exclamation-triangle" style="font-size:20px;color:#F59E0B;"></i>
          <div><strong>Attention:</strong> Aucune photo de nettoyage trouv√©e</div>
        </div>
      `}
    </div>

    <div style="background:#f9fafb;border-radius:12px;padding:16px;margin-bottom:20px;">
      <div style="display:flex;align-items:center;gap:8px;font-size:14px;font-weight:600;color:#6B7280;margin-bottom:12px;">
        <i class="fas fa-eye"></i>
        Aper√ßu du message
      </div>
      <div id="messageText" style="background:white;border:1px solid #e5e7eb;border-radius:8px;padding:16px;font-size:14px;line-height:1.6;color:#111827;white-space:pre-wrap;max-height:400px;overflow-y:auto;">${message.replace(/\n/g, '<br>')}</div>
    </div>

    <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;">
      <button onclick="copyBookingMessage()" style="flex:1;min-width:200px;padding:14px 24px;background:#3B82F6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
        <i class="fas fa-copy"></i>
        Copier le message
      </button>
      <button onclick="previewLinks('${links.cleaningPhotos || ''}', '${links.checkoutForm}')" style="padding:14px 24px;background:white;color:#3B82F6;border:2px solid #3B82F6;border-radius:8px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;">
        <i class="fas fa-external-link-alt"></i>
        Tester les liens
      </button>
    </div>

    <div style="display:flex;gap:12px;padding:16px;background:#EFF6FF;border-radius:8px;font-size:13px;color:#1E40AF;">
      <i class="fas fa-info-circle" style="font-size:18px;margin-top:2px;flex-shrink:0;"></i>
      <p style="margin:0;"><strong>Instructions :</strong> Copiez ce message et collez-le dans votre messagerie Airbnb ou Booking.com pour l'envoyer √† votre voyageur.</p>
    </div>
  `;
}

function copyBookingMessage() {
  const messageText = document.getElementById('messageText');
  if (!messageText) return;

  const text = messageText.innerText || messageText.textContent;
  
  navigator.clipboard.writeText(text).then(() => {
    alert('‚úÖ Message copi√© dans le presse-papier !');
  }).catch(err => {
    console.error('Erreur copie:', err);
    alert('‚ùå Erreur lors de la copie');
  });
}

function previewLinks(cleaningPhotosLink, checkoutFormLink) {
  let opened = false;
  
  if (cleaningPhotosLink && cleaningPhotosLink !== 'null' && cleaningPhotosLink !== '') {
    window.open(cleaningPhotosLink, '_blank');
    opened = true;
  }
  if (checkoutFormLink && checkoutFormLink !== 'null' && checkoutFormLink !== '') {
    window.open(checkoutFormLink, '_blank');
    opened = true;
  }
  
  if (!opened) {
    alert('Aucun lien √† tester');
  }
}

function closeBookingMessageModal() {
  const modal = document.getElementById('bookingMessageModal');
  if (modal) {
    modal.remove();
  }
}
  </script>

<!-- ‚úÖ ULTIMATE FIX iOS - Version simple -->
<script>
// Attendre que le DOM soit pr√™t
document.addEventListener('DOMContentLoaded', function() {
  console.log('‚úÖ Ultimate iOS fix - Version simple charg√©e');
});
</script>

<script src="/js/bh-layout.js"></script>
<script src="/js/logout-fix.js"></script>
<script src="/js/mobile-native-experience.js"></script>
<script src="/js/mobile-tabs-handler.js"></script>
<!-- chat-emoji-photo removed - emoji bar not wanted -->
<script src="/js/messages-badge-desktop-mobile.js"></script> 
<script>
// Fix scroll iOS Capacitor
if (window.Capacitor && window.Capacitor.isNativePlatform()) {
  console.log('üîí iOS Modal Fix activ√©');
  
  // Observer quand le modal s'ouvre
  const observer = new MutationObserver(() => {
    const modal = document.querySelector('.modal-overlay.active');
    if (modal) {
      console.log('üîí Modal ouvert - Blocage scroll');
      document.body.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      document.body.style.width = '100%';
      document.body.style.height = '100vh';
    } else {
      console.log('üîì Modal ferm√© - D√©blocage scroll');
      document.body.style.overflow = '';
      document.body.style.position = '';
      document.body.style.width = '';
      document.body.style.height = '';
    }
  });
  
  observer.observe(document.body, {
    childList: true,
    subtree: true,
    attributes: true,
    attributeFilter: ['class']
  });
}
</script>

<script>
// ============================================================
// PATCH: inline chat panel + photo upload + utilities
// Runs AFTER chat-owner.js (correct order)
// ============================================================
(function() {

  // ‚îÄ‚îÄ Show inline chat panel ‚îÄ‚îÄ
  function showInlineChat(conv) {
    document.getElementById('msgsChatPlaceholder').style.display = 'none';
    document.getElementById('msgsChatHeader').style.display = 'flex';
    document.getElementById('chatMessages').style.display = 'flex';
    document.getElementById('chatInputArea').style.display = 'flex';

    // Avatar: letter + color matching conversation list
    var avatarEl = document.getElementById('msgsChatAvatar');
    if (conv && avatarEl) {
      var name = conv.guest_display_name || conv.guest_first_name || conv.guest_name || 'V';
      avatarEl.textContent = name.charAt(0).toUpperCase();
      avatarEl.style.background = conv.property_color || '#1A7A5E';
    }

    // Platform in meta
    var platEl = document.getElementById('chatPlatform');
    if (conv && platEl) platEl.textContent = conv.platform || '';

    // Active state in list
    document.querySelectorAll('#conversationsList .conversation-item').forEach(function(el) {
      el.classList.toggle('active', String(el.dataset.conversationId) === String(conv && conv.id));
    });

    // Unlock scroll (chat-owner.js locks it)
    setTimeout(function() {
      document.body.style.overflow = '';
      document.body.style.position = '';
      document.body.style.width = '';
      document.body.style.height = '';
      document.body.classList.remove('modal-open');
      document.documentElement.style.overflow = '';
    }, 30);
  }

  // ‚îÄ‚îÄ Override openChat after chat-owner.js loaded ‚îÄ‚îÄ
  function patchOpenChat() {
    var orig = window.openChat;
    if (!orig || orig._bhPatched) return;

    window.openChat = function(conversationId) {
      // Force desktop mode (prevent redirect to chat-mobile.html)
      var origIsMobile = window.isMobileDevice;
      window.isMobileDevice = function() { return false; };

      // Call original ‚Üí populates #chatMessages, #chatModalTitle, etc.
      orig.call(this, conversationId);

      // Restore
      window.isMobileDevice = origIsMobile;

      // Show our inline panel
      setTimeout(function() {
        var conv = (window.allConversations || []).find(function(c) {
          return String(c.id) === String(conversationId);
        });
        showInlineChat(conv || { id: conversationId });
      }, 80);
    };
    window.openChat._bhPatched = true;
  }

  // ‚îÄ‚îÄ Close conversation ‚îÄ‚îÄ
  window.closeCurrentConversation = function() {
    var convId = window.currentConversationId;
    if (!convId) return;
    if (!confirm('Clore cette conversation ? Elle passera en bas de liste.')) return;

    var token = localStorage.getItem('lcc_token');
    fetch('/api/chat/conversations/' + convId, {
      method: 'PATCH',
      headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: 'closed' })
    }).catch(function() {});

    var item = document.querySelector('#conversationsList [data-conversation-id="' + convId + '"]');
    if (item) {
      item.style.opacity = '0.45';
      item.style.filter = 'grayscale(0.5)';
      document.getElementById('conversationsList').appendChild(item);
    }

    var btn = document.getElementById('chatCloseConvBtn');
    if (btn) {
      btn.innerHTML = '<i class="fas fa-undo"></i> Rouvrir';
      btn.onclick = function() {
        fetch('/api/chat/conversations/' + convId, {
          method: 'PATCH',
          headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'active' })
        }).catch(function() {});
        if (item) { item.style.opacity = ''; item.style.filter = ''; }
        btn.innerHTML = '<i class="fas fa-check-circle"></i> Clore la conversation';
      };
    }
  };

  // ‚îÄ‚îÄ Photo upload (Cloudinary) ‚îÄ‚îÄ
  window.openPhotoUpload = function() {
    var input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.multiple = true;
    input.style.display = 'none';

    input.addEventListener('change', async function(e) {
      var files = Array.from(e.target.files);
      if (!files.length) { input.remove(); return; }

      var btn = document.getElementById('photoUploadBtn');
      if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; }

      try {
        for (var i = 0; i < files.length; i++) {
          var file = files[i];
          if (!file.type.startsWith('image/')) throw new Error('Doit √™tre une image');
          if (file.size > 5 * 1024 * 1024) throw new Error('Max 5MB');

          var formData = new FormData();
          formData.append('file', file);
          formData.append('upload_preset', 'chat-photos');

          var res = await fetch('https://api.cloudinary.com/v1_1/dvn95fhbx/image/upload', {
            method: 'POST', body: formData
          });
          if (!res.ok) throw new Error('Erreur upload Cloudinary');
          var data = await res.json();
          var imageUrl = data.secure_url;

          // Send via API (correct field names from server.js)
          var token = localStorage.getItem('lcc_token');
          await fetch('/api/chat/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({
              conversation_id: window.currentConversationId,
              message: '[IMAGE:' + imageUrl + ']',
              sender_type: 'owner',
              sender_name: 'Vous'
            })
          });
        }
      } catch(err) {
        alert('Erreur photo: ' + err.message);
      } finally {
        if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-image"></i>'; }
        input.remove();
      }
    });

    document.body.appendChild(input);
    input.click();
  };

  // ‚îÄ‚îÄ Render [IMAGE:url] as actual <img> in bubbles ‚îÄ‚îÄ
  function fixImageBubbles(root) {
    (root || document).querySelectorAll('#chatMessages .chat-bubble').forEach(function(bubble) {
      var text = bubble.textContent || '';
      var m = text.match(/\[IMAGE:(https?:\/\/[^\]]+)\]/);
      if (m) {
        bubble.innerHTML = '<img src="' + m[1] + '" style="max-width:220px;max-height:180px;border-radius:10px;cursor:pointer;display:block;" onclick="window.open(this.src,'_blank')" />';
      }
    });
  }

  // ‚îÄ‚îÄ Search ‚îÄ‚îÄ
  function initSearch() {
    var input = document.getElementById('msgsSearchInput');
    if (!input) return;
    input.addEventListener('input', function() {
      var q = this.value.toLowerCase();
      document.querySelectorAll('#conversationsList .conversation-item').forEach(function(item) {
        var h3 = item.querySelector('h3');
        item.style.display = (h3 && h3.textContent.toLowerCase().includes(q)) ? '' : 'none';
      });
    });
  }

  // ‚îÄ‚îÄ Property label injection ‚îÄ‚îÄ
  function injectPropertyLabels() {
    document.querySelectorAll('#conversationsList .conversation-item').forEach(function(item) {
      if (item.querySelector('.conv-property')) return;
      var badge = item.querySelector('.property-badge');
      if (!badge) return;
      var name = badge.textContent.trim();
      if (!name || name === 'Logement') return;
      var color = badge.style.color || '#1A7A5E';
      var h3 = item.querySelector('.conversation-info h3');
      if (!h3) return;
      var el = document.createElement('div');
      el.className = 'conv-property';
      el.textContent = name;
      el.style.color = color;
      h3.parentNode.insertBefore(el, h3.nextSibling);
    });
  }

  // ‚îÄ‚îÄ Hide back button from bh-layout.js ‚îÄ‚îÄ
  function hideBackBtn() {
    document.querySelectorAll('.header-actions .btn-ghost, .header-actions .btn.btn-ghost').forEach(function(el) {
      el.style.display = 'none';
    });
  }

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
  document.addEventListener('DOMContentLoaded', function() {
    initSearch();

    // Watch conversationsList
    var list = document.getElementById('conversationsList');
    if (list) {
      new MutationObserver(function() {
        injectPropertyLabels();
        hideBackBtn();
      }).observe(list, { childList: true, subtree: true });
    }

    // Watch chatMessages for image rendering
    var msgs = document.getElementById('chatMessages');
    if (msgs) {
      new MutationObserver(function() { fixImageBubbles(); }).observe(msgs, { childList: true, subtree: true });
    }
  });

  // Patch openChat as soon as it's available
  var interval = setInterval(function() {
    if (window.openChat) { patchOpenChat(); clearInterval(interval); }
  }, 50);

  setTimeout(function() {
    patchOpenChat();
    hideBackBtn();
    injectPropertyLabels();
  }, 1000);

})();
</script>

<style>
.view-selector { display: none !important; }
</style>


<style>
/* FINAL OVERRIDES */
/* Owner bubble dark */
.chat-message.owner .chat-bubble,
[class*="chat"] .owner .chat-bubble,
.chat-bubble.owner-bubble { 
  background: #0D1117 !important; 
  color: #ffffff !important; 
}
/* Messages area beige */
#chatMessages,
.chat-modal-messages { 
  background: #F5F2EC !important; 
}
/* Right panel beige when no conversation */
.msgs-right {
  background: #F5F2EC !important;
}
#msgsChatPlaceholder {
  background: #F5F2EC !important;
}
</style>


<script>
// Move back button into bh-layout header + hide the btn-ghost back link
(function() {
  function fixHeader() {
    var headerActions = document.querySelector('header.main-header .header-actions');
    var backBtn = document.getElementById('msgsDirectBackBtn');
    if (headerActions && backBtn && !backBtn._moved) {
      // Hide the btn-ghost (retour au dashboard from bh-layout)
      headerActions.querySelectorAll('.btn-ghost, .btn.btn-ghost').forEach(function(el) {
        el.style.display = 'none';
      });
      // Move our button into header-actions at the start
      headerActions.insertBefore(backBtn, headerActions.firstChild);
      backBtn.style.position = '';
      backBtn._moved = true;
    }
  }
  
  // Try immediately and via MutationObserver on #bhHeader
  var bhHeader = document.getElementById('bhHeader');
  if (bhHeader) {
    new MutationObserver(function() { fixHeader(); }).observe(bhHeader, { childList: true, subtree: true });
  }
  setTimeout(fixHeader, 300);
  setTimeout(fixHeader, 800);
})();
</script>

</body>
</html>
