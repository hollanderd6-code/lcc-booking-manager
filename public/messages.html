<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Messages – LCC Booking Manager</title>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <!-- CSS plateforme -->
  <link rel="stylesheet" href="/css/style.css">

  <style>
    html, body {
      margin: 0 !important;
      padding: 0 !important;
    }

    .main-content {
      padding-top: 24px !important;
    }

    .page-content {
      margin-top: 0 !important;
    }

    .messages-page-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .messages-page-title i {
      color: var(--primary-color);
    }

    /* ===== Ancien style réadapté en mode "cards" ===== */

    .timeline-section {
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid var(--border-color);
    }
    
    .timeline-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .timeline-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
    }
    
    .timeline-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .timeline-count {
      background: var(--primary-light);
      color: var(--primary-color);
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      margin-left: auto;
    }
    
    .reservation-list {
      display: grid;
      gap: 16px;
    }
    
    .reservation-item {
      padding: 16px;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      border-left: 4px solid var(--primary-color);
      transition: var(--transition);
    }
    
    .reservation-item:hover {
      box-shadow: var(--shadow-sm);
      transform: translateX(4px);
    }
    
    .reservation-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    
    .reservation-info h3 {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    
    .reservation-meta {
      color: var(--text-secondary);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    .empty-state i {
      font-size: 40px;
      opacity: 0.3;
      margin-bottom: 12px;
    }

    /* ============================================
       ASSISTANT IA - RÉDACTION VOYAGEURS
       ============================================ */

    .ai-section {
      border-left: 4px solid var(--accent-color);
    }

    .message-reply-body {
      margin-top: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
    }

    .message-reply-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      display: block;
      margin-bottom: 6px;
    }

    .message-reply-input {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      padding: var(--spacing-md);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      font-family: inherit;
      font-size: 14px;
      line-height: 1.5;
      color: var(--text-primary);
    }

    .message-reply-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 1px var(--primary-light);
    }

    .message-reply-footer {
      margin-top: var(--spacing-md);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: var(--spacing-md);
      flex-wrap: wrap;
    }

    .message-reply-ai {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      flex: 1;
      min-width: 260px;
    }

    .btn-ai {
      white-space: nowrap;
    }

    .message-reply-hint {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .message-reply-actions {
      display: flex;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
    }

    @media (max-width: 768px) {
      .message-reply-footer {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    .copy-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-fast);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    
    .copy-btn:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    .copy-btn.copied {
      background: #16a34a;
    }

    /* ============================================
       MESSAGES ÉQUIPE MÉNAGE
       ============================================ */

    .cleaning-messages-section {
      margin-top: var(--spacing-xl);
    }

    .cleaning-controls {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .cleaning-controls input[type="date"] {
      padding: 8px 10px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      font-size: 14px;
    }

    .cleaning-hint {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .cleaning-messages-container {
      display: grid;
      gap: var(--spacing-md);
    }

    .cleaning-message-card {
      padding: var(--spacing-md);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
    }

    .cleaning-message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--spacing-sm);
      margin-bottom: 8px;
    }

    .cleaning-message-title {
      font-weight: 600;
      font-size: 14px;
    }

    .cleaning-message-meta {
      font-size: 12px;
      color: var(--text-secondary);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .cleaning-message-textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      padding: var(--spacing-sm);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      font-size: 13px;
      font-family: inherit;
      line-height: 1.5;
      margin-top: 8px;
    }

    .badge-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="app-container">
    
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="/" class="sidebar-logo">
          <i class="fas fa-home"></i>
          <div class="sidebar-logo-text">
            <span class="sidebar-logo-title">LCC Booking</span>
            <span class="sidebar-logo-subtitle">La Conciergerie de Charles</span>
          </div>
        </a>
      </div>
      
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Principal</div>
          <a href="/app.html" class="nav-item">
            <i class="fas fa-th-large"></i>
            <span>Dashboard</span>
          </a>
          <a href="/app.html#calendarSection" class="nav-item" id="navCalendarLink">
            <i class="fas fa-calendar"></i>
            <span>Calendrier</span>
          </a>
          <a href="/messages.html" class="nav-item active">
            <i class="fas fa-comment-dots"></i>
            <span>Messages</span>
          </a>
        </div>
        
        <div class="nav-section">
          <div class="nav-section-title">Gestion</div>
          <a href="/settings.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Mes logements</span>
          </a>
          <a href="/welcome.html" class="nav-item">
            <i class="fas fa-book-open"></i>
            <span>Livret d'accueil</span>
          </a>
          <a href="/cleaning.html" class="nav-item">
            <i class="fas fa-broom"></i>
            <span>Gestion du ménage</span>
          </a>
          <a href="#" class="nav-item">
            <i class="fas fa-chart-bar"></i>
            <span>Statistiques</span>
          </a>
          <a href="#" class="nav-item">
            <i class="fas fa-bell"></i>
            <span>Notifications</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Paramètres</div>
          <a href="/settings-account.html" class="nav-item">
            <i class="fas fa-cog"></i>
            <span>Paramètres</span>
          </a>
          <a href="/help.html" class="nav-item">
            <i class="fas fa-question-circle"></i>
            <span>Aide</span>
          </a>
        </div>
      </nav>
      
      <div class="sidebar-footer">
        <div class="user-profile">
          <div class="user-avatar" id="sidebarUserAvatar">C</div>
          <div class="user-info">
            <div class="user-name" id="sidebarUserName">Utilisateur</div>
            <div class="user-email" id="sidebarUserCompany">Mon espace</div>
          </div>

          <button class="btn btn-ghost" id="logoutBtn" style="padding: 4px 10px; font-size: 12px; margin-left: auto;">
            <i class="fas fa-sign-out-alt"></i>
            <span>Quitter</span>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main-content">
      <!-- Header -->
      <header class="main-header">
        <div class="header-left">
          <div class="page-kicker">Communication</div>
          <h1 class="page-title messages-page-title">
            <i class="fas fa-comment-dots"></i>
            Messages
          </h1>
          <p class="page-subtitle">
            Préparez vos messages pour les voyageurs et vos équipes en quelques clics.
          </p>
        </div>
      </header>

      <!-- Page Content -->
      <div class="page-content">

        <!-- Assistant IA voyageurs -->
        <section class="timeline-section ai-section">
          <div class="timeline-header">
            <div class="timeline-icon" style="background: #8b5cf6;">
              <i class="fas fa-wand-magic-sparkles"></i>
            </div>
            <div class="timeline-title">Assistant de rédaction – voyageurs</div>
          </div>

          <div class="message-reply-body">
            <label for="aiContext" class="message-reply-label">
              Contexte du message (collez ici le message du voyageur ou décrivez la situation)
            </label>
            <textarea
              id="aiContext"
              class="message-reply-input"
              rows="4"
              placeholder="Exemples :&#10;- Demande d’arrivée tardive vers 23h&#10;- Le client demande si les draps sont fournis&#10;- Réponse à une réclamation sur le ménage"
            ></textarea>
          </div>

          <div class="message-reply-body">
            <label for="aiReply" class="message-reply-label">
              Proposition de réponse
            </label>
            <textarea
              id="aiReply"
              class="message-reply-input"
              rows="5"
              placeholder="La réponse proposée par l’IA apparaîtra ici. Vous pourrez la modifier avant de la copier."
            ></textarea>
          </div>

          <div class="message-reply-footer">
            <div class="message-reply-ai">
              <button type="button" class="btn btn-secondary btn-ai" id="aiSuggestBtn">
                <i class="fas fa-magic"></i>
                Proposer une réponse avec l’IA
              </button>
              <span class="message-reply-hint" id="aiHint">
                L’IA rédigera un brouillon poli et professionnel à partir du contexte.
              </span>
            </div>

            <div class="message-reply-actions">
              <button type="button" class="btn btn-ghost" id="aiClearBtn">
                Effacer
              </button>
              <button type="button" class="btn btn-primary copy-btn" id="aiCopyBtn">
                <i class="fas fa-copy"></i>
                Copier la réponse
              </button>
            </div>
          </div>
        </section>

        <!-- Messages rapides pour arrivées / départs (timeline) -->
        <section class="timeline-section">
          <div class="timeline-header">
            <div class="timeline-icon" style="background:#10b981;">
              <i class="fas fa-bolt"></i>
            </div>
            <div class="timeline-title">Messages rapides – arrivées & séjours</div>
          </div>

          <!-- Arrivées aujourd'hui -->
          <div class="timeline-section" id="checkinsToday">
            <div class="timeline-header">
              <div class="timeline-icon" style="background: #e74c3c;">
                <i class="fas fa-door-open"></i>
              </div>
              <div class="timeline-title">Arrivées aujourd'hui</div>
              <div class="timeline-count" id="countToday">0</div>
            </div>
            <div class="reservation-list" id="listToday"></div>
          </div>

          <!-- Arrivées demain -->
          <div class="timeline-section" id="checkinsTomorrow">
            <div class="timeline-header">
              <div class="timeline-icon" style="background: #f39c12;">
                <i class="fas fa-calendar-day"></i>
              </div>
              <div class="timeline-title">Arrivées demain</div>
              <div class="timeline-count" id="countTomorrow">0</div>
            </div>
            <div class="reservation-list" id="listTomorrow"></div>
          </div>

          <!-- Prochains 7 jours -->
          <div class="timeline-section" id="checkinsNext7">
            <div class="timeline-header">
              <div class="timeline-icon" style="background: #3498db;">
                <i class="fas fa-calendar-week"></i>
              </div>
              <div class="timeline-title">Prochains 7 jours</div>
              <div class="timeline-count" id="countNext7">0</div>
            </div>
            <div class="reservation-list" id="listNext7"></div>
          </div>

          <!-- Séjours en cours -->
          <div class="timeline-section" id="currentStays">
            <div class="timeline-header">
              <div class="timeline-icon" style="background: #2ecc71;">
                <i class="fas fa-home"></i>
              </div>
              <div class="timeline-title">Séjours en cours</div>
              <div class="timeline-count" id="countCurrent">0</div>
            </div>
            <div class="reservation-list" id="listCurrent"></div>
          </div>

          <!-- Départs aujourd'hui -->
          <div class="timeline-section" id="checkoutsToday">
            <div class="timeline-header">
              <div class="timeline-icon" style="background: #95a5a6;">
                <i class="fas fa-sign-out-alt"></i>
              </div>
              <div class="timeline-title">Départs aujourd'hui</div>
              <div class="timeline-count" id="countCheckouts">0</div>
            </div>
            <div class="reservation-list" id="listCheckouts"></div>
          </div>
        </section>

        <!-- Messages équipe ménage (à partir du planning) -->
        <section class="timeline-section cleaning-messages-section">
          <div class="timeline-header">
            <div class="timeline-icon" style="background:#0f766e;">
              <i class="fas fa-broom"></i>
            </div>
            <div class="timeline-title">Messages à envoyer à l’équipe ménage</div>
          </div>

          <div class="cleaning-controls">
            <div style="display:flex; flex-direction:column; gap:4px;">
              <label for="cleaningMsgDate" style="font-size:13px; font-weight:600; color:var(--text-secondary);">
                Date des interventions
              </label>
              <input type="date" id="cleaningMsgDate">
            </div>
            <button type="button" class="btn btn-secondary" id="generateCleaningMessagesBtn">
              <i class="fas fa-wand-magic-sparkles"></i>
              Générer les messages ménage
            </button>
            <span class="cleaning-hint" id="cleaningMsgHint">
              Les messages sont construits à partir de vos réservations, logements et assignations ménage.
            </span>
          </div>

          <div id="cleaningMessagesContainer" class="cleaning-messages-container">
            <p class="empty-state">
              <i class="fas fa-comment-slash"></i><br>
              Choisissez une date puis générez les messages pour vos intervenants ménage.
            </p>
          </div>
        </section>

      </div>
    </main>
  </div>

  <!-- Toast / loading (réutilisés depuis ton style global) -->
  <div class="toast-container" id="toastContainer"></div>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Chargement...</p>
    </div>
  </div>

  <!-- Script logique messages rapides (existant) -->
  <script src="/js/messages.js"></script>

  <!-- Script auth + user + logout -->
  <script>
    (function () {
      const token = localStorage.getItem('lcc_token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      const rawUser = localStorage.getItem('lcc_user');
      let user = null;

      try {
        user = rawUser ? JSON.parse(rawUser) : null;
      } catch (e) {
        console.error('Impossible de lire lcc_user', e);
      }

      if (user) {
        const nameEl = document.getElementById('sidebarUserName');
        const companyEl = document.getElementById('sidebarUserCompany');
        const avatarEl = document.getElementById('sidebarUserAvatar');

        if (nameEl) {
          nameEl.textContent = user.firstName
            ? user.firstName + (user.lastName ? ' ' + user.lastName : '')
            : (user.email || 'Mon compte');
        }

        if (companyEl) {
          companyEl.textContent = user.company || 'Mon espace';
        }

        if (avatarEl) {
          const initial = (user.firstName || user.email || '?').trim()[0] || 'U';
          avatarEl.textContent = initial.toUpperCase();
        }
      }

      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function () {
          localStorage.removeItem('lcc_token');
          localStorage.removeItem('lcc_user');
          window.location.href = '/login.html';
        });
      }
    })();
  </script>

  <!-- Script Assistant IA voyageurs + SMS ménage -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      /* ===== Assistant IA voyageurs ===== */
      const aiContext = document.getElementById('aiContext');
      const aiReply = document.getElementById('aiReply');
      const aiSuggestBtn = document.getElementById('aiSuggestBtn');
      const aiHint = document.getElementById('aiHint');
      const aiClearBtn = document.getElementById('aiClearBtn');
      const aiCopyBtn = document.getElementById('aiCopyBtn');

      if (aiContext && aiReply && aiSuggestBtn) {
        async function fetchAiSuggestion(contextText) {
          const intro = "Bonjour,";
          let core;

          if (contextText && contextText.length > 10) {
            core = "Merci pour votre message. " +
              "Je vous confirme avoir bien pris en compte votre demande. " +
              "Je reste bien entendu disponible si vous avez la moindre question ou besoin supplémentaire pendant votre séjour.";
          } else {
            core = "Merci pour votre message. " +
              "Je reste à votre disposition pour toute question ou précision concernant votre arrivée ou votre séjour.";
          }

          return (
            intro + "\n\n" +
            core + "\n\n" +
            "Bien cordialement,\nLa Conciergerie de Charles"
          );
        }

        aiSuggestBtn.addEventListener('click', async () => {
          const contextText = aiContext.value.trim();

          aiSuggestBtn.disabled = true;
          aiSuggestBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération…';
          aiHint.textContent = "Génération d’un brouillon de réponse…";

          try {
            const suggestion = await fetchAiSuggestion(contextText);

            if (!aiReply.value.trim()) {
              aiReply.value = suggestion;
            } else {
              aiReply.value = aiReply.value.trim() + "\n\n" + suggestion;
            }

            aiHint.textContent = "Brouillon généré. Tu peux le modifier avant de le copier dans Airbnb/Booking.";
          } catch (e) {
            console.error(e);
            aiHint.textContent = "Impossible de générer une réponse pour le moment.";
          } finally {
            aiSuggestBtn.disabled = false;
            aiSuggestBtn.innerHTML = '<i class="fas fa-magic"></i> Proposer une réponse avec l’IA';
          }
        });

        if (aiClearBtn) {
          aiClearBtn.addEventListener('click', () => {
            aiContext.value = '';
            aiReply.value = '';
            aiHint.textContent = "L’IA rédigera un brouillon poli et professionnel à partir du contexte.";
          });
        }

        if (aiCopyBtn) {
          aiCopyBtn.addEventListener('click', async () => {
            const text = aiReply.value.trim();
            if (!text) return;

            try {
              if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
                aiCopyBtn.classList.add('copied');
                aiCopyBtn.innerHTML = '<i class="fas fa-check"></i> Copié !';
                setTimeout(() => {
                  aiCopyBtn.classList.remove('copied');
                  aiCopyBtn.innerHTML = '<i class="fas fa-copy"></i> Copier la réponse';
                }, 1500);
              } else {
                const temp = document.createElement('textarea');
                temp.value = text;
                document.body.appendChild(temp);
                temp.select();
                document.execCommand('copy');
                document.body.removeChild(temp);
              }
            } catch (e) {
              console.error(e);
            }
          });
        }
      }

      /* ===== Messages équipe ménage à partir du planning ===== */

      const STORAGE_CLEANERS = 'lcc_cleaners';
      const STORAGE_ASSIGN = 'lcc_cleaning_assignments';

      const PROPERTIES = window.LCC_PROPERTIES || [
        { id: 'apt-demo-1', name: 'Appartement démo 1' },
        { id: 'apt-demo-2', name: 'Appartement démo 2' }
      ];
      const RESERVATIONS = window.LCC_RESERVATIONS || [];

      let cleaners = [];
      let assignments = {};

      function loadCleaningData() {
        try {
          cleaners = JSON.parse(localStorage.getItem(STORAGE_CLEANERS)) || [];
          assignments = JSON.parse(localStorage.getItem(STORAGE_ASSIGN)) || {};
        } catch (e) {
          cleaners = [];
          assignments = {};
        }
      }

      function normalizeDateString(dateStr) {
        return dateStr ? dateStr.slice(0, 10) : null;
      }

      function getPropertyName(propertyId) {
        const p = PROPERTIES.find(x => x.id === propertyId || x.propertyId === propertyId);
        return p ? (p.name || p.title || p.label || propertyId) : (propertyId || 'Logement');
      }

      function getCleanerById(id) {
        return cleaners.find(c => c.id === id) || null;
      }

      // Génère la liste de tâches ménage (départs / arrivées) pour une date donnée
      function generateCleaningTasks(dateStr) {
        if (!dateStr) return [];

        const tasks = [];

        RESERVATIONS.forEach(r => {
          if (!r.start || !r.end || !r.propertyId) return;

          const startStr = normalizeDateString(r.start);
          const endStr = normalizeDateString(r.end);
          const propertyId = r.propertyId;
          const propertyName = getPropertyName(propertyId);
          const cleanerId = assignments[propertyId];
          const cleaner = cleanerId ? getCleanerById(cleanerId) : null;

          if (endStr === dateStr) {
            tasks.push({
              type: 'departure',
              propertyId,
              propertyName,
              cleaner,
              reservation: r
            });
          }

          if (startStr === dateStr) {
            tasks.push({
              type: 'arrival',
              propertyId,
              propertyName,
              cleaner,
              reservation: r
            });
          }
        });

        return tasks;
      }

      function buildMessageForCleaner(cleaner, tasksForCleaner, dateStr) {
        const date = new Date(dateStr);
        const formattedDate = date.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit', month: 'long' });

        const firstName = cleaner.name?.split(' ')[0] || cleaner.name || '';
        let lines = [];

        lines.push(`Bonjour ${firstName},`);
        lines.push('');
        lines.push(`Voici vos interventions ménage prévues pour ${formattedDate} :`);
        lines.push('');

        tasksForCleaner.forEach(t => {
          const res = t.reservation;
          const guest = res.guestName || res.name || 'client';
          const stayInfo = `${normalizeDateString(res.start)} → ${normalizeDateString(res.end)}`;

          if (t.type === 'departure') {
            lines.push(`- ${t.propertyName} – après un départ (${guest}, séjour ${stayInfo})`);
          } else {
            lines.push(`- ${t.propertyName} – vérification avant une arrivée (${guest}, séjour ${stayInfo})`);
          }
        });

        lines.push('');
        lines.push(`Merci beaucoup, et n’hésite pas à me signaler tout problème ou anomalie.`);
        lines.push('');
        lines.push('La Conciergerie de Charles');

        return lines.join('\n');
      }

      function buildMessageForUnassigned(tasks, dateStr) {
        const date = new Date(dateStr);
        const formattedDate = date.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit', month: 'long' });

        let lines = [];
        lines.push(`Tâches ménage sans personne assignée – ${formattedDate}`);
        lines.push('');

        tasks.forEach(t => {
          const res = t.reservation;
          const guest = res.guestName || res.name || 'client';
          const stayInfo = `${normalizeDateString(res.start)} → ${normalizeDateString(res.end)}`;

          if (t.type === 'departure') {
            lines.push(`- ${t.propertyName} – après un départ (${guest}, séjour ${stayInfo})`);
          } else {
            lines.push(`- ${t.propertyName} – avant une arrivée (${guest}, séjour ${stayInfo})`);
          }
        });

        lines.push('');
        lines.push('Pensez à assigner ces logements à une personne de ménage dans le module dédié.');
        return lines.join('\n');
      }

      const cleaningMsgDate = document.getElementById('cleaningMsgDate');
      const generateCleaningMessagesBtn = document.getElementById('generateCleaningMessagesBtn');
      const cleaningMessagesContainer = document.getElementById('cleaningMessagesContainer');
      const cleaningMsgHint = document.getElementById('cleaningMsgHint');

      if (cleaningMsgDate && generateCleaningMessagesBtn && cleaningMessagesContainer) {
        // valeur par défaut = aujourd’hui
        const today = new Date();
        const isoToday = today.toISOString().slice(0,10);
        cleaningMsgDate.value = isoToday;

        generateCleaningMessagesBtn.addEventListener('click', () => {
          const dateStr = cleaningMsgDate.value;
          if (!dateStr) return;

          loadCleaningData();
          const tasks = generateCleaningTasks(dateStr);

          if (!tasks.length) {
            cleaningMessagesContainer.innerHTML = `
              <p class="empty-state">
                <i class="fas fa-calendar-times"></i><br>
                Aucun départ ou arrivée trouvé pour cette date. Aucun message ménage généré.
              </p>`;
            return;
          }

          const byCleaner = {};
          const unassigned = [];

          tasks.forEach(t => {
            if (t.cleaner) {
              const id = t.cleaner.id;
              if (!byCleaner[id]) byCleaner[id] = [];
              byCleaner[id].push(t);
            } else {
              unassigned.push(t);
            }
          });

          cleaningMessagesContainer.innerHTML = '';

          Object.keys(byCleaner).forEach(cleanerId => {
            const cleaner = getCleanerById(cleanerId);
            if (!cleaner) return;
            const tasksForCleaner = byCleaner[cleanerId];
            const messageText = buildMessageForCleaner(cleaner, tasksForCleaner, dateStr);

            const card = document.createElement('div');
            card.className = 'cleaning-message-card';

            const phone = cleaner.phone || '';
            const email = cleaner.email || '';

            card.innerHTML = `
              <div class="cleaning-message-header">
                <div>
                  <div class="cleaning-message-title">
                    ${cleaner.name}
                  </div>
                  <div class="cleaning-message-meta">
                    ${phone ? `<span class="badge-pill"><i class="fas fa-phone"></i>${phone}</span>` : ''}
                    ${email ? `<span class="badge-pill"><i class="fas fa-envelope"></i>${email}</span>` : ''}
                    <span class="badge-pill"><i class="fas fa-list-check"></i>${tasksForCleaner.length} intervention(s)</span>
                  </div>
                </div>
                <button type="button" class="copy-btn cleaning-copy-btn">
                  <i class="fas fa-copy"></i> Copier le message
                </button>
              </div>
              <textarea class="cleaning-message-textarea">${messageText}</textarea>
            `;

            cleaningMessagesContainer.appendChild(card);
          });

          if (unassigned.length) {
            const text = buildMessageForUnassigned(unassigned, dateStr);
            const card = document.createElement('div');
            card.className = 'cleaning-message-card';
            card.innerHTML = `
              <div class="cleaning-message-header">
                <div>
                  <div class="cleaning-message-title">
                    Logements sans personne assignée
                  </div>
                  <div class="cleaning-message-meta">
                    <span class="badge-pill"><i class="fas fa-triangle-exclamation"></i>${unassigned.length} tâche(s)</span>
                  </div>
                </div>
                <button type="button" class="copy-btn cleaning-copy-btn">
                  <i class="fas fa-copy"></i> Copier le message
                </button>
              </div>
              <textarea class="cleaning-message-textarea">${text}</textarea>
            `;
            cleaningMessagesContainer.appendChild(card);
          }

          cleaningMsgHint.textContent = "Messages générés. Tu peux les ajuster avant de les coller dans SMS / WhatsApp / email.";

          // Gestion du copy pour tous les boutons
          cleaningMessagesContainer.querySelectorAll('.cleaning-copy-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
              const card = btn.closest('.cleaning-message-card');
              if (!card) return;
              const ta = card.querySelector('.cleaning-message-textarea');
              if (!ta) return;
              const text = ta.value.trim();
              if (!text) return;

              try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                  await navigator.clipboard.writeText(text);
                  btn.classList.add('copied');
                  btn.innerHTML = '<i class="fas fa-check"></i> Copié !';
                  setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.innerHTML = '<i class="fas fa-copy"></i> Copier le message';
                  }, 1500);
                } else {
                  const temp = document.createElement('textarea');
                  temp.value = text;
                  document.body.appendChild(temp);
                  temp.select();
                  document.execCommand('copy');
                  document.body.removeChild(temp);
                }
              } catch (e) {
                console.error(e);
              }
            });
          });
        });
      }
    });
  </script>
</body>
</html>
