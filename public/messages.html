<!DOCTYPE html>
<html data-theme="light" data-theme-v3="1" lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
<title>Messages ‚Äî Boostinghost</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>
<link href="/css/style.css" rel="stylesheet"/>
<link href="/css/bh-shared.css?v=1" rel="stylesheet"/>
<link href="/css/bh-theme-v3.css" rel="stylesheet"/>
<link href="/css/bottom-bar-enhanced.css" rel="stylesheet"/>
<link href="/css/tablet-bottom-bar-fix.css" rel="stylesheet"/>
<link href="/css/messages-badge-fix.css" rel="stylesheet"/>
<link rel="stylesheet" href="/css/messages-badge-red.css">
<link rel="stylesheet" href="/css/messages-badge-desktop.css">
<link href="/css/chat-modern.css" rel="stylesheet">
<link href="/css/guest-info-styles.css" rel="stylesheet">
<link rel="stylesheet" href="/css/mobile-native-styles.css">

<style>
/* ============================================================
   DARK BAR CSS
   ============================================================ */
html[data-theme-v3="1"] .bh-demo-nav {
  position: fixed;
  top: 0; left: 0; right: 0;
  z-index: 9999;
  background: #0D1117;
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 0 16px;
  height: 40px;
  font-family: 'DM Sans', sans-serif;
  font-size: 12px;
  /* Pour le centrage absolu des badges */
  position: fixed;
}
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-label {
  color: rgba(255,255,255,.4);
  font-weight: 500;
  margin-right: 6px;
  letter-spacing: .08em;
  text-transform: uppercase;
  font-size: 11px;
  white-space: nowrap;
}
html[data-theme-v3="1"] .bh-demo-nav a.bh-demo-btn,
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-btn {
  padding: 4px 13px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.15);
  background: transparent;
  color: rgba(255,255,255,.6);
  cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  font-size: 11.5px;
  font-weight: 500;
  transition: all .2s;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  text-decoration: none;
  white-space: nowrap;
}
html[data-theme-v3="1"] .bh-demo-nav a.bh-demo-btn:hover,
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-btn:hover {
  background: rgba(255,255,255,.1);
  color: white;
}
html[data-theme-v3="1"] .bh-demo-nav a.bh-demo-btn.active,
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-btn.active {
  background: #1A7A5E;
  color: white;
  border-color: #1A7A5E;
}
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-right {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-mode-label {
  color: rgba(255,255,255,.4);
  font-size: 10.5px;
  font-weight: 500;
  letter-spacing: .07em;
  text-transform: uppercase;
}
html[data-theme-v3="1"] .bh-theme-toggle {
  width: 44px;
  height: 24px;
  background: rgba(255,255,255,.15);
  border-radius: 999px;
  border: none;
  cursor: pointer;
  position: relative;
  transition: background .2s;
  flex-shrink: 0;
}
html[data-theme-v3="1"] .bh-theme-toggle::after {
  content: '';
  position: absolute;
  top: 3px; left: 3px;
  width: 18px; height: 18px;
  background: white;
  border-radius: 50%;
  transition: transform .2s;
}
html[data-theme-v3="1"][data-theme="dark"] .bh-theme-toggle { background: #1A7A5E; }
html[data-theme-v3="1"][data-theme="dark"] .bh-theme-toggle::after { transform: translateX(20px); }

/* ============================================================
   MESSAGES PAGE - REDESIGN V3
   ============================================================ */
html[data-theme-v3="1"] body {
  padding-top: 40px !important;
  background: #F5F2EC !important;
  font-family: 'DM Sans', sans-serif !important;
}

html[data-theme-v3="1"] .main-content {
  background: #F5F2EC !important;
}

/* Header de page */
html[data-theme-v3="1"] .msgs-page-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 18px 24px 14px;
  background: transparent;
  gap: 16px;
}

html[data-theme-v3="1"] .msgs-page-title {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

html[data-theme-v3="1"] .msgs-page-kicker {
  font-size: 10.5px;
  font-weight: 600;
  letter-spacing: .1em;
  text-transform: uppercase;
  color: rgba(13,17,23,.4);
}

html[data-theme-v3="1"] .msgs-page-heading {
  font-family: 'Instrument Serif', serif;
  font-size: 26px;
  font-weight: 400;
  color: #0D1117;
  margin: 0;
  line-height: 1.1;
}

html[data-theme-v3="1"] .msgs-page-heading em {
  font-style: italic;
  color: #1A7A5E;
}

html[data-theme-v3="1"] .msgs-header-actions {
  display: flex;
  align-items: center;
  gap: 8px;
}

html[data-theme-v3="1"] .msgs-icon-btn {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  border: 1px solid rgba(0,0,0,.1);
  background: white;
  color: #5A6A7A;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  transition: all .15s;
}

html[data-theme-v3="1"] .msgs-icon-btn:hover {
  background: #f0ebe3;
  color: #0D1117;
}

html[data-theme-v3="1"] .msgs-group-btn {
  background: #1A7A5E;
  color: white;
  border: none;
  border-radius: 10px;
  padding: 0 16px;
  height: 36px;
  font-family: 'DM Sans', sans-serif;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 7px;
  transition: background .15s;
}

html[data-theme-v3="1"] .msgs-group-btn:hover {
  background: #15624B;
}

/* ============================================================
   SPLIT LAYOUT
   ============================================================ */
html[data-theme-v3="1"] .msgs-split {
  display: flex;
  height: calc(100vh - 40px - 72px);  /* minus topbar + header */
  margin: 0 16px 16px;
  border-radius: 20px;
  overflow: hidden;
  border: 1px solid rgba(0,0,0,.08);
  box-shadow: 0 4px 24px rgba(0,0,0,.06);
  background: white;
}

/* LEFT PANEL */
html[data-theme-v3="1"] .msgs-left {
  width: 340px;
  min-width: 340px;
  display: flex;
  flex-direction: column;
  border-right: 1px solid rgba(0,0,0,.07);
  background: #FAFAF8;
}

html[data-theme-v3="1"] .msgs-search-wrap {
  padding: 14px 14px 10px;
  border-bottom: 1px solid rgba(0,0,0,.06);
}

html[data-theme-v3="1"] .msgs-search {
  display: flex;
  align-items: center;
  gap: 8px;
  background: white;
  border: 1px solid rgba(0,0,0,.1);
  border-radius: 10px;
  padding: 0 12px;
  height: 38px;
}

html[data-theme-v3="1"] .msgs-search i {
  color: #9AA3AE;
  font-size: 13px;
  flex-shrink: 0;
}

html[data-theme-v3="1"] .msgs-search input {
  flex: 1;
  border: none;
  background: transparent;
  font-family: 'DM Sans', sans-serif;
  font-size: 13.5px;
  color: #0D1117;
  outline: none;
}

html[data-theme-v3="1"] .msgs-search input::placeholder {
  color: #9AA3AE;
}

html[data-theme-v3="1"] .msgs-conv-list {
  flex: 1;
  overflow-y: auto;
}

html[data-theme-v3="1"] .msgs-conv-list::-webkit-scrollbar {
  width: 4px;
}

html[data-theme-v3="1"] .msgs-conv-list::-webkit-scrollbar-thumb {
  background: rgba(0,0,0,.1);
  border-radius: 2px;
}

/* Conversation items */
html[data-theme-v3="1"] .conversation-item {
  padding: 13px 14px;
  border-bottom: 1px solid rgba(0,0,0,.05);
  cursor: pointer;
  display: flex;
  gap: 11px;
  align-items: flex-start;
  transition: background .12s;
  position: relative;
}

html[data-theme-v3="1"] .conversation-item:hover {
  background: #F0EBE3;
}

html[data-theme-v3="1"] .conversation-item.active {
  background: #E8F4EF;
  border-left: 3px solid #1A7A5E;
}

html[data-theme-v3="1"] .conversation-item:last-child {
  border-bottom: none;
}

html[data-theme-v3="1"] .conversation-avatar {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  background: #1A7A5E;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 16px;
  flex-shrink: 0;
  font-family: 'DM Sans', sans-serif;
}

html[data-theme-v3="1"] .conversation-content {
  flex: 1;
  min-width: 0;
}

html[data-theme-v3="1"] .conversation-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 3px;
}

html[data-theme-v3="1"] .conversation-info h3 {
  font-size: 14px;
  font-weight: 700;
  color: #0D1117;
  margin: 0;
  font-family: 'DM Sans', sans-serif;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 180px;
}

html[data-theme-v3="1"] .conversation-status {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-shrink: 0;
}

html[data-theme-v3="1"] .conversation-time {
  font-size: 11.5px;
  color: #9AA3AE;
  font-weight: 400;
}

html[data-theme-v3="1"] .unread-badge {
  background: #EF4444;
  color: white;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: 700;
}

html[data-theme-v3="1"] .conversation-preview {
  font-size: 13px;
  color: #6B7A8A;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-family: 'DM Sans', sans-serif;
}

html[data-theme-v3="1"] .conversation-actions {
  display: none;
}

/* RIGHT PANEL */
html[data-theme-v3="1"] .msgs-right {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: white;
}

html[data-theme-v3="1"] .msgs-chat-placeholder {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #9AA3AE;
  gap: 12px;
}

html[data-theme-v3="1"] .msgs-chat-placeholder i {
  font-size: 48px;
  opacity: .3;
}

html[data-theme-v3="1"] .msgs-chat-placeholder p {
  font-size: 15px;
  color: #9AA3AE;
}

/* Chat header in right panel */
html[data-theme-v3="1"] .msgs-chat-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 20px;
  border-bottom: 1px solid rgba(0,0,0,.07);
  background: white;
  flex-shrink: 0;
}

html[data-theme-v3="1"] .msgs-chat-header-info {
  flex: 1;
  min-width: 0;
}

html[data-theme-v3="1"] .msgs-chat-guest-name {
  font-size: 16px;
  font-weight: 700;
  color: #0D1117;
  font-family: 'DM Sans', sans-serif;
  margin-bottom: 2px;
}

html[data-theme-v3="1"] .msgs-chat-meta {
  font-size: 12.5px;
  color: #6B7A8A;
  display: flex;
  align-items: center;
  gap: 6px;
}

html[data-theme-v3="1"] .msgs-chat-meta .dot {
  opacity: .4;
}

html[data-theme-v3="1"] .msgs-chat-header-actions {
  display: flex;
  align-items: center;
  gap: 8px;
}

html[data-theme-v3="1"] .msgs-auto-reply-btn {
  background: white;
  border: 1px solid rgba(0,0,0,.12);
  border-radius: 10px;
  padding: 0 14px;
  height: 34px;
  font-family: 'DM Sans', sans-serif;
  font-size: 12.5px;
  font-weight: 600;
  color: #0D1117;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 7px;
  transition: all .15s;
}

html[data-theme-v3="1"] .msgs-auto-reply-btn:hover {
  background: #f5f2ec;
}

/* Messages area */
html[data-theme-v3="1"] .chat-modal-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  background: #F5F2EC;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* Owner bubble = dark */
html[data-theme-v3="1"] .chat-message.owner .chat-bubble {
  background: #0D1117;
  color: white;
  border-radius: 18px 18px 4px 18px;
}

html[data-theme-v3="1"] .chat-message.owner .chat-time {
  color: rgba(255,255,255,.6);
}

/* Guest bubble = white */
html[data-theme-v3="1"] .chat-message.guest .chat-bubble,
html[data-theme-v3="1"] .chat-message.bot .chat-bubble {
  background: white;
  border-radius: 18px 18px 18px 4px;
  box-shadow: 0 1px 3px rgba(0,0,0,.06);
}

/* Input area */
html[data-theme-v3="1"] .chat-modal-input {
  padding: 12px 16px;
  border-top: 1px solid rgba(0,0,0,.07);
  background: white;
  display: flex;
  gap: 10px;
  align-items: flex-end;
}

html[data-theme-v3="1"] .chat-input {
  flex: 1;
  padding: 10px 16px;
  border: 1px solid rgba(0,0,0,.1);
  border-radius: 24px;
  font-size: 14px;
  font-family: 'DM Sans', sans-serif;
  resize: none;
  max-height: 120px;
  background: #F5F2EC;
  outline: none;
  color: #0D1117;
}

html[data-theme-v3="1"] .chat-input:focus {
  border-color: rgba(26,122,94,.4);
  background: white;
}

html[data-theme-v3="1"] .send-btn {
  width: 40px;
  height: 40px;
  background: #1A7A5E;
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  flex-shrink: 0;
  transition: background .15s;
}

html[data-theme-v3="1"] .send-btn:hover {
  background: #15624B;
}

/* Empty state */
html[data-theme-v3="1"] .empty-state {
  text-align: center;
  padding: 40px 20px;
  color: #9AA3AE;
}

/* Hide old layout elements */
html[data-theme-v3="1"] .stats-section,
html[data-theme-v3="1"] .filters-section,
html[data-theme-v3="1"] .conversations-section,
html[data-theme-v3="1"] .modal-overlay#chatModal {
  display: none !important;
}

html[data-theme-v3="1"] .page-content {
  padding: 0 !important;
  margin: 0 !important;
}

/* Date separator */
html[data-theme-v3="1"] .chat-date-separator {
  text-align: center;
  font-size: 11.5px;
  color: #9AA3AE;
  padding: 8px 0;
  position: relative;
}

html[data-theme-v3="1"] .chat-date-separator span {
  background: #F5F2EC;
  padding: 0 10px;
  position: relative;
  z-index: 1;
}

/* ============================================================
   HEADER FIXE + SUPPRESSION RETOUR AU DASHBOARD
   ============================================================ */
html[data-theme-v3="1"] header.main-header {
  position: sticky !important;
  top: 0 !important;
  z-index: 50 !important;
  margin-top: 0 !important;
  background: #F5F2EC !important;
}
html[data-theme-v3="1"] main.main-content {
  padding-top: 0 !important;
  margin-top: 0 !important;
}
html[data-theme-v3="1"] .app-container {
  margin-top: 0 !important;
  padding-top: 0 !important;
}
html[data-theme-v3="1"] main.main-content > header.main-header {
  margin-top: 0 !important;
  padding-top: 0 !important;
}
/* Hide back button */
html[data-theme-v3="1"] .back-btn,
html[data-theme-v3="1"] .btn-back,
html[data-theme-v3="1"] [href="/app.html"].back,
html[data-theme-v3="1"] .header-back,
html[data-theme-v3="1"] .page-back-btn,
html[data-theme-v3="1"] a[data-back],
html[data-theme-v3="1"] .header-breadcrumb,
html[data-theme-v3="1"] .breadcrumb {
  display: none !important;
}

</style>
</head>
<body  data-kicker="Communication" data-page="messages" data-subtitle="Centralisez et g√©rez toutes vos conversations." data-title="Messages">

<script src="/js/auth-fetch.js"></script>
<link rel="stylesheet" href="/css/mobile-native-styles.css">
</head>
<body  data-kicker="Communication" data-page="messages" data-subtitle="Centralisez et g√©rez toutes vos conversations." data-title="Messages">
<script>
(function() {
  'use strict';
  
  console.log('üåê [API FIX] Initialisation...');
  
  // D√©tection native
  const IS_NATIVE = !!(
    window.Capacitor?.isNativePlatform?.() ||
    window.location.protocol === 'capacitor:' ||
    window.location.protocol === 'ionic:'
  );

  // URL de l'API
  const API_BASE_URL = IS_NATIVE 
    ? 'https://lcc-booking-manager.onrender.com' 
    : window.location.origin;

  // Exposer globalement
  window.API_BASE = API_BASE_URL;
  window.API_URL = API_BASE_URL;
  window.IS_NATIVE = IS_NATIVE;

  console.log('üåê [API FIX] IS_NATIVE:', IS_NATIVE);
  console.log('üåê [API FIX] API_BASE:', API_BASE_URL);
  console.log('üåê [API FIX] Protocol:', window.location.protocol);

  // Helper pour construire les URLs
  window.buildApiUrl = function(path) {
    if (path.startsWith('/')) {
      return API_BASE_URL + path;
    }
    return API_BASE_URL + '/' + path;
  };

  // ‚ö° IMPORTANT: Intercepter fetch pour r√©√©crire automatiquement les URLs
  const originalFetch = window.fetch;
  window.fetch = function(input, init) {
    let url = input;
    
    // Si c'est un string qui commence par /api/
    if (typeof input === 'string' && input.startsWith('/api/')) {
      url = window.buildApiUrl(input);
      console.log('üîÑ [API FIX] Rewrite:', input, '‚Üí', url);
    }
    
    return originalFetch(url, init);
  };

  console.log('‚úÖ [API FIX] Activ√© et pr√™t');
})();
</script>

<!-- MOBILE HEADER -->
<div class="mobile-header">
<a class="mobile-logo" href="/app.html">
<i class="fas fa-calendar-check"></i>
<span class="mobile-logo-text">Boostinghost</span>
</a>
<button class="mobile-menu-btn" id="mobileMenuBtn">
<i class="fas fa-bars"></i>
</button>
</div>

<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- DARK TOP BAR -->
<div class="bh-demo-nav" id="bhTopBar">
  <!-- Connexions centr√©es -->
  <div style="position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:16px;">

    <!-- Airbnb -->
    <div style="display:flex;align-items:center;gap:7px;">
      <i class="fa-brands fa-airbnb" style="font-size:15px;color:#FF5A5F;"></i>
      <span style="color:rgba(255,255,255,.7);font-size:12px;font-weight:500;">Airbnb</span>
      <span id="topbar-status-airbnb" style="font-size:11px;font-weight:600;padding:2px 9px;border-radius:999px;background:rgba(239,68,68,.2);color:#F87171;border:1px solid rgba(239,68,68,.35);">
        <i class="fas fa-circle" style="font-size:7px;margin-right:3px;vertical-align:middle;"></i>Non connect√©
      </span>
    </div>

    <div style="width:1px;height:16px;background:rgba(255,255,255,.1);"></div>

    <!-- Booking.com -->
    <div style="display:flex;align-items:center;gap:7px;">
      <span style="font-size:13px;font-weight:800;color:#003580;">B.</span>
      <span style="color:rgba(255,255,255,.7);font-size:12px;font-weight:500;">Booking.com</span>
      <span id="topbar-status-booking" style="font-size:11px;font-weight:600;padding:2px 9px;border-radius:999px;background:rgba(239,68,68,.2);color:#F87171;border:1px solid rgba(239,68,68,.35);">
        <i class="fas fa-circle" style="font-size:7px;margin-right:3px;vertical-align:middle;"></i>Non connect√©
      </span>
    </div>

    <div style="width:1px;height:16px;background:rgba(255,255,255,.1);"></div>

    <!-- Stripe -->
    <div style="display:flex;align-items:center;gap:7px;">
      <i class="fa-brands fa-stripe-s" style="font-size:17px;color:#6772E5;"></i>
      <span style="color:rgba(255,255,255,.7);font-size:12px;font-weight:500;">Stripe</span>
      <span id="topbar-status-stripe" style="font-size:11px;font-weight:600;padding:2px 9px;border-radius:999px;background:rgba(239,68,68,.2);color:#F87171;border:1px solid rgba(239,68,68,.35);">
        <i class="fas fa-circle" style="font-size:7px;margin-right:3px;vertical-align:middle;"></i>Non connect√©
      </span>
    </div>

  </div>

  <!-- Toggle dark mode (droite) -->
  <div class="bh-demo-right">
    <span class="bh-demo-mode-label">Mode</span>
    <button class="bh-theme-toggle" id="bhThemeToggleDark" onclick="document.documentElement.getAttribute('data-theme')==='dark'?document.documentElement.setAttribute('data-theme','light'):document.documentElement.setAttribute('data-theme','dark')"></button>
  </div>
</div>

<script>
// Mise √† jour des statuts de connexion dans la top bar
(function updateTopBarStatus() {
  function setStatus(id, connected) {
    const el = document.getElementById(id);
    if (!el) return;
    if (connected) {
      el.style.background = 'rgba(34,197,94,.2)';
      el.style.color = '#4ADE80';
      el.style.borderColor = 'rgba(34,197,94,.35)';
      el.innerHTML = '<i class="fas fa-circle" style="font-size:7px;margin-right:3px;vertical-align:middle;"></i>Connect√©';
    } else {
      el.style.background = 'rgba(239,68,68,.2)';
      el.style.color = '#F87171';
      el.style.borderColor = 'rgba(239,68,68,.35)';
      el.innerHTML = '<i class="fas fa-circle" style="font-size:7px;margin-right:3px;vertical-align:middle;"></i>Non connect√©';
    }
  }

  function checkStatuses() {
    try {
      const reservations = JSON.parse(localStorage.getItem('LCC_RESERVATIONS') || '[]');
      const hasAirbnb = reservations.some(r =>
        (r.source || r.platform || '').toLowerCase().includes('airbnb')
      );
      const hasBooking = reservations.some(r =>
        (r.source || r.platform || '').toLowerCase().includes('booking')
      );
      setStatus('topbar-status-airbnb', hasAirbnb);
      setStatus('topbar-status-booking', hasBooking);

      // Stripe : v√©rifie lcc_user ou LCC_PROPERTIES
      const user = JSON.parse(localStorage.getItem('lcc_user') || '{}');
      const properties = JSON.parse(localStorage.getItem('LCC_PROPERTIES') || '[]');
      const hasStripe = !!(
        user.stripeAccountId ||
        user.stripe_account_id ||
        user.stripeConnected ||
        properties.some(p => p.stripeAccountId || p.stripe_account_id)
      );
      setStatus('topbar-status-stripe', hasStripe);
    } catch(e) {
      console.warn('TopBar status error:', e);
    }
  }

  // V√©rifier au chargement
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', checkStatuses);
  } else {
    checkStatuses();
  }

  // Re-v√©rifier apr√®s chargement des donn√©es API (d√©lai)
  setTimeout(checkStatuses, 2000);
  setTimeout(checkStatuses, 5000);

  // Exposer pour appel manuel apr√®s loadData
  window.updateTopBarStatus = checkStatuses;
})();
</script>

<div class="app-container">
<!-- Sidebar -->
<div id="bhSidebar"></div>

<!-- Main -->
<main class="main-content">
<div id="bhHeader"></div>

<!-- Page Header -->
<div class="msgs-page-header">
  <div class="msgs-page-title">
    <span class="msgs-page-kicker">Communication</span>
    <h1 class="msgs-page-heading">Mes <em>messages</em></h1>
  </div>
  <div class="msgs-header-actions">
    <button class="msgs-icon-btn" title="Notifications" id="notifBtn"><i class="fas fa-bell"></i></button>
    <button class="msgs-icon-btn" title="Actualiser" onclick="if(window.loadConversations) window.loadConversations(); else window.location.reload();"><i class="fas fa-sync-alt"></i></button>
    <button class="msgs-group-btn" id="groupMessageBtn"><i class="fas fa-plus"></i> Message group√©</button>
  </div>
</div>

<!-- Page Content (hidden elements kept for JS compatibility) -->
<div class="page-content">
  <div class="stats-section" style="display:none!important">
    <div class="stat-card"><div class="stat-icon"></div><div class="stat-content"><h3 id="statTotal">0</h3><p>Conversations totales</p></div></div>
    <div class="stat-card"><div class="stat-icon"></div><div class="stat-content"><h3 id="statUnread">0</h3><p>Messages non lus</p></div></div>
    <div class="stat-card"><div class="stat-icon"></div><div class="stat-content"><h3 id="statActive">0</h3><p>Conversations actives</p></div></div>
  </div>
  <div class="filters-section" style="display:none!important">
    <div class="filter-group"><label>Statut</label><select id="filterStatus"><option value="">Tous</option><option selected value="active">Actives</option><option value="pending">En attente</option><option value="closed">Ferm√©es</option></select></div>
    <div class="filter-group"><label>Logement</label><select id="filterProperty"><option value="">Tous les logements</option></select></div>
  </div>
  <div class="conversations-section" style="display:none!important">
    <div class="conversations-header"><h2>Vos conversations</h2></div>
    <div id="conversationsList"><div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Chargement...</p></div></div>
  </div>
</div>

<!-- NEW SPLIT LAYOUT -->
<div class="msgs-split">
  <!-- Left: conversations list -->
  <div class="msgs-left">
    <div class="msgs-search-wrap">
      <div class="msgs-search">
        <i class="fas fa-search"></i>
        <input id="msgsSearchInput" placeholder="Rechercher un voyageur..." type="text"/>
      </div>
    </div>
    <div class="msgs-conv-list" id="msgsConvList">
      <div class="empty-state">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Chargement...</p>
      </div>
    </div>
  </div>

  <!-- Right: chat panel -->
  <div class="msgs-right" id="msgsChatPanel">
    <div class="msgs-chat-placeholder" id="msgsChatPlaceholder">
      <i class="fas fa-comments"></i>
      <p>S√©lectionnez une conversation</p>
    </div>
    <!-- Chat header (shown when conversation selected) -->
    <div class="msgs-chat-header" id="msgsChatHeader" style="display:none;">
      <div class="conversation-avatar" id="msgsChatAvatar" style="width:38px;height:38px;font-size:15px;"></div>
      <div class="msgs-chat-header-info">
        <div class="msgs-chat-guest-name" id="msgsChatGuestName"></div>
        <div class="msgs-chat-meta" id="msgsChatMeta"></div>
      </div>
      <div class="msgs-chat-header-actions">
        <button class="msgs-icon-btn" title="Profil voyageur" id="chatGuestInfoBtn"><i class="fas fa-user"></i></button>
        <button class="msgs-icon-btn" title="R√©servation" id="chatBookingInfoBtn"><i class="fas fa-calendar"></i></button>
        <button class="msgs-auto-reply-btn" id="chatAutoReplyBtn"><i class="fas fa-reply"></i> R√©ponse auto</button>
      </div>
    </div>
    <!-- Messages area -->
    <div class="chat-modal-messages" id="chatMessages" style="display:none;">
      <div class="loading" style="text-align:center;padding:40px;">
        <i class="fas fa-spinner fa-spin" style="font-size:32px;"></i>
        <p>Chargement des messages...</p>
      </div>
    </div>
    <!-- Input -->
    <div class="chat-modal-input" id="msgsChatInput" style="display:none;">
      <textarea class="chat-input" id="chatInput" placeholder="R√©pondre..." rows="1"></textarea>
      <button class="msgs-icon-btn" id="chatLightningBtn" title="R√©ponse rapide"><i class="fas fa-bolt"></i></button>
      <button class="send-btn" id="sendBtn" onclick="sendMessageOwner()"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>
</div>

<!-- Old chat modal kept for JS compatibility (hidden) -->
<div class="modal-overlay" id="chatModal" style="display:none!important;">
<div class="chat-modal">
<div class="chat-modal-header">
<div style="flex:1;"><h2 id="chatModalTitle">Conversation</h2></div>
<button class="close-modal" onclick="closeChat()"><i class="fas fa-times"></i></button>
</div>
</div>
</div>

</main>
</div>

<div class="toast-container" id="toastContainer"></div>
<div class="loading-overlay" id="loadingOverlay" style="display:none;">
<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><p>Chargement...</p></div>
</div>

<!-- Socket.IO -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<!-- ‚úÖ FONCTIONS HELPERS POUR AFFICHAGE VOYAGEUR -->
<script>
// ============================================
// FONCTIONS HELPERS POUR AFFICHAGE VOYAGEUR
// ============================================

function cleanGuestName(reservation) {
  if (!reservation) return 'Voyageur';
  
  // Si on a le guest_display_name construit par le serveur
  if (reservation.guest_display_name && 
      reservation.guest_display_name !== 'Voyageur' &&
      reservation.guest_display_name.trim() !== '') {
    return reservation.guest_display_name;
  }
  
  // Construire √† partir de guest_first_name et guest_last_name (onboarding)
  if (reservation.guest_first_name) {
    const firstName = reservation.guest_first_name.trim();
    const lastName = reservation.guest_last_name ? reservation.guest_last_name.trim() : '';
    return lastName ? `${firstName} ${lastName}` : firstName;
  }
  
  // Fallback sur guest_name
  const rawName = reservation.guest_name || reservation.guestName;
  if (rawName && rawName !== 'undefined' && rawName !== 'null' && rawName.trim() !== '') {
    const cleaned = rawName.trim().replace(/^\(|\)$/g, '');
    const invalidNames = [
      'not available', 'closed', 'reservation', 'reserved', 'blocked', 
      'unavailable', 'booked', 'not provided', 'n/a', 'unknown', 'guest'
    ];
    
    if (!invalidNames.some(invalid => cleaned.toLowerCase().includes(invalid))) {
      return cleaned;
    }
  }
  
  // Fallback final avec plateforme
  const plat = (reservation.source || reservation.platform || '').toLowerCase();
  if (plat.includes('airbnb')) return 'Voyageur Airbnb';
  if (plat.includes('booking')) return 'Voyageur Booking';
  
  return 'Voyageur';
}  // ‚úÖ ACCOLADE FERMANTE MANQUANTE !

function getGuestInitial(reservation) {
  if (!reservation) return 'V';
  
  // Si on a l'initiale construite par le serveur
  if (reservation.guest_initial && reservation.guest_initial !== 'V') {
    return reservation.guest_initial;
  }
  
  // Extraire du pr√©nom (onboarding)
  if (reservation.guest_first_name && reservation.guest_first_name.trim() !== '') {
    return reservation.guest_first_name.charAt(0).toUpperCase();
  }
  
  // Fallback sur guest_name
  const name = reservation.guest_name || reservation.guestName;
  if (name && name !== 'undefined' && name !== 'null' && name.trim() !== '') {
    return name.charAt(0).toUpperCase();
  }
  
  return 'V';
}

function getGuestPhone(reservation) {
  if (!reservation) return '';
  
  if (reservation.guest_phone && reservation.guest_phone.trim() !== '') {
    return reservation.guest_phone;
  }
  
  if (reservation.guestPhone && reservation.guestPhone.trim() !== '') {
    return reservation.guestPhone;
  }
  
  return '';
}

function formatRelativeTime(date) {
  const now = new Date();
  const diff = Math.floor((now - date) / 1000);
  
  if (diff < 60) return '√Ä l\'instant';
  if (diff < 3600) return `Il y a ${Math.floor(diff / 60)} min`;
  if (diff < 86400) return `Il y a ${Math.floor(diff / 3600)}h`;
  if (diff < 604800) return `Il y a ${Math.floor(diff / 86400)}j`;
  
  return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
}

// Exposer globalement
window.cleanGuestName = cleanGuestName;
window.getGuestInitial = getGuestInitial;
window.getGuestPhone = getGuestPhone;
window.formatRelativeTime = formatRelativeTime;

console.log('‚úÖ Fonctions helpers messages charg√©es');
</script>

<!-- Script -->
<script src="/js/chat-owner.js"></script>
<!-- Auth + User -->
<script>
    (async function checkSubscriptionAccess() {
    const token = localStorage.getItem('lcc_token');
    
    if (!token) {
      window.location.href = '/login.html';
      return;
    }

   try {
  const res = await fetch('/api/subscription/status', {
    headers: { 'Authorization': 'Bearer ' + token }
  });

      if (!res.ok) {
        if (res.status === 401 || res.status === 403) {
          localStorage.removeItem('lcc_token');
          localStorage.removeItem('lcc_user');
          window.location.href = '/login.html';
        }
        return;
      }

      // ‚ö° V√©rifier content-type avant parsing
      const contentType = res.headers.get('content-type') || '';
      if (!contentType.includes('application/json')) {
        console.warn('‚ö†Ô∏è Subscription non-JSON');
        return;
      }
      const data = await res.json();

      if (data.status === 'expired' || data.status === 'canceled') {
        localStorage.removeItem('lcc_token');
        localStorage.removeItem('lcc_user');
        window.location.href = '/login.html?reason=expired';
        return;
      }
    } catch (err) {
      console.error('Erreur v√©rification abonnement:', err);
    }
    return;
  }

  // ‚úÖ V√©rifier que c'est du JSON
    })();
</script>

<script>
    (function() {
      const token = localStorage.getItem('lcc_token');

      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      const rawUser = localStorage.getItem('lcc_user');
      let user = null;

      try {
        user = rawUser ? JSON.parse(rawUser) : null;
      } catch (e) {
        console.error('Impossible de lire lcc_user', e);
      }

      if (user) {
        const nameEl = document.getElementById('sidebarUserName');
        const companyEl = document.getElementById('sidebarUserCompany');
        const avatarEl = document.getElementById('sidebarUserAvatar');

        if (nameEl) {
          nameEl.textContent = user.firstName
            ? user.firstName + (user.lastName ? ' ' + user.lastName : '')
            : (user.email || 'Mon compte');
        }

        if (companyEl) {
          companyEl.textContent = user.company || 'Mon espace';
        }

        if (avatarEl) {
          const initial = (user.firstName || user.email || '?').trim()[0] || 'U';
          avatarEl.textContent = initial.toUpperCase();
        }
      }

      //       const logoutBtn = document.getElementById('logoutBtn');
      //       if (logoutBtn) {
      //         logoutBtn.addEventListener('click', function () {
      //           localStorage.removeItem('lcc_token');
      //           localStorage.removeItem('lcc_user');
      //           window.location.href = '/login.html';
      //         });
      //       }

      // Mobile menu
      const menuBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebarOverlay');

      if (menuBtn && sidebar && overlay) {
        menuBtn.addEventListener('click', function() {
          sidebar.classList.toggle('active');
          overlay.classList.toggle('active');

          const icon = menuBtn.querySelector('i');
          if (sidebar.classList.contains('active')) {
            icon.classList.remove('fa-bars');
            icon.classList.add('fa-times');
          } else {
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
          }
        });

        overlay.addEventListener('click', function() {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          const icon = menuBtn.querySelector('i');
          icon.classList.remove('fa-times');
          icon.classList.add('fa-bars');
        });

        if (window.innerWidth <= 1024) {
          document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
              sidebar.classList.remove('active');
              overlay.classList.remove('active');
              const icon = menuBtn.querySelector('i');
              icon.classList.remove('fa-times');
              icon.classList.add('fa-bars');
            });
          });
        }
      }

      // Nav active
      const currentPage = document.body.getAttribute('data-page');
      if (currentPage) {
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.remove('active');
        });
        const activeLink = document.querySelector('.nav-item[data-page="messages"]');
        if (activeLink) {
          activeLink.classList.add('active');
        }
      }
    })();
  </script>

  <!-- ‚úÖ NOUVELLE FONCTION : Suppression de conversation -->
  <script>
// ============================================
// FONCTION SUPPRESSION DE CONVERSATION
// ============================================

async function deleteConversation(conversationId, event) {
  // Emp√™cher l'ouverture du chat
  event.stopPropagation();
  
  if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette conversation ? Cette action est irr√©versible.')) {
    return;
  }
  
  try {
    const token = localStorage.getItem('lcc_token');
    const API_URL = window.location.origin;
    
    const response = await fetch(`${API_URL}/api/chat/conversations/${conversationId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });
    
    if (!response.ok) {
      const data = await response.json();
      throw new Error(data.error || 'Erreur lors de la suppression');
    }
    
    // Supprimer visuellement
    const conversationElement = document.querySelector(`[data-conversation-id="${conversationId}"]`);
    if (conversationElement) {
      conversationElement.style.transition = 'all 0.3s ease';
      conversationElement.style.opacity = '0';
      conversationElement.style.transform = 'translateX(-20px)';
      
      setTimeout(() => {
        conversationElement.remove();
        
        // Mettre √† jour les stats
        updateConversationStats();
        
        // Si plus aucune conversation
        const conversationsList = document.getElementById('conversationsList');
        if (conversationsList && conversationsList.children.length === 0) {
          conversationsList.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-inbox"></i>
              <p>Aucune conversation</p>
            </div>
          `;
        }
      }, 300);
    }
    
    // Toast de confirmation
    showToast('Conversation supprim√©e', 'success');
    
  } catch (error) {
    console.error('Erreur suppression conversation:', error);
    showToast('Erreur: ' + error.message, 'error');
  }
}

// Fonction pour afficher les toasts
function showToast(message, type = 'info') {
  const toastContainer = document.getElementById('toastContainer');
  if (!toastContainer) return;
  
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.style.cssText = `
    padding: 16px 20px;
    background: ${type === 'success' ? '#10B981' : '#EF4444'};
    color: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    margin-bottom: 12px;
    animation: slideInRight 0.3s ease;
  `;
  toast.textContent = message;
  
  toastContainer.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOutRight 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Fonction pour mettre √† jour les stats apr√®s suppression
function updateConversationStats() {
  const conversations = document.querySelectorAll('.conversation-item');
  const total = conversations.length;
  
  let unread = 0;
  let active = 0;
  
  conversations.forEach(conv => {
    const unreadBadge = conv.querySelector('.unread-badge');
    if (unreadBadge) {
      unread += parseInt(unreadBadge.textContent) || 0;
    }
    
    const statusBadge = conv.querySelector('.status-badge.active');
    if (statusBadge) {
      active++;
    }
  });
  
  document.getElementById('statTotal').textContent = total;
  document.getElementById('statUnread').textContent = unread;
  document.getElementById('statActive').textContent = active;
}
  </script>

  <!-- Fonctions g√©n√©ration message de r√©servation -->
  <script>
// ============================================
// FONCTIONS G√âN√âRATION MESSAGE DE R√âSERVATION
// ============================================

async function openBookingMessageModal(conversationId) {
  if (!conversationId) {
    alert('Erreur: ID de conversation manquant');
    return;
  }

  try {
    // Cr√©er la modal
    const modal = createBookingMessageModal();
    document.body.appendChild(modal);

    // Afficher loading
    const modalContent = modal.querySelector('.booking-modal-content');
    modalContent.innerHTML = `
      <div style="text-align: center; padding: 48px;">
        <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: var(--primary-color); margin-bottom: 16px;"></i>
        <p style="color: var(--text-secondary);">G√©n√©ration du message...</p>
      </div>
    `;

    // R√©cup√©rer le message
    const token = localStorage.getItem('lcc_token');
    const API_URL = window.location.origin;
    const response = await fetch(`${API_URL}/api/chat/generate-booking-message/${conversationId}`, {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || 'Erreur de g√©n√©ration');
    }

    // Afficher le message
    displayBookingMessage(modalContent, data);

  } catch (error) {
    console.error('Erreur g√©n√©ration message:', error);
    alert('Erreur: ' + error.message);
    closeBookingMessageModal();
  }
}

function createBookingMessageModal() {
  const modal = document.createElement('div');
  modal.id = 'bookingMessageModal';
  modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;z-index:10000;display:flex;align-items:center;justify-content:center;';
  
  modal.innerHTML = `
    <div onclick="closeBookingMessageModal()" style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);"></div>
    <div style="position:relative;background:white;border-radius:16px;width:90%;max-width:600px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:24px;border-bottom:1px solid #e5e7eb;">
        <h2 style="font-size:20px;font-weight:700;color:#111827;display:flex;align-items:center;gap:12px;margin:0;">
          <i class="fas fa-paper-plane"></i>
          Message de r√©servation
        </h2>
        <button onclick="closeBookingMessageModal()" style="width:36px;height:36px;border:none;background:#f9fafb;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="booking-modal-content" style="padding:24px;"></div>
    </div>
  `;
  return modal;
}

function displayBookingMessage(container, data) {
  const { message, hasCleaningPhotos, cleaningPhotoCount, pinCode, links } = data;

  container.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:24px;">
      <div style="display:flex;align-items:center;gap:12px;padding:12px;background:#f9fafb;border-radius:8px;border-left:4px solid #3B82F6;">
        <i class="fas fa-key" style="font-size:20px;color:#3B82F6;"></i>
        <div><strong>Code PIN:</strong> ${pinCode}</div>
      </div>
      ${hasCleaningPhotos ? `
        <div style="display:flex;align-items:center;gap:12px;padding:12px;background:#D1FAE5;border-radius:8px;border-left:4px solid #10B981;">
          <i class="fas fa-check-circle" style="font-size:20px;color:#10B981;"></i>
          <div><strong>Photos de nettoyage:</strong> ${cleaningPhotoCount} photo(s) disponible(s)</div>
        </div>
      ` : `
        <div style="display:flex;align-items:center;gap:12px;padding:12px;background:#FEF3C7;border-radius:8px;border-left:4px solid #F59E0B;">
          <i class="fas fa-exclamation-triangle" style="font-size:20px;color:#F59E0B;"></i>
          <div><strong>Attention:</strong> Aucune photo de nettoyage trouv√©e</div>
        </div>
      `}
    </div>

    <div style="background:#f9fafb;border-radius:12px;padding:16px;margin-bottom:20px;">
      <div style="display:flex;align-items:center;gap:8px;font-size:14px;font-weight:600;color:#6B7280;margin-bottom:12px;">
        <i class="fas fa-eye"></i>
        Aper√ßu du message
      </div>
      <div id="messageText" style="background:white;border:1px solid #e5e7eb;border-radius:8px;padding:16px;font-size:14px;line-height:1.6;color:#111827;white-space:pre-wrap;max-height:400px;overflow-y:auto;">${message.replace(/\n/g, '<br>')}</div>
    </div>

    <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;">
      <button onclick="copyBookingMessage()" style="flex:1;min-width:200px;padding:14px 24px;background:#3B82F6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
        <i class="fas fa-copy"></i>
        Copier le message
      </button>
      <button onclick="previewLinks('${links.cleaningPhotos || ''}', '${links.checkoutForm}')" style="padding:14px 24px;background:white;color:#3B82F6;border:2px solid #3B82F6;border-radius:8px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;">
        <i class="fas fa-external-link-alt"></i>
        Tester les liens
      </button>
    </div>

    <div style="display:flex;gap:12px;padding:16px;background:#EFF6FF;border-radius:8px;font-size:13px;color:#1E40AF;">
      <i class="fas fa-info-circle" style="font-size:18px;margin-top:2px;flex-shrink:0;"></i>
      <p style="margin:0;"><strong>Instructions :</strong> Copiez ce message et collez-le dans votre messagerie Airbnb ou Booking.com pour l'envoyer √† votre voyageur.</p>
    </div>
  `;
}

function copyBookingMessage() {
  const messageText = document.getElementById('messageText');
  if (!messageText) return;

  const text = messageText.innerText || messageText.textContent;
  
  navigator.clipboard.writeText(text).then(() => {
    alert('‚úÖ Message copi√© dans le presse-papier !');
  }).catch(err => {
    console.error('Erreur copie:', err);
    alert('‚ùå Erreur lors de la copie');
  });
}

function previewLinks(cleaningPhotosLink, checkoutFormLink) {
  let opened = false;
  
  if (cleaningPhotosLink && cleaningPhotosLink !== 'null' && cleaningPhotosLink !== '') {
    window.open(cleaningPhotosLink, '_blank');
    opened = true;
  }
  if (checkoutFormLink && checkoutFormLink !== 'null' && checkoutFormLink !== '') {
    window.open(checkoutFormLink, '_blank');
    opened = true;
  }
  
  if (!opened) {
    alert('Aucun lien √† tester');
  }
}

function closeBookingMessageModal() {
  const modal = document.getElementById('bookingMessageModal');
  if (modal) {
    modal.remove();
  }
}
  </script>

<!-- ‚úÖ ULTIMATE FIX iOS - Version simple -->
<script>
// Attendre que le DOM soit pr√™t
document.addEventListener('DOMContentLoaded', function() {
  console.log('‚úÖ Ultimate iOS fix - Version simple charg√©e');
});
</script>

<script src="/js/bh-layout.js"></script>
<script src="/js/logout-fix.js"></script>
<script src="/js/mobile-native-experience.js"></script>
<script src="/js/mobile-tabs-handler.js"></script>
<script src="/js/chat-emoji-photo.js"></script>
<script src="/js/messages-badge-desktop-mobile.js"></script> 
<script>
// Fix scroll iOS Capacitor
if (window.Capacitor && window.Capacitor.isNativePlatform()) {
  console.log('üîí iOS Modal Fix activ√©');
  
  // Observer quand le modal s'ouvre
  const observer = new MutationObserver(() => {
    const modal = document.querySelector('.modal-overlay.active');
    if (modal) {
      console.log('üîí Modal ouvert - Blocage scroll');
      document.body.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      document.body.style.width = '100%';
      document.body.style.height = '100vh';
    } else {
      console.log('üîì Modal ferm√© - D√©blocage scroll');
      document.body.style.overflow = '';
      document.body.style.position = '';
      document.body.style.width = '';
      document.body.style.height = '';
    }
  });
  
  observer.observe(document.body, {
    childList: true,
    subtree: true,
    attributes: true,
    attributeFilter: ['class']
  });
}
</script>


<script>
// ============================================================
// BRIDGE: connect old chat-owner.js to new split layout
// ============================================================
(function() {
  'use strict';

  // Mirror conversations from the hidden #conversationsList to #msgsConvList
  function syncConvList() {
    const source = document.getElementById('conversationsList');
    const target = document.getElementById('msgsConvList');
    if (!source || !target) return;

    const items = source.querySelectorAll('.conversation-item');
    if (items.length === 0) {
      // Still loading or empty
      if (source.querySelector('.empty-state')) {
        target.innerHTML = source.innerHTML;
      }
      return;
    }

    // Clone items into new panel
    target.innerHTML = '';
    items.forEach(function(item) {
      const clone = item.cloneNode(true);
      // Re-attach click handlers
      clone.addEventListener('click', function(e) {
        // Sync active state
        target.querySelectorAll('.conversation-item').forEach(function(i) { i.classList.remove('active'); });
        clone.classList.add('active');
        // Trigger original click
        item.click();
      });
      target.appendChild(clone);
    });
  }

  // Mirror chat from old modal to new right panel  
  function syncChatPanel() {
    const oldModal = document.getElementById('chatModal');
    const newMsgs = document.getElementById('chatMessages');
    const newHeader = document.getElementById('msgsChatHeader');
    const newInput = document.getElementById('msgsChatInput');
    const placeholder = document.getElementById('msgsChatPlaceholder');
    const oldTitle = document.getElementById('chatModalTitle');

    if (!oldModal || !newMsgs) return;

    // When old modal becomes active, show new panel
    const observer = new MutationObserver(function() {
      const isActive = oldModal.classList.contains('active') || oldModal.style.display === 'flex';
      if (isActive) {
        placeholder.style.display = 'none';
        newHeader.style.display = 'flex';
        newMsgs.style.display = 'flex';
        newInput.style.display = 'flex';

        // Copy title
        if (oldTitle) {
          document.getElementById('msgsChatGuestName').textContent = oldTitle.textContent;
        }

        // Mirror messages
        const oldMsgs = oldModal.querySelector('#chatMessages, .chat-modal-messages');
        if (oldMsgs && oldMsgs !== newMsgs) {
          newMsgs.innerHTML = oldMsgs.innerHTML;
        }

        // Close the old modal overlay (we're showing inline)
        oldModal.classList.remove('active');
        oldModal.style.display = 'none';
      }
    });
    observer.observe(oldModal, { attributes: true, attributeFilter: ['class', 'style'], childList: true, subtree: true });

    // Also observe chatMessages for new content
    const msgObserver = new MutationObserver(function() {
      const oldMsgArea = document.querySelector('#chatModal .chat-modal-messages, #chatModal #chatMessages');
      if (oldMsgArea) {
        newMsgs.innerHTML = oldMsgArea.innerHTML;
        newMsgs.scrollTop = newMsgs.scrollHeight;
      }
    });
    msgObserver.observe(document.body, { childList: true, subtree: true });
  }

  // Search filter
  function initSearch() {
    const input = document.getElementById('msgsSearchInput');
    if (!input) return;
    input.addEventListener('input', function() {
      const q = this.value.toLowerCase();
      document.querySelectorAll('#msgsConvList .conversation-item').forEach(function(item) {
        const name = item.querySelector('h3, .conversation-info h3');
        const text = name ? name.textContent.toLowerCase() : '';
        item.style.display = text.includes(q) ? '' : 'none';
      });
    });
  }

  // Observe conversationsList for changes and sync
  function watchAndSync() {
    const source = document.getElementById('conversationsList');
    if (!source) return;
    const obs = new MutationObserver(function() {
      setTimeout(syncConvList, 100);
    });
    obs.observe(source, { childList: true, subtree: true });
    syncConvList();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      watchAndSync();
      syncChatPanel();
      initSearch();
    });
  } else {
    watchAndSync();
    syncChatPanel();
    initSearch();
  }

  // Also sync every second as fallback
  setTimeout(syncConvList, 1000);
  setTimeout(syncConvList, 2000);
  setTimeout(syncConvList, 3000);
})();
</script>

<style id="final-overrides">
.view-selector { display: none !important; }
</style>


<script>
// Hide back button injected by bh-layout.js
(function() {
  function hideBackBtn() {
    // Common selectors for the back button
    document.querySelectorAll('.back-btn, .btn-back, .header-back, .page-back-btn, [class*="back"]').forEach(function(el) {
      var text = el.textContent || '';
      if (text.includes('dashboard') || text.includes('Dashboard') || text.includes('Retour') || el.href && el.href.includes('app.html')) {
        el.style.display = 'none';
      }
    });
  }
  // Run immediately and after layout injection
  hideBackBtn();
  document.addEventListener('DOMContentLoaded', hideBackBtn);
  setTimeout(hideBackBtn, 500);
  setTimeout(hideBackBtn, 1500);
  // MutationObserver to catch dynamically injected elements
  new MutationObserver(hideBackBtn).observe(document.body, { childList: true, subtree: true });
})();
</script>

</body>
</html>
