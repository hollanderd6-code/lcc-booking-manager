<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Messages ‚Äì LCC Booking Manager</title>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <!-- CSS plateforme -->
  <link rel="stylesheet" href="/css/style.css">

  <style>
    html, body {
      margin: 0 !important;
      padding: 0 !important;
    }

    /* Layout global : sidebar + contenu */
    .app-container {
      display: flex;
      min-height: 100vh;
    }

    .main-content {
      flex: 1;
      padding-top: 24px !important;
    }

    .page-content {
      margin-top: 0 !important;
    }

    .messages-page-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .messages-page-title i {
      color: var(--primary-color);
    }

    /* ===== Cards & timelines ===== */

    .timeline-section {
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid var(--border-color);
    }
    
    .timeline-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .timeline-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
    }
    
    .timeline-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .timeline-count {
      background: var(--primary-light);
      color: var(--primary-color);
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      margin-left: auto;
    }
    
    .reservation-list {
      display: grid;
      gap: 16px;
    }
    
    .reservation-item {
      padding: 16px;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      border-left: 4px solid var(--primary-color);
      transition: var(--transition);
    }
    
    .reservation-item:hover {
      box-shadow: var(--shadow-sm);
      transform: translateX(4px);
    }
    
    .reservation-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    
    .reservation-info h3 {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    
    .reservation-meta {
      color: var(--text-secondary);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    .empty-state i {
      font-size: 40px;
      opacity: 0.3;
      margin-bottom: 12px;
    }

    /* ============================================
       ASSISTANT IA - R√âDACTION VOYAGEURS
       ============================================ */

    .ai-section {
      border-left: 4px solid var(--accent-color);
    }

    .message-reply-body {
      margin-top: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
    }

    .message-reply-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      display: block;
      margin-bottom: 6px;
    }

    .message-reply-input {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      padding: var(--spacing-md);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      font-family: inherit;
      font-size: 14px;
      line-height: 1.5;
      color: var(--text-primary);
    }

    .message-reply-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 1px var(--primary-light);
    }

    .message-reply-footer {
      margin-top: var(--spacing-md);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: var(--spacing-md);
      flex-wrap: wrap;
    }

    .message-reply-ai {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      flex: 1;
      min-width: 260px;
    }

    .btn-ai {
      white-space: nowrap;
    }

    .message-reply-hint {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .message-reply-actions {
      display: flex;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
    }

    @media (max-width: 768px) {
      .message-reply-footer {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    .copy-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-fast);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    
    .copy-btn:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    .copy-btn.copied {
      background: #16a34a;
    }

    /* ============================================
       MOD√àLES INTELLIGENTS ‚Äì MESSAGES VOYAGEURS
       ============================================ */

    .templates-grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
      gap: var(--spacing-lg);
    }

    @media (max-width: 900px) {
      .templates-grid {
        grid-template-columns: 1fr;
      }
    }

    .template-form-row {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-sm);
    }

    .template-field {
      flex: 1;
      min-width: 160px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .template-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .template-input,
    .template-select {
      padding: 8px 10px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      font-size: 14px;
      font-family: inherit;
      color: var(--text-primary);
    }

    .template-input:focus,
    .template-select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 1px var(--primary-light);
    }

    .template-help-text {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-sm);
    }

    .template-result {
      width: 100%;
      min-height: 200px;
      resize: vertical;
      padding: var(--spacing-md);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      font-family: inherit;
      font-size: 14px;
      line-height: 1.6;
      color: var(--text-primary);
    }

    /* ============================================
       MESSAGES √âQUIPE M√âNAGE
       ============================================ */

    .cleaning-messages-section {
      margin-top: var(--spacing-xl);
    }

    .cleaning-controls {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .cleaning-controls input[type="date"] {
      padding: 8px 10px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      font-size: 14px;
    }

    .cleaning-hint {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .cleaning-messages-container {
      display: grid;
      gap: var(--spacing-md);
    }

    .cleaning-message-card {
      padding: var(--spacing-md);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
    }

    .cleaning-message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--spacing-sm);
      margin-bottom: 8px;
    }

    .cleaning-message-title {
      font-weight: 600;
      font-size: 14px;
    }

    .cleaning-message-meta {
      font-size: 12px;
      color: var(--text-secondary);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .cleaning-message-textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      padding: var(--spacing-sm);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      font-size: 13px;
      font-family: inherit;
      line-height: 1.5;
      margin-top: 8px;
    }

    .badge-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
    }

    /* ========== SIDEBAR ULTRA MODERNE (copi√© depuis app.html) ========== */

    .sidebar {
      background: radial-gradient(circle at top, #020617, #020617);
      border-right: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 18px 0 60px rgba(15, 23, 42, 0.7);
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .sidebar-header {
      padding: 4px 4px 10px;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      padding: 10px 12px;
      border-radius: 999px;
      background: linear-gradient(135deg, #0f172a, #020617);
      border: 1px solid rgba(148, 163, 184, 0.45);
      box-shadow: 0 14px 40px rgba(15, 23, 42, 0.8);
    }

    .sidebar-logo i {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 0%, #22c55e, #16a34a);
      color: #ecfdf5;
      font-size: 16px;
    }

    .sidebar-logo-title {
      font-weight: 700;
      font-size: 15px;
      letter-spacing: 0.02em;
      color: #e5e7eb;
    }

    .sidebar-logo-subtitle {
      font-size: 12px;
      color: #9ca3af;
    }

    .nav-section {
      margin-top: 8px;
    }

    .nav-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #6b7280;
      margin: 10px 10px 6px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 999px;
      color: #9ca3af;
      font-size: 13px;
      text-decoration: none;
      position: relative;
      transition: background 0.16s ease, color 0.16s ease, transform 0.16s ease, box-shadow 0.16s ease;
    }

    .nav-item i {
      font-size: 14px;
      width: 18px;
      text-align: center;
    }

    .nav-item:hover {
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      transform: translateX(2px);
    }

    .nav-item.active {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #ecfdf5;
      box-shadow: 0 16px 40px rgba(34, 197, 94, 0.45);
    }

    .nav-item.active i {
      color: #ecfdf5;
    }

    .nav-badge {
      margin-left: auto;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.85);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    .sidebar-footer {
      margin-top: auto;
      padding-top: 8px;
      border-top: 1px solid rgba(31, 41, 55, 0.9);
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 8px;
      border-radius: 16px;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      color: #ecfdf5;
    }

    .user-name {
      font-size: 13px;
      font-weight: 600;
      color: #e5e7eb;
    }

    .user-email {
      font-size: 11px;
      color: #9ca3af;
    }

    #logoutBtn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.9);
    }

    #logoutBtn:hover {
      background: rgba(15, 23, 42, 0.98);
    }
  </style>
</head>
<body>
  <div class="app-container">
    
    <!-- Sidebar ‚Äì identique √† app.html, mais Messages est active -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="/" class="sidebar-logo">
          <i class="fas fa-home"></i>
          <div class="sidebar-logo-text">
            <span class="sidebar-logo-title">LCC Booking</span>
            <span class="sidebar-logo-subtitle">La Conciergerie de Charles</span>
          </div>
        </a>
      </div>
      
      <nav class="sidebar-nav">
        <!-- PRINCIPAL -->
        <div class="nav-section">
          <div class="nav-section-title">Principal</div>

          <a href="/app.html" class="nav-item">
            <i class="fas fa-th-large"></i>
            <span>Dashboard</span>
          </a>

          <a href="#" class="nav-item" id="navCalendarLink">
            <i class="fas fa-calendar"></i>
            <span>Calendrier</span>
            <span class="nav-badge" id="navTotalReservations">0</span>
          </a>

          <a href="/messages.html" class="nav-item active">
            <i class="fas fa-comment-dots"></i>
            <span>Messages</span>
          </a>
        </div>
        
        <!-- GESTION -->
        <div class="nav-section">
          <div class="nav-section-title">Gestion</div>

          <a href="/settings.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Mes logements</span>
          </a>

          <a href="/welcome.html" class="nav-item">
            <i class="fas fa-book-open"></i>
            <span>Livret d'accueil</span>
          </a>

          <a href="/cleaning.html" class="nav-item">
            <i class="fas fa-broom"></i>
            <span>Gestion du m√©nage</span>
            <span class="nav-badge">Nouveau</span>
          </a>

          <a href="/statistics.html" class="nav-item">
            <i class="fas fa-chart-bar"></i>
            <span>Statistiques</span>
          </a>

          <a href="/deposits.html" class="nav-item">
            <i class="fas fa-shield-alt"></i>
            <span>Cautions</span>
          </a>

          <a href="/notifications.html" class="nav-item">
            <i class="fas fa-bell"></i>
            <span>Notifications</span>
          </a>
        </div>

        <!-- PARAM√àTRES -->
        <div class="nav-section">
          <div class="nav-section-title">Param√®tres</div>

          <a href="/settings-account.html" class="nav-item">
            <i class="fas fa-cog"></i>
            <span>Param√®tres</span>
          </a>

          <a href="/help.html" class="nav-item">
            <i class="fas fa-question-circle"></i>
            <span>Aide</span>
          </a>
        </div>
      </nav>
      
      <div class="sidebar-footer">
        <div class="user-profile">
          <div class="user-avatar" id="sidebarUserAvatar">C</div>
          <div class="user-info">
            <div class="user-name" id="sidebarUserName">Utilisateur</div>
            <div class="user-email" id="sidebarUserCompany">Mon espace</div>
          </div>

          <button class="btn btn-ghost" id="logoutBtn" style="padding: 4px 10px; font-size: 12px; margin-left: auto;">
            <i class="fas fa-sign-out-alt"></i>
            <span>Quitter</span>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main-content">
      <!-- Header -->
      <header class="main-header">
        <div class="header-left">
          <div class="page-kicker">Communication</div>
          <h1 class="page-title messages-page-title">
            <i class="fas fa-comment-dots"></i>
            Messages
          </h1>
          <p class="page-subtitle">
            Pr√©parez vos messages pour les voyageurs et vos √©quipes en quelques clics.
          </p>
        </div>
      </header>

      <!-- Page Content -->
      <div class="page-content">

        <!-- (tout le contenu que tu avais d√©j√† : sections messages, IA, m√©nage, etc.) -->
        <!-- Je ne le recolle pas pour gagner de la place, mais tu peux remettre exactement ce que tu avais √† l‚Äôint√©rieur de .page-content -->
        <!-- Colle ici le contenu de tes sections timeline / IA / mod√®les / m√©nage que tu m‚Äôavais envoy√©, sans toucher au layout au-dessus -->

      </div>
    </main>
  </div>

  <div class="toast-container" id="toastContainer"></div>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Chargement...</p>
    </div>
  </div>

  <!-- JS sp√©cifique messages (listes, etc.) -->
  <script src="/js/messages.js"></script>

  <!-- Script auth + user + logout (copi√© du dashboard) -->
  <script>
    (function () {
      const token = localStorage.getItem('lcc_token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      const rawUser = localStorage.getItem('lcc_user');
      let user = null;

      try {
        user = rawUser ? JSON.parse(rawUser) : null;
      } catch (e) {
        console.error('Impossible de lire lcc_user', e);
      }

      if (user) {
        const nameEl = document.getElementById('sidebarUserName');
        const companyEl = document.getElementById('sidebarUserCompany');
        const avatarEl = document.getElementById('sidebarUserAvatar');

        if (nameEl) {
          nameEl.textContent = user.firstName
            ? user.firstName + (user.lastName ? ' ' + user.lastName : '')
            : (user.email || 'Mon compte');
        }

        if (companyEl) {
          companyEl.textContent = user.company || 'Mon espace';
        }

        if (avatarEl) {
          const initial = (user.firstName || user.email || '?').trim()[0] || 'U';
          avatarEl.textContent = initial.toUpperCase();
        }
      }

      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function () {
          localStorage.removeItem('lcc_token');
          localStorage.removeItem('lcc_user');
          window.location.href = '/login.html';
        });
      }
    })();
  </script>

  <!-- Script assistant IA + mod√®les + messages m√©nage -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      /* ========= Donn√©es logements (partag√©es) ========= */
      const PROPERTIES = window.LCC_PROPERTIES || [
        { id: 'apt-demo-1', name: 'Appartement d√©mo 1' },
        { id: 'apt-demo-2', name: 'Appartement d√©mo 2' }
      ];

      /* ========= 1) MOD√àLES INTELLIGENTS ========= */
      const tplType = document.getElementById('tplType');
      const tplGuestName = document.getElementById('tplGuestName');
      const tplPropertyName = document.getElementById('tplPropertyName');
      const tplCheckinDate = document.getElementById('tplCheckinDate');
      const tplCheckoutDate = document.getElementById('tplCheckoutDate');
      const tplArrivalTime = document.getElementById('tplArrivalTime');
      const tplExtraInfo = document.getElementById('tplExtraInfo');
      const tplResult = document.getElementById('tplResult');
      const tplGenerateBtn = document.getElementById('tplGenerateBtn');
      const tplResetBtn = document.getElementById('tplResetBtn');
      const tplCopyBtn = document.getElementById('tplCopyBtn');

      // üîΩ On remplit le select des logements avec LCC_PROPERTIES
      if (tplPropertyName && PROPERTIES && PROPERTIES.length) {
        PROPERTIES.forEach(p => {
          const opt = document.createElement('option');
          opt.value = (p.name || p.title || p.label || p.id || '').toString();
          opt.textContent = p.name || p.title || p.label || p.id;
          tplPropertyName.appendChild(opt);
        });
      }

      function formatDateFr(iso) {
        if (!iso) return '';
        const d = new Date(iso);
        if (isNaN(d)) return iso;
        return d.toLocaleDateString('fr-FR', { day:'2-digit', month:'long', year:'numeric' });
      }

      function buildSmartTemplate() {
        const type = tplType.value;
        const guest = tplGuestName.value.trim() || 'Bonjour';
        const firstLine = guest.toLowerCase().startsWith('bonjour') ? guest : `Bonjour ${guest},`;

        const property = (tplPropertyName.value || '').trim() || 'votre logement';
        const ci = tplCheckinDate.value ? formatDateFr(tplCheckinDate.value) : null;
        const co = tplCheckoutDate.value ? formatDateFr(tplCheckoutDate.value) : null;
        const arrTime = tplArrivalTime.value.trim();
        const extra = tplExtraInfo.value.trim();

        const stayLine = (ci && co)
          ? `Votre s√©jour est pr√©vu du ${ci} au ${co}.`
          : ci
            ? `Votre arriv√©e est pr√©vue le ${ci}.`
            : '';

        let body = '';

        if (type === 'prearrival') {
          body += (stayLine ? stayLine + '\n\n' : '');
          body += `Je vous confirme la r√©servation de ${property}. `;
          body += `Vous recevrez, avant votre arriv√©e, toutes les informations d√©taill√©es concernant l'acc√®s au logement, le code ou la remise des cl√©s, ainsi que le fonctionnement du check-in.`;
          if (arrTime) {
            body += `\n\nSi possible, merci de me confirmer votre heure d‚Äôarriv√©e approximative (${arrTime}) afin que je puisse m‚Äôorganiser au mieux.`;
          } else {
            body += `\n\nSi possible, merci de me communiquer votre heure d‚Äôarriv√©e approximative afin que je puisse m‚Äôorganiser au mieux.`;
          }
          if (extra) {
            body += `\n\n√Ä noter : ${extra}.`;
          }
        }

        if (type === 'arrivalday') {
          body += (stayLine ? stayLine + '\n\n' : '');
          body += `Petit rappel pour votre arriv√©e √† ${property} aujourd‚Äôhui. `;
          body += `Les instructions de check-in (adresse exacte, acc√®s √† l‚Äôimmeuble, codes ou cl√©s) sont disponibles dans vos messages et dans le livret d‚Äôaccueil.`;
          if (arrTime) {
            body += `\n\nComme indiqu√©, votre arriv√©e est pr√©vue ${arrTime}. Si votre horaire change, n‚Äôh√©sitez pas √† me pr√©venir.`;
          } else {
            body += `\n\nSi votre horaire d‚Äôarriv√©e change, n‚Äôh√©sitez pas √† me pr√©venir.`;
          }
          if (extra) {
            body += `\n\nRappel utile : ${extra}.`;
          }
        }

        if (type === 'duringstay') {
          body += (stayLine ? stayLine + '\n\n' : '');
          body += `J‚Äôesp√®re que tout se passe bien pour vous √† ${property}. `;
          body += `N‚Äôh√©sitez surtout pas √† me signaler si quelque chose manque, si vous avez une question sur le logement ou besoin d‚Äôune recommandation (restaurants, activit√©s, transports‚Ä¶).`;
          if (extra) {
            body += `\n\nInformations utiles pour votre s√©jour : ${extra}.`;
          }
        }

        if (type === 'checkout') {
          body += co
            ? `Comme pr√©vu, votre d√©part est pr√©vu le ${co}.\n\n`
            : 'Petit rappel concernant votre d√©part.\n\n';
          body += `Le check-out se fait g√©n√©ralement avant 11h (sauf accord diff√©rent). `;
          body += `Merci de laisser le logement dans un √©tat correct, de v√©rifier que vous n‚Äôavez rien oubli√© et de vous assurer que la porte est bien ferm√©e en partant.`;
          if (extra) {
            body += `\n\nDernier rappel important : ${extra}.`;
          }
        }

        if (type === 'thankyou') {
          body += co
            ? `Merci encore pour votre s√©jour du ${ci || ''}${ci && co ? ' au ' : ''}${co || ''} √† ${property}.\n\n`
            : `Merci encore pour votre s√©jour √† ${property}.\n\n`;
          body += `J‚Äôesp√®re que tout s‚Äôest bien pass√© et que vous avez pass√© un agr√©able moment. `;
          body += `Si vous avez quelques minutes, je serais ravi(e) que vous laissiez un avis sur la plateforme, cela m‚Äôaide beaucoup pour la suite.`;
          if (extra) {
            body += `\n\nVous pouvez √©galement me faire un retour direct si vous voyez un point √† am√©liorer : ${extra}.`;
          }
        }

        let msg = firstLine + '\n\n' + body + '\n\n' + 'Bien cordialement,\nLa Conciergerie de Charles';
        return msg.trim();
      }

      if (tplGenerateBtn && tplResult) {
        tplGenerateBtn.addEventListener('click', () => {
          tplResult.value = buildSmartTemplate();
        });
      }

      if (tplResetBtn) {
        tplResetBtn.addEventListener('click', () => {
          tplGuestName.value = '';
          tplPropertyName.value = '';
          tplCheckinDate.value = '';
          tplCheckoutDate.value = '';
          tplArrivalTime.value = '';
          tplExtraInfo.value = '';
          tplResult.value = '';
        });
      }

      if (tplCopyBtn) {
        tplCopyBtn.addEventListener('click', async () => {
          const text = tplResult.value.trim();
          if (!text) return;
          try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              await navigator.clipboard.writeText(text);
              tplCopyBtn.classList.add('copied');
              tplCopyBtn.innerHTML = '<i class="fas fa-check"></i> Copi√© !';
              setTimeout(() => {
                tplCopyBtn.classList.remove('copied');
                tplCopyBtn.innerHTML = '<i class="fas fa-copy"></i> Copier le message';
              }, 1500);
            } else {
              const t = document.createElement('textarea');
              t.value = text;
              document.body.appendChild(t);
              t.select();
              document.execCommand('copy');
              document.body.removeChild(t);
            }
          } catch (e) {
            console.error(e);
          }
        });
      }

      /* ========= 2) Assistant IA voyageurs (brouillon) ========= */
      const aiContext = document.getElementById('aiContext');
      const aiReply = document.getElementById('aiReply');
      const aiSuggestBtn = document.getElementById('aiSuggestBtn');
      const aiHint = document.getElementById('aiHint');
      const aiClearBtn = document.getElementById('aiClearBtn');
      const aiCopyBtn = document.getElementById('aiCopyBtn');

      if (aiContext && aiReply && aiSuggestBtn) {
        async function fetchAiSuggestion(contextText) {
          const intro = "Bonjour,";
          let core;

          if (contextText && contextText.length > 10) {
            core = "Merci pour votre message. " +
              "Je vous confirme avoir bien pris en compte votre demande. " +
              "Je reste bien entendu disponible si vous avez la moindre question ou besoin suppl√©mentaire pendant votre s√©jour.";
          } else {
            core = "Merci pour votre message. " +
              "Je reste √† votre disposition pour toute question ou pr√©cision concernant votre arriv√©e ou votre s√©jour.";
          }

          return (
            intro + "\n\n" +
            core + "\n\n" +
            "Bien cordialement,\nLa Conciergerie de Charles"
          );
        }

        aiSuggestBtn.addEventListener('click', async () => {
          const contextText = aiContext.value.trim();

          aiSuggestBtn.disabled = true;
          aiSuggestBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> G√©n√©ration‚Ä¶';
          aiHint.textContent = "G√©n√©ration d‚Äôun brouillon de r√©ponse‚Ä¶";

          try {
            const suggestion = await fetchAiSuggestion(contextText);

            if (!aiReply.value.trim()) {
              aiReply.value = suggestion;
            } else {
              aiReply.value = aiReply.value.trim() + "\n\n" + suggestion;
            }

            aiHint.textContent = "Brouillon g√©n√©r√©. Tu peux le modifier avant de le copier dans Airbnb/Booking.";
          } catch (e) {
            console.error(e);
            aiHint.textContent = "Impossible de g√©n√©rer une r√©ponse pour le moment.";
          } finally {
            aiSuggestBtn.disabled = false;
            aiSuggestBtn.innerHTML = '<i class="fas fa-magic"></i> Proposer une r√©ponse avec l‚ÄôIA';
          }
        });

        if (aiClearBtn) {
          aiClearBtn.addEventListener('click', () => {
            aiContext.value = '';
            aiReply.value = '';
            aiHint.textContent = "L‚ÄôIA r√©digera un brouillon poli et professionnel √† partir du contexte.";
          });
        }

        if (aiCopyBtn) {
          aiCopyBtn.addEventListener('click', async () => {
            const text = aiReply.value.trim();
            if (!text) return;

            try {
              if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
                aiCopyBtn.classList.add('copied');
                aiCopyBtn.innerHTML = '<i class="fas fa-check"></i> Copi√© !';
                setTimeout(() => {
                  aiCopyBtn.classList.remove('copied');
                  aiCopyBtn.innerHTML = '<i class="fas fa-copy"></i> Copier la r√©ponse';
                }, 1500);
              } else {
                const temp = document.createElement('textarea');
                temp.value = text;
                document.body.appendChild(temp);
                temp.select();
                document.execCommand('copy');
                document.body.removeChild(temp);
              }
            } catch (e) {
              console.error(e);
            }
          });
        }
      }

      /* ========= 3) Messages √©quipe m√©nage ========= */

      const STORAGE_CLEANERS = 'lcc_cleaners';
      const STORAGE_ASSIGN = 'lcc_cleaning_assignments';

      const RESERVATIONS = window.LCC_RESERVATIONS || [];

      let cleaners = [];
      let assignments = {};

      function loadCleaningData() {
        try {
          cleaners = JSON.parse(localStorage.getItem(STORAGE_CLEANERS)) || [];
          assignments = JSON.parse(localStorage.getItem(STORAGE_ASSIGN)) || {};
        } catch (e) {
          cleaners = [];
          assignments = {};
        }
      }

      function normalizeDateString(dateStr) {
        return dateStr ? dateStr.slice(0, 10) : null;
      }

      function getPropertyName(propertyId) {
        const p = PROPERTIES.find(x => x.id === propertyId || x.propertyId === propertyId);
        return p ? (p.name || p.title || p.label || propertyId) : (propertyId || 'Logement');
      }

      function getCleanerById(id) {
        return cleaners.find(c => c.id === id) || null;
      }

      function generateCleaningTasks(dateStr) {
        if (!dateStr) return [];

        const tasks = [];

        RESERVATIONS.forEach(r => {
          if (!r.start || !r.end || !r.propertyId) return;

          const startStr = normalizeDateString(r.start);
          const endStr = normalizeDateString(r.end);
          const propertyId = r.propertyId;
          const propertyName = getPropertyName(propertyId);
          const cleanerId = assignments[propertyId];
          const cleaner = cleanerId ? getCleanerById(cleanerId) : null;

          if (endStr === dateStr) {
            tasks.push({
              type: 'departure',
              propertyId,
              propertyName,
              cleaner,
              reservation: r
            });
          }

          if (startStr === dateStr) {
            tasks.push({
              type: 'arrival',
              propertyId,
              propertyName,
              cleaner,
              reservation: r
            });
          }
        });

        return tasks;
      }

      function buildMessageForCleaner(cleaner, tasksForCleaner, dateStr) {
        const date = new Date(dateStr);
        const formattedDate = date.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit', month: 'long' });

        const firstName = cleaner.name?.split(' ')[0] || cleaner.name || '';
        let lines = [];

        lines.push(`Bonjour ${firstName},`);
        lines.push('');
        lines.push(`Voici vos interventions m√©nage pr√©vues pour ${formattedDate} :`);
        lines.push('');

        tasksForCleaner.forEach(t => {
          const res = t.reservation;
          const guest = res.guestName || res.name || 'client';
          const stayInfo = `${normalizeDateString(res.start)} ‚Üí ${normalizeDateString(res.end)}`;

          if (t.type === 'departure') {
            lines.push(`- ${t.propertyName} ‚Äì apr√®s un d√©part (${guest}, s√©jour ${stayInfo})`);
          } else {
            lines.push(`- ${t.propertyName} ‚Äì v√©rification avant une arriv√©e (${guest}, s√©jour ${stayInfo})`);
          }
        });

        lines.push('');
        lines.push(`Merci beaucoup, et n‚Äôh√©site pas √† me signaler tout probl√®me ou anomalie.`);
        lines.push('');
        lines.push('La Conciergerie de Charles');

        return lines.join('\n');
      }

      function buildMessageForUnassigned(tasks, dateStr) {
        const date = new Date(dateStr);
        const formattedDate = date.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit', month: 'long' });

        let lines = [];
        lines.push(`T√¢ches m√©nage sans personne assign√©e ‚Äì ${formattedDate}`);
        lines.push('');

        tasks.forEach(t => {
          const res = t.reservation;
          const guest = res.guestName || res.name || 'client';
          const stayInfo = `${normalizeDateString(res.start)} ‚Üí ${normalizeDateString(res.end)}`;

          if (t.type === 'departure') {
            lines.push(`- ${t.propertyName} ‚Äì apr√®s un d√©part (${guest}, s√©jour ${stayInfo})`);
          } else {
            lines.push(`- ${t.propertyName} ‚Äì avant une arriv√©e (${guest}, s√©jour ${stayInfo})`);
          }
        });

        lines.push('');
        lines.push('Pensez √† assigner ces logements √† une personne de m√©nage dans le module d√©di√©.');
        return lines.join('\n');
      }

      const cleaningMsgDate = document.getElementById('cleaningMsgDate');
      const generateCleaningMessagesBtn = document.getElementById('generateCleaningMessagesBtn');
      const cleaningMessagesContainer = document.getElementById('cleaningMessagesContainer');
      const cleaningMsgHint = document.getElementById('cleaningMsgHint');

      if (cleaningMsgDate && generateCleaningMessagesBtn && cleaningMessagesContainer) {
        const today = new Date();
        const isoToday = today.toISOString().slice(0,10);
        cleaningMsgDate.value = isoToday;

        generateCleaningMessagesBtn.addEventListener('click', () => {
          const dateStr = cleaningMsgDate.value;
          if (!dateStr) return;

          loadCleaningData();
          const tasks = generateCleaningTasks(dateStr);

          if (!tasks.length) {
            cleaningMessagesContainer.innerHTML = `
              <p class="empty-state">
                <i class="fas fa-calendar-times"></i><br>
                Aucun d√©part ou arriv√©e trouv√© pour cette date. Aucun message m√©nage g√©n√©r√©.
              </p>`;
            return;
          }

          const byCleaner = {};
          const unassigned = [];

          tasks.forEach(t => {
            if (t.cleaner) {
              const id = t.cleaner.id;
              if (!byCleaner[id]) byCleaner[id] = [];
              byCleaner[id].push(t);
            } else {
              unassigned.push(t);
            }
          });

          cleaningMessagesContainer.innerHTML = '';

          Object.keys(byCleaner).forEach(cleanerId => {
            const cleaner = getCleanerById(cleanerId);
            if (!cleaner) return;
            const tasksForCleaner = byCleaner[cleanerId];
            const messageText = buildMessageForCleaner(cleaner, tasksForCleaner, dateStr);

            const card = document.createElement('div');
            card.className = 'cleaning-message-card';

            const phone = cleaner.phone || '';
            const email = cleaner.email || '';

            card.innerHTML = `
              <div class="cleaning-message-header">
                <div>
                  <div class="cleaning-message-title">
                    ${cleaner.name}
                  </div>
                  <div class="cleaning-message-meta">
                    ${phone ? `<span class="badge-pill"><i class="fas fa-phone"></i>${phone}</span>` : ''}
                    ${email ? `<span class="badge-pill"><i class="fas fa-envelope"></i>${email}</span>` : ''}
                    <span class="badge-pill"><i class="fas fa-list-check"></i>${tasksForCleaner.length} intervention(s)</span>
                  </div>
                </div>
                <button type="button" class="copy-btn cleaning-copy-btn">
                  <i class="fas fa-copy"></i> Copier le message
                </button>
              </div>
              <textarea class="cleaning-message-textarea">${messageText}</textarea>
            `;

            cleaningMessagesContainer.appendChild(card);
          });

          if (unassigned.length) {
            const text = buildMessageForUnassigned(unassigned, dateStr);
            const card = document.createElement('div');
            card.className = 'cleaning-message-card';
            card.innerHTML = `
              <div class="cleaning-message-header">
                <div>
                  <div class="cleaning-message-title">
                    Logements sans personne assign√©e
                  </div>
                  <div class="cleaning-message-meta">
                    <span class="badge-pill"><i class="fas fa-triangle-exclamation"></i>${unassigned.length} t√¢che(s)</span>
                  </div>
                </div>
                <button type="button" class="copy-btn cleaning-copy-btn">
                  <i class="fas fa-copy"></i> Copier le message
                </button>
              </div>
              <textarea class="cleaning-message-textarea">${text}</textarea>
            `;
            cleaningMessagesContainer.appendChild(card);
          }

          cleaningMsgHint.textContent = "Messages g√©n√©r√©s. Tu peux les ajuster avant de les coller dans SMS / WhatsApp / email.";

          cleaningMessagesContainer.querySelectorAll('.cleaning-copy-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
              const card = btn.closest('.cleaning-message-card');
              if (!card) return;
              const ta = card.querySelector('.cleaning-message-textarea');
              if (!ta) return;
              const text = ta.value.trim();
              if (!text) return;

              try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                  await navigator.clipboard.writeText(text);
                  btn.classList.add('copied');
                  btn.innerHTML = '<i class="fas fa-check"></i> Copi√© !';
                  setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.innerHTML = '<i class="fas fa-copy"></i> Copier le message';
                  }, 1500);
                } else {
                  const temp = document.createElement('textarea');
                  temp.value = text;
                  document.body.appendChild(temp);
                  temp.select();
                  document.execCommand('copy');
                  document.body.removeChild(temp);
                }
              } catch (e) {
                console.error(e);
              }
            });
          });
        });
      }
    });
  </script>
</body>
</html>
