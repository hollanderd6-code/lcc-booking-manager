<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Boostinghost – Cautions</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- CSS plateforme -->
  <link rel="stylesheet" href="/css/style.css">

  <style>
    html, body {
      margin: 0 !important;
      padding: 0 !important;
    }
    .app-container {
      margin-top: 0 !important;
    }
    .main-content {
      margin-top: 0 !important;
      padding-top: 24px !important;
    }
    .page-content {
      margin-top: 0 !important;
      max-width: 1100px;
    }
    html {
      scroll-behavior: smooth;
    }

    .card {
      background: var(--bg-primary);
      border-radius: 18px;
      padding: 16px 18px;
      box-shadow: var(--shadow-sm);
      margin-bottom: 20px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .card-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }
    .card-title i {
      font-size: 14px;
      color: var(--text-secondary);
    }
    .card-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border-color-subtle);
      text-align: left;
    }
    th {
      font-weight: 600;
      background: var(--bg-secondary);
    }
    tr:last-child td {
      border-bottom: none;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
    }
    .badge-empty {
      background: var(--bg-secondary);
      color: var(--text-secondary);
    }
    .badge-pending {
      background: rgba(234, 179, 8, .12);
      color: #92400e;
    }
    .badge-paid {
      background: rgba(22, 163, 74, .12);
      color: #166534;
    }
    .badge-refunded {
      background: rgba(37, 99, 235, .12);
      color: #1d4ed8;
    }

    .btn-xs {
      padding: 4px 8px;
      font-size: 11px;
    }

    .empty-state {
      padding: 12px 0;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .link-cell {
      max-width: 260px;
      word-break: break-all;
      font-size: 11px;
      color: var(--text-secondary);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: var(--bg-primary);
      border-radius: 18px;
      max-width: 420px;
      width: 90%;
      box-shadow: var(--shadow-xl);
      overflow: hidden;
    }
    .modal-header {
      padding: 14px 18px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h2 {
      font-size: 16px;
      margin: 0;
    }
    .modal-body {
      padding: 16px 18px 18px;
    }
    .modal-footer {
      padding: 10px 18px 14px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .modal-close {
      border: none;
      background: transparent;
      cursor: pointer;
      color: var(--text-secondary);
    }
    .form-row {
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }
    .form-row label {
      font-weight: 500;
    }
    .form-row input,
    .form-row select {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border-color-subtle);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 13px;
    }
    .small-hint {
      font-size: 11px;
      color: var(--text-secondary);
    }
.actions-stack {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 4px;
}

    .text-secondary {
      color: var(--text-secondary);
    }

    /* ========== HEADER DASHBOARD MODERNE (comme app.html) ========== */

    .main-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      padding: 18px 20px;
      margin-bottom: 20px;
      border-radius: 20px;
      background: linear-gradient(
        135deg,
        rgba(15, 23, 42, 0.98),
        rgba(15, 23, 42, 0.92)
      );
      border: 1px solid rgba(148, 163, 184, 0.45);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.7);
    }

    [data-theme="light"] .main-header {
      background: linear-gradient(135deg, #f9fafb, #eff6ff);
      border-color: rgba(148, 163, 184, 0.4);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.06);
    }

    .header-left {
      max-width: 60%;
    }

    .page-kicker {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: #9ca3af;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .page-title {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    .page-subtitle {
      margin-top: 6px;
      font-size: 13px;
      color: #9ca3af;
    }

    [data-theme="light"] .page-subtitle {
      color: #6b7280;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-ghost {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: transparent;
      padding-inline: 14px;
    }

    .btn-ghost:hover {
      background: rgba(15, 23, 42, 0.06);
    }

    [data-theme="dark"] .btn-ghost:hover {
      background: rgba(15, 23, 42, 0.9);
    }

    .hide-on-mobile {
      display: inline-flex;
    }

    @media (max-width: 768px) {
      .main-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-left {
        max-width: 100%;
      }
      .hide-on-mobile {
        display: none;
      }
    }
  </style>

  <!-- Script auth + user + logout -->
  <script>
    (async function checkSubscriptionAccess() {
    const token = localStorage.getItem('lcc_token');
    
    if (!token) {
      window.location.href = '/login.html';
      return;
    }

    try {
      const res = await fetch('/api/subscription/status', {
        headers: { 'Authorization': 'Bearer ' + token }
      });

      if (!res.ok) {
        if (res.status === 401 || res.status === 403) {
          localStorage.removeItem('lcc_token');
          localStorage.removeItem('lcc_user');
          window.location.href = '/login.html';
        }
        return;
      }

      const data = await res.json();

      if (data.status === 'expired' || data.status === 'canceled') {
        window.location.href = '/subscription-expired.html';
        return;
      }

      if (data.status === 'trial' && data.daysRemaining !== null && data.daysRemaining < 0) {
        window.location.href = '/subscription-expired.html';
        return;
      }

    } catch (err) {
      console.error('Erreur vérification abonnement:', err);
    }
  })();
    (function () {
      const token = localStorage.getItem('lcc_token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      const rawUser = localStorage.getItem('lcc_user');
      let user = null;

      try {
        user = rawUser ? JSON.parse(rawUser) : null;
      } catch (e) {
        console.error('Impossible de lire lcc_user', e);
      }

      window.addEventListener('DOMContentLoaded', () => {
        if (user) {
          const nameEl = document.getElementById('sidebarUserName');
          const companyEl = document.getElementById('sidebarUserCompany');
          const avatarEl = document.getElementById('sidebarUserAvatar');

          if (nameEl) {
            nameEl.textContent = user.firstName
              ? user.firstName + (user.lastName ? ' ' + user.lastName : '')
              : (user.email || 'Mon compte');
          }

          if (companyEl) {
            companyEl.textContent = user.company || 'Mon espace';
          }

          if (avatarEl) {
            const initial = (user.firstName || user.email || '?').trim()[0] || 'U';
            avatarEl.textContent = initial.toUpperCase();
          }
        }

        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', function () {
            localStorage.removeItem('lcc_token');
            localStorage.removeItem('lcc_user');
            window.location.href = '/login.html';
          });
        }
      });
    })();
  </script>
</head>
<body data-page="deposits">
  <!-- MOBILE HEADER -->
  <div class="mobile-header">
    <a href="/app.html" class="mobile-logo">
      <i class="fas fa-calendar-check"></i>
      <span class="mobile-logo-text">Bookingmanage</span>
    </a>
    <button class="mobile-menu-btn" id="mobileMenuBtn">
      <i class="fas fa-bars"></i>
    </button>
  </div>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div class="app-container">

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="/" class="sidebar-logo">
  <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink:0;">
    <path d="M8 20V34C8 35.1046 8.89543 36 10 36H30C31.1046 36 32 35.1046 32 34V20" 
          stroke="#3B82F6" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M16 36V26H24V36" 
          stroke="#3B82F6" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M20 4L4 18H10V22H30V18H36L20 4Z" 
          fill="#10B981" stroke="#10B981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M20 9L24 14H16L20 9Z" fill="white"/>
  </svg>
  <div class="sidebar-logo-text" style="display: flex; flex-direction: column; justify-content: center; margin-left: 10px;">
    <span class="sidebar-logo-title" style="font-family: 'Inter', sans-serif; font-size: 17px; line-height: 1.1;">
      <span style="color: #10B981; font-weight: 800;">Boosting</span><span style="color: #111827; font-weight: 600;">host</span>
    </span>
    <span class="sidebar-logo-subtitle" style="font-size: 10px; color: #6B7280; font-weight: 500; letter-spacing: 0.5px;">
      Smart Property Manager
    </span>
  </div>
</a>
      
      <nav class="sidebar-nav">
        <!-- PRINCIPAL -->
        <div class="nav-section">
          <div class="nav-section-title">Principal</div>

          <a href="/app.html" class="nav-item" data-page="app">
            <i class="fas fa-th-large"></i>
            <span>Dashboard</span>
          </a>

          <a href="/app.html#calendarSection" class="nav-item" id="navCalendarLink">
            <i class="fas fa-calendar"></i>
            <span>Calendrier</span>
            <span class="nav-badge" id="navTotalReservations">0</span>
          </a>

          <a href="/messages.html" class="nav-item" data-page="messages">
            <i class="fas fa-comment-dots"></i>
            <span>Messages</span>
          </a>
        </div>

        <!-- GESTION -->
        <div class="nav-section">
          <div class="nav-section-title">Gestion</div>

          <a href="/settings.html" class="nav-item" data-page="settings">
            <i class="fas fa-home"></i>
            <span>Mes logements</span>
          </a>

          <a href="/welcome.html" class="nav-item" data-page="welcome">
            <i class="fas fa-book-open"></i>
            <span>Livret d'accueil</span>
          </a>

          <a href="/cleaning.html" class="nav-item" data-page="cleaning">
            <i class="fas fa-broom"></i>
            <span>Gestion du ménage</span>
             </a>

          <div class="nav-section">
  <div class="nav-section-title"><Facturation></Facturation></div>
  <a href="/factures.html" class="nav-item">
    <i class="fas fa-file-invoice"></i>
    <span>Factures clients</span>
  </a>
  <a href="/factures-proprietaires.html" class="nav-item">
    <i class="fas fa-file-invoice-dollar"></i>
    <span>Factures propriétaires</span>
  </a>
</div>


          <a href="/deposits.html" class="nav-item active" data-page="deposits">
            <i class="fas fa-shield-alt"></i>
            <span>Cautions</span>
          </a>

          <a href="/notifications.html" class="nav-item" data-page="notifications">
            <i class="fas fa-bell"></i>
            <span>Notifications</span>
          </a>
        </div>

        <!-- PARAMÈTRES -->
        <div class="nav-section">
          <div class="nav-section-title">Paramètres</div>

          <a href="/settings-account.html" class="nav-item" data-page="settings-account">
            <i class="fas fa-cog"></i>
            <span>Paramètres</span>
          </a>

          <a href="/help.html" class="nav-item" data-page="help">
            <i class="fas fa-question-circle"></i>
            <span>Aide</span>
          </a>
        </div>
      </nav>
      
      <div class="sidebar-footer">
        <div class="user-profile">
          <div class="user-avatar" id="sidebarUserAvatar">C</div>
          <div class="user-info">
            <div class="user-name" id="sidebarUserName">Utilisateur</div>
            <div class="user-email" id="sidebarUserCompany">Mon espace</div>
          </div>

          <button class="btn btn-ghost btn-xs" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main-content">
      <header class="main-header">
        <div class="header-left">
          <div class="page-kicker">Paiements</div>
          <h1 class="page-title">Cautions</h1>
          <p class="page-subtitle">
            Générez des liens de paiement de caution pour vos voyageurs, réservation par réservation.
          </p>
        </div>

        <div class="header-actions">
          <button class="btn btn-ghost hide-on-mobile" onclick="window.location.href='/app.html'">
            <i class="fas fa-th-large"></i>
            Retour au dashboard
          </button>
        </div>
      </header>

      <div class="page-content">

        <section class="card">
          <div class="card-header">
            <div class="card-title">
              <i class="fas fa-list"></i>
              <span>Réservations & cautions</span>
            </div>
            <button class="btn btn-ghost btn-xs" id="refreshBtn">
              <i class="fas fa-sync-alt"></i>
              Actualiser
            </button>
          </div>
          <p class="card-subtitle">
            Pour chaque réservation, vous pouvez créer un lien Stripe de caution avec un montant libre.
          </p>

          <div class="form-row" style="margin-bottom: 10px; display:flex; align-items:center; gap:8px;">
            <label for="propertyFilter" style="font-size:13px; font-weight:500;">Logement :</label>
            <select id="propertyFilter">
              <option value="">Tous les logements</option>
            </select>
          </div>

          <div id="depositsContainer">
            <p class="empty-state">Chargement des réservations…</p>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- MODAL: nouvelle caution -->
  <div class="modal" id="depositModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Nouvelle caution</h2>
        <button class="modal-close" id="depositModalClose">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <label>Réservation</label>
          <div id="depositModalReservationLabel" class="small-hint"></div>
        </div>
        <div class="form-row">
          <label for="depositAmount">Montant de la caution (€)</label>
          <input type="number" id="depositAmount" min="1" step="1" required>
          <div class="small-hint">
            Le montant sera encaissé via Stripe. Vous pourrez rembourser ensuite si besoin.
          </div>
        </div>
        <div id="depositError" class="small-hint" style="color:#b91c1c;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" id="depositCancelBtn">Annuler</button>
        <button class="btn btn-primary" id="depositCreateBtn">Générer le lien</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';

    let currentReservationForDeposit = null;
    let allReservationsWithDeposits = [];
function formatDateFr(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  if (Number.isNaN(d.getTime())) {
    // si jamais ce n'est pas une date valide, on renvoie la valeur brute
    return dateStr;
  }
  return d.toLocaleDateString('fr-FR', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric'
  });
}

    function getDefaultDepositAmount(propertyId) {
      if (!propertyId) return null;
      try {
        const raw = localStorage.getItem('lcc_deposit_defaults') || '{}';
        const parsed = JSON.parse(raw);
        const v = parsed[propertyId];
        if (typeof v === 'number') return v;
        if (typeof v === 'string' && v.trim() !== '') return parseFloat(v);
        return null;
      } catch (e) {
        console.warn('Impossible de lire les montants de caution par défaut', e);
        return null;
      }
    }

    function openDepositModal(reservation) {
      currentReservationForDeposit = reservation;

      const amountInput = document.getElementById('depositAmount');
      const errorEl = document.getElementById('depositError');

      if (amountInput) {
        const defaultAmount = getDefaultDepositAmount(reservation.propertyId);
        amountInput.value = defaultAmount && !isNaN(defaultAmount) ? defaultAmount : '';
      }

      if (errorEl) {
        errorEl.textContent = '';
      }

      document.getElementById('depositModalReservationLabel').textContent =
  `${reservation.propertyName || 'Logement'} – ${formatDateFr(reservation.startDate)} → ${formatDateFr(reservation.endDate)}`;
      document.getElementById('depositModal').classList.add('active');
    }

    function closeDepositModal() {
      document.getElementById('depositModal').classList.remove('active');
      currentReservationForDeposit = null;
    }

    function copyText(encoded) {
      const text = decodeURIComponent(encoded);
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(() => alert('Lien copié dans le presse-papiers.'))
          .catch(() => alert('Impossible de copier automatiquement, copiez-le manuellement.'));
      } else {
        alert('Votre navigateur ne supporte pas la copie automatique, copiez le lien manuellement.');
      }
    }
function buildDepositMessage(reservation, checkoutUrl) {
  const startFr = formatDateFr(reservation.startDate);
  const endFr = formatDateFr(reservation.endDate);

  return `
Bonjour ${reservation.guestName || ''},

Votre séjour au logement "${reservation.propertyName || 'le logement'}"
du ${startFr} au ${endFr} nécessite une caution.
Voici le lien sécurisé pour procéder au paiement :

${checkoutUrl}

Merci, et à très bientôt !
  `.trim();
}

async function copyExistingDepositMessage(reservation) {
  if (!reservation || !reservation.deposit || !reservation.deposit.checkoutUrl) {
    alert('Aucun lien de caution disponible pour ce séjour.');
    return;
  }

  const message = buildDepositMessage(reservation, reservation.deposit.checkoutUrl);

  if (navigator.clipboard && navigator.clipboard.writeText) {
    try {
      await navigator.clipboard.writeText(message);
      alert("Message de caution copié ! Vous pouvez le coller dans Airbnb, Booking, email…");
    } catch (e) {
      alert("Impossible de copier automatiquement, copiez le message manuellement :\n\n" + message);
    }
  } else {
    alert("Votre navigateur ne supporte pas la copie automatique. Voici le message :\n\n" + message);
  }
}

    async function loadPropertiesForFilter() {
      const select = document.getElementById('propertyFilter');
      if (!select) return;

      try {
        const res = await fetch(API_BASE + '/properties', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('lcc_token')
          }
        });
        if (!res.ok) throw new Error('Erreur API propriétés');
        const data = await res.json(); // { properties: [...] }

        (data.properties || []).forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.name;
          select.appendChild(opt);
        });

        select.addEventListener('change', renderDepositsTable);
      } catch (e) {
        console.error('Erreur chargement propriétés:', e);
      }
    }

    async function loadReservationsWithDeposits() {
      const container = document.getElementById('depositsContainer');
      container.innerHTML = '<p class="empty-state">Chargement des réservations…</p>';

      try {
        const res = await fetch(API_BASE + '/reservations-with-deposits', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('lcc_token')
          }
        });
        if (!res.ok) throw new Error('Erreur API');
        const data = await res.json();
        allReservationsWithDeposits = Array.isArray(data) ? data : [];
        renderDepositsTable();
      } catch (e) {
        console.error(e);
        container.innerHTML = '<p class="empty-state">Impossible de charger les réservations.</p>';
      }
    }

    function normalizeSourceToKey(raw) {
      if (!raw) return 'direct';
      const v = String(raw).toLowerCase();
      if (v.includes('airbnb')) return 'airbnb';
      if (v.includes('booking')) return 'booking';
      if (v.includes('vrbo') || v.includes('abritel') || v.includes('homeaway')) return 'vrbo';
      if (v.includes('expedia')) return 'expedia';
      if (v.includes('block') || v.includes('blocage') || v.includes('indispo')) return 'block';
      return 'direct';
    }

    function renderDepositsTable() {
      const container = document.getElementById('depositsContainer');
      const select = document.getElementById('propertyFilter');
      const selectedPropertyId = select ? select.value : '';

      // Filtrer par logement
      const filtered = allReservationsWithDeposits.filter((r) =>
        !selectedPropertyId || r.propertyId === selectedPropertyId
      );

      // Regrouper par séjour (1 ligne par réservation, pas par nuit)
      const byReservation = new Map();

      filtered.forEach((r) => {
        const key =
          r.reservationUid ||
          (r.propertyId || '') + '|' + (r.startDate || '') + '|' + (r.endDate || '') + '|' + (r.guestName || '');

        if (!byReservation.has(key)) {
          // On clone l'objet pour pouvoir l'enrichir
          byReservation.set(key, { ...r });
        } else {
          const existing = byReservation.get(key);

          // On agrège les dates au cas où
          if (r.startDate && (!existing.startDate || r.startDate < existing.startDate)) {
            existing.startDate = r.startDate;
          }
          if (r.endDate && (!existing.endDate || r.endDate > existing.endDate)) {
            existing.endDate = r.endDate;
          }

          // Si une des lignes a déjà une caution, on la garde
          if (!existing.deposit && r.deposit) {
            existing.deposit = r.deposit;
          }
        }
      });

      const data = Array.from(byReservation.values()).sort((a, b) => {
        if (!a.startDate || !b.startDate) return 0;
        if (a.startDate < b.startDate) return -1;
        if (a.startDate > b.startDate) return 1;
        return 0;
      });

      if (!data.length) {
        container.innerHTML = '<p class="empty-state">Aucune réservation pour ce filtre.</p>';
        return;
      }

      let html = `
        <table>
          <thead>
            <tr>
              <th>Logement</th>
              <th>Dates</th>
              <th>Voyageur</th>
              <th>Source</th>
              <th>Caution</th>
              <th>Statut</th>
              <th>Lien</th>
              <th>Actions</th>
            </tr>
</thead>
          <tbody>
      `;

      data.forEach((r) => {
        const d = r.deposit || null;
        let amountText = '<span class="badge badge-empty">Aucune</span>';
        let statusBadge = '<span class="badge badge-empty">Aucune</span>';
        let linkHtml = '';

        if (d) {
          if (d.amountCents) {
            amountText = (d.amountCents / 100).toFixed(2).replace('.', ',') + ' €';
          }
          if (d.status === 'pending') {
            statusBadge = '<span class="badge badge-pending">En attente de paiement</span>';
          } else if (d.status === 'paid') {
            statusBadge = '<span class="badge badge-paid">Payée</span>';
          } else if (d.status === 'refunded') {
            statusBadge = '<span class="badge badge-refunded">Remboursée</span>';
          } else {
            statusBadge = `<span class="badge badge-empty">${d.status}</span>`;
          }

          if (d.checkoutUrl) {
            const encodedUrl = encodeURIComponent(d.checkoutUrl);
            linkHtml = `
              <div class="link-cell">
                ${d.checkoutUrl}
                <button class="btn btn-ghost btn-xs" onclick="copyText('${encodedUrl}')">
                  Copier
                </button>
              </div>
            `;
          }
        }

        // Détection de la plateforme (Airbnb / Booking / etc.)
        const rawSource = r.source || r.sourceRaw || r.channel || '';
        const sourceKey = normalizeSourceToKey(rawSource);
        const isAirbnb = sourceKey === 'airbnb';
        const isBooking = sourceKey === 'booking';

        let sourceLabel = '-';
        if (sourceKey === 'airbnb') sourceLabel = 'Airbnb';
        else if (sourceKey === 'booking') sourceLabel = 'Booking.com';
        else if (sourceKey === 'direct') sourceLabel = 'Direct';
        else if (sourceKey === 'vrbo') sourceLabel = 'Vrbo';
        else if (sourceKey === 'expedia') sourceLabel = 'Expedia';
        else if (sourceKey === 'block') sourceLabel = 'Blocage';
        else if (rawSource) sourceLabel = rawSource;

        const safeJson = JSON.stringify(r).replace(/'/g, "&apos;");

        let actionsHtml = '';

        if (isAirbnb) {
  actionsHtml = '<span class="small-hint text-secondary">Caution gérée par Airbnb</span>';
} else if (d && d.status === 'pending' && d.checkoutUrl) {
  actionsHtml = `
    <div class="actions-stack">
      <button class="btn btn-ghost btn-xs" onclick='copyExistingDepositMessage(${safeJson})'>
        Copier le message
      </button>
      <span class="small-hint text-secondary">Lien déjà créé pour ce séjour</span>
    </div>
  `;
} else if (!d) {
  actionsHtml = `
    <button class="btn btn-primary btn-xs" onclick='openDepositModal(${safeJson})'>
      Créer un lien
    </button>
  `;
} else {
  actionsHtml = '<span class="small-hint text-secondary">Caution déjà gérée pour ce séjour</span>';
}


        html += `
          <tr>
            <td>${r.propertyName || 'Logement'}</td>
            <td>${formatDateFr(r.startDate)} → ${formatDateFr(r.endDate)}</td>
            <td>${r.guestName || '-'}</td>
            <td>${sourceLabel}</td>
            <td>${amountText}</td>
            <td>${statusBadge}</td>
            <td>${linkHtml || '-'}</td>
            <td>${actionsHtml}</td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    async function createDeposit() {
      const errorEl = document.getElementById('depositError');
      errorEl.textContent = '';
      if (!currentReservationForDeposit) return;

      const amountInput = document.getElementById('depositAmount');
      const amountValue = parseFloat(amountInput.value);
      if (!amountValue || amountValue <= 0) {
        errorEl.textContent = 'Merci de saisir un montant valide.';
        return;
      }

      // On mémorise ce montant comme valeur par défaut pour ce logement
      try {
        const defaultsRaw = localStorage.getItem('lcc_deposit_defaults') || '{}';
        const defaults = JSON.parse(defaultsRaw);
        if (currentReservationForDeposit.propertyId) {
          defaults[currentReservationForDeposit.propertyId] = amountValue;
          localStorage.setItem('lcc_deposit_defaults', JSON.stringify(defaults));
        }
      } catch (e) {
        console.warn('Impossible de sauvegarder le montant par défaut de caution', e);
      }

      try {
        const res = await fetch(API_BASE + '/deposits', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('lcc_token')
          },
          body: JSON.stringify({
            reservationUid: currentReservationForDeposit.reservationUid,
            amount: amountValue
          })
        });

        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.error || 'Erreur lors de la création de la caution');
        }

        closeDepositModal();
        await loadReservationsWithDeposits();

        if (data.checkoutUrl) {
          const startFr = formatDateFr(r.startDate);
const endFr = formatDateFr(r.endDate);

const message = `
Bonjour ${r.guestName || ''},

Votre séjour au logement "${r.propertyName || 'le logement'}"
du ${startFr} au ${endFr} nécessite une caution.
Voici le lien sécurisé pour procéder au paiement :

${data.checkoutUrl}

Merci, et à très bientôt !
          `.trim();


          try {
            await navigator.clipboard.writeText(message);
            alert("Message prêt à envoyer ! Il a été copié dans votre presse-papiers. Vous pouvez le coller dans Airbnb, Booking, email…");
          } catch {
            alert("Lien généré. Impossible de copier automatiquement, mais vous pouvez le copier depuis le tableau.");
          }
        }
      } catch (e) {
        console.error(e);
        errorEl.textContent = e.message || 'Erreur lors de la création de la caution.';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const refreshBtn = document.getElementById('refreshBtn');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', loadReservationsWithDeposits);
      }

      document.getElementById('depositModalClose').addEventListener('click', closeDepositModal);
      document.getElementById('depositCancelBtn').addEventListener('click', closeDepositModal);
      document.getElementById('depositCreateBtn').addEventListener('click', createDeposit);

      loadReservationsWithDeposits();
      loadPropertiesForFilter();
    });
  </script>

  <!-- MOBILE MENU SCRIPT -->
  <script>
    (function() {
      const menuBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      
      if (menuBtn && sidebar && overlay) {
        menuBtn.addEventListener('click', function() {
          sidebar.classList.toggle('active');
          overlay.classList.toggle('active');
          
          const icon = menuBtn.querySelector('i');
          if (sidebar.classList.contains('active')) {
            icon.classList.remove('fa-bars');
            icon.classList.add('fa-times');
          } else {
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
          }
        });
        
        overlay.addEventListener('click', function() {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          const icon = menuBtn.querySelector('i');
          icon.classList.remove('fa-times');
          icon.classList.add('fa-bars');
        });
        
        if (window.innerWidth <= 1024) {
          document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
              sidebar.classList.remove('active');
              overlay.classList.remove('active');
              const icon = menuBtn.querySelector('i');
              icon.classList.remove('fa-times');
              icon.classList.add('fa-bars');
            });
          });
        }
      }
    })();
    
    (function() {
      const currentPage = document.body.getAttribute('data-page');
      if (currentPage) {
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.remove('active');
        });
        const activeLink = document.querySelector('.nav-item[data-page="deposits"]');
        if (activeLink) {
          activeLink.classList.add('active');
        }
      }
    })();
    
    document.getElementById('logoutBtn')?.addEventListener('click', function() {
      localStorage.removeItem('lcc_token');
      localStorage.removeItem('lcc_user');
      window.location.href = '/login.html';
    });
    
    (function() {
      const user = JSON.parse(localStorage.getItem('lcc_user') || '{}');
      if (user.firstName) {
        const nameEl = document.getElementById('sidebarUserName');
        const avatarEl = document.getElementById('sidebarUserAvatar');
        if (nameEl) nameEl.textContent = user.firstName + ' ' + (user.lastName || '');
        if (avatarEl) avatarEl.textContent = user.firstName.charAt(0).toUpperCase();
      }
      if (user.company) {
        const companyEl = document.getElementById('sidebarUserCompany');
        if (companyEl) companyEl.textContent = user.company;
      }
    })();
  </script>
</body>
</html>
