<!DOCTYPE html>

<html data-theme="light" lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
<title>Boostinghost ‚Äì Cautions</title>
<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>
<!-- CSS plateforme -->
<link href="/css/style.css" rel="stylesheet"/><link href="/css/bh-shared.css?v=1" rel="stylesheet"/><link href="/css/bottom-bar-enhanced.css" rel="stylesheet"/><link href="/css/menu-plus-fixes.css" rel="stylesheet"/><link href="/css/menu-active-button.css" rel="stylesheet"/>
<link href="/css/deposits-cards-style.css" rel="stylesheet"/>
<link href="/css/messages-badge-fix.css" rel="stylesheet"/>   
<link rel="stylesheet" href="/css/messages-badge-red.css">
<link rel="stylesheet" href="/css/messages-badge-desktop.css">
<style>
    html, body {
      margin: 0 !important;
      }
    .app-container {
      margin-top: 0 !important;
    }
    /* (patched) removed inline .main-content padding override for iOS safe-area */
    .page-content {
      margin-top: 0 !important;
      max-width: 1100px;
    }
    html {
      scroll-behavior: smooth;
    }

    .card {
      background: var(--bg-primary);
      border-radius: 18px;
      padding: 16px 18px;
      box-shadow: var(--shadow-sm);
      margin-bottom: 20px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .card-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }
    .card-title i {
      font-size: 14px;
      color: var(--text-secondary);
    }
    .card-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border-color-subtle);
      text-align: left;
    }
    th {
      font-weight: 600;
      background: var(--bg-secondary);
    }
    tr:last-child td {
      border-bottom: none;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
    }
    .badge-empty {
      background: var(--bg-secondary);
      color: var(--text-secondary);
    }
    .badge-pending {
      background: rgba(234, 179, 8, .12);
      color: #92400e;
    }
    .badge-paid {
      background: rgba(22, 163, 74, .12);
      color: #166534;
    }
    .badge-refunded {
      background: rgba(37, 99, 235, .12);
      color: #1d4ed8;
    }

    .btn-xs {
      padding: 4px 8px;
      font-size: 11px;
    }

    .empty-state {
      padding: 12px 0;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .link-cell {
      max-width: 260px;
      word-break: break-all;
      font-size: 11px;
      color: var(--text-secondary);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: var(--bg-primary);
      border-radius: 18px;
      max-width: 420px;
      width: 90%;
      box-shadow: var(--shadow-xl);
      overflow: hidden;
    }
    .modal-header {
      padding: 14px 18px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h2 {
      font-size: 16px;
      margin: 0;
    }
    .modal-body {
      padding: 16px 18px 18px;
    }
    .modal-footer {
      padding: 10px 18px 14px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .modal-close {
      border: none;
      background: transparent;
      cursor: pointer;
      color: var(--text-secondary);
    }
    .form-row {
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }
    .form-row label {
      font-weight: 500;
    }
    .form-row input,
    .form-row select {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border-color-subtle);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 13px;
    }
    .small-hint {
      font-size: 11px;
      color: var(--text-secondary);
    }
.actions-stack {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 4px;
}

    .text-secondary {
      color: var(--text-secondary);
    }

    /* ========== CARTES EXPANDABLES ========== */
    .deposit-card.expandable {
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .deposit-card.expandable:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    .expand-icon {
      font-size: 12px;
      color: var(--text-secondary);
      transition: transform 0.3s ease;
    }

    .deposit-card.expanded .expand-icon {
      transform: rotate(180deg);
    }

    .deposit-details {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        max-height: 0;
      }
      to {
        opacity: 1;
        max-height: 500px;
      }
    }

    .details-section {
      margin-bottom: 16px;
    }

    .details-section h4 {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--text-primary);
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 12px;
      border-bottom: 1px solid var(--border-color-subtle);
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      color: var(--text-secondary);
      font-weight: 500;
    }

    .detail-value {
      color: var(--text-primary);
      font-weight: 600;
    }

    .details-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .details-actions h4 {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .btn-warning {
      background: #f59e0b;
      color: white;
    }

    .btn-warning:hover {
      background: #d97706;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-sm {
      padding: 8px 12px;
      font-size: 13px;
    }

    /* ========== HEADER DASHBOARD MODERNE (comme app.html) ========== */

    .main-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      padding: 18px 20px;
      margin-bottom: 20px;
      border-radius: 20px;
      background: linear-gradient(
        135deg,
        rgba(15, 23, 42, 0.98),
        rgba(15, 23, 42, 0.92)
      );
      border: 1px solid rgba(148, 163, 184, 0.45);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.7);
    }

    [data-theme="light"] .main-header {
      background: linear-gradient(135deg, #f9fafb, #eff6ff);
      border-color: rgba(148, 163, 184, 0.4);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.06);
    }

    .header-left {
      max-width: 60%;
    }

    .page-kicker {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: #9ca3af;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .page-title {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    .page-subtitle {
      margin-top: 6px;
      font-size: 13px;
      color: #9ca3af;
    }

    [data-theme="light"] .page-subtitle {
      color: #6b7280;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-ghost {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: transparent;
      padding-inline: 14px;
    }

    .btn-ghost:hover {
      background: rgba(15, 23, 42, 0.06);
    }

    [data-theme="dark"] .btn-ghost:hover {
      background: rgba(15, 23, 42, 0.9);
    }

    .hide-on-mobile {
      display: inline-flex;
    }

    @media (max-width: 768px) {
      .main-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-left {
        max-width: 100%;
      }
      .hide-on-mobile {
        display: none;
      }
    }
  </style>
<!-- Script auth + user + logout -->
<script>
    (async function checkSubscriptionAccess() {
    const token = localStorage.getItem('lcc_token');
    
    if (!token) {
      window.location.href = '/login.html';
      return;
    }

    try {
      const res = await fetch('/api/subscription/status', {
        headers: { 'Authorization': 'Bearer ' + token }
      });

      if (!res.ok) {
        if (res.status === 401 || res.status === 403) {
          localStorage.removeItem('lcc_token');
          localStorage.removeItem('lcc_user');
          window.location.href = '/login.html';
        }
        return;
      }

      const data = await res.json();

      if (data.status === 'expired' || data.status === 'canceled') {
        window.location.href = '/subscription-expired.html';
        return;
      }

      if (data.status === 'trial' && data.daysRemaining !== null && data.daysRemaining < 0) {
        window.location.href = '/subscription-expired.html';
        return;
      }

    } catch (err) {
      console.error('Erreur v√©rification abonnement:', err);
    }
  })();
    (function () {
      const token = localStorage.getItem('lcc_token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      const rawUser = localStorage.getItem('lcc_user');
      let user = null;

      try {
        user = rawUser ? JSON.parse(rawUser) : null;
      } catch (e) {
        console.error('Impossible de lire lcc_user', e);
      }

      window.addEventListener('DOMContentLoaded', () => {
        if (user) {
          const nameEl = document.getElementById('sidebarUserName');
          const companyEl = document.getElementById('sidebarUserCompany');
          const avatarEl = document.getElementById('sidebarUserAvatar');

          if (nameEl) {
            nameEl.textContent = user.firstName
              ? user.firstName + (user.lastName ? ' ' + user.lastName : '')
              : (user.email || 'Mon compte');
          }

          if (companyEl) {
            companyEl.textContent = user.company || 'Mon espace';
          }

          if (avatarEl) {
            const initial = (user.firstName || user.email || '?').trim()[0] || 'U';
            avatarEl.textContent = initial.toUpperCase();
          }
        }

        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', function () {
            localStorage.removeItem('lcc_token');
            localStorage.removeItem('lcc_user');
            window.location.href = '/login.html';
          });
        }
      });
    })();
  </script>
<script src="/js/auth-fetch.js"></script>
<link rel="stylesheet" href="/css/mobile-native-styles.css">
</head>
<body data-back-href="/app.html" data-back-label="Retour au dashboard" data-kicker="Gestion" data-page="deposits" data-subtitle="Suivez et g√©rez les d√©p√¥ts de garantie." data-title="Cautions">
<!-- MOBILE HEADER -->
<div class="mobile-header">
<a class="mobile-logo" href="/app.html">
<i class="fas fa-calendar-check"></i>
<span class="mobile-logo-text">Bookingmanage</span>
</a>
<button class="mobile-menu-btn" id="mobileMenuBtn">
<i class="fas fa-bars"></i>
</button>
</div>
<div class="sidebar-overlay" id="sidebarOverlay"></div>
<div class="app-container">
<!-- Sidebar -->
<div id="bhSidebar"></div>
<!-- MAIN -->
<main class="main-content"><div id="bhHeader"></div>

<div class="page-content">
<section class="card">
<div class="card-header">
<div class="card-title">
<i class="fas fa-list"></i>
<span>R√©servations &amp; cautions</span>
</div>
<button class="btn btn-ghost btn-xs" id="refreshBtn">
<i class="fas fa-sync-alt"></i>
              Actualiser
            </button>
</div>
<p class="card-subtitle">
            Pour chaque r√©servation, vous pouvez cr√©er un lien Stripe de caution avec un montant libre.
          </p>
<div class="form-row" style="margin-bottom: 10px; display:flex; align-items:center; gap:8px;">
<label for="propertyFilter" style="font-size:13px; font-weight:500;">Logement :</label>
<select id="propertyFilter">
<option value="">Tous les logements</option>
</select>
</div>
<div style="overflow-x: auto; -webkit-overflow-scrolling: touch; width: 100%;">
<div id="depositsContainer">
<p class="empty-state">Chargement des r√©servations‚Ä¶</p>
</div>
</div>
</section>
</div>
</main>
</div>
<!-- MODAL: nouvelle caution -->
<div class="modal" id="depositModal">
<div class="modal-content">
<div class="modal-header">
<h2>Nouvelle caution</h2>
<button class="modal-close" id="depositModalClose">
<i class="fas fa-times"></i>
</button>
</div>
<div class="modal-body">
<div class="form-row">
<label>R√©servation</label>
<div class="small-hint" id="depositModalReservationLabel"></div>
</div>
<div class="form-row">
<label for="depositAmount">Montant de la caution (‚Ç¨)</label>
<input id="depositAmount" min="1" required="" step="1" type="number"/>
<div class="small-hint">
            Le montant sera encaiss√© via Stripe. Vous pourrez rembourser ensuite si besoin.
          </div>
</div>
<div class="small-hint" id="depositError" style="color:#b91c1c;"></div>
</div>
<div class="modal-footer">
<button class="btn btn-ghost" id="depositCancelBtn">Annuler</button>
<button class="btn btn-primary" id="depositCreateBtn">G√©n√©rer le lien</button>
</div>
</div>
</div>
<script>
    const API_BASE = '/api';

    let currentReservationForDeposit = null;
    let allReservationsWithDeposits = [];
function formatDateFr(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  if (Number.isNaN(d.getTime())) {
    // si jamais ce n'est pas une date valide, on renvoie la valeur brute
    return dateStr;
  }
  return d.toLocaleDateString('fr-FR', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric'
  });
}

    function getDefaultDepositAmount(propertyId) {
      if (!propertyId) return null;
      try {
        const raw = localStorage.getItem('lcc_deposit_defaults') || '{}';
        const parsed = JSON.parse(raw);
        const v = parsed[propertyId];
        if (typeof v === 'number') return v;
        if (typeof v === 'string' && v.trim() !== '') return parseFloat(v);
        return null;
      } catch (e) {
        console.warn('Impossible de lire les montants de caution par d√©faut', e);
        return null;
      }
    }

    // ========== FONCTIONS EXPANSION CARTES ==========
    function toggleDetails(reservationUid, event) {
      if (!event) event = window.event;
      
      const details = document.getElementById(`details-${reservationUid}`);
      if (!details) return;
      
      // Trouver la carte parente
      const card = details.closest('.deposit-card');
      
      if (details.style.display === 'none' || details.style.display === '') {
        details.style.display = 'block';
        if (card) card.classList.add('expanded');
      } else {
        details.style.display = 'none';
        if (card) card.classList.remove('expanded');
      }
      
      if (event) event.stopPropagation();
    }

    // ========== ACTIONS CAUTIONS ==========
    async function captureDepositWithAmount(depositId, reservationUid, maxAmountCents) {
      const inputId = `capture-amount-${reservationUid}`;
      const input = document.getElementById(inputId);
      
      if (!input) {
        alert('Erreur : champ de montant introuvable');
        return;
      }
      
      const amountEuros = parseFloat(input.value);
      
      if (isNaN(amountEuros) || amountEuros <= 0) {
        alert('Merci de saisir un montant valide');
        return;
      }
      
      const amountCents = Math.round(amountEuros * 100);
      const maxAmount = maxAmountCents / 100;
      
      if (amountCents > maxAmountCents) {
        alert(`Le montant ne peut pas d√©passer ${maxAmount.toFixed(2)}‚Ç¨`);
        return;
      }
      
      if (!confirm(`D√©biter ${amountEuros.toFixed(2)}‚Ç¨ ?\n\nCette action est irr√©versible. L'argent sera transf√©r√© depuis la carte du client.`)) {
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/deposits/${depositId}/capture`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('lcc_token')
          },
          body: JSON.stringify({ amountCents })
        });

        const data = await res.json();
        
        if (!res.ok) {
          throw new Error(data.error || 'Erreur lors du d√©bit');
        }

        alert(`‚úÖ Caution d√©bit√©e avec succ√®s : ${amountEuros.toFixed(2)}‚Ç¨`);
        await loadReservationsWithDeposits();
      } catch (error) {
        console.error('Erreur capture:', error);
        alert('‚ùå Erreur: ' + error.message);
      }
    }

    async function captureDeposit(depositId, amountCents) {
      if (!confirm(`D√©biter la caution de ${(amountCents/100).toFixed(2)}‚Ç¨ ?\n\nCette action est irr√©versible. L'argent sera transf√©r√© depuis la carte du client.`)) {
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/deposits/${depositId}/capture`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('lcc_token')
          },
          body: JSON.stringify({ amountCents })
        });

        const data = await res.json();
        
        if (!res.ok) {
          throw new Error(data.error || 'Erreur lors du d√©bit');
        }

        alert('‚úÖ Caution d√©bit√©e avec succ√®s !');
        await loadReservationsWithDeposits();
      } catch (error) {
        console.error('Erreur capture:', error);
        alert('‚ùå Erreur: ' + error.message);
      }
    }

    async function releaseDeposit(depositId) {
      if (!confirm('Lib√©rer cette caution ?\n\nL\'autorisation sera annul√©e et aucun montant ne sera d√©bit√©.')) {
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/deposits/${depositId}/release`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('lcc_token')
          }
        });

        const data = await res.json();
        
        if (!res.ok) {
          throw new Error(data.error || 'Erreur lors de la lib√©ration');
        }

        alert('‚úÖ Caution lib√©r√©e avec succ√®s !');
        await loadReservationsWithDeposits();
      } catch (error) {
        console.error('Erreur release:', error);
        alert('‚ùå Erreur: ' + error.message);
      }
    }

    function openDepositModal(reservation) {
      currentReservationForDeposit = reservation;

      const amountInput = document.getElementById('depositAmount');
      const errorEl = document.getElementById('depositError');

      if (amountInput) {
        const defaultAmount = getDefaultDepositAmount(reservation.propertyId);
        amountInput.value = defaultAmount && !isNaN(defaultAmount) ? defaultAmount : '';
      }

      if (errorEl) {
        errorEl.textContent = '';
      }

      document.getElementById('depositModalReservationLabel').textContent =
  `${reservation.propertyName || 'Logement'} ‚Äì ${formatDateFr(reservation.startDate)} ‚Üí ${formatDateFr(reservation.endDate)}`;
      document.getElementById('depositModal').classList.add('active');
    }

    function closeDepositModal() {
      document.getElementById('depositModal').classList.remove('active');
      currentReservationForDeposit = null;
    }

    function copyText(encoded) {
      const text = decodeURIComponent(encoded);
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(() => alert('Lien copi√© dans le presse-papiers.'))
          .catch(() => alert('Impossible de copier automatiquement, copiez-le manuellement.'));
      } else {
        alert('Votre navigateur ne supporte pas la copie automatique, copiez le lien manuellement.');
      }
    }
    function openDepositModalByUid(uid) {
  const reservation = allReservationsWithDeposits.find(r => r.reservationUid === uid);
  if (!reservation) {
    alert('R√©servation introuvable');
    console.error('UID cherch√©:', uid);
    console.log('R√©servations disponibles:', allReservationsWithDeposits);
    return;
  }
  openDepositModal(reservation);
}
    
function buildDepositMessage(reservation, checkoutUrl) {
  const startFr = formatDateFr(reservation.startDate);
  const endFr = formatDateFr(reservation.endDate);

  return `
Bonjour ${reservation.guestName || ''},

Votre s√©jour au logement "${reservation.propertyName || 'le logement'}"
du ${startFr} au ${endFr} n√©cessite une caution.
Voici le lien s√©curis√© pour proc√©der au paiement :

${checkoutUrl}

Merci, et √† tr√®s bient√¥t !
  `.trim();
}

async function copyExistingDepositMessage(reservation) {
  if (!reservation || !reservation.deposit || !reservation.deposit.checkoutUrl) {
    alert('Aucun lien de caution disponible pour ce s√©jour.');
    return;
  }

  // ‚úÖ Copier uniquement le lien, pas le message complet
  const checkoutUrl = reservation.deposit.checkoutUrl;

  if (navigator.clipboard && navigator.clipboard.writeText) {
    try {
      await navigator.clipboard.writeText(checkoutUrl);
      alert("Lien de caution copi√©");
    } catch (e) {
      alert("Impossible de copier automatiquement, copiez le lien manuellement :\n\n" + checkoutUrl);
    }
  } else {
    alert("Votre navigateur ne supporte pas la copie automatique. Voici le lien :\n\n" + checkoutUrl);
  }
}
function copyDepositMessageByUid(uid) {
  // Retrouver la r√©servation dans le tableau
  const reservation = allReservationsWithDeposits.find(r => r.reservationUid === uid);
  if (!reservation) {
    alert('R√©servation introuvable');
    return;
  }
  // Appeler la fonction existante
  copyExistingDepositMessage(reservation);
}

// ‚úÖ NOUVELLE FONCTION pour copier le lien depuis les cartes
function copyDepositLinkByUid(uid) {
  const reservation = allReservationsWithDeposits.find(r => r.reservationUid === uid);
  if (!reservation) {
    alert('R√©servation introuvable');
    return;
  }
  copyExistingDepositMessage(reservation);
}
    async function loadPropertiesForFilter() {
      const select = document.getElementById('propertyFilter');
      if (!select) return;

      try {
        const res = await fetch(API_BASE + '/properties', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('lcc_token')
          }
        });
        if (!res.ok) throw new Error('Erreur API propri√©t√©s');
        const data = await res.json(); // { properties: [...] }

        (data.properties || []).forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.name;
          select.appendChild(opt);
        });

        select.addEventListener('change', renderDepositsTable);
      } catch (e) {
        console.error('Erreur chargement propri√©t√©s:', e);
      }
    }

    async function loadReservationsWithDeposits() {
      const container = document.getElementById('depositsContainer');
      container.innerHTML = '<p class="empty-state">Chargement des r√©servations‚Ä¶</p>';

      try {
        const res = await fetch(API_BASE + '/reservations-with-deposits', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('lcc_token')
          }
        });
        if (!res.ok) throw new Error('Erreur API');
        const data = await res.json();
        allReservationsWithDeposits = Array.isArray(data) ? data : [];
        console.log('‚úÖ R√©servations charg√©es:', allReservationsWithDeposits.length);
        console.log('üìä Premi√®re r√©servation:', allReservationsWithDeposits[0]);
        renderDepositsTable();
      } catch (e) {
        console.error(e);
        container.innerHTML = '<p class="empty-state">Impossible de charger les r√©servations.</p>';
      }
    }

    function normalizeSourceToKey(raw) {
      if (!raw) return 'direct';
      const v = String(raw).toLowerCase();
      if (v.includes('airbnb')) return 'airbnb';
      if (v.includes('booking')) return 'booking';
      if (v.includes('vrbo') || v.includes('abritel') || v.includes('homeaway')) return 'vrbo';
      if (v.includes('expedia')) return 'expedia';
      if (v.includes('block') || v.includes('blocage') || v.includes('indispo')) return 'block';
      return 'direct';
    }

    function renderDepositsTable() {
      const container = document.getElementById('depositsContainer');
      const select = document.getElementById('propertyFilter');
      const selectedPropertyId = select ? select.value : '';

      // Filtrer par logement
      const filtered = allReservationsWithDeposits.filter((r) =>
        !selectedPropertyId || r.propertyId === selectedPropertyId
      );

      // Regrouper par s√©jour (1 ligne par r√©servation, pas par nuit)
      const byReservation = new Map();

      filtered.forEach((r) => {
        const key =
          r.reservationUid ||
          (r.propertyId || '') + '|' + (r.startDate || '') + '|' + (r.endDate || '') + '|' + (r.guestName || '');

        if (!byReservation.has(key)) {
          // On clone l'objet pour pouvoir l'enrichir
          byReservation.set(key, { ...r });
        } else {
          const existing = byReservation.get(key);

          // On agr√®ge les dates au cas o√π
          if (r.startDate && (!existing.startDate || r.startDate < existing.startDate)) {
            existing.startDate = r.startDate;
          }
          if (r.endDate && (!existing.endDate || r.endDate > existing.endDate)) {
            existing.endDate = r.endDate;
          }

          // Si une des lignes a d√©j√† une caution, on la garde
          if (!existing.deposit && r.deposit) {
            existing.deposit = r.deposit;
          }
        }
      });

      const data = Array.from(byReservation.values()).sort((a, b) => {
        if (!a.startDate || !b.startDate) return 0;
        if (a.startDate < b.startDate) return -1;
        if (a.startDate > b.startDate) return 1;
        return 0;
      });

      if (!data.length) {
        container.innerHTML = '<p class="empty-state">Aucune r√©servation pour ce filtre.</p>';
        return;
      }

      // ============================================
      // üé¥ MODE CARTES (remplace le tableau)
      // ============================================

      let html = '<div class="deposits-cards-grid">';

      data.forEach((r) => {
        // üîç DEBUG: Voir la structure des donn√©es
        console.log('üé¥ Carte pour ' + r.propertyName + ':', {
          reservationUid: r.reservationUid,
          hasDeposit: !!r.deposit,
          depositStatus: r.deposit?.status,
          hasCheckoutUrl: !!r.deposit?.checkoutUrl,
          checkoutUrl: r.deposit?.checkoutUrl,
          fullDeposit: r.deposit
        });
        const d = r.deposit || null;
        let amountBadge = '<span class="badge badge-empty">Aucune</span>';
        let statusBadge = '<span class="badge badge-empty">Aucune</span>';
        
        if (d) {
          if (d.amountCents) {
            amountBadge = '<span class="badge badge-amount">' + (d.amountCents / 100).toFixed(2).replace('.', ',') + ' ‚Ç¨</span>';
          }
          if (d.status === 'pending') {
            statusBadge = '<span class="badge badge-pending">En attente</span>';
          } else if (d.status === 'paid') {
            statusBadge = '<span class="badge badge-paid">Pay√©e</span>';
          } else if (d.status === 'refunded') {
            statusBadge = '<span class="badge badge-refunded">Rembours√©e</span>';
          } else if (d.status) {
            statusBadge = `<span class="badge badge-empty">${d.status}</span>`;
          }
        }

        // D√©tection de la plateforme (Airbnb / Booking / etc.)
        const rawSource = r.source || r.sourceRaw || r.channel || '';
        const sourceKey = normalizeSourceToKey(rawSource);
        const isAirbnb = sourceKey === 'airbnb';
          
        // Actions principales
        let actionsHtml = '';
        
        if (isAirbnb) {
          actionsHtml = '<div class="card-hint">Caution g√©r√©e par Airbnb</div>';
        } else if (d && d.checkoutUrl) {
          actionsHtml = `
            <button class="btn btn-primary btn-card" onclick="copyDepositLinkByUid('${r.reservationUid}')">
              <i class="fas fa-copy"></i> Copier le lien
            </button>
          `;
        } else if (!d) {
          actionsHtml = `
            <button class="btn btn-primary btn-card" onclick="openDepositModalByUid('${r.reservationUid}')">
              <i class="fas fa-link"></i> Cr√©er un lien
            </button>
          `;
        } else {
          actionsHtml = '<div class="card-hint">Caution d√©j√† g√©r√©e</div>';
        }

        // Actions avanc√©es (capture/release)
        let advancedActionsHtml = '';
        if (d && d.status === 'paid') {
          const maxAmount = (d.amountCents / 100).toFixed(2);
          advancedActionsHtml = `
            <div class="deposit-details" id="details-${r.reservationUid}" style="display: none;">
              <div class="details-section">
                <h4>üìã Informations</h4>
                <div class="detail-row">
                  <span class="detail-label">ID Caution</span>
                  <span class="detail-value">${d.id}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Montant autoris√©</span>
                  <span class="detail-value">${maxAmount} ‚Ç¨</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Cr√©√©e le</span>
                  <span class="detail-value">${new Date(d.createdAt || Date.now()).toLocaleString('fr-FR')}</span>
                </div>
              </div>
              
              <div class="details-actions">
                <h4>‚ö° Actions</h4>
                
                <div style="margin-bottom: 12px;">
                  <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">
                    üí∞ Montant √† d√©biter (‚Ç¨)
                  </label>
                  <input 
                    type="number" 
                    id="capture-amount-${r.reservationUid}" 
                    value="${maxAmount}" 
                    max="${maxAmount}" 
                    min="0.01"
                    step="0.01"
                    style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 14px;"
                    placeholder="Montant √† d√©biter"
                  />
                  <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                    Maximum : ${maxAmount} ‚Ç¨
                  </div>
                </div>
                
                <button class="btn btn-warning btn-sm" onclick="captureDepositWithAmount('${d.id}', '${r.reservationUid}', ${d.amountCents})">
                  <i class="fas fa-credit-card"></i> D√©biter la caution
                </button>
                <button class="btn btn-success btn-sm" onclick="releaseDeposit('${d.id}')">
                  <i class="fas fa-check-circle"></i> Lib√©rer (tout ok)
                </button>
                <a href="https://dashboard.stripe.com/test/payments" target="_blank" class="btn btn-ghost btn-sm">
                  <i class="fas fa-external-link-alt"></i> Voir dans Stripe
                </a>
              </div>
            </div>
          `;
        }

        // Ic√¥ne d'expansion si d√©tails disponibles
        const expandIcon = (d && d.status === 'paid') ? '<i class="fas fa-chevron-down expand-icon"></i>' : '';

        // G√©n√©rer la carte
        const cardClass = (d && d.status === 'paid') ? 'deposit-card expandable' : 'deposit-card';
        const cardClick = (d && d.status === 'paid') ? `onclick="toggleDetails('${r.reservationUid}', event)"` : '';
        
        html += `
          <div class="${cardClass}" ${cardClick}>
            <div class="deposit-card-header">
              <h3 class="deposit-card-title">${r.propertyName || 'Logement'}</h3>
              ${expandIcon}
            </div>
            
            <div class="deposit-card-body">
              <div class="deposit-info-row">
                <i class="fas fa-calendar"></i>
                <span>${formatDateFr(r.startDate)} ‚Üí ${formatDateFr(r.endDate)}</span>
              </div>
              
              <div class="deposit-info-grid-simple">
                <div class="deposit-info-item">
                  <div class="deposit-info-label">Caution</div>
                  <div class="deposit-info-value">${amountBadge}</div>
                </div>
                
                <div class="deposit-info-item">
                  <div class="deposit-info-label">Statut</div>
                  <div class="deposit-info-value">${statusBadge}</div>
                </div>
              </div>
            </div>
            
            ${advancedActionsHtml}
            
            <div class="deposit-card-footer">
              ${actionsHtml}
            </div>
          </div>
        `;
      });

      html += '</div>';
      container.innerHTML = html;
    }

    // ============================================
// CORRECTION FINALE : fonction createDeposit
// Remplacer TOUTE la fonction (lignes 779-842)
// ============================================

async function createDeposit() {
  const errorEl = document.getElementById('depositError');
  errorEl.textContent = '';
  if (!currentReservationForDeposit) return;

  const amountInput = document.getElementById('depositAmount');
  const amountValue = parseFloat(amountInput.value);
  if (!amountValue || amountValue <= 0) {
    errorEl.textContent = 'Merci de saisir un montant valide.';
    return;
  }

  // ‚úÖ SAUVEGARDER la r√©servation dans une variable locale
  const reservation = currentReservationForDeposit;

  // On m√©morise ce montant comme valeur par d√©faut pour ce logement
  try {
    const defaultsRaw = localStorage.getItem('lcc_deposit_defaults') || '{}';
    const defaults = JSON.parse(defaultsRaw);
    if (reservation.propertyId) {
      defaults[reservation.propertyId] = amountValue;
      localStorage.setItem('lcc_deposit_defaults', JSON.stringify(defaults));
    }
  } catch (e) {
    console.warn('Impossible de sauvegarder le montant par d√©faut de caution', e);
  }

  try {
    const res = await fetch(API_BASE + '/deposits', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + localStorage.getItem('lcc_token')
      },
      body: JSON.stringify({
        reservationUid: reservation.reservationUid,
        amount: amountValue
      })
    });

    const data = await res.json();
    if (!res.ok) {
      throw new Error(data.error || 'Erreur lors de la cr√©ation de la caution');
    }

    // üîç DEBUG: Voir ce que le serveur retourne
    console.log('‚úÖ Caution cr√©√©e, r√©ponse serveur:', data);

    // ‚úÖ Fermer la modale AVANT de recharger
    closeDepositModal();
    
    // ‚úÖ Petit d√©lai pour laisser le serveur enregistrer
    await new Promise(resolve => setTimeout(resolve, 300));
    
    // ‚úÖ Recharger ET r√©afficher les donn√©es
    await loadReservationsWithDeposits();

    // ‚úÖ Message simple de succ√®s
    alert("Lien cr√©√© avec succ√®s !");
  } catch (e) {
    console.error(e);
    errorEl.textContent = e.message || 'Erreur lors de la cr√©ation de la caution.';
  }
}


    document.addEventListener('DOMContentLoaded', () => {
      const refreshBtn = document.getElementById('refreshBtn');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', loadReservationsWithDeposits);
      }

      document.getElementById('depositModalClose').addEventListener('click', closeDepositModal);
      document.getElementById('depositCancelBtn').addEventListener('click', closeDepositModal);
      document.getElementById('depositCreateBtn').addEventListener('click', createDeposit);

      loadReservationsWithDeposits();
      loadPropertiesForFilter();
    });
  </script>
<!-- MOBILE MENU SCRIPT -->
<script>
    (function() {
      const menuBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      
      if (menuBtn && sidebar && overlay) {
        menuBtn.addEventListener('click', function() {
          sidebar.classList.toggle('active');
          overlay.classList.toggle('active');
          
          const icon = menuBtn.querySelector('i');
          if (sidebar.classList.contains('active')) {
            icon.classList.remove('fa-bars');
            icon.classList.add('fa-times');
          } else {
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
          }
        });
        
        overlay.addEventListener('click', function() {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          const icon = menuBtn.querySelector('i');
          icon.classList.remove('fa-times');
          icon.classList.add('fa-bars');
        });
        
        if (window.innerWidth <= 1024) {
          document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
              sidebar.classList.remove('active');
              overlay.classList.remove('active');
              const icon = menuBtn.querySelector('i');
              icon.classList.remove('fa-times');
              icon.classList.add('fa-bars');
            });
          });
        }
      }
    })();
    
    (function() {
      const currentPage = document.body.getAttribute('data-page');
      if (currentPage) {
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.remove('active');
        });
        const activeLink = document.querySelector('.nav-item[data-page="deposits"]');
        if (activeLink) {
          activeLink.classList.add('active');
        }
      }
    })();
    
    document.getElementById('logoutBtn')?.addEventListener('click', function() {
      localStorage.removeItem('lcc_token');
      localStorage.removeItem('lcc_user');
      window.location.href = '/login.html';
    });
    
    (function() {
      const user = JSON.parse(localStorage.getItem('lcc_user') || '{}');
      if (user.firstName) {
        const nameEl = document.getElementById('sidebarUserName');
        const avatarEl = document.getElementById('sidebarUserAvatar');
        if (nameEl) nameEl.textContent = user.firstName + ' ' + (user.lastName || '');
        if (avatarEl) avatarEl.textContent = user.firstName.charAt(0).toUpperCase();
      }
      if (user.company) {
        const companyEl = document.getElementById('sidebarUserCompany');
        if (companyEl) companyEl.textContent = user.company;
      }
    })();
  </script>
<script src="/js/bh-layout.js"></script>
<script src="/js/mobile-native-experience.js"></script>
<script src="/js/mobile-tabs-handler.js"></script>

<!-- FORCE LE SCROLL HORIZONTAL AVEC JAVASCRIPT -->
<script>
(function forceHorizontalScroll() {
  console.log('üîß For√ßage du scroll horizontal...');
  
  function applyScrollFix() {
    // Supprimer overflow-x: hidden de PARTOUT
    const elementsToFix = [
      document.documentElement,
      document.body,
      document.querySelector('.app-container'),
      document.querySelector('.main-content'),
      document.querySelector('.page-content'),
      document.querySelector('#depositsContainer')?.parentElement
    ];
    
    elementsToFix.forEach(el => {
      if (el) {
        el.style.overflowX = 'visible';
        console.log('‚úÖ overflow-x visible sur', el.tagName);
      }
    });
    
    // Wrapper scrollable
    const wrapper = document.querySelector('#depositsContainer')?.parentElement;
    if (wrapper) {
      wrapper.style.overflowX = 'auto';
      wrapper.style.webkitOverflowScrolling = 'touch';
      wrapper.style.width = '100%';
      wrapper.style.display = 'block';
      console.log('‚úÖ Wrapper scrollable configur√©');
    }
    
    // Table
    const table = document.querySelector('#depositsContainer table');
    if (table) {
      table.style.minWidth = '900px';
      table.style.width = '900px';
      table.style.display = 'table';
      console.log('‚úÖ Table configur√©e avec width 900px');
      console.log('üìè Table clientWidth:', table.clientWidth);
      console.log('üìè Wrapper clientWidth:', wrapper?.clientWidth);
    }
  }
  
  // Appliquer imm√©diatement
  applyScrollFix();
  
  // R√©appliquer apr√®s chargement
  setTimeout(applyScrollFix, 500);
  setTimeout(applyScrollFix, 1500);
  
  // Observer les changements du DOM
  const observer = new MutationObserver(() => {
    applyScrollFix();
  });
  
  const container = document.querySelector('#depositsContainer');
  if (container) {
    observer.observe(container, { childList: true, subtree: true });
  }
  
  console.log('‚úÖ Force scroll activ√©');
})();
</script>
<script src="/js/messages-badge-desktop-mobile.js"></script>
<!-- Socket.io pour le temps r√©el -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>    
</body>
</html>
