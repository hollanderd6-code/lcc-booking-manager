<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Boostinghost – Factures</title>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <!-- CSS plateforme -->
  <link rel="stylesheet" href="/css/style.css">

  <style>
    html, body {
      margin: 0 !important;
      padding: 0 !important;
    }

    .main-content {
      padding-top: 24px !important;
    }

    .page-content {
      margin-top: 0 !important;
      max-width: 1200px;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
    }

    .stat-label {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .stat-value.currency::before {
      content: attr(data-currency);
      font-size: 20px;
      margin-right: 4px;
    }

    /* Filters */
    .filters-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-btn {
      padding: 8px 16px;
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .filter-btn:hover:not(.active) {
      border-color: var(--primary-color);
    }

    /* Invoice Table */
    .invoice-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--bg-primary);
      border-radius: 12px;
      overflow: hidden;
    }

    .invoice-table thead {
      background: var(--bg-secondary);
    }

    .invoice-table th {
      padding: 12px 16px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .invoice-table td {
      padding: 16px;
      border-top: 1px solid var(--border-color);
      font-size: 14px;
    }

    .invoice-table tbody tr {
      cursor: pointer;
      transition: background 0.15s;
    }

    .invoice-table tbody tr:hover {
      background: var(--bg-secondary);
    }

    /* Status Badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-badge.draft {
      background: rgba(234, 179, 8, 0.15);
      color: #854d0e;
    }

    .status-badge.issued {
      background: rgba(59, 130, 246, 0.15);
      color: #1e40af;
    }

    .status-badge.paid {
      background: rgba(34, 197, 94, 0.15);
      color: #166534;
    }

    .status-badge.overdue {
      background: rgba(239, 68, 68, 0.15);
      color: #991b1b;
    }

    .status-badge.cancelled {
      background: rgba(107, 114, 128, 0.15);
      color: #374151;
    }

    /* Actions */
    .actions-cell {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      padding: 6px 10px;
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .action-btn:hover {
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    .action-btn.danger:hover {
      border-color: #dc2626;
      color: #dc2626;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .invoice-table {
        font-size: 13px;
      }

      .invoice-table th,
      .invoice-table td {
        padding: 10px;
      }

      .actions-cell {
        flex-direction: column;
      }
    }
  </style>
</head>
<body data-page="invoices">
  <!-- MOBILE HEADER -->
  <div class="mobile-header">
    <a href="/app.html" class="mobile-logo">
      <i class="fas fa-calendar-check"></i>
      <span class="mobile-logo-text">Boostinghost</span>
    </a>
    <button class="mobile-menu-btn" id="mobileMenuBtn">
      <i class="fas fa-bars"></i>
    </button>
  </div>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div class="app-container">
    
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="/" class="sidebar-logo">
          <i class="fas fa-calendar-check"></i>
          <div class="sidebar-logo-text">
            <span class="sidebar-logo-title">Boostinghost</span>
            <span class="sidebar-logo-subtitle">Property Manager</span>
          </div>
        </a>
      </div>
      
      <nav class="sidebar-nav">
        <!-- PRINCIPAL -->
        <div class="nav-section">
          <div class="nav-section-title">Principal</div>

          <a href="/app.html" class="nav-item" data-page="app">
            <i class="fas fa-th-large"></i>
            <span>Dashboard</span>
          </a>

          <a href="/app.html#calendarSection" class="nav-item" id="navCalendarLink">
            <i class="fas fa-calendar"></i>
            <span>Calendrier</span>
          </a>

          <a href="/messages.html" class="nav-item" data-page="messages">
            <i class="fas fa-comment-dots"></i>
            <span>Messages</span>
          </a>
        </div>

        <!-- GESTION -->
        <div class="nav-section">
          <div class="nav-section-title">Gestion</div>

          <a href="/settings.html" class="nav-item" data-page="settings">
            <i class="fas fa-home"></i>
            <span>Mes logements</span>
          </a>

          <a href="/welcome.html" class="nav-item" data-page="welcome">
            <i class="fas fa-book-open"></i>
            <span>Livret d'accueil</span>
          </a>

          <a href="/cleaning.html" class="nav-item" data-page="cleaning">
            <i class="fas fa-broom"></i>
            <span>Gestion du ménage</span>
          </a>

          <a href="/invoices.html" class="nav-item active" data-page="invoices">
            <i class="fas fa-file-invoice-dollar"></i>
            <span>Factures</span>
          </a>

          <a href="/deposits.html" class="nav-item" data-page="deposits">
            <i class="fas fa-shield-alt"></i>
            <span>Cautions</span>
          </a>

          <a href="/notifications.html" class="nav-item" data-page="notifications">
            <i class="fas fa-bell"></i>
            <span>Notifications</span>
          </a>
        </div>

        <!-- PARAMÈTRES -->
        <div class="nav-section">
          <div class="nav-section-title">Paramètres</div>

          <a href="/settings-account.html" class="nav-item" data-page="settings-account">
            <i class="fas fa-cog"></i>
            <span>Paramètres</span>
          </a>

          <a href="/help.html" class="nav-item" data-page="help">
            <i class="fas fa-question-circle"></i>
            <span>Aide</span>
          </a>
        </div>
      </nav>
      
      <div class="sidebar-footer">
        <div class="user-profile">
          <div class="user-avatar" id="sidebarUserAvatar">C</div>
          <div class="user-info">
            <div class="user-name" id="sidebarUserName">Utilisateur</div>
            <div class="user-email" id="sidebarUserCompany">Mon espace</div>
          </div>
          <button class="btn btn-ghost btn-xs" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
        </div>
      </div>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
      
      <!-- Header -->
      <header class="main-header">
        <div class="header-left">
          <div class="page-kicker">Gestion</div>
          <h1 class="page-title">Factures</h1>
          <p class="page-subtitle">
            Créez et gérez vos factures professionnelles
          </p>
        </div>
        <div class="header-actions">
          <a href="/invoice-create.html" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            Nouvelle facture
          </a>
        </div>
      </header>
      
      <!-- Page Content -->
      <div class="page-content">

        <!-- Statistics -->
        <div class="stats-grid" id="statsGrid">
          <div class="stat-card">
            <div class="stat-label">Brouillons</div>
            <div class="stat-value" id="statDrafts">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Émises</div>
            <div class="stat-value" id="statIssued">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Payées</div>
            <div class="stat-value" id="statPaid">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total encaissé</div>
            <div class="stat-value currency" id="statTotalPaid" data-currency="€">-</div>
          </div>
        </div>

        <!-- Filters -->
        <div class="filters-bar">
          <button class="filter-btn active" data-status="all">Toutes</button>
          <button class="filter-btn" data-status="draft">Brouillons</button>
          <button class="filter-btn" data-status="issued">Émises</button>
          <button class="filter-btn" data-status="paid">Payées</button>
          <button class="filter-btn" data-status="overdue">En retard</button>
          
          <select id="yearFilter" class="filter-btn" style="cursor: pointer;">
            <option value="">Toutes les années</option>
          </select>
        </div>

        <!-- Invoices Table -->
        <div class="card">
          <div class="card-body" style="padding: 0;">
            
            <div id="loadingState" class="loading">
              <i class="fas fa-spinner fa-spin"></i>
              <p>Chargement des factures...</p>
            </div>

            <div id="emptyState" class="empty-state" style="display: none;">
              <i class="fas fa-file-invoice"></i>
              <h3>Aucune facture</h3>
              <p>Créez votre première facture pour commencer</p>
              <br>
              <a href="/invoice-create.html" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                Créer une facture
              </a>
            </div>

            <table class="invoice-table" id="invoiceTable" style="display: none;">
              <thead>
                <tr>
                  <th>N° Facture</th>
                  <th>Client</th>
                  <th>Date</th>
                  <th>Échéance</th>
                  <th>Montant</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="invoiceTableBody">
                <!-- Populated by JavaScript -->
              </tbody>
            </table>

          </div>
        </div>

      </div>
      
    </main>
  </div>

  <!-- Scripts -->
  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const token = localStorage.getItem('lcc_token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      let currentFilter = 'all';
      let currentYear = '';

      // Load user info
      const user = JSON.parse(localStorage.getItem('lcc_user') || '{}');
      if (user.firstName) {
        const nameEl = document.getElementById('sidebarUserName');
        const avatarEl = document.getElementById('sidebarUserAvatar');
        if (nameEl) nameEl.textContent = user.firstName + ' ' + (user.lastName || '');
        if (avatarEl) avatarEl.textContent = user.firstName.charAt(0).toUpperCase();
      }
      if (user.company) {
        const companyEl = document.getElementById('sidebarUserCompany');
        if (companyEl) companyEl.textContent = user.company;
      }

      // Logout
      document.getElementById('logoutBtn')?.addEventListener('click', function() {
        localStorage.removeItem('lcc_token');
        localStorage.removeItem('lcc_user');
        window.location.href = '/login.html';
      });

      // Load stats
      async function loadStats() {
        try {
          const response = await fetch(`/api/invoices/stats?year=${currentYear || new Date().getFullYear()}`, {
            headers: { 'Authorization': 'Bearer ' + token }
          });

          if (response.ok) {
            const stats = await response.json();
            document.getElementById('statDrafts').textContent = stats.drafts || 0;
            document.getElementById('statIssued').textContent = stats.issued || 0;
            document.getElementById('statPaid').textContent = stats.paid || 0;
            document.getElementById('statTotalPaid').textContent = formatCurrency(stats.total_paid || 0);
          }
        } catch (err) {
          console.error('Error loading stats:', err);
        }
      }

      // Load invoices
      async function loadInvoices() {
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const invoiceTable = document.getElementById('invoiceTable');
        const invoiceTableBody = document.getElementById('invoiceTableBody');

        loadingState.style.display = 'block';
        emptyState.style.display = 'none';
        invoiceTable.style.display = 'none';

        try {
          const params = new URLSearchParams();
          if (currentFilter !== 'all') params.append('status', currentFilter);
          if (currentYear) params.append('year', currentYear);

          const response = await fetch(`/api/invoices?${params.toString()}`, {
            headers: { 'Authorization': 'Bearer ' + token }
          });

          if (response.ok) {
            const data = await response.json();
            const invoices = data.invoices || [];

            loadingState.style.display = 'none';

            if (invoices.length === 0) {
              emptyState.style.display = 'block';
            } else {
              invoiceTable.style.display = 'table';
              invoiceTableBody.innerHTML = invoices.map(invoice => `
                <tr onclick="window.location.href='/invoice-view.html?id=${invoice.id}'">
                  <td><strong>${invoice.invoice_number}</strong></td>
                  <td>${invoice.client_name}</td>
                  <td>${formatDate(invoice.issue_date)}</td>
                  <td>${invoice.due_date ? formatDate(invoice.due_date) : '-'}</td>
                  <td><strong>${formatCurrency(invoice.total_ttc)} ${invoice.currency || 'EUR'}</strong></td>
                  <td>${getStatusBadge(invoice.status, invoice.paid)}</td>
                  <td onclick="event.stopPropagation();">
                    <div class="actions-cell">
                      <button class="action-btn" onclick="viewInvoice(${invoice.id})" title="Voir">
                        <i class="fas fa-eye"></i>
                      </button>
                      ${invoice.status === 'draft' || invoice.status === 'issued' ? `
                        <button class="action-btn" onclick="editInvoice(${invoice.id})" title="Modifier">
                          <i class="fas fa-edit"></i>
                        </button>
                      ` : ''}
                      ${!invoice.paid && invoice.status !== 'cancelled' ? `
                        <button class="action-btn" onclick="markAsPaid(${invoice.id})" title="Marquer payée">
                          <i class="fas fa-check"></i>
                        </button>
                      ` : ''}
                      ${invoice.status === 'draft' ? `
                        <button class="action-btn danger" onclick="deleteInvoice(${invoice.id}, '${invoice.invoice_number}')" title="Supprimer">
                          <i class="fas fa-trash"></i>
                        </button>
                      ` : ''}
                    </div>
                  </td>
                </tr>
              `).join('');
            }
          } else {
            throw new Error('Failed to load invoices');
          }
        } catch (err) {
          console.error('Error loading invoices:', err);
          loadingState.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            <p>Erreur lors du chargement des factures</p>
          `;
        }
      }

      // Filters
      document.querySelectorAll('.filter-btn[data-status]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.filter-btn[data-status]').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentFilter = this.dataset.status;
          loadInvoices();
        });
      });

      document.getElementById('yearFilter').addEventListener('change', function() {
        currentYear = this.value;
        loadInvoices();
        loadStats();
      });

      // Populate year filter
      const currentYearValue = new Date().getFullYear();
      const yearFilter = document.getElementById('yearFilter');
      for (let year = currentYearValue; year >= currentYearValue - 5; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentYearValue) option.selected = true;
        yearFilter.appendChild(option);
      }

      // Helper functions
      function formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleDateString('fr-FR');
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat('fr-FR', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }).format(amount);
      }

      function getStatusBadge(status, paid) {
        const statusMap = {
          draft: '<span class="status-badge draft"><i class="fas fa-edit"></i> Brouillon</span>',
          issued: '<span class="status-badge issued"><i class="fas fa-paper-plane"></i> Émise</span>',
          paid: '<span class="status-badge paid"><i class="fas fa-check-circle"></i> Payée</span>',
          overdue: '<span class="status-badge overdue"><i class="fas fa-exclamation-triangle"></i> En retard</span>',
          cancelled: '<span class="status-badge cancelled"><i class="fas fa-times-circle"></i> Annulée</span>'
        };
        return statusMap[status] || status;
      }

      // Actions
      window.viewInvoice = function(id) {
        window.location.href = `/invoice-view.html?id=${id}`;
      };

      window.editInvoice = function(id) {
        window.location.href = `/invoice-create.html?id=${id}`;
      };

      window.markAsPaid = async function(id) {
        if (!confirm('Marquer cette facture comme payée ?')) return;

        try {
          const response = await fetch(`/api/invoices/${id}/mark-paid`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
              paymentDate: new Date().toISOString().split('T')[0],
              paymentMethod: 'Virement bancaire'
            })
          });

          if (response.ok) {
            alert('Facture marquée comme payée');
            loadInvoices();
            loadStats();
          } else {
            alert('Erreur lors du marquage de la facture');
          }
        } catch (err) {
          console.error('Error marking as paid:', err);
          alert('Erreur lors du marquage de la facture');
        }
      };

      window.deleteInvoice = async function(id, invoiceNumber) {
        if (!confirm(`Supprimer la facture ${invoiceNumber} ?\n\nCette action est irréversible.`)) return;

        try {
          const response = await fetch(`/api/invoices/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
          });

          if (response.ok) {
            alert('Facture supprimée');
            loadInvoices();
            loadStats();
          } else {
            alert('Erreur lors de la suppression');
          }
        } catch (err) {
          console.error('Error deleting invoice:', err);
          alert('Erreur lors de la suppression');
        }
      };

      // Initial load
      loadStats();
      loadInvoices();

      // Mobile menu
      const menuBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      
      if (menuBtn && sidebar && overlay) {
        menuBtn.addEventListener('click', function() {
          sidebar.classList.toggle('active');
          overlay.classList.toggle('active');
          const icon = menuBtn.querySelector('i');
          if (sidebar.classList.contains('active')) {
            icon.classList.remove('fa-bars');
            icon.classList.add('fa-times');
          } else {
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
          }
        });
        
        overlay.addEventListener('click', function() {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          const icon = menuBtn.querySelector('i');
          icon.classList.remove('fa-times');
          icon.classList.add('fa-bars');
        });
      }
    });
  </script>
</body>
</html>
