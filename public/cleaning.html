<!DOCTYPE html>

<html data-theme="light" lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
<title>Boostinghost ‚Äì Gestion du m√©nage</title>
<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>
<!-- CSS plateforme globale -->
<link href="/css/style.css" rel="stylesheet"/><link href="/css/bh-shared.css?v=1" rel="stylesheet"/><link href="/css/bottom-bar-enhanced.css" rel="stylesheet"/><link href="/css/tablet-bottom-bar-fix.css" rel="stylesheet"/><link href="/css/menu-plus-fixes.css" rel="stylesheet"/><link href="/css/menu-active-button.css" rel="stylesheet"/>
<link href="/css/messages-badge-fix.css" rel="stylesheet"/>
<link href="/css/cleaning-cards-style.css" rel="stylesheet"/>
<link rel="stylesheet" href="/css/messages-badge-red.css">    
<link rel="stylesheet" href="/css/messages-badge-desktop.css">    
<link href="/css/guest-info-styles.css" rel="stylesheet"/>
<style>
    html, body {
      margin: 0 !important;
      }

    .app-container {
      margin-top: 0 !important;
    }

    /* (patched) removed inline .main-content padding override for iOS safe-area */

    .page-content {
      margin-top: 0 !important;
    }

    html {
      scroll-behavior: smooth;
    }

    /* Mise en page sp√©cifique m√©nage */
    .cleaning-page-grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
      gap: var(--spacing-xl);
      margin-bottom: var(--spacing-xl);
    }

    @media (max-width: 1024px) {
      .cleaning-page-grid {
        grid-template-columns: 1fr;
      }
    }

    .cleaner-list {
      margin-top: var(--spacing-md);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .cleaner-item {
      padding: var(--spacing-md);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .cleaner-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .cleaner-name {
      font-weight: 600;
    }

    .cleaner-tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .cleaner-pill {
      padding: 2px 8px;
      border-radius: var(--radius-full);
      border: 1px solid var(--border-color);
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .cleaner-actions {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .btn-xs {
      padding: 4px 8px;
      font-size: 11px;
    }

    /* Assignation logements */
    table.assign-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    table.assign-table th,
    table.assign-table td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border-color);
      text-align: left;
    }

    table.assign-table th {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-tertiary);
    }

    .assign-select {
      width: 100%;
      padding: 6px 8px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      font-size: 13px;
    }

    .assign-hint {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-sm);
    }

    /* Planning IA m√©nage */
    .planning-controls {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .planning-controls input[type="date"] {
      padding: 8px 10px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      font-size: 14px;
    }

    .planning-hint {
      font-size: 12px;
      color: var(--text-secondary);
    }

    table.planning-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: var(--spacing-sm);
    }

    table.planning-table th,
    table.planning-table td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border-color);
      text-align: left;
      vertical-align: top;
    }

    table.planning-table th {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-tertiary);
    }

    .planning-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 11px;
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
    }

    .planning-tag i {
      font-size: 11px;
    }

    .planning-empty {
      font-size: 13px;
      color: var(--text-secondary);
      padding: 8px 0;
    }

    .badge-type {
      display: inline-block;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 11px;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      margin-left: 6px;
    }

    .badge-cleaner {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 11px;
      background: var(--primary-light);
      color: var(--primary-color);
    }

    /* Petites utilitaires */
    .text-secondary {
      color: var(--text-secondary);
    }

    /* ===== TABS NAVIGATION M√âNAGE ===== */
    .cleaning-tabs {
      display: flex;
      gap: 4px;
      background: var(--bg-secondary);
      padding: 4px;
      border-radius: 12px;
      margin-bottom: var(--spacing-lg);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .cleaning-tab {
      flex: 1;
      min-width: 120px;
      padding: 10px 16px;
      border: none;
      border-radius: 10px;
      background: transparent;
      font-family: inherit;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }

    .cleaning-tab:hover {
      color: var(--text-primary);
    }

    .cleaning-tab.active {
      background: var(--bg-primary);
      color: var(--primary-color);
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }

    .cleaning-tab .tab-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 700;
      background: var(--primary-color);
      color: white;
    }

    .cleaning-tab-panel {
      display: none;
    }

    .cleaning-tab-panel.active {
      display: block;
    }

    /* ===== STATS CARDS ===== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: var(--spacing-lg);
    }

    .stat-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .stat-card-value {
      font-size: 28px;
      font-weight: 800;
      color: var(--text-primary);
      line-height: 1.1;
    }

    .stat-card-value.green { color: #059669; }
    .stat-card-value.orange { color: #f59e0b; }
    .stat-card-value.red { color: #ef4444; }
    .stat-card-value.blue { color: #3b82f6; }

    .stat-card-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
      font-weight: 500;
    }

    /* ===== CHECKLISTS VALID√âES ===== */
    .checklists-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .checklist-item {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: all 0.2s;
    }

    .checklist-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .checklist-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .checklist-item-property {
      font-weight: 700;
      font-size: 15px;
    }

    .checklist-item-status {
      flex-shrink: 0;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
    }

    .status-pending {
      background: #fef3c7;
      color: #b45309;
    }

    .status-validated {
      background: #d1fae5;
      color: #059669;
    }

    .status-rejected {
      background: #fee2e2;
      color: #dc2626;
    }

    .checklist-item-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .checklist-item-meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .checklist-item-meta-item i {
      font-size: 12px;
      width: 14px;
      text-align: center;
      color: var(--text-tertiary);
    }

    .checklist-item-actions {
      display: flex;
      gap: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--border-color);
    }

    .checklist-item-actions .btn {
      flex: 1;
    }

    /* ===== TEMPLATE EDITOR ===== */
    .template-editor {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .template-room-section {
      margin-bottom: 16px;
    }

    .template-room-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 8px;
    }

    .template-room-header .room-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .template-task-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
    }

    .template-task-row input[type="text"] {
      flex: 1;
      padding: 8px 10px !important;
      font-size: 13px !important;
    }

    .template-task-row .btn-delete-task {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: transparent;
      color: var(--text-tertiary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      transition: all 0.15s;
    }

    .template-task-row .btn-delete-task:hover {
      color: #dc2626;
      border-color: #dc2626;
      background: #fee2e2;
    }

    .btn-add-task {
      padding: 6px 12px;
      border: 1px dashed var(--border-color);
      border-radius: 6px;
      background: transparent;
      font-family: inherit;
      font-size: 12px;
      font-weight: 600;
      color: var(--primary-color);
      cursor: pointer;
      margin-top: 4px;
      transition: all 0.15s;
    }

    .btn-add-task:hover {
      background: var(--primary-light);
      border-color: var(--primary-color);
    }

    /* ===== QR CODE MODAL ===== */
    .qr-modal-content {
      text-align: center;
      padding: 20px;
    }

    .qr-modal-content canvas,
    .qr-modal-content img {
      max-width: 240px;
      margin: 16px auto;
    }

    .qr-modal-url {
      font-size: 12px;
      color: var(--text-secondary);
      word-break: break-all;
      background: var(--bg-secondary);
      padding: 8px 12px;
      border-radius: 8px;
      margin-top: 12px;
    }

    /* ===== CHECKLIST DETAIL MODAL ===== */
    .checklist-detail-modal {
      position: fixed;
      inset: 0;
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .checklist-detail-modal.active {
      display: flex;
    }

    .checklist-detail-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(4px);
    }

    .checklist-detail-panel {
      position: relative;
      background: var(--bg-primary);
      border-radius: 16px;
      max-width: 540px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    }

    .checklist-detail-header {
      padding: 20px 20px 12px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .checklist-detail-close {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .checklist-detail-body {
      padding: 20px;
    }

    .checklist-detail-section {
      margin-bottom: 20px;
    }

    .checklist-detail-section-title {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-tertiary);
      margin-bottom: 8px;
    }

    .checklist-detail-tasks .task-row-display {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 13px;
    }

    .task-row-display .task-check-icon {
      width: 20px;
      height: 20px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      flex-shrink: 0;
    }

    .task-check-icon.checked {
      background: #d1fae5;
      color: #059669;
    }

    .task-check-icon.unchecked {
      background: #fee2e2;
      color: #dc2626;
    }

    .checklist-detail-photos {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .checklist-detail-photos img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .checklist-detail-photos img:hover {
      transform: scale(1.03);
    }

    .checklist-detail-notes {
      padding: 12px;
      background: #fef3c7;
      border-radius: 8px;
      font-size: 13px;
      color: #92400e;
      border-left: 3px solid #f59e0b;
    }

    .checklist-detail-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 8px;
    }

    .checklist-detail-footer .btn {
      flex: 1;
    }

    .btn-validate {
      background: #059669 !important;
      color: white !important;
      border: none !important;
    }

    .btn-validate:hover {
      background: #047857 !important;
    }

    .btn-reject {
      background: transparent !important;
      color: #dc2626 !important;
      border: 1px solid #dc2626 !important;
    }

    .btn-reject:hover {
      background: #fee2e2 !important;
    }

    /* ===== TEMPLATE LIST ===== */
    .templates-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .template-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
    }

    .template-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .template-card-name {
      font-weight: 700;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .template-card-property {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .template-card-tasks-count {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .template-default-badge {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 10px;
      background: var(--primary-light);
      color: var(--primary-color);
      font-weight: 700;
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .checklist-detail-photos {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* ========== HEADER DASHBOARD MODERNE (comme app.html) ========== */

    .main-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      padding: 18px 20px;
      margin-bottom: 20px;
      border-radius: 20px;
      background: linear-gradient(
        135deg,
        rgba(15, 23, 42, 0.98),
        rgba(15, 23, 42, 0.92)
      );
      border: 1px solid rgba(148, 163, 184, 0.45);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.7);
    }

    [data-theme="light"] .main-header {
      background: linear-gradient(135deg, #f9fafb, #eff6ff);
      border-color: rgba(148, 163, 184, 0.4);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.06);
    }

    .header-left {
      max-width: 60%;
    }

    .page-kicker {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: #9ca3af;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .page-title {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    .page-subtitle {
      margin-top: 6px;
      font-size: 13px;
      color: #9ca3af;
    }

    [data-theme="light"] .page-subtitle {
      color: #6b7280;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-ghost {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: transparent;
      padding-inline: 14px;
    }

    .btn-ghost:hover {
      background: rgba(15, 23, 42, 0.06);
    }

    [data-theme="dark"] .btn-ghost:hover {
      background: rgba(15, 23, 42, 0.9);
    }

    @media (max-width: 768px) {
      .main-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-left {
        max-width: 100%;
      }
    }
    /* ===== INPUTS MODERNES - STYLE UNIFI√â ===== */
    
    /* Override des styles globaux pour cette page */
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="tel"],
    input[type="number"],
    input[type="url"],
    input[type="date"],
    input[type="time"],
    textarea,
    select {
      width: 100%;
      padding: 12px 16px !important;
      font-size: 15px !important;
      font-weight: 400 !important;
      line-height: 1.5 !important;
      color: var(--text-primary) !important;
      background-color: #ffffff !important;
      border: 1.5px solid #e5e7eb !important;
      border-radius: 8px !important;
      transition: all 0.15s ease !important;
      font-family: 'Inter', sans-serif !important;
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      appearance: none !important;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="password"]:focus,
    input[type="tel"]:focus,
    input[type="number"]:focus,
    input[type="url"]:focus,
    input[type="date"]:focus,
    input[type="time"]:focus,
    textarea:focus,
    select:focus {
      outline: none !important;
      border-color: var(--primary-color) !important;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
      background-color: #ffffff !important;
    }

    input[type="text"]:hover:not(:focus),
    input[type="email"]:hover:not(:focus),
    input[type="password"]:hover:not(:focus),
    input[type="tel"]:hover:not(:focus),
    input[type="number"]:hover:not(:focus),
    input[type="url"]:hover:not(:focus),
    input[type="date"]:hover:not(:focus),
    input[type="time"]:hover:not(:focus),
    textarea:hover:not(:focus),
    select:hover:not(:focus) {
      border-color: #d1d5db !important;
    }

    input::placeholder,
    textarea::placeholder {
      color: #9ca3af !important;
      opacity: 1 !important;
    }

    /* Labels plus modernes */
    label {
      display: block;
      font-size: 14px !important;
      font-weight: 600 !important;
      color: var(--text-primary) !important;
      margin-bottom: 8px !important;
    }

    /* Form groups avec espacement */
    .form-group {
      margin-bottom: 20px;
    }

    /* Select avec ic√¥ne */
    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E") !important;
      background-position: right 12px center !important;
      background-repeat: no-repeat !important;
      background-size: 20px !important;
      padding-right: 40px !important;
    }

    /* Textarea */
    textarea {
      min-height: 100px !important;
      resize: vertical !important;
    }

    /* Disabled state */
    input:disabled,
    textarea:disabled,
    select:disabled {
      background-color: #f3f4f6 !important;
      color: #9ca3af !important;
      cursor: not-allowed !important;
      opacity: 0.6 !important;
    }

    /* Boutons modernes */
    .btn-primary,
    .btn-action,
    button[type="submit"] {
      padding: 12px 24px !important;
      font-size: 15px !important;
      font-weight: 600 !important;
      border-radius: 8px !important;
      transition: all 0.15s ease !important;
      border: none !important;
    }

    .btn-primary:hover,
    .btn-action:hover,
    button[type="submit"]:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2) !important;
    }

    .btn-secondary {
      padding: 10px 20px !important;
      font-size: 14px !important;
      font-weight: 600 !important;
      border-radius: 8px !important;
      transition: all 0.15s ease !important;
    }

    .btn-secondary:hover {
      transform: translateY(-1px) !important;
    }

    /* Boutons d'action dans les listes */
    .btn-sm {
      padding: 8px 14px !important;
      font-size: 13px !important;
      border-radius: 6px !important;
      transition: all 0.15s ease !important;
    }

    .btn-sm:hover {
      transform: translateY(-1px) !important;
    }

    /* Messages d'erreur/succ√®s */
    .error-message {
      color: #dc2626;
      font-size: 13px;
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .success-message {
      color: #059669;
      font-size: 13px;
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Card sections plus espac√©es */
    .card {
      padding: 28px !important;
      border-radius: 12px !important;
    }

    .card h2 {
      margin-bottom: 24px !important;
    }

    /* Checkbox modernes */
    input[type="checkbox"] {
      width: 20px !important;
      height: 20px !important;
      border: 2px solid #d1d5db !important;
      border-radius: 4px !important;
      cursor: pointer !important;
      transition: all 0.15s ease !important;
    }

    input[type="checkbox"]:checked {
      background-color: var(--primary-color) !important;
      border-color: var(--primary-color) !important;
    }

    input[type="checkbox"]:hover {
      border-color: var(--primary-color) !important;
    }

    /* Upload de fichier moderne */
    input[type="file"] {
      padding: 10px !important;
      border: 2px dashed #d1d5db !important;
      background: #f9fafb !important;
      cursor: pointer !important;
      border-radius: 8px !important;
    }

    input[type="file"]:hover {
      border-color: var(--primary-color) !important;
      background: #f0fdf4 !important;
    }

    /* Modals avec inputs modernes */
    .modal input[type="text"],
    .modal input[type="email"],
    .modal input[type="tel"],
    .modal input[type="date"],
    .modal textarea,
    .modal select {
      margin-bottom: 16px;
    }

    /* Espacement des formulaires dans les modals */
    .modal .form-group:last-child {
      margin-bottom: 0;
    }
  </style>
<script src="/js/auth-fetch.js"></script>
<link rel="stylesheet" href="/css/mobile-native-styles.css">
</head>
<body data-back-href="/app.html" data-back-label="Retour au dashboard" data-kicker="Gestion" data-page="cleaning" data-subtitle="Assignez-la √† vos logements et g√©n√©rez un planning intelligent." data-title="Gestion du m√©nage">
<!-- MOBILE HEADER -->
<div class="mobile-header">
  <a class="mobile-logo" href="/app.html">
    <span class="mobile-logo-text"></span>
  </a>
  <button class="mobile-menu-btn" id="mobileMenuBtn">
    <i class="fas fa-bars"></i>
  </button>
</div>
<div class="sidebar-overlay" id="sidebarOverlay"></div>
<div class="app-container">
  <!-- Sidebar -->
  <div id="bhSidebar"></div>
  <!-- Main -->
  <main class="main-content"><div id="bhHeader"></div>

<!-- Contenu -->
<div class="page-content">

<!-- TABS NAVIGATION -->
<div class="cleaning-tabs" id="cleaningTabs">
  <button class="cleaning-tab active" data-tab="team" onclick="switchTab('team')">
    <i class="fas fa-users"></i> √âquipe
  </button>
  <button class="cleaning-tab" data-tab="checklists" onclick="switchTab('checklists')">
    <i class="fas fa-clipboard-check"></i> Checklists
    <span class="tab-badge" id="checklistsPendingBadge" style="display:none">0</span>
  </button>
  <button class="cleaning-tab" data-tab="templates" onclick="switchTab('templates')">
    <i class="fas fa-list-check"></i> Templates
  </button>
  <button class="cleaning-tab" data-tab="stats" onclick="switchTab('stats')">
    <i class="fas fa-chart-bar"></i> Stats
  </button>
</div>

<!-- ===== TAB 1 : √âQUIPE & ASSIGNATION ===== -->
<div class="cleaning-tab-panel active" id="panel-team">
<section class="cleaning-page-grid">
<!-- Colonne gauche : √©quipe m√©nage -->
<section class="card">
<div class="card-header">
<div class="card-title">
<i class="fas fa-users"></i>
                √âquipe de m√©nage
              </div>
</div>
<form class="form-grid" id="cleanerForm">
<div class="form-row">
<label for="cleanerName">Nom &amp; pr√©nom</label>
<input id="cleanerName" required="" type="text"/>
</div>
<div class="form-row">
<label for="cleanerEmail">E-mail</label>
<input id="cleanerEmail" placeholder="exemple@mail.com" type="email"/>
</div>
<div class="form-row">
<label for="cleanerPhone">T√©l√©phone</label>
<input id="cleanerPhone" placeholder="+33 6 00 00 00 00" type="tel"/>
</div>
<div class="form-row">
<label for="cleanerNotes">Notes / zone d'intervention</label>
<textarea id="cleanerNotes" placeholder="Ex : intervient uniquement sur les appartements du centre-ville" rows="2"></textarea>
</div>
<div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
<button class="btn btn-primary" type="submit">
<i class="fas fa-user-plus"></i>
                  Ajouter √† l'√©quipe
                </button>
</div>
</form>
<hr style="margin:16px 0; border:none; border-top:1px solid var(--border-color);"/>
<div>
<div class="text-secondary" style="font-size:13px; margin-bottom:8px;">
                Membres de l'√©quipe
              </div>
<div class="cleaner-list" id="cleanerList">
<p class="text-secondary" style="font-size:13px;">
                  Aucun membre pour l'instant. Ajoutez votre premi√®re personne de m√©nage.
                </p>
</div>
</div>
</section>
<!-- Colonne droite : assignation par r√©servation -->
<section class="card">
<div class="card-header">
<div class="card-title">
<i class="fas fa-broom"></i>
                Assignation par r√©servation
              </div>
</div>
<p class="assign-hint">
              Assignez une personne de m√©nage √† chaque d√©part de r√©servation. 
              Ces assignations seront visibles dans le dashboard et dans le calendrier.
            </p>
<!-- Filtre par logement -->
<div class="cleaning-filter-row" style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
<label for="reservationPropertyFilter" style="font-size:13px;">
                Filtrer par logement :
              </label>
<select class="assign-select" id="reservationPropertyFilter" style="max-width:260px;">
<option value="">Tous les logements</option>
</select>
</div>
<div id="assignContainer">
<p class="text-secondary" style="font-size:13px;">
                Chargement des r√©servations‚Ä¶
              </p>
</div>
</section>
</section>
</div>

<!-- ===== TAB 2 : CHECKLISTS SOUMISES ===== -->
<div class="cleaning-tab-panel" id="panel-checklists">
<section class="card">
  <div class="card-header">
    <div class="card-title">
      <i class="fas fa-clipboard-check"></i>
      Checklists soumises
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <select id="checklistStatusFilter" class="assign-select" style="max-width:180px; font-size:13px;" onchange="renderChecklistsList()">
        <option value="">Tous les statuts</option>
        <option value="pending">‚è≥ En attente</option>
        <option value="validated">‚úÖ Valid√©es</option>
        <option value="rejected">‚ö†Ô∏è Rejet√©es</option>
      </select>
    </div>
  </div>
  <div class="checklists-list" id="checklistsList">
    <p class="text-secondary" style="font-size:13px;">Chargement‚Ä¶</p>
  </div>
</section>
</div>

<!-- ===== TAB 3 : TEMPLATES ===== -->
<div class="cleaning-tab-panel" id="panel-templates">
<section class="card" style="margin-bottom:16px;">
  <div class="card-header">
    <div class="card-title">
      <i class="fas fa-list-check"></i>
      Templates de m√©nage
    </div>
    <button class="btn btn-primary btn-sm" onclick="openTemplateEditor()">
      <i class="fas fa-plus"></i> Nouveau template
    </button>
  </div>
  <p class="assign-hint" style="margin-bottom:12px;">
    Cr√©ez des templates personnalis√©s par logement. Vos √©quipes de m√©nage les verront automatiquement dans leur interface.
  </p>
  <div class="templates-list" id="templatesList">
    <p class="text-secondary" style="font-size:13px;">Chargement‚Ä¶</p>
  </div>
</section>

<!-- Template editor (hidden by default) -->
<section class="card" id="templateEditorSection" style="display:none;">
  <div class="card-header">
    <div class="card-title" id="templateEditorTitle">
      <i class="fas fa-edit"></i> Nouveau template
    </div>
    <button class="btn btn-ghost btn-sm" onclick="closeTemplateEditor()">
      <i class="fas fa-times"></i> Annuler
    </button>
  </div>
  <div class="template-editor">
    <div class="form-row" style="margin-bottom:12px;">
      <label>Nom du template</label>
      <input type="text" id="templateName" value="Template m√©nage" placeholder="Ex: M√©nage studio centre-ville"/>
    </div>
    <div class="form-row" style="margin-bottom:12px;">
      <label>Logement associ√© (optionnel)</label>
      <select id="templatePropertySelect" class="assign-select">
        <option value="">Tous les logements (template par d√©faut)</option>
      </select>
    </div>
    <div class="form-row" style="margin-bottom:16px;">
      <label style="display:flex; align-items:center; gap:6px;">
        <input type="checkbox" id="templateIsDefault" style="width:auto !important; height:auto !important;"/>
        Template par d√©faut
      </label>
    </div>

    <div id="templateTasksEditor">
      <!-- Rendered by JS -->
    </div>

    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:16px;">
      <button class="btn btn-primary" onclick="saveTemplate()">
        <i class="fas fa-save"></i> Enregistrer
      </button>
    </div>
  </div>
  <input type="hidden" id="editingTemplateId" value=""/>
</section>
</div>

<!-- ===== TAB 4 : STATISTIQUES ===== -->
<div class="cleaning-tab-panel" id="panel-stats">
<section class="card">
  <div class="card-header">
    <div class="card-title">
      <i class="fas fa-chart-bar"></i>
      Statistiques m√©nage
    </div>
    <select id="statsPeriod" class="assign-select" style="max-width:160px; font-size:13px;" onchange="loadStats()">
      <option value="month">30 derniers jours</option>
      <option value="week">7 derniers jours</option>
      <option value="year">Cette ann√©e</option>
    </select>
  </div>

  <div class="stats-grid" id="statsGrid">
    <div class="stat-card">
      <div class="stat-card-value" id="statTotal">‚Äî</div>
      <div class="stat-card-label">Total m√©nages</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-value green" id="statValidated">‚Äî</div>
      <div class="stat-card-label">Valid√©s</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-value orange" id="statPending">‚Äî</div>
      <div class="stat-card-label">En attente</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-value blue" id="statAvgDuration">‚Äî</div>
      <div class="stat-card-label">Dur√©e moyenne</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-value green" id="statValidationRate">‚Äî</div>
      <div class="stat-card-label">Taux validation</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-value red" id="statRejected">‚Äî</div>
      <div class="stat-card-label">Rejet√©s</div>
    </div>
  </div>

  <h3 style="font-size:14px; font-weight:700; margin:16px 0 8px;">Par personne de m√©nage</h3>
  <div id="statsCleanerTable"></div>

  <h3 style="font-size:14px; font-weight:700; margin:16px 0 8px;">Par logement</h3>
  <div id="statsPropertyTable"></div>
</section>
</div>

</div>

<!-- ===== CHECKLIST DETAIL MODAL ===== -->
<div class="checklist-detail-modal" id="checklistDetailModal">
  <div class="checklist-detail-overlay" onclick="closeChecklistDetail()"></div>
  <div class="checklist-detail-panel">
    <div class="checklist-detail-header">
      <div>
        <div style="font-size:17px; font-weight:700;" id="detailPropertyName">‚Äî</div>
        <div style="font-size:13px; color:var(--text-secondary);" id="detailSubtitle">‚Äî</div>
      </div>
      <button class="checklist-detail-close" onclick="closeChecklistDetail()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="checklist-detail-body">
      <div class="checklist-detail-section">
        <div class="checklist-detail-section-title">Infos</div>
        <div id="detailInfos"></div>
      </div>
      <div class="checklist-detail-section">
        <div class="checklist-detail-section-title">T√¢ches</div>
        <div class="checklist-detail-tasks" id="detailTasks"></div>
      </div>
      <div class="checklist-detail-section">
        <div class="checklist-detail-section-title">Photos</div>
        <div class="checklist-detail-photos" id="detailPhotos"></div>
      </div>
      <div class="checklist-detail-section" id="detailNotesSection" style="display:none;">
        <div class="checklist-detail-section-title">Notes du cleaner</div>
        <div class="checklist-detail-notes" id="detailNotes"></div>
      </div>
      <div class="checklist-detail-section" id="detailOwnerNotesSection" style="display:none;">
        <div class="checklist-detail-section-title">Votre commentaire (rejet)</div>
        <div class="checklist-detail-notes" id="detailOwnerNotes" style="background:#fee2e2; color:#991b1b; border-color:#ef4444;"></div>
      </div>
    </div>
    <div class="checklist-detail-footer" id="detailFooter">
      <!-- Boutons valider/rejeter ajout√©s dynamiquement -->
    </div>
  </div>
</div>

<!-- QR Code Modal -->
<div class="checklist-detail-modal" id="qrModal">
  <div class="checklist-detail-overlay" onclick="closeQrModal()"></div>
  <div class="checklist-detail-panel" style="max-width:380px;">
    <div class="checklist-detail-header">
      <div style="font-size:17px; font-weight:700;">QR Code M√©nage</div>
      <button class="checklist-detail-close" onclick="closeQrModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="qr-modal-content" id="qrModalContent">
      <p class="text-secondary">Chargement‚Ä¶</p>
    </div>
  </div>
</div>
</main>
</div>
<!-- Scripts -->
<script>
    // Auth / user (m√™me logique que app.html)
    (function () {
      const token = localStorage.getItem('lcc_token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      const rawUser = localStorage.getItem('lcc_user');
      let user = null;

      try {
        user = rawUser ? JSON.parse(rawUser) : null;
      } catch (e) {
        console.error('Impossible de lire lcc_user', e);
      }

      if (user) {
        const nameEl = document.getElementById('sidebarUserName');
        const companyEl = document.getElementById('sidebarUserCompany');
        const avatarEl = document.getElementById('sidebarUserAvatar');

        if (nameEl) {
          nameEl.textContent = user.firstName
            ? user.firstName + (user.lastName ? ' ' + user.lastName : '')
            : (user.email || 'Mon compte');
        }

        if (companyEl) {
          companyEl.textContent = user.company || 'Mon espace';
        }

        if (avatarEl) {
          const initial = (user.firstName || user.email || '?').trim()[0] || 'U';
          avatarEl.textContent = initial.toUpperCase();
        }
      }

      //       const logoutBtn = document.getElementById('logoutBtn');
      //       if (logoutBtn) {
      //         logoutBtn.addEventListener('click', function () {
      //           localStorage.removeItem('lcc_token');
      //           localStorage.removeItem('lcc_user');
      //           window.location.href = '/login.html';
      //         });
      //       }
    })();

    // --------------------------
    // GESTION EQUIPE + ASSIGNATION + PLANNING
    // --------------------------
    document.addEventListener('DOMContentLoaded', () => {
      
      // ============================================
      // ‚úÖ FONCTIONS HELPERS POUR AFFICHAGE VOYAGEUR
      // ============================================
      
      function cleanGuestName(reservation) {
        if (!reservation) return 'Voyageur';
        
        // Si on a le guest_display_name construit par le serveur
        if (reservation.guest_display_name && 
            reservation.guest_display_name !== 'Voyageur' &&
            reservation.guest_display_name.trim() !== '') {
          return reservation.guest_display_name;
        }
        
        // Construire √† partir de guest_first_name et guest_last_name (onboarding)
        if (reservation.guest_first_name) {
          const firstName = reservation.guest_first_name.trim();
          const lastName = reservation.guest_last_name ? reservation.guest_last_name.trim() : '';
          return lastName ? `${firstName} ${lastName}` : firstName;
        }
        
        // Fallback sur guest_name
        const rawName = reservation.guestName || reservation.guest_name || reservation.name;
        if (rawName && rawName !== 'undefined' && rawName !== 'null' && rawName.trim() !== '') {
          const cleaned = rawName.trim().replace(/^\(|\)$/g, '');
          const invalidNames = [
            'not available', 'closed', 'reservation', 'reserved', 'blocked', 
            'unavailable', 'booked', 'not provided', 'n/a', 'unknown', 'guest'
          ];
          
          if (!invalidNames.some(invalid => cleaned.toLowerCase().includes(invalid))) {
            return cleaned;
          }
        }
        
        // Fallback final avec plateforme
        const plat = (reservation.source || reservation.platform || '').toLowerCase();
        if (plat.includes('airbnb')) return 'Voyageur Airbnb';
        if (plat.includes('booking')) return 'Voyageur Booking';
        
        return 'Voyageur';
      }
      
      function getGuestInitial(reservation) {
        if (!reservation) return 'V';
        
        // Si on a l'initiale construite par le serveur
        if (reservation.guest_initial && reservation.guest_initial !== 'V') {
          return reservation.guest_initial;
        }
        
        // Extraire du pr√©nom (onboarding)
        if (reservation.guest_first_name && reservation.guest_first_name.trim() !== '') {
          return reservation.guest_first_name.charAt(0).toUpperCase();
        }
        
        // Fallback sur guest_name
        const name = reservation.guestName || reservation.guest_name || reservation.name;
        if (name && name !== 'undefined' && name !== 'null' && name.trim() !== '') {
          return name.charAt(0).toUpperCase();
        }
        
        return 'V';
      }
      
      // Exposer globalement
      window.cleanGuestName = cleanGuestName;
      window.getGuestInitial = getGuestInitial;
      
      console.log('‚úÖ Fonctions helpers m√©nage charg√©es');
      
      // NOUVELLE FONCTION : Formater une date YYYY-MM-DD en DD/MM/YYYY
      function formatDateFr(dateStr) {
        if (!dateStr) return '';
        const parts = dateStr.split('-');
        if (parts.length !== 3) return dateStr;
        const [year, month, day] = parts;
        return `${day}/${month}/${year}`;
      }
      const API_URL = 'https://lcc-booking-manager.onrender.com';
      const STORAGE_CLEANERS = 'lcc_cleaners';
      const STORAGE_ASSIGN = 'lcc_cleaning_assignments';

      let PROPERTIES = [];
      let RESERVATIONS = [];

      let cleaners = [];
      let assignments = {};

      // Filtre logement
      let selectedReservationPropertyFilter = '';
      let propertyFilterInitialized = false;

      const cleanerForm = document.getElementById('cleanerForm');
      const cleanerList = document.getElementById('cleanerList');
      const assignContainer = document.getElementById('assignContainer');
      
function formatDateFr(dateStr) {
  if (!dateStr) return '';
  const parts = dateStr.split('-');
  if (parts.length !== 3) return dateStr;
  const [year, month, day] = parts;
  return `${day}/${month}/${year}`;
}
      function loadLocalData() {
        try {
          // Les cleaners sont maintenant charg√©s depuis l'API dans loadRemoteData()
          // On garde seulement les assignations en localStorage pour la compatibilit√©
          assignments = JSON.parse(localStorage.getItem(STORAGE_ASSIGN)) || {};
        } catch (e) {
          assignments = {};
        }
      }

      function saveLocalData() {
        // On ne sauvegarde plus les cleaners en localStorage
        // Ils sont maintenant g√©r√©s uniquement via l'API
        localStorage.setItem(STORAGE_ASSIGN, JSON.stringify(assignments));
      }

      // Charge les assignations m√©nage depuis le backend et les injecte dans "assignments"
      async function loadAssignmentsFromApi() {
  try {
    const token = localStorage.getItem('lcc_token');
    if (!token) return;

    const res = await fetch(`${API_URL}/api/cleaning/assignments`, {
      headers: {
        Authorization: 'Bearer ' + token
      }
    });

    if (!res.ok) {
      console.warn('Erreur lors du chargement des assignations m√©nage', res.status);
      return;
    }

    const data = await res.json();
    const apiMap = {};

    // On reconstruit une map √† partir de ce que renvoie l'API
    (data.assignments || []).forEach((row) => {
      const key = row.reservation_key;

      if (key && row.cleaner_id) {
        apiMap[key] = row.cleaner_id;
      }
    });

    const apiKeys = Object.keys(apiMap);

    if (apiKeys.length > 0) {
      // ‚úÖ On FUSIONNE les assignations API avec les locales
      // Les donn√©es API prennent le dessus si conflit
      assignments = Object.assign({}, assignments, apiMap);
      saveLocalData();
    } else {
      // ‚úÖ Aucune assignation retourn√©e ‚Üí on NE TOUCHE PAS aux assignations locales
      console.log("‚ÑπÔ∏è Aucune assignation m√©nage renvoy√©e par l'API, on garde les assignations locales.");
    }
  } catch (e) {
    console.error('Erreur loadAssignmentsFromApi()', e);
    // En cas d'erreur r√©seau, on ne touche pas non plus aux assignations locales
  }
}

      // ‚úÖ Cleaners par d√©faut par logement (charg√© depuis settings)
      let defaultCleanersMap = {};

      async function loadDefaultCleanersMap() {
        try {
          const token = localStorage.getItem('lcc_token');
          if (!token) return;
          const res = await fetch(`${API_URL}/api/cleaning/default-cleaners`, {
            headers: { Authorization: 'Bearer ' + token }
          });
          if (res.ok) {
            const data = await res.json();
            defaultCleanersMap = data.defaults || {};
            console.log('üßπ Cleaners par d√©faut charg√©s:', Object.keys(defaultCleanersMap));
          }
        } catch (e) { console.error('Erreur default cleaners:', e); }
      }

      // Helper : r√©cup√©rer le cleaner assign√© (sp√©cifique > d√©faut)
      function getAssignedCleanerId(reservationKey, propertyId) {
        // 1) Assignation sp√©cifique par reservation_key
        if (reservationKey && assignments[reservationKey]) {
          return assignments[reservationKey];
        }
        // 2) Cleaner par d√©faut du logement
        if (propertyId && defaultCleanersMap[propertyId]) {
          return defaultCleanersMap[propertyId].cleanerId;
        }
        return '';
      }


      async function loadRemoteData() {
        try {
          const token = localStorage.getItem('lcc_token');
          if (!token) return;

          // Charger les r√©servations et propri√©t√©s
          const response = await fetch(`${API_URL}/api/reservations`, {
            headers: {
              Authorization: 'Bearer ' + token
            }
          });

          if (!response.ok) {
            console.warn('Erreur lors du chargement des r√©servations pour le m√©nage', response.status);
            return;
          }

          const data = await response.json().catch(() => ({}));

          RESERVATIONS = Array.isArray(data.reservations) ? data.reservations : [];
          PROPERTIES = Array.isArray(data.properties) ? data.properties : [];

          // Charger les cleaners depuis l'API
          const cleanersResponse = await fetch(`${API_URL}/api/cleaners`, {
            headers: {
              Authorization: 'Bearer ' + token
            }
          });

          if (cleanersResponse.ok) {
            const cleanersData = await cleanersResponse.json().catch(() => ({}));
            if (Array.isArray(cleanersData.cleaners)) {
              cleaners = cleanersData.cleaners;
            }
          }

          // Fallback de d√©mo si aucune propri√©t√©
          if (!PROPERTIES.length) {
            PROPERTIES = [
              { id: 'apt-demo-1', name: 'Appartement d√©mo 1' },
              { id: 'apt-demo-2', name: 'Appartement d√©mo 2' }
            ];
          }
        } catch (e) {
          console.error('Erreur loadRemoteData()', e);
          if (!PROPERTIES.length) {
            PROPERTIES = [
              { id: 'apt-demo-1', name: 'Appartement d√©mo 1' },
              { id: 'apt-demo-2', name: 'Appartement d√©mo 2' }
            ];
          }
        }
      }

      function getReservationKey(reservation) {
  if (!reservation || !reservation.start || !reservation.end) return null;
  
  const propertyId = getReservationPropertyId(reservation);
  if (!propertyId) return null;
  
  const startStr = String(reservation.start).slice(0, 10);
  const endStr = String(reservation.end).slice(0, 10);
  return `${propertyId}_${startStr}_${endStr}`;
}

      function getPropertyNameById(propertyId) {
        if (!propertyId) return 'Logement';
        const p = PROPERTIES.find(
          (x) =>
            String(x.id) === String(propertyId) ||
            String(x.propertyId) === String(propertyId)
        );
        return p ? (p.name || p.title || p.label || propertyId) : propertyId;
      }

      function getReservationPropertyId(r) {
        if (!r) return null;
        if (r.propertyId != null) return String(r.propertyId);
        if (r.property && r.property.id != null) return String(r.property.id);
        if (r.property_id != null) return String(r.property_id);
        return null;
      }

      function initReservationPropertyFilter() {
        const select = document.getElementById('reservationPropertyFilter');
        if (!select) return;

        const previousValue = selectedReservationPropertyFilter;

        // Reset de base
        select.innerHTML = '<option value="">Tous les logements</option>';

        const alreadyAdded = new Set();

        // On se base sur PROPERTIES pour remplir la liste
        if (Array.isArray(PROPERTIES)) {
          PROPERTIES.forEach((p) => {
            const id = p.id != null ? p.id : p.propertyId;
            if (!id) return;
            const idStr = String(id);
            if (alreadyAdded.has(idStr)) return;
            alreadyAdded.add(idStr);

            const opt = document.createElement('option');
            opt.value = idStr;
            opt.textContent = p.name || p.title || p.label || ('Logement ' + idStr);
            select.appendChild(opt);
          });
        }

        // Restaure la s√©lection pr√©c√©dente si possible
        if (previousValue) {
          select.value = previousValue;
        }

        select.onchange = (e) => {
          selectedReservationPropertyFilter = e.target.value || '';
          renderAssignments();
        };

        propertyFilterInitialized = true;
      }

      function renderCleaners() {
        if (!cleanerList) return;
        if (!cleaners.length) {
          cleanerList.innerHTML = '<p class="text-secondary" style="font-size:13px;">Aucun membre pour l\'instant. Ajoutez votre premi√®re personne de m√©nage.</p>';
          return;
        }

        cleanerList.innerHTML = '';
        cleaners.forEach((c) => {
          const div = document.createElement('div');
          div.className = 'cleaner-item';
          
          const taskUrl = c.pin_code ? `${window.location.origin}/cleaning-tasks.html` : '';
          
          div.innerHTML = `
            <div class="cleaner-item-header">
              <div>
                <div class="cleaner-name">${c.name}</div>
                <div class="cleaner-tags">
                  ${c.email ? `<span class="cleaner-pill"><i class="fas fa-envelope"></i> ${c.email}</span>` : ''}
                  ${c.phone ? `<span class="cleaner-pill"><i class="fas fa-phone"></i> ${c.phone}</span>` : ''}
                  ${c.pin_code ? `<span class="cleaner-pill" style="background: #d1fae5; color: #059669; font-weight: 600;"><i class="fas fa-key"></i> PIN: ${c.pin_code}</span>` : ''}
                </div>
              </div>
              <button class="btn btn-ghost btn-xs" data-id="${c.id}" data-action="deleteCleaner">
                <i class="fas fa-trash"></i>
              </button>
            </div>
            ${c.notes ? `<div style="font-size:12px; color:var(--text-secondary); margin-top:4px;">${c.notes}</div>` : ''}
            ${taskUrl ? `<div style="font-size:12px; margin-top:8px;"><a href="${taskUrl}" target="_blank" style="color: #667eea; text-decoration: none;"><i class="fas fa-external-link-alt"></i> Lien d'acc√®s aux t√¢ches</a></div>` : ''}
            ${c.pin_code ? `<div style="font-size:12px; margin-top:4px; display:flex; gap:8px; flex-wrap:wrap;">
              <span style="color:var(--text-secondary);"><i class="fas fa-qrcode"></i> PIN: <strong>${c.pin_code}</strong></span>
            </div>` : ''}
          `;
          cleanerList.appendChild(div);
        });
      }

      function renderAssignments() {
         console.log('üîç RESERVATIONS:', RESERVATIONS);
  console.log('üîç PROPERTIES:', PROPERTIES);
  console.log('üîç assignments:', assignments);
        if (!assignContainer) return;

        // Initialisation du filtre logement (une seule fois, quand on a des donn√©es)
        if (!propertyFilterInitialized) {
          initReservationPropertyFilter();
        }

        if (!RESERVATIONS.length) {
          assignContainer.innerHTML = `
            <p class="text-secondary" style="font-size:13px;">
              Aucune r√©servation future d√©tect√©e. Les d√©parts appara√Ætront ici d√®s qu'ils seront synchronis√©s.
            </p>`;
          return;
        }

        const todayStr = new Date().toISOString().slice(0, 10);

        // R√©servations avec d√©part aujourd'hui ou plus tard
        const upcoming = (RESERVATIONS || [])
  .filter((r) => {
    if (!r.end) return false;

    const propertyId = getReservationPropertyId(r);
    if (!propertyId) return false;

    // Si un logement est s√©lectionn√©, on ne garde que celui-l√†
    if (
      selectedReservationPropertyFilter &&
      String(propertyId) !== String(selectedReservationPropertyFilter)
    ) {
      return false;
    }

    const endStr = String(r.end).slice(0, 10); // ‚ö†Ô∏è on garde le format AAAA-MM-JJ pour filtrer
          const endDateFr = formatDateFr(endStr);
    return endStr >= todayStr;
  })
  .sort((a, b) => {
    const aEnd = String(a.end).slice(0, 10);
    const bEnd = String(b.end).slice(0, 10);
    return aEnd.localeCompare(bEnd);
  });


        if (!upcoming.length) {
          assignContainer.innerHTML = `
            <p class="text-secondary" style="font-size:13px;">
              Aucune r√©servation future d√©tect√©e. Les d√©parts appara√Ætront ici d√®s qu'ils seront synchronis√©s.
            </p>`;
          return;
        }

        let html = '<div class="cleaning-cards-grid">';

     upcoming.forEach((r) => {
  const key = getReservationKey(r);
  const propertyId = getReservationPropertyId(r);
  const assignedId = getAssignedCleanerId(key, propertyId);
  const propertyName =
    r.propertyName ||
    (r.property && (r.property.name || r.property.title || r.property.label)) ||
    getPropertyNameById(propertyId);
  
  // ‚úÖ Utiliser les nouvelles fonctions helpers
  const guestName = window.cleanGuestName(r);
  const guestInitial = window.getGuestInitial(r);
  
  const endStr = String(r.end).slice(0, 10);
  const endDateFr = formatDateFr(endStr);
  
  html += `
    <div class="cleaning-card">
      <div class="cleaning-card-header">
        <h3 class="cleaning-card-title">${propertyName}</h3>
      </div>
      
      <div class="cleaning-card-body">
        <div class="cleaning-info-row date">
          <i class="fas fa-calendar-check"></i>
          <span>D√©part le ${endDateFr}</span>
        </div>
        
        <div class="cleaning-info-item">
          <div class="cleaning-info-label">Client</div>
          <div class="cleaning-info-value" style="display: flex; align-items: center; gap: 8px;">
            <span style="
              display: inline-flex;
              align-items: center;
              justify-content: center;
              width: 28px;
              height: 28px;
              border-radius: 50%;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              font-size: 12px;
              font-weight: 600;
              flex-shrink: 0;
            ">${guestInitial}</span>
            <span>${guestName || '-'}</span>
          </div>
        </div>
      </div>
      
      <div class="cleaning-card-footer">
        <select class="assign-select assign-select-card"
                data-reservation-key="${key || ''}"
                data-property-id="${propertyId || ''}">
          <option value="">Aucun</option>
          ${cleaners
            .map(
              (c) => `
            <option value="${c.id}" ${c.id === assignedId ? 'selected' : ''}>
              ${c.name || c.email || c.phone || c.id}
            </option>
          `
            )
            .join('')}
        </select>
        ${(assignedId && !assignments[key] && defaultCleanersMap[propertyId]) ? '<div style="font-size:10px; color:#059669; margin-top:3px; font-weight:600;"><i class="fas fa-star" style="font-size:8px;"></i> Cleaner r√©gulier</div>' : ''}
      </div>
    </div>
  `;
});
        html += '</div>';
        assignContainer.innerHTML = html;

        assignContainer.querySelectorAll('.assign-select').forEach((sel) => {
          sel.addEventListener('change', async (e) => {
            const select = e.target;
            const key = select.getAttribute('data-reservation-key');
            const propertyId = select.getAttribute('data-property-id') || null;
            const cleanerId = select.value;

            if (!key) return;

            if (cleanerId) {
              assignments[key] = cleanerId;
            } else {
              delete assignments[key];
            }
            saveLocalData();

            const token = localStorage.getItem('lcc_token');
            if (!token) return;

            try {
              await fetch(`${API_URL}/api/cleaning/assignments`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  Authorization: 'Bearer ' + token
                },
                body: JSON.stringify({
                  reservationKey: key,
                  propertyId,
                  cleanerId: cleanerId || null
                })
              });
            } catch (err) {
              console.error('Erreur sauvegarde assignation m√©nage', err);
            }
          });
        });
      }

      // Ajout d'un membre
      if (cleanerForm) {
        cleanerForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const name = document.getElementById('cleanerName').value.trim();
          const email = document.getElementById('cleanerEmail').value.trim();
          const phone = document.getElementById('cleanerPhone').value.trim();
          const notes = document.getElementById('cleanerNotes').value.trim();

          if (!name) return;

          const token = localStorage.getItem('lcc_token');
          if (!token) {
            alert('Session expir√©e, veuillez vous reconnecter');
            return;
          }

          try {
            const response = await fetch(`${API_URL}/api/cleaners`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: 'Bearer ' + token
              },
              body: JSON.stringify({
                name,
                email: email || null,
                phone: phone || null,
                notes: notes || null,
                isActive: true
              })
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.error || 'Erreur lors de la cr√©ation');
            }

            // Ajouter √† la liste locale
            cleaners.push(data.cleaner);
            
            cleanerForm.reset();
            renderCleaners();
            renderAssignments();
          } catch (err) {
            console.error('Erreur cr√©ation cleaner:', err);
            alert('Erreur lors de la cr√©ation: ' + err.message);
          }
        });
      }

      // Suppression d'un membre
      if (cleanerList) {
        cleanerList.addEventListener('click', async (e) => {
          const btn = e.target.closest('[data-action="deleteCleaner"]');
          if (!btn) return;

          const id = btn.getAttribute('data-id');
          
          if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette personne ?')) {
            return;
          }

          const token = localStorage.getItem('lcc_token');
          if (!token) {
            alert('Session expir√©e, veuillez vous reconnecter');
            return;
          }

          try {
            const response = await fetch(`${API_URL}/api/cleaners/${id}`, {
              method: 'DELETE',
              headers: {
                Authorization: 'Bearer ' + token
              }
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.error || 'Erreur lors de la suppression');
            }

            // Retirer de la liste locale
            cleaners = cleaners.filter((c) => c.id !== id);

            // On enl√®ve les assignations li√©es (maintenant par reservation_key)
            Object.keys(assignments).forEach((resKey) => {
              if (assignments[resKey] === id) {
                delete assignments[resKey];
              }
            });

            renderCleaners();
            renderAssignments();
          } catch (err) {
            console.error('Erreur suppression cleaner:', err);
            alert('Erreur lors de la suppression: ' + err.message);
          }
        });
      }

      // --------- PLANNING "IA" (brouillon) ---------
      function normalizeDateString(dateStr) {
        return dateStr ? dateStr.slice(0, 10) : null;
      }

      function getPropertyName(propertyId) {
        const p = PROPERTIES.find((x) => x.id === propertyId || x.propertyId === propertyId);
        return p ? p.name || p.title || p.label || propertyId : propertyId || 'Logement';
      }

      function getCleanerById(id) {
        return cleaners.find((c) => c.id === id) || null;
      }

      // ========== ONGLETS ==========
      function switchTab(tabId) {
        document.querySelectorAll('.cleaning-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.cleaning-tab-panel').forEach(p => p.classList.remove('active'));
        document.querySelector('[data-tab="' + tabId + '"]').classList.add('active');
        document.getElementById('panel-' + tabId).classList.add('active');
        if (tabId === 'checklists') loadChecklistsList();
        if (tabId === 'templates') loadTemplates();
        if (tabId === 'stats') loadStats();
      }
      window.switchTab = switchTab;

      // ========== CHECKLISTS ==========
      let allChecklists = [];
      async function loadChecklistsList() {
        try {
          const token = localStorage.getItem('lcc_token'); if (!token) return;
          const res = await fetch(API_URL + '/api/cleaning/checklists', { headers: { Authorization: 'Bearer ' + token } });
          if (!res.ok) throw new Error('err');
          const data = await res.json(); allChecklists = data.checklists || [];
          renderChecklistsList();
          const pending = allChecklists.filter(c => (c.owner_status || 'pending') === 'pending' && c.completed_at);
          const badge = document.getElementById('checklistsPendingBadge');
          if (pending.length > 0) { badge.textContent = pending.length; badge.style.display = 'inline-flex'; } else { badge.style.display = 'none'; }
        } catch (err) { console.error('Erreur checklists:', err); }
      }
      window.loadChecklistsList = loadChecklistsList;

      function renderChecklistsList() {
        const container = document.getElementById('checklistsList');
        const sf = document.getElementById('checklistStatusFilter')?.value || '';
        let filtered = sf ? allChecklists.filter(c => (c.owner_status || 'pending') === sf) : allChecklists;
        if (!filtered.length) { container.innerHTML = '<p class="text-secondary" style="font-size:13px;">Aucune checklist.</p>'; return; }
        const sL = { pending: '‚è≥ En attente', validated: '‚úÖ Valid√©', rejected: '‚ö†Ô∏è Rejet√©' };
        const sC = { pending: 'status-pending', validated: 'status-validated', rejected: 'status-rejected' };
        container.innerHTML = filtered.map(function(c) {
          var st = c.owner_status || 'pending', pn = getPropertyNameById(c.property_id) || c.property_id;
          var cd = c.checkout_date ? formatDateFr(String(c.checkout_date).slice(0,10)) : '';
          var dm = c.duration_seconds ? Math.round(c.duration_seconds / 60) : null;
          var ph = typeof c.photos === 'string' ? JSON.parse(c.photos) : (c.photos || []);
          return '<div class="checklist-item"><div class="checklist-item-header"><div class="checklist-item-property">' + pn + '</div><span class="checklist-item-status ' + sC[st] + '">' + sL[st] + '</span></div>'
            + '<div class="checklist-item-meta"><div class="checklist-item-meta-item"><i class="fas fa-calendar"></i> ' + cd + '</div>'
            + '<div class="checklist-item-meta-item"><i class="fas fa-user-check"></i> ' + (c.cleaner_name || 'N/A') + '</div>'
            + (dm ? '<div class="checklist-item-meta-item"><i class="fas fa-stopwatch"></i> ' + dm + ' min</div>' : '')
            + '<div class="checklist-item-meta-item"><i class="fas fa-camera"></i> ' + ph.length + ' photos</div></div>'
            + '<div class="checklist-item-actions"><button class="btn btn-ghost btn-sm" onclick="openChecklistDetail(' + c.id + ')"><i class="fas fa-eye"></i> D√©tails</button>'
            + (st === 'pending' ? '<button class="btn btn-sm btn-validate" onclick="validateChecklist(' + c.id + ')"><i class="fas fa-check"></i> Valider</button><button class="btn btn-sm btn-reject" onclick="rejectChecklist(' + c.id + ')"><i class="fas fa-undo"></i> Compl√©ment</button>' : '')
            + '</div></div>';
        }).join('');
      }
      window.renderChecklistsList = renderChecklistsList;

      async function openChecklistDetail(id) {
        try {
          var token = localStorage.getItem('lcc_token');
          var res = await fetch(API_URL + '/api/cleaning/checklists/' + id, { headers: { Authorization: 'Bearer ' + token } });
          if (!res.ok) throw new Error('err');
          var data = await res.json(); var c = data.checklist;
          var pn = getPropertyNameById(c.property_id) || c.property_id, st = c.owner_status || 'pending';
          var cd = c.checkout_date ? formatDateFr(String(c.checkout_date).slice(0,10)) : '', dm = c.duration_seconds ? Math.round(c.duration_seconds/60) : null;
          document.getElementById('detailPropertyName').textContent = pn;
          document.getElementById('detailSubtitle').textContent = 'D√©part le ' + cd + ' ‚Äî ' + (c.cleaner_name || 'N/A');
          document.getElementById('detailInfos').innerHTML = '<div style="display:flex;flex-wrap:wrap;gap:10px;font-size:13px;"><span style="padding:4px 10px;background:var(--bg-secondary);border-radius:8px;">üïê ' + (dm ? dm+' min':'Non mesur√©') + '</span><span style="padding:4px 10px;background:var(--bg-secondary);border-radius:8px;">' + (c.cleaner_name||'N/A') + '</span><span class="checklist-item-status ' + (st==='validated'?'status-validated':st==='rejected'?'status-rejected':'status-pending') + '">' + (st==='validated'?'‚úÖ Valid√©':st==='rejected'?'‚ö†Ô∏è Rejet√©':'‚è≥ En attente') + '</span></div>';
          var tasks = typeof c.tasks === 'string' ? JSON.parse(c.tasks) : (c.tasks || []);
          document.getElementById('detailTasks').innerHTML = tasks.map(function(t){ return '<div class="task-row-display"><div class="task-check-icon ' + (t.checked?'checked':'unchecked') + '"><i class="fas ' + (t.checked?'fa-check':'fa-times') + '"></i></div><span>' + (t.name||t.title||'T√¢che') + '</span></div>'; }).join('') || '<p class="text-secondary">Aucune t√¢che</p>';
          var photos = typeof c.photos === 'string' ? JSON.parse(c.photos) : (c.photos || []);
          document.getElementById('detailPhotos').innerHTML = photos.map(function(p,i){ return '<img src="' + p + '" alt="Photo" onclick="window.open(\'' + p + '\',\'_blank\')"/>'; }).join('') || '<p class="text-secondary">Aucune photo</p>';
          document.getElementById('detailNotesSection').style.display = (c.notes && c.notes.trim()) ? 'block' : 'none';
          if (c.notes) document.getElementById('detailNotes').textContent = c.notes;
          document.getElementById('detailOwnerNotesSection').style.display = (c.owner_notes && c.owner_notes.trim()) ? 'block' : 'none';
          if (c.owner_notes) document.getElementById('detailOwnerNotes').textContent = c.owner_notes;
          var footer = document.getElementById('detailFooter');
          footer.innerHTML = st === 'pending'
            ? '<button class="btn btn-validate" onclick="validateChecklist(' + c.id + ');closeChecklistDetail();"><i class="fas fa-check-circle"></i> Valider</button><button class="btn btn-reject" onclick="rejectChecklist(' + c.id + ');closeChecklistDetail();"><i class="fas fa-undo"></i> Compl√©ment</button>'
            : '<button class="btn btn-ghost" onclick="closeChecklistDetail()" style="width:100%;">Fermer</button>';
          document.getElementById('checklistDetailModal').classList.add('active');
          document.body.style.overflow = 'hidden';
        } catch (err) { console.error(err); alert('Erreur chargement'); }
      }
      window.openChecklistDetail = openChecklistDetail;
      function closeChecklistDetail() { document.getElementById('checklistDetailModal').classList.remove('active'); document.body.style.overflow = ''; }
      window.closeChecklistDetail = closeChecklistDetail;
      async function validateChecklist(id) { if (!confirm('Valider ce m√©nage ?')) return; try { var token = localStorage.getItem('lcc_token'); var res = await fetch(API_URL+'/api/cleaning/checklists/'+id+'/validate', { method:'PUT', headers:{'Content-Type':'application/json',Authorization:'Bearer '+token} }); if (!res.ok) throw new Error('err'); await loadChecklistsList(); } catch(e){ console.error(e); alert('Erreur'); } }
      window.validateChecklist = validateChecklist;
      async function rejectChecklist(id) { var notes = prompt('Message pour la personne de m√©nage :'); if (notes === null) return; try { var token = localStorage.getItem('lcc_token'); var res = await fetch(API_URL+'/api/cleaning/checklists/'+id+'/reject', { method:'PUT', headers:{'Content-Type':'application/json',Authorization:'Bearer '+token}, body:JSON.stringify({notes:notes||'Merci de compl√©ter'}) }); if (!res.ok) throw new Error('err'); await loadChecklistsList(); } catch(e){ console.error(e); alert('Erreur'); } }
      window.rejectChecklist = rejectChecklist;

      // ========== TEMPLATES ==========
      let allTemplates = [];
      var ROOM_DEFAULTS = { kitchen:{name:'Cuisine',color:'#f97316'}, bathroom:{name:'Salle de bain',color:'#06b6d4'}, bedroom:{name:'Chambre',color:'#8b5cf6'}, living:{name:'Salon',color:'#ec4899'}, terrace:{name:'Terrasse',color:'#84cc16'}, general:{name:'G√©n√©ral',color:'#6b7280'} };
      let editingTemplateTasks = [];
      async function loadTemplates() { try { var token = localStorage.getItem('lcc_token'); var res = await fetch(API_URL+'/api/cleaning/templates', { headers:{ Authorization:'Bearer '+token } }); if (!res.ok) throw new Error('err'); var data = await res.json(); allTemplates = data.templates || []; renderTemplates(); } catch(e){ console.error(e); } }
      function renderTemplates() {
        var c = document.getElementById('templatesList');
        if (!allTemplates.length) { c.innerHTML = '<p class="text-secondary" style="font-size:13px;">Aucun template. Cr√©ez-en un.</p>'; return; }
        c.innerHTML = allTemplates.map(function(t) { var tasks = typeof t.tasks === 'string' ? JSON.parse(t.tasks) : (t.tasks||[]); var pn = t.property_id ? getPropertyNameById(t.property_id) : 'Tous les logements';
          return '<div class="template-card"><div class="template-card-header"><div><div class="template-card-name">' + t.name + (t.is_default ? ' <span class="template-default-badge">Par d√©faut</span>' : '') + '</div><div class="template-card-property">' + pn + '</div></div><div style="display:flex;gap:6px;"><button class="btn btn-ghost btn-xs" onclick="editTemplate(' + t.id + ')"><i class="fas fa-edit"></i></button><button class="btn btn-ghost btn-xs" style="color:#dc2626;" onclick="deleteTemplate(' + t.id + ')"><i class="fas fa-trash"></i></button></div></div><div class="template-card-tasks-count">' + tasks.length + ' t√¢ches</div></div>';
        }).join('');
      }
      function openTemplateEditor(template) {
        document.getElementById('templateEditorSection').style.display = 'block';
        var sel = document.getElementById('templatePropertySelect'); sel.innerHTML = '<option value="">Tous les logements</option>';
        PROPERTIES.forEach(function(p) { var o = document.createElement('option'); o.value = p.id; o.textContent = p.name || p.id; sel.appendChild(o); });
        if (template) {
          document.getElementById('templateEditorTitle').innerHTML = '<i class="fas fa-edit"></i> Modifier';
          document.getElementById('templateName').value = template.name; document.getElementById('templatePropertySelect').value = template.property_id || '';
          document.getElementById('templateIsDefault').checked = template.is_default; document.getElementById('editingTemplateId').value = template.id;
          editingTemplateTasks = typeof template.tasks === 'string' ? JSON.parse(template.tasks) : (template.tasks ? JSON.parse(JSON.stringify(template.tasks)) : []);
        } else {
          document.getElementById('templateEditorTitle').innerHTML = '<i class="fas fa-plus"></i> Nouveau template';
          document.getElementById('templateName').value = 'Template m√©nage'; document.getElementById('templatePropertySelect').value = '';
          document.getElementById('templateIsDefault').checked = false; document.getElementById('editingTemplateId').value = '';
          editingTemplateTasks = [{id:'k1',name:'Nettoyer le plan de travail',room:'kitchen'},{id:'k2',name:'Nettoyer l\'√©vier',room:'kitchen'},{id:'k3',name:'Vider la poubelle',room:'kitchen'},{id:'k4',name:'Laver le sol',room:'kitchen'},{id:'b1',name:'Nettoyer la douche',room:'bathroom'},{id:'b2',name:'Nettoyer les WC',room:'bathroom'},{id:'b3',name:'Serviettes propres',room:'bathroom'},{id:'c1',name:'Changer les draps',room:'bedroom'},{id:'c2',name:'Faire le lit',room:'bedroom'},{id:'c3',name:'Passer l\'aspirateur',room:'bedroom'},{id:'l1',name:'Passer l\'aspirateur',room:'living'},{id:'g1',name:'V√©rifier les lumi√®res',room:'general'},{id:'g2',name:'Fermer les fen√™tres',room:'general'}];
        }
        renderTemplateTasksEditor(); document.getElementById('templateEditorSection').scrollIntoView({ behavior: 'smooth' });
      }
      window.openTemplateEditor = openTemplateEditor;
      function closeTemplateEditor() { document.getElementById('templateEditorSection').style.display = 'none'; }
      window.closeTemplateEditor = closeTemplateEditor;
      function renderTemplateTasksEditor() {
        var c = document.getElementById('templateTasksEditor'), byRoom = {};
        editingTemplateTasks.forEach(function(t) { var r = t.room || 'general'; if (!byRoom[r]) byRoom[r] = []; byRoom[r].push(t); });
        var html = '';
        ['kitchen','bathroom','bedroom','living','terrace','general'].forEach(function(rk) {
          var rt = byRoom[rk] || [], cfg = ROOM_DEFAULTS[rk];
          html += '<div class="template-room-section"><div class="template-room-header"><div class="room-dot" style="background:' + cfg.color + '"></div> ' + cfg.name + ' (' + rt.length + ')</div>';
          rt.forEach(function(t) { html += '<div class="template-task-row" data-task-id="' + t.id + '"><input type="text" value="' + (t.name||'').replace(/"/g,'&quot;') + '" onchange="updateTemplateTask(\'' + t.id + '\', this.value)"/><button class="btn-delete-task" onclick="deleteTemplateTask(\'' + t.id + '\')"><i class="fas fa-times"></i></button></div>'; });
          html += '<button class="btn-add-task" onclick="addTemplateTask(\'' + rk + '\')"><i class="fas fa-plus"></i> Ajouter</button></div>';
        });
        c.innerHTML = html;
      }
      function updateTemplateTask(tid, v) { var t = editingTemplateTasks.find(function(x){return x.id===tid;}); if (t) t.name = v; }
      window.updateTemplateTask = updateTemplateTask;
      function deleteTemplateTask(tid) { editingTemplateTasks = editingTemplateTasks.filter(function(t){return t.id!==tid;}); renderTemplateTasksEditor(); }
      window.deleteTemplateTask = deleteTemplateTask;
      function addTemplateTask(room) { var id = 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2,5); editingTemplateTasks.push({id:id,name:'',room:room}); renderTemplateTasksEditor(); setTimeout(function(){ var r = document.querySelector('[data-task-id="'+id+'"] input'); if(r) r.focus(); }, 50); }
      window.addTemplateTask = addTemplateTask;
      async function saveTemplate() {
        document.querySelectorAll('.template-task-row').forEach(function(row) { var tid = row.dataset.taskId, inp = row.querySelector('input[type="text"]'); if (tid && inp) { var t = editingTemplateTasks.find(function(x){return x.id===tid;}); if (t) t.name = inp.value; } });
        var valid = editingTemplateTasks.filter(function(t){return t.name && t.name.trim();}); if (!valid.length) { alert('Ajoutez au moins une t√¢che'); return; }
        var tid = document.getElementById('editingTemplateId').value || null;
        var payload = { name: document.getElementById('templateName').value || 'Template m√©nage', propertyId: document.getElementById('templatePropertySelect').value || null, isDefault: document.getElementById('templateIsDefault').checked, tasks: valid };
        if (tid) payload.templateId = parseInt(tid);
        try { var token = localStorage.getItem('lcc_token'); var res = await fetch(API_URL+'/api/cleaning/templates', { method:'POST', headers:{'Content-Type':'application/json',Authorization:'Bearer '+token}, body:JSON.stringify(payload) }); if (!res.ok) throw new Error('err'); closeTemplateEditor(); await loadTemplates(); } catch(e){ console.error(e); alert('Erreur sauvegarde'); }
      }
      window.saveTemplate = saveTemplate;
      function editTemplate(id) { var t = allTemplates.find(function(x){return x.id===id;}); if (t) openTemplateEditor(t); }
      window.editTemplate = editTemplate;
      async function deleteTemplate(id) { if (!confirm('Supprimer ?')) return; try { var token = localStorage.getItem('lcc_token'); await fetch(API_URL+'/api/cleaning/templates/'+id, { method:'DELETE', headers:{Authorization:'Bearer '+token} }); await loadTemplates(); } catch(e){ console.error(e); alert('Erreur'); } }
      window.deleteTemplate = deleteTemplate;

      // ========== STATISTIQUES ==========
      async function loadStats() {
        try { var token = localStorage.getItem('lcc_token'), period = document.getElementById('statsPeriod')?.value || 'month';
          var res = await fetch(API_URL+'/api/cleaning/stats?period='+period, { headers:{Authorization:'Bearer '+token} }); if (!res.ok) throw new Error('err');
          var data = await res.json(), s = data.stats;
          document.getElementById('statTotal').textContent = s.total; document.getElementById('statValidated').textContent = s.validated;
          document.getElementById('statPending').textContent = s.pending; document.getElementById('statRejected').textContent = s.rejected;
          document.getElementById('statAvgDuration').textContent = s.avgDurationMin ? s.avgDurationMin + ' min' : '‚Äî';
          document.getElementById('statValidationRate').textContent = s.validationRate + '%';
          var ct = document.getElementById('statsCleanerTable');
          ct.innerHTML = (s.byCleaner && s.byCleaner.length) ? '<table class="assign-table"><thead><tr><th>Nom</th><th>Total</th><th>Dur√©e moy.</th><th>Valid√©s</th></tr></thead><tbody>' + s.byCleaner.map(function(c){return '<tr><td>'+(c.cleaner_name||'N/A')+'</td><td>'+c.total+'</td><td>'+(c.avg_duration_min?c.avg_duration_min+' min':'‚Äî')+'</td><td>'+(c.validated||0)+'</td></tr>';}).join('') + '</tbody></table>' : '<p class="text-secondary" style="font-size:13px;">Aucune donn√©e</p>';
          var pt = document.getElementById('statsPropertyTable');
          pt.innerHTML = (s.byProperty && s.byProperty.length) ? '<table class="assign-table"><thead><tr><th>Logement</th><th>Total</th><th>Dur√©e moy.</th></tr></thead><tbody>' + s.byProperty.map(function(p){return '<tr><td>'+(p.property_name||p.property_id)+'</td><td>'+p.total+'</td><td>'+(p.avg_duration_min?p.avg_duration_min+' min':'‚Äî')+'</td></tr>';}).join('') + '</tbody></table>' : '<p class="text-secondary" style="font-size:13px;">Aucune donn√©e</p>';
        } catch(e){ console.error('Stats error:', e); }
      }
      window.loadStats = loadStats;

      // ========== QR CODE ==========
      async function openQrModal(propertyId) {
        var modal = document.getElementById('qrModal'), content = document.getElementById('qrModalContent');
        content.innerHTML = '<p class="text-secondary">Chargement‚Ä¶</p>'; modal.classList.add('active'); document.body.style.overflow = 'hidden';
        try { var token = localStorage.getItem('lcc_token');
          var res = await fetch(API_URL+'/api/cleaning/qr/'+propertyId, { headers:{Authorization:'Bearer '+token} }); if (!res.ok) throw new Error('err');
          var data = await res.json();
          content.innerHTML = '<div style="margin-bottom:12px;"><strong>' + data.propertyName + '</strong>' + (data.cleanerName ? '<br/><span style="font-size:13px;color:var(--text-secondary);">Assign√© √† : ' + data.cleanerName + '</span>' : '') + '</div>'
            + '<div id="qrCanvas" style="margin:16px auto;"></div>'
            + '<div class="qr-modal-url">' + data.qrUrl + '</div>'
            + '<div style="margin-top:12px;display:flex;gap:8px;justify-content:center;"><button class="btn btn-primary btn-sm" onclick="copyToClipboard(\'' + data.qrUrl.replace(/'/g,"\\'") + '\')"><i class="fas fa-copy"></i> Copier le lien</button></div>'
            + '<p style="font-size:12px;color:var(--text-secondary);margin-top:12px;">Imprimez ce QR code et collez-le dans le logement.</p>';
          var qrImg = document.createElement('img'); qrImg.src = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(data.qrUrl);
          qrImg.style.cssText = 'max-width:200px;margin:0 auto;display:block;'; document.getElementById('qrCanvas').appendChild(qrImg);
        } catch(e){ console.error(e); content.innerHTML = '<p style="color:#dc2626;">Erreur</p>'; }
      }
      window.openQrModal = openQrModal;
      function closeQrModal() { document.getElementById('qrModal').classList.remove('active'); document.body.style.overflow = ''; }
      window.closeQrModal = closeQrModal;
      function copyToClipboard(text) { navigator.clipboard.writeText(text).then(function(){alert('Lien copi√© !');}).catch(function(){ var inp = document.createElement('input'); inp.value = text; document.body.appendChild(inp); inp.select(); document.execCommand('copy'); document.body.removeChild(inp); alert('Copi√© !'); }); }
      window.copyToClipboard = copyToClipboard;

      // Init
      (async function initCleaningPage() {
        loadLocalData();
        await loadRemoteData();
        await Promise.all([
          loadAssignmentsFromApi(),
          loadDefaultCleanersMap()
        ]);
        renderCleaners();
        renderAssignments();
        // Charger les checklists en arri√®re-plan pour le badge
        loadChecklistsList();
      })();
    });
  </script>
<!-- MOBILE MENU SCRIPT -->
<script>
    (function() {
      const menuBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      
      if (menuBtn && sidebar && overlay) {
        menuBtn.addEventListener('click', function() {
          sidebar.classList.toggle('active');
          overlay.classList.toggle('active');
          
          const icon = menuBtn.querySelector('i');
          if (sidebar.classList.contains('active')) {
            icon.classList.remove('fa-bars');
            icon.classList.add('fa-times');
          } else {
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
          }
        });
        
        overlay.addEventListener('click', function() {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          const icon = menuBtn.querySelector('i');
          icon.classList.remove('fa-times');
          icon.classList.add('fa-bars');
        });
        
        if (window.innerWidth <= 1024) {
          document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
              sidebar.classList.remove('active');
              overlay.classList.remove('active');
              const icon = menuBtn.querySelector('i');
              icon.classList.remove('fa-times');
              icon.classList.add('fa-bars');
            });
          });
        }
      }
    })();
    
    (function() {
      const currentPage = document.body.getAttribute('data-page');
      if (currentPage) {
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.remove('active');
        });
        const activeLink = document.querySelector('.nav-item[data-page="cleaning"]');
        if (activeLink) {
          activeLink.classList.add('active');
        }
      }
    })();
    
    //     document.getElementById('logoutBtn')?.addEventListener('click', function() {
    //       localStorage.removeItem('lcc_token');
    //       localStorage.removeItem('lcc_user');
    //       window.location.href = '/login.html';
    //     });
    
    //     (function() {
    //       const user = JSON.parse(localStorage.getItem('lcc_user') || '{}');
    //       if (user.firstName) {
    //         const nameEl = document.getElementById('sidebarUserName');
    //         const avatarEl = document.getElementById('sidebarUserAvatar');
    //         if (nameEl) nameEl.textContent = user.firstName + ' ' + (user.lastName || '');
    //         if (avatarEl) avatarEl.textContent = user.firstName.charAt(0).toUpperCase();
    //       }
    //       if (user.company) {
    //         const companyEl = document.getElementById('sidebarUserCompany');
    //         if (companyEl) companyEl.textContent = user.company;
    //       }
    //     })();
  </script>
<script src="/js/bh-layout.js"></script>
<script src="/js/mobile-native-experience.js"></script>
<script src="/js/mobile-tabs-handler.js"></script>
<script src="/js/messages-badge-desktop-mobile.js"></script>
<!-- Socket.io pour le temps r√©el -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>    
</body>
</html>
