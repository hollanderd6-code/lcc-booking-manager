<!DOCTYPE html>

<html data-theme="light" lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Boostinghost ‚Äì Gestion du m√©nage</title>
<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>
<!-- CSS plateforme globale -->
<link href="/css/style.css" rel="stylesheet"/><link href="/css/bh-shared.css?v=1" rel="stylesheet"/><link href="/css/bottom-bar-enhanced.css" rel="stylesheet"/><link href="/css/menu-plus-fixes.css" rel="stylesheet"/><link href="/css/menu-active-button.css" rel="stylesheet"/>
<link href="/css/messages-badge-fix.css" rel="stylesheet"/>
<link href="/css/cleaning-cards-style.css" rel="stylesheet"/>
<style>
    html, body {
      margin: 0 !important;
      padding: 0 !important;
    }

    .app-container {
      margin-top: 0 !important;
    }

    .main-content {
      padding-top: 24px !important;
      margin-top: 0 !important;
    }

    .page-content {
      margin-top: 0 !important;
    }

    html {
      scroll-behavior: smooth;
    }

    /* Mise en page sp√©cifique m√©nage */
    .cleaning-page-grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
      gap: var(--spacing-xl);
      margin-bottom: var(--spacing-xl);
    }

    @media (max-width: 1024px) {
      .cleaning-page-grid {
        grid-template-columns: 1fr;
      }
    }

    .cleaner-list {
      margin-top: var(--spacing-md);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .cleaner-item {
      padding: var(--spacing-md);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .cleaner-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .cleaner-name {
      font-weight: 600;
    }

    .cleaner-tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .cleaner-pill {
      padding: 2px 8px;
      border-radius: var(--radius-full);
      border: 1px solid var(--border-color);
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .cleaner-actions {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .btn-xs {
      padding: 4px 8px;
      font-size: 11px;
    }

    /* Assignation logements */
    table.assign-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    table.assign-table th,
    table.assign-table td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border-color);
      text-align: left;
    }

    table.assign-table th {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-tertiary);
    }

    .assign-select {
      width: 100%;
      padding: 6px 8px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      font-size: 13px;
    }

    .assign-hint {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-sm);
    }

    /* Planning IA m√©nage */
    .planning-controls {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .planning-controls input[type="date"] {
      padding: 8px 10px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      font-size: 14px;
    }

    .planning-hint {
      font-size: 12px;
      color: var(--text-secondary);
    }

    table.planning-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: var(--spacing-sm);
    }

    table.planning-table th,
    table.planning-table td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border-color);
      text-align: left;
      vertical-align: top;
    }

    table.planning-table th {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-tertiary);
    }

    .planning-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 11px;
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
    }

    .planning-tag i {
      font-size: 11px;
    }

    .planning-empty {
      font-size: 13px;
      color: var(--text-secondary);
      padding: 8px 0;
    }

    .badge-type {
      display: inline-block;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 11px;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      margin-left: 6px;
    }

    .badge-cleaner {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 11px;
      background: var(--primary-light);
      color: var(--primary-color);
    }

    /* Petites utilitaires */
    .text-secondary {
      color: var(--text-secondary);
    }

    /* ========== HEADER DASHBOARD MODERNE (comme app.html) ========== */

    .main-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      padding: 18px 20px;
      margin-bottom: 20px;
      border-radius: 20px;
      background: linear-gradient(
        135deg,
        rgba(15, 23, 42, 0.98),
        rgba(15, 23, 42, 0.92)
      );
      border: 1px solid rgba(148, 163, 184, 0.45);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.7);
    }

    [data-theme="light"] .main-header {
      background: linear-gradient(135deg, #f9fafb, #eff6ff);
      border-color: rgba(148, 163, 184, 0.4);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.06);
    }

    .header-left {
      max-width: 60%;
    }

    .page-kicker {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: #9ca3af;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .page-title {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    .page-subtitle {
      margin-top: 6px;
      font-size: 13px;
      color: #9ca3af;
    }

    [data-theme="light"] .page-subtitle {
      color: #6b7280;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-ghost {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: transparent;
      padding-inline: 14px;
    }

    .btn-ghost:hover {
      background: rgba(15, 23, 42, 0.06);
    }

    [data-theme="dark"] .btn-ghost:hover {
      background: rgba(15, 23, 42, 0.9);
    }

    @media (max-width: 768px) {
      .main-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-left {
        max-width: 100%;
      }
    }
    /* ===== INPUTS MODERNES - STYLE UNIFI√â ===== */
    
    /* Override des styles globaux pour cette page */
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="tel"],
    input[type="number"],
    input[type="url"],
    input[type="date"],
    input[type="time"],
    textarea,
    select {
      width: 100%;
      padding: 12px 16px !important;
      font-size: 15px !important;
      font-weight: 400 !important;
      line-height: 1.5 !important;
      color: var(--text-primary) !important;
      background-color: #ffffff !important;
      border: 1.5px solid #e5e7eb !important;
      border-radius: 8px !important;
      transition: all 0.15s ease !important;
      font-family: 'Inter', sans-serif !important;
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      appearance: none !important;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="password"]:focus,
    input[type="tel"]:focus,
    input[type="number"]:focus,
    input[type="url"]:focus,
    input[type="date"]:focus,
    input[type="time"]:focus,
    textarea:focus,
    select:focus {
      outline: none !important;
      border-color: var(--primary-color) !important;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
      background-color: #ffffff !important;
    }

    input[type="text"]:hover:not(:focus),
    input[type="email"]:hover:not(:focus),
    input[type="password"]:hover:not(:focus),
    input[type="tel"]:hover:not(:focus),
    input[type="number"]:hover:not(:focus),
    input[type="url"]:hover:not(:focus),
    input[type="date"]:hover:not(:focus),
    input[type="time"]:hover:not(:focus),
    textarea:hover:not(:focus),
    select:hover:not(:focus) {
      border-color: #d1d5db !important;
    }

    input::placeholder,
    textarea::placeholder {
      color: #9ca3af !important;
      opacity: 1 !important;
    }

    /* Labels plus modernes */
    label {
      display: block;
      font-size: 14px !important;
      font-weight: 600 !important;
      color: var(--text-primary) !important;
      margin-bottom: 8px !important;
    }

    /* Form groups avec espacement */
    .form-group {
      margin-bottom: 20px;
    }

    /* Select avec ic√¥ne */
    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E") !important;
      background-position: right 12px center !important;
      background-repeat: no-repeat !important;
      background-size: 20px !important;
      padding-right: 40px !important;
    }

    /* Textarea */
    textarea {
      min-height: 100px !important;
      resize: vertical !important;
    }

    /* Disabled state */
    input:disabled,
    textarea:disabled,
    select:disabled {
      background-color: #f3f4f6 !important;
      color: #9ca3af !important;
      cursor: not-allowed !important;
      opacity: 0.6 !important;
    }

    /* Boutons modernes */
    .btn-primary,
    .btn-action,
    button[type="submit"] {
      padding: 12px 24px !important;
      font-size: 15px !important;
      font-weight: 600 !important;
      border-radius: 8px !important;
      transition: all 0.15s ease !important;
      border: none !important;
    }

    .btn-primary:hover,
    .btn-action:hover,
    button[type="submit"]:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2) !important;
    }

    .btn-secondary {
      padding: 10px 20px !important;
      font-size: 14px !important;
      font-weight: 600 !important;
      border-radius: 8px !important;
      transition: all 0.15s ease !important;
    }

    .btn-secondary:hover {
      transform: translateY(-1px) !important;
    }

    /* Boutons d'action dans les listes */
    .btn-sm {
      padding: 8px 14px !important;
      font-size: 13px !important;
      border-radius: 6px !important;
      transition: all 0.15s ease !important;
    }

    .btn-sm:hover {
      transform: translateY(-1px) !important;
    }

    /* Messages d'erreur/succ√®s */
    .error-message {
      color: #dc2626;
      font-size: 13px;
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .success-message {
      color: #059669;
      font-size: 13px;
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Card sections plus espac√©es */
    .card {
      padding: 28px !important;
      border-radius: 12px !important;
    }

    .card h2 {
      margin-bottom: 24px !important;
    }

    /* Checkbox modernes */
    input[type="checkbox"] {
      width: 20px !important;
      height: 20px !important;
      border: 2px solid #d1d5db !important;
      border-radius: 4px !important;
      cursor: pointer !important;
      transition: all 0.15s ease !important;
    }

    input[type="checkbox"]:checked {
      background-color: var(--primary-color) !important;
      border-color: var(--primary-color) !important;
    }

    input[type="checkbox"]:hover {
      border-color: var(--primary-color) !important;
    }

    /* Upload de fichier moderne */
    input[type="file"] {
      padding: 10px !important;
      border: 2px dashed #d1d5db !important;
      background: #f9fafb !important;
      cursor: pointer !important;
      border-radius: 8px !important;
    }

    input[type="file"]:hover {
      border-color: var(--primary-color) !important;
      background: #f0fdf4 !important;
    }

    /* Modals avec inputs modernes */
    .modal input[type="text"],
    .modal input[type="email"],
    .modal input[type="tel"],
    .modal input[type="date"],
    .modal textarea,
    .modal select {
      margin-bottom: 16px;
    }

    /* Espacement des formulaires dans les modals */
    .modal .form-group:last-child {
      margin-bottom: 0;
    }
  </style>
<script src="/js/auth-fetch.js"></script>
<link rel="stylesheet" href="/css/mobile-native-styles.css">
</head>
<body data-back-href="/app.html" data-back-label="Retour au dashboard" data-kicker="Gestion" data-page="cleaning" data-subtitle="Assignez-la √† vos logements et g√©n√©rez un planning intelligent." data-title="Gestion du m√©nage">
<!-- MOBILE HEADER -->
<div class="mobile-header">
<a class="mobile-logo" href="/app.html">
<i class="fas fa-calendar-check"></i>
<span class="mobile-logo-text">Bookingmanage</span>
</a>
<button class="mobile-menu-btn" id="mobileMenuBtn">
<i class="fas fa-bars"></i>
</button>
</div>
<div class="sidebar-overlay" id="sidebarOverlay"></div>
<div class="app-container">
<!-- Sidebar -->
<div id="bhSidebar"></div>
<!-- Main -->
<main class="main-content"><div id="bhHeader"></div>
<!-- Header -->

<!-- Contenu -->
<div class="page-content">
<!-- Grid √©quipe + assignation -->
<section class="cleaning-page-grid">
<!-- Colonne gauche : √©quipe m√©nage -->
<section class="card">
<div class="card-header">
<div class="card-title">
<i class="fas fa-users"></i>
                √âquipe de m√©nage
              </div>
</div>
<form class="form-grid" id="cleanerForm">
<div class="form-row">
<label for="cleanerName">Nom &amp; pr√©nom</label>
<input id="cleanerName" required="" type="text"/>
</div>
<div class="form-row">
<label for="cleanerEmail">E-mail</label>
<input id="cleanerEmail" placeholder="exemple@mail.com" type="email"/>
</div>
<div class="form-row">
<label for="cleanerPhone">T√©l√©phone</label>
<input id="cleanerPhone" placeholder="+33 6 00 00 00 00" type="tel"/>
</div>
<div class="form-row">
<label for="cleanerNotes">Notes / zone d'intervention</label>
<textarea id="cleanerNotes" placeholder="Ex : intervient uniquement sur les appartements du centre-ville" rows="2"></textarea>
</div>
<div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
<button class="btn btn-primary" type="submit">
<i class="fas fa-user-plus"></i>
                  Ajouter √† l'√©quipe
                </button>
</div>
</form>
<hr style="margin:16px 0; border:none; border-top:1px solid var(--border-color);"/>
<div>
<div class="text-secondary" style="font-size:13px; margin-bottom:8px;">
                Membres de l'√©quipe
              </div>
<div class="cleaner-list" id="cleanerList">
<p class="text-secondary" style="font-size:13px;">
                  Aucun membre pour l'instant. Ajoutez votre premi√®re personne de m√©nage.
                </p>
</div>
</div>
</section>
<!-- Colonne droite : assignation par r√©servation -->
<section class="card">
<div class="card-header">
<div class="card-title">
<i class="fas fa-broom"></i>
                Assignation par r√©servation
              </div>
</div>
<p class="assign-hint">
              Assignez une personne de m√©nage √† chaque d√©part de r√©servation. 
              Ces assignations seront visibles dans le dashboard et dans le calendrier.
            </p>
<!-- Filtre par logement -->
<div class="cleaning-filter-row" style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
<label for="reservationPropertyFilter" style="font-size:13px;">
                Filtrer par logement :
              </label>
<select class="assign-select" id="reservationPropertyFilter" style="max-width:260px;">
<option value="">Tous les logements</option>
</select>
</div>
<div id="assignContainer">
<p class="text-secondary" style="font-size:13px;">
                Chargement des r√©servations‚Ä¶
              </p>
</div>
</section>
</section>
</div>
</main>
</div>
<!-- Scripts -->
<script>
    // Auth / user (m√™me logique que app.html)
    (function () {
      const token = localStorage.getItem('lcc_token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      const rawUser = localStorage.getItem('lcc_user');
      let user = null;

      try {
        user = rawUser ? JSON.parse(rawUser) : null;
      } catch (e) {
        console.error('Impossible de lire lcc_user', e);
      }

      if (user) {
        const nameEl = document.getElementById('sidebarUserName');
        const companyEl = document.getElementById('sidebarUserCompany');
        const avatarEl = document.getElementById('sidebarUserAvatar');

        if (nameEl) {
          nameEl.textContent = user.firstName
            ? user.firstName + (user.lastName ? ' ' + user.lastName : '')
            : (user.email || 'Mon compte');
        }

        if (companyEl) {
          companyEl.textContent = user.company || 'Mon espace';
        }

        if (avatarEl) {
          const initial = (user.firstName || user.email || '?').trim()[0] || 'U';
          avatarEl.textContent = initial.toUpperCase();
        }
      }

      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function () {
          localStorage.removeItem('lcc_token');
          localStorage.removeItem('lcc_user');
          window.location.href = '/login.html';
        });
      }
    })();

    // --------------------------
    // GESTION EQUIPE + ASSIGNATION + PLANNING
    // --------------------------
    document.addEventListener('DOMContentLoaded', () => {
      // NOUVELLE FONCTION : Formater une date YYYY-MM-DD en DD/MM/YYYY
      function formatDateFr(dateStr) {
        if (!dateStr) return '';
        const parts = dateStr.split('-');
        if (parts.length !== 3) return dateStr;
        const [year, month, day] = parts;
        return `${day}/${month}/${year}`;
      }
      const API_URL = 'https://lcc-booking-manager.onrender.com';
      const STORAGE_CLEANERS = 'lcc_cleaners';
      const STORAGE_ASSIGN = 'lcc_cleaning_assignments';

      let PROPERTIES = [];
      let RESERVATIONS = [];

      let cleaners = [];
      let assignments = {};

      // Filtre logement
      let selectedReservationPropertyFilter = '';
      let propertyFilterInitialized = false;

      const cleanerForm = document.getElementById('cleanerForm');
      const cleanerList = document.getElementById('cleanerList');
      const assignContainer = document.getElementById('assignContainer');
      
function formatDateFr(dateStr) {
  if (!dateStr) return '';
  const parts = dateStr.split('-');
  if (parts.length !== 3) return dateStr;
  const [year, month, day] = parts;
  return `${day}/${month}/${year}`;
}
      function loadLocalData() {
        try {
          // Les cleaners sont maintenant charg√©s depuis l'API dans loadRemoteData()
          // On garde seulement les assignations en localStorage pour la compatibilit√©
          assignments = JSON.parse(localStorage.getItem(STORAGE_ASSIGN)) || {};
        } catch (e) {
          assignments = {};
        }
      }

      function saveLocalData() {
        // On ne sauvegarde plus les cleaners en localStorage
        // Ils sont maintenant g√©r√©s uniquement via l'API
        localStorage.setItem(STORAGE_ASSIGN, JSON.stringify(assignments));
      }

      // Charge les assignations m√©nage depuis le backend et les injecte dans "assignments"
      async function loadAssignmentsFromApi() {
  try {
    const token = localStorage.getItem('lcc_token');
    if (!token) return;

    const res = await fetch(`${API_URL}/api/cleaning/assignments`, {
      headers: {
        Authorization: 'Bearer ' + token
      }
    });

    if (!res.ok) {
      console.warn('Erreur lors du chargement des assignations m√©nage', res.status);
      return;
    }

    const data = await res.json();
    const apiMap = {};

    // On reconstruit une map √† partir de ce que renvoie l'API
    (data.assignments || []).forEach((row) => {
      const key = row.reservation_key;

      if (key && row.cleaner_id) {
        apiMap[key] = row.cleaner_id;
      }
    });

    const apiKeys = Object.keys(apiMap);

    if (apiKeys.length > 0) {
      // ‚úÖ On FUSIONNE les assignations API avec les locales
      // Les donn√©es API prennent le dessus si conflit
      assignments = Object.assign({}, assignments, apiMap);
      saveLocalData();
    } else {
      // ‚úÖ Aucune assignation retourn√©e ‚Üí on NE TOUCHE PAS aux assignations locales
      console.log("‚ÑπÔ∏è Aucune assignation m√©nage renvoy√©e par l'API, on garde les assignations locales.");
    }
  } catch (e) {
    console.error('Erreur loadAssignmentsFromApi()', e);
    // En cas d'erreur r√©seau, on ne touche pas non plus aux assignations locales
  }
}


      async function loadRemoteData() {
        try {
          const token = localStorage.getItem('lcc_token');
          if (!token) return;

          // Charger les r√©servations et propri√©t√©s
          const response = await fetch(`${API_URL}/api/reservations`, {
            headers: {
              Authorization: 'Bearer ' + token
            }
          });

          if (!response.ok) {
            console.warn('Erreur lors du chargement des r√©servations pour le m√©nage', response.status);
            return;
          }

          const data = await response.json().catch(() => ({}));

          RESERVATIONS = Array.isArray(data.reservations) ? data.reservations : [];
          PROPERTIES = Array.isArray(data.properties) ? data.properties : [];

          // Charger les cleaners depuis l'API
          const cleanersResponse = await fetch(`${API_URL}/api/cleaners`, {
            headers: {
              Authorization: 'Bearer ' + token
            }
          });

          if (cleanersResponse.ok) {
            const cleanersData = await cleanersResponse.json().catch(() => ({}));
            if (Array.isArray(cleanersData.cleaners)) {
              cleaners = cleanersData.cleaners;
            }
          }

          // Fallback de d√©mo si aucune propri√©t√©
          if (!PROPERTIES.length) {
            PROPERTIES = [
              { id: 'apt-demo-1', name: 'Appartement d√©mo 1' },
              { id: 'apt-demo-2', name: 'Appartement d√©mo 2' }
            ];
          }
        } catch (e) {
          console.error('Erreur loadRemoteData()', e);
          if (!PROPERTIES.length) {
            PROPERTIES = [
              { id: 'apt-demo-1', name: 'Appartement d√©mo 1' },
              { id: 'apt-demo-2', name: 'Appartement d√©mo 2' }
            ];
          }
        }
      }

      function getReservationKey(reservation) {
  if (!reservation || !reservation.start || !reservation.end) return null;
  
  const propertyId = getReservationPropertyId(reservation);
  if (!propertyId) return null;
  
  const startStr = String(reservation.start).slice(0, 10);
  const endStr = String(reservation.end).slice(0, 10);
  return `${propertyId}_${startStr}_${endStr}`;
}

      function getPropertyNameById(propertyId) {
        if (!propertyId) return 'Logement';
        const p = PROPERTIES.find(
          (x) =>
            String(x.id) === String(propertyId) ||
            String(x.propertyId) === String(propertyId)
        );
        return p ? (p.name || p.title || p.label || propertyId) : propertyId;
      }

      function getReservationPropertyId(r) {
        if (!r) return null;
        if (r.propertyId != null) return String(r.propertyId);
        if (r.property && r.property.id != null) return String(r.property.id);
        if (r.property_id != null) return String(r.property_id);
        return null;
      }

      function initReservationPropertyFilter() {
        const select = document.getElementById('reservationPropertyFilter');
        if (!select) return;

        const previousValue = selectedReservationPropertyFilter;

        // Reset de base
        select.innerHTML = '<option value="">Tous les logements</option>';

        const alreadyAdded = new Set();

        // On se base sur PROPERTIES pour remplir la liste
        if (Array.isArray(PROPERTIES)) {
          PROPERTIES.forEach((p) => {
            const id = p.id != null ? p.id : p.propertyId;
            if (!id) return;
            const idStr = String(id);
            if (alreadyAdded.has(idStr)) return;
            alreadyAdded.add(idStr);

            const opt = document.createElement('option');
            opt.value = idStr;
            opt.textContent = p.name || p.title || p.label || ('Logement ' + idStr);
            select.appendChild(opt);
          });
        }

        // Restaure la s√©lection pr√©c√©dente si possible
        if (previousValue) {
          select.value = previousValue;
        }

        select.onchange = (e) => {
          selectedReservationPropertyFilter = e.target.value || '';
          renderAssignments();
        };

        propertyFilterInitialized = true;
      }

      function renderCleaners() {
        if (!cleanerList) return;
        if (!cleaners.length) {
          cleanerList.innerHTML = '<p class="text-secondary" style="font-size:13px;">Aucun membre pour l\'instant. Ajoutez votre premi√®re personne de m√©nage.</p>';
          return;
        }

        cleanerList.innerHTML = '';
        cleaners.forEach((c) => {
          const div = document.createElement('div');
          div.className = 'cleaner-item';
          
          const taskUrl = c.pin_code ? `${window.location.origin}/cleaning-tasks.html` : '';
          
          div.innerHTML = `
            <div class="cleaner-item-header">
              <div>
                <div class="cleaner-name">${c.name}</div>
                <div class="cleaner-tags">
                  ${c.email ? `<span class="cleaner-pill"><i class="fas fa-envelope"></i> ${c.email}</span>` : ''}
                  ${c.phone ? `<span class="cleaner-pill"><i class="fas fa-phone"></i> ${c.phone}</span>` : ''}
                  ${c.pin_code ? `<span class="cleaner-pill" style="background: #d1fae5; color: #059669; font-weight: 600;"><i class="fas fa-key"></i> PIN: ${c.pin_code}</span>` : ''}
                </div>
              </div>
              <button class="btn btn-ghost btn-xs" data-id="${c.id}" data-action="deleteCleaner">
                <i class="fas fa-trash"></i>
              </button>
            </div>
            ${c.notes ? `<div style="font-size:12px; color:var(--text-secondary); margin-top:4px;">${c.notes}</div>` : ''}
            ${taskUrl ? `<div style="font-size:12px; margin-top:8px;"><a href="${taskUrl}" target="_blank" style="color: #667eea; text-decoration: none;"><i class="fas fa-external-link-alt"></i> Lien d'acc√®s aux t√¢ches</a></div>` : ''}
          `;
          cleanerList.appendChild(div);
        });
      }

      function renderAssignments() {
         console.log('üîç RESERVATIONS:', RESERVATIONS);
  console.log('üîç PROPERTIES:', PROPERTIES);
  console.log('üîç assignments:', assignments);
        if (!assignContainer) return;

        // Initialisation du filtre logement (une seule fois, quand on a des donn√©es)
        if (!propertyFilterInitialized) {
          initReservationPropertyFilter();
        }

        if (!RESERVATIONS.length) {
          assignContainer.innerHTML = `
            <p class="text-secondary" style="font-size:13px;">
              Aucune r√©servation future d√©tect√©e. Les d√©parts appara√Ætront ici d√®s qu'ils seront synchronis√©s.
            </p>`;
          return;
        }

        const todayStr = new Date().toISOString().slice(0, 10);

        // R√©servations avec d√©part aujourd'hui ou plus tard
        const upcoming = (RESERVATIONS || [])
  .filter((r) => {
    if (!r.end) return false;

    const propertyId = getReservationPropertyId(r);
    if (!propertyId) return false;

    // Si un logement est s√©lectionn√©, on ne garde que celui-l√†
    if (
      selectedReservationPropertyFilter &&
      String(propertyId) !== String(selectedReservationPropertyFilter)
    ) {
      return false;
    }

    const endStr = String(r.end).slice(0, 10); // ‚ö†Ô∏è on garde le format AAAA-MM-JJ pour filtrer
          const endDateFr = formatDateFr(endStr);
    return endStr >= todayStr;
  })
  .sort((a, b) => {
    const aEnd = String(a.end).slice(0, 10);
    const bEnd = String(b.end).slice(0, 10);
    return aEnd.localeCompare(bEnd);
  });


        if (!upcoming.length) {
          assignContainer.innerHTML = `
            <p class="text-secondary" style="font-size:13px;">
              Aucune r√©servation future d√©tect√©e. Les d√©parts appara√Ætront ici d√®s qu'ils seront synchronis√©s.
            </p>`;
          return;
        }

        let html = `
          // ============================================
          // üé¥ MODE CARTES (remplace le tableau)
          // ============================================
          
          let html = '<div class="cleaning-cards-grid">';

     upcoming.forEach((r) => {
  const key = getReservationKey(r);
  const assignedId = key && assignments[key] ? assignments[key] : '';
  const propertyId = getReservationPropertyId(r);
  const propertyName =
    r.propertyName ||
    (r.property && (r.property.name || r.property.title || r.property.label)) ||
    getPropertyNameById(propertyId);
  const guestName = r.guestName || r.name || '';
  const endStr = String(r.end).slice(0, 10);
  const endDateFr = formatDateFr(endStr);
  
  html += `
    <div class="cleaning-card">
      <div class="cleaning-card-header">
        <h3 class="cleaning-card-title">${propertyName}</h3>
      </div>
      
      <div class="cleaning-card-body">
        <div class="cleaning-info-row date">
          <i class="fas fa-calendar-check"></i>
          <span>D√©part le ${endDateFr}</span>
        </div>
        
        <div class="cleaning-info-item">
          <div class="cleaning-info-label">Client</div>
          <div class="cleaning-info-value">${guestName || '-'}</div>
        </div>
      </div>
      
      <div class="cleaning-card-footer">
        <select class="assign-select assign-select-card"
                data-reservation-key="${key || ''}"
                data-property-id="${propertyId || ''}">
          <option value="">Aucun</option>
          ${cleaners
            .map(
              (c) => `
            <option value="${c.id}" ${c.id === assignedId ? 'selected' : ''}>
              ${c.name || c.email || c.phone || c.id}
            </option>
          `
            )
            .join('')}
        </select>
      </div>
    </div>
  `;
});
        html += '</div>';
        assignContainer.innerHTML = html;

        assignContainer.querySelectorAll('.assign-select').forEach((sel) => {
          sel.addEventListener('change', async (e) => {
            const select = e.target;
            const key = select.getAttribute('data-reservation-key');
            const propertyId = select.getAttribute('data-property-id') || null;
            const cleanerId = select.value;

            if (!key) return;

            if (cleanerId) {
              assignments[key] = cleanerId;
            } else {
              delete assignments[key];
            }
            saveLocalData();

            const token = localStorage.getItem('lcc_token');
            if (!token) return;

            try {
              await fetch(`${API_URL}/api/cleaning/assignments`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  Authorization: 'Bearer ' + token
                },
                body: JSON.stringify({
                  reservationKey: key,
                  propertyId,
                  cleanerId: cleanerId || null
                })
              });
            } catch (err) {
              console.error('Erreur sauvegarde assignation m√©nage', err);
            }
          });
        });
      }

      // Ajout d'un membre
      if (cleanerForm) {
        cleanerForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const name = document.getElementById('cleanerName').value.trim();
          const email = document.getElementById('cleanerEmail').value.trim();
          const phone = document.getElementById('cleanerPhone').value.trim();
          const notes = document.getElementById('cleanerNotes').value.trim();

          if (!name) return;

          const token = localStorage.getItem('lcc_token');
          if (!token) {
            alert('Session expir√©e, veuillez vous reconnecter');
            return;
          }

          try {
            const response = await fetch(`${API_URL}/api/cleaners`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: 'Bearer ' + token
              },
              body: JSON.stringify({
                name,
                email: email || null,
                phone: phone || null,
                notes: notes || null,
                isActive: true
              })
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.error || 'Erreur lors de la cr√©ation');
            }

            // Ajouter √† la liste locale
            cleaners.push(data.cleaner);
            
            cleanerForm.reset();
            renderCleaners();
            renderAssignments();
          } catch (err) {
            console.error('Erreur cr√©ation cleaner:', err);
            alert('Erreur lors de la cr√©ation: ' + err.message);
          }
        });
      }

      // Suppression d'un membre
      if (cleanerList) {
        cleanerList.addEventListener('click', async (e) => {
          const btn = e.target.closest('[data-action="deleteCleaner"]');
          if (!btn) return;

          const id = btn.getAttribute('data-id');
          
          if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette personne ?')) {
            return;
          }

          const token = localStorage.getItem('lcc_token');
          if (!token) {
            alert('Session expir√©e, veuillez vous reconnecter');
            return;
          }

          try {
            const response = await fetch(`${API_URL}/api/cleaners/${id}`, {
              method: 'DELETE',
              headers: {
                Authorization: 'Bearer ' + token
              }
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.error || 'Erreur lors de la suppression');
            }

            // Retirer de la liste locale
            cleaners = cleaners.filter((c) => c.id !== id);

            // On enl√®ve les assignations li√©es (maintenant par reservation_key)
            Object.keys(assignments).forEach((resKey) => {
              if (assignments[resKey] === id) {
                delete assignments[resKey];
              }
            });

            renderCleaners();
            renderAssignments();
          } catch (err) {
            console.error('Erreur suppression cleaner:', err);
            alert('Erreur lors de la suppression: ' + err.message);
          }
        });
      }

      // --------- PLANNING "IA" (brouillon) ---------
      function normalizeDateString(dateStr) {
        return dateStr ? dateStr.slice(0, 10) : null;
      }

      function getPropertyName(propertyId) {
        const p = PROPERTIES.find((x) => x.id === propertyId || x.propertyId === propertyId);
        return p ? p.name || p.title || p.label || propertyId : propertyId || 'Logement';
      }

      function getCleanerById(id) {
        return cleaners.find((c) => c.id === id) || null;
      }

      // Init
      (async function initCleaningPage() {
        loadLocalData();
        await loadRemoteData();
        await loadAssignmentsFromApi();
        renderCleaners();
        renderAssignments();
      })();
    });
  </script>
<!-- MOBILE MENU SCRIPT -->
<script>
    (function() {
      const menuBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      
      if (menuBtn && sidebar && overlay) {
        menuBtn.addEventListener('click', function() {
          sidebar.classList.toggle('active');
          overlay.classList.toggle('active');
          
          const icon = menuBtn.querySelector('i');
          if (sidebar.classList.contains('active')) {
            icon.classList.remove('fa-bars');
            icon.classList.add('fa-times');
          } else {
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
          }
        });
        
        overlay.addEventListener('click', function() {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          const icon = menuBtn.querySelector('i');
          icon.classList.remove('fa-times');
          icon.classList.add('fa-bars');
        });
        
        if (window.innerWidth <= 1024) {
          document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
              sidebar.classList.remove('active');
              overlay.classList.remove('active');
              const icon = menuBtn.querySelector('i');
              icon.classList.remove('fa-times');
              icon.classList.add('fa-bars');
            });
          });
        }
      }
    })();
    
    (function() {
      const currentPage = document.body.getAttribute('data-page');
      if (currentPage) {
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.remove('active');
        });
        const activeLink = document.querySelector('.nav-item[data-page="cleaning"]');
        if (activeLink) {
          activeLink.classList.add('active');
        }
      }
    })();
    
    document.getElementById('logoutBtn')?.addEventListener('click', function() {
      localStorage.removeItem('lcc_token');
      localStorage.removeItem('lcc_user');
      window.location.href = '/login.html';
    });
    
    (function() {
      const user = JSON.parse(localStorage.getItem('lcc_user') || '{}');
      if (user.firstName) {
        const nameEl = document.getElementById('sidebarUserName');
        const avatarEl = document.getElementById('sidebarUserAvatar');
        if (nameEl) nameEl.textContent = user.firstName + ' ' + (user.lastName || '');
        if (avatarEl) avatarEl.textContent = user.firstName.charAt(0).toUpperCase();
      }
      if (user.company) {
        const companyEl = document.getElementById('sidebarUserCompany');
        if (companyEl) companyEl.textContent = user.company;
      }
    })();
  </script>
<script src="/js/bh-layout.js"></script>
    <script src="/js/mobile-native-experience.js"></script>
<script src="/js/mobile-tabs-handler.js"></script>
</body>
</html>
