<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Boostinghost – Gestion du ménage</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- CSS plateforme globale -->
  <link rel="stylesheet" href="/css/style.css">

  <style>
    html, body {
      margin: 0 !important;
      padding: 0 !important;
    }

    .app-container {
      margin-top: 0 !important;
    }

    .main-content {
      padding-top: 24px !important;
      margin-top: 0 !important;
    }

    .page-content {
      margin-top: 0 !important;
    }

    html {
      scroll-behavior: smooth;
    }

    /* Mise en page spécifique ménage */
    .cleaning-page-grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
      gap: var(--spacing-xl);
      margin-bottom: var(--spacing-xl);
    }

    @media (max-width: 1024px) {
      .cleaning-page-grid {
        grid-template-columns: 1fr;
      }
    }

    .cleaner-list {
      margin-top: var(--spacing-md);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .cleaner-item {
      padding: var(--spacing-md);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .cleaner-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .cleaner-name {
      font-weight: 600;
    }

    .cleaner-tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .cleaner-pill {
      padding: 2px 8px;
      border-radius: var(--radius-full);
      border: 1px solid var(--border-color);
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .cleaner-actions {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .btn-xs {
      padding: 4px 8px;
      font-size: 11px;
    }

    /* Assignation logements */
    table.assign-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    table.assign-table th,
    table.assign-table td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border-color);
      text-align: left;
    }

    table.assign-table th {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-tertiary);
    }

    .assign-select {
      width: 100%;
      padding: 6px 8px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      font-size: 13px;
    }

    .assign-hint {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-sm);
    }

    /* Planning IA ménage */
    .planning-controls {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .planning-controls input[type="date"] {
      padding: 8px 10px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      font-size: 14px;
    }

    .planning-hint {
      font-size: 12px;
      color: var(--text-secondary);
    }

    table.planning-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: var(--spacing-sm);
    }

    table.planning-table th,
    table.planning-table td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border-color);
      text-align: left;
      vertical-align: top;
    }

    table.planning-table th {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-tertiary);
    }

    .planning-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 11px;
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
    }

    .planning-tag i {
      font-size: 11px;
    }

    .planning-empty {
      font-size: 13px;
      color: var(--text-secondary);
      padding: 8px 0;
    }

    .badge-type {
      display: inline-block;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 11px;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      margin-left: 6px;
    }

    .badge-cleaner {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 11px;
      background: var(--primary-light);
      color: var(--primary-color);
    }

    /* Petites utilitaires */
    .text-secondary {
      color: var(--text-secondary);
    }

    /* ========== HEADER DASHBOARD MODERNE (comme app.html) ========== */

    .main-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      padding: 18px 20px;
      margin-bottom: 20px;
      border-radius: 20px;
      background: linear-gradient(
        135deg,
        rgba(15, 23, 42, 0.98),
        rgba(15, 23, 42, 0.92)
      );
      border: 1px solid rgba(148, 163, 184, 0.45);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.7);
    }

    [data-theme="light"] .main-header {
      background: linear-gradient(135deg, #f9fafb, #eff6ff);
      border-color: rgba(148, 163, 184, 0.4);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.06);
    }

    .header-left {
      max-width: 60%;
    }

    .page-kicker {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: #9ca3af;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .page-title {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    .page-subtitle {
      margin-top: 6px;
      font-size: 13px;
      color: #9ca3af;
    }

    [data-theme="light"] .page-subtitle {
      color: #6b7280;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-ghost {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: transparent;
      padding-inline: 14px;
    }

    .btn-ghost:hover {
      background: rgba(15, 23, 42, 0.06);
    }

    [data-theme="dark"] .btn-ghost:hover {
      background: rgba(15, 23, 42, 0.9);
    }

    @media (max-width: 768px) {
      .main-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-left {
        max-width: 100%;
      }
    }
  </style>
  <script src="/js/auth-fetch.js"></script>
</head>
<body data-page="cleaning">
  <!-- MOBILE HEADER -->
  <div class="mobile-header">
    <a href="/app.html" class="mobile-logo">
      <i class="fas fa-calendar-check"></i>
      <span class="mobile-logo-text">Bookingmanage</span>
    </a>
    <button class="mobile-menu-btn" id="mobileMenuBtn">
      <i class="fas fa-bars"></i>
    </button>
  </div>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div class="app-container">
    
  <!-- Sidebar -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <a href="/" class="sidebar-logo">
      <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink:0;">
        <path d="M8 20V34C8 35.1046 8.89543 36 10 36H30C31.1046 36 32 35.1046 32 34V20"
              stroke="#3B82F6" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M16 36V26H24V36"
              stroke="#3B82F6" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M20 4L4 18H10V22H30V18H36L20 4Z"
              fill="#10B981" stroke="#10B981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M20 9L24 14H16L20 9Z" fill="white"/>
      </svg>

      <div class="sidebar-logo-text" style="display:flex; flex-direction:column; justify-content:center; margin-left:10px;">
        <span class="sidebar-logo-title" style="font-family:'Inter',sans-serif; font-size:17px; line-height:1.1;">
          <span style="color:#10B981; font-weight:800;">Boosting</span><span style="color:#111827; font-weight:600;">host</span>
        </span>
        <span class="sidebar-logo-subtitle" style="font-size:10px; color:#6B7280; font-weight:500; letter-spacing:0.5px;">
          Smart Property Manager
        </span>
      </div>
    </a>
  </div> <!-- ✅ IMPORTANT -->

  <nav class="sidebar-nav">
    <!-- PRINCIPAL -->
    <div class="nav-section">
      <div class="nav-section-title">Principal</div>

      <a href="/app.html" class="nav-item" data-page="app">
        <i class="fas fa-th-large"></i>
        <span>Dashboard</span>
      </a>

      <a href="/app.html#calendarSection" class="nav-item" id="navCalendarLink">
        <i class="fas fa-calendar"></i>
        <span>Calendrier</span>
        <span class="nav-badge" id="navTotalReservations">0</span>
      </a>

      <a href="/messages.html" class="nav-item" data-page="messages">
        <i class="fas fa-comment-dots"></i>
        <span>Messages</span>
      </a>
    </div>

    <!-- GESTION -->
    <div class="nav-section">
      <div class="nav-section-title">Gestion</div>

      <a href="/settings.html" class="nav-item" data-page="settings">
        <i class="fas fa-home"></i>
        <span>Mes logements</span>
      </a>

      <a href="/welcome.html" class="nav-item" data-page="welcome">
        <i class="fas fa-book-open"></i>
        <span>Livret d'accueil</span>
      </a>

      <a href="/cleaning.html" class="nav-item active" data-page="cleaning">
        <i class="fas fa-broom"></i>
        <span>Gestion du ménage</span>
      </a>
    </div>

    <!-- FACTURATION (propre) -->
    <div class="nav-section">
      <div class="nav-section-title">Facturation</div>

      <a href="/factures.html" class="nav-item" data-page="factures">
        <i class="fas fa-file-invoice"></i>
        <span>Factures clients</span>
      </a>

      <a href="/factures-proprietaires.html" class="nav-item" data-page="factures-proprietaires">
        <i class="fas fa-file-invoice-dollar"></i>
        <span>Factures propriétaires</span>
      </a>
    </div>

    <!-- AUTRES -->
    <div class="nav-section">
      <div class="nav-section-title">Autres</div>

      <a href="/deposits.html" class="nav-item" data-page="deposits">
        <i class="fas fa-shield-alt"></i>
        <span>Cautions</span>
      </a>

      <a href="/notifications.html" class="nav-item" data-page="notifications">
        <i class="fas fa-bell"></i>
        <span>Notifications</span>
      </a>
    </div>

    <!-- PARAMÈTRES -->
    <div class="nav-section">
      <div class="nav-section-title">Paramètres</div>

      <a href="/settings-account.html" class="nav-item" data-page="settings-account">
        <i class="fas fa-cog"></i>
        <span>Paramètres</span>
      </a>

      <a href="/help.html" class="nav-item" data-page="help">
        <i class="fas fa-question-circle"></i>
        <span>Aide</span>
      </a>
    </div>
  </nav>

  <div class="sidebar-footer">
    <div class="user-profile">
      <div class="user-avatar" id="sidebarUserAvatar">C</div>
      <div class="user-info">
        <div class="user-name" id="sidebarUserName">Utilisateur</div>
        <div class="user-email" id="sidebarUserCompany">Mon espace</div>
      </div>

      <button class="btn btn-ghost btn-xs" id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </div>
  </div>
</aside>

    <!-- Main -->
    <main class="main-content">
      <!-- Header -->
      <header class="main-header">
        <div class="header-left">
          <div class="page-kicker">Gestion</div>
          <h1 class="page-title">Gestion du ménage</h1>
          <p class="page-subtitle">
            Assignez-la à vos logements et générez un planning intelligent.
          </p>
        </div>
        <div class="header-actions">
          <button class="btn btn-ghost" onclick="window.location.href='/app.html'">
            <i class="fas fa-arrow-left"></i>
            Retour au dashboard
          </button>
        </div>
      </header>

      <!-- Contenu -->
      <div class="page-content">

        <!-- Grid équipe + assignation -->
        <section class="cleaning-page-grid">

          <!-- Colonne gauche : équipe ménage -->
          <section class="card">
            <div class="card-header">
              <div class="card-title">
                <i class="fas fa-users"></i>
                Équipe de ménage
              </div>
            </div>

            <form id="cleanerForm" class="form-grid">
              <div class="form-row">
                <label for="cleanerName">Nom & prénom</label>
                <input type="text" id="cleanerName" required>
              </div>
              <div class="form-row">
                <label for="cleanerEmail">E-mail</label>
                <input type="email" id="cleanerEmail" placeholder="exemple@mail.com">
              </div>
              <div class="form-row">
                <label for="cleanerPhone">Téléphone</label>
                <input type="tel" id="cleanerPhone" placeholder="+33 6 00 00 00 00">
              </div>
              <div class="form-row">
                <label for="cleanerNotes">Notes / zone d'intervention</label>
                <textarea id="cleanerNotes" rows="2" placeholder="Ex : intervient uniquement sur les appartements du centre-ville"></textarea>
              </div>
              <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-user-plus"></i>
                  Ajouter à l'équipe
                </button>
              </div>
            </form>

            <hr style="margin:16px 0; border:none; border-top:1px solid var(--border-color);" />

            <div>
              <div class="text-secondary" style="font-size:13px; margin-bottom:8px;">
                Membres de l'équipe
              </div>
              <div id="cleanerList" class="cleaner-list">
                <p class="text-secondary" style="font-size:13px;">
                  Aucun membre pour l'instant. Ajoutez votre première personne de ménage.
                </p>
              </div>
            </div>
          </section>

          <!-- Colonne droite : assignation par réservation -->
          <section class="card">
            <div class="card-header">
              <div class="card-title">
                <i class="fas fa-broom"></i>
                Assignation par réservation
              </div>
            </div>

            <p class="assign-hint">
              Assignez une personne de ménage à chaque départ de réservation. 
              Ces assignations seront visibles dans le dashboard et dans le calendrier.
            </p>

            <!-- Filtre par logement -->
            <div class="cleaning-filter-row" style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
              <label for="reservationPropertyFilter" style="font-size:13px;">
                Filtrer par logement :
              </label>
              <select id="reservationPropertyFilter" class="assign-select" style="max-width:260px;">
                <option value="">Tous les logements</option>
              </select>
            </div>

            <div id="assignContainer">
              <p class="text-secondary" style="font-size:13px;">
                Chargement des réservations…
              </p>
            </div>
          </section>


        </section>
      </div>
    </main>
  </div>

  <!-- Scripts -->
  <script>
    // Auth / user (même logique que app.html)
    (function () {
      const token = localStorage.getItem('lcc_token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      const rawUser = localStorage.getItem('lcc_user');
      let user = null;

      try {
        user = rawUser ? JSON.parse(rawUser) : null;
      } catch (e) {
        console.error('Impossible de lire lcc_user', e);
      }

      if (user) {
        const nameEl = document.getElementById('sidebarUserName');
        const companyEl = document.getElementById('sidebarUserCompany');
        const avatarEl = document.getElementById('sidebarUserAvatar');

        if (nameEl) {
          nameEl.textContent = user.firstName
            ? user.firstName + (user.lastName ? ' ' + user.lastName : '')
            : (user.email || 'Mon compte');
        }

        if (companyEl) {
          companyEl.textContent = user.company || 'Mon espace';
        }

        if (avatarEl) {
          const initial = (user.firstName || user.email || '?').trim()[0] || 'U';
          avatarEl.textContent = initial.toUpperCase();
        }
      }

      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function () {
          localStorage.removeItem('lcc_token');
          localStorage.removeItem('lcc_user');
          window.location.href = '/login.html';
        });
      }
    })();

    // --------------------------
    // GESTION EQUIPE + ASSIGNATION + PLANNING
    // --------------------------
    document.addEventListener('DOMContentLoaded', () => {
      // NOUVELLE FONCTION : Formater une date YYYY-MM-DD en DD/MM/YYYY
      function formatDateFr(dateStr) {
        if (!dateStr) return '';
        const parts = dateStr.split('-');
        if (parts.length !== 3) return dateStr;
        const [year, month, day] = parts;
        return `${day}/${month}/${year}`;
      }
      const API_URL = 'https://lcc-booking-manager.onrender.com';
      const STORAGE_CLEANERS = 'lcc_cleaners';
      const STORAGE_ASSIGN = 'lcc_cleaning_assignments';

      let PROPERTIES = [];
      let RESERVATIONS = [];

      let cleaners = [];
      let assignments = {};

      // Filtre logement
      let selectedReservationPropertyFilter = '';
      let propertyFilterInitialized = false;

      const cleanerForm = document.getElementById('cleanerForm');
      const cleanerList = document.getElementById('cleanerList');
      const assignContainer = document.getElementById('assignContainer');
      
function formatDateFr(dateStr) {
  if (!dateStr) return '';
  const parts = dateStr.split('-');
  if (parts.length !== 3) return dateStr;
  const [year, month, day] = parts;
  return `${day}/${month}/${year}`;
}
      function loadLocalData() {
        try {
          // Les cleaners sont maintenant chargés depuis l'API dans loadRemoteData()
          // On garde seulement les assignations en localStorage pour la compatibilité
          assignments = JSON.parse(localStorage.getItem(STORAGE_ASSIGN)) || {};
        } catch (e) {
          assignments = {};
        }
      }

      function saveLocalData() {
        // On ne sauvegarde plus les cleaners en localStorage
        // Ils sont maintenant gérés uniquement via l'API
        localStorage.setItem(STORAGE_ASSIGN, JSON.stringify(assignments));
      }

      // Charge les assignations ménage depuis le backend et les injecte dans "assignments"
      async function loadAssignmentsFromApi() {
  try {
    const token = localStorage.getItem('lcc_token');
    if (!token) return;

    const res = await fetch(`${API_URL}/api/cleaning/assignments`, {
      headers: {
        Authorization: 'Bearer ' + token
      }
    });

    if (!res.ok) {
      console.warn('Erreur lors du chargement des assignations ménage', res.status);
      return;
    }

    const data = await res.json();
    const apiMap = {};

    // On reconstruit une map à partir de ce que renvoie l'API
    (data.assignments || []).forEach((row) => {
      const key = row.reservation_key;

      if (key && row.cleaner_id) {
        apiMap[key] = row.cleaner_id;
      }
    });

    const apiKeys = Object.keys(apiMap);

    if (apiKeys.length > 0) {
      // ✅ On FUSIONNE les assignations API avec les locales
      // Les données API prennent le dessus si conflit
      assignments = Object.assign({}, assignments, apiMap);
      saveLocalData();
    } else {
      // ✅ Aucune assignation retournée → on NE TOUCHE PAS aux assignations locales
      console.log("ℹ️ Aucune assignation ménage renvoyée par l'API, on garde les assignations locales.");
    }
  } catch (e) {
    console.error('Erreur loadAssignmentsFromApi()', e);
    // En cas d'erreur réseau, on ne touche pas non plus aux assignations locales
  }
}


      async function loadRemoteData() {
        try {
          const token = localStorage.getItem('lcc_token');
          if (!token) return;

          // Charger les réservations et propriétés
          const response = await fetch(`${API_URL}/api/reservations`, {
            headers: {
              Authorization: 'Bearer ' + token
            }
          });

          if (!response.ok) {
            console.warn('Erreur lors du chargement des réservations pour le ménage', response.status);
            return;
          }

          const data = await response.json().catch(() => ({}));

          RESERVATIONS = Array.isArray(data.reservations) ? data.reservations : [];
          PROPERTIES = Array.isArray(data.properties) ? data.properties : [];

          // Charger les cleaners depuis l'API
          const cleanersResponse = await fetch(`${API_URL}/api/cleaners`, {
            headers: {
              Authorization: 'Bearer ' + token
            }
          });

          if (cleanersResponse.ok) {
            const cleanersData = await cleanersResponse.json().catch(() => ({}));
            if (Array.isArray(cleanersData.cleaners)) {
              cleaners = cleanersData.cleaners;
            }
          }

          // Fallback de démo si aucune propriété
          if (!PROPERTIES.length) {
            PROPERTIES = [
              { id: 'apt-demo-1', name: 'Appartement démo 1' },
              { id: 'apt-demo-2', name: 'Appartement démo 2' }
            ];
          }
        } catch (e) {
          console.error('Erreur loadRemoteData()', e);
          if (!PROPERTIES.length) {
            PROPERTIES = [
              { id: 'apt-demo-1', name: 'Appartement démo 1' },
              { id: 'apt-demo-2', name: 'Appartement démo 2' }
            ];
          }
        }
      }

      function getReservationKey(reservation) {
  if (!reservation || !reservation.start || !reservation.end) return null;
  
  const propertyId = getReservationPropertyId(reservation);
  if (!propertyId) return null;
  
  const startStr = String(reservation.start).slice(0, 10);
  const endStr = String(reservation.end).slice(0, 10);
  return `${propertyId}_${startStr}_${endStr}`;
}

      function getPropertyNameById(propertyId) {
        if (!propertyId) return 'Logement';
        const p = PROPERTIES.find(
          (x) =>
            String(x.id) === String(propertyId) ||
            String(x.propertyId) === String(propertyId)
        );
        return p ? (p.name || p.title || p.label || propertyId) : propertyId;
      }

      function getReservationPropertyId(r) {
        if (!r) return null;
        if (r.propertyId != null) return String(r.propertyId);
        if (r.property && r.property.id != null) return String(r.property.id);
        if (r.property_id != null) return String(r.property_id);
        return null;
      }

      function initReservationPropertyFilter() {
        const select = document.getElementById('reservationPropertyFilter');
        if (!select) return;

        const previousValue = selectedReservationPropertyFilter;

        // Reset de base
        select.innerHTML = '<option value="">Tous les logements</option>';

        const alreadyAdded = new Set();

        // On se base sur PROPERTIES pour remplir la liste
        if (Array.isArray(PROPERTIES)) {
          PROPERTIES.forEach((p) => {
            const id = p.id != null ? p.id : p.propertyId;
            if (!id) return;
            const idStr = String(id);
            if (alreadyAdded.has(idStr)) return;
            alreadyAdded.add(idStr);

            const opt = document.createElement('option');
            opt.value = idStr;
            opt.textContent = p.name || p.title || p.label || ('Logement ' + idStr);
            select.appendChild(opt);
          });
        }

        // Restaure la sélection précédente si possible
        if (previousValue) {
          select.value = previousValue;
        }

        select.onchange = (e) => {
          selectedReservationPropertyFilter = e.target.value || '';
          renderAssignments();
        };

        propertyFilterInitialized = true;
      }

      function renderCleaners() {
        if (!cleanerList) return;
        if (!cleaners.length) {
          cleanerList.innerHTML = '<p class="text-secondary" style="font-size:13px;">Aucun membre pour l\'instant. Ajoutez votre première personne de ménage.</p>';
          return;
        }

        cleanerList.innerHTML = '';
        cleaners.forEach((c) => {
          const div = document.createElement('div');
          div.className = 'cleaner-item';
          
          const taskUrl = c.pin_code ? `${window.location.origin}/cleaning-tasks.html` : '';
          
          div.innerHTML = `
            <div class="cleaner-item-header">
              <div>
                <div class="cleaner-name">${c.name}</div>
                <div class="cleaner-tags">
                  ${c.email ? `<span class="cleaner-pill"><i class="fas fa-envelope"></i> ${c.email}</span>` : ''}
                  ${c.phone ? `<span class="cleaner-pill"><i class="fas fa-phone"></i> ${c.phone}</span>` : ''}
                  ${c.pin_code ? `<span class="cleaner-pill" style="background: #d1fae5; color: #059669; font-weight: 600;"><i class="fas fa-key"></i> PIN: ${c.pin_code}</span>` : ''}
                </div>
              </div>
              <button class="btn btn-ghost btn-xs" data-id="${c.id}" data-action="deleteCleaner">
                <i class="fas fa-trash"></i>
              </button>
            </div>
            ${c.notes ? `<div style="font-size:12px; color:var(--text-secondary); margin-top:4px;">${c.notes}</div>` : ''}
            ${taskUrl ? `<div style="font-size:12px; margin-top:8px;"><a href="${taskUrl}" target="_blank" style="color: #667eea; text-decoration: none;"><i class="fas fa-external-link-alt"></i> Lien d'accès aux tâches</a></div>` : ''}
          `;
          cleanerList.appendChild(div);
        });
      }

      function renderAssignments() {
        if (!assignContainer) return;

        // Initialisation du filtre logement (une seule fois, quand on a des données)
        if (!propertyFilterInitialized) {
          initReservationPropertyFilter();
        }

        if (!RESERVATIONS.length) {
          assignContainer.innerHTML = `
            <p class="text-secondary" style="font-size:13px;">
              Aucune réservation future détectée. Les départs apparaîtront ici dès qu'ils seront synchronisés.
            </p>`;
          return;
        }

        const todayStr = new Date().toISOString().slice(0, 10);

        // Réservations avec départ aujourd'hui ou plus tard
        const upcoming = (RESERVATIONS || [])
  .filter((r) => {
    if (!r.end) return false;

    const propertyId = getReservationPropertyId(r);
    if (!propertyId) return false;

    // Si un logement est sélectionné, on ne garde que celui-là
    if (
      selectedReservationPropertyFilter &&
      String(propertyId) !== String(selectedReservationPropertyFilter)
    ) {
      return false;
    }

    const endStr = String(r.end).slice(0, 10); // ⚠️ on garde le format AAAA-MM-JJ pour filtrer
          const endDateFr = formatDateFr(endStr);
    return endStr >= todayStr;
  })
  .sort((a, b) => {
    const aEnd = String(a.end).slice(0, 10);
    const bEnd = String(b.end).slice(0, 10);
    return aEnd.localeCompare(bEnd);
  });


        if (!upcoming.length) {
          assignContainer.innerHTML = `
            <p class="text-secondary" style="font-size:13px;">
              Aucune réservation future détectée. Les départs apparaîtront ici dès qu'ils seront synchronisés.
            </p>`;
          return;
        }

        let html = `
          <table class="assign-table">
            <thead>
              <tr>
                <th>Départ le</th>
                <th>Logement</th>
                <th>Client</th>
                <th>Personne en charge</th>
              </tr>
            </thead>
            <tbody>
        `;

     upcoming.forEach((r) => {
  const key = getReservationKey(r);
  const assignedId = key && assignments[key] ? assignments[key] : '';
  const propertyId = getReservationPropertyId(r);
  const propertyName =
    r.propertyName ||
    (r.property && (r.property.name || r.property.title || r.property.label)) ||
    getPropertyNameById(propertyId);
  const guestName = r.guestName || r.name || '';
  const endStr = String(r.end).slice(0, 10);
  const endDateFr = formatDateFr(endStr);  // ← AJOUTE CETTE LIGNE ICI
  
  html += `
    <tr>
      <td>${endDateFr}</td>
      <td>${propertyName}</td>
      <td>${guestName || '-'}</td>
      <td>
        <select class="assign-select"
                data-reservation-key="${key || ''}"
                data-property-id="${propertyId || ''}">
          <option value="">Aucun</option>
          ${cleaners
            .map(
              (c) => `
            <option value="${c.id}" ${c.id === assignedId ? 'selected' : ''}>
              ${c.name || c.email || c.phone || c.id}
            </option>
          `
            )
            .join('')}
        </select>
      </td>
    </tr>
  `;
});
        html += '</tbody></table>';
        assignContainer.innerHTML = html;

        assignContainer.querySelectorAll('.assign-select').forEach((sel) => {
          sel.addEventListener('change', async (e) => {
            const select = e.target;
            const key = select.getAttribute('data-reservation-key');
            const propertyId = select.getAttribute('data-property-id') || null;
            const cleanerId = select.value;

            if (!key) return;

            if (cleanerId) {
              assignments[key] = cleanerId;
            } else {
              delete assignments[key];
            }
            saveLocalData();

            const token = localStorage.getItem('lcc_token');
            if (!token) return;

            try {
              await fetch(`${API_URL}/api/cleaning/assignments`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  Authorization: 'Bearer ' + token
                },
                body: JSON.stringify({
                  reservationKey: key,
                  propertyId,
                  cleanerId: cleanerId || null
                })
              });
            } catch (err) {
              console.error('Erreur sauvegarde assignation ménage', err);
            }
          });
        });
      }

      // Ajout d'un membre
      if (cleanerForm) {
        cleanerForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const name = document.getElementById('cleanerName').value.trim();
          const email = document.getElementById('cleanerEmail').value.trim();
          const phone = document.getElementById('cleanerPhone').value.trim();
          const notes = document.getElementById('cleanerNotes').value.trim();

          if (!name) return;

          const token = localStorage.getItem('lcc_token');
          if (!token) {
            alert('Session expirée, veuillez vous reconnecter');
            return;
          }

          try {
            const response = await fetch(`${API_URL}/api/cleaners`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: 'Bearer ' + token
              },
              body: JSON.stringify({
                name,
                email: email || null,
                phone: phone || null,
                notes: notes || null,
                isActive: true
              })
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.error || 'Erreur lors de la création');
            }

            // Ajouter à la liste locale
            cleaners.push(data.cleaner);
            
            cleanerForm.reset();
            renderCleaners();
            renderAssignments();
          } catch (err) {
            console.error('Erreur création cleaner:', err);
            alert('Erreur lors de la création: ' + err.message);
          }
        });
      }

      // Suppression d'un membre
      if (cleanerList) {
        cleanerList.addEventListener('click', async (e) => {
          const btn = e.target.closest('[data-action="deleteCleaner"]');
          if (!btn) return;

          const id = btn.getAttribute('data-id');
          
          if (!confirm('Êtes-vous sûr de vouloir supprimer cette personne ?')) {
            return;
          }

          const token = localStorage.getItem('lcc_token');
          if (!token) {
            alert('Session expirée, veuillez vous reconnecter');
            return;
          }

          try {
            const response = await fetch(`${API_URL}/api/cleaners/${id}`, {
              method: 'DELETE',
              headers: {
                Authorization: 'Bearer ' + token
              }
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.error || 'Erreur lors de la suppression');
            }

            // Retirer de la liste locale
            cleaners = cleaners.filter((c) => c.id !== id);

            // On enlève les assignations liées (maintenant par reservation_key)
            Object.keys(assignments).forEach((resKey) => {
              if (assignments[resKey] === id) {
                delete assignments[resKey];
              }
            });

            renderCleaners();
            renderAssignments();
          } catch (err) {
            console.error('Erreur suppression cleaner:', err);
            alert('Erreur lors de la suppression: ' + err.message);
          }
        });
      }

      // --------- PLANNING "IA" (brouillon) ---------
      function normalizeDateString(dateStr) {
        return dateStr ? dateStr.slice(0, 10) : null;
      }

      function getPropertyName(propertyId) {
        const p = PROPERTIES.find((x) => x.id === propertyId || x.propertyId === propertyId);
        return p ? p.name || p.title || p.label || propertyId : propertyId || 'Logement';
      }

      function getCleanerById(id) {
        return cleaners.find((c) => c.id === id) || null;
      }

      // Init
      (async function initCleaningPage() {
        loadLocalData();
        await loadRemoteData();
        await loadAssignmentsFromApi();
        renderCleaners();
        renderAssignments();
      })();
    });
  </script>

  <!-- MOBILE MENU SCRIPT -->
  <script>
    (function() {
      const menuBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      
      if (menuBtn && sidebar && overlay) {
        menuBtn.addEventListener('click', function() {
          sidebar.classList.toggle('active');
          overlay.classList.toggle('active');
          
          const icon = menuBtn.querySelector('i');
          if (sidebar.classList.contains('active')) {
            icon.classList.remove('fa-bars');
            icon.classList.add('fa-times');
          } else {
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
          }
        });
        
        overlay.addEventListener('click', function() {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          const icon = menuBtn.querySelector('i');
          icon.classList.remove('fa-times');
          icon.classList.add('fa-bars');
        });
        
        if (window.innerWidth <= 1024) {
          document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
              sidebar.classList.remove('active');
              overlay.classList.remove('active');
              const icon = menuBtn.querySelector('i');
              icon.classList.remove('fa-times');
              icon.classList.add('fa-bars');
            });
          });
        }
      }
    })();
    
    (function() {
      const currentPage = document.body.getAttribute('data-page');
      if (currentPage) {
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.remove('active');
        });
        const activeLink = document.querySelector('.nav-item[data-page="cleaning"]');
        if (activeLink) {
          activeLink.classList.add('active');
        }
      }
    })();
    
    document.getElementById('logoutBtn')?.addEventListener('click', function() {
      localStorage.removeItem('lcc_token');
      localStorage.removeItem('lcc_user');
      window.location.href = '/login.html';
    });
    
    (function() {
      const user = JSON.parse(localStorage.getItem('lcc_user') || '{}');
      if (user.firstName) {
        const nameEl = document.getElementById('sidebarUserName');
        const avatarEl = document.getElementById('sidebarUserAvatar');
        if (nameEl) nameEl.textContent = user.firstName + ' ' + (user.lastName || '');
        if (avatarEl) avatarEl.textContent = user.firstName.charAt(0).toUpperCase();
      }
      if (user.company) {
        const companyEl = document.getElementById('sidebarUserCompany');
        if (companyEl) companyEl.textContent = user.company;
      }
    })();
  </script>
</body>
</html>
