<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Créateur de Livret d'Accueil – Boostinghost</title>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Cormorant+Garamond:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- Platform CSS -->
<link rel="stylesheet" href="/css/style.css?v=3">
  
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #10B981;
      --primary-dark: #059669;
      --secondary: #3B82F6;
      --accent: #E67E50;
      --dark: #111827;
      --gray-50: #F9FAFB;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-300: #D1D5DB;
      --gray-400: #9CA3AF;
      --gray-500: #6B7280;
      --gray-600: #4B5563;
      --gray-700: #374151;
      --gray-800: #1F2937;
      --gray-900: #111827;
      --white: #FFFFFF;
      --success: #10B981;
      --warning: #F59E0B;
      --danger: #EF4444;
    }
/* Layout avec sidebar */
.app-container {
  display: flex;
  min-height: 100vh;
}

.sidebar {
  width: 260px;
  flex-shrink: 0;
}

.main-content-welcome {
  flex: 1;
  overflow-x: hidden;
}

/* Sur mobile, cacher le sidebar */
@media (max-width: 768px) {
  .sidebar {
    display: none;
  }
}
    body {
      font-family: 'Inter', sans-serif;
      background: var(--gray-50);
      color: var(--gray-900);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* Header */

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.2rem;
    }

    .logo-text {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .logo-text .green {
      color: var(--primary);
    }

    .logo-text .dark {
      color: var(--gray-900);
    }

    .header-actions {
      display: flex;
      gap: 1rem;
    }

    /* Page Title */
    .page-title {
      margin-bottom: 2rem;
    }

    .page-title h1 {
      font-size: 2rem;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 0.5rem;
    }

    .page-title p {
      font-size: 1rem;
      color: var(--gray-500);
    }

    /* Progress Steps */
    .progress-steps {
      background: var(--white);
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }

    .steps-container {
      display: flex;
      justify-content: space-between;
      position: relative;
    }

    .steps-container::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--gray-200);
      z-index: 0;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 1;
      flex: 1;
    }

    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--gray-200);
      color: var(--gray-500);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      margin-bottom: 0.5rem;
      transition: all 0.3s ease;
    }

    .step.active .step-number {
      background: var(--primary);
      color: white;
    }

    .step.completed .step-number {
      background: var(--success);
      color: white;
    }

    .step-label {
      font-size: 0.875rem;
      color: var(--gray-500);
      text-align: center;
      font-weight: 500;
    }

    .step.active .step-label {
      color: var(--primary);
      font-weight: 600;
    }

    /* Form Card */
    .form-card {
      background: var(--white);
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .form-section {
      display: none;
    }

    .form-section.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .section-header {
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--gray-100);
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .section-title i {
      color: var(--accent);
    }

    .section-description {
      font-size: 0.95rem;
      color: var(--gray-500);
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 0.5rem;
    }

    .form-group label .required {
      color: var(--danger);
    }

    .form-group .hint {
      font-size: 0.8rem;
      color: var(--gray-500);
      font-weight: 400;
      display: block;
      margin-top: 0.25rem;
    }

    .form-control {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    textarea.form-control {
      resize: vertical;
      min-height: 100px;
    }

    /* Grid Layout */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
    }

    /* Image Upload */
    .image-upload-area {
      border: 2px dashed var(--gray-300);
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: var(--gray-50);
    }

    .image-upload-area:hover {
      border-color: var(--primary);
      background: rgba(16, 185, 129, 0.05);
    }

    .image-upload-area i {
      font-size: 3rem;
      color: var(--gray-400);
      margin-bottom: 1rem;
    }

    .image-upload-area p {
      color: var(--gray-600);
      margin-bottom: 0.5rem;
    }

    .image-upload-area .supported-formats {
      font-size: 0.8rem;
      color: var(--gray-400);
    }

    .image-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .image-preview-item {
      position: relative;
      aspect-ratio: 4/3;
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid var(--gray-200);
    }

    .image-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-preview-item .remove-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: rgba(239, 68, 68, 0.9);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .image-preview-item .remove-btn:hover {
      background: var(--danger);
      transform: scale(1.1);
    }

    /* Repeatable Items */
    .repeatable-section {
      margin-bottom: 2rem;
    }

    .repeatable-item {
      background: var(--gray-50);
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      position: relative;
      border: 1px solid var(--gray-200);
    }

    .repeatable-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--gray-200);
    }

    .repeatable-item-title {
      font-weight: 600;
      color: var(--gray-700);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .remove-item-btn {
      background: transparent;
      border: none;
      color: var(--danger);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    .remove-item-btn:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    .add-item-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      background: var(--gray-100);
      color: var(--gray-700);
      border: 1px dashed var(--gray-300);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      margin-top: 1rem;
    }

    .add-item-btn:hover {
      background: var(--gray-200);
      border-color: var(--gray-400);
    }

    /* Buttons */
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-secondary {
      background: var(--gray-200);
      color: var(--gray-700);
    }

    .btn-secondary:hover {
      background: var(--gray-300);
    }

    .btn-accent {
      background: var(--accent);
      color: white;
    }

    .btn-accent:hover {
      background: #d46d42;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(230, 126, 80, 0.3);
    }

    .form-actions {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 2px solid var(--gray-100);
    }

    /* Info Box */
    .info-box {
      background: rgba(16, 185, 129, 0.1);
      border-left: 4px solid var(--primary);
      padding: 1rem 1.25rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }

    .info-box i {
      color: var(--primary);
      margin-right: 0.5rem;
    }

    .info-box p {
      color: var(--gray-700);
      font-size: 0.9rem;
    }

    /* Warning Box */
    .warning-box {
      background: rgba(245, 158, 11, 0.1);
      border-left: 4px solid var(--warning);
      padding: 1rem 1.25rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }

    .warning-box i {
      color: var(--warning);
      margin-right: 0.5rem;
    }

    /* Success Message */
    .success-message {
      display: none;
      background: var(--white);
      border-radius: 12px;
      padding: 3rem;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .success-message.show {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    .success-icon {
      width: 80px;
      height: 80px;
      background: var(--success);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
      color: white;
      font-size: 2.5rem;
    }

    .success-message h2 {
      font-size: 1.75rem;
      color: var(--gray-900);
      margin-bottom: 0.75rem;
    }

    .success-message p {
      color: var(--gray-600);
      margin-bottom: 2rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      .form-card {
        padding: 1.5rem;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .steps-container {
        flex-wrap: wrap;
        gap: 1rem;
      }

      .step {
        flex-basis: 45%;
      }

      .form-actions {
        flex-direction: column;
      }

      .page-title h1 {
        font-size: 1.5rem;
      }
    }

    /* Loading Spinner */
    .spinner {
      border: 3px solid var(--gray-200);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Fix pour le layout avec sidebar */
body {
  margin: 0;
  padding: 0;
}

.main-content-welcome .container {
  max-width: 100%;
  margin: 0;
  padding: 2rem 3rem;
}

.main-content-welcome .page-title {
  padding-left: 0;
}

.main-content-welcome {
  background: var(--gray-50);
  min-height: 100vh;
  padding: 2rem;
}
  </style>
</head>
<body>
 <!-- Sidebar Overlay (pour mobile) -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<div class="app-container">
  
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <a href="/" class="sidebar-logo">
        <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink:0;">
          <path d="M8 20V34C8 35.1046 8.89543 36 10 36H30C31.1046 36 32 35.1046 32 34V20" 
                stroke="#3B82F6" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M16 36V26H24V36" 
                stroke="#3B82F6" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M20 4L4 18H10V22H30V18H36L20 4Z" 
                fill="#10B981" stroke="#10B981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M20 9L24 14H16L20 9Z" fill="white"/>
        </svg>
        <div class="sidebar-logo-text" style="display: flex; flex-direction: column; justify-content: center; margin-left: 10px;">
          <span class="sidebar-logo-title" style="font-family: 'Inter', sans-serif; font-size: 17px; line-height: 1.1;">
            <span style="color: #10B981; font-weight: 800;">Boosting</span><span style="color: #111827; font-weight: 600;">host</span>
          </span>
          <span class="sidebar-logo-subtitle" style="font-size: 10px; color: #6B7280; font-weight: 500; letter-spacing: 0.5px;">
            Smart Property Manager
          </span>
        </div>
      </a>
    </div>
    
    <nav class="sidebar-nav">
      <!-- PRINCIPAL -->
      <div class="nav-section">
        <div class="nav-section-title">Principal</div>

        <a href="/app.html" class="nav-item" data-page="app">
          <i class="fas fa-th-large"></i>
          <span>Dashboard</span>
        </a>

        <a href="/app.html#calendarSection" class="nav-item" id="navCalendarLink">
          <i class="fas fa-calendar"></i>
          <span>Calendrier</span>
        </a>

        <a href="/messages.html" class="nav-item" data-page="messages">
          <i class="fas fa-comment-dots"></i>
          <span>Messages</span>
        </a>
      </div>

      <!-- GESTION -->
      <div class="nav-section">
        <div class="nav-section-title">Gestion</div>

        <a href="/settings.html" class="nav-item" data-page="settings">
          <i class="fas fa-home"></i>
          <span>Mes logements</span>
        </a>

        <a href="/welcome.html" class="nav-item active" data-page="welcome">
          <i class="fas fa-book-open"></i>
          <span>Livret d'accueil</span>
        </a>

        <a href="/cleaning.html" class="nav-item" data-page="cleaning">
          <i class="fas fa-broom"></i>
          <span>Gestion du ménage</span>
        </a>

        <a href="/factures.html" class="nav-item">
          <i class="fas fa-file-invoice"></i>
          <span>Factures clients</span>
        </a>

        <a href="/notifications.html" class="nav-item" data-page="notifications">
          <i class="fas fa-bell"></i>
          <span>Notifications</span>
        </a>
      </div>

      <!-- PARAMÈTRES -->
      <div class="nav-section">
        <div class="nav-section-title">Paramètres</div>

        <a href="/settings-account.html" class="nav-item" data-page="settings-account">
          <i class="fas fa-cog"></i>
          <span>Paramètres</span>
        </a>

        <a href="/help.html" class="nav-item" data-page="help">
          <i class="fas fa-question-circle"></i>
          <span>Aide</span>
        </a>
      </div>
    </nav>
    
    <div class="sidebar-footer">
      <div class="user-profile">
        <div class="user-avatar" id="sidebarUserAvatar">C</div>
        <div class="user-info">
          <div class="user-name" id="sidebarUserName">Utilisateur</div>
          <div class="user-email" id="sidebarUserCompany">Mon espace</div>
        </div>

        <button class="btn btn-ghost btn-xs" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </div>
  </aside>
  
  <!-- Main Content -->
  <main class="main-content-welcome">

  <div class="container">
    <!-- Page Title -->
    <div class="page-title">
      <h1>Créer un Livret d'Accueil</h1>
      <p>Créez un livret d'accueil personnalisé et professionnel pour vos voyageurs</p>
    </div>

    <!-- Progress Steps -->
    <div class="progress-steps">
      <div class="steps-container">
        <div class="step active" data-step="1">
          <div class="step-number">1</div>
          <div class="step-label">Informations<br>générales</div>
        </div>
        <div class="step" data-step="2">
          <div class="step-number">2</div>
          <div class="step-label">Accès &<br>Arrivée</div>
        </div>
        <div class="step" data-step="3">
          <div class="step-number">3</div>
          <div class="step-label">Le<br>Logement</div>
        </div>
        <div class="step" data-step="4">
          <div class="step-number">4</div>
          <div class="step-label">Informations<br>pratiques</div>
        </div>
        <div class="step" data-step="5">
          <div class="step-number">5</div>
          <div class="step-label">Aux<br>Alentours</div>
        </div>
      </div>
    </div>

    <!-- Liste des livrets existants -->
<div id="livretsListSection" class="form-card" style="margin-bottom: 2rem;">
  <h2 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; color: var(--gray-700);">
    <i class="fas fa-list"></i>
    Mes livrets d'accueil
  </h2>
  <div id="livretsList" style="margin-bottom: 1rem;">
    <p style="color: #64748b; text-align: center;">Chargement...</p>
  </div>
  <button type="button" class="btn btn-primary" onclick="createNewLivret()">
    <i class="fas fa-plus"></i>
    Créer un nouveau livret
  </button>
</div>
    <!-- Form -->
    <form id="welcomeForm" style="display: none;">
      <!-- Section 1: Informations Générales -->
      <div class="form-section active" data-section="1">
        <div class="form-card">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-home"></i>
              Informations Générales
            </h2>
            <p class="section-description">
              Commencez par les informations de base de votre logement
            </p>
          </div>

          <div class="info-box">
            <p><i class="fas fa-info-circle"></i> Ces informations apparaîtront sur la page d'accueil de votre livret</p>
          </div>

          <div class="form-group">
            <label>
              Nom du logement <span class="required">*</span>
              <span class="hint">Ex: "Votre Pied-à-Terre ", "Appartement Cosy Centre-Ville"</span>
            </label>
            <input type="text" class="form-control" name="propertyName" required placeholder="Nom de votre logement">
          </div>

          <div class="form-group">
            <label>
              Photo de couverture <span class="required">*</span>
              <span class="hint">Image principale qui apparaîtra en haut du livret (format recommandé: 1920x1080px)</span>
            </label>
            <div class="image-upload-area" onclick="document.getElementById('coverPhoto').click()">
              <i class="fas fa-cloud-upload-alt"></i>
              <p>Cliquez pour télécharger votre photo de couverture</p>
              <p class="supported-formats">JPG, PNG ou WebP (max 5MB)</p>
            </div>
            <input type="file" id="coverPhoto" accept="image/*" style="display: none;">
            <div class="image-preview" id="coverPhotoPreview"></div>
          </div>

          <div class="form-group">
            <label>
              Description d'accueil
              <span class="hint">Message de bienvenue pour vos voyageurs</span>
            </label>
            <textarea class="form-control" name="welcomeDescription" rows="3" placeholder="Ex: Nous sommes ravis de vous accueillir dans cet appartement. Ce livret contient toutes les informations pour profiter pleinement de votre séjour."></textarea>
          </div>

          <div class="form-group">
            <label>
              Votre numéro de téléphone <span class="required">*</span>
              <span class="hint">Pour que vos voyageurs puissent vous contacter</span>
            </label>
            <input type="tel" class="form-control" name="contactPhone" required placeholder="06 XX XX XX XX">
          </div>
        </div>

        <div class="form-actions">
          <div></div>
          <button type="button" class="btn btn-primary" onclick="nextSection()">
            Suivant
            <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <!-- Section 2: Accès & Arrivée -->
      <div class="form-section" data-section="2">
        <div class="form-card">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-map-marker-alt"></i>
              Accès & Arrivée
            </h2>
            <p class="section-description">
              Comment vos voyageurs accèdent-ils à votre logement ?
            </p>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label>
                Adresse complète <span class="required">*</span>
              </label>
              <input type="text" class="form-control" name="address" required placeholder="Numéro et rue">
            </div>

            <div class="form-group">
              <label>
                Code postal <span class="required">*</span>
              </label>
              <input type="text" class="form-control" name="postalCode" required placeholder="75001">
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label>
                Ville <span class="required">*</span>
              </label>
              <input type="text" class="form-control" name="city" required placeholder="Paris">
            </div>

            <div class="form-group">
              <label>
                Code de la boîte à clés
                <span class="hint">Si applicable</span>
              </label>
              <input type="text" class="form-control" name="keyboxCode" placeholder="Ex: 8670">
            </div>
          </div>

          <div class="form-group">
            <label>
              Instructions d'accès
              <span class="hint">Expliquez comment accéder au logement (portail, étage, etc.)</span>
            </label>
            <textarea class="form-control" name="accessInstructions" rows="4" placeholder="Ex: Poussez le portail, la boîte à clés est à gauche au niveau de la flèche rouge..."></textarea>
          </div>

          <div class="form-group">
            <label>
              Photos de l'entrée
              <span class="hint">Photos du portail, de l'entrée, de la boîte à clés, etc.</span>
            </label>
            <div class="image-upload-area" onclick="document.getElementById('entrancePhotos').click()">
              <i class="fas fa-images"></i>
              <p>Cliquez pour télécharger les photos de l'entrée</p>
              <p class="supported-formats">Vous pouvez sélectionner plusieurs images</p>
            </div>
            <input type="file" id="entrancePhotos" accept="image/*" multiple style="display: none;">
            <div class="image-preview" id="entrancePhotosPreview"></div>
          </div>

          <div class="form-group">
            <label>
              Parking
              <span class="hint">Informations sur le stationnement</span>
            </label>
            <textarea class="form-control" name="parkingInfo" rows="3" placeholder="Ex: Parking gratuit au 43-51 rue du Marché, 230 places sur 3 niveaux"></textarea>
          </div>

          <div class="form-group">
            <label>
              Photos du parking
              <span class="hint">Si applicable</span>
            </label>
            <div class="image-upload-area" onclick="document.getElementById('parkingPhotos').click()">
              <i class="fas fa-parking"></i>
              <p>Cliquez pour télécharger les photos du parking</p>
            </div>
            <input type="file" id="parkingPhotos" accept="image/*" multiple style="display: none;">
            <div class="image-preview" id="parkingPhotosPreview"></div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="prevSection()">
            <i class="fas fa-arrow-left"></i>
            Précédent
          </button>
          <button type="button" class="btn btn-primary" onclick="nextSection()">
            Suivant
            <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <!-- Section 3: Le Logement -->
      <div class="form-section" data-section="3">
        <div class="form-card">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-door-open"></i>
              Le Logement
            </h2>
            <p class="section-description">
              Présentez les différentes pièces et espaces de votre logement
            </p>
          </div>

          <div class="warning-box">
            <p><i class="fas fa-lightbulb"></i> Ajoutez autant de pièces que nécessaire pour présenter votre logement</p>
          </div>

          <div id="roomsContainer" class="repeatable-section">
            <!-- Les pièces seront ajoutées ici dynamiquement -->
          </div>

          <button type="button" class="add-item-btn" onclick="addRoom()">
            <i class="fas fa-plus-circle"></i>
            Ajouter une pièce / un espace
          </button>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="prevSection()">
            <i class="fas fa-arrow-left"></i>
            Précédent
          </button>
          <button type="button" class="btn btn-primary" onclick="nextSection()">
            Suivant
            <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <!-- Section 4: Informations Pratiques -->
      <div class="form-section" data-section="4">
        <div class="form-card">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-info-circle"></i>
              Informations Pratiques
            </h2>
            <p class="section-description">
              WiFi, équipements, consignes et tout ce qui est utile au quotidien
            </p>
          </div>

          <h3 style="margin-bottom: 1rem; color: var(--gray-700);">
            <i class="fas fa-wifi" style="color: var(--accent);"></i> WiFi
          </h3>

          <div class="form-grid">
            <div class="form-group">
              <label>Nom du réseau WiFi (SSID)</label>
              <input type="text" class="form-control" name="wifiSSID" placeholder="Nom du réseau">
            </div>

            <div class="form-group">
              <label>Mot de passe WiFi</label>
              <input type="text" class="form-control" name="wifiPassword" placeholder="Mot de passe">
            </div>
          </div>

          <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--gray-200);">

          <h3 style="margin-bottom: 1rem; color: var(--gray-700);">
            <i class="fas fa-clipboard-list" style="color: var(--accent);"></i> Consignes de départ
          </h3>

          <div class="form-group">
            <label>
              Heure de départ
              <span class="hint">Ex: 11h, 10h30</span>
            </label>
            <input type="text" class="form-control" name="checkoutTime" placeholder="11h">
          </div>

          <div class="form-group">
            <label>
              Instructions de départ
              <span class="hint">Ce que les voyageurs doivent faire avant de partir</span>
            </label>
            <textarea class="form-control" name="checkoutInstructions" rows="5" placeholder="Ex:&#10;- Éteindre toutes les lumières&#10;- Laver la vaisselle&#10;- Poser les serviettes au sol..."></textarea>
          </div>

          <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--gray-200);">

          <h3 style="margin-bottom: 1rem; color: var(--gray-700);">
            <i class="fas fa-toolbox" style="color: var(--accent);"></i> Équipements disponibles
          </h3>

          <div class="form-group">
            <label>
              Liste des équipements
              <span class="hint">Un équipement par ligne</span>
            </label>
            <textarea class="form-control" name="equipmentList" rows="8" placeholder="Ex:&#10;Machine à café Nespresso&#10;Micro-ondes&#10;Machine à laver&#10;Fer et planche à repasser..."></textarea>
          </div>

          <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--gray-200);">

          <h3 style="margin-bottom: 1rem; color: var(--gray-700);">
            <i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i> Règles importantes
          </h3>

          <div class="form-group">
            <label>
              Règles et avertissements
              <span class="hint">Ex: Poutre basse, logement non-fumeur, attention aux marches...</span>
            </label>
            <textarea class="form-control" name="importantRules" rows="4" placeholder="Entrez les règles importantes..."></textarea>
          </div>

          <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--gray-200);">

          <h3 style="margin-bottom: 1rem; color: var(--gray-700);">
            <i class="fas fa-train" style="color: var(--accent);"></i> Transports
          </h3>

          <div class="form-group">
            <label>
              Informations sur les transports
              <span class="hint">Comment accéder aux transports en commun, gares, etc.</span>
            </label>
            <textarea class="form-control" name="transportInfo" rows="6" placeholder="Ex: Bus ligne 15 à 1 minute à pied..."></textarea>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="prevSection()">
            <i class="fas fa-arrow-left"></i>
            Précédent
          </button>
          <button type="button" class="btn btn-primary" onclick="nextSection()">
            Suivant
            <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <!-- Section 5: Aux Alentours -->
      <div class="form-section" data-section="5">
        <div class="form-card">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-map-marked-alt"></i>
              Aux Alentours
            </h2>
            <p class="section-description">
              Recommandations de restaurants, commerces et lieux à visiter
            </p>
          </div>

          <h3 style="margin-bottom: 1rem; color: var(--gray-700);">
            <i class="fas fa-utensils" style="color: var(--accent);"></i> Restaurants & Bars
          </h3>

          <div id="restaurantsContainer" class="repeatable-section">
            <!-- Les restaurants seront ajoutés ici dynamiquement -->
          </div>

          <button type="button" class="add-item-btn" onclick="addRestaurant()">
            <i class="fas fa-plus-circle"></i>
            Ajouter un restaurant / bar
          </button>

          <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--gray-200);">

          <h3 style="margin-bottom: 1rem; color: var(--gray-700);">
            <i class="fas fa-shopping-bag" style="color: var(--accent);"></i> Commerces
          </h3>

          <div class="form-group">
            <label>
              Liste des commerces
              <span class="hint">Supermarchés, boulangeries, pharmacies, etc. (un par ligne)</span>
            </label>
            <textarea class="form-control" name="shopsList" rows="6" placeholder="Ex:&#10;FRANPRIX - 6 rue de Pontoise&#10;Boulangerie LA POTERNE - Place du marché..."></textarea>
          </div>

          <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--gray-200);">

          <h3 style="margin-bottom: 1rem; color: var(--gray-700);">
            <i class="fas fa-map-signs" style="color: var(--accent);"></i> Lieux à Visiter
          </h3>

          <div id="placesContainer" class="repeatable-section">
            <!-- Les lieux seront ajoutés ici dynamiquement -->
          </div>

          <button type="button" class="add-item-btn" onclick="addPlace()">
            <i class="fas fa-plus-circle"></i>
            Ajouter un lieu à visiter
          </button>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="prevSection()">
            <i class="fas fa-arrow-left"></i>
            Précédent
          </button>
          <button type="submit" class="btn btn-accent">
            <i class="fas fa-check-circle"></i>
            Créer le livret d'accueil
          </button>
        </div>
      </div>
    </form>

    <!-- Success Message -->
      <div class="success-message" id="successMessage">
  <div class="success-icon">
    <i class="fas fa-check"></i>
  </div>
  <h2>Livret d'accueil créé avec succès !</h2>
  <p>Votre livret d'accueil personnalisé a été généré.</p>
  
  <!-- QR Code Section -->
  <div style="background: white; padding: 2rem; border-radius: 12px; margin: 2rem auto; max-width: 400px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
    <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: #374151;">
      <i class="fas fa-qrcode"></i> QR Code du livret
    </h3>
    <div id="qrcode" style="display: flex; justify-content: center; margin-bottom: 1rem;"></div>
    <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 1rem;">
      Scannez ce code pour accéder directement au livret
    </p>
    <button class="btn btn-secondary" onclick="downloadQRCode()" style="width: 100%;">
      <i class="fas fa-download"></i>
      Télécharger le QR Code
    </button>
  </div>
      <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
        <button class="btn btn-primary" onclick="viewWelcomeBook()">
          <i class="fas fa-eye"></i>
          Voir le livret
        </button>
        
        <button class="btn btn-secondary" onclick="copyWelcomeBookLink(this)">
          <i class="fas fa-copy"></i>
          Copier le lien
        </button>

        <button class="btn btn-secondary" onclick="createAnother()">
          <i class="fas fa-edit"></i>
          Modifier
        </button>
      </div>
    </div>
  </div>
<script>
const API_BASE = 'https://lcc-booking-manager.onrender.com';
let currentUniqueId = null; // Pour savoir si on modifie ou on crée

// Charger la liste des livrets au démarrage
async function loadLivretsList() {
  try {
    const response = await fetch(`${API_BASE}/api/welcome-books/user/list`, {
      headers: { 'Authorization': `Bearer ${getAuthToken()}` }
    });
    
    const data = await response.json();
    
    if (data.success && data.welcomeBooks && data.welcomeBooks.length > 0) {
      displayLivretsList(data.welcomeBooks);
    } else {
      document.getElementById('livretsList').innerHTML = '<p style="color: #64748b; text-align: center;">Aucun livret pour le moment.</p>';
    }
  } catch (error) {
    console.error('Erreur chargement livrets:', error);
    document.getElementById('livretsList').innerHTML = '<p style="color: #e53e3e;">Erreur lors du chargement des livrets.</p>';
  }
}

// Afficher la liste des livrets
function displayLivretsList(livrets) {
  const html = livrets.map(livret => `
    <div style="border: 1px solid #e2e8f0; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; background: white;">
      <div>
        <strong style="font-size: 16px; color: #1a202c;">${livret.propertyName || 'Sans nom'}</strong>
        <br>
        <small style="color: #64748b;">Modifié le ${new Date(livret.updatedAt).toLocaleDateString('fr-FR')}</small>
      </div>
      <div style="display: flex; gap: 0.5rem;">
        <button class="btn btn-secondary" onclick="editLivret('${livret.uniqueId}')" style="font-size: 14px; padding: 0.5rem 1rem;">
          <i class="fas fa-edit"></i> Modifier
        </button>
        <button class="btn btn-secondary" onclick="viewLivret('${livret.uniqueId}')" style="font-size: 14px; padding: 0.5rem 1rem;">
          <i class="fas fa-eye"></i> Voir
        </button>
        <button class="btn btn-secondary" onclick="deleteLivret('${livret.uniqueId}')" style="font-size: 14px; padding: 0.5rem 1rem; background: #e53e3e; color: white;">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
  `).join('');
  
  document.getElementById('livretsList').innerHTML = html;
}

// Créer un nouveau livret
function createNewLivret() {
  currentUniqueId = null;
  document.getElementById('welcomeForm').reset();
  document.getElementById('livretsListSection').style.display = 'none';
  document.getElementById('welcomeForm').style.display = 'block';
  
  // Remonter en haut de la page
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Voir un livret
function viewLivret(uniqueId) {
  window.open(`${API_BASE}/welcome/${uniqueId}`, '_blank');
}

// Supprimer un livret
async function deleteLivret(uniqueId) {
  if (!confirm('Êtes-vous sûr de vouloir supprimer ce livret ?')) return;
  
  try {
    const response = await fetch(`${API_BASE}/api/welcome/by-unique/${uniqueId}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${getAuthToken()}` }
    });
    
    const data = await response.json();
    
    if (data.success) {
      alert('Livret supprimé avec succès');
      loadLivretsList();
    } else {
      alert('Erreur lors de la suppression');
    }
  } catch (error) {
    console.error('Erreur suppression:', error);
    alert('Erreur lors de la suppression');
  }
}

// Remplir le formulaire avec les données d'un livret
function fillFormWithData(data) {
  document.querySelector('[name="propertyName"]').value = data.propertyName || '';
  document.querySelector('[name="welcomeDescription"]').value = data.welcomeDescription || '';
  document.querySelector('[name="contactPhone"]').value = data.contactPhone || '';
  document.querySelector('[name="address"]').value = data.address || '';
  document.querySelector('[name="postalCode"]').value = data.postalCode || '';
  document.querySelector('[name="city"]').value = data.city || '';
  // ... ajoute les autres champs si besoin
}

// Charger la liste au démarrage de la page
document.addEventListener('DOMContentLoaded', function() {
  loadLivretsList();
});
// --- 1. GESTION AUTHENTIFICATION ---
function getAuthToken() {
  const t = localStorage.getItem('lcc_token');
  return (t && t !== 'undefined' && t !== 'null') ? t : null;
}

async function checkAuth({ redirect = true } = {}) {
  const token = getAuthToken();
  if (!token) {
    if (redirect) window.location.href = '/login.html';
    return false;
  }
  try {
    const res = await fetch(`${API_BASE}/api/auth/me`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    if (!res.ok) throw new Error('Auth failed');
    return true;
  } catch (err) {
    console.error('Erreur auth:', err);
    localStorage.removeItem('lcc_token');
    if (redirect) window.location.href = '/login.html';
    return false;
  }
}

function initLogout() {
  const btn = document.getElementById('logoutBtn');
  if (btn) btn.addEventListener('click', () => {
    localStorage.removeItem('lcc_token');
    window.location.href = '/login.html';
  });
}

// --- 2. GESTION DU FORMULAIRE (Navigation & Uploads) ---
let currentSection = 1;
const totalSections = 5;
let roomCounter = 0;
let restaurantCounter = 0;
let placeCounter = 0;

function nextSection() {
  if (currentSection < totalSections) {
    document.querySelector(`.form-section[data-section="${currentSection}"]`).classList.remove('active');
    document.querySelector(`.step[data-step="${currentSection}"]`).classList.add('completed');
    document.querySelector(`.step[data-step="${currentSection}"]`).classList.remove('active');
    currentSection++;
    document.querySelector(`.form-section[data-section="${currentSection}"]`).classList.add('active');
    document.querySelector(`.step[data-step="${currentSection}"]`).classList.add('active');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
}

function prevSection() {
  if (currentSection > 1) {
    document.querySelector(`.form-section[data-section="${currentSection}"]`).classList.remove('active');
    document.querySelector(`.step[data-step="${currentSection}"]`).classList.remove('active');
    currentSection--;
    document.querySelector(`.form-section[data-section="${currentSection}"]`).classList.add('active');
    document.querySelector(`.step[data-step="${currentSection}"]`).classList.add('active');
    document.querySelector(`.step[data-step="${currentSection}"]`).classList.remove('completed');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
}

function setupImageUpload(inputId, previewId) {
  const input = document.getElementById(inputId);
  const preview = document.getElementById(previewId);
  if (!input || !preview) return;

  input.addEventListener('change', function(e) {
    // Si c'est input unique (cover), on vide avant
    if (!input.multiple) preview.innerHTML = '';
    
    Array.from(e.target.files || []).forEach(file => {
      const reader = new FileReader();
      reader.onload = function(ev) {
        const div = document.createElement('div');
        div.className = 'image-preview-item';
        div.innerHTML = `<img src="${ev.target.result}"><button type="button" class="remove-btn" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>`;
        preview.appendChild(div);
      };
      reader.readAsDataURL(file);
    });
  });
}

function showExistingImage(containerId, url) {
    const container = document.getElementById(containerId);
    if (!container || !url) return;
    const div = document.createElement('div');
    div.className = 'image-preview-item';
    div.innerHTML = `<img src="${url}" style="object-fit:cover"><div style="position:absolute;bottom:0;background:rgba(0,0,0,0.5);color:white;width:100%;font-size:10px;text-align:center;">Image actuelle</div>`;
    container.appendChild(div);
}

// Initialisation des uploads statiques
setupImageUpload('coverPhoto', 'coverPhotoPreview');
setupImageUpload('entrancePhotos', 'entrancePhotosPreview');
setupImageUpload('parkingPhotos', 'parkingPhotosPreview');

// --- 3. GESTION DYNAMIQUE (Pièces, Restos, Lieux) ---
function addRoom() {
  roomCounter++;
  const container = document.getElementById('roomsContainer');
  const html = `
    <div class="repeatable-item" id="room-${roomCounter}">
      <div class="repeatable-item-header">
        <div class="repeatable-item-title"><i class="fas fa-door-closed"></i> Pièce ${roomCounter}</div>
        <button type="button" class="remove-item-btn" onclick="document.getElementById('room-${roomCounter}').remove()"><i class="fas fa-trash"></i></button>
      </div>
      <div class="form-group"><label>Nom</label><input type="text" class="form-control" name="room[${roomCounter}][name]"></div>
      <div class="form-group"><label>Description</label><textarea class="form-control" name="room[${roomCounter}][description]" rows="2"></textarea></div>
      <div class="form-group"><label>Photos</label>
        <div class="image-upload-area" onclick="document.getElementById('roomPhotos-${roomCounter}').click()"><i class="fas fa-camera"></i><p>Ajouter photos</p></div>
        <input type="file" id="roomPhotos-${roomCounter}" accept="image/*" multiple style="display:none;">
        <div class="image-preview" id="roomPhotosPreview-${roomCounter}"></div>
      </div>
    </div>`;
  container.insertAdjacentHTML('beforeend', html);
  setupImageUpload(`roomPhotos-${roomCounter}`, `roomPhotosPreview-${roomCounter}`);
}

function addRestaurant() {
  restaurantCounter++;
  const html = `
    <div class="repeatable-item" id="restaurant-${restaurantCounter}">
      <div class="repeatable-item-header">
         <div class="repeatable-item-title"><i class="fas fa-utensils"></i> Restaurant ${restaurantCounter}</div>
         <button type="button" class="remove-item-btn" onclick="document.getElementById('restaurant-${restaurantCounter}').remove()"><i class="fas fa-trash"></i></button>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>Nom</label><input type="text" class="form-control" name="restaurant[${restaurantCounter}][name]"></div>
        <div class="form-group"><label>Tél</label><input type="text" class="form-control" name="restaurant[${restaurantCounter}][phone]"></div>
      </div>
      <div class="form-group"><label>Adresse</label><input type="text" class="form-control" name="restaurant[${restaurantCounter}][address]"></div>
      <div class="form-group"><label>Description</label><textarea class="form-control" name="restaurant[${restaurantCounter}][description]" rows="2"></textarea></div>
    </div>`;
  document.getElementById('restaurantsContainer').insertAdjacentHTML('beforeend', html);
}

function addPlace() {
  placeCounter++;
  const html = `
    <div class="repeatable-item" id="place-${placeCounter}">
      <div class="repeatable-item-header">
         <div class="repeatable-item-title"><i class="fas fa-map-marker-alt"></i> Lieu ${placeCounter}</div>
         <button type="button" class="remove-item-btn" onclick="document.getElementById('place-${placeCounter}').remove()"><i class="fas fa-trash"></i></button>
      </div>
      <div class="form-group"><label>Nom</label><input type="text" class="form-control" name="place[${placeCounter}][name]"></div>
      <div class="form-group"><label>Description</label><textarea class="form-control" name="place[${placeCounter}][description]" rows="2"></textarea></div>
      <div class="form-group"><label>Photo</label>
        <div class="image-upload-area" onclick="document.getElementById('placePhoto-${placeCounter}').click()"><i class="fas fa-image"></i><p>Photo</p></div>
        <input type="file" id="placePhoto-${placeCounter}" accept="image/*" style="display:none;">
        <div class="image-preview" id="placePhotoPreview-${placeCounter}"></div>
      </div>
    </div>`;
  document.getElementById('placesContainer').insertAdjacentHTML('beforeend', html);
  setupImageUpload(`placePhoto-${placeCounter}`, `placePhotoPreview-${placeCounter}`);
}

// --- 4. CHARGEMENT DES DONNÉES EXISTANTES ---
async function loadExistingData() {
    const token = getAuthToken();
    if (!token) return;

    try {
        // On utilise la route principale de server-22.js qui est fiable
        const response = await fetch(`${API_BASE}/api/welcome`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) return;
        const data = await response.json();

        // Si on a des données, on remplit
        if (data && (data.propertyName || data.uniqueId)) {
            console.log("Données récupérées:", data);

            // Champs simples
            const fields = [
                'propertyName', 'welcomeDescription', 'contactPhone', 
                'address', 'postalCode', 'city', 'keyboxCode', 
                'accessInstructions', 'parkingInfo', 'wifiSSID', 
                'wifiPassword', 'checkoutTime', 'checkoutInstructions', 
                'equipmentList', 'importantRules', 'transportInfo', 'shopsList'
            ];
            fields.forEach(f => {
                const el = document.querySelector(`[name="${f}"]`);
                if (el && data[f]) el.value = data[f];
            });

            // Images existantes
            if (data.photos) {
                if(data.photos.cover) showExistingImage('coverPhotoPreview', data.photos.cover);
                if(Array.isArray(data.photos.entrance)) data.photos.entrance.forEach(u => showExistingImage('entrancePhotosPreview', u));
                if(Array.isArray(data.photos.parking)) data.photos.parking.forEach(u => showExistingImage('parkingPhotosPreview', u));
            }

            // Pièces
            document.getElementById('roomsContainer').innerHTML = '';
            roomCounter = 0;
            if (Array.isArray(data.rooms)) {
                data.rooms.forEach(r => {
                    addRoom();
                    document.querySelector(`[name="room[${roomCounter}][name]"]`).value = r.name || '';
                    document.querySelector(`[name="room[${roomCounter}][description]"]`).value = r.description || '';
                });
            } else { addRoom(); } // Une vide par défaut

            // Restaurants
            document.getElementById('restaurantsContainer').innerHTML = '';
            restaurantCounter = 0;
            if (Array.isArray(data.restaurants)) {
                data.restaurants.forEach(r => {
                    addRestaurant();
                    document.querySelector(`[name="restaurant[${restaurantCounter}][name]"]`).value = r.name || '';
                    document.querySelector(`[name="restaurant[${restaurantCounter}][phone]"]`).value = r.phone || '';
                    document.querySelector(`[name="restaurant[${restaurantCounter}][address]"]`).value = r.address || '';
                    document.querySelector(`[name="restaurant[${restaurantCounter}][description]"]`).value = r.description || '';
                });
            } else { addRestaurant(); }

            // Lieux
            document.getElementById('placesContainer').innerHTML = '';
            placeCounter = 0;
            if (Array.isArray(data.places)) {
                data.places.forEach(p => {
                    addPlace();
                    document.querySelector(`[name="place[${placeCounter}][name]"]`).value = p.name || '';
                    document.querySelector(`[name="place[${placeCounter}][description]"]`).value = p.description || '';
                });
            } else { addPlace(); }

            // URL Public
            if (data.uniqueId) {
                window.welcomeBookUrl = `${API_BASE}/welcome/${data.uniqueId}`;
            }
        } else {
            // Pas de données : on initialise les champs vides
            addRoom();
            addRestaurant();
            addPlace();
        }
    } catch (e) {
        console.error("Erreur chargement:", e);
        // Fallback
        addRoom(); addRestaurant(); addPlace();
    }
}

// --- 5. SOUMISSION ET INITIALISATION ---
function collectFormData() {
  const formData = new FormData();
  // Champs textes simples
  const fields = ['propertyName','welcomeDescription','contactPhone','address','postalCode','city','keyboxCode','accessInstructions','parkingInfo','wifiSSID','wifiPassword','checkoutTime','checkoutInstructions','equipmentList','importantRules','transportInfo','shopsList'];
  fields.forEach(f => formData.append(f, document.querySelector(`[name="${f}"]`)?.value || ''));

  // Fichiers principaux
  const cover = document.getElementById('coverPhoto').files[0];
  if(cover) formData.append('coverPhoto', cover);
  
  const entrance = document.getElementById('entrancePhotos').files;
  for(let f of entrance) formData.append('entrancePhotos', f);
  
  const parking = document.getElementById('parkingPhotos').files;
  for(let f of parking) formData.append('parkingPhotos', f);

  // Arrays (Rooms, etc)
  const rooms = [];
  document.querySelectorAll('[id^="room-"]').forEach(el => {
     // On extrait l'index depuis l'ID "room-1", "room-2"
     const idParts = el.id.split('-');
     const idx = idParts[1];
     rooms.push({
        name: el.querySelector(`[name="room[${idx}][name]"]`)?.value || '',
        description: el.querySelector(`[name="room[${idx}][description]"]`)?.value || ''
     });
     const files = document.getElementById(`roomPhotos-${idx}`)?.files;
     if(files) for(let f of files) formData.append('roomPhotos', f);
  });
  formData.append('rooms', JSON.stringify(rooms));

  const restos = [];
  document.querySelectorAll('[id^="restaurant-"]').forEach(el => {
     const idx = el.id.split('-')[1];
     restos.push({
        name: el.querySelector(`[name="restaurant[${idx}][name]"]`)?.value || '',
        phone: el.querySelector(`[name="restaurant[${idx}][phone]"]`)?.value || '',
        address: el.querySelector(`[name="restaurant[${idx}][address]"]`)?.value || '',
        description: el.querySelector(`[name="restaurant[${idx}][description]"]`)?.value || ''
     });
  });
  formData.append('restaurants', JSON.stringify(restos));

  const places = [];
  document.querySelectorAll('[id^="place-"]').forEach(el => {
     const idx = el.id.split('-')[1];
     places.push({
        name: el.querySelector(`[name="place[${idx}][name]"]`)?.value || '',
        description: el.querySelector(`[name="place[${idx}][description]"]`)?.value || ''
     });
     const file = document.getElementById(`placePhoto-${idx}`)?.files[0];
     if(file) formData.append('placePhotos', file);
  });
  formData.append('places', JSON.stringify(places));

  return formData;
}

document.addEventListener('DOMContentLoaded', async () => {
  const isAuth = await checkAuth({ redirect: false });
  initLogout();
  
  const form = document.getElementById('welcomeForm');
  if (form) {
      form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const btn = form.querySelector('button[type="submit"]');
          const oldText = btn.innerHTML;
          btn.disabled = true;
          btn.innerHTML = '<div class="spinner"></div> Sauvegarde...';

          try {
              const token = getAuthToken();
              const formData = collectFormData();
              const res = await fetch(`${API_BASE}/api/welcome-books/create`, {
                  method: 'POST',
                  headers: { Authorization: `Bearer ${token}` },
                  body: formData
              });
              
              const result = await res.json();
             if (result.success) {
  document.getElementById('successMessage').classList.add('show');
  window.scrollTo({top:0, behavior:'smooth'});
  if(result.uniqueId) {
    window.welcomeBookUrl = `${API_BASE}/welcome/${result.uniqueId}`;
    // Générer le QR Code
    setTimeout(() => generateQRCode(window.welcomeBookUrl), 100);
  }
              } else {
                  alert("Erreur: " + (result.error || "Inconnue"));
              }
          } catch (err) {
              console.error(err);
              alert("Erreur technique");
          } finally {
              btn.disabled = false;
              btn.innerHTML = oldText;
          }
      });
  }

  // Si connecté, on charge les données
  if (isAuth) {
      await loadExistingData();
  }
});

function viewWelcomeBook() {
    if(window.welcomeBookUrl) window.open(window.welcomeBookUrl, '_blank');
}

// Fonction pour copier le lien du livret
function copyWelcomeBookLink(button) {
  if (!window.welcomeBookUrl) {
    alert('URL du livret introuvable');
    return;
  }
  
  // Copier dans le presse-papier
  navigator.clipboard.writeText(window.welcomeBookUrl).then(() => {
    // Changer temporairement le texte du bouton
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i> Copié !';
    button.style.background = '#10B981';
    button.style.color = 'white';
    
    setTimeout(() => {
      button.innerHTML = originalText;
      button.style.background = '';
      button.style.color = '';
    }, 2000);
  }).catch(err => {
    console.error('Erreur copie:', err);
    alert('Erreur lors de la copie du lien');
  });
}

// Fonction pour modifier le livret (revenir au formulaire)
function createAnother() {
  // Cacher le message de succès
  document.getElementById('successMessage').classList.remove('show');
  
  // Afficher le formulaire
  document.getElementById('welcomeForm').style.display = 'block';
  
  // Recharger les données existantes
  loadExistingData();
  
  // Remonter en haut
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
// Générer le QR Code
function generateQRCode(url) {
  const qrContainer = document.getElementById('qrcode');
  qrContainer.innerHTML = ''; // Vider le conteneur
  
  new QRCode(qrContainer, {
    text: url,
    width: 200,
    height: 200,
    colorDark: "#000000",
    colorLight: "#ffffff",
    correctLevel: QRCode.CorrectLevel.H
  });
}

// Télécharger le QR Code
function downloadQRCode() {
  const qrCanvas = document.querySelector('#qrcode canvas');
  if (!qrCanvas) {
    alert('QR Code introuvable');
    return;
  }
  
  // Convertir le canvas en image
  const url = qrCanvas.toDataURL('image/png');
  
  // Créer un lien de téléchargement
  const link = document.createElement('a');
  link.download = `qrcode-${window.welcomeBookUrl ? window.welcomeBookUrl.split('/').pop() : 'livret'}.png`;
  link.href = url;
  link.click();
}
// Afficher la liste des livrets
function displayLivretsList(livrets) {
  const html = livrets.map(livret => `
    <div style="border: 1px solid #e2e8f0; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
      <div>
        <strong>${livret.propertyName || 'Sans nom'}</strong>
        <br>
        <small style="color: #64748b;">Modifié le ${new Date(livret.updatedAt).toLocaleDateString('fr-FR')}</small>
      </div>
      <div style="display: flex; gap: 0.5rem;">
        <button class="btn btn-secondary btn-sm" onclick="editLivret('${livret.uniqueId}')">
          <i class="fas fa-edit"></i> Modifier
        </button>
<button class="btn btn-secondary btn-sm" onclick="viewLivret('${livret.uniqueId}')">
<i class="fas fa-eye"></i> Voir
        </button>
        <button class="btn btn-secondary btn-sm" onclick="deleteLivret('${livret.uniqueId}')">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
  `).join('');
  
  document.getElementById('livretsList').innerHTML = html;
}

// Créer un nouveau livret
function createNewLivret() {
  currentUniqueId = null;
  document.getElementById('welcomeForm').reset();
  document.getElementById('livretsListSection').style.display = 'none';
  document.querySelector('form').style.display = 'block';
}

// Modifier un livret existant
async function editLivret(uniqueId) {
  currentUniqueId = uniqueId;
  
  try {
    const response = await fetch(`${API_BASE}/api/welcome-books/public/${uniqueId}`);
    
    const data = await response.json();
    
    if (data.success && data.book) {
      fillFormWithData(data.book);
      document.getElementById('livretsListSection').style.display = 'none';
      document.getElementById('welcomeForm').style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  } catch (error) {
    console.error('Erreur chargement livret:', error);
    alert('Erreur lors du chargement du livret');
  }
}

// Voir un livret
function viewLivret(uniqueId) {
  window.open(`${API_BASE}/welcome/${uniqueId}`, '_blank');
}

// Supprimer un livret
async function deleteLivret(uniqueId) {
  if (!confirm('Êtes-vous sûr de vouloir supprimer ce livret ?')) return;
  
  try {
    const response = await fetch(`${API_BASE}/api/welcome-books/by-unique/${uniqueId}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${getAuthToken()}` }
    });
    
    const data = await response.json();
    
    if (data.success) {
      alert('Livret supprimé avec succès');
      loadLivretsList();
    } else {
      alert('Erreur lors de la suppression');
    }
  } catch (error) {
    console.error('Erreur suppression:', error);
    alert('Erreur lors de la suppression');
  }
}

// Remplir le formulaire avec les données d'un livret
function fillFormWithData(data) {
  // À compléter selon tes champs
  document.querySelector('[name="propertyName"]').value = data.propertyName || '';
  document.querySelector('[name="welcomeDescription"]').value = data.welcomeDescription || '';
  // ... etc pour tous les champs
}

// Appeler loadLivretsList() au chargement de la page
document.addEventListener('DOMContentLoaded', loadLivretsList);
</script>
</main>
</div>
</body>
</html>
