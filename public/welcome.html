<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Cr√©ateur de Livret d'Accueil ‚Äì Boostinghost</title>
<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;family=Cormorant+Garamond:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>
<script src="/js/auth-fetch.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<!-- Platform CSS -->
<link href="/css/style.css?v=3" rel="stylesheet"/><link href="/css/bh-shared.css?v=1" rel="stylesheet"/><link href="/css/bottom-bar-enhanced.css" rel="stylesheet"/><link href="/css/menu-plus-fixes.css" rel="stylesheet"/><link href="/css/menu-active-button.css" rel="stylesheet"/>
<link href="/css/messages-badge-fix.css" rel="stylesheet"/>
   <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #10B981;
      --primary-dark: #059669;
      --secondary: #3B82F6;
      --accent: #E67E50;
      --dark: #111827;
      --gray-50: #F9FAFB;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-300: #D1D5DB;
      --gray-400: #9CA3AF;
      --gray-500: #6B7280;
      --gray-600: #4B5563;
      --gray-700: #374151;
      --gray-800: #1F2937;
      --gray-900: #111827;
      --white: #FFFFFF;
      --success: #10B981;
      --warning: #F59E0B;
      --danger: #EF4444;
    }
/* Layout avec sidebar */
.app-container {
  display: flex;
  min-height: 100vh;
}

.sidebar {
  width: 260px;
  flex-shrink: 0;
}

.main-content-welcome {
  flex: 1;
  overflow-x: hidden;
}
    body {
      font-family: 'Inter', sans-serif;
      background: var(--gray-50);
      color: var(--gray-900);
      line-height: 1.6;
    }

    .container {
  max-width: 100%;
  margin: 0;
  padding: 2rem;
  width: 100%;
}

    /* Header */

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.2rem;
    }

    .logo-text {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .logo-text .green {
      color: var(--primary);
    }

    .logo-text .dark {
      color: var(--gray-900);
    }

    .header-actions {
      display: flex;
      gap: 1rem;
    }

    /* Page Title */
    .page-title {
      margin-bottom: 2rem;
    }

    .page-title h1 {
      font-size: 2rem;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 0.5rem;
    }

    .page-title p {
      font-size: 1rem;
      color: var(--gray-500);
    }

    /* Progress Steps */
    .progress-steps {
      background: var(--white);
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }

    .steps-container {
      display: flex;
      justify-content: space-between;
      position: relative;
    }

    .steps-container::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--gray-200);
      z-index: 0;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 1;
      flex: 1;
    }

    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--gray-200);
      color: var(--gray-500);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      margin-bottom: 0.5rem;
      transition: all 0.3s ease;
    }

    .step.active .step-number {
      background: var(--primary);
      color: white;
    }

    .step.completed .step-number {
      background: var(--success);
      color: white;
    }

    .step-label {
      font-size: 0.875rem;
      color: var(--gray-500);
      text-align: center;
      font-weight: 500;
    }

    .step.active .step-label {
      color: var(--primary);
      font-weight: 600;
    }

    /* Form Card */
    .form-card {
      background: var(--white);
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .form-section {
      display: none;
    }

    .form-section.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .section-header {
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--gray-100);
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .section-title i {
      color: var(--accent);
    }

    .section-description {
      font-size: 0.95rem;
      color: var(--gray-500);
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 0.5rem;
    }

    .form-group label .required {
      color: var(--danger);
    }

    .form-group .hint {
      font-size: 0.8rem;
      color: var(--gray-500);
      font-weight: 400;
      display: block;
      margin-top: 0.25rem;
    }

    .form-control {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    textarea.form-control {
      resize: vertical;
      min-height: 100px;
    }

    /* Grid Layout */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
    }

    /* Image Upload */
    .image-upload-area {
      border: 2px dashed var(--gray-300);
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: var(--gray-50);
    }

    .image-upload-area:hover {
      border-color: var(--primary);
      background: rgba(16, 185, 129, 0.05);
    }

    .image-upload-area i {
      font-size: 3rem;
      color: var(--gray-400);
      margin-bottom: 1rem;
    }

    .image-upload-area p {
      color: var(--gray-600);
      margin-bottom: 0.5rem;
    }

    .image-upload-area .supported-formats {
      font-size: 0.8rem;
      color: var(--gray-400);
    }

    .image-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .image-preview-item {
      position: relative;
      aspect-ratio: 4/3;
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid var(--gray-200);
    }

    .image-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-preview-item .remove-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: rgba(239, 68, 68, 0.9);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .image-preview-item .remove-btn:hover {
      background: var(--danger);
      transform: scale(1.1);
    }

    /* Repeatable Items */
    .repeatable-section {
      margin-bottom: 2rem;
    }

    .repeatable-item {
      background: var(--gray-50);
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      position: relative;
      border: 1px solid var(--gray-200);
    }

    .repeatable-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--gray-200);
    }

    .repeatable-item-title {
      font-weight: 600;
      color: var(--gray-700);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .remove-item-btn {
      background: transparent;
      border: none;
      color: var(--danger);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    .remove-item-btn:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    .add-item-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      background: var(--gray-100);
      color: var(--gray-700);
      border: 1px dashed var(--gray-300);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      margin-top: 1rem;
    }

    .add-item-btn:hover {
      background: var(--gray-200);
      border-color: var(--gray-400);
    }

    /* Buttons */
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-secondary {
      background: var(--gray-200);
      color: var(--gray-700);
    }

    .btn-secondary:hover {
      background: var(--gray-300);
    }

    .btn-accent {
      background: var(--accent);
      color: white;
    }

    .btn-accent:hover {
      background: #d46d42;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(230, 126, 80, 0.3);
    }

    .form-actions {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 2px solid var(--gray-100);
    }

    /* Info Box */
    .info-box {
      background: rgba(16, 185, 129, 0.1);
      border-left: 4px solid var(--primary);
      padding: 1rem 1.25rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }

    .info-box i {
      color: var(--primary);
      margin-right: 0.5rem;
    }

    .info-box p {
      color: var(--gray-700);
      font-size: 0.9rem;
    }

    /* Warning Box */
    .warning-box {
      background: rgba(245, 158, 11, 0.1);
      border-left: 4px solid var(--warning);
      padding: 1rem 1.25rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }

    .warning-box i {
      color: var(--warning);
      margin-right: 0.5rem;
    }

    /* Success Message */
    .success-message {
      display: none;
      background: var(--white);
      border-radius: 12px;
      padding: 3rem;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .success-message.show {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    .success-icon {
      width: 80px;
      height: 80px;
      background: var(--success);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
      color: white;
      font-size: 2.5rem;
    }

    .success-message h2 {
      font-size: 1.75rem;
      color: var(--gray-900);
      margin-bottom: 0.75rem;
    }

    .success-message p {
      color: var(--gray-600);
      margin-bottom: 2rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      .form-card {
        padding: 1.5rem;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .steps-container {
        flex-wrap: wrap;
        gap: 1rem;
      }

      .step {
        flex-basis: 45%;
      }

      .form-actions {
        flex-direction: column;
      }

      .page-title h1 {
        font-size: 1.5rem;
      }
    }

    /* Loading Spinner */
    .spinner {
      border: 3px solid var(--gray-200);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
 /* Fix d√©finitif pour le contenu avec sidebar */
.app-container {
  display: flex;
  min-height: 100vh;
}

.sidebar {
  width: 260px;
  flex-shrink: 0;
  position: fixed;
  left: 0;
  top: 0;
  height: 100vh;
  z-index: 100;
}

.main-content-welcome {
  flex: 1;
  margin-left: 260px;
  width: calc(100% - 260px);
  background: var(--gray-50);
  min-height: 100vh;
}
  .main-content-welcome {
    margin-left: 0;
    width: 100%;
  }
}
   /* ‚úÖ Welcome: sidebar mobile OFF-CANVAS (menu fonctionne) */
@media (max-width: 768px) {
  aside.sidebar, .sidebar { display: block !important; }

  aside.sidebar {
    position: fixed !important;
    left: 0 !important;
    top: 0 !important;
    height: 100vh !important;
    transform: translateX(-110%) !important;
    transition: transform .25s ease !important;
  }
  aside.sidebar.active { transform: translateX(0) !important; }

  #sidebarOverlay.sidebar-overlay {
    position: fixed !important;
    inset: 0 !important;
    pointer-events: none;
  }
  #sidebarOverlay.sidebar-overlay.active {
    pointer-events: auto;
  }
}

/* ‚úÖ Welcome: stepper mobile (scroll horizontal propre) */
@media (max-width: 768px) {
  .progress-steps {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding: 1rem !important;
  }

  .steps-container {
    display: flex !important;
    flex-wrap: nowrap !important;
    gap: 14px !important;
    min-width: max-content !important;
    justify-content: flex-start !important;
    padding: 8px 4px !important;
  }

  .steps-container::before { display: none !important; }

  .step {
    flex: 0 0 auto !important;
    min-width: 150px !important;
    align-items: flex-start !important;
    background: #fff;
    border: 1px solid rgba(148,163,184,.30);
    border-radius: 16px;
    padding: 12px;
  }

  .step-label {
    text-align: left !important;
    white-space: normal !important;
    line-height: 1.25 !important;
  }
}
<style>
/* ‚úÖ Uniformisation du bouton "Retour au dashboard" (header) */
.main-header .header-actions .btn.btn-ghost{
  border-radius: 999px !important;
  border: 1px solid rgba(148, 163, 184, 0.45) !important;
  background: transparent !important;
  padding: 10px 16px !important;
  font-size: 14px !important;
  font-weight: 600 !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;
  color: inherit !important;
  box-shadow: none !important;
}
.main-header .header-actions .btn.btn-ghost i{
  font-size: 16px !important;
}
.main-header .header-actions .btn.btn-ghost:hover{
  background: rgba(15, 23, 42, 0.06) !important;
}
[data-theme="dark"] .main-header .header-actions .btn.btn-ghost:hover{
  background: rgba(15, 23, 42, 0.90) !important;
}
</style><style id="bhWelcomeFixes">
/* ‚úÖ Mobile global : √©viter le contenu sous le header mobile */
@media (max-width: 768px){
  body{ padding-top:72px !important; }
}

/* ‚úÖ Welcome: stepper mobile en scroll horizontal */
@media (max-width: 768px){
  .progress-steps{ overflow-x:auto !important; -webkit-overflow-scrolling:touch; padding:1rem !important; }
  .steps-container{ display:flex !important; flex-wrap:nowrap !important; gap:14px !important; min-width:max-content !important; justify-content:flex-start !important; padding:8px 4px !important; }
  .steps-container::before{ display:none !important; }
  .step{ flex:0 0 auto !important; min-width:150px !important; align-items:flex-start !important; }
  .step-label{ text-align:left !important; white-space:normal !important; line-height:1.25 !important; }
}

/* ‚úÖ Welcome: menu mobile OFF-CANVAS (sidebar visible + overlay cliquable) */
@media (max-width: 768px){
  #bhSidebar aside.sidebar, aside.sidebar{ display:block !important; position:fixed !important; left:0 !important; top:0 !important; height:100vh !important; transform:translateX(-110%) !important; transition:transform .25s ease !important; z-index:1200 !important; }
  #bhSidebar aside.sidebar.active, aside.sidebar.active{ transform:translateX(0) !important; }
  #sidebarOverlay.sidebar-overlay{ position:fixed !important; inset:0 !important; z-index:1100 !important; pointer-events:none; }
  #sidebarOverlay.sidebar-overlay.active{ pointer-events:auto; }
  .mobile-header{ position:fixed !important; top:0; left:0; right:0; z-index:1300 !important; }
}
</style>

<!-- üî• FIX DEFINITIF SIDEBAR - NE PAS SUPPRIMER -->
<style>
/* CORRECTION : la sidebar masque le contenu */

/* Desktop : le contenu doit avoir un margin-left pour √©viter la sidebar */
@media (min-width: 769px) {
  .main-content-welcome,
  .main-content {
    margin-left: 260px !important;
    width: calc(100% - 260px) !important;
    padding-left: 2rem !important;
    padding-right: 2rem !important;
  }
  
  /* S'assurer que la sidebar est bien fixe √† gauche */
  #bhSidebar,
  .sidebar,
  aside.sidebar {
    position: fixed !important;
    left: 0 !important;
    top: 0 !important;
    width: 260px !important;
    height: 100vh !important;
    overflow-y: auto !important;
    z-index: 1000 !important;
  }
}

/* Mobile : pas de margin, sidebar cach√©e */
@media (max-width: 768px) {
  .main-content-welcome,
  .main-content {
    margin-left: 0 !important;
    width: 100% !important;
    padding-left: 1rem !important;
    padding-right: 1rem !important;
  }
}

/* Container spacing */
.container {
  max-width: 1400px !important;
  margin-left: auto !important;
  margin-right: auto !important;
}
</style>

<link rel="stylesheet" href="/css/mobile-native-styles.css">
</head>
<body data-back-href="/app.html" data-back-label="Retour au dashboard" data-kicker="Gestion" data-page="welcome" data-subtitle="Cr√©ez et g√©rez vos livrets d‚Äôaccueil." data-title="Livret d'accueil"><div class="mobile-header">
<a class="mobile-logo" href="/app.html">
<i class="fas fa-calendar-check"></i>
<span class="mobile-logo-text">Boostinghost</span>
</a>
<button class="mobile-menu-btn" id="mobileMenuBtn">
<i class="fas fa-bars"></i>
</button>
</div>
<!-- Sidebar Overlay (pour mobile) -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>
<div class="app-container">
<!-- Sidebar -->
<div id="bhSidebar"></div>
<!-- Main Content -->
<main class="main-content-welcome main-content"><div id="bhHeader"></div>
<div class="container">
<!-- Page Title -->
<div class="page-title">
<h1>Cr√©er un Livret d'Accueil</h1>
<p>Cr√©ez un livret d'accueil personnalis√© et professionnel pour vos voyageurs</p>
</div>
<!-- Progress Steps -->
<div class="progress-steps">
<div class="steps-container">
<div class="step active" data-step="1">
<div class="step-number">1</div>
<div class="step-label">Informations<br/>g√©n√©rales</div>
</div>
<div class="step" data-step="2">
<div class="step-number">2</div>
<div class="step-label">Acc√®s &amp;<br/>Arriv√©e</div>
</div>
<div class="step" data-step="3">
<div class="step-number">3</div>
<div class="step-label">Le<br/>Logement</div>
</div>
<div class="step" data-step="4">
<div class="step-number">4</div>
<div class="step-label">Informations<br/>pratiques</div>
</div>
<div class="step" data-step="5">
<div class="step-number">5</div>
<div class="step-label">Aux<br/>Alentours</div>
</div>
</div>
</div>
<!-- Liste des livrets existants -->
<div class="form-card" id="livretsListSection" style="margin-bottom: 2rem;">
<h2 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; color: var(--gray-700);">
<i class="fas fa-list"></i>
    Mes livrets d'accueil
  </h2>
<div id="livretsList" style="margin-bottom: 1rem;">
<p style="color: #64748b; text-align: center;">Chargement...</p>
</div>
<button class="btn btn-primary" onclick="createNewLivret()" type="button">
<i class="fas fa-plus"></i>
    Cr√©er un nouveau livret
  </button>
</div>
<!-- Form -->
<form id="welcomeForm" style="display: none;">
<!-- Section 1: Informations G√©n√©rales -->
<div class="form-section active" data-section="1">
<div class="form-card">
<div class="section-header">
<h2 class="section-title">
<i class="fas fa-home"></i>
              Informations G√©n√©rales
            </h2>
<p class="section-description">
              Commencez par les informations de base de votre logement
            </p>
</div>
<div class="info-box">
<p><i class="fas fa-info-circle"></i> Ces informations appara√Ætront sur la page d'accueil de votre livret</p>
</div>
<div class="form-group">
<label>
              Nom du logement <span class="required">*</span>
<span class="hint">Ex: "Votre Pied-√†-Terre ", "Appartement Cosy Centre-Ville"</span>
</label>
<input class="form-control" name="propertyName" placeholder="Nom de votre logement" required="" type="text"/>
</div>
<div class="form-group">
<label>
              Photo de couverture <span class="required">*</span>
<span class="hint">Image principale qui appara√Ætra en haut du livret (format recommand√©: 1920x1080px)</span>
</label>
<div class="image-upload-area" onclick="document.getElementById('coverPhoto').click()">
<i class="fas fa-cloud-upload-alt"></i>
<p>Cliquez pour t√©l√©charger votre photo de couverture</p>
<p class="supported-formats">JPG, PNG ou WebP (max 5MB)</p>
</div>
<input accept="image/*" id="coverPhoto" style="display: none;" type="file"/>
<div class="image-preview" id="coverPhotoPreview"></div>
</div>
<div class="form-group">
<label>
              Description d'accueil
              <span class="hint">Message de bienvenue pour vos voyageurs</span>
</label>
<textarea class="form-control" name="welcomeDescription" placeholder="Ex: Nous sommes ravis de vous accueillir dans cet appartement. Ce livret contient toutes les informations pour profiter pleinement de votre s√©jour." rows="3"></textarea>
</div>
<div class="form-group">
<label>
              Votre num√©ro de t√©l√©phone <span class="required">*</span>
<span class="hint">Pour que vos voyageurs puissent vous contacter</span>
</label>
<input class="form-control" name="contactPhone" placeholder="06 XX XX XX XX" required="" type="tel"/>
</div>
</div>
<div class="form-actions">
<div></div>
<button class="btn btn-primary" onclick="nextSection()" type="button">
            Suivant
            <i class="fas fa-arrow-right"></i>
</button>
</div>
</div>
<!-- Section 2: Acc√®s & Arriv√©e -->
<div class="form-section" data-section="2">
<div class="form-card">
<div class="section-header">
<h2 class="section-title">
<i class="fas fa-map-marker-alt"></i>
              Acc√®s &amp; Arriv√©e
            </h2>
<p class="section-description">
              Comment vos voyageurs acc√®dent-ils √† votre logement ?
            </p>
</div>
<div class="form-grid">
<div class="form-group">
<label>
                Adresse compl√®te <span class="required">*</span>
</label>
<input class="form-control" name="address" placeholder="Num√©ro et rue" required="" type="text"/>
</div>
<div class="form-group">
<label>
                Code postal <span class="required">*</span>
</label>
<input class="form-control" name="postalCode" placeholder="75001" required="" type="text"/>
</div>
</div>
<div class="form-grid">
<div class="form-group">
<label>
                Ville <span class="required">*</span>
</label>
<input class="form-control" name="city" placeholder="Paris" required="" type="text"/>
</div>
<div class="form-group">
<label>
                Code de la bo√Æte √† cl√©s
                <span class="hint">Si applicable</span>
</label>
<input class="form-control" name="keyboxCode" placeholder="Ex: 8670" type="text"/>
</div>
</div>
<div class="form-group">
<label>
              Instructions d'acc√®s
              <span class="hint">Expliquez comment acc√©der au logement (portail, √©tage, etc.)</span>
</label>
<textarea class="form-control" name="accessInstructions" placeholder="Ex: Poussez le portail, la bo√Æte √† cl√©s est √† gauche au niveau de la fl√®che rouge..." rows="4"></textarea>
</div>
<div class="form-group">
<label>
              Photos de l'entr√©e
              <span class="hint">Photos du portail, de l'entr√©e, de la bo√Æte √† cl√©s, etc.</span>
</label>
<div class="image-upload-area" onclick="document.getElementById('entrancePhotos').click()">
<i class="fas fa-images"></i>
<p>Cliquez pour t√©l√©charger les photos de l'entr√©e</p>
<p class="supported-formats">Vous pouvez s√©lectionner plusieurs images</p>
</div>
<input accept="image/*" id="entrancePhotos" multiple="" style="display: none;" type="file"/>
<div class="image-preview" id="entrancePhotosPreview"></div>
</div>
<div class="form-group">
<label>
              Parking
              <span class="hint">Informations sur le stationnement</span>
</label>
<textarea class="form-control" name="parkingInfo" placeholder="Ex: Parking gratuit au 43-51 rue du March√©, 230 places sur 3 niveaux" rows="3"></textarea>
</div>
<div class="form-group">
<label>
              Photos du parking
              <span class="hint">Si applicable</span>
</label>
<div class="image-upload-area" onclick="document.getElementById('parkingPhotos').click()">
<i class="fas fa-parking"></i>
<p>Cliquez pour t√©l√©charger les photos du parking</p>
</div>
<input accept="image/*" id="parkingPhotos" multiple="" style="display: none;" type="file"/>
<div class="image-preview" id="parkingPhotosPreview"></div>
</div>
</div>
<div class="form-actions">
<button class="btn btn-secondary" onclick="prevSection()" type="button">
<i class="fas fa-arrow-left"></i>
            Pr√©c√©dent
          </button>
<button class="btn btn-primary" onclick="nextSection()" type="button">
            Suivant
            <i class="fas fa-arrow-right"></i>
</button>
</div>
</div>
<!-- Section 3: Le Logement -->
<div class="form-section" data-section="3">
<div class="form-card">
<div class="section-header">
<h2 class="section-title">
<i class="fas fa-door-open"></i>
              Le Logement
            </h2>
<p class="section-description">
              Pr√©sentez les diff√©rentes pi√®ces et espaces de votre logement
            </p>
</div>
<div class="warning-box">
<p><i class="fas fa-lightbulb"></i> Ajoutez autant de pi√®ces que n√©cessaire pour pr√©senter votre logement</p>
</div>
<div class="repeatable-section" id="roomsContainer">
<!-- Les pi√®ces seront ajout√©es ici dynamiquement -->
</div>
<button class="add-item-btn" onclick="addRoom()" type="button">
<i class="fas fa-plus-circle"></i>
            Ajouter une pi√®ce / un espace
          </button>
</div>
<div class="form-actions">
<button class="btn btn-secondary" onclick="prevSection()" type="button">
<i class="fas fa-arrow-left"></i>
            Pr√©c√©dent
          </button>
<button class="btn btn-primary" onclick="nextSection()" type="button">
            Suivant
            <i class="fas fa-arrow-right"></i>
</button>
</div>
</div>
<!-- Section 4: Informations Pratiques -->
<div class="form-section" data-section="4">
<div class="form-card">
<div class="section-header">
<h2 class="section-title">
<i class="fas fa-info-circle"></i>
              Informations Pratiques
            </h2>
<p class="section-description">
              WiFi, √©quipements, consignes et tout ce qui est utile au quotidien
            </p>
</div>
<h3 style="margin-bottom: 1rem; color: var(--gray-700);">
<i class="fas fa-wifi" style="color: var(--accent);"></i> WiFi
          </h3>
<div class="form-grid">
<div class="form-group">
<label>Nom du r√©seau WiFi (SSID)</label>
<input class="form-control" name="wifiSSID" placeholder="Nom du r√©seau" type="text"/>
</div>
<div class="form-group">
<label>Mot de passe WiFi</label>
<input class="form-control" name="wifiPassword" placeholder="Mot de passe" type="text"/>
</div>
</div>
<hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--gray-200);"/>
<h3 style="margin-bottom: 1rem; color: var(--gray-700);">
<i class="fas fa-clipboard-list" style="color: var(--accent);"></i> Consignes de d√©part
          </h3>
<div class="form-group">
<label>
              Heure de d√©part
              <span class="hint">Ex: 11h, 10h30</span>
</label>
<input class="form-control" name="checkoutTime" placeholder="11h" type="text"/>
</div>
<div class="form-group">
<label>
              Instructions de d√©part
              <span class="hint">Ce que les voyageurs doivent faire avant de partir</span>
</label>
<textarea class="form-control" name="checkoutInstructions" placeholder="Ex:
- √âteindre toutes les lumi√®res
- Laver la vaisselle
- Poser les serviettes au sol..." rows="5"></textarea>
</div>
<hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--gray-200);"/>
<h3 style="margin-bottom: 1rem; color: var(--gray-700);">
<i class="fas fa-toolbox" style="color: var(--accent);"></i> √âquipements disponibles
          </h3>
<div class="form-group">
<label>
              Liste des √©quipements
              <span class="hint">Un √©quipement par ligne</span>
</label>
<textarea class="form-control" name="equipmentList" placeholder="Ex:
Machine √† caf√© Nespresso
Micro-ondes
Machine √† laver
Fer et planche √† repasser..." rows="8"></textarea>
</div>
<hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--gray-200);"/>
<h3 style="margin-bottom: 1rem; color: var(--gray-700);">
<i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i> R√®gles importantes
          </h3>
<div class="form-group">
<label>
              R√®gles et avertissements
              <span class="hint">Ex: Poutre basse, logement non-fumeur, attention aux marches...</span>
</label>
<textarea class="form-control" name="importantRules" placeholder="Entrez les r√®gles importantes..." rows="4"></textarea>
</div>
<hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--gray-200);"/>
<h3 style="margin-bottom: 1rem; color: var(--gray-700);">
<i class="fas fa-train" style="color: var(--accent);"></i> Transports
          </h3>
<div class="form-group">
<label>
              Informations sur les transports
              <span class="hint">Comment acc√©der aux transports en commun, gares, etc.</span>
</label>
<textarea class="form-control" name="transportInfo" placeholder="Ex: Bus ligne 15 √† 1 minute √† pied..." rows="6"></textarea>
</div>
</div>
<div class="form-actions">
<button class="btn btn-secondary" onclick="prevSection()" type="button">
<i class="fas fa-arrow-left"></i>
            Pr√©c√©dent
          </button>
<button class="btn btn-primary" onclick="nextSection()" type="button">
            Suivant
            <i class="fas fa-arrow-right"></i>
</button>
</div>
</div>
<!-- Section 5: Aux Alentours -->
<div class="form-section" data-section="5">
<div class="form-card">
<div class="section-header">
<h2 class="section-title">
<i class="fas fa-map-marked-alt"></i>
              Aux Alentours
            </h2>
<p class="section-description">
              Recommandations de restaurants, commerces et lieux √† visiter
            </p>
</div>
<h3 style="margin-bottom: 1rem; color: var(--gray-700);">
<i class="fas fa-utensils" style="color: var(--accent);"></i> Restaurants &amp; Bars
          </h3>
<div class="repeatable-section" id="restaurantsContainer">
<!-- Les restaurants seront ajout√©s ici dynamiquement -->
</div>
<button class="add-item-btn" onclick="addRestaurant()" type="button">
<i class="fas fa-plus-circle"></i>
            Ajouter un restaurant / bar
          </button>
<hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--gray-200);"/>
<h3 style="margin-bottom: 1rem; color: var(--gray-700);">
<i class="fas fa-shopping-bag" style="color: var(--accent);"></i> Commerces
          </h3>
<div class="form-group">
<label>
              Liste des commerces
              <span class="hint">Supermarch√©s, boulangeries, pharmacies, etc. (un par ligne)</span>
</label>
<textarea class="form-control" name="shopsList" placeholder="Ex:
FRANPRIX - 6 rue de Pontoise
Boulangerie LA POTERNE - Place du march√©..." rows="6"></textarea>
</div>
<hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--gray-200);"/>
<h3 style="margin-bottom: 1rem; color: var(--gray-700);">
<i class="fas fa-map-signs" style="color: var(--accent);"></i> Lieux √† Visiter
          </h3>
<div class="repeatable-section" id="placesContainer">
<!-- Les lieux seront ajout√©s ici dynamiquement -->
</div>
<button class="add-item-btn" onclick="addPlace()" type="button">
<i class="fas fa-plus-circle"></i>
            Ajouter un lieu √† visiter
          </button>
</div>
<div class="form-actions">
<button class="btn btn-secondary" onclick="prevSection()" type="button">
<i class="fas fa-arrow-left"></i>
            Pr√©c√©dent
          </button>
<button class="btn btn-accent" type="submit">
<i class="fas fa-check-circle"></i>
            Cr√©er le livret d'accueil
          </button>
</div>
</div>
</form>
<!-- Success Message -->
<div class="success-message" id="successMessage">
<div class="success-icon">
<i class="fas fa-check"></i>
</div>
<h2>Livret d'accueil cr√©√© avec succ√®s !</h2>
<p>Votre livret d'accueil personnalis√© a √©t√© g√©n√©r√©.</p>
<!-- QR Code Section -->
<div style="background: white; padding: 2rem; border-radius: 12px; margin: 2rem auto; max-width: 400px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
<h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: #374151;">
<i class="fas fa-qrcode"></i> QR Code du livret
    </h3>
<div id="qrcode" style="display: flex; justify-content: center; margin-bottom: 1rem;"></div>
<p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 1rem;">
      Scannez ce code pour acc√©der directement au livret
    </p>
<button class="btn btn-secondary" onclick="downloadQRCode()" style="width: 100%;">
<i class="fas fa-download"></i>
      T√©l√©charger le QR Code
    </button>
</div>
<div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
<button class="btn btn-primary" onclick="viewWelcomeBook()">
<i class="fas fa-eye"></i>
          Voir le livret
        </button>
<button class="btn btn-secondary" onclick="copyWelcomeBookLink(this)">
<i class="fas fa-copy"></i>
          Copier le lien
        </button>
<button class="btn btn-secondary" onclick="modifyCurrentLivret()">
<i class="fas fa-edit"></i>
          Modifier
        </button>
</div>
</div>
</div>
<script>
const API_BASE = 'https://lcc-booking-manager.onrender.com';

window.getAuthToken = window.getAuthToken || (() => localStorage.getItem('lcc_token') || '');
let currentUniqueId = null; // Pour savoir si on modifie ou on cr√©e

// ----------------------------
// Navigation par sections (wizard)
// ----------------------------
let currentSectionIndex = 0;

function getSections() {
  return Array.from(document.querySelectorAll('.form-section'));
}

function showSection(index) {
  const sections = getSections();
  if (!sections.length) return;

  currentSectionIndex = Math.max(0, Math.min(index, sections.length - 1));
  sections.forEach((sec, i) => sec.classList.toggle('active', i === currentSectionIndex));

  // Scroll top du formulaire
  const form = document.getElementById('welcomeForm');
  if (form) form.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function nextSection() {
  showSection(currentSectionIndex + 1);
}

function prevSection() {
  showSection(currentSectionIndex - 1);
}

// ----------------------------
// Upload + preview images
// ----------------------------
function setupImageUpload(inputId, previewId, multiple = false) {
  const input = document.getElementById(inputId);
  const preview = document.getElementById(previewId);
  if (!input || !preview) return;

  input.addEventListener('change', () => {
    // Reset preview
    preview.innerHTML = '';

    const files = Array.from(input.files || []);
    if (!files.length) return;

    files.forEach(file => {
      if (!file.type || !file.type.startsWith('image/')) return;

      const reader = new FileReader();
      reader.onload = (ev) => {
        const div = document.createElement('div');
        div.className = 'image-preview-item';
        div.innerHTML = `
          <img src="${ev.target.result}" alt="preview">
        `;
        preview.appendChild(div);
      };
      reader.readAsDataURL(file);
    });
  });
}

// ----------------------------
// Collecte des donn√©es + sauvegarde
// ----------------------------
function collectFormData() {
  const formData = new FormData();

  // Champs texte simples
  const fields = [
    'propertyName','welcomeDescription','contactPhone',
    'address','postalCode','city','keyboxCode',
    'accessInstructions','parkingInfo','wifiSSID',
    'wifiPassword','checkoutTime','checkoutInstructions',
    'equipmentList','importantRules','transportInfo','shopsList'
  ];
  fields.forEach(f => formData.append(f, document.querySelector(`[name="${f}"]`)?.value || ''));

  // Pi√®ces
  const rooms = [];
  document.querySelectorAll('#roomsContainer .room-block').forEach(block => {
    const name = block.querySelector('input[name*="[name]"]')?.value || '';
    const description = block.querySelector('textarea[name*="[description]"]')?.value || '';
    rooms.push({ name, description });
  });
  formData.append('rooms', JSON.stringify(rooms));

  // Restaurants
  const restaurants = [];
  document.querySelectorAll('#restaurantsContainer .restaurant-block').forEach(block => {
    const name = block.querySelector('input[name*="[name]"]')?.value || '';
    const phone = block.querySelector('input[name*="[phone]"]')?.value || '';
    const address = block.querySelector('input[name*="[address]"]')?.value || '';
    const description = block.querySelector('textarea[name*="[description]"]')?.value || '';
    restaurants.push({ name, phone, address, description });
  });
  formData.append('restaurants', JSON.stringify(restaurants));

  // Lieux
  const places = [];
  document.querySelectorAll('#placesContainer .place-block').forEach(block => {
    const name = block.querySelector('input[name*="[name]"]')?.value || '';
    const description = block.querySelector('textarea[name*="[description]"]')?.value || '';
    places.push({ name, description });
  });
  formData.append('places', JSON.stringify(places));

  // Fichiers
  const cover = document.getElementById('coverPhoto')?.files?.[0];
  if (cover) formData.append('coverPhoto', cover);

  const entrance = document.getElementById('entrancePhotos')?.files || [];
  for (const f of entrance) formData.append('entrancePhotos', f);

  const parking = document.getElementById('parkingPhotos')?.files || [];
  for (const f of parking) formData.append('parkingPhotos', f);

  // uniqueId si √©dition
  if (currentUniqueId) formData.append('uniqueId', currentUniqueId);

  return formData;
}

async function saveWelcomeBook(e) {
  if (e) e.preventDefault();

  try {
    const formData = collectFormData();

    const response = await fetch(`${API_BASE}/api/welcome-books/create`, {
      method: 'POST',
      body: formData
    });

    const raw = await response.text();
    let data = null;
    try { data = raw ? JSON.parse(raw) : null; } catch (_) { data = null; }

    if (!response.ok || !data || !data.success) {
      alert((data && (data.error || data.message)) ? (data.error || data.message) : `Erreur sauvegarde (${response.status})`);
      return;
    }

    // Si le backend renvoie un uniqueId, on le garde
    if (data.uniqueId) currentUniqueId = data.uniqueId;

    // Affichage succ√®s
    hideFormShowSuccess();
    document.getElementById('successMessage').style.display = 'block';

    // Recharge la liste pour voir le livret
    await loadLivretsList();
  } catch (err) {
    console.error("Erreur sauvegarde:", err);
    alert("Erreur lors de la sauvegarde.");
  }
}

function createAnother() {
  currentUniqueId = null;
  const form = document.getElementById('welcomeForm');
  if (form) form.reset();

  // Reset previews + containers
  const previews = ['coverPhotoPreview','entrancePhotosPreview','parkingPhotosPreview'];
  previews.forEach(id => { const el = document.getElementById(id); if (el) el.innerHTML = ''; });

  const rooms = document.getElementById('roomsContainer'); if (rooms) rooms.innerHTML = '';
  const rests = document.getElementById('restaurantsContainer'); if (rests) rests.innerHTML = '';
  const places = document.getElementById('placesContainer'); if (places) places.innerHTML = '';

  roomCounter = 0; restaurantCounter = 0; placeCounter = 0;
  addRoom(); addRestaurant(); addPlace();

  document.getElementById('successMessage').style.display = 'none';
  setDisplayById('welcomeForm','block');
  showSection(0);
}

// Init
document.addEventListener('DOMContentLoaded', () => {
  setupImageUpload('coverPhoto', 'coverPhotoPreview', false);
  setupImageUpload('entrancePhotos', 'entrancePhotosPreview', true);
  setupImageUpload('parkingPhotos', 'parkingPhotosPreview', true);

  const form = document.getElementById('welcomeForm');
  if (form) form.addEventListener('submit', saveWelcomeBook);

  // Sections default
  showSection(0);

  // Pr√©pare les blocs par d√©faut
  try { addRoom(); addRestaurant(); addPlace(); } catch (_) {}
});

// Charger la liste des livrets au d√©marrage
async function loadLivretsList() {
  try {
    const response = await fetch(`${API_BASE}/api/welcome-books/user/list`, {
      headers: { 'Authorization': `Bearer ${localStorage.getItem('lcc_token')}` }
    });
    
    const data = await response.json();
    
    if (data.success && data.welcomeBooks && data.welcomeBooks.length > 0) {
      displayLivretsList(data.welcomeBooks);
    } else {
      document.getElementById('livretsList').innerHTML = '<p style="color: #64748b; text-align: center;">Aucun livret pour le moment.</p>';
    }
  } catch (error) {
    console.error('Erreur chargement livrets:', error);
    document.getElementById('livretsList').innerHTML = '<p style="color: #e53e3e;">Erreur lors du chargement des livrets.</p>';
  }
}

// Afficher la liste des livrets
function displayLivretsList(livrets) {
  const html = livrets.map(livret => `
    <div style="border: 1px solid #e2e8f0; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; background: white;">
      <div>
        <strong style="font-size: 16px; color: #1a202c;">${livret.propertyName || 'Sans nom'}</strong>
        <br>
        <small style="color: #64748b;">Modifi√© le ${new Date(livret.updatedAt).toLocaleDateString('fr-FR')}</small>
      </div>
      <div style="display: flex; gap: 0.5rem;">
        <button class="btn btn-secondary" onclick="editLivret('${livret.uniqueId}')" style="font-size: 14px; padding: 0.5rem 1rem;">
          <i class="fas fa-edit"></i> Modifier
        </button>
        <button class="btn btn-secondary" onclick="viewLivret('${livret.uniqueId}')" style="font-size: 14px; padding: 0.5rem 1rem;">
          <i class="fas fa-eye"></i> Voir
        </button>
        <button class="btn btn-secondary" onclick="deleteLivret('${livret.uniqueId}')" style="font-size: 14px; padding: 0.5rem 1rem; background: #e53e3e; color: white;">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
  `).join('');
  
  document.getElementById('livretsList').innerHTML = html;
}

// Cr√©er un nouveau livret
function createNewLivret() {
  currentUniqueId = null;
  document.getElementById('welcomeForm').reset();
  document.getElementById('livretsListSection').style.display = 'none';
  document.getElementById('welcomeForm').style.display = 'block';
  
  // Remonter en haut de la page
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Voir un livret
function viewLivret(uniqueId) {
  window.open(`${API_BASE}/welcome/${uniqueId}`, '_blank');
}

// Supprimer un livret
// Modifier un livret (chargement + remplissage du formulaire)
async function editLivret(uniqueId) {
  try {
    currentUniqueId = uniqueId;

    const response = await fetch(`${API_BASE}/api/welcome-books/public/${uniqueId}`);
    const data = await response.json();

    if (data && data.success && data.book) {
      fillFormWithData(data.book);
      document.getElementById('livretsListSection').style.display = 'none';
      setDisplayById('welcomeForm','block');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
      alert((data && data.error) ? data.error : "Impossible de charger ce livret.");
    }
  } catch (err) {
    console.error("Erreur editLivret:", err);
    alert("Erreur lors du chargement du livret.");
  }
}
async function copyWelcomeBookLink(buttonEl) {
    try {
      const url =
        window.welcomeBookUrl ||
        (typeof currentUniqueId !== "undefined" && currentUniqueId
          ? `${API_BASE}/welcome/${currentUniqueId}`
          : "");

      if (!url) {
        alert("Lien indisponible (uniqueId manquant)");
        return;
      }

      await navigator.clipboard.writeText(url);

      if (buttonEl) {
        const old = buttonEl.innerHTML;
        buttonEl.innerHTML = '<i class="fas fa-check"></i> Lien copi√©';
        setTimeout(() => (buttonEl.innerHTML = old), 1500);
      } else {
        alert("Lien copi√© ‚úÖ");
      }
    } catch (e) {
      const url =
        window.welcomeBookUrl ||
        (currentUniqueId ? `${API_BASE}/welcome/${currentUniqueId}` : "");
      prompt("Copie le lien :", url);
    }
  }
  async function modifyCurrentLivret() {
  if (!currentUniqueId) {
    alert("Impossible de modifier : identifiant manquant.");
    return;
  }
  await editLivret(currentUniqueId);
}
async function deleteLivret(uniqueId) {
  if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce livret ?')) return;
  
  try {
    const response = await fetch(`${API_BASE}/api/welcome-books/by-unique/${uniqueId}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${localStorage.getItem('lcc_token')}` }
    });
    
    const raw = await response.text();
      let data = null;
      try { data = raw ? JSON.parse(raw) : null; } catch (e) { data = null; }

      if (data && data.success) {
      alert('Livret supprim√© avec succ√®s');
      loadLivretsList();
    } else {
      alert('Erreur lors de la suppression');
    }
  } catch (error) {
    console.error('Erreur suppression:', error);
    alert('Erreur lors de la suppression');
  }
}
function downloadQRCode(uniqueId) {
  try {
    // 0) Si on a un uniqueId, on peut toujours reconstruire l'URL
    const url = uniqueId ? `${API_BASE}/welcome/${uniqueId}` : (window.welcomeBookUrl || null);

    // 1) Cas 1: un <img> d√©di√© (si tu l'utilises dans une liste)
    const img =
      (uniqueId && document.getElementById(`qrCodeImg-${uniqueId}`)) ||
      (uniqueId && document.querySelector(`[data-qr="${uniqueId}"]`)) ||
      document.querySelector('#qrcode img');

    if (img && img.src) {
      const a = document.createElement('a');
      a.href = img.src;
      a.download = `qr-${uniqueId || 'welcome-book'}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      return;
    }

    // 2) Cas 2: QRCodeJS rend souvent un <canvas>
    const canvas = document.querySelector('#qrcode canvas');
    if (canvas && canvas.toDataURL) {
      const a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download = `qr-${uniqueId || 'welcome-book'}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      return;
    }

    // 3) Fallback: si on a l'URL mais pas de rendu, on g√©n√®re un QR temporaire puis on t√©l√©charge
    if (url && window.QRCode) {
      const tmp = document.createElement('div');
      tmp.style.position = 'fixed';
      tmp.style.left = '-9999px';
      tmp.style.top = '-9999px';
      document.body.appendChild(tmp);

      new QRCode(tmp, { text: url, width: 256, height: 256 });

      // QRCodeJS peut mettre un img ou un canvas
      const tmpImg = tmp.querySelector('img');
      const tmpCanvas = tmp.querySelector('canvas');

      const dataUrl = tmpImg?.src || (tmpCanvas?.toDataURL ? tmpCanvas.toDataURL('image/png') : null);
      document.body.removeChild(tmp);

      if (dataUrl) {
        const a = document.createElement('a');
        a.href = dataUrl;
        a.download = `qr-${uniqueId || 'welcome-book'}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        return;
      }
    }

    alert("QR Code introuvable");
  } catch (e) {
    console.error("downloadQRCode error:", e);
    alert("Impossible de t√©l√©charger le QR Code.");
  }
}
// Remplir le formulaire avec les donn√©es d'un livret
// Affiche une image d√©j√† existante (URL) dans un container de preview
function showExistingImage(containerId, url) {
  const container = document.getElementById(containerId);
  if (!container || !url) return;

  const wrapper = document.createElement('div');
  wrapper.className = 'preview-thumb';

  const img = document.createElement('img');
  img.src = url;
  img.alt = 'Photo existante';
  img.loading = 'lazy';

  wrapper.appendChild(img);
  container.appendChild(wrapper);
}

// Compteurs pour les sections r√©p√©tables
let roomCounter = 0;
let restaurantCounter = 0;
let placeCounter = 0;

function addRoom() {
  const container = document.getElementById('roomsContainer');
  if (!container) return;
  roomCounter += 1;

  const block = document.createElement('div');
  block.className = 'repeat-block room-block';

  block.innerHTML = `
    <div class="field">
      <label>Nom de la pi√®ce</label>
      <input type="text" name="room[${roomCounter}][name]" placeholder="Ex: Chambre 1">
    </div>
    <div class="field">
      <label>Description</label>
      <textarea name="room[${roomCounter}][description]" rows="3" placeholder="Lit, rangement, etc."></textarea>
    </div>
    <hr/>
  `;
  container.appendChild(block);
}

function addRestaurant() {
  const container = document.getElementById('restaurantsContainer');
  if (!container) return;
  restaurantCounter += 1;

  const block = document.createElement('div');
  block.className = 'repeat-block restaurant-block';

  block.innerHTML = `
    <div class="field">
      <label>Nom</label>
      <input type="text" name="restaurant[${restaurantCounter}][name]" placeholder="Nom du restaurant">
    </div>
    <div class="field">
      <label>T√©l√©phone</label>
      <input type="text" name="restaurant[${restaurantCounter}][phone]" placeholder="01 23 45 67 89">
    </div>
    <div class="field">
      <label>Adresse</label>
      <input type="text" name="restaurant[${restaurantCounter}][address]" placeholder="Adresse">
    </div>
    <div class="field">
      <label>Description</label>
      <textarea name="restaurant[${restaurantCounter}][description]" rows="3" placeholder="Pourquoi tu le recommandes"></textarea>
    </div>
    <hr/>
  `;
  container.appendChild(block);
}

function addPlace() {
  const container = document.getElementById('placesContainer');
  if (!container) return;
  placeCounter += 1;

  const block = document.createElement('div');
  block.className = 'repeat-block place-block';

  block.innerHTML = `
    <div class="field">
      <label>Nom</label>
      <input type="text" name="place[${placeCounter}][name]" placeholder="Lieu √† visiter">
    </div>
    <div class="field">
      <label>Description</label>
      <textarea name="place[${placeCounter}][description]" rows="3" placeholder="Infos utiles"></textarea>
    </div>
    <hr/>
  `;
  container.appendChild(block);
}

function fillFormWithData(data) {
  if (!data) return;

  // Champs simples
  const fields = [
    'propertyName', 'welcomeDescription', 'contactPhone',
    'address', 'postalCode', 'city', 'keyboxCode',
    'accessInstructions', 'parkingInfo', 'wifiSSID',
    'wifiPassword', 'checkoutTime', 'checkoutInstructions',
    'equipmentList', 'importantRules', 'transportInfo', 'shopsList'
  ];

  fields.forEach(f => {
    const el = document.querySelector(`[name="${f}"]`);
    if (!el) return;
    // On accepte 0 / false / "" : on teste uniquement undefined/null
    if (data[f] !== undefined && data[f] !== null) el.value = data[f];
  });

  // Photos existantes (si pr√©sentes en URL)
  if (data.photos) {
    if (data.photos.cover) showExistingImage('coverPhotoPreview', data.photos.cover);
    if (Array.isArray(data.photos.entrance)) data.photos.entrance.forEach(u => showExistingImage('entrancePhotosPreview', u));
    if (Array.isArray(data.photos.parking)) data.photos.parking.forEach(u => showExistingImage('parkingPhotosPreview', u));
  }

  // Pi√®ces
  document.getElementById('roomsContainer').innerHTML = '';
  roomCounter = 0;
  if (Array.isArray(data.rooms) && data.rooms.length) {
    data.rooms.forEach(r => {
      addRoom();
      document.querySelector(`[name="room[${roomCounter}][name]"]`).value = r.name || '';
      document.querySelector(`[name="room[${roomCounter}][description]"]`).value = r.description || '';
    });
  } else {
    addRoom();
  }

  // Restaurants
  document.getElementById('restaurantsContainer').innerHTML = '';
  restaurantCounter = 0;
  if (Array.isArray(data.restaurants) && data.restaurants.length) {
    data.restaurants.forEach(r => {
      addRestaurant();
      document.querySelector(`[name="restaurant[${restaurantCounter}][name]"]`).value = r.name || '';
      document.querySelector(`[name="restaurant[${restaurantCounter}][phone]"]`).value = r.phone || '';
      document.querySelector(`[name="restaurant[${restaurantCounter}][address]"]`).value = r.address || '';
      document.querySelector(`[name="restaurant[${restaurantCounter}][description]"]`).value = r.description || '';
    });
  } else {
    addRestaurant();
  }

  // Lieux
  document.getElementById('placesContainer').innerHTML = '';
  placeCounter = 0;
  if (Array.isArray(data.places) && data.places.length) {
    data.places.forEach(p => {
      addPlace();
      document.querySelector(`[name="place[${placeCounter}][name]"]`).value = p.name || '';
      document.querySelector(`[name="place[${placeCounter}][description]"]`).value = p.description || '';
    });
  } else {
    addPlace();
  }

  // URL public / QR (on se base sur currentUniqueId si on √©dite)
  const uid = currentUniqueId || data.uniqueId;
  if (uid) window.welcomeBookUrl = `${API_BASE}/welcome/${uid}`;
}

// Appeler loadLivretsList() au chargement de la page() au chargement de la page
document.addEventListener('DOMContentLoaded', loadLivretsList);
// ----------------------------
// Helpers d'affichage (liste/form/succ√®s)
// ----------------------------
function setDisplayById(id, display) {
  const el = document.getElementById(id);
  if (el) el.style.display = display;
}

function hideFormShowSuccess() {
  setDisplayById('welcomeForm', 'none');
  setDisplayById('successMessage', 'block');
}

function showFormHideLists() {
  setDisplayById('livretsListSection', 'none');
  setDisplayById('successMessage', 'none');
  setDisplayById('welcomeForm', 'block');
  try { showSection(0); } catch (_) {}
}

function createNewLivret() {
  currentUniqueId = null;
  const form = document.getElementById('welcomeForm');
  if (form) form.reset();
  showFormHideLists();
}

</script>
</main>
</div>
<script src="/js/bh-layout.js"></script>
<script src="/js/mobile-native-experience.js"></script>
<script src="/js/mobile-tabs-handler.js"></script>
<script src="/js/messages-badge-loader.js"></script>   
</body>
</html>
