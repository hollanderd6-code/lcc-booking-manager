<!DOCTYPE html>
<html lang="fr" data-theme="light" data-theme-v3="1">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>Livret d'accueil – Boostinghost</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>
<script src="/js/auth-fetch.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link href="/css/style.css" rel="stylesheet"/>
<link href="/css/bh-shared.css?v=1" rel="stylesheet"/>
<link href="/css/bh-theme-v3.css" rel="stylesheet"/>
<link href="/css/bottom-bar-enhanced.css" rel="stylesheet"/>
<link href="/css/messages-badge-fix.css" rel="stylesheet"/>
<link rel="stylesheet" href="/css/messages-badge-red.css">
<link rel="stylesheet" href="/css/mobile-native-styles.css">
<style>
/* ============================================================
   DARK BAR + STICKY HEADER (identical to app.html)
   ============================================================ */
html[data-theme-v3="1"] body { padding-top: 40px !important; }
html[data-theme-v3="1"] .sidebar {
  position: fixed !important; top: 40px !important;
  left: 0 !important; bottom: 0 !important;
  height: auto !important;
  z-index: 30 !important;
}
html[data-theme-v3="1"] header.main-header {
  position: sticky !important;
  top: 0 !important;
  z-index: 50 !important;
  margin-top: 0 !important;
}
html[data-theme-v3="1"] main.main-content {
  padding-top: 0 !important;
  margin-top: 0 !important;
  position: relative !important;
  z-index: 35 !important;
}
html[data-theme-v3="1"] .app-container {
  margin-top: 0 !important;
  padding-top: 0 !important;
}
/* Tuer tout espace parasite entre barre dark et header */
html[data-theme-v3="1"] main.main-content > header.main-header {
  margin-top: 0 !important;
  padding-top: 0 !important;
}

/* ── BARRE DARK EN HAUT ── */
html[data-theme-v3="1"] .bh-demo-nav {
  position: fixed;
  top: 0; left: 0; right: 0;
  z-index: 9999;
  background: #0D1117;
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 0 16px;
  height: 40px;
  font-family: 'DM Sans', sans-serif;
  font-size: 12px;
  /* Pour le centrage absolu des badges */
  position: fixed;
}
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-label {
  color: rgba(255,255,255,.4);
  font-weight: 500;
  margin-right: 6px;
  letter-spacing: .08em;
  text-transform: uppercase;
  font-size: 11px;
  white-space: nowrap;
}
html[data-theme-v3="1"] .bh-demo-nav a.bh-demo-btn,
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-btn {
  padding: 4px 13px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.15);
  background: transparent;
  color: rgba(255,255,255,.6);
  cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  font-size: 11.5px;
  font-weight: 500;
  transition: all .2s;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  text-decoration: none;
  white-space: nowrap;
}
html[data-theme-v3="1"] .bh-demo-nav a.bh-demo-btn:hover,
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-btn:hover {
  background: rgba(255,255,255,.1);
  color: white;
}
html[data-theme-v3="1"] .bh-demo-nav a.bh-demo-btn.active,
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-btn.active {
  background: #1A7A5E;
  color: white;
  border-color: #1A7A5E;
}
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-right {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}
html[data-theme-v3="1"] .bh-demo-nav .bh-demo-mode-label {
  color: rgba(255,255,255,.4);
  font-size: 10.5px;
  font-weight: 500;
  letter-spacing: .07em;
  text-transform: uppercase;
}
html[data-theme-v3="1"] .bh-theme-toggle {
  width: 44px;
  height: 24px;
  background: rgba(255,255,255,.15);
  border-radius: 999px;
  border: none;
  cursor: pointer;
  position: relative;
  transition: background .2s;
  flex-shrink: 0;
}
html[data-theme-v3="1"] .bh-theme-toggle::after {
  content: '';
  position: absolute;
  top: 3px; left: 3px;
  width: 18px; height: 18px;
  background: white;
  border-radius: 50%;
  transition: transform .2s;
}
html[data-theme-v3="1"][data-theme="dark"] .bh-theme-toggle { background: #1A7A5E; }
html[data-theme-v3="1"][data-theme="dark"] .bh-theme-toggle::after { transform: translateX(20px); }


/* ============================================================
   PAGE WELCOME — V3
   ============================================================ */
html[data-theme-v3="1"],
html[data-theme-v3="1"] body {
  overflow: hidden !important;
  height: 100% !important;
}
html[data-theme-v3="1"] .app-container {
  height: calc(100vh - 40px) !important;
  overflow: hidden !important;
}
html[data-theme-v3="1"] .main-content {
  background: #F5F2EC !important;
  overflow-y: auto !important;
  height: 100% !important;
}
html[data-theme-v3="1"] .sidebar { z-index: 30 !important; }
html[data-theme-v3="1"] main.main-content {
  padding-top: 0 !important;
  margin-top: 0 !important;
  position: relative !important;
  z-index: 35 !important;
}
html[data-theme-v3="1"] .header-actions .btn-ghost,
html[data-theme-v3="1"] .header-actions .btn.btn-ghost { display: none !important; }

/* Back button */
.welcome-back-btn {
  display: inline-flex; align-items: center; gap: 8px;
  height: 40px; padding: 0 20px; border: none; border-radius: 12px;
  background: #1A7A5E; color: white; font-family: 'DM Sans', sans-serif;
  font-size: 14px; font-weight: 600; cursor: pointer; transition: background .15s;
  white-space: nowrap; position: fixed; top: calc(40px + 13px); right: 24px; z-index: 200;
}
.welcome-back-btn:hover { background: #15624B; }

/* Page container */
.welcome-container {
  max-width: 860px;
  margin: 0 auto;
  padding: 28px 24px 60px;
}

/* ── Section header ── */
.welcome-section-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 28px;
}
.welcome-kicker {
  font-size: 11px; font-weight: 600; letter-spacing: .1em;
  text-transform: uppercase; color: rgba(13,17,23,.38); margin-bottom: 4px;
}
.welcome-title {
  font-family: 'Instrument Serif', serif;
  font-size: 28px; font-weight: 400; color: #0D1117; margin: 0;
}
.welcome-title em { font-style: italic; color: #1A7A5E; }

/* ── Livrets list ── */
.livrets-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}
.livret-card {
  background: #F5F0E8;
  border: 1px solid rgba(200,184,154,.4);
  border-radius: 16px;
  padding: 20px;
  display: flex; flex-direction: column; gap: 12px;
  transition: all .2s;
}
.livret-card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(13,17,23,.1); }
.livret-card-icon {
  width: 44px; height: 44px; border-radius: 12px;
  background: rgba(26,122,94,.1); display: flex; align-items: center;
  justify-content: center; font-size: 20px; color: #1A7A5E;
}
.livret-card-name {
  font-size: 15px; font-weight: 700; color: #0D1117;
  font-family: 'DM Sans', sans-serif; flex: 1;
}
.livret-card-date { font-size: 12px; color: #7A8695; }
.livret-card-actions {
  display: flex; gap: 8px;
  padding-top: 12px;
  border-top: 1px solid rgba(13,17,23,.08);
}
.livret-card-actions .btn-lv {
  flex: 1; height: 34px; border-radius: 9px; font-size: 12.5px;
  font-weight: 600; cursor: pointer; transition: all .15s; border: none;
  display: flex; align-items: center; justify-content: center; gap: 5px;
  font-family: 'DM Sans', sans-serif;
}
.btn-lv-edit { background: white; color: #0D1117; border: 1px solid rgba(0,0,0,.12) !important; }
.btn-lv-edit:hover { background: #f0ede7; }
.btn-lv-view { background: #1A7A5E; color: white; }
.btn-lv-view:hover { background: #15624B; }
.btn-lv-delete {
  flex: 0 0 34px !important; width: 34px;
  background: #FEF2F2; color: #DC2626;
  border: 1px solid rgba(220,38,38,.15) !important;
}
.btn-lv-delete:hover { background: #FEE2E2; }

/* Dashed add card */
.livret-card-add {
  background: transparent;
  border: 2px dashed rgba(26,122,94,.3);
  border-radius: 16px; padding: 28px;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 10px;
  cursor: pointer; transition: all .2s; text-align: center;
  min-height: 140px;
}
.livret-card-add:hover { border-color: #1A7A5E; background: rgba(26,122,94,.04); }
.livret-card-add-icon {
  width: 44px; height: 44px; border-radius: 12px;
  background: rgba(26,122,94,.1); display: flex; align-items: center;
  justify-content: center; font-size: 20px; color: #1A7A5E;
}
.livret-card-add-label { font-size: 14px; font-weight: 700; color: #0D1117; }
.livret-card-add-sub { font-size: 12px; color: #7A8695; }

/* ── Wizard stepper ── */
.wizard-stepper {
  display: flex; align-items: center;
  background: white; border-radius: 16px;
  border: 1px solid rgba(200,184,154,.4);
  padding: 16px 20px; margin-bottom: 24px;
  gap: 4px; overflow-x: auto;
}
.wizard-step {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 14px; border-radius: 10px; cursor: pointer;
  transition: all .15s; white-space: nowrap; flex: 1;
  justify-content: center;
}
.wizard-step-num {
  width: 26px; height: 26px; border-radius: 50%;
  background: rgba(13,17,23,.08); color: #7A8695;
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 700; flex-shrink: 0;
}
.wizard-step-label { font-size: 12.5px; font-weight: 600; color: #7A8695; }
.wizard-step.active { background: rgba(26,122,94,.08); }
.wizard-step.active .wizard-step-num { background: #1A7A5E; color: white; }
.wizard-step.active .wizard-step-label { color: #1A7A5E; }
.wizard-step.done .wizard-step-num { background: rgba(26,122,94,.15); color: #1A7A5E; }
.wizard-step.done .wizard-step-label { color: #0D1117; }
.wizard-sep { width: 24px; height: 2px; background: rgba(13,17,23,.08); flex-shrink: 0; }

/* ── Form card ── */
.wiz-card {
  background: white; border: 1px solid rgba(200,184,154,.35);
  border-radius: 16px; overflow: hidden; margin-bottom: 16px;
}
.wiz-card-header {
  padding: 20px 24px; border-bottom: 1px solid rgba(13,17,23,.06);
  background: #FAFAF8; display: flex; align-items: center; gap: 12px;
}
.wiz-card-icon {
  width: 40px; height: 40px; border-radius: 10px;
  background: rgba(26,122,94,.1); display: flex; align-items: center;
  justify-content: center; color: #1A7A5E; font-size: 16px; flex-shrink: 0;
}
.wiz-card-title { font-size: 16px; font-weight: 700; color: #0D1117; margin: 0; }
.wiz-card-sub { font-size: 13px; color: #7A8695; margin: 2px 0 0; }
.wiz-card-body { padding: 24px; }

/* ── Form elements ── */
.wiz-group { margin-bottom: 20px; }
.wiz-group:last-child { margin-bottom: 0; }
.wiz-label {
  display: block; font-size: 13px; font-weight: 600;
  color: #374151; margin-bottom: 6px;
}
.wiz-hint { font-size: 12px; color: #9CA3AF; font-weight: 400; display: block; margin-top: 2px; }
.wiz-required { color: #EF4444; }
.wiz-input, .wiz-textarea, .wiz-select {
  width: 100%; padding: 10px 14px;
  background: #FAFAF8; border: 1.5px solid rgba(13,17,23,.12);
  border-radius: 10px; font-size: 14px; font-family: 'DM Sans', sans-serif;
  color: #0D1117; transition: border-color .15s;
  outline: none;
}
.wiz-input:focus, .wiz-textarea:focus, .wiz-select:focus {
  border-color: #1A7A5E; background: white;
  box-shadow: 0 0 0 3px rgba(26,122,94,.08);
}
.wiz-textarea { resize: vertical; min-height: 90px; }
.wiz-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
@media(max-width:640px){ .wiz-grid-2 { grid-template-columns: 1fr; } }

/* Sub-sections inside card */
.wiz-subsection { margin-bottom: 24px; }
.wiz-subsection:last-child { margin-bottom: 0; }
.wiz-subsection-title {
  font-size: 13px; font-weight: 700; text-transform: uppercase;
  letter-spacing: .06em; color: #7A8695; margin-bottom: 14px;
  display: flex; align-items: center; gap: 8px;
}
.wiz-subsection-title i { color: #1A7A5E; }
.wiz-divider { border: none; border-top: 1px solid rgba(13,17,23,.07); margin: 24px 0; }

/* Image upload */
.wiz-upload {
  border: 2px dashed rgba(13,17,23,.12); border-radius: 12px;
  padding: 24px; text-align: center; cursor: pointer;
  background: #FAFAF8; transition: all .15s;
}
.wiz-upload:hover { border-color: #1A7A5E; background: rgba(26,122,94,.03); }
.wiz-upload i { font-size: 28px; color: #9CA3AF; margin-bottom: 8px; display: block; }
.wiz-upload p { font-size: 13px; color: #9CA3AF; margin: 4px 0; }
.wiz-upload-hint { font-size: 11px; color: #C4C4C4; }
.image-preview { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
.image-preview-item img, .preview-thumb img {
  width: 72px; height: 72px; object-fit: cover;
  border-radius: 8px; border: 1px solid rgba(0,0,0,.08);
}

/* Repeat blocks */
.wiz-repeat-block {
  background: #FAFAF8; border: 1px solid rgba(13,17,23,.08);
  border-radius: 12px; padding: 16px; margin-bottom: 12px; position: relative;
}
.wiz-repeat-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 14px;
}
.wiz-repeat-title { font-size: 13px; font-weight: 700; color: #374151; }
.wiz-remove-btn {
  width: 28px; height: 28px; border-radius: 8px; border: none;
  background: #FEF2F2; color: #DC2626; cursor: pointer; font-size: 12px;
  display: flex; align-items: center; justify-content: center;
}
.wiz-remove-btn:hover { background: #FEE2E2; }
.wiz-add-btn {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 10px 16px; border-radius: 10px;
  background: rgba(26,122,94,.08); color: #1A7A5E;
  border: 1px dashed rgba(26,122,94,.3); cursor: pointer;
  font-size: 13px; font-weight: 600; font-family: 'DM Sans', sans-serif;
  transition: all .15s; width: 100%; justify-content: center; margin-top: 4px;
}
.wiz-add-btn:hover { background: rgba(26,122,94,.14); border-color: #1A7A5E; }

/* Wizard nav buttons */
.wiz-nav {
  display: flex; align-items: center; justify-content: space-between;
  padding: 20px 0 8px;
}
.wiz-btn-back {
  display: inline-flex; align-items: center; gap: 8px; height: 42px;
  padding: 0 20px; border: 1.5px solid rgba(13,17,23,.15); border-radius: 12px;
  background: white; color: #374151; font-family: 'DM Sans', sans-serif;
  font-size: 14px; font-weight: 600; cursor: pointer; transition: all .15s;
}
.wiz-btn-back:hover { border-color: rgba(13,17,23,.3); }
.wiz-btn-next {
  display: inline-flex; align-items: center; gap: 8px; height: 42px;
  padding: 0 24px; border: none; border-radius: 12px;
  background: #1A7A5E; color: white; font-family: 'DM Sans', sans-serif;
  font-size: 14px; font-weight: 600; cursor: pointer; transition: background .15s;
}
.wiz-btn-next:hover { background: #15624B; }
.wiz-btn-submit {
  display: inline-flex; align-items: center; gap: 8px; height: 42px;
  padding: 0 24px; border: none; border-radius: 12px;
  background: #0D1117; color: white; font-family: 'DM Sans', sans-serif;
  font-size: 14px; font-weight: 600; cursor: pointer; transition: background .15s;
}
.wiz-btn-submit:hover { background: #1C2333; }

/* Success message */
.wiz-success {
  text-align: center; padding: 48px 24px;
  background: white; border-radius: 16px;
  border: 1px solid rgba(200,184,154,.35);
}
.wiz-success-icon {
  width: 72px; height: 72px; border-radius: 50%;
  background: rgba(26,122,94,.1); color: #1A7A5E;
  display: flex; align-items: center; justify-content: center;
  font-size: 28px; margin: 0 auto 20px;
}
.wiz-success h2 { font-family: 'Instrument Serif', serif; font-size: 26px; font-weight: 400; margin-bottom: 8px; }
.wiz-success p { color: #7A8695; font-size: 14px; margin-bottom: 24px; }
.wiz-success-actions { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-top: 24px; }
.wiz-qr-box {
  background: #FAFAF8; border: 1px solid rgba(13,17,23,.08);
  border-radius: 14px; padding: 24px; max-width: 340px; margin: 24px auto 0;
}
.wiz-qr-box h3 { font-size: 15px; font-weight: 600; margin-bottom: 16px; color: #0D1117; }

/* Info/warning boxes */
.wiz-info-box {
  background: rgba(26,122,94,.06); border: 1px solid rgba(26,122,94,.2);
  border-radius: 10px; padding: 12px 16px; font-size: 13px;
  color: #1A7A5E; margin-bottom: 20px; display: flex; gap: 10px; align-items: flex-start;
}
.wiz-warn-box {
  background: rgba(245,158,11,.06); border: 1px solid rgba(245,158,11,.2);
  border-radius: 10px; padding: 12px 16px; font-size: 13px;
  color: #92400E; margin-bottom: 20px; display: flex; gap: 10px; align-items: flex-start;
}

/* Hidden form section */
.form-section { display: none; }
.form-section.active { display: block; }
</style>
</head>
<body data-back-href="/app.html" data-kicker="Gestion" data-page="welcome" data-title="Livret d'accueil">

<!-- Dark bar -->
<div class="bh-demo-nav" id="bhTopBar">
  <!-- Connexions centrées -->
  <div style="position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:16px;">

    <!-- Airbnb -->
    <div style="display:flex;align-items:center;gap:7px;">
      <i class="fa-brands fa-airbnb" style="font-size:15px;color:#FF5A5F;"></i>
      <span style="color:rgba(255,255,255,.7);font-size:12px;font-weight:500;">Airbnb</span>
      <span id="topbar-status-airbnb" style="font-size:11px;font-weight:600;padding:2px 9px;border-radius:999px;background:rgba(239,68,68,.2);color:#F87171;border:1px solid rgba(239,68,68,.35);">
        <i class="fas fa-circle" style="font-size:7px;margin-right:3px;vertical-align:middle;"></i>Non connecté
      </span>
    </div>

    <div style="width:1px;height:16px;background:rgba(255,255,255,.1);"></div>

    <!-- Booking.com -->
    <div style="display:flex;align-items:center;gap:7px;">
      <span style="font-size:13px;font-weight:800;color:#003580;">B.</span>
      <span style="color:rgba(255,255,255,.7);font-size:12px;font-weight:500;">Booking.com</span>
      <span id="topbar-status-booking" style="font-size:11px;font-weight:600;padding:2px 9px;border-radius:999px;background:rgba(239,68,68,.2);color:#F87171;border:1px solid rgba(239,68,68,.35);">
        <i class="fas fa-circle" style="font-size:7px;margin-right:3px;vertical-align:middle;"></i>Non connecté
      </span>
    </div>

    <div style="width:1px;height:16px;background:rgba(255,255,255,.1);"></div>

    <!-- Stripe -->
    <div style="display:flex;align-items:center;gap:7px;">
      <i class="fa-brands fa-stripe-s" style="font-size:17px;color:#6772E5;"></i>
      <span style="color:rgba(255,255,255,.7);font-size:12px;font-weight:500;">Stripe</span>
      <span id="topbar-status-stripe" style="font-size:11px;font-weight:600;padding:2px 9px;border-radius:999px;background:rgba(239,68,68,.2);color:#F87171;border:1px solid rgba(239,68,68,.35);">
        <i class="fas fa-circle" style="font-size:7px;margin-right:3px;vertical-align:middle;"></i>Non connecté
      </span>
    </div>

  </div>

  <!-- Toggle dark mode (droite) -->
  <div class="bh-demo-right">
    <span class="bh-demo-mode-label">Mode</span>
    <button class="bh-theme-toggle" id="bhThemeToggleDark" onclick="document.documentElement.getAttribute('data-theme')==='dark'?document.documentElement.setAttribute('data-theme','light'):document.documentElement.setAttribute('data-theme','dark')"></button>
  </div>
</div>

<script>
// Mise à jour des statuts de connexion dans la top bar
(function updateTopBarStatus() {
  function setStatus(id, connected) {
    const el = document.getElementById(id);
    if (!el) return;
    if (connected) {
      el.style.background = 'rgba(34,197,94,.2)';
      el.style.color = '#4ADE80';
      el.style.borderColor = 'rgba(34,197,94,.35)';
      el.innerHTML = '<i class="fas fa-circle" style="font-size:7px;margin-right:3px;vertical-align:middle;"></i>Connecté';
    } else {
      el.style.background = 'rgba(239,68,68,.2)';
      el.style.color = '#F87171';
      el.style.borderColor = 'rgba(239,68,68,.35)';
      el.innerHTML = '<i class="fas fa-circle" style="font-size:7px;margin-right:3px;vertical-align:middle;"></i>Non connecté';
    }
  }

  function checkStatuses() {
    try {
      const reservations = JSON.parse(localStorage.getItem('LCC_RESERVATIONS') || '[]');
      const hasAirbnb = reservations.some(r =>
        (r.source || r.platform || '').toLowerCase().includes('airbnb')
      );
      const hasBooking = reservations.some(r =>
        (r.source || r.platform || '').toLowerCase().includes('booking')
      );
      setStatus('topbar-status-airbnb', hasAirbnb);
      setStatus('topbar-status-booking', hasBooking);

      // Stripe : vérifie lcc_user ou LCC_PROPERTIES
      const user = JSON.parse(localStorage.getItem('lcc_user') || '{}');
      const properties = JSON.parse(localStorage.getItem('LCC_PROPERTIES') || '[]');
      const hasStripe = !!(
        user.stripeAccountId ||
        user.stripe_account_id ||
        user.stripeConnected ||
        properties.some(p => p.stripeAccountId || p.stripe_account_id)
      );
      setStatus('topbar-status-stripe', hasStripe);
    } catch(e) {
      console.warn('TopBar status error:', e);
    }
  }

  // Vérifier au chargement
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', checkStatuses);
  } else {
    checkStatuses();
  }

  // Re-vérifier après chargement des données API (délai)
  setTimeout(checkStatuses, 2000);
  setTimeout(checkStatuses, 5000);

  // Exposer pour appel manuel après loadData
  window.updateTopBarStatus = checkStatuses;
})();
</script>

<div class="mobile-header">
  <a class="mobile-logo" href="/app.html"><i class="fas fa-calendar-check"></i><span class="mobile-logo-text">Boostinghost</span></a>
  <button class="mobile-menu-btn" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
</div>
<div class="sidebar-overlay" id="sidebarOverlay"></div>
<div class="app-container">
<div id="bhSidebar"></div>
<main class="main-content">
<div id="bhHeader"></div>
<button class="welcome-back-btn" onclick="window.location.href='/app.html'"><i class="fas fa-arrow-left"></i> Tableau de bord</button>

<div class="welcome-container">

  <!-- ── Header ── -->
  <div class="welcome-section-header">
    <div>
      <div class="welcome-kicker">Gestion</div>
      <h1 class="welcome-title">Mes <em>livrets</em></h1>
    </div>
  </div>

  <!-- ── Liste des livrets ── -->
  <div id="livretsListSection">
    <div class="livrets-grid" id="livretsList">
      <p style="color:#7A8695;grid-column:1/-1;text-align:center;padding:24px">Chargement...</p>
    </div>
  </div>

  <!-- ── Wizard de création ── -->
  <form id="welcomeForm" style="display:none;">

    <!-- Stepper -->
    <div class="wizard-stepper" id="wizardStepper">
      <div class="wizard-step active" data-step="1">
        <div class="wizard-step-num">1</div>
        <div class="wizard-step-label">Infos générales</div>
      </div>
      <div class="wizard-sep"></div>
      <div class="wizard-step" data-step="2">
        <div class="wizard-step-num">2</div>
        <div class="wizard-step-label">Accès & Arrivée</div>
      </div>
      <div class="wizard-sep"></div>
      <div class="wizard-step" data-step="3">
        <div class="wizard-step-num">3</div>
        <div class="wizard-step-label">Le logement</div>
      </div>
      <div class="wizard-sep"></div>
      <div class="wizard-step" data-step="4">
        <div class="wizard-step-num">4</div>
        <div class="wizard-step-label">Infos pratiques</div>
      </div>
      <div class="wizard-sep"></div>
      <div class="wizard-step" data-step="5">
        <div class="wizard-step-num">5</div>
        <div class="wizard-step-label">Aux alentours</div>
      </div>
    </div>

    <!-- Section 1: Infos générales -->
    <div class="form-section active" data-section="1">
      <div class="wiz-card">
        <div class="wiz-card-header">
          <div class="wiz-card-icon"><i class="fas fa-home"></i></div>
          <div>
            <h2 class="wiz-card-title">Informations Générales</h2>
            <p class="wiz-card-sub">Commencez par les informations de base de votre logement</p>
          </div>
        </div>
        <div class="wiz-card-body">
          <div class="wiz-info-box"><i class="fas fa-info-circle"></i> Ces informations apparaîtront sur la page d'accueil de votre livret</div>
          <div class="wiz-group">
            <label class="wiz-label">Nom du logement <span class="wiz-required">*</span><span class="wiz-hint">Ex: "Votre Pied-à-Terre", "Appartement Cosy Centre-Ville"</span></label>
            <input class="wiz-input" name="propertyName" placeholder="Nom de votre logement" required type="text"/>
          </div>
          <div class="wiz-group">
            <label class="wiz-label">Photo de couverture <span class="wiz-required">*</span><span class="wiz-hint">Image principale (format recommandé: 1920x1080px)</span></label>
            <div class="wiz-upload" onclick="document.getElementById('coverPhoto').click()">
              <i class="fas fa-cloud-upload-alt"></i>
              <p>Cliquez pour télécharger votre photo de couverture</p>
              <p class="wiz-upload-hint">JPG, PNG ou WebP (max 5MB)</p>
            </div>
            <input accept="image/*" id="coverPhoto" style="display:none;" type="file"/>
            <div class="image-preview" id="coverPhotoPreview"></div>
          </div>
          <div class="wiz-group">
            <label class="wiz-label">Message de bienvenue<span class="wiz-hint">Message d'accueil pour vos voyageurs</span></label>
            <textarea class="wiz-textarea" name="welcomeDescription" placeholder="Ex: Nous sommes ravis de vous accueillir dans cet appartement..."></textarea>
          </div>
          <div class="wiz-group">
            <label class="wiz-label">Votre numéro de téléphone <span class="wiz-required">*</span><span class="wiz-hint">Pour que vos voyageurs puissent vous contacter</span></label>
            <input class="wiz-input" name="contactPhone" placeholder="06 XX XX XX XX" required type="tel"/>
          </div>
        </div>
      </div>
      <div class="wiz-nav"><div></div><button class="wiz-btn-next" onclick="nextSection()" type="button">Suivant <i class="fas fa-arrow-right"></i></button></div>
    </div>

    <!-- Section 2: Accès & Arrivée -->
    <div class="form-section" data-section="2">
      <div class="wiz-card">
        <div class="wiz-card-header">
          <div class="wiz-card-icon"><i class="fas fa-map-marker-alt"></i></div>
          <div>
            <h2 class="wiz-card-title">Accès &amp; Arrivée</h2>
            <p class="wiz-card-sub">Comment vos voyageurs accèdent-ils à votre logement ?</p>
          </div>
        </div>
        <div class="wiz-card-body">
          <div class="wiz-grid-2">
            <div class="wiz-group">
              <label class="wiz-label">Adresse <span class="wiz-required">*</span></label>
              <input class="wiz-input" name="address" placeholder="Numéro et rue" required type="text"/>
            </div>
            <div class="wiz-group">
              <label class="wiz-label">Code postal <span class="wiz-required">*</span></label>
              <input class="wiz-input" name="postalCode" placeholder="75001" required type="text"/>
            </div>
          </div>
          <div class="wiz-grid-2">
            <div class="wiz-group">
              <label class="wiz-label">Ville <span class="wiz-required">*</span></label>
              <input class="wiz-input" name="city" placeholder="Paris" required type="text"/>
            </div>
            <div class="wiz-group">
              <label class="wiz-label">Code boîte à clés<span class="wiz-hint">Si applicable</span></label>
              <input class="wiz-input" name="keyboxCode" placeholder="Ex: 8670" type="text"/>
            </div>
          </div>
          <div class="wiz-group">
            <label class="wiz-label">Instructions d'accès<span class="wiz-hint">Portail, étage, etc.</span></label>
            <textarea class="wiz-textarea" name="accessInstructions" placeholder="Ex: Poussez le portail, la boîte à clés est à gauche..."></textarea>
          </div>
          <div class="wiz-group">
            <label class="wiz-label">Photos de l'entrée<span class="wiz-hint">Portail, entrée, boîte à clés...</span></label>
            <div class="wiz-upload" onclick="document.getElementById('entrancePhotos').click()">
              <i class="fas fa-images"></i>
              <p>Télécharger les photos de l'entrée</p>
              <p class="wiz-upload-hint">Plusieurs images possibles</p>
            </div>
            <input accept="image/*" id="entrancePhotos" multiple style="display:none;" type="file"/>
            <div class="image-preview" id="entrancePhotosPreview"></div>
          </div>
          <hr class="wiz-divider"/>
          <div class="wiz-group">
            <label class="wiz-label">Parking<span class="wiz-hint">Informations sur le stationnement</span></label>
            <textarea class="wiz-textarea" name="parkingInfo" placeholder="Ex: Parking gratuit au 43-51 rue du Marché, 230 places..."></textarea>
          </div>
          <div class="wiz-group">
            <label class="wiz-label">Photos du parking</label>
            <div class="wiz-upload" onclick="document.getElementById('parkingPhotos').click()">
              <i class="fas fa-parking"></i>
              <p>Télécharger les photos du parking</p>
            </div>
            <input accept="image/*" id="parkingPhotos" multiple style="display:none;" type="file"/>
            <div class="image-preview" id="parkingPhotosPreview"></div>
          </div>
        </div>
      </div>
      <div class="wiz-nav">
        <button class="wiz-btn-back" onclick="prevSection()" type="button"><i class="fas fa-arrow-left"></i> Précédent</button>
        <button class="wiz-btn-next" onclick="nextSection()" type="button">Suivant <i class="fas fa-arrow-right"></i></button>
      </div>
    </div>

    <!-- Section 3: Le Logement -->
    <div class="form-section" data-section="3">
      <div class="wiz-card">
        <div class="wiz-card-header">
          <div class="wiz-card-icon"><i class="fas fa-door-open"></i></div>
          <div>
            <h2 class="wiz-card-title">Le Logement</h2>
            <p class="wiz-card-sub">Présentez les différentes pièces et espaces</p>
          </div>
        </div>
        <div class="wiz-card-body">
          <div class="wiz-warn-box"><i class="fas fa-lightbulb"></i> Ajoutez autant de pièces que nécessaire</div>
          <div id="roomsContainer"></div>
          <button class="wiz-add-btn" onclick="addRoom()" type="button"><i class="fas fa-plus"></i> Ajouter une pièce / un espace</button>
        </div>
      </div>
      <div class="wiz-nav">
        <button class="wiz-btn-back" onclick="prevSection()" type="button"><i class="fas fa-arrow-left"></i> Précédent</button>
        <button class="wiz-btn-next" onclick="nextSection()" type="button">Suivant <i class="fas fa-arrow-right"></i></button>
      </div>
    </div>

    <!-- Section 4: Infos pratiques -->
    <div class="form-section" data-section="4">
      <div class="wiz-card">
        <div class="wiz-card-header">
          <div class="wiz-card-icon"><i class="fas fa-info-circle"></i></div>
          <div>
            <h2 class="wiz-card-title">Informations Pratiques</h2>
            <p class="wiz-card-sub">WiFi, équipements, consignes et tout ce qui est utile</p>
          </div>
        </div>
        <div class="wiz-card-body">
          <div class="wiz-subsection">
            <div class="wiz-subsection-title"><i class="fas fa-wifi"></i> WiFi</div>
            <div class="wiz-grid-2">
              <div class="wiz-group">
                <label class="wiz-label">Nom du réseau (SSID)</label>
                <input class="wiz-input" name="wifiSSID" placeholder="Nom du réseau" type="text"/>
              </div>
              <div class="wiz-group">
                <label class="wiz-label">Mot de passe</label>
                <input class="wiz-input" name="wifiPassword" placeholder="Mot de passe" type="text"/>
              </div>
            </div>
          </div>
          <hr class="wiz-divider"/>
          <div class="wiz-subsection">
            <div class="wiz-subsection-title"><i class="fas fa-clipboard-list"></i> Consignes de départ</div>
            <div class="wiz-group">
              <label class="wiz-label">Heure de départ<span class="wiz-hint">Ex: 11h, 10h30</span></label>
              <input class="wiz-input" name="checkoutTime" placeholder="11h" type="text"/>
            </div>
            <div class="wiz-group">
              <label class="wiz-label">Instructions de départ</label>
              <textarea class="wiz-textarea" name="checkoutInstructions" placeholder="- Éteindre toutes les lumières&#10;- Laver la vaisselle&#10;- Poser les serviettes au sol..." style="min-height:110px;"></textarea>
            </div>
          </div>
          <hr class="wiz-divider"/>
          <div class="wiz-subsection">
            <div class="wiz-subsection-title"><i class="fas fa-toolbox"></i> Équipements disponibles</div>
            <div class="wiz-group">
              <label class="wiz-label">Liste des équipements<span class="wiz-hint">Un équipement par ligne</span></label>
              <textarea class="wiz-textarea" name="equipmentList" placeholder="Machine à café Nespresso&#10;Micro-ondes&#10;Machine à laver..." style="min-height:140px;"></textarea>
            </div>
          </div>
          <hr class="wiz-divider"/>
          <div class="wiz-subsection">
            <div class="wiz-subsection-title"><i class="fas fa-exclamation-triangle"></i> Règles importantes</div>
            <div class="wiz-group">
              <label class="wiz-label">Règles et avertissements<span class="wiz-hint">Poutre basse, non-fumeur, etc.</span></label>
              <textarea class="wiz-textarea" name="importantRules" placeholder="Entrez les règles importantes..."></textarea>
            </div>
          </div>
          <hr class="wiz-divider"/>
          <div class="wiz-subsection">
            <div class="wiz-subsection-title"><i class="fas fa-train"></i> Transports</div>
            <div class="wiz-group">
              <label class="wiz-label">Informations transports<span class="wiz-hint">Accès transports en commun, gares, etc.</span></label>
              <textarea class="wiz-textarea" name="transportInfo" placeholder="Ex: Bus ligne 15 à 1 minute à pied..."></textarea>
            </div>
          </div>
        </div>
      </div>
      <div class="wiz-nav">
        <button class="wiz-btn-back" onclick="prevSection()" type="button"><i class="fas fa-arrow-left"></i> Précédent</button>
        <button class="wiz-btn-next" onclick="nextSection()" type="button">Suivant <i class="fas fa-arrow-right"></i></button>
      </div>
    </div>

    <!-- Section 5: Aux alentours -->
    <div class="form-section" data-section="5">
      <div class="wiz-card">
        <div class="wiz-card-header">
          <div class="wiz-card-icon"><i class="fas fa-map-marked-alt"></i></div>
          <div>
            <h2 class="wiz-card-title">Aux Alentours</h2>
            <p class="wiz-card-sub">Restaurants, commerces et lieux à visiter</p>
          </div>
        </div>
        <div class="wiz-card-body">
          <div class="wiz-subsection">
            <div class="wiz-subsection-title"><i class="fas fa-utensils"></i> Restaurants &amp; Bars</div>
            <div id="restaurantsContainer"></div>
            <button class="wiz-add-btn" onclick="addRestaurant()" type="button"><i class="fas fa-plus"></i> Ajouter un restaurant / bar</button>
          </div>
          <hr class="wiz-divider"/>
          <div class="wiz-subsection">
            <div class="wiz-subsection-title"><i class="fas fa-shopping-bag"></i> Commerces</div>
            <div class="wiz-group">
              <label class="wiz-label">Liste des commerces<span class="wiz-hint">Un commerce par ligne</span></label>
              <textarea class="wiz-textarea" name="shopsList" placeholder="FRANPRIX - 6 rue de Pontoise&#10;Boulangerie LA POTERNE - Place du marché..." style="min-height:110px;"></textarea>
            </div>
          </div>
          <hr class="wiz-divider"/>
          <div class="wiz-subsection">
            <div class="wiz-subsection-title"><i class="fas fa-map-signs"></i> Lieux à Visiter</div>
            <div id="placesContainer"></div>
            <button class="wiz-add-btn" onclick="addPlace()" type="button"><i class="fas fa-plus"></i> Ajouter un lieu à visiter</button>
          </div>
        </div>
      </div>
      <div class="wiz-nav">
        <button class="wiz-btn-back" onclick="prevSection()" type="button"><i class="fas fa-arrow-left"></i> Précédent</button>
        <button class="wiz-btn-submit" type="submit"><i class="fas fa-check-circle"></i> Créer le livret</button>
      </div>
    </div>

  </form>

  <!-- ── Succès ── -->
  <div id="successMessage" style="display:none;">
    <div class="wiz-success">
      <div class="wiz-success-icon"><i class="fas fa-check"></i></div>
      <h2>Livret créé avec succès !</h2>
      <p>Votre livret d'accueil personnalisé a été généré.</p>
      <div class="wiz-qr-box">
        <h3><i class="fas fa-qrcode"></i> QR Code du livret</h3>
        <div id="qrcode" style="display:flex;justify-content:center;margin-bottom:12px;"></div>
        <p style="font-size:12px;color:#9CA3AF;margin-bottom:12px;">Scannez pour accéder directement au livret</p>
        <button class="wiz-btn-next" onclick="downloadQRCode()" style="width:100%;justify-content:center;"><i class="fas fa-download"></i> Télécharger le QR Code</button>
      </div>
      <div class="wiz-success-actions">
        <button class="wiz-btn-next" onclick="viewWelcomeBook()"><i class="fas fa-eye"></i> Voir le livret</button>
        <button class="wiz-btn-back" onclick="copyWelcomeBookLink(this)"><i class="fas fa-copy"></i> Copier le lien</button>
        <button class="wiz-btn-back" onclick="modifyCurrentLivret()"><i class="fas fa-edit"></i> Modifier</button>
      </div>
    </div>
  </div>

</div><!-- .welcome-container -->
</main>
</div>

<script>

const API_BASE = 'https://lcc-booking-manager.onrender.com';

window.getAuthToken = window.getAuthToken || (() => localStorage.getItem('lcc_token') || '');
let currentUniqueId = null; // Pour savoir si on modifie ou on crée

// ----------------------------
// Navigation par sections (wizard)
// ----------------------------
let currentSectionIndex = 0;

function getSections() {
  return Array.from(document.querySelectorAll('.form-section'));
}

function showSection(index) {
  const sections = getSections();
  if (!sections.length) return;

  currentSectionIndex = Math.max(0, Math.min(index, sections.length - 1));
  sections.forEach((sec, i) => sec.classList.toggle('active', i === currentSectionIndex));

  // Scroll top du formulaire
  const form = document.getElementById('welcomeForm');
  if (form) form.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function nextSection() {
  showSection(currentSectionIndex + 1);
}

function prevSection() {
  showSection(currentSectionIndex - 1);
}

// ----------------------------
// Upload + preview images
// ----------------------------
function setupImageUpload(inputId, previewId, multiple = false) {
  const input = document.getElementById(inputId);
  const preview = document.getElementById(previewId);
  if (!input || !preview) return;

  input.addEventListener('change', () => {
    // Reset preview
    preview.innerHTML = '';

    const files = Array.from(input.files || []);
    if (!files.length) return;

    files.forEach(file => {
      if (!file.type || !file.type.startsWith('image/')) return;

      const reader = new FileReader();
      reader.onload = (ev) => {
        const div = document.createElement('div');
        div.className = 'image-preview-item';
        div.innerHTML = `
          <img src="${ev.target.result}" alt="preview">
        `;
        preview.appendChild(div);
      };
      reader.readAsDataURL(file);
    });
  });
}

// ----------------------------
// Collecte des données + sauvegarde
// ----------------------------
function collectFormData() {
  const formData = new FormData();

  // Champs texte simples
  const fields = [
    'propertyName','welcomeDescription','contactPhone',
    'address','postalCode','city','keyboxCode',
    'accessInstructions','parkingInfo','wifiSSID',
    'wifiPassword','checkoutTime','checkoutInstructions',
    'equipmentList','importantRules','transportInfo','shopsList'
  ];
  fields.forEach(f => formData.append(f, document.querySelector(`[name="${f}"]`)?.value || ''));

  // Pièces
  const rooms = [];
  document.querySelectorAll('#roomsContainer .room-block').forEach(block => {
    const name = block.querySelector('input[name*="[name]"]')?.value || '';
    const description = block.querySelector('textarea[name*="[description]"]')?.value || '';
    rooms.push({ name, description });
  });
  formData.append('rooms', JSON.stringify(rooms));

  // Restaurants
  const restaurants = [];
  document.querySelectorAll('#restaurantsContainer .restaurant-block').forEach(block => {
    const name = block.querySelector('input[name*="[name]"]')?.value || '';
    const phone = block.querySelector('input[name*="[phone]"]')?.value || '';
    const address = block.querySelector('input[name*="[address]"]')?.value || '';
    const description = block.querySelector('textarea[name*="[description]"]')?.value || '';
    restaurants.push({ name, phone, address, description });
  });
  formData.append('restaurants', JSON.stringify(restaurants));

  // Lieux
  const places = [];
  document.querySelectorAll('#placesContainer .place-block').forEach(block => {
    const name = block.querySelector('input[name*="[name]"]')?.value || '';
    const description = block.querySelector('textarea[name*="[description]"]')?.value || '';
    places.push({ name, description });
  });
  formData.append('places', JSON.stringify(places));

  // Fichiers
  const cover = document.getElementById('coverPhoto')?.files?.[0];
  if (cover) formData.append('coverPhoto', cover);

  const entrance = document.getElementById('entrancePhotos')?.files || [];
  for (const f of entrance) formData.append('entrancePhotos', f);

  const parking = document.getElementById('parkingPhotos')?.files || [];
  for (const f of parking) formData.append('parkingPhotos', f);

  // uniqueId si édition
  if (currentUniqueId) formData.append('uniqueId', currentUniqueId);

  return formData;
}

async function saveWelcomeBook(e) {
  if (e) e.preventDefault();

  try {
    const formData = collectFormData();

    const response = await fetch(`${API_BASE}/api/welcome-books/create`, {
      method: 'POST',
      body: formData
    });

    const raw = await response.text();
    let data = null;
    try { data = raw ? JSON.parse(raw) : null; } catch (_) { data = null; }

    if (!response.ok || !data || !data.success) {
      alert((data && (data.error || data.message)) ? (data.error || data.message) : `Erreur sauvegarde (${response.status})`);
      return;
    }

    // Si le backend renvoie un uniqueId, on le garde
    if (data.uniqueId) currentUniqueId = data.uniqueId;

    // Affichage succès
    hideFormShowSuccess();
    document.getElementById('successMessage').style.display = 'block';

    // Recharge la liste pour voir le livret
    await loadLivretsList();
  } catch (err) {
    console.error("Erreur sauvegarde:", err);
    alert("Erreur lors de la sauvegarde.");
  }
}

function createAnother() {
  currentUniqueId = null;
  const form = document.getElementById('welcomeForm');
  if (form) form.reset();

  // Reset previews + containers
  const previews = ['coverPhotoPreview','entrancePhotosPreview','parkingPhotosPreview'];
  previews.forEach(id => { const el = document.getElementById(id); if (el) el.innerHTML = ''; });

  const rooms = document.getElementById('roomsContainer'); if (rooms) rooms.innerHTML = '';
  const rests = document.getElementById('restaurantsContainer'); if (rests) rests.innerHTML = '';
  const places = document.getElementById('placesContainer'); if (places) places.innerHTML = '';

  roomCounter = 0; restaurantCounter = 0; placeCounter = 0;
  addRoom(); addRestaurant(); addPlace();

  document.getElementById('successMessage').style.display = 'none';
  setDisplayById('welcomeForm','block');
  showSection(0);
}

// Init
document.addEventListener('DOMContentLoaded', () => {
  setupImageUpload('coverPhoto', 'coverPhotoPreview', false);
  setupImageUpload('entrancePhotos', 'entrancePhotosPreview', true);
  setupImageUpload('parkingPhotos', 'parkingPhotosPreview', true);

  const form = document.getElementById('welcomeForm');
  if (form) form.addEventListener('submit', saveWelcomeBook);

  // Sections default
  showSection(0);

  // Prépare les blocs par défaut
  try { addRoom(); addRestaurant(); addPlace(); } catch (_) {}
});

// Charger la liste des livrets au démarrage
async function loadLivretsList() {
  try {
    const response = await fetch(`${API_BASE}/api/welcome-books/user/list`, {
      headers: { 'Authorization': `Bearer ${localStorage.getItem('lcc_token')}` }
    });
    
    const data = await response.json();
    
    if (data.success && data.welcomeBooks && data.welcomeBooks.length > 0) {
      displayLivretsList(data.welcomeBooks);
    } else {
      document.getElementById('livretsList').innerHTML = '<p style="color: #64748b; text-align: center;">Aucun livret pour le moment.</p>';
    }
  } catch (error) {
    console.error('Erreur chargement livrets:', error);
    document.getElementById('livretsList').innerHTML = '<p style="color: #e53e3e;">Erreur lors du chargement des livrets.</p>';
  }
}

// Afficher la liste des livrets
function displayLivretsList(livrets) {
  const html = livrets.map(livret => `
    <div style="border: 1px solid #e2e8f0; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; background: white;">
      <div>
        <strong style="font-size: 16px; color: #1a202c;">${livret.propertyName || 'Sans nom'}</strong>
        <br>
        <small style="color: #64748b;">Modifié le ${new Date(livret.updatedAt).toLocaleDateString('fr-FR')}</small>
      </div>
      <div style="display: flex; gap: 0.5rem;">
        <button class="btn btn-secondary" onclick="editLivret('${livret.uniqueId}')" style="font-size: 14px; padding: 0.5rem 1rem;">
          <i class="fas fa-edit"></i> Modifier
        </button>
        <button class="btn btn-secondary" onclick="viewLivret('${livret.uniqueId}')" style="font-size: 14px; padding: 0.5rem 1rem;">
          <i class="fas fa-eye"></i> Voir
        </button>
        <button class="btn btn-secondary" onclick="deleteLivret('${livret.uniqueId}')" style="font-size: 14px; padding: 0.5rem 1rem; background: #e53e3e; color: white;">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
  `).join('');
  
  document.getElementById('livretsList').innerHTML = html;
}

// Créer un nouveau livret
function createNewLivret() {
  currentUniqueId = null;
  document.getElementById('welcomeForm').reset();
  document.getElementById('livretsListSection').style.display = 'none';
  document.getElementById('welcomeForm').style.display = 'block';
  
  // Remonter en haut de la page
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Voir un livret
function viewLivret(uniqueId) {
  window.open(`${API_BASE}/welcome/${uniqueId}`, '_blank');
}

// Supprimer un livret
// Modifier un livret (chargement + remplissage du formulaire)
async function editLivret(uniqueId) {
  try {
    currentUniqueId = uniqueId;

    const response = await fetch(`${API_BASE}/api/welcome-books/public/${uniqueId}`);
    const data = await response.json();

    if (data && data.success && data.book) {
      fillFormWithData(data.book);
      document.getElementById('livretsListSection').style.display = 'none';
      setDisplayById('welcomeForm','block');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
      alert((data && data.error) ? data.error : "Impossible de charger ce livret.");
    }
  } catch (err) {
    console.error("Erreur editLivret:", err);
    alert("Erreur lors du chargement du livret.");
  }
}
async function copyWelcomeBookLink(buttonEl) {
    try {
      const url =
        window.welcomeBookUrl ||
        (typeof currentUniqueId !== "undefined" && currentUniqueId
          ? `${API_BASE}/welcome/${currentUniqueId}`
          : "");

      if (!url) {
        alert("Lien indisponible (uniqueId manquant)");
        return;
      }

      await navigator.clipboard.writeText(url);

      if (buttonEl) {
        const old = buttonEl.innerHTML;
        buttonEl.innerHTML = '<i class="fas fa-check"></i> Lien copié';
        setTimeout(() => (buttonEl.innerHTML = old), 1500);
      } else {
        alert("Lien copié ✅");
      }
    } catch (e) {
      const url =
        window.welcomeBookUrl ||
        (currentUniqueId ? `${API_BASE}/welcome/${currentUniqueId}` : "");
      prompt("Copie le lien :", url);
    }
  }
  async function modifyCurrentLivret() {
  if (!currentUniqueId) {
    alert("Impossible de modifier : identifiant manquant.");
    return;
  }
  await editLivret(currentUniqueId);
}
async function deleteLivret(uniqueId) {
  if (!confirm('Êtes-vous sûr de vouloir supprimer ce livret ?')) return;
  
  try {
    const response = await fetch(`${API_BASE}/api/welcome-books/by-unique/${uniqueId}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${localStorage.getItem('lcc_token')}` }
    });
    
    const raw = await response.text();
      let data = null;
      try { data = raw ? JSON.parse(raw) : null; } catch (e) { data = null; }

      if (data && data.success) {
      alert('Livret supprimé avec succès');
      loadLivretsList();
    } else {
      alert('Erreur lors de la suppression');
    }
  } catch (error) {
    console.error('Erreur suppression:', error);
    alert('Erreur lors de la suppression');
  }
}
function downloadQRCode(uniqueId) {
  try {
    // 0) Si on a un uniqueId, on peut toujours reconstruire l'URL
    const url = uniqueId ? `${API_BASE}/welcome/${uniqueId}` : (window.welcomeBookUrl || null);

    // 1) Cas 1: un <img> dédié (si tu l'utilises dans une liste)
    const img =
      (uniqueId && document.getElementById(`qrCodeImg-${uniqueId}`)) ||
      (uniqueId && document.querySelector(`[data-qr="${uniqueId}"]`)) ||
      document.querySelector('#qrcode img');

    if (img && img.src) {
      const a = document.createElement('a');
      a.href = img.src;
      a.download = `qr-${uniqueId || 'welcome-book'}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      return;
    }

    // 2) Cas 2: QRCodeJS rend souvent un <canvas>
    const canvas = document.querySelector('#qrcode canvas');
    if (canvas && canvas.toDataURL) {
      const a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download = `qr-${uniqueId || 'welcome-book'}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      return;
    }

    // 3) Fallback: si on a l'URL mais pas de rendu, on génère un QR temporaire puis on télécharge
    if (url && window.QRCode) {
      const tmp = document.createElement('div');
      tmp.style.position = 'fixed';
      tmp.style.left = '-9999px';
      tmp.style.top = '-9999px';
      document.body.appendChild(tmp);

      new QRCode(tmp, { text: url, width: 256, height: 256 });

      // QRCodeJS peut mettre un img ou un canvas
      const tmpImg = tmp.querySelector('img');
      const tmpCanvas = tmp.querySelector('canvas');

      const dataUrl = tmpImg?.src || (tmpCanvas?.toDataURL ? tmpCanvas.toDataURL('image/png') : null);
      document.body.removeChild(tmp);

      if (dataUrl) {
        const a = document.createElement('a');
        a.href = dataUrl;
        a.download = `qr-${uniqueId || 'welcome-book'}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        return;
      }
    }

    alert("QR Code introuvable");
  } catch (e) {
    console.error("downloadQRCode error:", e);
    alert("Impossible de télécharger le QR Code.");
  }
}
// Remplir le formulaire avec les données d'un livret
// Affiche une image déjà existante (URL) dans un container de preview
function showExistingImage(containerId, url) {
  const container = document.getElementById(containerId);
  if (!container || !url) return;

  const wrapper = document.createElement('div');
  wrapper.className = 'preview-thumb';

  const img = document.createElement('img');
  img.src = url;
  img.alt = 'Photo existante';
  img.loading = 'lazy';

  wrapper.appendChild(img);
  container.appendChild(wrapper);
}

// Compteurs pour les sections répétables
let roomCounter = 0;
let restaurantCounter = 0;
let placeCounter = 0;

function addRoom() {
  const container = document.getElementById('roomsContainer');
  if (!container) return;
  roomCounter += 1;

  const block = document.createElement('div');
  block.className = 'repeat-block room-block';

  block.innerHTML = `
    <div class="field">
      <label>Nom de la pièce</label>
      <input type="text" name="room[${roomCounter}][name]" placeholder="Ex: Chambre 1">
    </div>
    <div class="field">
      <label>Description</label>
      <textarea name="room[${roomCounter}][description]" rows="3" placeholder="Lit, rangement, etc."></textarea>
    </div>
    <hr/>
  `;
  container.appendChild(block);
}

function addRestaurant() {
  const container = document.getElementById('restaurantsContainer');
  if (!container) return;
  restaurantCounter += 1;

  const block = document.createElement('div');
  block.className = 'repeat-block restaurant-block';

  block.innerHTML = `
    <div class="field">
      <label>Nom</label>
      <input type="text" name="restaurant[${restaurantCounter}][name]" placeholder="Nom du restaurant">
    </div>
    <div class="field">
      <label>Téléphone</label>
      <input type="text" name="restaurant[${restaurantCounter}][phone]" placeholder="01 23 45 67 89">
    </div>
    <div class="field">
      <label>Adresse</label>
      <input type="text" name="restaurant[${restaurantCounter}][address]" placeholder="Adresse">
    </div>
    <div class="field">
      <label>Description</label>
      <textarea name="restaurant[${restaurantCounter}][description]" rows="3" placeholder="Pourquoi tu le recommandes"></textarea>
    </div>
    <hr/>
  `;
  container.appendChild(block);
}

function addPlace() {
  const container = document.getElementById('placesContainer');
  if (!container) return;
  placeCounter += 1;

  const block = document.createElement('div');
  block.className = 'repeat-block place-block';

  block.innerHTML = `
    <div class="field">
      <label>Nom</label>
      <input type="text" name="place[${placeCounter}][name]" placeholder="Lieu à visiter">
    </div>
    <div class="field">
      <label>Description</label>
      <textarea name="place[${placeCounter}][description]" rows="3" placeholder="Infos utiles"></textarea>
    </div>
    <hr/>
  `;
  container.appendChild(block);
}

function fillFormWithData(data) {
  if (!data) return;

  // Champs simples
  const fields = [
    'propertyName', 'welcomeDescription', 'contactPhone',
    'address', 'postalCode', 'city', 'keyboxCode',
    'accessInstructions', 'parkingInfo', 'wifiSSID',
    'wifiPassword', 'checkoutTime', 'checkoutInstructions',
    'equipmentList', 'importantRules', 'transportInfo', 'shopsList'
  ];

  fields.forEach(f => {
    const el = document.querySelector(`[name="${f}"]`);
    if (!el) return;
    // On accepte 0 / false / "" : on teste uniquement undefined/null
    if (data[f] !== undefined && data[f] !== null) el.value = data[f];
  });

  // Photos existantes (si présentes en URL)
  if (data.photos) {
    if (data.photos.cover) showExistingImage('coverPhotoPreview', data.photos.cover);
    if (Array.isArray(data.photos.entrance)) data.photos.entrance.forEach(u => showExistingImage('entrancePhotosPreview', u));
    if (Array.isArray(data.photos.parking)) data.photos.parking.forEach(u => showExistingImage('parkingPhotosPreview', u));
  }

  // Pièces
  document.getElementById('roomsContainer').innerHTML = '';
  roomCounter = 0;
  if (Array.isArray(data.rooms) && data.rooms.length) {
    data.rooms.forEach(r => {
      addRoom();
      document.querySelector(`[name="room[${roomCounter}][name]"]`).value = r.name || '';
      document.querySelector(`[name="room[${roomCounter}][description]"]`).value = r.description || '';
    });
  } else {
    addRoom();
  }

  // Restaurants
  document.getElementById('restaurantsContainer').innerHTML = '';
  restaurantCounter = 0;
  if (Array.isArray(data.restaurants) && data.restaurants.length) {
    data.restaurants.forEach(r => {
      addRestaurant();
      document.querySelector(`[name="restaurant[${restaurantCounter}][name]"]`).value = r.name || '';
      document.querySelector(`[name="restaurant[${restaurantCounter}][phone]"]`).value = r.phone || '';
      document.querySelector(`[name="restaurant[${restaurantCounter}][address]"]`).value = r.address || '';
      document.querySelector(`[name="restaurant[${restaurantCounter}][description]"]`).value = r.description || '';
    });
  } else {
    addRestaurant();
  }

  // Lieux
  document.getElementById('placesContainer').innerHTML = '';
  placeCounter = 0;
  if (Array.isArray(data.places) && data.places.length) {
    data.places.forEach(p => {
      addPlace();
      document.querySelector(`[name="place[${placeCounter}][name]"]`).value = p.name || '';
      document.querySelector(`[name="place[${placeCounter}][description]"]`).value = p.description || '';
    });
  } else {
    addPlace();
  }

  // URL public / QR (on se base sur currentUniqueId si on édite)
  const uid = currentUniqueId || data.uniqueId;
  if (uid) window.welcomeBookUrl = `${API_BASE}/welcome/${uid}`;
}

// Appeler loadLivretsList() au chargement de la page() au chargement de la page
document.addEventListener('DOMContentLoaded', loadLivretsList);
// ----------------------------
// Helpers d'affichage (liste/form/succès)
// ----------------------------
function setDisplayById(id, display) {
  const el = document.getElementById(id);
  if (el) el.style.display = display;
}

function hideFormShowSuccess() {
  setDisplayById('welcomeForm', 'none');
  setDisplayById('successMessage', 'block');
}

function showFormHideLists() {
  setDisplayById('livretsListSection', 'none');
  setDisplayById('successMessage', 'none');
  setDisplayById('welcomeForm', 'block');
  try { showSection(0); } catch (_) {}
}

function createNewLivret() {
  currentUniqueId = null;
  const form = document.getElementById('welcomeForm');
  if (form) form.reset();
  showFormHideLists();
}


</script>

<script>
// ── Redesign helpers ──

// Update stepper UI
function updateStepper(index) {
  document.querySelectorAll('.wizard-step').forEach((step, i) => {
    step.classList.remove('active','done');
    if (i === index) step.classList.add('active');
    else if (i < index) step.classList.add('done');
  });
}

// Patch showSection to also update stepper
const _origShowSection = showSection;
window.showSection = function(index) {
  _origShowSection(index);
  updateStepper(index);
};

// Redesign displayLivretsList
function displayLivretsList(livrets) {
  const grid = document.getElementById('livretsList');
  if (!livrets || !livrets.length) {
    grid.innerHTML = '<p style="color:#7A8695;grid-column:1/-1;text-align:center;padding:24px">Aucun livret pour le moment.</p>';
    appendAddCard(grid);
    return;
  }
  const html = livrets.map(livret => `
    <div class="livret-card">
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="livret-card-icon"><i class="fas fa-book-open"></i></div>
        <div>
          <div class="livret-card-name">${livret.propertyName || 'Sans nom'}</div>
          <div class="livret-card-date">Modifié le ${new Date(livret.updatedAt).toLocaleDateString('fr-FR')}</div>
        </div>
      </div>
      <div class="livret-card-actions">
        <button class="btn-lv btn-lv-edit" onclick="editLivret('${livret.uniqueId}')"><i class="fas fa-edit"></i> Modifier</button>
        <button class="btn-lv btn-lv-view" onclick="viewLivret('${livret.uniqueId}')"><i class="fas fa-eye"></i> Voir</button>
        <button class="btn-lv btn-lv-delete" onclick="deleteLivret('${livret.uniqueId}')"><i class="fas fa-trash"></i></button>
      </div>
    </div>
  `).join('');
  grid.innerHTML = html;
  appendAddCard(grid);
}

function appendAddCard(grid) {
  const add = document.createElement('div');
  add.className = 'livret-card-add';
  add.onclick = createNewLivret;
  add.innerHTML = `
    <div class="livret-card-add-icon"><i class="fas fa-plus"></i></div>
    <div class="livret-card-add-label">Nouveau livret</div>
    <div class="livret-card-add-sub">Créer un livret d'accueil</div>
  `;
  grid.appendChild(add);
}

// Redesign addRoom
window.addRoom = function() {
  const container = document.getElementById('roomsContainer');
  if (!container) return;
  roomCounter += 1;
  const block = document.createElement('div');
  block.className = 'wiz-repeat-block room-block';
  block.innerHTML = `
    <div class="wiz-repeat-header">
      <span class="wiz-repeat-title"><i class="fas fa-door-open" style="color:#1A7A5E;margin-right:6px;"></i>Pièce ${roomCounter}</span>
      <button type="button" class="wiz-remove-btn" onclick="this.closest('.wiz-repeat-block').remove()"><i class="fas fa-times"></i></button>
    </div>
    <div class="wiz-group">
      <label class="wiz-label">Nom de la pièce</label>
      <input type="text" class="wiz-input" name="room[${roomCounter}][name]" placeholder="Ex: Chambre 1">
    </div>
    <div class="wiz-group" style="margin-bottom:0">
      <label class="wiz-label">Description</label>
      <textarea class="wiz-textarea" name="room[${roomCounter}][description]" placeholder="Lit, rangement, etc."></textarea>
    </div>
  `;
  container.appendChild(block);
};

window.addRestaurant = function() {
  const container = document.getElementById('restaurantsContainer');
  if (!container) return;
  restaurantCounter += 1;
  const block = document.createElement('div');
  block.className = 'wiz-repeat-block restaurant-block';
  block.innerHTML = `
    <div class="wiz-repeat-header">
      <span class="wiz-repeat-title"><i class="fas fa-utensils" style="color:#1A7A5E;margin-right:6px;"></i>Restaurant / Bar ${restaurantCounter}</span>
      <button type="button" class="wiz-remove-btn" onclick="this.closest('.wiz-repeat-block').remove()"><i class="fas fa-times"></i></button>
    </div>
    <div class="wiz-grid-2">
      <div class="wiz-group">
        <label class="wiz-label">Nom</label>
        <input type="text" class="wiz-input" name="restaurant[${restaurantCounter}][name]" placeholder="Nom du restaurant">
      </div>
      <div class="wiz-group">
        <label class="wiz-label">Téléphone</label>
        <input type="text" class="wiz-input" name="restaurant[${restaurantCounter}][phone]" placeholder="01 23 45 67 89">
      </div>
    </div>
    <div class="wiz-group">
      <label class="wiz-label">Adresse</label>
      <input type="text" class="wiz-input" name="restaurant[${restaurantCounter}][address]" placeholder="Adresse">
    </div>
    <div class="wiz-group" style="margin-bottom:0">
      <label class="wiz-label">Pourquoi le recommander ?</label>
      <textarea class="wiz-textarea" name="restaurant[${restaurantCounter}][description]" placeholder="Cuisine, ambiance, spécialité..."></textarea>
    </div>
  `;
  container.appendChild(block);
};

window.addPlace = function() {
  const container = document.getElementById('placesContainer');
  if (!container) return;
  placeCounter += 1;
  const block = document.createElement('div');
  block.className = 'wiz-repeat-block place-block';
  block.innerHTML = `
    <div class="wiz-repeat-header">
      <span class="wiz-repeat-title"><i class="fas fa-map-marker-alt" style="color:#1A7A5E;margin-right:6px;"></i>Lieu ${placeCounter}</span>
      <button type="button" class="wiz-remove-btn" onclick="this.closest('.wiz-repeat-block').remove()"><i class="fas fa-times"></i></button>
    </div>
    <div class="wiz-group">
      <label class="wiz-label">Nom</label>
      <input type="text" class="wiz-input" name="place[${placeCounter}][name]" placeholder="Lieu à visiter">
    </div>
    <div class="wiz-group" style="margin-bottom:0">
      <label class="wiz-label">Description</label>
      <textarea class="wiz-textarea" name="place[${placeCounter}][description]" placeholder="Infos utiles, pourquoi y aller..."></textarea>
    </div>
  `;
  container.appendChild(block);
};
</script>

<script src="/js/bh-layout.js"></script>
<script src="/js/logout-fix.js"></script>
<script src="/js/mobile-native-experience.js"></script>
<script src="/js/mobile-tabs-handler.js"></script>
<script src="/js/messages-badge-desktop-mobile.js"></script>
</body>
</html>
