<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug Notifications Push</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Courier New', monospace;
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
    }
    h1 {
      color: #4ec9b0;
      margin-bottom: 20px;
      font-size: 18px;
    }
    .controls {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    button {
      background: #007acc;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 600;
    }
    button:active {
      background: #005a9e;
    }
    button.danger {
      background: #d73a49;
    }
    button.success {
      background: #28a745;
    }
    .log-container {
      background: #252526;
      border: 1px solid #3e3e42;
      border-radius: 6px;
      padding: 15px;
      max-height: 70vh;
      overflow-y: auto;
      font-size: 12px;
      line-height: 1.6;
    }
    .log-entry {
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 4px;
      border-left: 3px solid;
    }
    .log-debug {
      border-left-color: #569cd6;
      background: #1e2a3a;
    }
    .log-info {
      border-left-color: #4ec9b0;
      background: #1e3a2e;
    }
    .log-warn {
      border-left-color: #dcdcaa;
      background: #3a3a1e;
    }
    .log-error {
      border-left-color: #f48771;
      background: #3a1e1e;
    }
    .timestamp {
      color: #858585;
      font-size: 11px;
      margin-right: 8px;
    }
    .status-bar {
      background: #007acc;
      color: white;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .status-bar span {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>üîî Debug Notifications Push</h1>
  
  <div class="status-bar">
    <div>Platform: <span id="platform">-</span></div>
    <div>Capacitor: <span id="capacitor">-</span></div>
    <div>Permission: <span id="permission">-</span></div>
    <div>Token: <span id="token-status">-</span></div>
  </div>

  <div class="controls">
    <button onclick="testInit()">üîÑ Tester Init</button>
    <button onclick="checkPermissions()">üîê V√©rifier Permissions</button>
    <button onclick="requestPermissions()" class="success">‚úã Demander Permissions</button>
    <button onclick="registerPush()">üìù Register Push</button>
    <button onclick="sendPending()">üì§ Envoyer Token Pending</button>
    <button onclick="clearLogs()" class="danger">üóëÔ∏è Clear Logs</button>
  </div>

  <div class="log-container" id="logs"></div>

  <script>
    // Remplacer console.log
    const originalLog = console.log;
    const originalWarn = console.warn;
    const originalError = console.error;

    function addLog(message, type = 'debug') {
      const logsDiv = document.getElementById('logs');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      
      const timestamp = new Date().toLocaleTimeString('fr-FR', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        fractionalSecondDigits: 3
      });
      
      entry.innerHTML = `<span class="timestamp">${timestamp}</span>${message}`;
      logsDiv.appendChild(entry);
      logsDiv.scrollTop = logsDiv.scrollHeight;
      
      // Garder aussi dans la vraie console
      if (type === 'error') originalError(message);
      else if (type === 'warn') originalWarn(message);
      else originalLog(message);
    }

    console.log = (...args) => addLog(args.join(' '), 'debug');
    console.warn = (...args) => addLog(args.join(' '), 'warn');
    console.error = (...args) => addLog(args.join(' '), 'error');
    console.info = (...args) => addLog(args.join(' '), 'info');

    function clearLogs() {
      document.getElementById('logs').innerHTML = '';
      addLog('üóëÔ∏è Logs effac√©s', 'info');
    }

    function updateStatus() {
      const platformEl = document.getElementById('platform');
      const capacitorEl = document.getElementById('capacitor');
      
      if (typeof Capacitor !== 'undefined' || typeof window.Capacitor !== 'undefined') {
        const Cap = window.Capacitor || Capacitor;
        platformEl.textContent = Cap.getPlatform();
        capacitorEl.textContent = '‚úÖ Disponible';
        capacitorEl.style.color = '#4ec9b0';
      } else {
        platformEl.textContent = 'web';
        capacitorEl.textContent = '‚ùå Non disponible';
        capacitorEl.style.color = '#f48771';
      }
    }

    async function checkPermissions() {
      try {
        console.log('üîê V√©rification des permissions...');
        
        if (typeof Capacitor === 'undefined' && typeof window.Capacitor === 'undefined') {
          console.error('‚ùå Capacitor non disponible');
          return;
        }

        const Cap = window.Capacitor || Capacitor;
        const { PushNotifications } = Cap.Plugins;
        
        if (!PushNotifications) {
          console.error('‚ùå Plugin PushNotifications non trouv√©');
          console.log('Plugins disponibles:', Object.keys(Cap.Plugins).join(', '));
          return;
        }

        const result = await PushNotifications.checkPermissions();
        console.log('üìä Permissions:', JSON.stringify(result));
        document.getElementById('permission').textContent = result.receive;
        document.getElementById('permission').style.color = 
          result.receive === 'granted' ? '#4ec9b0' : '#f48771';
      } catch (error) {
        console.error('‚ùå Erreur:', error.message);
      }
    }

    async function requestPermissions() {
      try {
        console.log('‚úã Demande de permissions...');
        
        const Cap = window.Capacitor || Capacitor;
        const { PushNotifications } = Cap.Plugins;
        
        const result = await PushNotifications.requestPermissions();
        console.log('üìä R√©sultat:', JSON.stringify(result));
        document.getElementById('permission').textContent = result.receive;
        document.getElementById('permission').style.color = 
          result.receive === 'granted' ? '#4ec9b0' : '#f48771';
      } catch (error) {
        console.error('‚ùå Erreur:', error.message);
      }
    }

    async function registerPush() {
      try {
        console.log('üìù Enregistrement push notifications...');
        
        const Cap = window.Capacitor || Capacitor;
        const { PushNotifications } = Cap.Plugins;
        
        // Ajouter les listeners
        PushNotifications.addListener('registration', (token) => {
          console.log('‚úÖ Token re√ßu:', token.value.substring(0, 50) + '...');
          document.getElementById('token-status').textContent = '‚úÖ Re√ßu';
          document.getElementById('token-status').style.color = '#4ec9b0';
          
          // Sauvegarder
          const platform = Cap.getPlatform();
          const deviceType = platform === 'ios' ? 'ios' : 'android';
          saveToken(token.value, deviceType);
        });

        PushNotifications.addListener('registrationError', (error) => {
          console.error('‚ùå Erreur registration:', JSON.stringify(error));
        });

        await PushNotifications.register();
        console.log('‚úÖ Register() appel√©');
        
      } catch (error) {
        console.error('‚ùå Erreur:', error.message);
      }
    }

    async function saveToken(token, deviceType) {
      try {
        console.log('üíæ Sauvegarde token...');
        console.log('   Device:', deviceType);
        
        const authToken = localStorage.getItem('token');
        if (!authToken) {
          console.warn('‚ö†Ô∏è Pas de token auth - sauvegarde en local');
          localStorage.setItem('pending_fcm_token', token);
          localStorage.setItem('pending_device_type', deviceType);
          return;
        }

        const response = await fetch('/api/save-token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ token, device_type: deviceType })
        });

        const data = await response.json();
        
        if (response.ok) {
          console.log('‚úÖ Token enregistr√© sur serveur');
          localStorage.removeItem('pending_fcm_token');
          localStorage.removeItem('pending_device_type');
        } else {
          console.error('‚ùå Erreur serveur:', data.error);
        }
      } catch (error) {
        console.error('‚ùå Erreur r√©seau:', error.message);
      }
    }

    async function sendPending() {
      const token = localStorage.getItem('pending_fcm_token');
      const deviceType = localStorage.getItem('pending_device_type');
      
      if (!token) {
        console.warn('‚ö†Ô∏è Pas de token en attente');
        return;
      }
      
      console.log('üì§ Envoi token en attente...');
      await saveToken(token, deviceType);
    }

    async function testInit() {
      console.log('üîÑ Test initialisation compl√®te...');
      await checkPermissions();
      setTimeout(() => registerPush(), 1000);
    }

    // Au chargement
    window.addEventListener('load', () => {
      console.log('üéØ Page de debug charg√©e');
      updateStatus();
      
      // V√©rifier le token en attente
      const pendingToken = localStorage.getItem('pending_fcm_token');
      if (pendingToken) {
        console.info('‚ÑπÔ∏è Token en attente d√©tect√©');
      }
    });
  </script>
</body>
</html>
