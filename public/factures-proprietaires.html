<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Boostinghost ‚Äì Facturation</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="/css/style.css">

  <style>
    /* DESIGN SYSTEM "FACTURE PRO" */
    :root { --primary: #10B981; --primary-dark: #059669; --bg-body: #f3f4f6; --paper-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }

    html, body { margin: 0; padding: 0; background: var(--bg-body); font-family: 'Inter', sans-serif; height: 100%; overflow-x: hidden; }
    .app-container { display: flex; min-height: 100vh; }
    
    /* SIDEBAR */
    .sidebar { width: 260px; background: white; border-right: 1px solid #e5e7eb; position: fixed; top: 0; bottom: 0; left: 0; z-index: 50; display: flex; flex-direction: column; }
    .sidebar-header { padding: 24px; }
    .sidebar-logo { display: flex; align-items: center; gap: 10px; text-decoration: none; color: #111827; font-weight: 800; font-size: 18px; }
    .nav-section-title { font-size: 11px; font-weight: 700; color: #9ca3af; text-transform: uppercase; margin: 24px 24px 8px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 24px; color: #4b5563; text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s; border-right: 3px solid transparent; }
    .nav-item:hover { background: #f9fafb; color: #111827; }
    .nav-item.active { background: #ecfdf5; color: #10B981; border-right-color: #10B981; }
    .nav-item i { width: 20px; text-align: center; }

    /* CONTENT */
    .main-wrapper { flex: 1; margin-left: 260px; display: flex; flex-direction: column; min-width: 0; }
    .top-bar { background: white; height: 64px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: flex-end; padding: 0 32px; position: sticky; top: 0; z-index: 40; }
    .main-content { padding: 32px; max-width: 1600px; margin: 0 auto; width: 100%; box-sizing: border-box; }

    /* DASHBOARD */
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
    .page-title { font-size: 24px; font-weight: 700; color: #111827; margin: 0; }
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .stat-card { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .stat-label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #6b7280; margin-bottom: 8px; display: block; }
    .stat-value { font-size: 24px; font-weight: 700; color: #111827; }

    /* TABS */
    .nav-tabs { display: inline-flex; background: #e5e7eb; padding: 4px; border-radius: 10px; margin-bottom: 24px; }
    .nav-tab { padding: 8px 24px; border-radius: 8px; border: none; background: transparent; font-weight: 600; color: #4b5563; cursor: pointer; font-size: 14px; transition: all 0.2s; }
    .nav-tab.active { background: white; color: #111827; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }

    /* √âDITEUR FACTURE (Split View) */
    .invoice-editor-layout { display: grid; grid-template-columns: 400px 1fr; gap: 32px; align-items: start; }
    
    /* GAUCHE : Contr√¥les */
    .editor-sidebar { background: white; border-radius: 16px; border: 1px solid #e5e7eb; position: sticky; top: 88px; max-height: calc(100vh - 120px); overflow-y: auto; display: flex; flex-direction: column; }
    .editor-section { padding: 20px; border-bottom: 1px solid #f3f4f6; }
    .editor-section-title { font-size: 12px; font-weight: 700; text-transform: uppercase; color: #9ca3af; margin-bottom: 12px; }
    
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; color: #374151; }
    .form-control { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px; box-sizing: border-box; }
    .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(16,185,129,0.1); }
    
    /* DROITE : Feuille A4 */
    .invoice-preview-container { display: flex; justify-content: center; padding-bottom: 40px; }
    .invoice-paper { background: white; width: 100%; max-width: 800px; min-height: 1000px; padding: 48px; box-shadow: var(--paper-shadow); border-radius: 2px; position: relative; color: #1f2937; }
    .paper-header { display: flex; justify-content: space-between; margin-bottom: 40px; }
    .paper-logo-img { max-height: 60px; max-width: 180px; object-fit: contain; display: block; margin-bottom: 8px; }
    
    .paper-table { width: 100%; border-collapse: collapse; margin-top: 32px; }
    .paper-table th { text-align: left; padding: 12px 8px; border-bottom: 2px solid #e5e7eb; font-size: 11px; text-transform: uppercase; color: #6b7280; font-weight: 600; }
    .paper-table td { padding: 16px 8px; border-bottom: 1px solid #f3f4f6; font-size: 13px; vertical-align: top; }
    .paper-totals { display: flex; justify-content: flex-end; margin-top: 32px; }
    .totals-box { width: 260px; }
    .total-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; color: #4b5563; }
    .total-row.final { font-size: 16px; font-weight: 700; color: var(--primary); border-top: 2px solid #e5e7eb; margin-top: 8px; padding-top: 12px; }

    /* PRESTATIONS MINI-CARDS (Style √âditeur) */
    .prestation-mini-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 8px; position: relative; }
    .prestation-mini-card:hover { border-color: #d1d5db; background: white; }
    .prestation-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; }
    .badge-commission { background: #dcfce7; color: #166534; }
    .badge-cleaning { background: #dbeafe; color: #1e40af; }
    .badge-debours { background: #fef3c7; color: #92400e; }
    .badge-other { background: #f3f4f6; color: #374151; }
    .remove-line-btn { position: absolute; top: 8px; right: 8px; color: #ef4444; background: none; border: none; cursor: pointer; opacity: 0.5; }
    .remove-line-btn:hover { opacity: 1; }

    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; text-decoration: none; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: white; border: 1px solid #d1d5db; color: #374151; }
    .btn-xs { padding: 4px 8px; font-size: 11px; }

    /* MODALS */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: white; border-radius: 16px; width: 90%; max-width: 500px; padding: 24px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; }

    @media (max-width: 1024px) {
      .sidebar { transform: translateX(-100%); } .sidebar.active { transform: translateX(0); }
      .main-wrapper { margin-left: 0; } .invoice-editor-layout { grid-template-columns: 1fr; }
      .menu-toggle { display: block; font-size: 20px; background: none; border: none; cursor: pointer; margin-right: 16px; }
    }
    @media (min-width: 1025px) { .menu-toggle { display: none; } }
    .invoice-row-actions {
  position: relative;
  display: inline-block;
}
/* LES 3 PETITS POINTS*/
.invoice-actions-menu {
  position: fixed;              /* au lieu de absolute */
  right: 0;
  top: 0;
  margin-top: 0;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  box-shadow: 0 10px 25px rgba(15,23,42,0.15);
  padding: 4px;
  min-width: 180px;
  display: none;
  z-index: 9999;                /* passe au-dessus de la carte */
}


.invoice-actions-menu.open {
  display: block;
}

.invoice-actions-menu button {
  width: 100%;
  padding: 8px 10px;
  background: transparent;
  border: none;
  text-align: left;
  font-size: 13px;
  border-radius: 6px;
  cursor: pointer;
}

.invoice-actions-menu button:hover {
  background: #f3f4f6;
}
@media print {
  body {
    background: #ffffff !important;
  }

  body * {
    visibility: hidden;
  }

  .invoice-paper,
  .invoice-paper * {
    visibility: visible;
  }

  .invoice-paper {
    position: absolute;
    inset: 0;
    margin: 0;
    box-shadow: none;
    max-width: none;
    width: 210mm;     /* format A4 portrait */
    min-height: 0;
  }
}
/* D√©sactiver les petites fl√®ches sur tous les champs num√©riques */
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

input[type="number"] {
  -moz-appearance: textfield;
  appearance: textfield;
}

/* READ-ONLY MODE (vue consultation facture) */
.editor-sidebar.readonly .form-control,
.editor-sidebar.readonly .btn-primary {
  pointer-events: none;
  opacity: 0.6;
  background: #f3f4f6;
}

.editor-sidebar.readonly .remove-line-btn {
  display: none;
}

.readonly-banner {
  background: #fef3c7;
  border: 1px solid #fbbf24;
  color: #92400e;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 16px;
  font-size: 13px;
  font-weight: 600;
  text-align: center;
}

  </style>
</head>
<body>

<div class="app-container">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <a href="/" class="sidebar-logo">
        <i class="fa fa-chart-line" style="color:var(--primary);"></i> Boostinghost
      </a>
    </div>

    <div class="nav-section-title">Menu</div>
    <a href="/dashboard.html" class="nav-item"><i class="fa fa-home"></i>Tableau de bord</a>
    <a href="/reservations.html" class="nav-item"><i class="fa fa-calendar-check"></i>R√©servations</a>
    <a href="/proprietes.html" class="nav-item"><i class="fa fa-building"></i>Propri√©t√©s</a>
    <a href="/taches.html" class="nav-item"><i class="fa fa-tasks"></i>T√¢ches</a>
    <a href="/messages.html" class="nav-item"><i class="fa fa-comments"></i>Messages</a>

    <div class="nav-section-title">Comptabilit√©</div>
    <a href="/factures-client.html" class="nav-item"><i class="fa fa-file-invoice"></i>Factures clients</a>
    <a href="/factures-proprietaires.html" class="nav-item active"><i class="fa fa-file-invoice-dollar"></i>Factures propri√©taires</a>

    <div class="nav-section-title">Autres</div>
    <a href="/parametres.html" class="nav-item"><i class="fa fa-cog"></i>Param√®tres</a>
  </aside>

  <div class="main-wrapper">
    <header class="top-bar">
      <button class="menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('active')">
        <i class="fa fa-bars"></i>
      </button>
      <button class="btn btn-secondary" onclick="logout()">
        <i class="fa fa-sign-out-alt"></i> D√©connexion
      </button>
    </header>

    <main class="main-content">
      <!-- TABS NAVIGATION -->
      <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('dashboard')">üìä Tableau de bord</button>
        <button class="nav-tab" onclick="switchTab('create')">‚úèÔ∏è √âditeur</button>
        <button class="nav-tab" onclick="switchTab('history')">üìã Historique</button>
      </div>

      <!-- TAB 1: Dashboard -->
      <div id="tabDashboard" class="tab-content active">
        <div class="dashboard-header">
          <h1 class="page-title">Facturation propri√©taires</h1>
          <button class="btn btn-primary" onclick="createNewInvoice()">
            <i class="fa fa-plus"></i> Nouvelle facture
          </button>
        </div>

        <div class="stats-row">
          <div class="stat-card">
            <span class="stat-label">Total √©mis ce mois</span>
            <div class="stat-value" id="statMonthTotal">0,00 ‚Ç¨</div>
          </div>
          <div class="stat-card">
            <span class="stat-label">En attente d'encaissement</span>
            <div class="stat-value" id="statPendingTotal">0,00 ‚Ç¨</div>
          </div>
          <div class="stat-card">
            <span class="stat-label">Encaiss√© ce mois</span>
            <div class="stat-value" id="statPaidThisMonth">0,00 ‚Ç¨</div>
          </div>
        </div>
      </div>

      <!-- TAB 2: √âditeur -->
      <div id="tabCreate" class="tab-content">
        <div class="dashboard-header">
          <h1 class="page-title">√âditeur de facture</h1>
        </div>

        <div class="invoice-editor-layout">
          <!-- SIDEBAR GAUCHE -->
          <div class="editor-sidebar" id="editorSidebar">
            <!-- Banni√®re READ-ONLY (masqu√©e par d√©faut) -->
            <div id="readonlyBanner" class="readonly-banner" style="display:none;">
              ‚ö†Ô∏è Facture en lecture seule - D√©j√† √©mise
            </div>

            <div class="editor-section">
              <div class="editor-section-title">Client</div>
              <div class="form-group">
                <label>Client propri√©taire</label>
                <select id="invoiceClientId" class="form-control" onchange="updatePreview()">
                  <option value="">Choisir un client...</option>
                </select>
              </div>
              <button class="btn btn-secondary btn-xs" onclick="openClientModal()">
                <i class="fa fa-plus"></i> Nouveau client
              </button>
            </div>

            <div class="editor-section">
              <div class="editor-section-title">Dates</div>
              <div class="form-group">
                <label>Date d'√©mission</label>
                <input type="date" id="invoiceIssueDate" class="form-control" onchange="updatePreview()">
              </div>
              <div class="form-group">
                <label>Date d'√©ch√©ance</label>
                <input type="date" id="invoiceDueDate" class="form-control" onchange="updatePreview()">
              </div>
              <div class="form-group">
                <label>P√©riode : D√©but</label>
                <input type="date" id="invoicePeriodStart" class="form-control" onchange="updatePreview()">
              </div>
              <div class="form-group">
                <label>P√©riode : Fin</label>
                <input type="date" id="invoicePeriodEnd" class="form-control" onchange="updatePreview()">
              </div>
            </div>

            <div class="editor-section">
              <div class="editor-section-title">Prestations</div>
              <button class="btn btn-secondary btn-xs" onclick="addPrestation('commission')">+ Commission</button>
              <button class="btn btn-secondary btn-xs" onclick="addPrestation('cleaning')">+ M√©nage</button>
              <button class="btn btn-secondary btn-xs" onclick="addPrestation('debours')">+ D√©bours</button>
              <button class="btn btn-secondary btn-xs" onclick="addPrestation('other')">+ Autre</button>

              <div id="editorPrestationsList" style="margin-top:16px;"></div>
            </div>

            <div class="editor-section">
              <div class="editor-section-title">TVA</div>
              <label style="display:flex;align-items:center;gap:8px;font-size:13px;">
                <input type="checkbox" id="invoiceVatApplicable" onchange="updatePreview()">
                TVA applicable
              </label>
              <div class="form-group" style="margin-top:8px;">
                <label>Taux TVA (%)</label>
                <input type="number" id="invoiceVatRate" class="form-control" value="20" step="0.01" onchange="updatePreview()">
              </div>
            </div>

            <div class="editor-section" style="border-bottom:none;">
              <button class="btn btn-primary" onclick="saveInvoice(false)" style="width:100%;">
                <i class="fa fa-save"></i> Enregistrer la facture
              </button>
              <button class="btn btn-secondary" onclick="saveInvoice(true)" style="width:100%;margin-top:8px;">
                <i class="fa fa-envelope"></i> Enregistrer et envoyer par email
              </button>
            </div>
          </div>

          <!-- PREVIEW FACTURE DROITE -->
          <div class="invoice-preview-container">
            <div class="invoice-paper" id="invoicePaper">
              <div class="paper-header">
                <div>
                  <img src="/images/logo-lcc-dark.png" alt="Logo" class="paper-logo-img">
                  <p style="margin:0;font-size:12px;color:#6b7280;">
                    La Conciergerie de Charles<br>
                    123 Rue de la R√©publique<br>
                    95210 Saint-Gratien<br>
                    contact@lcc.fr
                  </p>
                </div>
                <div style="text-align:right;">
                  <h1 style="margin:0 0 8px 0;font-size:32px;font-weight:800;color:#111827;">FACTURE</h1>
                  <p style="margin:0;font-size:13px;color:#6b7280;">
                    N¬∞ <span id="previewInvoiceNumber">FACT-2024-001</span><br>
                    Date : <span id="previewIssueDate">--</span><br>
                    √âch√©ance : <span id="previewDueDate">--</span>
                  </p>
                </div>
              </div>

              <div style="margin-bottom:32px;">
                <p style="margin:0 0 4px 0;font-size:11px;font-weight:700;text-transform:uppercase;color:#9ca3af;">Factur√© √†</p>
                <p id="previewClientInfo" style="margin:0;font-size:13px;line-height:1.6;color:#4b5563;">
                  ---
                </p>
              </div>

              <p style="font-size:13px;color:#6b7280;margin:16px 0;">
                P√©riode couverte : <strong><span id="previewPeriod">--</span></strong>
              </p>

              <table class="paper-table">
                <thead>
                  <tr>
                    <th style="width:50%;">Description</th>
                    <th style="text-align:center;">Qt√©</th>
                    <th style="text-align:right;">P.U. HT</th>
                    <th style="text-align:right;">Total HT</th>
                  </tr>
                </thead>
                <tbody id="previewTableBody">
                  <tr><td colspan="4" style="text-align:center;color:#9ca3af;padding:40px 0;">Aucune prestation ajout√©e</td></tr>
                </tbody>
              </table>

              <div class="paper-totals">
                <div class="totals-box">
                  <div class="total-row">
                    <span>Total HT</span>
                    <span id="previewSubtotal">0,00 ‚Ç¨</span>
                  </div>
                  <div class="total-row" id="previewVatRow" style="display:none;">
                    <span>TVA (<span id="previewVatRateLabel">20</span>%)</span>
                    <span id="previewVat">0,00 ‚Ç¨</span>
                  </div>
                  <div class="total-row final">
                    <span>Total TTC</span>
                    <span id="previewTotal">0,00 ‚Ç¨</span>
                  </div>
                </div>
              </div>

              <div style="margin-top:64px;padding-top:24px;border-top:1px solid #e5e7eb;font-size:11px;color:#9ca3af;">
                <p style="margin:0 0 4px 0;">TVA non applicable - Article 293 B du CGI</p>
                <p style="margin:0;">En cas de retard de paiement, p√©nalit√©s de 10% du montant TTC.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB 3: Historique -->
      <div id="tabHistory" class="tab-content">
        <div class="dashboard-header">
          <h1 class="page-title">Historique des factures</h1>
        </div>

        <div style="background:white;border-radius:12px;border:1px solid #e5e7eb;overflow:hidden;">
          <table style="width:100%;border-collapse:collapse;">
            <thead>
              <tr style="background:#f9fafb;border-bottom:1px solid #e5e7eb;">
                <th style="text-align:left;padding:12px 16px;font-size:11px;font-weight:700;text-transform:uppercase;color:#6b7280;">Num√©ro</th>
                <th style="text-align:left;padding:12px 16px;font-size:11px;font-weight:700;text-transform:uppercase;color:#6b7280;">Client</th>
                <th style="text-align:left;padding:12px 16px;font-size:11px;font-weight:700;text-transform:uppercase;color:#6b7280;">P√©riode</th>
                <th style="text-align:right;padding:12px 16px;font-size:11px;font-weight:700;text-transform:uppercase;color:#6b7280;">Montant TTC</th>
                <th style="text-align:center;padding:12px 16px;font-size:11px;font-weight:700;text-transform:uppercase;color:#6b7280;">Statut</th>
                <th style="text-align:center;padding:12px 16px;font-size:11px;font-weight:700;text-transform:uppercase;color:#6b7280;">Actions</th>
              </tr>
            </thead>
            <tbody id="historyTableBody">
              <tr><td colspan="6" style="text-align:center;padding:40px;color:#9ca3af;">Aucune facture</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- MODAL CLIENT -->
<div id="clientModal" class="modal-overlay">
  <div class="modal-content">
    <h2 id="clientModalTitle" style="margin:0 0 16px 0;font-size:20px;font-weight:700;">Nouveau client</h2>

    <div style="margin-bottom:16px;">
      <label style="display:flex;align-items:center;gap:8px;font-size:13px;margin-bottom:8px;">
        <input type="radio" name="clientType" value="individual" onchange="toggleClientType()">
        Particulier
      </label>
      <label style="display:flex;align-items:center;gap:8px;font-size:13px;">
        <input type="radio" name="clientType" value="business" onchange="toggleClientType()">
        Entreprise
      </label>
    </div>

    <div id="individualFields">
      <div class="form-group">
        <label>Pr√©nom</label>
        <input type="text" id="clientFirstName" class="form-control">
      </div>
      <div class="form-group">
        <label>Nom</label>
        <input type="text" id="clientLastName" class="form-control">
      </div>
    </div>

    <div id="businessFields" style="display:none;">
      <div class="form-group">
        <label>Nom de l'entreprise</label>
        <input type="text" id="clientCompanyName" class="form-control">
      </div>
    </div>

    <div class="form-group">
      <label>Email</label>
      <input type="email" id="clientEmail" class="form-control">
    </div>
    <div class="form-group">
      <label>Adresse</label>
      <input type="text" id="clientAddress" class="form-control">
    </div>
    <div class="form-group">
      <label>Code postal</label>
      <input type="text" id="clientPostalCode" class="form-control">
    </div>
    <div class="form-group">
      <label>Ville</label>
      <input type="text" id="clientCity" class="form-control">
    </div>

    <div style="display:flex;gap:8px;margin-top:24px;">
      <button class="btn btn-primary" onclick="saveClient()">Enregistrer</button>
      <button class="btn btn-secondary" onclick="closeClientModal()">Annuler</button>
    </div>
  </div>
</div>

<script>
  const token = localStorage.getItem('lcc_token');
  if (!token) window.location.href = '/login.html';

  let prestations = [];
  let prestationCounter = 0;
  let editingInvoiceId = null;
  let editingClientId = null;
  let clients = [];
  let invoices = [];
  let isReadOnlyMode = false; // Nouveau flag pour le mode consultation

  // INIT
  (async function() {
    await loadClients();
    await loadInvoices();
    setDefaultDates();
    updatePreview();
  })();

  function setDefaultDates() {
    const today = new Date().toISOString().slice(0,10);
    document.getElementById('invoiceIssueDate').value = today;
    const due = new Date(); due.setDate(due.getDate() + 30);
    document.getElementById('invoiceDueDate').value = due.toISOString().slice(0,10);

    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), 1);
    const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    document.getElementById('invoicePeriodStart').value = start.toISOString().slice(0,10);
    document.getElementById('invoicePeriodEnd').value = end.toISOString().slice(0,10);
  }

  function switchTab(tab) {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

    if (tab === 'dashboard') {
      document.querySelectorAll('.nav-tab')[0].classList.add('active');
      document.getElementById('tabDashboard').classList.add('active');
    } else if (tab === 'create') {
      document.querySelectorAll('.nav-tab')[1].classList.add('active');
      document.getElementById('tabCreate').classList.add('active');
    } else if (tab === 'history') {
      document.querySelectorAll('.nav-tab')[2].classList.add('active');
      document.getElementById('tabHistory').classList.add('active');
    }
  }

  function createNewInvoice() {
    // R√©initialiser le mode lecture seule
    isReadOnlyMode = false;
    document.getElementById('editorSidebar').classList.remove('readonly');
    document.getElementById('readonlyBanner').style.display = 'none';
    
    editingInvoiceId = null;
    prestations = [];
    prestationCounter = 0;
    
    document.getElementById('invoiceClientId').value = '';
    setDefaultDates();
    document.getElementById('invoiceVatApplicable').checked = false;
    document.getElementById('invoiceVatRate').value = 20;
    
    renderEditorPrestations();
    updatePreview();
    switchTab('create');
  }

  async function loadClients() {
    try {
      const res = await fetch('/api/owner-clients', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (!res.ok) {
        const err = await res.json();
        console.error('Erreur chargement clients:', err);
        return;
      }
      const json = await res.json();
      clients = json.clients || [];
      
      // CORRECTION 1: Remplir le dropdown avec les clients
      const select = document.getElementById('invoiceClientId');
      select.innerHTML = '<option value="">Choisir un client...</option>';
      
      clients.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        if (c.client_type === 'business') {
          opt.textContent = c.company_name || 'Entreprise sans nom';
        } else {
          opt.textContent = `${c.first_name || ''} ${c.last_name || ''}`.trim() || 'Client sans nom';
        }
        select.appendChild(opt);
      });
      
    } catch (err) {
      console.error('Erreur:', err);
    }
  }

  async function loadInvoices() {
    try {
      const res = await fetch('/api/owner-invoices', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (!res.ok) throw new Error('Erreur chargement factures');
      
      const json = await res.json();
      invoices = json.invoices || [];
      
      renderHistoryTable();
      updateDashboardStats();
    } catch (err) {
      console.error(err);
    }
  }

  function renderHistoryTable() {
    const tbody = document.getElementById('historyTableBody');
    if (!invoices || invoices.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#9ca3af;">Aucune facture</td></tr>';
      return;
    }

    tbody.innerHTML = invoices.map(inv => {
      const client = clients.find(c => c.id === inv.client_id);
      let clientName = 'Client inconnu';
      if (client) {
        clientName = client.client_type === 'business' 
          ? (client.company_name || 'Entreprise') 
          : `${client.first_name || ''} ${client.last_name || ''}`.trim();
      }

      const period = inv.period_start && inv.period_end 
        ? `${formatDate(inv.period_start)} - ${formatDate(inv.period_end)}`
        : '--';

      const statusBadge = inv.paid 
        ? '<span style="background:#dcfce7;color:#166534;padding:4px 8px;border-radius:6px;font-size:11px;font-weight:600;">ENCAISS√â</span>'
        : '<span style="background:#fef3c7;color:#92400e;padding:4px 8px;border-radius:6px;font-size:11px;font-weight:600;">EN ATTENTE</span>';

      return `
        <tr style="border-bottom:1px solid #f3f4f6;">
          <td style="padding:16px;font-size:13px;font-weight:600;">${inv.invoice_number || '--'}</td>
          <td style="padding:16px;font-size:13px;">${clientName}</td>
          <td style="padding:16px;font-size:13px;">${period}</td>
          <td style="padding:16px;text-align:right;font-size:13px;font-weight:600;">${formatMoney(inv.total_ttc)}</td>
          <td style="padding:16px;text-align:center;">${statusBadge}</td>
          <td style="padding:16px;text-align:center;">
            <div class="invoice-row-actions">
              <button onclick="toggleInvoiceMenu(event, ${inv.id})" style="background:none;border:none;cursor:pointer;font-size:16px;color:#6b7280;">
                <i class="fa fa-ellipsis-v"></i>
              </button>
              <div id="menu-${inv.id}" class="invoice-actions-menu">
                <button onclick="viewOwnerInvoiceReadOnly(${inv.id})"><i class="fa fa-eye"></i> Voir la facture</button>
                ${!inv.paid ? `<button onclick="markAsPaid(${inv.id})"><i class="fa fa-check-circle"></i> Marquer encaiss√©</button>` : ''}
                <button onclick="downloadInvoice(${inv.id})"><i class="fa fa-download"></i> T√©l√©charger PDF</button>
              </div>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  function toggleInvoiceMenu(event, invoiceId) {
    event.stopPropagation();
    
    const menu = document.getElementById(`menu-${invoiceId}`);
    const button = event.currentTarget;
    const rect = button.getBoundingClientRect();
    
    // Fermer tous les autres menus
    document.querySelectorAll('.invoice-actions-menu').forEach(m => {
      if (m.id !== `menu-${invoiceId}`) m.classList.remove('open');
    });
    
    // Toggle ce menu
    const isOpen = menu.classList.contains('open');
    if (!isOpen) {
      menu.classList.add('open');
      menu.style.top = rect.bottom + 'px';
      menu.style.left = (rect.left - 180 + rect.width) + 'px';
    } else {
      menu.classList.remove('open');
    }
  }

  // Fermer les menus si on clique ailleurs
  document.addEventListener('click', () => {
    document.querySelectorAll('.invoice-actions-menu').forEach(m => m.classList.remove('open'));
  });

  function updateDashboardStats() {
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();

    let monthTotal = 0;
    let pendingTotal = 0;
    let paidThisMonth = 0;

    invoices.forEach(inv => {
      const issueDate = new Date(inv.issue_date);
      const isThisMonth = issueDate.getMonth() === currentMonth && issueDate.getFullYear() === currentYear;

      if (isThisMonth) {
        monthTotal += parseFloat(inv.total_ttc) || 0;
        if (inv.paid) {
          paidThisMonth += parseFloat(inv.total_ttc) || 0;
        }
      }

      if (!inv.paid) {
        pendingTotal += parseFloat(inv.total_ttc) || 0;
      }
    });

    document.getElementById('statMonthTotal').textContent = formatMoney(monthTotal);
    document.getElementById('statPendingTotal').textContent = formatMoney(pendingTotal);
    document.getElementById('statPaidThisMonth').textContent = formatMoney(paidThisMonth);
  }

  // CORRECTION 3: Marquer comme encaiss√©
  async function markAsPaid(id) {
    if (!confirm('Marquer cette facture comme encaiss√©e ?')) return;
    
    try {
      const res = await fetch(`/api/owner-invoices/${id}/mark-paid`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        }
      });
      
      if (res.ok) {
        alert('‚úÖ Facture marqu√©e comme encaiss√©e');
        await loadInvoices();
      } else {
        const err = await res.json();
        alert('Erreur : ' + (err.error || 'Erreur serveur'));
      }
    } catch (err) {
      console.error(err);
      alert('Erreur serveur');
    }
  }

  // CORRECTION 4: T√©l√©chargement direct (pas d'impression)
  async function downloadInvoice(id) {
    try {
      const res = await fetch(`/api/owner-invoices/${id}`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      
      if (!res.ok) throw new Error('Erreur chargement facture');
      
      const json = await res.json();
      const inv = json.invoice;
      
      // Charger la facture dans l'aper√ßu
      await viewOwnerInvoiceReadOnly(id);
      
      // Attendre un peu que le DOM se mette √† jour
      setTimeout(() => {
        // Utiliser html2pdf ou jsPDF pour g√©n√©rer le PDF
        // Pour l'instant, on utilise window.print() mais on pourrait am√©liorer
        const invoicePaper = document.getElementById('invoicePaper');
        const filename = `${inv.invoice_number || 'facture'}.pdf`;
        
        // Cr√©er un iframe invisible pour l'impression
        const iframe = document.createElement('iframe');
        iframe.style.position = 'fixed';
        iframe.style.right = '0';
        iframe.style.bottom = '0';
        iframe.style.width = '0';
        iframe.style.height = '0';
        iframe.style.border = 'none';
        document.body.appendChild(iframe);
        
        const iframeDoc = iframe.contentWindow.document;
        iframeDoc.open();
        iframeDoc.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <title>${filename}</title>
            <style>
              body { margin: 0; padding: 20px; font-family: 'Inter', sans-serif; }
              ${document.querySelector('style').textContent}
            </style>
          </head>
          <body>
            ${invoicePaper.outerHTML}
          </body>
          </html>
        `);
        iframeDoc.close();
        
        iframe.contentWindow.focus();
        iframe.contentWindow.print();
        
        setTimeout(() => {
          document.body.removeChild(iframe);
        }, 1000);
        
      }, 500);
      
    } catch (err) {
      console.error(err);
      alert('Erreur lors du t√©l√©chargement');
    }
  }

  function addPrestation(type) {
    if (isReadOnlyMode) return; // Emp√™cher l'ajout en mode lecture seule
    
    prestationCounter++;
    const p = {
      id: 'p' + prestationCounter,
      type,
      description: '',
      rentalAmount: 0,
      commissionRate: 0,
      quantity: 1,
      unitPrice: 0,
      isDebours: (type === 'debours')
    };
    prestations.push(p);
    renderEditorPrestations();
    updatePreview();
  }

  function removePrestation(id) {
    if (isReadOnlyMode) return; // Emp√™cher la suppression en mode lecture seule
    
    prestations = prestations.filter(p => p.id !== id);
    renderEditorPrestations();
    updatePreview();
  }

  function updatePrestationField(id, field, value) {
    if (isReadOnlyMode) return; // Emp√™cher la modification en mode lecture seule
    
    const p = prestations.find(pr => pr.id === id);
    if (!p) return;
    
    if (field === 'description') p.description = value;
    else if (field === 'rentalAmount') p.rentalAmount = parseFloat(value) || 0;
    else if (field === 'commissionRate') p.commissionRate = parseFloat(value) || 0;
    else if (field === 'quantity') p.quantity = parseFloat(value) || 0;
    else if (field === 'unitPrice') p.unitPrice = parseFloat(value) || 0;
    
    renderEditorPrestations();
    updatePreview();
  }

  function renderEditorPrestations() {
    const container = document.getElementById('editorPrestationsList');
    if (!prestations || prestations.length === 0) {
      container.innerHTML = '<p style="font-size:12px;color:#9ca3af;text-align:center;margin:16px 0;">Aucune prestation</p>';
      return;
    }

    container.innerHTML = prestations.map(p => {
      let badgeClass = 'badge-other';
      let badgeLabel = 'Autre';
      
      if (p.type === 'commission') { badgeClass = 'badge-commission'; badgeLabel = 'Commission'; }
      else if (p.type === 'cleaning') { badgeClass = 'badge-cleaning'; badgeLabel = 'M√©nage'; }
      else if (p.type === 'debours') { badgeClass = 'badge-debours'; badgeLabel = 'D√©bours'; }

      let fieldsHTML = '';
      
      if (p.type === 'commission') {
        fieldsHTML = `
          <input type="text" placeholder="Description" value="${p.description}" 
            onchange="updatePrestationField('${p.id}','description',this.value)"
            style="width:100%;margin-bottom:4px;padding:4px 6px;border:1px solid #e5e7eb;border-radius:4px;font-size:12px;" ${isReadOnlyMode ? 'disabled' : ''}>
          <input type="number" placeholder="Montant location" value="${p.rentalAmount}" 
            onchange="updatePrestationField('${p.id}','rentalAmount',this.value)"
            style="width:100%;margin-bottom:4px;padding:4px 6px;border:1px solid #e5e7eb;border-radius:4px;font-size:12px;" ${isReadOnlyMode ? 'disabled' : ''}>
          <input type="number" placeholder="Taux commission %" value="${p.commissionRate}" 
            onchange="updatePrestationField('${p.id}','commissionRate',this.value)"
            style="width:100%;padding:4px 6px;border:1px solid #e5e7eb;border-radius:4px;font-size:12px;" ${isReadOnlyMode ? 'disabled' : ''}>
        `;
      } else {
        fieldsHTML = `
          <input type="text" placeholder="Description" value="${p.description}" 
            onchange="updatePrestationField('${p.id}','description',this.value)"
            style="width:100%;margin-bottom:4px;padding:4px 6px;border:1px solid #e5e7eb;border-radius:4px;font-size:12px;" ${isReadOnlyMode ? 'disabled' : ''}>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;">
            <input type="number" placeholder="Quantit√©" value="${p.quantity}" 
              onchange="updatePrestationField('${p.id}','quantity',this.value)"
              style="padding:4px 6px;border:1px solid #e5e7eb;border-radius:4px;font-size:12px;" ${isReadOnlyMode ? 'disabled' : ''}>
            <input type="number" placeholder="Prix unitaire" value="${p.unitPrice}" 
              onchange="updatePrestationField('${p.id}','unitPrice',this.value)"
              style="padding:4px 6px;border:1px solid #e5e7eb;border-radius:4px;font-size:12px;" ${isReadOnlyMode ? 'disabled' : ''}>
          </div>
        `;
      }

      return `
        <div class="prestation-mini-card">
          ${!isReadOnlyMode ? `<button class="remove-line-btn" onclick="removePrestation('${p.id}')"><i class="fa fa-times"></i></button>` : ''}
          <span class="prestation-badge ${badgeClass}">${badgeLabel}</span>
          ${fieldsHTML}
          <div style="margin-top:4px;font-size:11px;font-weight:700;color:#111827;text-align:right;">
            ${formatMoney(calculateLineTotal(p))}
          </div>
        </div>
      `;
    }).join('');
  }

  function calculateLineTotal(p) {
    if (p.type === 'commission') {
      return (p.rentalAmount * p.commissionRate / 100);
    }
    return (p.quantity * p.unitPrice);
  }

  function updatePreview() {
    const clientId = document.getElementById('invoiceClientId').value;
    const client = clients.find(c => c.id == clientId);

    if (client) {
      let name = '';
      if (client.client_type === 'business') {
        name = client.company_name || 'Entreprise';
      } else {
        name = `${client.first_name || ''} ${client.last_name || ''}`.trim() || 'Client';
      }

      document.getElementById('previewClientInfo').innerHTML = `
        <strong>${name}</strong><br>
        ${client.address || ''}<br>
        ${client.postal_code || ''} ${client.city || ''}<br>
        ${client.email || ''}
      `;
    } else {
      document.getElementById('previewClientInfo').textContent = '---';
    }

    const issueDate = document.getElementById('invoiceIssueDate').value;
    const dueDate = document.getElementById('invoiceDueDate').value;
    const periodStart = document.getElementById('invoicePeriodStart').value;
    const periodEnd = document.getElementById('invoicePeriodEnd').value;

    document.getElementById('previewIssueDate').textContent = issueDate ? formatDate(issueDate) : '--';
    document.getElementById('previewDueDate').textContent = dueDate ? formatDate(dueDate) : '--';
    document.getElementById('previewPeriod').textContent = 
      (periodStart && periodEnd) ? `${formatDate(periodStart)} au ${formatDate(periodEnd)}` : '--';

    const tbody = document.getElementById('previewTableBody');
    if (!prestations || prestations.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#9ca3af;padding:40px 0;">Aucune prestation ajout√©e</td></tr>';
    } else {
      tbody.innerHTML = prestations.map(p => {
        const total = calculateLineTotal(p);
        let desc = p.description || 'Prestation';
        
        if (p.type === 'commission') {
          desc += ` (${p.commissionRate}% sur ${formatMoney(p.rentalAmount)})`;
        }

        return `
          <tr>
            <td>${desc}</td>
            <td style="text-align:center;">${p.quantity || 1}</td>
            <td style="text-align:right;">${formatMoney(p.type === 'commission' ? (p.rentalAmount * p.commissionRate / 100) : p.unitPrice)}</td>
            <td style="text-align:right;font-weight:600;">${formatMoney(total)}</td>
          </tr>
        `;
      }).join('');
    }

    let subtotal = 0;
    prestations.forEach(p => { subtotal += calculateLineTotal(p); });

    const vatApplicable = document.getElementById('invoiceVatApplicable').checked;
    const vatRate = parseFloat(document.getElementById('invoiceVatRate').value) || 20;
    const vatAmount = vatApplicable ? (subtotal * vatRate / 100) : 0;
    const total = subtotal + vatAmount;

    document.getElementById('previewSubtotal').textContent = formatMoney(subtotal);
    document.getElementById('previewVat').textContent = formatMoney(vatAmount);
    document.getElementById('previewVatRateLabel').textContent = vatRate.toFixed(2);
    document.getElementById('previewTotal').textContent = formatMoney(total);

    document.getElementById('previewVatRow').style.display = vatApplicable ? 'flex' : 'none';
  }

  function formatMoney(val) {
    return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(val || 0);
  }

  function formatDate(dateStr) {
    if (!dateStr) return '--';
    const d = new Date(dateStr + 'T00:00:00');
    return d.toLocaleDateString('fr-FR');
  }

  window.saveInvoice = async function(send = false) {
    if (isReadOnlyMode) {
      alert('‚ùå Cette facture est en lecture seule et ne peut pas √™tre modifi√©e');
      return;
    }
    
    const clientId = document.getElementById('invoiceClientId').value;
    if (!clientId) return alert('Veuillez s√©lectionner un client');
    if (prestations.length === 0) return alert('Ajoutez au moins une prestation');

    const data = {
      clientId: parseInt(clientId),
      issueDate: document.getElementById('invoiceIssueDate').value,
      dueDate: document.getElementById('invoiceDueDate').value,
      periodStart: document.getElementById('invoicePeriodStart').value,
      periodEnd: document.getElementById('invoicePeriodEnd').value,
      items: prestations.map(p => ({
        type: p.type,
        description: p.description,
        rentalAmount: p.rentalAmount,
        commissionRate: p.commissionRate,
        quantity: p.quantity,
        unitPrice: p.unitPrice,
        total: calculateLineTotal(p),
        isDebours: p.isDebours
      })),
      vatApplicable: document.getElementById('invoiceVatApplicable').checked,
      vatRate: parseFloat(document.getElementById('invoiceVatRate').value),
      sendEmail: send
    };

    try {
      const url = editingInvoiceId ? `/api/owner-invoices/${editingInvoiceId}` : '/api/owner-invoices';
      const method = editingInvoiceId ? 'PUT' : 'POST';
      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify(data)
      });
      if (res.ok) {
        alert('‚úÖ Facture enregistr√©e !');
        prestations = [];
        prestationCounter = 0;
        renderEditorPrestations();
        switchTab('dashboard');
        loadInvoices();
      } else {
        const err = await res.json();
        alert('Erreur : ' + err.error);
      }
    } catch (err) {
      console.error(err);
      alert('Erreur serveur');
    }
  };

  // CORRECTION 2: Mode consultation (lecture seule) au lieu de mode √©dition
  window.viewOwnerInvoiceReadOnly = async function(id) {
    try {
      const res = await fetch('/api/owner-invoices/' + id, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const json = await res.json();

      if (!res.ok) {
        console.error(json);
        return alert(json.error || 'Erreur lors du chargement de la facture');
      }

      const inv = json.invoice;
      const items = json.items || [];

      // Activer le mode lecture seule
      isReadOnlyMode = true;
      editingInvoiceId = inv.id;
      
      // Afficher la banni√®re et d√©sactiver les contr√¥les
      document.getElementById('editorSidebar').classList.add('readonly');
      document.getElementById('readonlyBanner').style.display = 'block';

      // Remplir les champs (mais ils seront disabled)
      const clientSelect = document.getElementById('invoiceClientId');
      if (clientSelect) clientSelect.value = inv.client_id;

      if (inv.issue_date) {
        document.getElementById('invoiceIssueDate').value = inv.issue_date.slice(0,10);
      }
      if (inv.due_date) {
        document.getElementById('invoiceDueDate').value = inv.due_date.slice(0,10);
      }
      if (inv.period_start) {
        document.getElementById('invoicePeriodStart').value = inv.period_start.slice(0,10);
      }
      if (inv.period_end) {
        document.getElementById('invoicePeriodEnd').value = inv.period_end.slice(0,10);
      }

      document.getElementById('invoiceVatApplicable').checked = !!inv.vat_applicable;
      document.getElementById('invoiceVatRate').value = inv.vat_rate || 20;

      // Recr√©er les prestations
      prestations = [];
      prestationCounter = 0;

      items.forEach(item => {
        prestationCounter++;
        prestations.push({
          id: 'p' + prestationCounter,
          type: item.item_type,
          description: item.description || '',
          rentalAmount: parseFloat(item.rental_amount) || 0,
          commissionRate: parseFloat(item.commission_rate) || 0,
          quantity: parseFloat(item.quantity) || 0,
          unitPrice: parseFloat(item.unit_price) || 0,
          isDebours: item.is_debours
        });
      });

      // Rafra√Æchir l'√©diteur + aper√ßu
      renderEditorPrestations();
      updatePreview();

      // Aller sur l'onglet "√âditeur" (en mode consultation)
      switchTab('create');

    } catch (err) {
      console.error(err);
      alert('Erreur serveur lors du chargement de la facture');
    }
  };

  // --- CLIENT MODAL ---
  window.openClientModal = function() {
    editingClientId = null;

    const titleEl = document.getElementById('clientModalTitle');
    if (titleEl) titleEl.textContent = 'Nouveau client';

    const radioInd = document.querySelector('input[name="clientType"][value="individual"]');
    if (radioInd) radioInd.checked = true;
    toggleClientType();

    ['clientFirstName','clientLastName','clientCompanyName','clientEmail','clientAddress','clientPostalCode','clientCity']
      .forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });

    document.getElementById('clientModal').classList.add('active');
  };
  
  window.closeClientModal = function() {
    document.getElementById('clientModal').classList.remove('active');
    editingClientId = null;
  };
  
  window.toggleClientType = function() {
    const t = document.querySelector('input[name="clientType"]:checked').value;
    document.getElementById('individualFields').style.display = t==='individual'?'block':'none';
    document.getElementById('businessFields').style.display = t==='business'?'block':'none';
  };

  window.saveClient = async function() {
    const type = document.querySelector('input[name="clientType"]:checked').value;

    const payload = {
        clientType: type,
        firstName: document.getElementById('clientFirstName').value,
        lastName: document.getElementById('clientLastName').value,
        companyName: document.getElementById('clientCompanyName').value,
        email: document.getElementById('clientEmail').value,
        address: document.getElementById('clientAddress').value,
        postalCode: document.getElementById('clientPostalCode').value,
        city: document.getElementById('clientCity').value,
        defaultCommissionRate: 20
    };

    let url = "/api/owner-clients";
    let method = "POST";

    if (editingClientId !== null) {
        url = `/api/owner-clients/${editingClientId}`;
        method = "PUT";
    }

    try {
        const res = await fetch(url, {
            method,
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify(payload)
        });

        const json = await res.json();
        if (!res.ok) return alert(json.error || "Erreur serveur");

        alert(editingClientId ? "Client mis √† jour !" : "Client ajout√© !");

        closeClientModal();
        await loadClients();
    } catch (err) {
        console.error(err);
        alert("Erreur serveur");
    }
};

  window.logout = function() {
    localStorage.removeItem('lcc_token');
    window.location.href = '/login.html';
  };
</script>

</body>
</html>
