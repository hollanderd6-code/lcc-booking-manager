<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Boostinghost – Facturation Propriétaires</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <link rel="stylesheet" href="/css/style.css">

  <style>
    /* =========================================
       STYLE SPÉCIFIQUE FACTURATION
       ========================================= */
    :root {
      --primary: #10B981;
      --bg-body: #f3f4f6;
      --paper-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    html, body { margin: 0; padding: 0; background: var(--bg-body); font-family: 'Inter', sans-serif; height: 100%; }
    
    .app-container { display: flex; min-height: 100vh; }

    /* SIDEBAR (Style restauré) */
    .sidebar {
      width: 260px;
      background: white;
      border-right: 1px solid #e5e7eb;
      position: fixed; top: 0; bottom: 0; left: 0;
      z-index: 50;
      display: flex; flex-direction: column;
      overflow-y: auto;
    }
    .sidebar-header { padding: 24px; }
    .sidebar-logo { display: flex; align-items: center; gap: 10px; text-decoration: none; color: #111827; font-weight: 800; font-size: 18px; }
    
    .nav-section-title { font-size: 11px; font-weight: 700; color: #9ca3af; text-transform: uppercase; margin: 24px 24px 8px; letter-spacing: 0.05em; }
    .nav-item {
      display: flex; align-items: center; gap: 12px;
      padding: 10px 24px;
      color: #4b5563; text-decoration: none; font-size: 14px; font-weight: 500;
      transition: all 0.2s;
    }
    .nav-item:hover { background: #f9fafb; color: #111827; }
    .nav-item.active { background: #ecfdf5; color: #10B981; border-right: 3px solid #10B981; }
    .nav-item i { width: 20px; text-align: center; }

    /* MAIN CONTENT (Ajusté) */
    .main-wrapper {
      flex: 1;
      margin-left: 260px; /* Espace pour la sidebar fixe */
      display: flex; flex-direction: column;
      min-width: 0; /* Empêche le débordement flex */
    }

    /* TOP BAR */
    .top-bar {
      background: white; height: 64px; border-bottom: 1px solid #e5e7eb;
      display: flex; align-items: center; justify-content: flex-end; padding: 0 32px;
      position: sticky; top: 0; z-index: 40;
    }

    .main-content { padding: 32px; max-width: 1600px; margin: 0 auto; width: 100%; box-sizing: border-box; }

    /* DASHBOARD WIDGETS */
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
    .page-title { font-size: 24px; font-weight: 700; color: #111827; margin: 0; }
    
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .stat-card { background: white; border-radius: 12px; padding: 24px; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .stat-label { font-size: 12px; font-weight: 600; text-transform: uppercase; color: #6b7280; margin-bottom: 8px; display: block; }
    .stat-value { font-size: 28px; font-weight: 700; color: #111827; }

    /* NAVIGATION TABS */
    .nav-tabs { display: inline-flex; background: #e5e7eb; padding: 4px; border-radius: 10px; margin-bottom: 24px; }
    .nav-tab { padding: 8px 24px; border-radius: 8px; border: none; background: transparent; font-weight: 600; color: #4b5563; cursor: pointer; font-size: 14px; }
    .nav-tab.active { background: white; color: #111827; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

    /* ÉDITEUR FACTURE (Split View) */
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .invoice-editor-layout { display: grid; grid-template-columns: 350px 1fr; gap: 32px; align-items: start; }
    
    /* Colonne Gauche */
    .editor-sidebar { background: white; padding: 24px; border-radius: 16px; border: 1px solid #e5e7eb; position: sticky; top: 88px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #374151; }
    .form-control { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
    
    /* Colonne Droite (Papier) */
    .invoice-paper {
      background: white; min-height: 1000px; padding: 64px;
      box-shadow: var(--paper-shadow); border-radius: 4px;
      position: relative; color: #1f2937;
    }
    .paper-header { display: flex; justify-content: space-between; margin-bottom: 48px; border-bottom: 2px solid #f3f4f6; padding-bottom: 24px; }
    .paper-logo { font-size: 24px; font-weight: 800; color: var(--primary); }
    .paper-table { width: 100%; border-collapse: collapse; margin-top: 32px; }
    .paper-table th { text-align: left; padding: 12px 8px; border-bottom: 2px solid #e5e7eb; font-size: 12px; text-transform: uppercase; color: #6b7280; }
    .paper-table td { padding: 16px 8px; border-bottom: 1px solid #f3f4f6; }
    
    .paper-totals { display: flex; justify-content: flex-end; margin-top: 32px; }
    .totals-box { width: 250px; }
    .total-row { display: flex; justify-content: space-between; padding: 8px 0; }
    .total-row.final { font-size: 18px; font-weight: 700; color: var(--primary); border-top: 2px solid #e5e7eb; margin-top: 8px; padding-top: 12px; }

    /* RESPONSIVE */
    @media (max-width: 1024px) {
      .sidebar { transform: translateX(-100%); transition: transform 0.3s; }
      .sidebar.active { transform: translateX(0); }
      .main-wrapper { margin-left: 0; }
      .invoice-editor-layout { grid-template-columns: 1fr; }
      .invoice-paper { padding: 32px; min-height: auto; }
      .menu-toggle { display: block; font-size: 20px; background: none; border: none; cursor: pointer; margin-right: 16px; }
    }
    @media (min-width: 1025px) { .menu-toggle { display: none; } }
  </style>
</head>
<body>

<div class="app-container">
  
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <a href="/" class="sidebar-logo">
        <div style="width:32px; height:32px; background:#10B981; border-radius:6px; display:flex; align-items:center; justify-content:center; color:white;"><i class="fas fa-bolt"></i></div>
        <span>Boostinghost</span>
      </a>
    </div>
    
    <nav class="sidebar-nav">
      <div class="nav-section-title">Principal</div>
      <a href="/app.html" class="nav-item"><i class="fas fa-th-large"></i> Dashboard</a>
      <a href="/app.html#calendarSection" class="nav-item"><i class="fas fa-calendar-alt"></i> Calendrier</a>
      <a href="/messages.html" class="nav-item"><i class="fas fa-comment-dots"></i> Messages</a>

      <div class="nav-section-title">Gestion</div>
      <a href="/settings.html" class="nav-item"><i class="fas fa-home"></i> Mes logements</a>
      <a href="/welcome.html" class="nav-item"><i class="fas fa-book-open"></i> Livret d'accueil</a>
      <a href="/cleaning.html" class="nav-item"><i class="fas fa-broom"></i> Gestion du ménage</a>

      <div class="nav-section-title">Facturation</div>
      <a href="/factures.html" class="nav-item"><i class="fas fa-file-invoice"></i> Factures clients</a>
      <a href="/factures-proprietaires.html" class="nav-item active"><i class="fas fa-file-invoice-dollar"></i> Factures propriétaires</a>

      <div class="nav-section-title">Autres</div>
      <a href="/deposits.html" class="nav-item"><i class="fas fa-shield-alt"></i> Cautions</a>
      <a href="/notifications.html" class="nav-item"><i class="fas fa-bell"></i> Notifications</a>
      
      <div class="nav-section-title">Paramètres</div>
      <a href="/settings-account.html" class="nav-item"><i class="fas fa-cog"></i> Paramètres</a>
      <a href="#" class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Déconnexion</a>
    </nav>
  </aside>

  <div class="main-wrapper">
    <header class="top-bar">
      <button class="menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('active')">
        <i class="fas fa-bars"></i>
      </button>
      <div style="display:flex; align-items:center; gap:12px;">
        <div style="text-align:right;">
          <div style="font-weight:600; font-size:14px;" id="userName">Mon Compte</div>
          <div style="font-size:11px; color:#6b7280;">Propriétaire</div>
        </div>
        <div style="width:36px; height:36px; background:#e5e7eb; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; color:#374151;">U</div>
      </div>
    </header>

    <main class="main-content">
      
      <div class="dashboard-header">
        <div>
          <h1 class="page-title">Facturation Propriétaires</h1>
          <p class="page-subtitle">Gérez vos revenus et générez vos factures en quelques clics.</p>
        </div>
        <button class="btn btn-primary" onclick="switchTab('create')" style="background:#10B981; color:white; padding:10px 20px; border:none; border-radius:8px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:8px;">
          <i class="fas fa-plus"></i> Nouvelle Facture
        </button>
      </div>

      <div class="stats-row">
        <div class="stat-card">
          <span class="stat-label">Chiffre d'Affaires (Mois)</span>
          <span class="stat-value" id="statsRevenue">0,00 €</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">En attente de paiement</span>
          <span class="stat-value" style="color:#f59e0b;" id="statsPending">0,00 €</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Clients Actifs</span>
          <span class="stat-value" id="statsClients">0</span>
        </div>
      </div>

      <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('dashboard')" id="btn-dashboard">Historique</button>
        <button class="nav-tab" onclick="switchTab('create')" id="btn-create">Éditeur</button>
        <button class="nav-tab" onclick="switchTab('clients')" id="btn-clients">Mes Clients</button>
      </div>

      <div id="tab-dashboard" class="tab-content active">
        <div style="background:white; border-radius:12px; border:1px solid #e5e7eb; overflow:hidden;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="background:#f9fafb; text-align:left; font-size:12px; text-transform:uppercase; color:#6b7280;">
                <th style="padding:16px;">N° Facture</th>
                <th style="padding:16px;">Client</th>
                <th style="padding:16px;">Date</th>
                <th style="padding:16px;">Montant</th>
                <th style="padding:16px;">Statut</th>
                <th style="padding:16px; text-align:right;">Actions</th>
              </tr>
            </thead>
            <tbody id="invoicesTableBody">
              <tr><td colspan="6" style="padding:40px; text-align:center; color:#9ca3af;">Chargement...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="tab-create" class="tab-content">
        <div class="invoice-editor-layout">
          
          <div class="editor-sidebar">
            <h3 style="margin-top:0; font-size:16px; margin-bottom:20px;">Paramètres</h3>
            
            <div class="form-group">
              <label>Client</label>
              <select class="form-control" id="editorClientSelect" onchange="updatePreview()">
                <option value="">Sélectionner...</option>
              </select>
            </div>

            <div class="form-group">
              <label>Date d'émission</label>
              <input type="date" class="form-control" id="editorDate" onchange="updatePreview()">
            </div>

            <div class="form-group">
              <label>Échéance</label>
              <input type="date" class="form-control" id="editorDue" onchange="updatePreview()">
            </div>

            <hr style="border:none; border-top:1px solid #e5e7eb; margin:24px 0;">

            <div id="editorLines"></div>
            
            <button onclick="addLine()" style="width:100%; padding:8px; border:1px dashed #d1d5db; background:white; color:#6b7280; border-radius:8px; cursor:pointer; margin-top:10px;">
              + Ajouter une ligne
            </button>

            <div style="margin-top:24px; display:flex; gap:10px;">
              <input type="checkbox" id="editorVat" checked onchange="updatePreview()">
              <label for="editorVat" style="margin:0; cursor:pointer;">Appliquer TVA (20%)</label>
            </div>

            <button onclick="saveInvoice()" style="width:100%; margin-top:32px; padding:14px; background:#10B981; color:white; border:none; border-radius:10px; font-weight:700; cursor:pointer;">
              Valider la facture
            </button>
          </div>

          <div class="invoice-preview-container">
            <div class="invoice-paper">
              <div class="paper-header">
                <div class="paper-logo">Boostinghost</div>
                <div style="text-align:right;">
                  <h1 style="margin:0; font-size:32px;">FACTURE</h1>
                  <div style="color:#6b7280; margin-top:4px;">N° BROUILLON</div>
                </div>
              </div>

              <div style="display:flex; justify-content:space-between; gap:40px; margin-bottom:40px;">
                <div>
                  <div style="font-size:11px; font-weight:700; color:#9ca3af; text-transform:uppercase; margin-bottom:8px;">Émetteur</div>
                  <div style="font-size:14px; line-height:1.5;">
                    <strong>Votre Entreprise</strong><br>
                    123 Rue de la Paix<br>75000 Paris
                  </div>
                </div>
                <div style="text-align:right;">
                  <div style="font-size:11px; font-weight:700; color:#9ca3af; text-transform:uppercase; margin-bottom:8px;">Adressé à</div>
                  <div style="font-size:14px; line-height:1.5;" id="previewClientAddress">
                    Sélectionnez un client...
                  </div>
                </div>
              </div>

              <div style="display:flex; gap:32px; margin-bottom:32px; padding-bottom:16px; border-bottom:1px solid #f3f4f6;">
                <div><span style="color:#6b7280; font-size:12px;">Date :</span> <strong style="font-size:14px;" id="previewDate">-</strong></div>
                <div><span style="color:#6b7280; font-size:12px;">Échéance :</span> <strong style="font-size:14px;" id="previewDue">-</strong></div>
              </div>

              <table class="paper-table">
                <thead>
                  <tr>
                    <th>Description</th>
                    <th style="width:60px; text-align:center;">Qté</th>
                    <th style="width:100px; text-align:right;">Prix Unit.</th>
                    <th style="width:100px; text-align:right;">Total HT</th>
                  </tr>
                </thead>
                <tbody id="previewBody"></tbody>
              </table>

              <div class="paper-totals">
                <div class="totals-box">
                  <div class="total-row"><span>Total HT</span><span id="previewHT">0,00 €</span></div>
                  <div class="total-row"><span>TVA (20%)</span><span id="previewTVA">0,00 €</span></div>
                  <div class="total-row final"><span>Net à payer</span><span id="previewTTC">0,00 €</span></div>
                </div>
              </div>
              
              <div style="position:absolute; bottom:40px; left:40px; right:40px; text-align:center; font-size:11px; color:#9ca3af; border-top:1px solid #f3f4f6; padding-top:16px;">
                Document généré automatiquement par Boostinghost
              </div>
            </div>
          </div>

        </div>
      </div>

      <div id="tab-clients" class="tab-content">
        <div style="background:white; padding:40px; text-align:center; border-radius:12px; border:1px solid #e5e7eb;">
          <h3 style="margin-top:0;">Gestion des Clients</h3>
          <p style="color:#6b7280;">Gérez ici les coordonnées de vos propriétaires.</p>
          <div id="clientsList"></div>
        </div>
      </div>

    </main>
  </div>
</div>

<script>
  // --- VARIABLES GLOBALES ---
  let clients = [];
  let invoices = [];
  let lines = [{ desc: "Commission sur loyers", qty: 1, price: 0 }];

  // --- NAVIGATION ---
  window.switchTab = function(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-'+tabId).classList.add('active');
    document.getElementById('btn-'+tabId).classList.add('active');
  };

  // --- INIT ---
  document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('lcc_token');
    if(!token) return window.location.href='/login.html';

    // Remplir User Info
    const user = JSON.parse(localStorage.getItem('lcc_user') || '{}');
    if(user.firstName) document.getElementById('userName').textContent = user.firstName;

    // Dates par défaut
    document.getElementById('editorDate').valueAsDate = new Date();
    const d = new Date(); d.setDate(d.getDate()+30);
    document.getElementById('editorDue').valueAsDate = d;

    // Charger Données API
    try {
      const [resC, resI] = await Promise.all([
        fetch('/api/owner-clients', { headers: { Authorization: 'Bearer '+token }}),
        fetch('/api/owner-invoices', { headers: { Authorization: 'Bearer '+token }})
      ]);
      const dataC = await resC.json();
      const dataI = await resI.json();
      
      clients = dataC.clients || [];
      invoices = dataI.invoices || [];

      renderClientsSelect();
      renderInvoicesTable();
      renderEditorLines();
      updatePreview();
      updateStats();

    } catch(e) { console.error(e); }
  });

  // --- FONCTIONS RENDU ---
  function renderClientsSelect() {
    const sel = document.getElementById('editorClientSelect');
    sel.innerHTML = '<option value="">Sélectionner...</option>';
    clients.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = c.company_name || (c.first_name + ' ' + c.last_name);
      opt.dataset.addr = (c.address || '') + ' ' + (c.city || '');
      sel.appendChild(opt);
    });
    // Stats
    document.getElementById('statsClients').textContent = clients.length;
  }

  function renderInvoicesTable() {
    const tbody = document.getElementById('invoicesTableBody');
    if(!invoices.length) {
      tbody.innerHTML = '<tr><td colspan="6" style="padding:40px; text-align:center; color:#9ca3af;">Aucune facture pour le moment.</td></tr>';
      return;
    }
    tbody.innerHTML = invoices.map(inv => `
      <tr style="border-bottom:1px solid #f3f4f6;">
        <td style="padding:16px; font-weight:700; color:#10B981;">${inv.invoice_number}</td>
        <td style="padding:16px;">${inv.client_name}</td>
        <td style="padding:16px;">${new Date(inv.issue_date).toLocaleDateString()}</td>
        <td style="padding:16px; font-weight:600;">${parseFloat(inv.total_ttc).toFixed(2)} €</td>
        <td style="padding:16px;"><span style="padding:4px 8px; background:#fffbeb; color:#d97706; border-radius:6px; font-size:12px; font-weight:600;">${inv.status}</span></td>
        <td style="padding:16px; text-align:right;"><button style="border:none; background:none; cursor:pointer; color:#6b7280;"><i class="fas fa-ellipsis-v"></i></button></td>
      </tr>
    `).join('');
  }

  function updateStats() {
    const total = invoices.reduce((acc, curr) => acc + parseFloat(curr.total_ttc), 0);
    document.getElementById('statsRevenue').textContent = total.toFixed(2) + ' €';
  }

  // --- LOGIQUE ÉDITEUR ---
  window.addLine = function() {
    lines.push({ desc:"", qty:1, price:0 });
    renderEditorLines();
    updatePreview();
  };

  window.removeLine = function(i) {
    lines.splice(i, 1);
    renderEditorLines();
    updatePreview();
  };

  window.updateLine = function(i, key, val) {
    lines[i][key] = key==='desc' ? val : parseFloat(val);
    updatePreview();
  };

  function renderEditorLines() {
    const cont = document.getElementById('editorLines');
    cont.innerHTML = lines.map((l, i) => `
      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <input type="text" class="form-control" value="${l.desc}" placeholder="Description" oninput="updateLine(${i},'desc',this.value)" style="flex:2;">
        <input type="number" class="form-control" value="${l.qty}" style="width:60px; text-align:center;" oninput="updateLine(${i},'qty',this.value)">
        <input type="number" class="form-control" value="${l.price}" style="width:80px; text-align:right;" oninput="updateLine(${i},'price',this.value)">
        <button onclick="removeLine(${i})" style="border:none; background:none; color:#ef4444; cursor:pointer;"><i class="fas fa-times"></i></button>
      </div>
    `).join('');
  }

  window.updatePreview = function() {
    // Client
    const sel = document.getElementById('editorClientSelect');
    if(sel.selectedIndex > 0) {
      const opt = sel.options[sel.selectedIndex];
      document.getElementById('previewClientAddress').innerHTML = `<strong>${opt.text}</strong><br>${opt.dataset.addr}`;
    }

    // Dates
    const d = document.getElementById('editorDate').valueAsDate;
    if(d) document.getElementById('previewDate').textContent = d.toLocaleDateString();
    
    const due = document.getElementById('editorDue').valueAsDate;
    if(due) document.getElementById('previewDue').textContent = due.toLocaleDateString();

    // Tableau
    const tbody = document.getElementById('previewBody');
    tbody.innerHTML = '';
    let ht = 0;
    
    lines.forEach(l => {
      const tot = l.qty * l.price;
      ht += tot;
      tbody.innerHTML += `
        <tr>
          <td>${l.desc || 'Ligne'}</td>
          <td style="text-align:center;">${l.qty}</td>
          <td style="text-align:right;">${l.price.toFixed(2)}</td>
          <td style="text-align:right; font-weight:600;">${tot.toFixed(2)} €</td>
        </tr>
      `;
    });

    const vat = document.getElementById('editorVat').checked ? ht * 0.2 : 0;
    document.getElementById('previewHT').textContent = ht.toFixed(2) + ' €';
    document.getElementById('previewTVA').textContent = vat.toFixed(2) + ' €';
    document.getElementById('previewTTC').textContent = (ht+vat).toFixed(2) + ' €';
  };

  window.saveInvoice = async function() {
    const cliId = document.getElementById('editorClientSelect').value;
    if(!cliId) return alert('Veuillez sélectionner un client');
    
    const payload = {
      clientId: parseInt(cliId),
      issueDate: document.getElementById('editorDate').value,
      dueDate: document.getElementById('editorDue').value,
      items: lines.map(l => ({ description: l.desc, quantity: l.qty, unitPrice: l.price })),
      vatApplicable: document.getElementById('editorVat').checked
    };

    try {
      const res = await fetch('/api/owner-invoices', {
        method:'POST',
        headers: { 'Content-Type':'application/json', Authorization:'Bearer '+localStorage.getItem('lcc_token')},
        body: JSON.stringify(payload)
      });
      if(res.ok) { alert('✅ Facture créée !'); location.reload(); }
      else alert('Erreur création');
    } catch(e) { alert('Erreur connexion'); }
  };

  window.logout = function() {
    localStorage.removeItem('lcc_token');
    window.location.href = '/login.html';
  };
</script>

</body>
</html>
