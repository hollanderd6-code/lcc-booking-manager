<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Boostinghost – Facturation</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="/css/style.css">

  <style>
    /* DESIGN SYSTEM "FACTURE PRO" */
    :root { --primary: #10B981; --primary-dark: #059669; --bg-body: #f3f4f6; --paper-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }

    html, body { margin: 0; padding: 0; background: var(--bg-body); font-family: 'Inter', sans-serif; height: 100%; overflow-x: hidden; }
    .app-container { display: flex; min-height: 100vh; }
    
    /* SIDEBAR */
    .sidebar { width: 260px; background: white; border-right: 1px solid #e5e7eb; position: fixed; top: 0; bottom: 0; left: 0; z-index: 50; display: flex; flex-direction: column; }
    .sidebar-header { padding: 24px; }
    .sidebar-logo { display: flex; align-items: center; gap: 10px; text-decoration: none; color: #111827; font-weight: 800; font-size: 18px; }
    .nav-section-title { font-size: 11px; font-weight: 700; color: #9ca3af; text-transform: uppercase; margin: 24px 24px 8px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 24px; color: #4b5563; text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s; border-right: 3px solid transparent; }
    .nav-item:hover { background: #f9fafb; color: #111827; }
    .nav-item.active { background: #ecfdf5; color: #10B981; border-right-color: #10B981; }
    .nav-item i { width: 20px; text-align: center; }

    /* CONTENT */
    .main-wrapper { flex: 1; margin-left: 260px; display: flex; flex-direction: column; min-width: 0; }
    .top-bar { background: white; height: 64px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: flex-end; padding: 0 32px; position: sticky; top: 0; z-index: 40; }
    .main-content { padding: 32px; max-width: 1600px; margin: 0 auto; width: 100%; box-sizing: border-box; }

    /* DASHBOARD */
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
    .page-title { font-size: 24px; font-weight: 700; color: #111827; margin: 0; }
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .stat-card { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .stat-label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #6b7280; margin-bottom: 8px; display: block; }
    .stat-value { font-size: 24px; font-weight: 700; color: #111827; }

    /* TABS */
    .nav-tabs { display: inline-flex; background: #e5e7eb; padding: 4px; border-radius: 10px; margin-bottom: 24px; }
    .nav-tab { padding: 8px 24px; border-radius: 8px; border: none; background: transparent; font-weight: 600; color: #4b5563; cursor: pointer; font-size: 14px; transition: all 0.2s; }
    .nav-tab.active { background: white; color: #111827; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }

    /* ÉDITEUR FACTURE (Split View) */
    .invoice-editor-layout { display: grid; grid-template-columns: 400px 1fr; gap: 32px; align-items: start; }
    
    /* GAUCHE : Contrôles */
    .editor-sidebar { background: white; border-radius: 16px; border: 1px solid #e5e7eb; position: sticky; top: 88px; max-height: calc(100vh - 120px); overflow-y: auto; display: flex; flex-direction: column; }
    .editor-section { padding: 20px; border-bottom: 1px solid #f3f4f6; }
    .editor-section-title { font-size: 12px; font-weight: 700; text-transform: uppercase; color: #9ca3af; margin-bottom: 12px; }
    
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; color: #374151; }
    .form-control { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px; box-sizing: border-box; }
    .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(16,185,129,0.1); }
    
    /* DROITE : Feuille A4 */
    .invoice-preview-container { display: flex; justify-content: center; padding-bottom: 40px; }
    .invoice-paper { background: white; width: 100%; max-width: 800px; min-height: 1000px; padding: 48px; box-shadow: var(--paper-shadow); border-radius: 2px; position: relative; color: #1f2937; }
    .paper-header { display: flex; justify-content: space-between; margin-bottom: 40px; }
    .paper-logo-img { max-height: 60px; max-width: 180px; object-fit: contain; display: block; margin-bottom: 8px; }
    
    .paper-table { width: 100%; border-collapse: collapse; margin-top: 32px; }
    .paper-table th { text-align: left; padding: 12px 8px; border-bottom: 2px solid #e5e7eb; font-size: 11px; text-transform: uppercase; color: #6b7280; font-weight: 600; }
    .paper-table td { padding: 16px 8px; border-bottom: 1px solid #f3f4f6; font-size: 13px; vertical-align: top; }
    .paper-totals { display: flex; justify-content: flex-end; margin-top: 32px; }
    .totals-box { width: 260px; }
    .total-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; color: #4b5563; }
    .total-row.final { font-size: 16px; font-weight: 700; color: var(--primary); border-top: 2px solid #e5e7eb; margin-top: 8px; padding-top: 12px; }

    /* PRESTATIONS MINI-CARDS (Style Éditeur) */
    .prestation-mini-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 8px; position: relative; }
    .prestation-mini-card:hover { border-color: #d1d5db; background: white; }
    .prestation-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; }
    .badge-commission { background: #dcfce7; color: #166534; }
    .badge-cleaning { background: #dbeafe; color: #1e40af; }
    .badge-debours { background: #fef3c7; color: #92400e; }
    .badge-other { background: #f3f4f6; color: #374151; }
    .remove-line-btn { position: absolute; top: 8px; right: 8px; color: #ef4444; background: none; border: none; cursor: pointer; opacity: 0.5; }
    .remove-line-btn:hover { opacity: 1; }

    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; text-decoration: none; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: white; border: 1px solid #d1d5db; color: #374151; }
    .btn-xs { padding: 4px 8px; font-size: 11px; }

    /* MODALS */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: white; border-radius: 16px; width: 90%; max-width: 500px; padding: 24px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; }

    @media (max-width: 1024px) {
      .sidebar { transform: translateX(-100%); } .sidebar.active { transform: translateX(0); }
      .main-wrapper { margin-left: 0; } .invoice-editor-layout { grid-template-columns: 1fr; }
      .menu-toggle { display: block; font-size: 20px; background: none; border: none; cursor: pointer; margin-right: 16px; }
    }
    @media (min-width: 1025px) { .menu-toggle { display: none; } }
  </style>
</head>
<body>

<div class="app-container">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <a href="/" class="sidebar-logo">
        <div style="width:32px; height:32px; background:#10B981; border-radius:6px; display:flex; align-items:center; justify-content:center; color:white;"><i class="fas fa-bolt"></i></div>
        <span>Boostinghost</span>
      </a>
    </div>
    <nav class="sidebar-nav" style="flex:1; overflow-y:auto;">
      <div class="nav-section-title">Principal</div>
      <a href="/app.html" class="nav-item"><i class="fas fa-th-large"></i> Dashboard</a>
      <a href="/app.html#calendarSection" class="nav-item"><i class="fas fa-calendar-alt"></i> Calendrier</a>
      <a href="/messages.html" class="nav-item"><i class="fas fa-comment-dots"></i> Messages</a>

      <div class="nav-section-title">Gestion</div>
      <a href="/settings.html" class="nav-item"><i class="fas fa-home"></i> Mes logements</a>
      <a href="/welcome.html" class="nav-item"><i class="fas fa-book-open"></i> Livret d'accueil</a>
      <a href="/cleaning.html" class="nav-item"><i class="fas fa-broom"></i> Gestion du ménage</a>

      <div class="nav-section-title">Facturation</div>
      <a href="/factures.html" class="nav-item"><i class="fas fa-file-invoice"></i> Factures clients</a>
      <a href="/factures-proprietaires.html" class="nav-item active"><i class="fas fa-file-invoice-dollar"></i> Factures propriétaires</a>

      <div class="nav-section-title">Autres</div>
      <a href="/deposits.html" class="nav-item"><i class="fas fa-shield-alt"></i> Cautions</a>
      <a href="/notifications.html" class="nav-item"><i class="fas fa-bell"></i> Notifications</a>

      <div class="nav-section-title">Paramètres</div>
      <a href="/settings-account.html" class="nav-item"><i class="fas fa-cog"></i> Paramètres</a>
      <a href="#" class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Déconnexion</a>
    </nav>
  </aside>

  <div class="main-wrapper">
    <header class="top-bar">
      <button class="menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('active')"><i class="fas fa-bars"></i></button>
      <div style="display:flex; align-items:center; gap:12px;">
        <div style="text-align:right;">
          <div style="font-weight:600; font-size:14px;" id="userName">Mon Compte</div>
          <div style="font-size:11px; color:#6b7280;">Propriétaire</div>
        </div>
        <div style="width:36px; height:36px; background:#e5e7eb; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; color:#374151;">U</div>
      </div>
    </header>

    <main class="main-content">
      <div class="dashboard-header">
        <div><h1 class="page-title">Facturation Propriétaires</h1><p class="page-subtitle" style="color:#6b7280; font-size:14px; margin-top:4px;">Gérez vos revenus et commissions.</p></div>
        <button class="btn btn-primary" onclick="switchTab('create')"><i class="fas fa-plus"></i> Nouvelle Facture</button>
      </div>

      <div class="stats-row">
        <div class="stat-card">
          <span class="stat-label">Total Facturé (Mois)</span>
          <span class="stat-value" id="statsRevenue">0,00 €</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">En attente</span>
          <span class="stat-value" style="color:#f59e0b;" id="statsPending">0,00 €</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Clients Propriétaires</span>
          <span class="stat-value" id="statsClients">0</span>
        </div>
      </div>

      <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('dashboard')" id="btn-dashboard">Historique</button>
        <button class="nav-tab" onclick="switchTab('create')" id="btn-create">Éditeur</button>
        <button class="nav-tab" onclick="switchTab('clients')" id="btn-clients">Mes Clients</button>
      </div>

      <div id="tab-dashboard" class="tab-content active">
        <div style="background:white; border-radius:12px; border:1px solid #e5e7eb; overflow:hidden;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="background:#f9fafb; text-align:left; font-size:12px; text-transform:uppercase; color:#6b7280;">
                <th style="padding:16px;">N°</th><th style="padding:16px;">Client</th><th style="padding:16px;">Date</th>
                <th style="padding:16px;">Montant TTC</th><th style="padding:16px;">Statut</th><th style="padding:16px;">Actions</th>
              </tr>
            </thead>
            <tbody id="invoicesTableBody"><tr><td colspan="6" style="padding:40px; text-align:center;">Chargement...</td></tr></tbody>
          </table>
        </div>
      </div>

      <div id="tab-create" class="tab-content">
        <div class="invoice-editor-layout">
          <div class="editor-sidebar">
            <div class="editor-section">
              <div class="editor-section-title">Informations Facture</div>
              <div class="form-group">
                <label>Client</label>
                <select class="form-control" id="invoiceClientId" onchange="loadClientDefaults(); updatePreview();">
                  <option value="">Sélectionner...</option>
                </select>
              </div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div class="form-group"><label>Émission</label><input type="date" class="form-control" id="invoiceIssueDate" onchange="updatePreview()"></div>
                <div class="form-group"><label>Échéance</label><input type="date" class="form-control" id="invoiceDueDate" onchange="updatePreview()"></div>
              </div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div class="form-group"><label>Période Du</label><input type="date" class="form-control" id="invoicePeriodStart" onchange="updatePreview()"></div>
                <div class="form-group"><label>Au</label><input type="date" class="form-control" id="invoicePeriodEnd" onchange="updatePreview()"></div>
              </div>
            </div>

            <div class="editor-section">
                            <div class="editor-section-title">Profil émetteur</div>

              <div class="form-group">
                <label>Nom de l'entreprise</label>
                <input type="text" id="emitterCompany" class="form-control" placeholder="La conciergerie de Charles" oninput="updateEmitterProfile()">
              </div>

              <div class="form-group">
                <label>Adresse</label>
                <input type="text" id="emitterAddress" class="form-control" placeholder="25 boulevard de la République" oninput="updateEmitterProfile()">
              </div>

              <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div class="form-group">
                  <label>Code postal</label>
                  <input type="text" id="emitterPostalCode" class="form-control" placeholder="95210" oninput="updateEmitterProfile()">
                </div>
                <div class="form-group">
                  <label>Ville</label>
                  <input type="text" id="emitterCity" class="form-control" placeholder="Saint-Gratien" oninput="updateEmitterProfile()">
                </div>
              </div>

              <div class="form-group">
                <label>SIRET</label>
                <input type="text" id="emitterSiret" class="form-control" placeholder="534 392 600" oninput="updateEmitterProfile()">
              </div>

              <div class="form-group">
                <label>Logo entreprise (optionnel)</label>
                <input type="file" id="logoInput" accept="image/*" class="form-control" onchange="updateLogoPreview()">
              </div>

              <div class="form-group">
                <label>Adresse affichée sur la facture</label>
                <textarea id="senderAddressInput" rows="2" class="form-control" placeholder="Votre adresse..." oninput="updatePreview()"></textarea>
                <div style="font-size:11px; color:#6b7280; margin-top:4px;">
                  Elle est pré-remplie automatiquement avec les champs ci-dessus, mais vous pouvez la modifier pour une facture précise.
                </div>
              </div>
            </div>
<div class="editor-section">
              <div class="editor-section-title">Prestations</div>
              <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:4px; margin-bottom:12px;">
                <button class="btn-xs btn-secondary" onclick="addPrestation('commission')">% Com</button>
                <button class="btn-xs btn-secondary" onclick="addPrestation('cleaning')">Ménage</button>
                <button class="btn-xs btn-secondary" onclick="addPrestation('debours')">Débours</button>
                <button class="btn-xs btn-secondary" onclick="addPrestation('other')">Autre</button>
              </div>
              <div id="prestationsListEditor"></div>
            </div>

            <div class="editor-section">
              <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                  <input type="checkbox" id="invoiceVatApplicable" onchange="toggleVat(); updatePreview();"> TVA (20%)
                </label>
                <input type="number" id="invoiceVatRate" value="20" style="width:50px; display:none;" onchange="updatePreview()">
              </div>
              <div style="background:#f9fafb; padding:12px; border-radius:8px; font-size:13px;">
                <div style="display:flex; justify-content:space-between;"><span>Total HT</span><strong id="displayTotalHT">0.00 €</strong></div>
                <div style="display:flex; justify-content:space-between; margin-top:4px;"><span>TVA</span><strong id="displayTotalVAT">0.00 €</strong></div>
                <div style="display:flex; justify-content:space-between; margin-top:8px; padding-top:8px; border-top:1px solid #e5e7eb; color:var(--primary); font-size:15px;"><span>NET À PAYER</span><strong id="displayTotalTTC">0.00 €</strong></div>
              </div>
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
                <button class="btn btn-secondary" onclick="createInvoice(false)">Brouillon</button>
                <button class="btn btn-primary" onclick="createInvoice(true)">Envoyer</button>
              </div>
            </div>
          </div>

          <div class="invoice-preview-container">
            <div class="invoice-paper">
              <div class="paper-header">
                <div>
                  <div id="paperLogoContainer"></div>
                  <div id="paperSenderInfo" style="margin-top:10px;">
                    <strong style="font-size:16px; color:#111827;" id="previewSenderName">Votre Entreprise</strong>
                    <div class="paper-sender-address" id="previewSenderAddress">Adresse...</div>
                  </div>
                </div>
                <div class="paper-meta">
                  <div class="paper-title" style="margin:0; font-size:32px; font-weight:800;">FACTURE</div>
                  <div class="paper-number" style="color:#6b7280;">N° BROUILLON</div>
                  <div style="margin-top:8px; font-size:12px; color:#4b5563;">Date : <span id="previewDate">-</span></div>
                </div>
              </div>

              <div class="paper-client" style="margin-bottom:40px; padding:20px; background:#f9fafb; border-radius:8px;">
                <div style="font-size:11px; font-weight:700; color:#9ca3af; text-transform:uppercase;">Facturé à</div>
                <div style="font-weight:700; font-size:16px; margin-top:4px;" id="previewClientName">Sélectionnez un client...</div>
                <div style="font-size:13px; color:#4b5563;" id="previewClientDetails"></div>
              </div>

              <div style="font-size:12px; color:#6b7280; margin-bottom:10px;">Période : <span id="previewPeriod">-</span></div>

              <table class="paper-table">
                <thead><tr><th>Description</th><th style="width:80px; text-align:center;">Base/Qté</th><th style="width:80px; text-align:right;">Prix/%</th><th style="width:100px; text-align:right;">Total HT</th></tr></thead>
                <tbody id="previewBody"></tbody>
              </table>

              <div class="paper-totals">
                <div class="totals-box">
                  <div class="total-row"><span>Total HT</span><span id="previewTotalHT">0,00 €</span></div>
                  <div class="total-row"><span>TVA</span><span id="previewTotalVAT">0,00 €</span></div>
                  <div class="total-row final"><span>Net à payer</span><span id="previewTotalTTC">0,00 €</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="tab-clients" class="tab-content">
        <div style="background:white; border-radius:12px; border:1px solid #e5e7eb; padding:24px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0;">Liste des propriétaires</h3>
            <button class="btn btn-primary" onclick="openClientModal()">+ Nouveau Client</button>
          </div>
          <div id="clientsContainer" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:16px;"></div>
        </div>
      </div>

    </main>
  </div>
</div>

<div class="modal-overlay" id="clientModal">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
      <h3 style="margin:0;">Nouveau Client</h3>
      <button onclick="closeClientModal()" style="border:none; background:none; font-size:20px; cursor:pointer;">&times;</button>
    </div>
    
    <div style="display:flex; gap:16px; margin-bottom:16px;">
      <label><input type="radio" name="clientType" value="individual" checked onchange="toggleClientType()"> Particulier</label>
      <label><input type="radio" name="clientType" value="business" onchange="toggleClientType()"> Entreprise</label>
    </div>

    <div id="individualFields">
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
        <div><label style="font-size:12px;">Prénom</label><input type="text" id="clientFirstName" class="form-control"></div>
        <div><label style="font-size:12px;">Nom</label><input type="text" id="clientLastName" class="form-control"></div>
      </div>
    </div>
    <div id="businessFields" style="display:none; margin-bottom:12px;">
      <div><label style="font-size:12px;">Société</label><input type="text" id="clientCompanyName" class="form-control"></div>
    </div>

    <div class="form-group"><label>Email</label><input type="email" id="clientEmail" class="form-control"></div>
    <div class="form-group"><label>Adresse</label><input type="text" id="clientAddress" class="form-control"></div>
    <div style="display:grid; grid-template-columns:1fr 2fr; gap:12px; margin-bottom:12px;">
      <div><label style="font-size:12px;">CP</label><input type="text" id="clientPostalCode" class="form-control"></div>
      <div><label style="font-size:12px;">Ville</label><input type="text" id="clientCity" class="form-control"></div>
    </div>
    
    <button onclick="saveClient()" class="btn btn-primary" style="width:100%;">Enregistrer</button>
  </div>
</div>


<script>
  let token = localStorage.getItem('lcc_token');
  let clients = [];
  let prestations = [];
  let prestationCounter = 0;
  let editingInvoiceId = null;
  let emitterProfile = {
    company: '',
    address: '',
    postalCode: '',
    city: '',
    siret: '',
    logoDataUrl: ''
  };
  let currentUser = null;


  // --- INIT ---
  document.addEventListener('DOMContentLoaded', async () => {
    if(!token) return window.location.href='/login.html';
    
    // User Info
    currentUser = JSON.parse(localStorage.getItem('lcc_user') || '{}');
    if(currentUser.firstName) {
      document.getElementById('userName').textContent = currentUser.firstName;
    }

    // Profil émetteur
    loadEmitterProfile();

    // Dates defaut
    const d = new Date(); 
    document.getElementById('invoiceIssueDate').valueAsDate = d;
    const d2 = new Date(); d2.setDate(d2.getDate()+30);
    document.getElementById('invoiceDueDate').valueAsDate = d2;

    await Promise.all([loadClients(), loadInvoices()]);
    // Ajout d'une ligne par défaut pour pas que ce soit vide
    addPrestation('commission');
    updatePreview(); 
  });

  // --- TABS ---
  window.switchTab = function(id) {
    document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(e => e.classList.remove('active'));
    document.getElementById('tab-'+id).classList.add('active');
    document.getElementById('btn-'+id).classList.add('active');
  }

  // --- CLIENTS ---
  async function loadClients() {
    try {
      const res = await fetch('/api/owner-clients', { headers: { Authorization: 'Bearer '+token }});
      const data = await res.json();
      clients = data.clients || [];
      document.getElementById('statsClients').textContent = clients.length;
      
      const sel = document.getElementById('invoiceClientId');
      sel.innerHTML = '<option value="">Sélectionner...</option>';
      const cont = document.getElementById('clientsContainer');
      cont.innerHTML = '';

      clients.forEach(c => {
        const name = c.company_name || `${c.first_name} ${c.last_name}`;
        // Select
        sel.innerHTML += `<option value="${c.id}">${name}</option>`;
        // List
        cont.innerHTML += `
          <div style="background:#f9fafb; padding:16px; border-radius:8px; border:1px solid #e5e7eb;">
            <div style="font-weight:700;">${name}</div>
            <div style="font-size:12px; color:#6b7280;">${c.email}</div>
            <button onclick="editClient(${c.id})" class="btn-xs btn-secondary" style="margin-top:8px;">Modifier</button>
          </div>`;
      });
    } catch(e) {}
  }

  // --- FACTURES ---
  async function loadInvoices() {
    try {
      const res = await fetch('/api/owner-invoices', { headers: { Authorization: 'Bearer '+token }});
      const data = await res.json();
      const invs = data.invoices || [];
      const tbody = document.getElementById('invoicesTableBody');
      
      if(invs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="padding:40px; text-align:center;">Aucune facture.</td></tr>';
          return;
      }
      
      let totalRev = 0;
      tbody.innerHTML = invs.map(inv => {
        totalRev += parseFloat(inv.total_ttc);
        return `
        <tr style="border-bottom:1px solid #f3f4f6;">
          <td style="padding:16px; font-weight:700; color:#10B981;">${inv.invoice_number}</td>
          <td style="padding:16px;">${inv.client_name}</td>
          <td style="padding:16px;">${new Date(inv.issue_date).toLocaleDateString()}</td>
          <td style="padding:16px; font-weight:600;">${parseFloat(inv.total_ttc).toFixed(2)} €</td>
          <td style="padding:16px;">${inv.status}</td>
          <td style="padding:16px; text-align:right;"><button class="btn-xs btn-secondary">...</button></td>
        </tr>`;
      }).join('');
      document.getElementById('statsRevenue').textContent = totalRev.toFixed(2) + ' €';
    } catch(e) {}
  }
let editingClientId = null;

window.editClient = function(clientId) {
    const client = clients.find(c => c.id == clientId);
    if (!client) {
        alert("Client introuvable.");
        return;
    }

    editingClientId = clientId;

    // Pré-remplir le popup
    document.getElementById("clientPopupTitle").textContent = "Modifier le client";

    document.querySelector(`input[name="clientType"][value="${client.client_type}"]`).checked = true;

    document.getElementById("clientFirstName").value = client.first_name || "";
    document.getElementById("clientLastName").value = client.last_name || "";
    document.getElementById("clientCompanyName").value = client.company_name || "";
    document.getElementById("clientEmail").value = client.email || "";
    document.getElementById("clientAddress").value = client.address || "";
    document.getElementById("clientPostalCode").value = client.postal_code || "";
    document.getElementById("clientCity").value = client.city || "";

    document.getElementById("clientPopup").style.display = "block";
};

  // --- PRESTATIONS (LOGIQUE MÉTIER RESTAURÉE) ---
  window.addPrestation = function(type) {
    prestationCounter++;
    prestations.push({
      id: 'p'+prestationCounter,
      type: type,
      description: type==='commission'?'Commission sur loyers':(type==='cleaning'?'Frais de ménage':'Débours'),
      rentalAmount: 0, commissionRate: 20, // Spécifique Commission
      quantity: 1, unitPrice: 0, // Spécifique Autres
      isDebours: type === 'debours'
    });
    renderEditorPrestations();
    updatePreview();
  };

  window.updatePrestation = function(id, key, val) {
    const p = prestations.find(x => x.id === id);
    if(p) {
      p[key] = key==='description' ? val : parseFloat(val)||0;
      renderEditorPrestations(); 
      updatePreview();
    }
  };

  window.removePrestation = function(id) {
    prestations = prestations.filter(x => x.id !== id);
    renderEditorPrestations();
    updatePreview();
  };

  function renderEditorPrestations() {
    const cont = document.getElementById('prestationsListEditor');
    cont.innerHTML = prestations.map(p => {
      let inputs = '';
      let badgeClass = 'badge-other';
      
      // LOGIQUE D'AFFICHAGE SELON LE TYPE (Comme dans ton ancien fichier)
      if(p.type === 'commission') {
        badgeClass = 'badge-commission';
        inputs = `
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <div><label style="font-size:10px;">Loyer (€)</label><input type="number" class="form-control" value="${p.rentalAmount}" oninput="updatePrestation('${p.id}','rentalAmount',this.value)"></div>
            <div><label style="font-size:10px;">Taux (%)</label><input type="number" class="form-control" value="${p.commissionRate}" oninput="updatePrestation('${p.id}','commissionRate',this.value)"></div>
          </div>`;
      } else {
        badgeClass = p.type === 'cleaning' ? 'badge-cleaning' : (p.type === 'debours' ? 'badge-debours' : 'badge-other');
        inputs = `
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <div><label style="font-size:10px;">Qté</label><input type="number" class="form-control" value="${p.quantity}" oninput="updatePrestation('${p.id}','quantity',this.value)"></div>
            <div><label style="font-size:10px;">Prix U.</label><input type="number" class="form-control" value="${p.unitPrice}" oninput="updatePrestation('${p.id}','unitPrice',this.value)"></div>
          </div>`;
      }

      return `
        <div class="prestation-mini-card">
          <button class="remove-line-btn" onclick="removePrestation('${p.id}')"><i class="fas fa-times"></i></button>
          <span class="prestation-badge ${badgeClass}">${p.type.toUpperCase()}</span>
          <div class="form-group" style="margin-bottom:8px;">
            <input type="text" class="form-control" value="${p.description}" oninput="updatePrestation('${p.id}','description',this.value)">
          </div>
          ${inputs}
          <div style="text-align:right; font-weight:700; font-size:12px; margin-top:8px;">
            ${calculateLineTotal(p).toFixed(2)} €
          </div>
        </div>
      `;
    }).join('');
  }

  function calculateLineTotal(p) {
    if(p.type === 'commission') return p.rentalAmount * (p.commissionRate/100);
    return p.quantity * p.unitPrice;
  }


  function loadEmitterProfile() {
    try {
      const saved = JSON.parse(localStorage.getItem('lcc_owner_emitter_profile') || '{}');
      emitterProfile = { ...emitterProfile, ...saved };

      const companyInput = document.getElementById('emitterCompany');
      const addressInput = document.getElementById('emitterAddress');
      const postalInput = document.getElementById('emitterPostalCode');
      const cityInput = document.getElementById('emitterCity');
      const siretInput = document.getElementById('emitterSiret');

      if (companyInput) companyInput.value = emitterProfile.company || '';
      if (addressInput) addressInput.value = emitterProfile.address || '';
      if (postalInput) postalInput.value = emitterProfile.postalCode || '';
      if (cityInput) cityInput.value = emitterProfile.city || '';
      if (siretInput) siretInput.value = emitterProfile.siret || '';

      updateSenderAddressFromProfile();
      updateSenderPreviewOnly();

      // Logo par défaut si déjà enregistré
      if (emitterProfile.logoDataUrl) {
        const logoContainer = document.getElementById('paperLogoContainer');
        if (logoContainer) {
          logoContainer.innerHTML = '<img src="' + emitterProfile.logoDataUrl + '" class="paper-logo-img">';
        }
      }
    } catch (e) {
      console.warn('Impossible de charger le profil émetteur', e);
    }
  }

  function saveEmitterProfile() {
    try {
      localStorage.setItem('lcc_owner_emitter_profile', JSON.stringify(emitterProfile));
    } catch (e) {
      console.warn('Impossible d\'enregistrer le profil émetteur', e);
    }
  }

  window.updateEmitterProfile = function () {
    const companyInput = document.getElementById('emitterCompany');
    const addressInput = document.getElementById('emitterAddress');
    const postalInput = document.getElementById('emitterPostalCode');
    const cityInput = document.getElementById('emitterCity');
    const siretInput = document.getElementById('emitterSiret');

    emitterProfile.company = companyInput ? companyInput.value.trim() : '';
    emitterProfile.address = addressInput ? addressInput.value.trim() : '';
    emitterProfile.postalCode = postalInput ? postalInput.value.trim() : '';
    emitterProfile.city = cityInput ? cityInput.value.trim() : '';
    emitterProfile.siret = siretInput ? siretInput.value.trim() : '';

    updateSenderAddressFromProfile();
    saveEmitterProfile();
    updateSenderPreviewOnly();
    updatePreview();
  };

  function updateSenderAddressFromProfile() {
    const parts = [];
    if (emitterProfile.address) parts.push(emitterProfile.address);
    const cityLine = (emitterProfile.postalCode || '') + ' ' + (emitterProfile.city || '');
    if (cityLine.trim()) parts.push(cityLine.trim());
    if (emitterProfile.siret) parts.push('SIRET : ' + emitterProfile.siret);

    const textarea = document.getElementById('senderAddressInput');
    if (textarea) {
      textarea.value = parts.join('\n');
    }
  }

  function updateSenderPreviewOnly() {
    let name = emitterProfile.company;
    if (!name && currentUser) {
      if (currentUser.company) name = currentUser.company;
      else {
        const first = currentUser.firstName || '';
        const last = currentUser.last_name || currentUser.lastName || '';
        name = (first + ' ' + last).trim();
      }
    }
    if (!name) name = 'Votre Entreprise';

    const senderNameEl = document.getElementById('previewSenderName');
    if (senderNameEl) senderNameEl.textContent = name;

    const addrTextarea = document.getElementById('senderAddressInput');
    const addr = (addrTextarea && addrTextarea.value) || '';
    const senderAddrEl = document.getElementById('previewSenderAddress');
    if (senderAddrEl) senderAddrEl.innerText = addr || 'Adresse...';
  }

  // --- PREVIEW ---
  window.updatePreview = function() {
    // Client
    const cliId = document.getElementById('invoiceClientId').value;
    const client = clients.find(c => String(c.id) === cliId);
    if(client) {
      const name = client.company_name || `${client.first_name} ${client.last_name}`;
      document.getElementById('previewClientName').textContent = name;
      document.getElementById('previewClientDetails').innerHTML = `${client.address || ''}<br>${client.postal_code || ''} ${client.city || ''}`;
    }

    // Dates
    const dIss = document.getElementById('invoiceIssueDate').valueAsDate;
    const dStart = document.getElementById('invoicePeriodStart').valueAsDate;
    const dEnd = document.getElementById('invoicePeriodEnd').valueAsDate;
    
    if(dIss) document.getElementById('previewDate').textContent = dIss.toLocaleDateString();
    if(dStart && dEnd) document.getElementById('previewPeriod').textContent = `${dStart.toLocaleDateString()} au ${dEnd.toLocaleDateString()}`;

    // Sender
    const sender = document.getElementById('senderAddressInput').value;
    if(sender) document.getElementById('previewSenderAddress').textContent = sender;

    // Totaux
    const tbody = document.getElementById('previewBody');
    tbody.innerHTML = '';
    let totalHT = 0;

    prestations.forEach(p => {
      const lineTotal = calculateLineTotal(p);
      totalHT += lineTotal;
      
      let qtyDisplay = p.type === 'commission' ? `${p.rentalAmount}€` : p.quantity;
      let priceDisplay = p.type === 'commission' ? `${p.commissionRate}%` : `${p.unitPrice}€`;

      tbody.innerHTML += `
        <tr>
          <td>${p.description}</td>
          <td style="text-align:center;">${qtyDisplay}</td>
          <td style="text-align:right;">${priceDisplay}</td>
          <td style="text-align:right; font-weight:600;">${lineTotal.toFixed(2)} €</td>
        </tr>`;
    });

    const hasVat = document.getElementById('invoiceVatApplicable').checked;
    if(hasVat) document.getElementById('invoiceVatRate').style.display = 'inline-block';
    else document.getElementById('invoiceVatRate').style.display = 'none';

    const vatRate = hasVat ? (parseFloat(document.getElementById('invoiceVatRate').value)||20)/100 : 0;
    const vatAmount = totalHT * vatRate;
    const totalTTC = totalHT + vatAmount;

    // MAJ UI
    const strHT = totalHT.toFixed(2) + ' €';
    const strTTC = totalTTC.toFixed(2) + ' €';
    
    document.getElementById('displayTotalHT').textContent = strHT;
    document.getElementById('displayTotalTTC').textContent = strTTC;
    document.getElementById('previewTotalHT').textContent = strHT;
    document.getElementById('previewTotalTTC').textContent = strTTC;
  };

  // --- LOGO ---
  window.updateLogoPreview = function() {
    const file = document.getElementById('logoInput').files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const dataUrl = e.target.result;
        const cont = document.getElementById('paperLogoContainer');
        if (cont) {
          cont.innerHTML = `<img src="${dataUrl}" class="paper-logo-img">`;
        }
        emitterProfile.logoDataUrl = dataUrl;
        saveEmitterProfile();
      };
      reader.readAsDataURL(file);
    }
  };

  // --- SAVE ---
  window.createInvoice = async function(send) {
    const clientId = document.getElementById('invoiceClientId').value;
    if(!clientId) return alert('Veuillez sélectionner un client');

    const data = {
      clientId: parseInt(clientId),
      periodStart: document.getElementById('invoicePeriodStart').value,
      periodEnd: document.getElementById('invoicePeriodEnd').value,
      issueDate: document.getElementById('invoiceIssueDate').value,
      dueDate: document.getElementById('invoiceDueDate').value,
      items: prestations.map(p => ({
        itemType: p.type,
        description: p.description,
        rentalAmount: p.rentalAmount, // Important pour commission
        commissionRate: p.commissionRate,
        quantity: p.quantity,
        unitPrice: p.unitPrice,
        total: calculateLineTotal(p),
        isDebours: p.isDebours
      })),
      vatApplicable: document.getElementById('invoiceVatApplicable').checked,
      vatRate: parseFloat(document.getElementById('invoiceVatRate').value),
      sendEmail: send
    };

    try {
      const url = editingInvoiceId ? `/api/owner-invoices/${editingInvoiceId}` : '/api/owner-invoices';
      const method = editingInvoiceId ? 'PUT' : 'POST';
      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify(data)
      });
      if (res.ok) {
        alert('✅ Facture enregistrée !');
        prestations = [];
        prestationCounter = 0;
        renderEditorPrestations();
        switchTab('dashboard');
        loadInvoices();
      } else {
        const err = await res.json();
        alert('Erreur : ' + err.error);
      }
    } catch (err) {
      console.error(err);
      alert('Erreur serveur');
    }
  };

  // --- CLIENT MODAL ---
  window.openClientModal = function() { document.getElementById('clientModal').classList.add('active'); };
  window.closeClientModal = function() { document.getElementById('clientModal').classList.remove('active'); };
  window.toggleClientType = function() {
    const t = document.querySelector('input[name="clientType"]:checked').value;
    document.getElementById('individualFields').style.display = t==='individual'?'block':'none';
    document.getElementById('businessFields').style.display = t==='business'?'block':'none';
  };

  window.saveClient = async function() {
    const type = document.querySelector('input[name="clientType"]:checked').value;

    const payload = {
        clientType: type,
        firstName: document.getElementById('clientFirstName').value,
        lastName: document.getElementById('clientLastName').value,
        companyName: document.getElementById('clientCompanyName').value,
        email: document.getElementById('clientEmail').value,
        address: document.getElementById('clientAddress').value,
        postalCode: document.getElementById('clientPostalCode').value,
        city: document.getElementById('clientCity').value,
        defaultCommissionRate: 20
    };

    let url = "/api/owner-clients";
    let method = "POST";

    if (editingClientId !== null) {
        url = `/api/owner-clients/${editingClientId}`;
        method = "PUT";
    }

    try {
        const res = await fetch(url, {
            method,
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify(payload)
        });

        const json = await res.json();
        if (!res.ok) return alert(json.error || "Erreur serveur");

        alert(editingClientId ? "Client mis à jour !" : "Client ajouté !");
        
        editingClientId = null;
        document.getElementById('clientPopup').style.display = 'none';
        loadClients();
    } catch (err) {
        console.error(err);
        alert("Erreur serveur");
    }
};

  window.logout = function() {
    localStorage.removeItem('lcc_token');
    window.location.href = '/login.html';
  };
</script>

</body>
</html>
