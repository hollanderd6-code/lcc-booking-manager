<!DOCTYPE html>

<html data-theme="light" lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="no-store, no-cache, must-revalidate, max-age=0" http-equiv="Cache-Control"/>
<meta content="no-cache" http-equiv="Pragma"/>
<meta content="0" http-equiv="Expires"/>
<meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
<title>Boostinghost ‚Äì Facturation</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>
<link href="/css/style.css" rel="stylesheet"/><link href="/css/bh-shared.css?v=1" rel="stylesheet"/><link href="/css/bottom-bar-enhanced.css" rel="stylesheet"/><link href="/css/menu-plus-fixes.css" rel="stylesheet"/><link href="/css/menu-active-button.css" rel="stylesheet"/>
<link href="/css/messages-badge-fix.css" rel="stylesheet"/>
<link href="/css/invoices-cards-style.css" rel="stylesheet"/>
<style>
    /* FIX iOS POUR APP MOBILE */
    html, body {
      margin: 0 !important;
    }
    .app-container {
      margin-top: 0 !important;
    }
    /* (patched) removed inline .main-content padding override for iOS safe-area */
    .page-content {
      margin-top: 0 !important;
      max-width: 1100px;
    }
    
    /* DESIGN SYSTEM "FACTURE PRO" */
    :root { --primary: #10B981; --primary-dark: #059669; --bg-body: #f3f4f6; --paper-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }

    html, body { margin: 0; padding: 0; background: var(--bg-body); font-family: 'Inter', sans-serif; height: 100%; overflow-x: hidden; }
    .app-container { display: flex; min-height: 100vh; }
    
    /* SIDEBAR */
    .sidebar { width: 260px; background: white; border-right: 1px solid #e5e7eb; position: fixed; top: 0; bottom: 0; left: 0; z-index: 50; display: flex; flex-direction: column; }
    .sidebar-header { padding: 24px; }
    .sidebar-logo { display: flex; align-items: center; gap: 10px; text-decoration: none; color: #111827; font-weight: 800; font-size: 18px; }
    .nav-section-title { font-size: 11px; font-weight: 700; color: #9ca3af; text-transform: uppercase; margin: 24px 24px 8px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 24px; color: #4b5563; text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s; border-right: 3px solid transparent; }
    .nav-item:hover { background: #f9fafb; color: #111827; }
    .nav-item.active { background: #ecfdf5; color: #10B981; border-right-color: #10B981; }
    .nav-item i { width: 20px; text-align: center; }

    /* CONTENT */
    .main-wrapper { flex: 1; margin-left: 260px; display: flex; flex-direction: column; min-width: 0; }
    .top-bar { background: white; height: 64px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: flex-end; padding: 0 32px; position: sticky; top: 0; z-index: 40; }
    .main-content { padding: 32px; max-width: 1600px; margin: 0 auto; width: 100%; box-sizing: border-box; }

    /* DASHBOARD */
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
    .page-title { font-size: 24px; font-weight: 700; color: #111827; margin: 0; }
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .stat-card { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .stat-label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #6b7280; margin-bottom: 8px; display: block; }
    .stat-value { font-size: 24px; font-weight: 700; color: #111827; }

    /* TABS */
    .nav-tabs { display: inline-flex; background: #e5e7eb; padding: 4px; border-radius: 10px; margin-bottom: 24px; }
    .nav-tab { padding: 8px 24px; border-radius: 8px; border: none; background: transparent; font-weight: 600; color: #4b5563; cursor: pointer; font-size: 14px; transition: all 0.2s; }
    .nav-tab.active { background: white; color: #111827; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }

    /* √âDITEUR FACTURE (Split View) */
    .invoice-editor-layout { display: grid; grid-template-columns: 400px 1fr; gap: 32px; align-items: start; }
    
    /* GAUCHE : Contr√¥les */
    .editor-sidebar { background: white; border-radius: 16px; border: 1px solid #e5e7eb; position: sticky; top: 88px; max-height: calc(100vh - 120px); overflow-y: auto; display: flex; flex-direction: column; }
    .editor-section { padding: 20px; border-bottom: 1px solid #f3f4f6; }
    .editor-section-title { font-size: 12px; font-weight: 700; text-transform: uppercase; color: #9ca3af; margin-bottom: 12px; }
    
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; color: #374151; }
    .form-control { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px; box-sizing: border-box; }
    .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(16,185,129,0.1); }
    
    /* DROITE : Feuille A4 */
    .invoice-preview-container { display: flex; justify-content: center; padding-bottom: 40px; }
    .invoice-paper { background: white; width: 100%; max-width: 800px; min-height: 1000px; padding: 48px; box-shadow: var(--paper-shadow); border-radius: 2px; position: relative; color: #1f2937; }
    .paper-header { display: flex; justify-content: space-between; margin-bottom: 40px; }
    .paper-logo-img { max-height: 60px; max-width: 180px; object-fit: contain; display: block; margin-bottom: 8px; }
    
    .paper-table { width: 100%; border-collapse: collapse; margin-top: 32px; }
    .paper-table th { text-align: left; padding: 12px 8px; border-bottom: 2px solid #e5e7eb; font-size: 11px; text-transform: uppercase; color: #6b7280; font-weight: 600; }
    .paper-table td { padding: 16px 8px; border-bottom: 1px solid #f3f4f6; font-size: 13px; vertical-align: top; }
    .paper-totals { display: flex; justify-content: flex-end; margin-top: 32px; }
    .totals-box { width: 260px; }
    .total-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; color: #4b5563; }
    .total-row.final { font-size: 16px; font-weight: 700; color: var(--primary); border-top: 2px solid #e5e7eb; margin-top: 8px; padding-top: 12px; }

    /* PRESTATIONS MINI-CARDS (Style √âditeur) */
.prestation-mini-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; padding-right: 80px; margin-bottom: 8px; position: relative; }  
    .prestation-mini-card:hover { border-color: #d1d5db; background: white; }
    .prestation-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; }
    .badge-commission { background: #dcfce7; color: #166534; }
    .badge-cleaning { background: #dbeafe; color: #1e40af; }
    .badge-debours { background: #fef3c7; color: #92400e; }
    .badge-other { background: #f3f4f6; color: #374151; }
.remove-line-btn { padding: 6px 8px; border-radius: 6px; border: none; cursor: pointer; opacity: 0.8; transition: opacity 0.2s; background: #fee2e2; color: #dc2626; }  
    .remove-line-btn:hover { opacity: 1; }

    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; text-decoration: none; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: white; border: 1px solid #d1d5db; color: #374151; }
    .btn-xs { padding: 4px 8px; font-size: 11px; }

    /* MODALS */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: white; border-radius: 16px; width: 90%; max-width: 500px; padding: 24px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; }

    @media (max-width: 1024px) {
      .sidebar { transform: translateX(-100%); } .sidebar.active { transform: translateX(0); }
      .main-wrapper { margin-left: 0; } .invoice-editor-layout { grid-template-columns: 1fr; }
      .menu-toggle { display: block; font-size: 20px; background: none; border: none; cursor: pointer; margin-right: 16px; }
    }
    @media (min-width: 1025px) { .menu-toggle { display: none; } }
    .invoice-row-actions {
  position: relative;
  display: inline-block;
}
/* LES 3 PETITS POINTS*/
.invoice-actions-menu {
  position: fixed;              /* au lieu de absolute */
  right: 0;
  top: 0;
  margin-top: 0;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  box-shadow: 0 10px 25px rgba(15,23,42,0.15);
  padding: 4px;
  min-width: 180px;
  display: none;
  z-index: 9999;                /* passe au-dessus de la carte */
}


.invoice-actions-menu.open {
  display: block;
}

.invoice-actions-menu button {
  width: 100%;
  padding: 8px 10px;
  background: transparent;
  border: none;
  text-align: left;
  font-size: 13px;
  border-radius: 6px;
  cursor: pointer;
}

.invoice-actions-menu button:hover {
  background: #f3f4f6;
}
@media print {
  body {
    background: #ffffff !important;
  }

  body * {
    visibility: hidden;
  }

  .invoice-paper,
  .invoice-paper * {
    visibility: visible;
  }

  .invoice-paper {
    position: absolute;
    inset: 0;
    margin: 0;
    box-shadow: none;
    max-width: none;
    width: 210mm;     /* format A4 portrait */
    min-height: 0;
  }
}
/* D√©sactiver les petites fl√®ches sur tous les champs num√©riques */
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

input[type="number"] {
  -moz-appearance: textfield;
  appearance: textfield;
}
/* READ-ONLY MODE */
.editor-sidebar.readonly .form-control,
.editor-sidebar.readonly .btn-primary {
  pointer-events: none;
  opacity: 0.6;
  background: #f3f4f6;
}

.editor-sidebar.readonly .remove-line-btn {
  display: none;
}

.readonly-banner {
  background: #fef3c7;
  border: 1px solid #fbbf24;
  color: #92400e;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 16px;
  font-size: 13px;
  font-weight: 600;
  text-align: center;
}
  
/* --- Sidebar section titles (nicer) --- */
.nav-section-title{
  display:flex;
  align-items:center;
  gap:10px;
  margin: 14px 16px 8px;
  font-size: 12px;
  font-weight: 800;
  letter-spacing: .10em;
  text-transform: uppercase;
  color: #6b7280;
}
.nav-section-title::after{
  content:"";
  flex:1;
  height:1px;
  background: rgba(15,23,42,.10);
  border-radius: 999px;
}

/* badge */
.nav-badge{
  margin-left:auto;
  background:#dcfce7;
  color:#166534;
  font-size:12px;
  font-weight:700;
  padding:4px 10px;
  border-radius:999px;
}

/* footer profile */
.sidebar-footer{
  border-top:1px solid #e5e7eb;
  padding:14px 16px;
}
.user-profile{
  display:flex;
  align-items:center;
  gap:10px;
}
.user-avatar{
  width:34px;
  height:34px;
  border-radius:999px;
  background:#e5e7eb;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  color:#374151;
}
.user-info{ min-width:0; }
.user-name{ font-weight:700; font-size:13px; color:#111827; line-height:1.1; }
.user-email{ font-size:11px; color:#6b7280; }

</style>
<style>
/* ‚úÖ Uniformisation du bouton "Retour au dashboard" (header) */
.main-header .header-actions .btn.btn-ghost{
  border-radius: 999px !important;
  border: 1px solid rgba(148, 163, 184, 0.45) !important;
  background: transparent !important;
  padding: 10px 16px !important;
  font-size: 14px !important;
  font-weight: 600 !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 10px !important;
  color: inherit !important;
  box-shadow: none !important;
}
.main-header .header-actions .btn.btn-ghost i{
  font-size: 16px !important;
}
.main-header .header-actions .btn.btn-ghost:hover{
  background: rgba(15, 23, 42, 0.06) !important;
}
[data-theme="dark"] .main-header .header-actions .btn.btn-ghost:hover{
  background: rgba(15, 23, 42, 0.90) !important;
}
</style>
<link rel="stylesheet" href="/css/mobile-native-styles.css">
<style>
/* RESPONSIVE MOBILE √âDITEUR - AUTO-INCLUS */
@media (max-width: 768px) {
  .invoice-editor-layout { display: flex !important; flex-direction: column !important; gap: 16px !important; }
  .editor-sidebar { position: static !important; width: 100% !important; max-height: none !important; }
  .invoice-preview-container { display: none !important; }
  .form-control { font-size: 16px !important; padding: 10px 12px !important; }
  .editor-section [style*="grid-template-columns"] { grid-template-columns: 1fr !important; }
  .editor-section .btn { width: 100%; padding: 12px 16px !important; font-size: 15px !important; }
  .nav-tabs { width: 100% !important; }
  .nav-tab { flex: 1 !important; font-size: 13px !important; }
}
</style>
<style>
/* FIX BOUTON MOBILE */
@media (max-width: 768px) {
  .main-header { display: flex !important; z-index: 100 !important; }
  .header-actions { display: flex !important; z-index: 101 !important; }
  .header-actions .btn { pointer-events: auto !important; touch-action: manipulation !important; min-height: 48px !important; }
  button[onclick*="createNewInvoice"] { display: inline-flex !important; visibility: visible !important; opacity: 1 !important; z-index: 9999 !important; }
}
</style>
<script>
/* DEBUG MOBILE */
setTimeout(() => {
  const btn = document.querySelector("button[onclick*="createNewInvoice"]");
  console.log("Bouton trouv√©:", !!btn);
  if(btn) {
    btn.addEventListener("touchstart", () => console.log("Touch d√©tect√©"));
    btn.addEventListener("click", () => console.log("Click d√©tect√©"));
  }
}, 1000);
</script>
</head>
<body data-back-href="/app.html" data-back-label="Retour au dashboard" data-kicker="Facturation" data-page="factures-proprietaires" data-subtitle="G√©rez vos revenus et commissions." data-title="Factures propri√©taires"><div class="mobile-header">
<a class="mobile-logo" href="/app.html">
<i class="fas fa-calendar-check"></i>
<span class="mobile-logo-text">Boostinghost</span>
</a>
</div><div class="sidebar-overlay" id="sidebarOverlay"></div>
<div class="app-container">
<!-- Sidebar -->
<div id="bhSidebar"></div>
<div class="main-wrapper">
<header class="top-bar">
</header>
<main class="main-content"><div id="bhHeaderActions" style="display:none;"><button class="btn btn-primary" onclick="createNewInvoice()">
<i class="fa fa-plus"></i> Nouvelle Facture
</button></div><div id="bhHeader"></div>
<div class="dashboard-header">
<div><h1 class="page-title">Facturation Propri√©taires</h1><p class="page-subtitle" style="color:#6b7280; font-size:14px; margin-top:4px;">G√©rez vos revenus et commissions.</p></div>
</div>
<div class="stats-row">
<div class="stat-card" onclick="openStatsModal('billed')" style="cursor:pointer;">
<span class="stat-label">Total Factur√© (Mois)</span>
<span class="stat-value" id="statsRevenue">0,00 ‚Ç¨</span>
</div>
<div class="stat-card" onclick="openStatsModal('pending')" style="cursor:pointer;">
<span class="stat-label">En attente</span>
<span class="stat-value" id="statsPending" style="color:#f59e0b;">0,00 ‚Ç¨</span>
</div>
<div class="stat-card" onclick="openStatsModal('clients')" style="cursor:pointer;">
<span class="stat-label">Clients Propri√©taires</span>
<span class="stat-value" id="statsClients">0</span>
</div>
</div>
<div class="nav-tabs">
<button class="nav-tab active" id="btn-dashboard" onclick="switchTab('dashboard')">Historique</button>
<button class="nav-tab" id="btn-create" onclick="switchTab('create')">√âditeur</button>
<button class="nav-tab" id="btn-clients" onclick="switchTab('clients')">Mes Clients</button>
</div>
<div class="tab-content active" id="tab-dashboard">
<div style="background:white; border-radius:12px; border:1px solid #e5e7eb; padding:16px; overflow:hidden;">
<div id="invoicesCardsGrid" class="invoices-cards-grid">
<div style="padding:40px; text-align:center; grid-column: 1 / -1;">Chargement...</div>
</div>
</div>
</div>
<div class="tab-content" id="tab-create">
<div class="invoice-editor-layout">
<div class="editor-sidebar" id="editorSidebar">
<!-- Banni√®re READ-ONLY (masqu√©e par d√©faut) -->
<div class="readonly-banner" id="readonlyBanner" style="display:none;">
  ‚ö†Ô∏è Facture en lecture seule - D√©j√† √©mise
</div>
<div class="editor-section">
<div class="editor-section-title">Informations Facture</div>
<div class="form-group">
<label>Client</label>
<select class="form-control" id="invoiceClientId" onchange="loadClientDefaults(); ;">
<option value="">S√©lectionner...</option>
</select>
</div>
<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
<div class="form-group"><label>√âmission</label><input class="form-control" id="invoiceIssueDate" onchange="" type="date"/></div>
<div class="form-group"><label>√âch√©ance</label><input class="form-control" id="invoiceDueDate" onchange="updatePreview()" type="date"/></div>
</div>
<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
<div class="form-group"><label>P√©riode Du</label><input class="form-control" id="invoicePeriodStart" onchange="updatePreview()" type="date"/></div>
<div class="form-group"><label>Au</label><input class="form-control" id="invoicePeriodEnd" onchange="updatePreview()" type="date"/></div>
</div>
</div>
<div class="form-group" id="propertySelectSection" style="display:none;margin-top:12px;">
<label>Logements concern√©s</label>
<div id="propertyCheckboxList" style="max-height:150px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:8px;padding:8px;">
<!-- Cases √† cocher g√©n√©r√©es dynamiquement -->
</div>
<small style="display:block;margin-top:4px;font-size:11px;color:#6b7280;">
    S√©lectionnez le(s) logement(s) concern√©(s) par cette facture
  </small>
</div>
<div class="editor-section">
<div class="editor-section-title">Profil √©metteur</div>
<div class="form-group">
<label>Nom de l'entreprise</label>
<input class="form-control" id="emitterCompany" oninput="updateEmitterProfile()" placeholder="Conciergerie" type="text"/>
</div>
<div class="form-group">
<label>Adresse</label>
<input class="form-control" id="emitterAddress" oninput="updateEmitterProfile()" placeholder="boulevard de la R√©publique" type="text"/>
</div>
<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
<div class="form-group">
<label>Code postal</label>
<input class="form-control" id="emitterPostalCode" oninput="updateEmitterProfile()" placeholder="75000" type="text"/>
</div>
<div class="form-group">
<label>Ville</label>
<input class="form-control" id="emitterCity" oninput="updateEmitterProfile()" placeholder="Paris" type="text"/>
</div>
</div>
<div class="form-group">
<label>SIRET</label>
<input class="form-control" id="emitterSiret" oninput="updateEmitterProfile()" placeholder="534 392 600" type="text"/>
</div>
<div class="form-group">
<label>Logo entreprise (optionnel)</label>
<div style="display:flex;gap:12px;align-items:center;">
<div style="width:60px;height:60px;border:2px dashed #e5e7eb;border-radius:8px;display:flex;align-items:center;justify-content:center;background:#f9fafb;overflow:hidden;">
<img id="logoPreviewImg" style="display:none;width:100%;height:100%;object-fit:contain;"/>
<i class="fas fa-image" id="logoPlaceholder" style="color:#9ca3af;font-size:20px;"></i>
</div>
<input accept="image/*" class="form-control" id="logoInput" onchange="updateLogoPreview()" style="flex:1;" type="file"/>
</div>
</div>
<div class="form-group">
<label>Adresse affich√©e sur la facture</label>
<textarea class="form-control" id="senderAddressInput" oninput="updatePreview()" placeholder="Votre adresse..." rows="2"></textarea>
<div style="font-size:11px; color:#6b7280; margin-top:4px;">
                  Elle est pr√©-remplie automatiquement avec les champs ci-dessus, mais vous pouvez la modifier pour une facture pr√©cise.
                </div>
</div>
</div>
<div class="editor-section">
<div class="editor-section-title">Prestations</div>
<div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:4px; margin-bottom:12px;">
<button class="btn-xs btn-secondary" onclick="addPrestation('commission')">% Com</button>
<button class="btn-xs btn-secondary" onclick="addPrestation('cleaning')">M√©nage</button>
<button class="btn-xs btn-secondary" onclick="addPrestation('debours')">D√©bours</button>
<button class="btn-xs btn-secondary" onclick="addPrestation('other')">Autre</button>
</div>
<div id="prestationsListEditor"></div>
</div>
<div class="editor-section">
<div style="display:flex; justify-content:space-between; margin-bottom:10px;">
<label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
<input id="invoiceVatApplicable" onchange="updatePreview()" type="checkbox"/> TVA
                </label>
<input id="invoiceVatRate" onchange="updatePreview()" style="width:50px; display:none;" type="number" value="20"/>
</div>
<div style="background:#f9fafb; padding:12px; border-radius:8px; font-size:13px;">
<div style="display:flex; justify-content:space-between;"><span>Total HT</span><strong id="displayTotalHT">0.00 ‚Ç¨</strong></div>
<div style="display:flex; justify-content:space-between; margin-top:4px;"><span>TVA</span><strong id="displayTotalVAT">0.00 ‚Ç¨</strong></div>
<div style="display:flex; justify-content:space-between; margin-top:8px; padding-top:8px; border-top:1px solid #e5e7eb; color:var(--primary); font-size:15px;"><span>NET √Ä PAYER</span><strong id="displayTotalTTC">0.00 ‚Ç¨</strong></div>
</div>
<div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
<button class="btn btn-secondary" onclick="createInvoice(false)">Brouillon</button>
<button class="btn btn-primary" onclick="createInvoice(true)">Envoyer</button>
</div>
</div>
</div>
<div class="invoice-preview-container">
<div class="invoice-paper">
<div class="paper-header">
<div>
<div id="paperLogoContainer" style="width:80px;height:80px;border:2px dashed #e5e7eb;border-radius:8px;display:flex;align-items:center;justify-content:center;background:#f9fafb;overflow:hidden;">
<img id="previewLogoImg" style="display:none;width:100%;height:100%;object-fit:contain;"/>
<i class="fas fa-image" id="previewLogoPlaceholder" style="color:#9ca3af;font-size:24px;"></i>
</div>
<div id="paperSenderInfo" style="margin-top:10px;">
<strong id="previewSenderName" style="font-size:16px; color:#111827;">Votre Entreprise</strong>
<div class="paper-sender-address" id="previewSenderAddress">Adresse...</div>
</div>
</div>
<div class="paper-meta">
<div class="paper-title" style="margin:0; font-size:32px; font-weight:800;">FACTURE</div>
<div class="paper-number" style="color:#6b7280;">N¬∞ BROUILLON</div>
<div style="margin-top:8px; font-size:12px; color:#4b5563;">Date : <span id="previewDate">-</span></div>
</div>
</div>
<div class="paper-client" style="margin-bottom:40px; padding:20px; background:#f9fafb; border-radius:8px;">
<div style="font-size:11px; font-weight:700; color:#9ca3af; text-transform:uppercase;">Factur√© √†</div>
<div id="previewClientName" style="font-weight:700; font-size:16px; margin-top:4px;">S√©lectionnez un client...</div>
<div id="previewClientDetails" style="font-size:13px; color:#4b5563;"></div>
</div>
<div style="font-size:12px; color:#6b7280; margin-bottom:10px;">P√©riode : <span id="previewPeriod">-</span></div>
<p style="font-size:13px;color:#6b7280;margin:16px 0;display:none;">
  Logement(s) : <strong><span id="previewProperties">--</span></strong>
</p>
<table class="paper-table">
<thead><tr><th>Description</th><th style="width:80px; text-align:center;">Base/Qt√©</th><th style="width:80px; text-align:right;">Prix/%</th><th style="width:100px; text-align:right;">Total HT</th></tr></thead>
<tbody id="previewBody"></tbody>
</table>
<div class="paper-totals">
<div class="totals-box">
<div class="total-row"><span>Total HT</span><span id="previewTotalHT">0,00 ‚Ç¨</span></div>
<div class="total-row"><span>TVA</span><span id="previewTotalVAT">0,00 ‚Ç¨</span></div>
<div class="total-row final"><span>Net √† payer</span><span id="previewTotalTTC">0,00 ‚Ç¨</span></div>
<div id="previewVatLegalMention" style="margin-top:6px; font-size:11px; color:#6b7280; display:none;">
  TVA non applicable, art. 293 B du CGI
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="tab-content" id="tab-clients">
<div style="background:white; border-radius:12px; border:1px solid #e5e7eb; padding:24px;">
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
<h3 style="margin:0;">Liste des propri√©taires</h3>
<button class="btn btn-primary" onclick="openClientModal()">+ Nouveau Client</button>
</div>
<div id="clientsContainer" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:16px;"></div>
</div>
</div>
</main>
</div>
</div>
<div class="modal-overlay" id="statsModal">
<div class="modal-content">
<div style="display:flex; justify-content:space-between; margin-bottom:20px;">
<h3 id="statsModalTitle" style="margin:0;">D√©tails</h3>
<button onclick="closeStatsModal()" style="border:none; background:none; font-size:20px; cursor:pointer;">√ó</button>
</div>
<div id="statsModalBody" style="font-size:14px;">
<!-- Contenu inject√© en JS -->
</div>
</div>
</div>
<div class="modal-overlay" id="clientModal">
<div class="modal-content">
<div style="display:flex; justify-content:space-between; margin-bottom:20px;">
<h3 id="clientModalTitle" style="margin:0;">Nouveau Client</h3>
<button onclick="closeClientModal()" style="border:none; background:none; font-size:20px; cursor:pointer;">√ó</button>
</div>
<div style="display:flex; gap:16px; margin-bottom:16px;">
<label><input checked="" name="clientType" onchange="toggleClientType()" type="radio" value="individual"/> Particulier</label>
<label><input name="clientType" onchange="toggleClientType()" type="radio" value="business"/> Entreprise</label>
</div>
<div id="individualFields">
<div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
<div><label style="font-size:12px;">Pr√©nom</label><input class="form-control" id="clientFirstName" type="text"/></div>
<div><label style="font-size:12px;">Nom</label><input class="form-control" id="clientLastName" type="text"/></div>
</div>
</div>
<div id="businessFields" style="display:none; margin-bottom:12px;">
<div><label style="font-size:12px;">Soci√©t√©</label><input class="form-control" id="clientCompanyName" type="text"/></div>
</div>
<div class="form-group"><label>Email</label><input class="form-control" id="clientEmail" type="email"/></div>
<div class="form-group"><label>Adresse</label><input class="form-control" id="clientAddress" type="text"/></div>
<div style="display:grid; grid-template-columns:1fr 2fr; gap:12px; margin-bottom:12px;">
<div><label style="font-size:12px;">CP</label><input class="form-control" id="clientPostalCode" type="text"/></div>
<div><label style="font-size:12px;">Ville</label><input class="form-control" id="clientCity" type="text"/></div>
</div>
<button class="btn btn-primary" onclick="saveClient()" style="width:100%;">Enregistrer</button>
</div>
</div>
<script src="/js/auth-fetch.js"></script>
<script>
let token = localStorage.getItem('lcc_token');
  let clients = [];
  let prestations = [];
  let prestationCounter = 0;
  let editingInvoiceId = null;
  let isReadOnlyMode = false;
  let emitterProfile = {
    company: '',
    address: '',
    postalCode: '',
    city: '',
    siret: '',
    logoDataUrl: ''
  };
  let currentUser = null;

  // Fonction pour formater les montants en fran√ßais
  function formatMoney(amount) {
    return amount.toFixed(2).replace('.', ',') + ' ‚Ç¨';
  }

  // --- INIT ---
document.addEventListener('DOMContentLoaded', async () => {
  console.log('üîß Initialisation de la page factures...');
  if(!token) return window.location.href='/login.html';
  
  // User Info
  currentUser = JSON.parse(localStorage.getItem('lcc_user') || '{}');
  
  // Dates defaut
  const d = new Date(); 
  document.getElementById('invoiceIssueDate').valueAsDate = d;
  const d2 = new Date(); d2.setDate(d2.getDate()+30);
  document.getElementById('invoiceDueDate').valueAsDate = d2;
  
  // Charger les donn√©es une par une pour √©viter le blocage
  try {
    console.log('üì• Chargement des clients...');
    await loadClients();
    console.log('‚úÖ Clients charg√©s');
  } catch(e) {
    console.error('‚ùå Erreur clients:', e);
  }
  
  try {
    console.log('üì• Chargement des factures...');
    await loadInvoices();
    console.log('‚úÖ Factures charg√©es');
  } catch(e) {
    console.error('‚ùå Erreur factures:', e);
  }
  
  try {
    console.log('üì• Chargement du profil...');
    await loadUserProfile();
    console.log('‚úÖ Profil charg√©');
  } catch(e) {
    console.error('‚ùå Erreur profil:', e);
  }
  
  // Profil √©metteur (APR√àS loadUserProfile pour ne pas √©craser le logo)
  loadEmitterProfile();
  
  // Ajout d'une ligne par d√©faut
  addPrestation('commission');
  
  // Attendre que le DOM soit pr√™t avant d'appeler updatePreview
  setTimeout(() => updatePreview(), 100);
  
  console.log('‚úÖ Initialisation termin√©e');
});

  // --- TABS ---
  window.switchTab = function(id) {
    document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(e => e.classList.remove('active'));
    document.getElementById('tab-'+id).classList.add('active');
    document.getElementById('btn-'+id).classList.add('active');
  }

  // --- CLIENTS ---
  async function loadClients() {
  try {
    const res = await fetch('/api/owner-clients', { headers: { Authorization: 'Bearer '+token }});
    const data = await res.json();
    clients = data.clients || [];
    document.getElementById('statsClients').textContent = clients.length;
    
    // Remplir le SELECT dans l'√©diteur
    const sel = document.getElementById('invoiceClientId');
    sel.innerHTML = '<option value="">S√©lectionner...</option>';
    clients.forEach(c => {
      const name = c.company_name || `${c.first_name || ''} ${c.last_name || ''}`.trim();
      sel.innerHTML += `<option value="${c.id}">${name}</option>`;
    });
    
    // Charger aussi les propri√©t√©s pour pouvoir les afficher
    await loadPropertiesForInvoice();
    
  } catch(e) {
    console.error('Erreur chargement clients:', e);
  }
}

// Charger les infos du profil utilisateur
async function loadUserProfile() {
  try {
    const res = await fetch('/api/user/profile', {
      headers: { Authorization: 'Bearer ' + token }
    });
    
    if (!res.ok) return;
    
    const profile = await res.json();
    window.userProfile = profile;
    
    // Pr√©-remplir automatiquement les champs √©metteur
    if (profile.company) {
      const companyInput = document.getElementById('emitterCompany');
      if (companyInput && !companyInput.value) {
        companyInput.value = profile.company;
      }
    }
    
    if (profile.address) {
      const addressInput = document.getElementById('emitterAddress');
      if (addressInput && !addressInput.value) {
        addressInput.value = profile.address;
      }
    }
    
    if (profile.postalCode && profile.city) {
      const cityInput = document.getElementById('emitterCity');
      if (cityInput && !cityInput.value) {
        cityInput.value = `${profile.postalCode} ${profile.city}`;
      }
    }
    
    if (profile.siret) {
      const siretInput = document.getElementById('emitterSiret');
      if (siretInput && !siretInput.value) {
        siretInput.value = profile.siret;
      }
    }
    
    // Charger le logo si pr√©sent
    if (profile.logoUrl) {
      emitterProfile.logoDataUrl = profile.logoUrl;
      const logoPreview = document.getElementById('logoPreviewImg');
      if (logoPreview) {
        logoPreview.src = profile.logoUrl;
        logoPreview.style.display = 'block';
      }
    }
    
  } catch (e) {
    console.error('Erreur chargement profil:', e);
  }
}
// Nouvelle fonction pour charger les propri√©t√©s
async function loadPropertiesForInvoice() {
  try {
    const res = await fetch('/api/properties', { 
      headers: { Authorization: 'Bearer ' + token }
    });
    const data = await res.json();
    window.allProperties = data.properties || [];
  } catch(e) {
    console.error('Erreur chargement propri√©t√©s:', e);
  }
}

// Nouvelle fonction appel√©e quand on s√©lectionne un client
function loadClientDefaults() {
  const clientId = document.getElementById('invoiceClientId').value;
  
  if (!clientId) {
    // Cacher la section logements
    document.getElementById('propertySelectSection').style.display = 'none';
    return;
  }
  
  // Afficher les logements de ce client
  const clientProperties = (window.allProperties || []).filter(p => p.owner_id == clientId);
  
  const container = document.getElementById('propertyCheckboxList');
  const section = document.getElementById('propertySelectSection');
  
  if (clientProperties.length === 0) {
    section.style.display = 'none';
    return;
  }
  
  section.style.display = 'block';
  container.innerHTML = '';
  
  clientProperties.forEach(prop => {
    const label = document.createElement('label');
    label.style.display = 'flex';
    label.style.alignItems = 'center';
    label.style.gap = '8px';
    label.style.padding = '8px';
    label.style.cursor = 'pointer';
    label.style.borderRadius = '6px';
    label.style.fontSize = '13px';
    label.innerHTML = `
      <input type="checkbox" class="property-checkbox" value="${prop.id}" onchange="updatePreview()">
      <span>${prop.name}</span>
    `;
    container.appendChild(label);
  });
  
  updatePreview();
}
  // --- FACTURES ---
  


window.openStatsModal = function(type) {
  const modal = document.getElementById('statsModal');
  const titleEl = document.getElementById('statsModalTitle');
  const bodyEl = document.getElementById('statsModalBody');
  if (!modal || !titleEl || !bodyEl) return;

  let htmlContent = '';
  const invoices = window.ownerInvoices || [];
  const clientsList = window.clients || [];

  if (type === 'billed') {
    titleEl.textContent = 'Factures factur√©es';
    const filtered = invoices.filter(function(inv) {
      const status = inv.status || '';
      return !inv.is_credit_note && status !== 'draft';
    });
    if (filtered.length === 0) {
      htmlContent = '<p>Aucune facture factur√©e.</p>';
    } else {
      htmlContent = '<table style="width:100%; border-collapse:collapse; font-size:13px;">' +
        '<thead><tr>' +
        '<th style="text-align:left; padding:6px 4px;">N¬∞</th>' +
        '<th style="text-align:left; padding:6px 4px;">Client</th>' +
        '<th style="text-align:left; padding:6px 4px;">Date</th>' +
        '<th style="text-align:right; padding:6px 4px;">Montant</th>' +
        '</tr></thead><tbody>';
      filtered.forEach(function(inv) {
        const dateStr = inv.issue_date ? new Date(inv.issue_date).toLocaleDateString() : '';
        const num = inv.invoice_number || ('#' + inv.id);
        const total = (parseFloat(inv.total_ttc || 0) || 0).toFixed(2) + ' ‚Ç¨';
        htmlContent += '<tr>' +
          '<td style="padding:4px 4px;">' + num + '</td>' +
          '<td style="padding:4px 4px;">' + (inv.client_name || '') + '</td>' +
          '<td style="padding:4px 4px;">' + dateStr + '</td>' +
          '<td style="padding:4px 4px; text-align:right;">' + total + '</td>' +
        '</tr>';
      });
      htmlContent += '</tbody></table>';
    }
  } else if (type === 'pending') {
    titleEl.textContent = 'Factures en attente de paiement';
    const filtered = invoices.filter(function(inv) {
      const status = inv.status || '';
      return !inv.is_credit_note && status !== 'draft' && status !== 'paid';
    });
    if (filtered.length === 0) {
      htmlContent = '<p>Aucune facture en attente de paiement.</p>';
    } else {
      htmlContent = '<table style="width:100%; border-collapse:collapse; font-size:13px;">' +
        '<thead><tr>' +
        '<th style="text-align:left; padding:6px 4px;">N¬∞</th>' +
        '<th style="text-align:left; padding:6px 4px;">Client</th>' +
        '<th style="text-align:left; padding:6px 4px;">Statut</th>' +
        '<th style="text-align:right; padding:6px 4px;">Montant</th>' +
        '</tr></thead><tbody>';
      filtered.forEach(function(inv) {
        const num = inv.invoice_number || ('#' + inv.id);
        const total = (parseFloat(inv.total_ttc || 0) || 0).toFixed(2) + ' ‚Ç¨';
        const status = inv.status || '';
        htmlContent += '<tr>' +
          '<td style="padding:4px 4px;">' + num + '</td>' +
          '<td style="padding:4px 4px;">' + (inv.client_name || '') + '</td>' +
          '<td style="padding:4px 4px;">' + status + '</td>' +
          '<td style="padding:4px 4px; text-align:right;">' + total + '</td>' +
        '</tr>';
      });
      htmlContent += '</tbody></table>';
    }
  } else if (type === 'clients') {
  titleEl.textContent = 'Clients propri√©taires';
  if (!clients || clients.length === 0) {  // CHANG√â: clientsList ‚Üí clients
    htmlContent = '<p>Aucun client pour le moment.</p>';
  } else {
   htmlContent = '<ul style="list-style:none; padding:0; margin:0; font-size:13px;">';
clients.forEach(function(c) {
  const name = c.company_name || ((c.first_name || '') + ' ' + (c.last_name || '')).trim();
  htmlContent += 
    '<li style="padding:8px 0; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center;">' +
      '<span>' + name + '</span>' +
      '<button onclick="editClient(' + c.id + ')" style="padding:4px 12px; background:#10b981; color:white; border:none; border-radius:6px; cursor:pointer; font-size:12px;">‚úèÔ∏è Modifier</button>' +
    '</li>';
});
htmlContent += '</ul>';
  }
  } else {
    titleEl.textContent = 'D√©tails';
    htmlContent = '<p>Aucune donn√©e √† afficher.</p>';
  }

  bodyEl.innerHTML = htmlContent;
  modal.classList.add('active');
};

window.closeStatsModal = function() {
  const modal = document.getElementById('statsModal');
  if (modal) modal.classList.remove('active');
};


async function loadInvoices() {
  console.log('üîç loadInvoices() - D√©but...');
  try {
    console.log('üì° Appel API /api/owner-invoices...');
    const res = await fetch('/api/owner-invoices', {
      headers: { Authorization: 'Bearer ' + token }
    });
    console.log('üì° R√©ponse re√ßue, status:', res.status);
    
    const data = await res.json();
    console.log('üì¶ Donn√©es re√ßues:', data);
    
    const invs = data.invoices || [];
    console.log('üìä Nombre de factures:', invs.length);
    
    window.ownerInvoices = invs;

    const container = document.getElementById('invoicesCardsGrid');
    console.log('üìç Container trouv√©:', !!container);

    if (invs.length === 0) {
      console.log('‚ö†Ô∏è Aucune facture trouv√©e');
      container.innerHTML = '<div style="padding:40px; text-align:center; grid-column: 1 / -1;">Aucune facture.</div>';
      document.getElementById('statsRevenue').textContent = '0,00 ‚Ç¨';
      document.getElementById('statsPending').textContent = '0,00 ‚Ç¨';
      return;
    }

    let totalRev = 0;
    let totalPending = 0;
    container.innerHTML = '';
    
    console.log('üîÑ G√©n√©ration des cartes de factures...');

    invs.forEach(function(inv) {
      const total = parseFloat(inv.total_ttc || 0) || 0;
      const status = inv.status || '';

      // Total factur√© : toutes les factures non brouillon et non avoir
      if (!inv.is_credit_note && status !== 'draft') {
        totalRev += total;
      }

      // En attente : factures non brouillon, non avoir, non pay√©es
      if (!inv.is_credit_note && status !== 'draft' && status !== 'paid') {
        totalPending += total;
      }

      const numberDisplay = inv.invoice_number || ('Brouillon #' + inv.id);

      let statusLabel = status;
      let statusClass = 'invoice-badge-draft';
      if (inv.is_credit_note) {
        statusLabel = 'Avoir';
        statusClass = 'invoice-badge-credit';
      } else if (status === 'draft') {
        statusLabel = 'Brouillon';
        statusClass = 'invoice-badge-draft';
      } else if (status === 'invoiced') {
        statusLabel = 'Factur√©e';
        statusClass = 'invoice-badge-invoiced';
      } else if (status === 'sent') {
        statusLabel = 'Envoy√©e';
        statusClass = 'invoice-badge-sent';
      } else if (status === 'paid') {
        statusLabel = 'Pay√©e';
        statusClass = 'invoice-badge-paid';
      }

      let actionsHtml = '';

      if (inv.is_credit_note) {
        actionsHtml =
          '<button type="button" onclick="viewOwnerInvoiceReadOnly(' + inv.id + ')">Voir la facture</button>' +
          '<button type="button" onclick="downloadOwnerInvoice(' + inv.id + ')">T√©l√©charger (PDF)</button>' +
          '<button type="button" onclick="sendOwnerInvoice(' + inv.id + ')">Envoyer par email</button>' +
          '<button type="button" onclick="deleteOwnerInvoice(' + inv.id + ')" style="color:#b91c1c;">Supprimer</button>';
      } else if (status === 'draft') {
        actionsHtml =
          '<button type="button" onclick="viewOwnerInvoiceReadOnly(' + inv.id + ')">Voir la facture</button>' +
          '<button type="button" onclick="finalizeOwnerInvoice(' + inv.id + ')">Passer en ‚ÄúFactur√©e‚Äù</button>' +
          '<button type="button" onclick="sendOwnerInvoice(' + inv.id + ')">Envoyer par email</button>' +
          '<button type="button" onclick="deleteOwnerInvoice(' + inv.id + ')" style="color:#b91c1c;">Supprimer le brouillon</button>';
      } else {
        let paidBtn = '';
        if (status !== 'paid') {
          paidBtn = '<button type="button" onclick="markOwnerInvoicePaid(' + inv.id + ')">Marquer comme encaiss√©e</button>';
        }

        actionsHtml =
          '<button type="button" onclick="viewOwnerInvoiceReadOnly(' + inv.id + ')">Voir la facture</button>' +
          paidBtn +
          '<button type="button" onclick="createOwnerCreditNote(' + inv.id + ')">Cr√©er un avoir</button>' +
          '<button type="button" onclick="downloadOwnerInvoice(' + inv.id + ')">T√©l√©charger (PDF)</button>' +
          '<button type="button" onclick="sendOwnerInvoice(' + inv.id + ')">Envoyer par email</button>' +
          '<button type="button" onclick="deleteOwnerInvoice(' + inv.id + ')" style="color:#b91c1c;">Supprimer</button>';
      }

      const issueDate = inv.issue_date ? new Date(inv.issue_date).toLocaleDateString() : '';

      const cardHtml =
        '<div class="invoice-card">' +
          '<div class="invoice-card-header">' +
            '<div class="invoice-card-number">' + numberDisplay + '</div>' +
            '<span class="invoice-card-badge ' + statusClass + '">' + statusLabel + '</span>' +
          '</div>' +
          '<div class="invoice-card-body">' +
            '<div class="invoice-info-grid">' +
              '<div class="invoice-info-item">' +
                '<div class="invoice-info-label">Client</div>' +
                '<div class="invoice-info-value">' + (inv.client_name || '-') + '</div>' +
              '</div>' +
              '<div class="invoice-info-item">' +
                '<div class="invoice-info-label">Date</div>' +
                '<div class="invoice-info-value">' + issueDate + '</div>' +
              '</div>' +
              '<div class="invoice-info-item">' +
                '<div class="invoice-info-label">Montant TTC</div>' +
                '<div class="invoice-info-value amount">' + formatMoney(total) + '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<div class="invoice-card-footer">' +
            '<button type="button" class="invoice-card-actions-btn" onclick="toggleInvoiceActions(' + inv.id + ', this)">' +
              '<i class="fas fa-ellipsis-v"></i> Actions' +
            '</button>' +
            '<div class="invoice-actions-menu" id="invoice-actions-' + inv.id + '">' +
              actionsHtml +
            '</div>' +
          '</div>' +
        '</div>';

      container.innerHTML += cardHtml;
    });

    document.getElementById('statsRevenue').textContent = formatMoney(totalRev);
    document.getElementById('statsPending').textContent = formatMoney(totalPending);
    console.log('‚úÖ loadInvoices() - Termin√© avec succ√®s');
  } catch (e) {
    console.error('‚ùå loadInvoices() - Erreur:', e);
    const container = document.getElementById('invoicesCardsGrid');
    if (container) {
      container.innerHTML = '<div style="padding:40px; text-align:center; grid-column: 1 / -1; color:#dc2626;">Erreur lors du chargement des factures. Veuillez r√©essayer.</div>';
    }
  }
}



let editingClientId = null;
window.toggleInvoiceActions = function (id, btn) {
  const menu = document.getElementById('invoice-actions-' + id);
  if (!menu) return;

  const wasOpen = menu.classList.contains('open');

  // Fermer tous les autres menus ouverts
  document.querySelectorAll('.invoice-actions-menu.open')
    .forEach(m => m.classList.remove('open'));

  if (wasOpen) {
    // si celui-l√† √©tait d√©j√† ouvert, on le referme et basta
    return;
  }

  // On calcule la position du bouton dans la fen√™tre
  const rect = btn.getBoundingClientRect();

  // Positionner le menu juste sous le bouton, align√© √† droite
  const approxWidth = 200; // largeur approximative du menu
  menu.style.top = (rect.bottom + 8) + 'px';
  menu.style.left = (rect.right - approxWidth) + 'px';

  menu.classList.add('open');
};

// Fermer le menu si on clique ailleurs dans la page
document.addEventListener('click', function(e) {
  // V√©rifier si le clic est en dehors d'un menu ou d'un bouton "..."
  if (!e.target.closest('.invoice-row-actions')) {
    document.querySelectorAll('.invoice-actions-menu.open')
      .forEach(m => m.classList.remove('open'));
  }
});


// Envoyer la facture (brouillon -> envoy√©e)
window.sendOwnerInvoice = async function (id) {
  if (!confirm('Envoyer cette facture au client ?')) return;

  try {
    const res = await fetch('/api/owner-invoices/' + id + '/send', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + token }
    });
    const json = await res.json();
    if (!res.ok) {
      console.error(json);
      return alert(json.error || 'Erreur lors de l\'envoi');
    }
    alert('Facture envoy√©e ‚úÖ');
    loadInvoices();
  } catch (e) {
    console.error(e);
    alert('Erreur serveur');
  }
};

// Supprimer un brouillon
// Supprimer un brouillon
window.deleteOwnerInvoice = async function (id) {
  if (!confirm('Supprimer cette facture ?')) return;

  try {
    const res = await fetch('/api/owner-invoices/' + id, {
      method: 'DELETE',
      headers: { 'Authorization': 'Bearer ' + token }
    });
    const json = await res.json();
    if (!res.ok) {
      console.error(json);
      return alert(json.error || 'Erreur lors de la suppression');
    }
    loadInvoices();
  } catch (e) {
    console.error(e);
    alert('Erreur serveur');
  }
};
  window.downloadOwnerInvoice = async function (id) {
  try {
    // R√©cup√©rer les donn√©es de la facture
    const res = await fetch('/api/owner-invoices/' + id, {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    
    if (!res.ok) throw new Error('Erreur chargement facture');
    
    const json = await res.json();
    const inv = json.invoice;
    const items = json.items || [];
    
    // Trouver le client
    const client = clients.find(c => c.id == inv.client_id);
    const clientName = client ? (client.company_name || `${client.first_name || ''} ${client.last_name || ''}`.trim()) : 'Client';
    
    // Cr√©er un conteneur temporaire invisible avec la facture
    const tempContainer = document.createElement('div');
    tempContainer.style.position = 'fixed';
    tempContainer.style.left = '-9999px';
    tempContainer.style.top = '0';
    document.body.appendChild(tempContainer);
    
    // G√©n√©rer le HTML de la facture
    let itemsHtml = '';
    items.forEach(item => {
      const desc = item.description || 'Prestation';
      const qty = item.quantity || 1;
      const price = parseFloat(item.unit_price || 0);
      const total = parseFloat(item.total || 0);
      
      itemsHtml += `
        <tr>
    <tr style="border-bottom:1px solid #f3f4f6;">
      <td style="padding:14px 8px;">${desc}</td>
      <td style="padding:14px 8px;text-align:center;">${qty}</td>
      <td style="padding:14px 8px;text-align:right;">${price.toFixed(2)} ‚Ç¨</td>
      <td style="padding:14px 8px;text-align:right;font-weight:600;">${total.toFixed(2)} ‚Ç¨</td>
    </tr>
      `;
    });
    
    const subtotal = parseFloat(inv.subtotal_ht || 0);
    const vatAmount = parseFloat(inv.vat_amount || 0);
    const totalTtc = parseFloat(inv.total_ttc || 0);
    
    tempContainer.innerHTML = `
  <div id="tempInvoicePaper" style="background:white;width:210mm;padding:20mm;font-family:'Inter',sans-serif;color:#1f2937;box-sizing:border-box;">
    <div style="display:flex;justify-content:space-between;margin-bottom:40px;">
      <div>
        <p style="margin:0;font-size:12px;color:#6b7280;line-height:1.6;">
          Votre conciergerie<br>
          123 Rue de la R√©publique<br>
          75000 Paris<br>
          contact@boostinghost.fr
        </p>
      </div>
      <div style="text-align:right;">
        <h1 style="margin:0 0 8px 0;font-size:28px;font-weight:800;">FACTURE</h1>
        <p style="margin:0;font-size:12px;color:#6b7280;line-height:1.6;">
          N¬∞ ${inv.invoice_number || 'BROUILLON'}<br>
          Date : ${new Date(inv.issue_date).toLocaleDateString('fr-FR')}<br>
          √âch√©ance : ${new Date(inv.due_date).toLocaleDateString('fr-FR')}
        </p>
      </div>
    </div>
    
    <div style="margin-bottom:30px;">
      <p style="margin:0 0 4px 0;font-size:10px;font-weight:700;text-transform:uppercase;color:#9ca3af;">Factur√© √†</p>
      <p style="margin:0;font-size:13px;line-height:1.6;color:#4b5563;">
        <strong>${clientName}</strong>
      </p>
    </div>
    
    <table style="width:100%;border-collapse:collapse;margin-top:25px;">
      <thead>
        <tr style="border-bottom:2px solid #e5e7eb;">
          <th style="text-align:left;padding:10px 8px;font-size:10px;text-transform:uppercase;color:#6b7280;font-weight:600;">DESCRIPTION</th>
          <th style="text-align:center;padding:10px 8px;font-size:10px;text-transform:uppercase;color:#6b7280;font-weight:600;">QT√â</th>
          <th style="text-align:right;padding:10px 8px;font-size:10px;text-transform:uppercase;color:#6b7280;font-weight:600;">P.U. HT</th>
          <th style="text-align:right;padding:10px 8px;font-size:10px;text-transform:uppercase;color:#6b7280;font-weight:600;">TOTAL HT</th>
        </tr>
      </thead>
      <tbody>
        ${itemsHtml}
      </tbody>
    </table>
    
    <div style="display:flex;justify-content:flex-end;margin-top:30px;">
      <div style="width:220px;">
        <div style="display:flex;justify-content:space-between;padding:8px 0;font-size:13px;color:#4b5563;">
          <span>Total HT</span>
          <span style="font-weight:600;">${subtotal.toFixed(2)} ‚Ç¨</span>
        </div>
        ${vatAmount > 0 ? `
        <div style="display:flex;justify-content:space-between;padding:8px 0;font-size:13px;color:#4b5563;">
          <span>TVA (${inv.vat_rate}%)</span>
          <span style="font-weight:600;">${vatAmount.toFixed(2)} ‚Ç¨</span>
        </div>
        ` : ''}
        <div style="display:flex;justify-content:space-between;padding:12px 0 8px 0;font-size:16px;font-weight:700;color:#10B981;border-top:2px solid #e5e7eb;margin-top:8px;">
          <span>Total TTC</span>
          <span>${totalTtc.toFixed(2)} ‚Ç¨</span>
        </div>
      </div>
    </div>
  </div>
`;
    
    const invoiceElement = document.getElementById('tempInvoicePaper');
    const filename = `${inv.invoice_number || 'facture'}.pdf`;
    
    // Charger html2pdf dynamiquement
    if (typeof html2pdf === 'undefined') {
  const script = document.createElement('script');
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
  script.onload = () => {
    const opt = {
      margin: 0,
      filename: filename,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { 
        scale: 2,
        useCORS: true,
        letterRendering: true
      },
      jsPDF: { 
        unit: 'mm', 
        format: 'a4', 
        orientation: 'portrait',
        compress: true
      }
    };
    html2pdf().set(opt).from(invoiceElement).save().then(() => {
      document.body.removeChild(tempContainer);
    });
  };
  document.head.appendChild(script);
} else {
  const opt = {
    margin: 0,
    filename: filename,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { 
      scale: 2,
      useCORS: true,
      letterRendering: true
    },
    jsPDF: { 
      unit: 'mm', 
      format: 'a4', 
      orientation: 'portrait',
      compress: true
    }
  };
  html2pdf().set(opt).from(invoiceElement).save().then(() => {
    document.body.removeChild(tempContainer);
  });
}
    
  } catch (err) {
    console.error(err);
    alert('Erreur lors du t√©l√©chargement');
  }
};

window.finalizeOwnerInvoice = async function (id) {
  if (!confirm('Passer cette facture en ‚ÄúFactur√©e‚Äù ?')) return;

  try {
    const res = await fetch('/api/owner-invoices/' + id + '/finalize', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + token }
    });
    const json = await res.json();
    if (!res.ok) {
      console.error(json);
      return alert(json.error || 'Erreur lors de la validation');
    }
    alert('Facture pass√©e en ‚ÄúFactur√©e‚Äù ‚úÖ');
    loadInvoices();
  } catch (e) {
    console.error(e);
    alert('Erreur serveur');
  }
};


window.markOwnerInvoicePaid = async function (id) {
  if (!confirm('Marquer cette facture comme encaiss√©e ?')) return;

  try {
    const res = await fetch('/api/owner-invoices/' + id + '/mark-paid', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token 
      }
    });
    const json = await res.json();
    if (!res.ok) {
      console.error(json);
      return alert(json.error || 'Erreur lors de la mise √† jour du paiement');
    }
    alert('Facture marqu√©e comme encaiss√©e ‚úÖ');
    loadInvoices();
  } catch (e) {
    console.error(e);
    alert('Erreur serveur');
  }
};


window.editClient = function(clientId) {
    const client = clients.find(c => c.id == clientId);
    if (!client) {
        alert("Client introuvable.");
        return;
    }

    editingClientId = clientId;

    const titleEl = document.getElementById('clientModalTitle');
    if (titleEl) titleEl.textContent = 'Modifier le client';

    const type = client.client_type || (client.company_name ? 'business' : 'individual');
    const radio = document.querySelector(`input[name="clientType"][value="${type}"]`);
    if (radio) radio.checked = true;
    toggleClientType();

    document.getElementById("clientFirstName").value   = client.first_name   || "";
    document.getElementById("clientLastName").value    = client.last_name    || "";
    document.getElementById("clientCompanyName").value = client.company_name || "";
    document.getElementById("clientEmail").value       = client.email        || "";
    document.getElementById("clientAddress").value     = client.address      || "";
    document.getElementById("clientPostalCode").value  = client.postal_code  || "";
    document.getElementById("clientCity").value        = client.city         || "";

    document.getElementById("clientModal").classList.add("active");
};

  // --- PRESTATIONS (LOGIQUE M√âTIER RESTAUR√âE) ---
  window.addPrestation = function(type) {
    if (isReadOnlyMode) return;
    prestationCounter++;
    prestations.push({
      id: 'p'+prestationCounter,
      type: type,
      description: type==='commission'?'Loyer du':(type==='cleaning'?'Frais de m√©nage':'D√©bours'),
      rentalAmount: 0, commissionRate: 20, // Sp√©cifique Commission
      quantity: 1, unitPrice: 0, // Sp√©cifique Autres
      isDebours: type === 'debours'
    });
    renderEditorPrestations();
    updatePreview();
  };

  window.updatePrestation = function(id, key, val) {
    if (isReadOnlyMode) return;
  const p = prestations.find(x => x.id === id);
  if (!p) return;

  if (key === 'description') {
    p[key] = val;
  } else {
    // on accepte aussi 5,5 (virgule) que l‚Äôon convertit en nombre
    const cleaned = (val || '').toString().replace(',', '.');
    p[key] = parseFloat(cleaned) || 0;
  }

  // Surtout : on NE re-render PAS toute la liste ici
  updatePreview();
};


  window.removePrestation = function(id) {
    if (isReadOnlyMode) return;
    prestations = prestations.filter(x => x.id !== id);
    renderEditorPrestations();
    updatePreview();
  };

  function renderEditorPrestations() {
    const cont = document.getElementById('prestationsListEditor');
    cont.innerHTML = prestations.map(p => {
      let inputs = '';
      let badgeClass = 'badge-other';
      
      // LOGIQUE D'AFFICHAGE SELON LE TYPE (Comme dans ton ancien fichier)
      if(p.type === 'commission') {
        badgeClass = 'badge-commission';
        inputs = `
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <div><label style="font-size:10px;">Loyer (‚Ç¨)</label><input type="number" class="form-control" value="${p.rentalAmount}" oninput="updatePrestation('${p.id}','rentalAmount',this.value)"></div>
            <div><label style="font-size:10px;">Taux (%)</label><input type="number" class="form-control" value="${p.commissionRate}" oninput="updatePrestation('${p.id}','commissionRate',this.value)"></div>
          </div>`;
      } else {
        badgeClass = p.type === 'cleaning' ? 'badge-cleaning' : (p.type === 'debours' ? 'badge-debours' : 'badge-other');
        inputs = `
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <div><label style="font-size:10px;">Qt√©</label><input type="number" class="form-control" value="${p.quantity}" oninput="updatePrestation('${p.id}','quantity',this.value)"></div>
            <div><label style="font-size:10px;">Prix U.</label><input type="number" class="form-control" value="${p.unitPrice}" oninput="updatePrestation('${p.id}','unitPrice',this.value)"></div>
          </div>`;
      }

      return `
        <div class="prestation-mini-card">
<div style="position:absolute;top:8px;right:8px;display:flex;gap:4px;">
  <button class="remove-line-btn" onclick="duplicatePrestation('${p.id}')" title="Dupliquer" style="background:#10b981;">
    <i class="fas fa-copy"></i>
  </button>
  <button class="remove-line-btn" onclick="removePrestation('${p.id}')" title="Supprimer">
    <i class="fas fa-times"></i>
  </button>
</div>         
<span class="prestation-badge ${badgeClass}">${p.type.toUpperCase()}</span>
          <div class="form-group" style="margin-bottom:8px;">
            <input type="text" class="form-control" value="${p.description}" oninput="updatePrestation('${p.id}','description',this.value)">
          </div>
          ${inputs}
          <div style="text-align:right; font-weight:700; font-size:12px; margin-top:8px;">
            ${calculateLineTotal(p).toFixed(2)} ‚Ç¨
          </div>
        </div>
      `;
    }).join('');
  }
window.duplicatePrestation = function(id) {
  if (isReadOnlyMode) return;
  const original = prestations.find(x => x.id === id);
  if (!original) return;
  
  // Cr√©er une copie avec un nouvel ID
  const duplicate = {
    ...original,
    id: 'p_' + Date.now()
  };
  
  prestations.push(duplicate);
  renderEditorPrestations();
  updatePreview();
};
  function calculateLineTotal(p) {
    if(p.type === 'commission') return p.rentalAmount * (p.commissionRate/100);
    return p.quantity * p.unitPrice;
  }


  function loadEmitterProfile() {
    try {
      const saved = JSON.parse(localStorage.getItem('lcc_owner_emitter_profile') || '{}');
      emitterProfile = { ...emitterProfile, ...saved };

      const companyInput = document.getElementById('emitterCompany');
      const addressInput = document.getElementById('emitterAddress');
      const postalInput = document.getElementById('emitterPostalCode');
      const cityInput = document.getElementById('emitterCity');
      const siretInput = document.getElementById('emitterSiret');

      if (companyInput) companyInput.value = emitterProfile.company || '';
      if (addressInput) addressInput.value = emitterProfile.address || '';
      if (postalInput) postalInput.value = emitterProfile.postalCode || '';
      if (cityInput) cityInput.value = emitterProfile.city || '';
      if (siretInput) siretInput.value = emitterProfile.siret || '';

      updateSenderAddressFromProfile();
      updateSenderPreviewOnly();

// Charger le logo depuis le profil utilisateur
if (window.userProfile && window.userProfile.logoUrl) {
  const logoContainer = document.getElementById('paperLogoContainer');
  if (logoContainer) {
    logoContainer.innerHTML = '<img src="' + window.userProfile.logoUrl + '" class="paper-logo-img">';
  }
} else if (emitterProfile.logoDataUrl) {
  // Fallback sur l'ancien syst√®me
  const logoContainer = document.getElementById('paperLogoContainer');
  if (logoContainer) {
    logoContainer.innerHTML = '<img src="' + emitterProfile.logoDataUrl + '" class="paper-logo-img">';
  }
}
    } catch (e) {
      console.warn('Impossible de charger le profil √©metteur', e);
    }
  }

  function saveEmitterProfile() {
    try {
      localStorage.setItem('lcc_owner_emitter_profile', JSON.stringify(emitterProfile));
    } catch (e) {
      console.warn('Impossible d\'enregistrer le profil √©metteur', e);
    }
  }

  window.updateEmitterProfile = function () {
    const companyInput = document.getElementById('emitterCompany');
    const addressInput = document.getElementById('emitterAddress');
    const postalInput = document.getElementById('emitterPostalCode');
    const cityInput = document.getElementById('emitterCity');
    const siretInput = document.getElementById('emitterSiret');

    emitterProfile.company = companyInput ? companyInput.value.trim() : '';
    emitterProfile.address = addressInput ? addressInput.value.trim() : '';
    emitterProfile.postalCode = postalInput ? postalInput.value.trim() : '';
    emitterProfile.city = cityInput ? cityInput.value.trim() : '';
    emitterProfile.siret = siretInput ? siretInput.value.trim() : '';

    updateSenderAddressFromProfile();
    saveEmitterProfile();
    updateSenderPreviewOnly();
    updatePreview();
  };

  function updateSenderAddressFromProfile() {
    const parts = [];
    if (emitterProfile.address) parts.push(emitterProfile.address);
    const cityLine = (emitterProfile.postalCode || '') + ' ' + (emitterProfile.city || '');
    if (cityLine.trim()) parts.push(cityLine.trim());
    if (emitterProfile.siret) parts.push('SIRET : ' + emitterProfile.siret);

    const textarea = document.getElementById('senderAddressInput');
    if (textarea) {
      textarea.value = parts.join('\n');
    }
  }

  function updateSenderPreviewOnly() {
    let name = emitterProfile.company;
    if (!name && currentUser) {
      if (currentUser.company) name = currentUser.company;
      else {
        const first = currentUser.firstName || '';
        const last = currentUser.last_name || currentUser.lastName || '';
        name = (first + ' ' + last).trim();
      }
    }
    if (!name) name = 'Votre Entreprise';

    const senderNameEl = document.getElementById('previewSenderName');
    if (senderNameEl) senderNameEl.textContent = name;

    const addrTextarea = document.getElementById('senderAddressInput');
    const addr = (addrTextarea && addrTextarea.value) || '';
    const senderAddrEl = document.getElementById('previewSenderAddress');
    if (senderAddrEl) senderAddrEl.innerText = addr || 'Adresse...';
  }

  // --- PREVIEW ---
  window.updatePreview = function() {
    // Client
    const cliId = document.getElementById('invoiceClientId').value;
    const client = clients.find(c => String(c.id) === cliId);
    if(client) {
      const name = client.company_name || `${client.first_name} ${client.last_name}`;
      document.getElementById('previewClientName').textContent = name;
      document.getElementById('previewClientDetails').innerHTML = `${client.address || ''}<br>${client.postal_code || ''} ${client.city || ''}`;
    }

    // Dates
    const dIss = document.getElementById('invoiceIssueDate').valueAsDate;
    const dStart = document.getElementById('invoicePeriodStart').valueAsDate;
    const dEnd = document.getElementById('invoicePeriodEnd').valueAsDate;
    
    if(dIss) document.getElementById('previewDate').textContent = dIss.toLocaleDateString();
    if(dStart && dEnd) document.getElementById('previewPeriod').textContent = `${dStart.toLocaleDateString()} au ${dEnd.toLocaleDateString()}`;

    // Afficher le logo si pr√©sent
    if (window.userProfile && window.userProfile.logoUrl) {
      const logoImg = document.getElementById('previewLogoImg');
      if (logoImg) {
        logoImg.src = window.userProfile.logoUrl;
        logoImg.style.display = 'block';
      }
      const logoPlaceholder = document.getElementById('previewLogoPlaceholder');
      if (logoPlaceholder) {
        logoPlaceholder.style.display = 'none';
      }
    }
    // Afficher les logements s√©lectionn√©s
    const selectedProps = getSelectedProperties();
    const propertyContainer = document.getElementById('previewProperties');

    if (selectedProps.length > 0 && window.allProperties) {
      const propNames = selectedProps.map(id => {
        const prop = window.allProperties.find(p => p.id === id);
        return prop ? prop.name : '';
      }).filter(Boolean);
      
      if (propertyContainer) {
        propertyContainer.textContent = propNames.join(', ');
        propertyContainer.parentElement.style.display = 'block';
      }
    } else {
      if (propertyContainer) {
        propertyContainer.parentElement.style.display = 'none';
      }
    }
    // Sender
    const sender = document.getElementById('senderAddressInput').value;
    if(sender) document.getElementById('previewSenderAddress').textContent = sender;

    // Totaux
    const tbody = document.getElementById('previewBody');
    tbody.innerHTML = '';
    let totalHT = 0;

    prestations.forEach(p => {
      const lineTotal = calculateLineTotal(p);
      totalHT += lineTotal;
      
      let qtyDisplay = p.type === 'commission' ? `${p.rentalAmount}‚Ç¨` : p.quantity;
      let priceDisplay = p.type === 'commission' ? `${p.commissionRate}%` : `${p.unitPrice}‚Ç¨`;

      tbody.innerHTML += `
        <tr>
          <td>${p.description}</td>
          <td style="text-align:center;">${qtyDisplay}</td>
          <td style="text-align:right;">${priceDisplay}</td>
          <td style="text-align:right; font-weight:600;">${lineTotal.toFixed(2)} ‚Ç¨</td>
        </tr>`;
    });

        // --- TVA ---

    const hasVat = document.getElementById('invoiceVatApplicable').checked;
    const vatRateInput = document.getElementById('invoiceVatRate');

    // Affiche / cache le champ de taux
    if (vatRateInput) {
      vatRateInput.style.display = hasVat ? 'inline-block' : 'none';
    }

    // Lecture du taux (on supporte 5.5, 10, 20, etc.)
    let rateValue = 20;
    if (vatRateInput) {
      const cleanedRate = vatRateInput.value.toString().replace(',', '.');
      rateValue = parseFloat(cleanedRate) || 20;
    }

    const vatRate = hasVat ? rateValue / 100 : 0;

    const vatAmount = totalHT * vatRate;
    const totalTTC = totalHT + vatAmount;

    // --- M√†J affichage totaux ---

    const strHT  = totalHT.toFixed(2) + ' ‚Ç¨';
    const strVAT = vatAmount.toFixed(2) + ' ‚Ç¨';
    const strTTC = totalTTC.toFixed(2) + ' ‚Ç¨';

    // Bloc de droite (√©diteur)
    const elHT  = document.getElementById('displayTotalHT');
    const elTVA = document.getElementById('displayTotalVAT');
    const elTTC = document.getElementById('displayTotalTTC');
    if (elHT)  elHT.textContent  = strHT;
    if (elTVA) elTVA.textContent = strVAT;
    if (elTTC) elTTC.textContent = strTTC;

    // Facture (aper√ßu papier)
    const pHT  = document.getElementById('previewTotalHT');
    const pTVA = document.getElementById('previewTotalVAT');
    const pTTC = document.getElementById('previewTotalTTC');
    if (pHT)  pHT.textContent  = strHT;
    if (pTVA) pTVA.textContent = strVAT;
    if (pTTC) pTTC.textContent = strTTC;

    // Mention "TVA non applicable, art. 293 B du CGI"
    const mentionEl = document.getElementById('previewVatLegalMention');
    if (mentionEl) {
      mentionEl.style.display = hasVat ? 'none' : 'block';
    }


  
  };

// --- LOGO ---
  window.updateLogoPreview = function() {
  const file = document.getElementById('logoInput').files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const dataUrl = e.target.result;
      // Afficher l'aper√ßu temporaire dans l'√©diteur
      const logoPreviewImg = document.getElementById('logoPreviewImg');
      if (logoPreviewImg) {
        logoPreviewImg.src = dataUrl;
        logoPreviewImg.style.display = 'block';
      }
      const logoPlaceholder = document.getElementById('logoPlaceholder');
      if (logoPlaceholder) {
        logoPlaceholder.style.display = 'none';
      }
      
      // Afficher sur la facture
      const cont = document.getElementById('paperLogoContainer');
      if (cont) {
        cont.innerHTML = `<img src="${dataUrl}" class="paper-logo-img">`;
      }
    };
    reader.readAsDataURL(file);
  }
};
function getSelectedProperties() {
  const checkboxes = document.querySelectorAll('.property-checkbox:checked');
  return Array.from(checkboxes).map(cb => cb.value);
}
  // --- SAVE ---
  window.createInvoice = async function(send) {
    const clientId = document.getElementById('invoiceClientId').value;
    if(!clientId) return alert('Veuillez s√©lectionner un client');

    const data = {
      clientId: parseInt(clientId),
      periodStart: document.getElementById('invoicePeriodStart').value,
      periodEnd: document.getElementById('invoicePeriodEnd').value,
      issueDate: document.getElementById('invoiceIssueDate').value,
      dueDate: document.getElementById('invoiceDueDate').value,
      items: prestations.map(p => ({
        itemType: p.type,
        description: p.description,
        rentalAmount: p.rentalAmount,
        commissionRate: p.commissionRate,
        quantity: p.quantity,
        unitPrice: p.unitPrice,
        total: calculateLineTotal(p),
        isDebours: p.isDebours
      })),
      vatApplicable: document.getElementById('invoiceVatApplicable').checked,
      vatRate: parseFloat(document.getElementById('invoiceVatRate').value),
      propertyIds: getSelectedProperties(),
      sendEmail: send
    };

    try {
      const url = editingInvoiceId ? `/api/owner-invoices/${editingInvoiceId}` : '/api/owner-invoices';
      const method = editingInvoiceId ? 'PUT' : 'POST';
      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify(data)
      });
      if (res.ok) {
        alert('‚úÖ Facture enregistr√©e !');
        prestations = [];
        prestationCounter = 0;
        renderEditorPrestations();
        switchTab('dashboard');
        loadInvoices();
      } else {
        const err = await res.json();
        alert('Erreur : ' + err.error);
      }
    } catch (err) {
      console.error(err);
      alert('Erreur serveur');
    }
  };

  window.createNewInvoice = function() {
    // D√©sactiver le mode lecture seule
    isReadOnlyMode = false;
    const sidebar = document.getElementById('editorSidebar');
    if (sidebar) sidebar.classList.remove('readonly');
    const banner = document.getElementById('readonlyBanner');
    if (banner) banner.style.display = 'none';
    
    editingInvoiceId = null;
    prestations = [];
    prestationCounter = 0;
    
    document.getElementById('invoiceClientId').value = '';
    const d = new Date(); 
    document.getElementById('invoiceIssueDate').valueAsDate = d;
    const d2 = new Date(); d2.setDate(d2.getDate()+30);
    document.getElementById('invoiceDueDate').valueAsDate = d2;
    document.getElementById('invoiceVatApplicable').checked = false;
    document.getElementById('invoiceVatRate').value = 20;
    
    renderEditorPrestations();
    updatePreview();
    switchTab('create');
  };
window.viewOwnerInvoiceReadOnly = async function(id) {
  try {
    const res = await fetch('/api/owner-invoices/' + id, {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    const json = await res.json();

    if (!res.ok) {
      console.error(json);
      return alert(json.error || 'Erreur lors du chargement de la facture');
    }

    const inv = json.invoice;
    const items = json.items || [];

    // Activer le mode lecture seule
    isReadOnlyMode = true;
    editingInvoiceId = inv.id;
    
    // Afficher la banni√®re et d√©sactiver les contr√¥les
    document.getElementById('editorSidebar').classList.add('readonly');
    document.getElementById('readonlyBanner').style.display = 'block';

    // Remplir les champs
    const clientSelect = document.getElementById('invoiceClientId');
    if (clientSelect) clientSelect.value = inv.client_id;

    if (inv.issue_date) {
      document.getElementById('invoiceIssueDate').value = inv.issue_date.slice(0,10);
    }
    if (inv.due_date) {
      document.getElementById('invoiceDueDate').value = inv.due_date.slice(0,10);
    }
    if (inv.period_start) {
      document.getElementById('invoicePeriodStart').value = inv.period_start.slice(0,10);
    }
    if (inv.period_end) {
      document.getElementById('invoicePeriodEnd').value = inv.period_end.slice(0,10);
    }

    document.getElementById('invoiceVatApplicable').checked = !!inv.vat_applicable;
    document.getElementById('invoiceVatRate').value = inv.vat_rate || 20;

    // Recr√©er les prestations
    prestations = [];
    prestationCounter = 0;

    items.forEach(item => {
      prestationCounter++;
      prestations.push({
        id: 'p' + prestationCounter,
        type: item.item_type,
        description: item.description || '',
        rentalAmount: parseFloat(item.rental_amount) || 0,
        commissionRate: parseFloat(item.commission_rate) || 0,
        quantity: parseFloat(item.quantity) || 0,
        unitPrice: parseFloat(item.unit_price) || 0,
        isDebours: item.is_debours
      });
    });

    renderEditorPrestations();
    updatePreview();
    switchTab('create');

  } catch (err) {
    console.error(err);
    alert('Erreur serveur lors du chargement de la facture');
  }
};

  // --- CLIENT MODAL ---
  window.openClientModal = function() {
    editingClientId = null;

    const titleEl = document.getElementById('clientModalTitle');
    if (titleEl) titleEl.textContent = 'Nouveau client';

    const radioInd = document.querySelector('input[name="clientType"][value="individual"]');
    if (radioInd) radioInd.checked = true;
    toggleClientType();

    ['clientFirstName','clientLastName','clientCompanyName','clientEmail','clientAddress','clientPostalCode','clientCity']
      .forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });

    document.getElementById('clientModal').classList.add('active');
  };
  window.editClient = function(clientId) {
  const client = clients.find(c => c.id == clientId);
  if (!client) {
    alert('Client introuvable');
    return;
  }
  
  editingClientId = clientId;
  
  const titleEl = document.getElementById('clientModalTitle');
  if (titleEl) titleEl.textContent = 'Modifier le client';
  
  // Cocher le bon type
  if (client.client_type === 'business') {
    document.querySelector('input[name="clientType"][value="business"]').checked = true;
  } else {
    document.querySelector('input[name="clientType"][value="individual"]').checked = true;
  }
  toggleClientType();
  
  // Remplir les champs
  document.getElementById('clientFirstName').value = client.first_name || '';
  document.getElementById('clientLastName').value = client.last_name || '';
  document.getElementById('clientCompanyName').value = client.company_name || '';
  document.getElementById('clientEmail').value = client.email || '';
  document.getElementById('clientAddress').value = client.address || '';
  document.getElementById('clientPostalCode').value = client.postal_code || '';
  document.getElementById('clientCity').value = client.city || '';
  
  // Ouvrir le modal
  document.getElementById('clientModal').classList.add('active');
  
  // Fermer la modal des stats
  closeStatsModal();
};
  window.closeClientModal = function() {
    document.getElementById('clientModal').classList.remove('active');
    editingClientId = null;
  };
  window.toggleClientType = function() {
    const t = document.querySelector('input[name="clientType"]:checked').value;
    document.getElementById('individualFields').style.display = t==='individual'?'block':'none';
    document.getElementById('businessFields').style.display = t==='business'?'block':'none';
  };

  window.saveClient = async function() {
    const type = document.querySelector('input[name="clientType"]:checked').value;

    const payload = {
        clientType: type,
        firstName: document.getElementById('clientFirstName').value,
        lastName: document.getElementById('clientLastName').value,
        companyName: document.getElementById('clientCompanyName').value,
        email: document.getElementById('clientEmail').value,
        address: document.getElementById('clientAddress').value,
        postalCode: document.getElementById('clientPostalCode').value,
        city: document.getElementById('clientCity').value,
        defaultCommissionRate: 20
    };

    let url = "/api/owner-clients";
    let method = "POST";

    if (editingClientId !== null) {
        url = `/api/owner-clients/${editingClientId}`;
        method = "PUT";
    }

    try {
        const res = await fetch(url, {
            method,
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify(payload)
        });

        const json = await res.json();
        if (!res.ok) return alert(json.error || "Erreur serveur");

        alert(editingClientId ? "Client mis √† jour !" : "Client ajout√© !");

        closeClientModal();
        await loadClients();
    } catch (err) {
        console.error(err);
        alert("Erreur serveur");
    }
};

  window.logout = function() {
    localStorage.removeItem('lcc_token');
    window.location.href = '/login.html';
  };

</script>
<script src="/js/bh-layout.js"></script>
<script src="/js/mobile-native-experience.js"></script>
<script src="/js/mobile-tabs-handler.js"></script>
<script src="/js/messages-badge-loader.js"></script>
<script src="/js/messages-badge-dynamic.js"></script>       
</body>
</html>
