<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Boostinghost – Facturation Propriétaires</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="/css/style.css">

  <style>
    /* DESIGN SYSTEM "FACTURE PRO" */
    :root { --primary: #10B981; --bg-body: #f3f4f6; --paper-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }

    html, body { margin: 0; padding: 0; background: var(--bg-body); font-family: 'Inter', sans-serif; height: 100%; overflow-x: hidden; }
    .app-container { display: flex; min-height: 100vh; }

    /* SIDEBAR (Style Vert Identique App) */
    .sidebar { width: 260px; background: white; border-right: 1px solid #e5e7eb; position: fixed; top: 0; bottom: 0; left: 0; z-index: 50; display: flex; flex-direction: column; }
    .sidebar-header { padding: 24px; }
    .sidebar-logo { display: flex; align-items: center; gap: 10px; text-decoration: none; color: #111827; font-weight: 800; font-size: 18px; }
    .nav-section-title { font-size: 11px; font-weight: 700; color: #9ca3af; text-transform: uppercase; margin: 24px 24px 8px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 24px; color: #4b5563; text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s; margin: 0 12px; border-radius: 8px; }
    .nav-item:hover { background: #f9fafb; color: #111827; }
    .nav-item.active { background: #10B981; color: white; }
    .nav-item i { width: 20px; text-align: center; }

    /* MAIN CONTENT */
    .main-wrapper { flex: 1; margin-left: 260px; display: flex; flex-direction: column; min-width: 0; }
    .top-bar { background: white; height: 64px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: flex-end; padding: 0 32px; position: sticky; top: 0; z-index: 40; }
    .main-content { padding: 32px; max-width: 1600px; margin: 0 auto; width: 100%; box-sizing: border-box; }

    /* DASHBOARD */
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
    .page-title { font-size: 24px; font-weight: 700; color: #111827; margin: 0; }
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .stat-card { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .stat-value { font-size: 24px; font-weight: 700; color: #111827; }

    /* TABS */
    .nav-tabs { display: inline-flex; background: #e5e7eb; padding: 4px; border-radius: 10px; margin-bottom: 24px; }
    .nav-tab { padding: 8px 24px; border-radius: 8px; border: none; background: transparent; font-weight: 600; color: #4b5563; cursor: pointer; transition: all 0.2s; }
    .nav-tab.active { background: white; color: #111827; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }

    /* ÉDITEUR FACTURE (Split View) */
    .invoice-editor-layout { display: grid; grid-template-columns: 400px 1fr; gap: 32px; align-items: start; }
    
    /* GAUCHE : Contrôles */
    .editor-sidebar { background: white; border-radius: 16px; border: 1px solid #e5e7eb; position: sticky; top: 88px; max-height: calc(100vh - 120px); overflow-y: auto; display: flex; flex-direction: column; }
    .editor-section { padding: 20px; border-bottom: 1px solid #f3f4f6; }
    .editor-section-title { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #9ca3af; margin-bottom: 12px; }
    
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; color: #374151; }
    .form-control { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px; box-sizing: border-box; }
    
    /* DROITE : Feuille A4 */
    .invoice-preview-container { display: flex; justify-content: center; padding-bottom: 40px; }
    .invoice-paper { background: white; width: 100%; max-width: 800px; min-height: 1000px; padding: 48px; box-shadow: var(--paper-shadow); border-radius: 2px; position: relative; color: #1f2937; }
    
    .paper-header { display: flex; justify-content: space-between; margin-bottom: 40px; }
    .paper-logo-img { max-height: 80px; max-width: 200px; object-fit: contain; margin-bottom: 10px; }
    .paper-sender-address { font-size: 12px; line-height: 1.4; color: #4b5563; white-space: pre-line; }
    
    .paper-table { width: 100%; border-collapse: collapse; margin-top: 32px; }
    .paper-table th { text-align: left; padding: 12px 8px; border-bottom: 2px solid #e5e7eb; font-size: 11px; text-transform: uppercase; color: #6b7280; font-weight: 600; }
    .paper-table td { padding: 16px 8px; border-bottom: 1px solid #f3f4f6; font-size: 13px; }
    
    .paper-totals { display: flex; justify-content: flex-end; margin-top: 32px; }
    .totals-box { width: 260px; }
    .total-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; color: #4b5563; }
    .total-row.final { font-size: 16px; font-weight: 700; color: var(--primary); border-top: 2px solid #e5e7eb; margin-top: 8px; padding-top: 12px; }

    /* LIGNES ÉDITEUR */
    .prestation-mini-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 8px; position: relative; }
    .prestation-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; }
    .badge-commission { background: #dcfce7; color: #166534; }
    .badge-cleaning { background: #dbeafe; color: #1e40af; }
    .badge-debours { background: #fef3c7; color: #92400e; }
    .badge-other { background: #f3f4f6; color: #374151; }
    .remove-line-btn { position: absolute; top: 8px; right: 8px; color: #ef4444; background: none; border: none; cursor: pointer; }

    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: white; border: 1px solid #d1d5db; color: #374151; }
    .btn-xs { padding: 4px 8px; font-size: 11px; }

    /* MODALS */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: white; border-radius: 16px; width: 90%; max-width: 500px; padding: 24px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; }

    @media (max-width: 1024px) {
      .sidebar { transform: translateX(-100%); } .sidebar.active { transform: translateX(0); }
      .main-wrapper { margin-left: 0; } .invoice-editor-layout { grid-template-columns: 1fr; }
      .menu-toggle { display: block; font-size: 20px; background: none; border: none; cursor: pointer; margin-right: 16px; }
    }
    @media (min-width: 1025px) { .menu-toggle { display: none; } }
  </style>
</head>
<body>

<div class="app-container">
  
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <a href="/" class="sidebar-logo">
        <div style="width:32px; height:32px; background:#10B981; border-radius:6px; display:flex; align-items:center; justify-content:center; color:white;"><i class="fas fa-bolt"></i></div>
        <span>Boostinghost</span>
      </a>
    </div>
    <nav class="sidebar-nav" style="flex:1; overflow-y:auto;">
      <div class="nav-section-title">Principal</div>
      <a href="/app.html" class="nav-item"><i class="fas fa-th-large"></i> Dashboard</a>
      <a href="/app.html#calendarSection" class="nav-item"><i class="fas fa-calendar-alt"></i> Calendrier</a>
      <a href="/messages.html" class="nav-item"><i class="fas fa-comment-dots"></i> Messages</a>

      <div class="nav-section-title">Gestion</div>
      <a href="/settings.html" class="nav-item"><i class="fas fa-home"></i> Mes logements</a>
      <a href="/welcome.html" class="nav-item"><i class="fas fa-book-open"></i> Livret d'accueil</a>
      <a href="/cleaning.html" class="nav-item"><i class="fas fa-broom"></i> Gestion du ménage</a>

      <div class="nav-section-title">Facturation</div>
      <a href="/factures.html" class="nav-item"><i class="fas fa-file-invoice"></i> Factures clients</a>
      <a href="/factures-proprietaires.html" class="nav-item active"><i class="fas fa-file-invoice-dollar"></i> Factures propriétaires</a>

      <div class="nav-section-title">Paramètres</div>
      <a href="/settings-account.html" class="nav-item"><i class="fas fa-cog"></i> Paramètres</a>
    </nav>
  </aside>

  <div class="main-wrapper">
    <header class="top-bar">
      <button class="menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('active')"><i class="fas fa-bars"></i></button>
      <div style="display:flex; align-items:center; gap:12px;">
        <div style="text-align:right;">
          <div style="font-weight:600; font-size:14px;" id="userName">Mon Compte</div>
        </div>
        <div style="width:36px; height:36px; background:#e5e7eb; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; color:#374151;">U</div>
      </div>
    </header>

    <main class="main-content">
      <div class="dashboard-header">
        <div><h1 class="page-title">Facturation Propriétaires</h1><p class="page-subtitle" style="color:#6b7280; font-size:14px; margin-top:4px;">Gérez vos revenus.</p></div>
        <button class="btn btn-primary" onclick="switchTab('create')"><i class="fas fa-plus"></i> Nouvelle Facture</button>
      </div>

      <div class="stats-row">
        <div class="stat-card"><span class="stat-label">Total Facturé</span><span class="stat-value" id="statsRevenue">0,00 €</span></div>
        <div class="stat-card"><span class="stat-label">Clients</span><span class="stat-value" id="statsClients">0</span></div>
      </div>

      <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('dashboard')" id="btn-dashboard">Historique</button>
        <button class="nav-tab" onclick="switchTab('create')" id="btn-create">Éditeur</button>
        <button class="nav-tab" onclick="switchTab('clients')" id="btn-clients">Mes Clients</button>
      </div>

      <div id="tab-dashboard" class="tab-content active">
        <div style="background:white; border-radius:12px; border:1px solid #e5e7eb; overflow:hidden;">
          <table style="width:100%; border-collapse:collapse;">
            <thead><tr style="background:#f9fafb; text-align:left; font-size:12px; text-transform:uppercase; color:#6b7280;"><th style="padding:16px;">N°</th><th style="padding:16px;">Client</th><th style="padding:16px;">Date</th><th style="padding:16px;">Montant TTC</th></tr></thead>
            <tbody id="invoicesTableBody"><tr><td colspan="4" style="padding:40px; text-align:center;">Chargement...</td></tr></tbody>
          </table>
        </div>
      </div>

      <div id="tab-create" class="tab-content">
        <div class="invoice-editor-layout">
          <div class="editor-sidebar">
            <div class="editor-section">
              <div class="editor-section-title">Informations</div>
              <div class="form-group">
                <label>Client</label>
                <select class="form-control" id="invoiceClientId" onchange="loadClientDefaults(); updatePreview();">
                  <option value="">Sélectionner...</option>
                </select>
              </div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div class="form-group"><label>Date</label><input type="date" class="form-control" id="invoiceIssueDate" onchange="updatePreview()"></div>
                <div class="form-group"><label>Échéance</label><input type="date" class="form-control" id="invoiceDueDate" onchange="updatePreview()"></div>
              </div>
            </div>

            <div class="editor-section">
              <div class="editor-section-title">Personnalisation</div>
              <div class="form-group">
                <label>Logo Entreprise</label>
                <input type="file" id="logoInput" accept="image/*" class="form-control" onchange="updateLogoPreview()">
              </div>
              <div class="form-group">
                <label>Adresse Émetteur</label>
                <textarea id="senderAddressInput" rows="3" class="form-control" placeholder="Nom Entreprise&#10;Adresse..." oninput="updatePreview()"></textarea>
              </div>
            </div>

            <div class="editor-section">
              <div class="editor-section-title">Lignes</div>
              <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:4px; margin-bottom:12px;">
                <button class="btn-xs btn-secondary" onclick="addPrestation('commission')">% Com</button>
                <button class="btn-xs btn-secondary" onclick="addPrestation('cleaning')">Ménage</button>
                <button class="btn-xs btn-secondary" onclick="addPrestation('other')">Autre</button>
              </div>
              <div id="prestationsListEditor"></div>
            </div>

            <div class="editor-section">
              <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <label style="display:flex; align-items:center; gap:6px; cursor:pointer;"><input type="checkbox" id="invoiceVatApplicable" onchange="updatePreview()"> TVA (20%)</label>
              </div>
              <div style="background:#f9fafb; padding:12px; border-radius:8px; font-size:13px;">
                <div style="display:flex; justify-content:space-between; padding-top:8px; border-top:1px solid #e5e7eb; font-size:15px; font-weight:700;"><span>TOTAL TTC</span><strong id="displayTotalTTC">0.00 €</strong></div>
              </div>
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
                <button class="btn btn-secondary" onclick="createInvoice(false)">Brouillon</button>
                <button class="btn btn-primary" onclick="createInvoice(true)">Valider</button>
              </div>
            </div>
          </div>

          <div class="invoice-preview-container">
            <div class="invoice-paper">
              <div class="paper-header">
                <div>
                  <div id="paperLogoContainer"></div>
                  <div id="paperSenderInfo" style="margin-top:10px;">
                    <div class="paper-sender-address" id="previewSenderAddress">Votre Entreprise<br>Adresse...</div>
                  </div>
                </div>
                <div class="paper-meta">
                  <div style="font-size:32px; font-weight:800;">FACTURE</div>
                  <div style="color:#6b7280; font-size:14px;">N° BROUILLON</div>
                  <div style="margin-top:8px; font-size:12px; color:#4b5563;">Date : <span id="previewDate">-</span></div>
                </div>
              </div>

              <div style="background:#f9fafb; padding:20px; border-radius:8px; margin-bottom:40px;">
                <div style="font-size:11px; font-weight:700; color:#9ca3af; text-transform:uppercase;">Facturé à</div>
                <div style="font-weight:700; font-size:16px; margin-top:4px;" id="previewClientName">Client...</div>
                <div style="font-size:13px; color:#4b5563;" id="previewClientDetails"></div>
              </div>

              <table class="paper-table">
                <thead><tr><th>Description</th><th style="width:80px; text-align:center;">Qté/Base</th><th style="width:80px; text-align:right;">Prix/%</th><th style="width:100px; text-align:right;">Total HT</th></tr></thead>
                <tbody id="previewBody"></tbody>
              </table>

              <div class="paper-totals">
                <div class="totals-box">
                  <div class="total-row"><span>Total HT</span><span id="previewTotalHT">0,00 €</span></div>
                  <div class="total-row"><span>TVA</span><span id="previewTotalVAT">0,00 €</span></div>
                  <div class="total-row final"><span>Net à payer</span><span id="previewTotalTTC">0,00 €</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="tab-clients" class="tab-content">
        <div style="background:white; border-radius:12px; border:1px solid #e5e7eb; padding:24px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0;">Liste des propriétaires</h3>
            <button class="btn btn-primary" onclick="openClientModal()">+ Nouveau Client</button>
          </div>
          <div id="clientsContainer" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:16px;"></div>
        </div>
      </div>
    </main>
  </div>
</div>

<div class="modal-overlay" id="clientModal">
  <div class="modal-content">
    <h3 style="margin-top:0;">Nouveau Client</h3>
    <div style="display:flex; gap:16px; margin-bottom:16px;">
      <label><input type="radio" name="clientType" value="individual" checked> Particulier</label>
      <label><input type="radio" name="clientType" value="business"> Entreprise</label>
    </div>
    <div class="form-group"><label>Nom / Raison Sociale</label><input type="text" id="clientName" class="form-control"></div>
    <div class="form-group"><label>Email</label><input type="email" id="clientEmail" class="form-control"></div>
    <div class="form-group"><label>Adresse</label><input type="text" id="clientAddress" class="form-control"></div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
       <div class="form-group"><label>CP</label><input type="text" id="clientZip" class="form-control"></div>
       <div class="form-group"><label>Ville</label><input type="text" id="clientCity" class="form-control"></div>
    </div>
    <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
      <button onclick="closeClientModal()" class="btn btn-secondary">Annuler</button>
      <button onclick="saveClient()" class="btn btn-primary">Enregistrer</button>
    </div>
  </div>
</div>

<script>
  let token = localStorage.getItem('lcc_token');
  let clients = [];
  let prestations = [];
  let counter = 0;

  // --- INIT ---
  document.addEventListener('DOMContentLoaded', async () => {
    if(!token) return window.location.href='/login.html';
    
    // User
    const user = JSON.parse(localStorage.getItem('lcc_user') || '{}');
    if(user.firstName) {
      document.getElementById('userName').textContent = user.firstName;
      document.getElementById('previewSenderAddress').innerHTML = `<strong>${user.company || user.firstName}</strong><br>Adresse à configurer...`;
      document.getElementById('senderAddressInput').value = `${user.company || user.firstName}\nAdresse...`;
    }

    // Dates
    document.getElementById('invoiceIssueDate').valueAsDate = new Date();
    const d = new Date(); d.setDate(d.getDate()+30);
    document.getElementById('invoiceDueDate').valueAsDate = d;

    await loadClients();
    await loadInvoices();
    addPrestation('commission'); // Ligne par défaut
  });

  // --- TABS ---
  window.switchTab = function(id) {
    document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(e => e.classList.remove('active'));
    document.getElementById('tab-'+id).classList.add('active');
    document.getElementById('btn-'+id).classList.add('active');
  }

  // --- API ---
  async function loadClients() {
    try {
      const res = await fetch('/api/owner-clients', { headers: { Authorization: 'Bearer '+token }});
      const data = await res.json();
      clients = data.clients || [];
      document.getElementById('statsClients').textContent = clients.length;
      
      const sel = document.getElementById('invoiceClientId');
      sel.innerHTML = '<option value="">Sélectionner...</option>';
      const cont = document.getElementById('clientsContainer');
      cont.innerHTML = '';

      clients.forEach(c => {
        const name = c.company_name || c.first_name + ' ' + c.last_name;
        sel.innerHTML += `<option value="${c.id}">${name}</option>`;
        cont.innerHTML += `<div style="background:#f9fafb; padding:16px; border:1px solid #ddd; border-radius:8px;"><strong>${name}</strong><br><small>${c.email}</small></div>`;
      });
    } catch(e){}
  }

  async function loadInvoices() {
    try {
      const res = await fetch('/api/owner-invoices', { headers: { Authorization: 'Bearer '+token }});
      const data = await res.json();
      const invs = data.invoices || [];
      let total = 0;
      const tbody = document.getElementById('invoicesTableBody');
      tbody.innerHTML = '';
      
      if(invs.length===0) tbody.innerHTML = '<tr><td colspan="6" style="padding:20px; text-align:center;">Aucune facture</td></tr>';
      
      invs.forEach(inv => {
        total += parseFloat(inv.total_ttc);
        tbody.innerHTML += `
        <tr style="border-bottom:1px solid #eee;">
           <td style="padding:16px; font-weight:bold; color:#10B981;">${inv.invoice_number}</td>
           <td>${inv.client_name}</td>
           <td>${new Date(inv.issue_date).toLocaleDateString()}</td>
           <td>${parseFloat(inv.total_ttc).toFixed(2)}€</td>
           <td>${inv.status}</td>
           <td style="text-align:right;">...</td>
        </tr>`;
      });
      document.getElementById('statsRevenue').textContent = total.toFixed(2) + ' €';
    } catch(e){}
  }

  // --- LIGNES ---
  window.addPrestation = function(type) {
    counter++;
    prestations.push({
      id: 'p'+counter, type: type, 
      description: type==='commission'?'Commission sur loyers':'Ménage',
      base: 0, price: type==='commission'?20:0 
    });
    renderLines();
  };

  window.updateLine = function(id, key, val) {
    const p = prestations.find(x => x.id === id);
    if(p) { p[key] = key==='description'?val:parseFloat(val)||0; renderLines(); }
  };

  window.removeLine = function(id) {
    prestations = prestations.filter(x => x.id !== id);
    renderLines();
  };

  function renderLines() {
    const cont = document.getElementById('prestationsListEditor');
    cont.innerHTML = prestations.map(p => {
      let inputs = '';
      let badge = p.type==='commission'?'badge-commission':'badge-other';
      if(p.type==='commission') {
        inputs = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
          <div><label style="font-size:10px;">Loyer</label><input type="number" class="form-control" value="${p.base}" oninput="updateLine('${p.id}','base',this.value)"></div>
          <div><label style="font-size:10px;">Taux %</label><input type="number" class="form-control" value="${p.price}" oninput="updateLine('${p.id}','price',this.value)"></div>
        </div>`;
      } else {
        inputs = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
          <div><label style="font-size:10px;">Qté</label><input type="number" class="form-control" value="${p.base}" oninput="updateLine('${p.id}','base',this.value)"></div>
          <div><label style="font-size:10px;">Prix U.</label><input type="number" class="form-control" value="${p.price}" oninput="updateLine('${p.id}','price',this.value)"></div>
        </div>`;
      }
      return `
      <div class="prestation-mini-card">
        <button class="remove-line-btn" onclick="removeLine('${p.id}')"><i class="fas fa-times"></i></button>
        <span class="prestation-badge ${badge}">${p.type}</span>
        <div class="form-group" style="margin-bottom:6px;"><input class="form-control" value="${p.description}" oninput="updateLine('${p.id}','description',this.value)"></div>
        ${inputs}
      </div>`;
    }).join('');
    updatePreview();
  }

  window.updatePreview = function() {
    // Client
    const id = document.getElementById('invoiceClientId').value;
    const c = clients.find(x => String(x.id)===id);
    if(c) {
      document.getElementById('previewClientName').textContent = c.company_name || c.first_name + ' ' + c.last_name;
      document.getElementById('previewClientDetails').innerHTML = `${c.address||''}<br>${c.postal_code||''} ${c.city||''}`;
    }
    // Dates
    const d = document.getElementById('invoiceIssueDate').valueAsDate;
    if(d) document.getElementById('previewDate').textContent = d.toLocaleDateString();

    // Sender & Logo
    document.getElementById('previewSenderAddress').innerHTML = document.getElementById('senderAddressInput').value.replace(/\n/g, '<br>');

    // Totaux
    let ht = 0;
    const tbody = document.getElementById('previewBody');
    tbody.innerHTML = '';
    prestations.forEach(p => {
      let tot = p.type==='commission' ? p.base*(p.price/100) : p.base*p.price;
      ht += tot;
      tbody.innerHTML += `<tr><td>${p.description}</td><td style="text-align:center;">${p.base}</td><td style="text-align:right;">${p.price}</td><td style="text-align:right; font-weight:bold;">${tot.toFixed(2)}€</td></tr>`;
    });

    const vat = document.getElementById('invoiceVatApplicable').checked ? ht*0.2 : 0;
    document.getElementById('displayTotalTTC').textContent = (ht+vat).toFixed(2)+' €';
    document.getElementById('previewTotalHT').textContent = ht.toFixed(2)+' €';
    document.getElementById('previewTotalVAT').textContent = vat.toFixed(2)+' €';
    document.getElementById('previewTotalTTC').textContent = (ht+vat).toFixed(2)+' €';
  };

  // --- LOGO ---
  window.updateLogoPreview = function() {
    const f = document.getElementById('logoInput').files[0];
    if(f) {
      const r = new FileReader();
      r.onload = (e) => document.getElementById('paperLogoContainer').innerHTML = `<img src="${e.target.result}" class="paper-logo-img">`;
      r.readAsDataURL(f);
    }
  };

  // --- ACTIONS ---
  window.openClientModal = () => document.getElementById('clientModal').classList.add('active');
  window.closeClientModal = () => document.getElementById('clientModal').classList.remove('active');
  
  window.saveClient = async function() {
    const name = document.getElementById('clientName').value;
    const type = document.querySelector('input[name="clientType"]:checked').value;
    // Adapté à ton API qui attend firstName/lastName ou companyName
    const payload = {
        clientType: type,
        companyName: type==='business'?name:'',
        firstName: type==='individual'?name.split(' ')[0]:'',
        lastName: type==='individual'?name.split(' ')[1]||'':'',
        email: document.getElementById('clientEmail').value,
        address: document.getElementById('clientAddress').value,
        city: document.getElementById('clientCity').value,
        postalCode: document.getElementById('clientZip').value,
        defaultCommissionRate: 20
    };
    
    try {
        const res = await fetch('/api/owner-clients', {
            method:'POST',
            headers:{'Content-Type':'application/json', Authorization:'Bearer '+token},
            body:JSON.stringify(payload)
        });
        if(res.ok) { alert("Client créé !"); closeClientModal(); loadClients(); }
        else { const d=await res.json(); alert("Erreur: "+(d.error||'Inconnue')); }
    } catch(e){ alert("Erreur connexion"); }
  };

  window.createInvoice = async function(send) {
    const clientId = document.getElementById('invoiceClientId').value;
    if(!clientId) return alert("Choisissez un client");
    
    const items = prestations.map(p => ({
        itemType: p.type,
        description: p.description,
        rentalAmount: p.type==='commission'?p.base:0,
        commissionRate: p.type==='commission'?p.price:0,
        quantity: p.type!=='commission'?p.base:0,
        unitPrice: p.type!=='commission'?p.price:0,
        total: p.type==='commission' ? p.base*(p.price/100) : p.base*p.price
    }));

    const payload = {
        clientId: parseInt(clientId),
        issueDate: document.getElementById('invoiceIssueDate').value,
        dueDate: document.getElementById('invoiceDueDate').value,
        items: items,
        vatApplicable: document.getElementById('invoiceVatApplicable').checked,
        sendEmail: send
    };

    try {
        const res = await fetch('/api/owner-invoices', {
            method:'POST',
            headers:{'Content-Type':'application/json', Authorization:'Bearer '+token},
            body:JSON.stringify(payload)
        });
        if(res.ok) { alert("Facture enregistrée !"); switchTab('dashboard'); loadInvoices(); }
        else { const d=await res.json(); alert("Erreur: "+d.error); }
    } catch(e){ alert("Erreur connexion"); }
  };
</script>

</body>
</html>
