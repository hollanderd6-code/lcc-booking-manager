<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>Support Admin ‚Äî Boostinghost</title>

<!-- PWA -->
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Support BH"/>
<meta name="theme-color" content="#0f172a"/>
<link rel="apple-touch-icon" href="/icons/support-icon-192.png"/>
<link rel="manifest" href="/support-manifest.json"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>
<style>
  :root {
    --bg-app: #f1f5f9;
    --bg-sidebar: #ffffff;
    --bg-chat: #f8fafc;
    --bg-bubble-admin: #3b82f6;
    --bg-bubble-user: #ffffff;
    --border: #e2e8f0;
    --text-primary: #0f172a;
    --text-secondary: #64748b;
    --text-muted: #94a3b8;
    --accent: #3b82f6;
    --accent-hover: #2563eb;
    --green: #10b981;
    --orange: #f59e0b;
    --red: #ef4444;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Inter', sans-serif; background: var(--bg-app); color: var(--text-primary); height: 100vh; overflow: hidden; padding-top: env(safe-area-inset-top, 0px); }

  /* ====== PIN LOCK ====== */
  .pin-overlay {
    position: fixed; inset: 0; z-index: 99999;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 24px; padding: 20px;
    padding-top: calc(20px + env(safe-area-inset-top, 0px));
  }
  .pin-overlay.hidden { display: none; }
  .pin-logo { font-size: 48px; }
  .pin-title { color: white; font-size: 20px; font-weight: 700; }
  .pin-subtitle { color: #94a3b8; font-size: 13px; text-align: center; }
  .pin-input-container { display: flex; gap: 8px; margin-top: 8px; }
  .pin-dot {
    width: 44px; height: 52px; border-radius: 12px;
    background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.15);
    color: white; font-size: 22px; font-weight: 700;
    text-align: center; outline: none; caret-color: #3b82f6;
    font-family: 'Inter', monospace;
    transition: border-color 0.2s;
  }
  .pin-dot:focus { border-color: #3b82f6; background: rgba(59,130,246,0.1); }
  .pin-dot.filled { border-color: #3b82f6; }
  .pin-error {
    color: #ef4444; font-size: 13px; font-weight: 600;
    min-height: 20px; transition: opacity 0.2s;
  }
  .pin-shake { animation: shake 0.4s ease; }
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-8px); }
    40%, 80% { transform: translateX(8px); }
  }
  .pin-remember {
    display: flex; align-items: center; gap: 8px;
    color: #94a3b8; font-size: 12px; margin-top: 4px;
  }
  .pin-remember input { accent-color: #3b82f6; }

  /* iOS safe area */
  @supports (padding-top: env(safe-area-inset-top)) {
    .chat-input-area { padding-bottom: calc(16px + env(safe-area-inset-bottom)); }
  }
  
  /* PWA standalone mode - extra top padding */
  @media all and (display-mode: standalone) {
    body { padding-top: env(safe-area-inset-top, 20px); }
    .admin-layout { height: calc(100vh - env(safe-area-inset-top, 20px)); }
  }

  /* ====== LAYOUT ====== */
  .admin-layout {
    display: flex; height: calc(100vh - env(safe-area-inset-top, 0px));
  }

  /* ====== SIDEBAR ‚Äî LISTE DES CONVERSATIONS ====== */
  .conversations-panel {
    width: 360px; min-width: 360px;
    background: var(--bg-sidebar);
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column;
    overflow: hidden;
  }

  .panel-header {
    padding: 20px; border-bottom: 1px solid var(--border);
  }
  .panel-header h1 {
    font-size: 20px; font-weight: 800; margin-bottom: 4px;
    display: flex; align-items: center; gap: 10px;
  }
  .panel-header h1 i { color: var(--accent); }
  .panel-header p { font-size: 12px; color: var(--text-secondary); }

  .panel-search {
    padding: 12px 20px; border-bottom: 1px solid var(--border);
  }
  .panel-search input {
    width: 100%; padding: 8px 12px; border-radius: 8px;
    border: 1px solid var(--border); font-size: 13px;
    background: var(--bg-app); color: var(--text-primary); outline: none;
  }
  .panel-search input:focus { border-color: var(--accent); }

  .conversations-list {
    flex: 1; overflow-y: auto;
  }

  .conv-item {
    display: flex; align-items: center; gap: 12px;
    padding: 14px 20px; cursor: pointer;
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
    position: relative;
  }
  .conv-item:hover { background: #f8fafc; }
  .conv-item.active { background: #eff6ff; border-left: 3px solid var(--accent); }

  .conv-avatar {
    width: 42px; height: 42px; border-radius: 50%; flex-shrink: 0;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    display: flex; align-items: center; justify-content: center;
    color: white; font-weight: 700; font-size: 15px;
  }

  .conv-info { flex: 1; min-width: 0; }
  .conv-name {
    font-size: 14px; font-weight: 600; margin-bottom: 2px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .conv-preview {
    font-size: 12px; color: var(--text-secondary);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  .conv-meta {
    display: flex; flex-direction: column; align-items: flex-end; gap: 4px; flex-shrink: 0;
  }
  .conv-time { font-size: 11px; color: var(--text-muted); }
  .conv-badge {
    width: 20px; height: 20px; border-radius: 50%; background: var(--red);
    color: white; font-size: 10px; font-weight: 700;
    display: flex; align-items: center; justify-content: center;
  }

  .conv-status-dot {
    width: 8px; height: 8px; border-radius: 50%; position: absolute;
    top: 16px; left: 50px;
  }
  .conv-status-dot.waiting { background: var(--orange); }
  .conv-status-dot.open { background: var(--green); }
  .conv-status-dot.closed { background: var(--text-muted); }

  /* ====== CHAT PANEL ====== */
  .chat-panel {
    flex: 1; display: flex; flex-direction: column;
    background: var(--bg-chat);
  }

  .chat-empty {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 16px;
    color: var(--text-muted);
  }
  .chat-empty i { font-size: 48px; opacity: 0.3; }
  .chat-empty p { font-size: 15px; }

  /* Chat header */
  .chat-header {
    padding: 16px 24px; background: var(--bg-sidebar);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .chat-header-left { display: flex; align-items: center; gap: 12px; }
  .chat-header-avatar {
    width: 36px; height: 36px; border-radius: 50%;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    display: flex; align-items: center; justify-content: center;
    color: white; font-weight: 700; font-size: 13px;
  }
  .chat-header-name { font-size: 15px; font-weight: 700; }
  .chat-header-sub { font-size: 12px; color: var(--text-secondary); }
  .chat-header-actions { display: flex; gap: 8px; }
  .chat-header-actions button {
    padding: 6px 12px; border-radius: 8px; border: 1px solid var(--border);
    background: white; font-size: 12px; cursor: pointer; font-weight: 600;
    transition: all 0.15s;
  }
  .chat-header-actions button:hover { background: var(--bg-app); }
  .chat-header-actions button.btn-close-conv { color: var(--red); border-color: var(--red); }

  /* Messages */
  .chat-messages {
    flex: 1; overflow-y: auto; padding: 24px;
    display: flex; flex-direction: column; gap: 12px;
  }

  .chat-msg { display: flex; gap: 10px; max-width: 70%; animation: fadeUp 0.2s ease; }
  .chat-msg.admin { align-self: flex-end; flex-direction: row-reverse; }
  .chat-msg.user { align-self: flex-start; }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .chat-msg-avatar {
    width: 30px; height: 30px; border-radius: 50%; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; color: white;
  }
  .chat-msg.user .chat-msg-avatar { background: linear-gradient(135deg, #6366f1, #8b5cf6); }
  .chat-msg.admin .chat-msg-avatar { background: linear-gradient(135deg, #059669, #10b981); }

  .chat-msg-content { display: flex; flex-direction: column; gap: 3px; }
  .chat-msg-sender { font-size: 11px; font-weight: 600; color: var(--text-secondary); }
  .chat-msg.admin .chat-msg-sender { text-align: right; }

  .chat-msg-bubble {
    padding: 10px 14px; border-radius: 14px; font-size: 14px; line-height: 1.5;
    word-wrap: break-word; white-space: pre-wrap;
  }
  .chat-msg.user .chat-msg-bubble {
    background: var(--bg-bubble-user); border: 1px solid var(--border);
    border-bottom-left-radius: 4px;
  }
  .chat-msg.admin .chat-msg-bubble {
    background: var(--bg-bubble-admin); color: white;
    border-bottom-right-radius: 4px;
  }
  .chat-msg-bubble img {
    max-width: 280px; max-height: 200px; border-radius: 8px;
    cursor: pointer; display: block; margin-top: 6px;
  }
  .chat-msg-time { font-size: 10px; color: var(--text-muted); }
  .chat-msg.admin .chat-msg-time { text-align: right; }

  .chat-date-sep {
    text-align: center; font-size: 11px; color: var(--text-muted);
    padding: 8px; margin: 4px 0;
  }

  /* Input area */
  .chat-input-area {
    padding: 16px 24px; background: var(--bg-sidebar);
    border-top: 1px solid var(--border);
    display: flex; align-items: center; gap: 12px;
  }
  .chat-input {
    flex: 1; padding: 12px 16px; border-radius: 12px;
    border: 1px solid var(--border); font-size: 14px; outline: none;
    background: var(--bg-app); color: var(--text-primary);
    resize: none; font-family: inherit; min-height: 44px; max-height: 120px;
  }
  .chat-input:focus { border-color: var(--accent); }
  .chat-send-btn {
    width: 44px; height: 44px; border-radius: 12px; border: none;
    background: var(--accent); color: white; font-size: 16px;
    cursor: pointer; transition: all 0.15s;
    display: flex; align-items: center; justify-content: center;
  }
  .chat-send-btn:hover { background: var(--accent-hover); transform: scale(1.05); }

  /* Image modal */
  .img-modal {
    display: none; position: fixed; inset: 0; z-index: 9999;
    background: rgba(0,0,0,0.85); align-items: center; justify-content: center; cursor: pointer;
  }
  .img-modal.active { display: flex; }
  .img-modal img { max-width: 90%; max-height: 90%; border-radius: 8px; }

  /* Responsive */
  @media (max-width: 768px) {
    .conversations-panel { width: 100%; min-width: unset; position: absolute; z-index: 10; }
    .conversations-panel.hidden { display: none; }
    .chat-panel .mobile-back { display: inline-flex; }
  }
  @media (min-width: 769px) {
    .chat-panel .mobile-back { display: none; }
  }

  /* Notification sonore badge */
  .notif-sound { display: none; }

  /* Filters */
  .filter-tabs {
    display: flex; gap: 4px; padding: 8px 20px; border-bottom: 1px solid var(--border);
  }
  .filter-tab {
    padding: 4px 10px; border-radius: 6px; border: none; background: transparent;
    font-size: 12px; font-weight: 600; cursor: pointer; color: var(--text-secondary);
    transition: all 0.15s;
  }
  .filter-tab:hover { background: var(--bg-app); }
  .filter-tab.active { background: var(--accent); color: white; }
</style>
</head>
<body>

<!-- PIN LOCK SCREEN -->
<div class="pin-overlay" id="pinOverlay">
  <div class="pin-logo">üîê</div>
  <div class="pin-title">Support Admin</div>
  <div class="pin-subtitle">Entrez votre code d'acc√®s √† 8 chiffres</div>
  <div class="pin-input-container" id="pinContainer">
    <input type="tel" maxlength="1" class="pin-dot" autofocus/>
    <input type="tel" maxlength="1" class="pin-dot"/>
    <input type="tel" maxlength="1" class="pin-dot"/>
    <input type="tel" maxlength="1" class="pin-dot"/>
    <input type="tel" maxlength="1" class="pin-dot"/>
    <input type="tel" maxlength="1" class="pin-dot"/>
    <input type="tel" maxlength="1" class="pin-dot"/>
    <input type="tel" maxlength="1" class="pin-dot"/>
  </div>
  <div class="pin-error" id="pinError"></div>
  <label class="pin-remember">
    <input type="checkbox" id="pinRemember" checked/>
    Se souvenir pendant 7 jours
  </label>
</div>

<div class="admin-layout" id="adminLayout" style="display: none;">
  <!-- SIDEBAR: Conversations -->
  <div class="conversations-panel" id="convPanel">
    <div class="panel-header">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h1><i class="fas fa-headset"></i> Support</h1>
          <p id="convCount">Chargement...</p>
        </div>
        <button onclick="toggleTeamPanel()" style="width:36px; height:36px; border-radius:10px; border:1px solid var(--border); background:white; cursor:pointer; font-size:14px; color:var(--text-secondary);" title="G√©rer l'√©quipe">
          <i class="fas fa-users-cog"></i>
        </button>
      </div>
    </div>

    <!-- Team panel (hidden by default) -->
    <div id="teamPanel" style="display:none; border-bottom:1px solid var(--border); padding:16px 20px; background:#f8fafc;">
      <div style="font-size:13px; font-weight:700; margin-bottom:10px;">üë• √âquipe support</div>
      <div id="teamList" style="margin-bottom:12px; font-size:13px;">Chargement...</div>
      <div style="display:flex; gap:6px;">
        <input type="email" id="teamEmailInput" placeholder="email@exemple.com" style="flex:1; padding:7px 10px; border-radius:8px; border:1px solid var(--border); font-size:12px; outline:none;"/>
        <button onclick="addTeamMember()" style="padding:7px 12px; border-radius:8px; border:none; background:var(--accent); color:white; font-size:12px; font-weight:600; cursor:pointer;">
          <i class="fas fa-plus"></i> Ajouter
        </button>
      </div>
      <div id="teamError" style="color:var(--red); font-size:11px; margin-top:6px; min-height:16px;"></div>
    </div>
    <div class="panel-search">
      <input type="text" id="searchInput" placeholder="Rechercher un utilisateur..." oninput="filterConversations()"/>
    </div>
    <div class="filter-tabs">
      <button class="filter-tab active" data-filter="all" onclick="setFilter('all', this)">Tous</button>
      <button class="filter-tab" data-filter="waiting" onclick="setFilter('waiting', this)">En attente</button>
      <button class="filter-tab" data-filter="open" onclick="setFilter('open', this)">Ouverts</button>
      <button class="filter-tab" data-filter="closed" onclick="setFilter('closed', this)">Ferm√©s</button>
    </div>
    <div class="conversations-list" id="convList">
      <div style="padding: 40px; text-align: center; color: var(--text-muted);">
        <i class="fas fa-spinner fa-spin"></i> Chargement...
      </div>
    </div>
  </div>

  <!-- CHAT: Messages -->
  <div class="chat-panel" id="chatPanel">
    <div class="chat-empty" id="chatEmpty">
      <i class="fas fa-comments"></i>
      <p>S√©lectionnez une conversation</p>
    </div>

    <div id="chatContent" style="display: none; flex-direction: column; height: 100%;">
      <div class="chat-header" id="chatHeader">
        <div class="chat-header-left">
          <button class="mobile-back" onclick="showConvPanel()" style="border:none; background:none; cursor:pointer; font-size:18px; color: var(--text-secondary);">
            <i class="fas fa-arrow-left"></i>
          </button>
          <div class="chat-header-avatar" id="chatAvatar">?</div>
          <div>
            <div class="chat-header-name" id="chatName">‚Äî</div>
            <div class="chat-header-sub" id="chatSub">‚Äî</div>
          </div>
        </div>
        <div class="chat-header-actions">
          <button onclick="closeConversation()" class="btn-close-conv" title="Fermer la conversation">
            <i class="fas fa-check-circle"></i> Clore
          </button>
        </div>
      </div>

      <div class="chat-messages" id="chatMessages"></div>

      <div class="chat-input-area">
        <textarea class="chat-input" id="adminInput" placeholder="√âcrivez votre r√©ponse..." rows="1"></textarea>
        <button class="chat-send-btn" onclick="sendAdminReply()">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal image -->
<div class="img-modal" id="imgModal" onclick="this.classList.remove('active')">
  <img id="imgModalSrc" src="" alt=""/>
</div>

<script>
// ============================================
// üîê PIN PROTECTION
// ============================================
// ‚ö†Ô∏è CHANGE CE CODE PIN ICI :
const SUPPORT_PIN = '12345678';

(function initPinLock() {
  const overlay = document.getElementById('pinOverlay');
  const layout = document.getElementById('adminLayout');
  const inputs = document.querySelectorAll('#pinContainer .pin-dot');
  const errorEl = document.getElementById('pinError');

  // V√©rifier si d√©j√† authentifi√© (cookie de session)
  const savedPin = localStorage.getItem('support_pin_session');
  const savedExpiry = localStorage.getItem('support_pin_expiry');
  
  if (savedPin === SUPPORT_PIN && savedExpiry && Date.now() < parseInt(savedExpiry)) {
    // D√©j√† authentifi√©
    overlay.classList.add('hidden');
    layout.style.display = 'flex';

    return;
  }

  // Gestion des inputs PIN
  inputs.forEach((input, i) => {
    input.addEventListener('input', (e) => {
      const val = e.target.value.replace(/\D/g, '');
      e.target.value = val;
      
      if (val && i < inputs.length - 1) {
        inputs[i + 1].focus();
      }
      
      e.target.classList.toggle('filled', !!val);

      // V√©rifier si tous les champs sont remplis
      const code = Array.from(inputs).map(inp => inp.value).join('');
      if (code.length === 8) {
        validatePin(code);
      }
    });

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !e.target.value && i > 0) {
        inputs[i - 1].focus();
        inputs[i - 1].value = '';
        inputs[i - 1].classList.remove('filled');
      }
    });

    // Coller un code complet
    input.addEventListener('paste', (e) => {
      e.preventDefault();
      const pasted = (e.clipboardData.getData('text') || '').replace(/\D/g, '').slice(0, 8);
      pasted.split('').forEach((char, idx) => {
        if (inputs[idx]) {
          inputs[idx].value = char;
          inputs[idx].classList.add('filled');
        }
      });
      if (pasted.length === 8) validatePin(pasted);
      else if (pasted.length > 0) inputs[Math.min(pasted.length, 7)].focus();
    });
  });

  function validatePin(code) {
    if (code === SUPPORT_PIN) {
      // Succ√®s
      errorEl.textContent = '';
      
      // Sauvegarder si "se souvenir" coch√©
      if (document.getElementById('pinRemember').checked) {
        const expiry = Date.now() + (7 * 24 * 60 * 60 * 1000); // 7 jours
        localStorage.setItem('support_pin_session', SUPPORT_PIN);
        localStorage.setItem('support_pin_expiry', expiry.toString());
      }

      overlay.style.transition = 'opacity 0.3s';
      overlay.style.opacity = '0';
      setTimeout(() => {
        overlay.classList.add('hidden');
        layout.style.display = 'flex';
        // Enregistrer les notifications push
    
      }, 300);
    } else {
      // √âchec
      errorEl.textContent = 'Code incorrect';
      document.getElementById('pinContainer').classList.add('pin-shake');
      setTimeout(() => {
        document.getElementById('pinContainer').classList.remove('pin-shake');
        inputs.forEach(inp => { inp.value = ''; inp.classList.remove('filled'); });
        inputs[0].focus();
      }, 400);
    }
  }
})();
</script>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
const API_URL = window.location.origin;
const token = localStorage.getItem('lcc_token');
if (!token) window.location.href = '/login.html';

let allConversations = [];
let activeConvId = null;
let currentFilter = 'all';
let socket = null;

// ============================================
// INIT
// ============================================
async function init() {
  await loadConversations();

  // Socket.io
  socket = io(API_URL, { transports: ['websocket', 'polling'] });
  socket.on('connect', () => {
    socket.emit('join_support_admin');
  });
  socket.on('support_new_message', (msg) => {
    // Rafra√Æchir la liste
    loadConversations();
    // Si c'est la conversation active, ajouter le message
    if (msg.conversation_id === activeConvId || msg.conversationId === activeConvId) {
      appendChatMessage(msg);
      scrollChat();
      // Marquer comme lu
      markAdminRead(activeConvId);
    }
  });

  // Auto-resize textarea
  const input = document.getElementById('adminInput');
  input.addEventListener('input', () => {
    input.style.height = 'auto';
    input.style.height = Math.min(input.scrollHeight, 120) + 'px';
  });
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendAdminReply();
    }
  });
}

// ============================================
// CHARGER CONVERSATIONS
// ============================================
async function loadConversations() {
  try {
    const res = await fetch(`${API_URL}/api/support/admin/conversations`, {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (!res.ok) throw new Error('Erreur API');
    const data = await res.json();
    allConversations = data.conversations || [];
    renderConversations();
  } catch (err) {
    console.error('Erreur chargement conversations:', err);
    document.getElementById('convList').innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-muted);">Erreur de chargement</div>';
  }
}

function renderConversations() {
  const container = document.getElementById('convList');
  const search = document.getElementById('searchInput').value.toLowerCase();

  let filtered = allConversations;

  // Filtre statut
  if (currentFilter !== 'all') {
    filtered = filtered.filter(c => c.status === currentFilter);
  }

  // Filtre recherche
  if (search) {
    filtered = filtered.filter(c => {
      const name = `${c.user_first_name || ''} ${c.user_last_name || ''} ${c.user_email || ''} ${c.user_company || ''}`.toLowerCase();
      return name.includes(search);
    });
  }

  // Compteur
  const waitingCount = allConversations.filter(c => c.status === 'waiting').length;
  document.getElementById('convCount').textContent = `${allConversations.length} conversation(s) ¬∑ ${waitingCount} en attente`;

  if (filtered.length === 0) {
    container.innerHTML = '<div style="padding:30px; text-align:center; color:var(--text-muted);">Aucune conversation</div>';
    return;
  }

  container.innerHTML = filtered.map(conv => {
    const name = conv.user_first_name
      ? `${conv.user_first_name} ${conv.user_last_name || ''}`.trim()
      : (conv.user_email || 'Utilisateur');
    const initial = (conv.user_first_name || conv.user_email || '?')[0].toUpperCase();
    const preview = conv.last_message ? conv.last_message.substring(0, 50) : 'Pas de message';
    const time = conv.last_message_at ? formatTime(conv.last_message_at) : '';
    const unread = parseInt(conv.unread_count) || 0;
    const isActive = conv.id === activeConvId;

    return `
      <div class="conv-item ${isActive ? 'active' : ''}" onclick="openConversation('${conv.id}')">
        <div class="conv-status-dot ${conv.status}"></div>
        <div class="conv-avatar">${initial}</div>
        <div class="conv-info">
          <div class="conv-name">${escapeHtml(name)}</div>
          <div class="conv-preview">${escapeHtml(preview)}</div>
        </div>
        <div class="conv-meta">
          <span class="conv-time">${time}</span>
          ${unread > 0 ? `<span class="conv-badge">${unread}</span>` : ''}
        </div>
      </div>
    `;
  }).join('');
}

// ============================================
// OUVRIR UNE CONVERSATION
// ============================================
async function openConversation(convId) {
  activeConvId = convId;
  const conv = allConversations.find(c => c.id === convId);
  if (!conv) return;

  // Header
  const name = conv.user_first_name
    ? `${conv.user_first_name} ${conv.user_last_name || ''}`.trim()
    : (conv.user_email || 'Utilisateur');
  const initial = (conv.user_first_name || conv.user_email || '?')[0].toUpperCase();

  document.getElementById('chatAvatar').textContent = initial;
  document.getElementById('chatName').textContent = name;
  document.getElementById('chatSub').textContent = `${conv.user_email || ''} ¬∑ ${conv.user_company || 'Sans entreprise'}`;

  // Afficher le chat
  document.getElementById('chatEmpty').style.display = 'none';
  const chatContent = document.getElementById('chatContent');
  chatContent.style.display = 'flex';

  // Charger les messages
  const container = document.getElementById('chatMessages');
  container.innerHTML = '<div style="text-align:center; padding:30px; color:var(--text-muted);"><i class="fas fa-spinner fa-spin"></i></div>';

  try {
    const res = await fetch(`${API_URL}/api/support/admin/messages/${convId}`, {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (!res.ok) throw new Error('Erreur API');
    const data = await res.json();

    container.innerHTML = '';
    let lastDate = '';
    (data.messages || []).forEach(msg => {
      const d = new Date(msg.created_at).toLocaleDateString('fr-FR');
      if (d !== lastDate) {
        lastDate = d;
        const sep = document.createElement('div');
        sep.className = 'chat-date-sep';
        sep.textContent = d === new Date().toLocaleDateString('fr-FR') ? "Aujourd'hui" : d;
        container.appendChild(sep);
      }
      appendChatMessage(msg, false);
    });

    scrollChat();

    // Rejoindre la room socket
    if (socket) socket.emit('join_support', convId);

    // Marquer comme lu
    await markAdminRead(convId);
  } catch (err) {
    console.error('Erreur chargement messages:', err);
    container.innerHTML = '<div style="text-align:center; padding:30px; color:var(--red);">Erreur de chargement</div>';
  }

  // Mettre √† jour la liste
  renderConversations();

  // Focus input
  document.getElementById('adminInput').focus();
}

// ============================================
// AFFICHER UN MESSAGE
// ============================================
function appendChatMessage(msg, animate = true) {
  const container = document.getElementById('chatMessages');
  const isAdmin = msg.sender_type === 'admin';

  const div = document.createElement('div');
  div.className = `chat-msg ${isAdmin ? 'admin' : 'user'}`;
  if (!animate) div.style.animation = 'none';

  const initial = isAdmin ? 'üõü' : (msg.sender_name || '?')[0].toUpperCase();
  const time = new Date(msg.created_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

  let bubbleHTML = escapeHtml(msg.message || '');
  bubbleHTML = bubbleHTML.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:inherit; text-decoration:underline; word-break:break-all;">$1</a>');

  if (msg.image_url) {
    bubbleHTML += `<img src="${msg.image_url}" alt="Image" onclick="event.stopPropagation(); openImg('${msg.image_url}')" loading="lazy"/>`;
  }

  div.innerHTML = `
    <div class="chat-msg-avatar">${initial}</div>
    <div class="chat-msg-content">
      <div class="chat-msg-sender">${isAdmin ? (msg.sender_name || 'Support') : (msg.sender_name || 'Utilisateur')}</div>
      <div class="chat-msg-bubble">${bubbleHTML}</div>
      <div class="chat-msg-time">${time}</div>
    </div>
  `;

  container.appendChild(div);
}

// ============================================
// ENVOYER UNE R√âPONSE
// ============================================
async function sendAdminReply() {
  const input = document.getElementById('adminInput');
  const message = input.value.trim();
  if (!message || !activeConvId) return;

  input.value = '';
  input.style.height = 'auto';

  // Optimistic
  appendChatMessage({
    sender_type: 'admin',
    sender_name: 'Support',
    message: message,
    created_at: new Date().toISOString()
  });
  scrollChat();

  try {
    await fetch(`${API_URL}/api/support/admin/reply`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({ conversationId: activeConvId, message })
    });
    // Rafra√Æchir la liste pour mettre √† jour le preview
    loadConversations();
  } catch (err) {
    console.error('Erreur envoi r√©ponse:', err);
  }
}

// ============================================
// FERMER UNE CONVERSATION
// ============================================
async function closeConversation() {
  if (!activeConvId) return;
  if (!confirm('Clore cette conversation ?')) return;

  try {
    // Envoyer un message de cl√¥ture
    await fetch(`${API_URL}/api/support/admin/reply`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({
        conversationId: activeConvId,
        message: '‚úÖ Cette conversation a √©t√© cl√¥tur√©e par le support. N\'h√©sitez pas √† nous recontacter si besoin.'
      })
    });

    // Changer le statut √† closed
    await fetch(`${API_URL}/api/support/admin/conversations/${activeConvId}/status`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({ status: 'closed' })
    });

    appendChatMessage({
      sender_type: 'admin',
      sender_name: 'Support',
      message: '‚úÖ Cette conversation a √©t√© cl√¥tur√©e par le support. N\'h√©sitez pas √† nous recontacter si besoin.',
      created_at: new Date().toISOString()
    });
    scrollChat();

    await loadConversations();
  } catch (err) {
    console.error('Erreur cl√¥ture:', err);
  }
}

// ============================================
// UTILS
// ============================================
function scrollChat() {
  const c = document.getElementById('chatMessages');
  setTimeout(() => { c.scrollTop = c.scrollHeight; }, 50);
}

function escapeHtml(text) {
  if (!text) return '';
  return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function formatTime(dateStr) {
  const d = new Date(dateStr);
  const now = new Date();
  const diffMs = now - d;
  const diffMin = Math.floor(diffMs / 60000);
  const diffH = Math.floor(diffMs / 3600000);

  if (diffMin < 1) return '√† l\'instant';
  if (diffMin < 60) return `${diffMin} min`;
  if (diffH < 24) return `${diffH}h`;

  return d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
}

function openImg(url) {
  document.getElementById('imgModalSrc').src = url;
  document.getElementById('imgModal').classList.add('active');
}

function filterConversations() {
  renderConversations();
}

function setFilter(filter, btn) {
  currentFilter = filter;
  document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  renderConversations();
}

async function markAdminRead(convId) {
  try {
    await fetch(`${API_URL}/api/support/admin/messages/${convId}`, {
      headers: { 'Authorization': 'Bearer ' + token }
    });
  } catch (e) {}
}

function showConvPanel() {
  document.getElementById('convPanel').classList.remove('hidden');
}

// ============================================
// üë• GESTION √âQUIPE SUPPORT
// ============================================
function toggleTeamPanel() {
  const panel = document.getElementById('teamPanel');
  if (panel.style.display === 'none') {
    panel.style.display = 'block';
    loadTeam();
  } else {
    panel.style.display = 'none';
  }
}

async function loadTeam() {
  try {
    const res = await fetch(`${API_URL}/api/support/admin/team`);
    if (!res.ok) throw new Error('Erreur');
    const data = await res.json();
    
    const list = document.getElementById('teamList');
    list.innerHTML = (data.admins || []).map(a => `
      <div style="display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom:1px solid #eee;">
        <div style="display:flex; align-items:center; gap:8px;">
          <span style="width:24px; height:24px; border-radius:50%; background:linear-gradient(135deg,#6366f1,#8b5cf6); color:white; font-size:10px; font-weight:700; display:flex; align-items:center; justify-content:center;">${(a.email || '?')[0].toUpperCase()}</span>
          <span>${escapeHtml(a.email)}</span>
          ${a.hardcoded ? '<span style="font-size:10px; background:#e2e8f0; padding:1px 6px; border-radius:4px; color:#64748b;">Principal</span>' : ''}
        </div>
        ${!a.hardcoded ? `<button onclick="removeTeamMember(${a.id})" style="border:none; background:none; cursor:pointer; color:var(--red); font-size:12px;" title="Retirer"><i class="fas fa-trash"></i></button>` : ''}
      </div>
    `).join('');
  } catch (err) {
    console.error('Erreur loadTeam:', err);
  }
}

async function addTeamMember() {
  const input = document.getElementById('teamEmailInput');
  const email = input.value.trim();
  const errorEl = document.getElementById('teamError');
  errorEl.textContent = '';

  if (!email || !email.includes('@')) {
    errorEl.textContent = 'Email invalide';
    return;
  }

  try {
    const res = await fetch(`${API_URL}/api/support/admin/team`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    });
    const data = await res.json();
    
    if (!res.ok) {
      errorEl.textContent = data.error || 'Erreur';
      return;
    }

    input.value = '';
    loadTeam();
  } catch (err) {
    errorEl.textContent = 'Erreur r√©seau';
  }
}

async function removeTeamMember(id) {
  if (!confirm('Retirer cet admin du support ?')) return;
  try {
    await fetch(`${API_URL}/api/support/admin/team/${id}`, { method: 'DELETE' });
    loadTeam();
  } catch (err) {
    console.error('Erreur remove:', err);
  }
}

// ============================================
// START
// ============================================
init();

// Rafra√Æchir les conversations toutes les 30s
setInterval(loadConversations, 30000);
</script>
</body>
</html>
