<!DOCTYPE html>

<html data-theme="light" lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="no-store, no-cache, must-revalidate, max-age=0" http-equiv="Cache-Control"/>
<meta content="no-cache" http-equiv="Pragma"/>
<meta content="0" http-equiv="Expires"/>
<meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
<title>Serrures Connect√©es</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>
<link href="/css/style.css" rel="stylesheet"/><link href="/css/bh-shared.css?v=1" rel="stylesheet"/><link href="/css/bottom-bar-enhanced.css" rel="stylesheet"/><link href="/css/menu-plus-fixes.css" rel="stylesheet"/><link href="/css/menu-active-button.css" rel="stylesheet"/>
<link href="/css/messages-badge-fix.css" rel="stylesheet"/>
<link href="/css/invoices-cards-style.css" rel="stylesheet"/>
<link rel="stylesheet" href="/css/messages-badge-red.css">
<link rel="stylesheet" href="/css/messages-badge-desktop.css">    
<style>
    /* FIX iOS POUR APP MOBILE */
    html, body {
      margin: 0 !important;
    }
    .app-container {
      margin-top: 0 !important;
    }
    .page-content {
      margin-top: 0 !important;
      max-width: 1100px;
    }
    
    /* DESIGN SYSTEM */
    :root { --primary: #10B981; --primary-dark: #059669; --bg-body: #f3f4f6; --paper-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }

    html, body { margin: 0; padding: 0; background: var(--bg-body); font-family: 'Inter', sans-serif; height: 100%; overflow-x: hidden; }
    .app-container { display: flex; min-height: 100vh; }
    
    /* SIDEBAR */
    .sidebar { width: 260px; background: white; border-right: 1px solid #e5e7eb; position: fixed; top: 0; bottom: 0; left: 0; z-index: 50; display: flex; flex-direction: column; }
    .sidebar-header { padding: 24px; }
    .sidebar-logo { display: flex; align-items: center; gap: 10px; text-decoration: none; color: #111827; font-weight: 800; font-size: 18px; }
    .nav-section-title { font-size: 11px; font-weight: 700; color: #9ca3af; text-transform: uppercase; margin: 24px 24px 8px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 24px; color: #4b5563; text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s; border-right: 3px solid transparent; }
    .nav-item:hover { background: #f9fafb; color: #111827; }
    .nav-item.active { background: #ecfdf5; color: #10B981; border-right-color: #10B981; }
    .nav-item i { width: 20px; text-align: center; }

    /* CONTENT */
    .main-wrapper { flex: 1; margin-left: 260px; display: flex; flex-direction: column; min-width: 0; }
    .top-bar { background: white; height: 64px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: flex-end; padding: 0 32px; position: sticky; top: 0; z-index: 40; }
    .main-content { padding: 32px; max-width: 1600px; margin: 0 auto; width: 100%; box-sizing: border-box; }

    /* DASHBOARD */
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
    .page-title { font-size: 24px; font-weight: 700; color: #111827; margin: 0; }
    .page-subtitle { color: #6b7280; font-size: 14px; margin-top: 4px; }
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .stat-card { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .stat-label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #6b7280; margin-bottom: 8px; display: block; }
    .stat-value { font-size: 24px; font-weight: 700; color: #111827; }

    /* TABS */
    .nav-tabs { display: inline-flex; background: #e5e7eb; padding: 4px; border-radius: 10px; margin-bottom: 24px; }
    .nav-tab { padding: 8px 24px; border-radius: 8px; border: none; background: transparent; font-weight: 600; color: #4b5563; cursor: pointer; font-size: 14px; transition: all 0.2s; }
    .nav-tab.active { background: white; color: #111827; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }

    /* LOCK LIST */
    .lock-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
    .lock-item { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; transition: all 0.2s; cursor: pointer; }
    .lock-item:hover { border-color: #10B981; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .lock-item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .lock-icon { width: 48px; height: 48px; background: #10B981; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; }
    .lock-name { font-size: 15px; font-weight: 600; color: #111827; margin-bottom: 4px; }
    .lock-type { font-size: 12px; color: #6b7280; }
    .lock-property { display: flex; align-items: center; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb; }
    .property-badge { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; background: #EDE9FE; color: #5B21B6; }

    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; text-decoration: none; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: white; border: 1px solid #d1d5db; color: #374151; }
    .btn-danger { background: #ef4444; color: white; }

    /* MODALS */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: white; border-radius: 16px; width: 90%; max-width: 500px; padding: 24px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; }
    .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
    .modal-subtitle { font-size: 13px; color: #6b7280; margin-bottom: 20px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; color: #374151; }
    .form-control { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px; box-sizing: border-box; }
    .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(16,185,129,0.1); }
    .form-help { font-size: 11px; color: #6b7280; margin-top: 4px; }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

    .alert-box { background: #FEF3C7; border: 1px solid #FCD34D; border-radius: 8px; padding: 12px; margin-bottom: 16px; }
    .alert-box .alert-content { font-size: 12px; color: #92400E; }
    .alert-box strong { display: block; margin-bottom: 4px; }
    .alert-box a { color: #D97706; text-decoration: underline; }

    .status-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
    .status-connected { background: #D1FAE5; color: #065F46; }
    .status-disconnected { background: #FEE2E2; color: #991B1B; }

    .empty-state { text-align: center; padding: 60px 20px; }
    .empty-state-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.3; }
    .empty-state-title { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
    .empty-state-text { font-size: 14px; color: #6b7280; margin-bottom: 20px; }

    @media (max-width: 1024px) {
      .sidebar { transform: translateX(-100%); } 
      .sidebar.active { transform: translateX(0); }
      .main-wrapper { margin-left: 0; }
      .menu-toggle { display: block; }
      .mobile-header { display: flex; justify-content: center; align-items: center; }
      .mobile-menu-btn { display: none; }
    }
    @media (min-width: 1025px) { .menu-toggle { display: none; } }

    /* BOTTOM SHEET STYLES */
    .bottom-sheet {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: flex-end;
      pointer-events: none;
    }
    .bottom-sheet.open {
      pointer-events: auto;
    }
    .bottom-sheet-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0);
      transition: background 0.3s ease;
    }
    .bottom-sheet.open .bottom-sheet-overlay {
      background: rgba(0, 0, 0, 0.5);
    }
    .bottom-sheet-content {
      position: relative;
      width: 100%;
      background: white;
      border-radius: 20px 20px 0 0;
      padding: 20px;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      overflow-y: auto;
      max-height: 80vh;
    }
    .bottom-sheet.open .bottom-sheet-content {
      transform: translateY(0);
    }
    .sheet-handle {
      width: 40px;
      height: 4px;
      background: #d1d5db;
      border-radius: 2px;
      margin: 0 auto 16px;
    }
    .sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .sheet-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }
    .sheet-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      color: #6b7280;
    }
    .sheet-body {
      /* Styles pour le contenu */
    }

</style>
<!-- Script auth + user + logout -->
<script src="/js/auth-fetch.js"></script>
<script>
(function () {
  const token = localStorage.getItem('lcc_token');
  if (!token) {
    window.location.href = '/login.html';
    return;
  }

  const rawUser = localStorage.getItem('lcc_user');
  let user = null;

  try {
    user = rawUser ? JSON.parse(rawUser) : null;
  } catch (e) {
    console.error('Impossible de lire lcc_user', e);
  }

  window.addEventListener('DOMContentLoaded', () => {
    if (user) {
      const nameEl = document.getElementById('sidebarUserName');
      const companyEl = document.getElementById('sidebarUserCompany');
      const avatarEl = document.getElementById('sidebarUserAvatar');

      if (nameEl) {
        nameEl.textContent = user.firstName
          ? user.firstName + (user.lastName ? ' ' + user.lastName : '')
          : (user.email || 'Mon compte');
      }

      if (companyEl) {
        companyEl.textContent = user.company || 'Mon espace';
      }

      if (avatarEl) {
        const initial = (user.firstName || user.email || '?').trim()[0] || 'U';
        avatarEl.textContent = initial.toUpperCase();
      }
    }

    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', function () {
        localStorage.removeItem('lcc_token');
        localStorage.removeItem('lcc_user');
        window.location.href = '/login.html';
      });
    }
  });
})();
</script>
<link rel="stylesheet" href="/css/mobile-native-styles.css">
</head>
<body data-page="smart-locks">
<!-- MOBILE HEADER -->
<div class="mobile-header">
<a class="mobile-logo" href="/app.html" style="margin: 0 auto;">
<i class="fas fa-calendar-check"></i>
<span class="mobile-logo-text">Boostinghost</span>
</a>
</div>
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- Sidebar -->
<div id="bhSidebar"></div>
<div class="main-wrapper">
<header class="top-bar"></header>
<main class="main-content">
<div id="bhHeaderActions" style="display:none;">
<button class="btn btn-primary" onclick="openConnectModal()">
<i class="fa fa-plug"></i> Connecter Igloohome
</button>
</div>
<div id="bhHeader"></div>

<div class="dashboard-header">
<div>
<h1 class="page-title">Serrures Connect√©es</h1>
<p class="page-subtitle">G√©rez vos serrures Igloohome et codes d'acc√®s automatiques.</p>
</div>
</div>

<div class="stats-row">
<div class="stat-card">
<span class="stat-label">Connexion API</span>
<span class="stat-value" id="apiStatus" style="font-size: 14px;"></span>
</div>
<div class="stat-card">
<span class="stat-label">Mes Serrures</span>
<span class="stat-value" id="lockCount">0</span>
</div>
<div class="stat-card">
<span class="stat-label">Codes G√©n√©r√©s</span>
<span class="stat-value" id="codesCount">0</span>
</div>
</div>

<div class="nav-tabs">
<button class="nav-tab active" id="btn-locks" onclick="switchTab('locks')">Mes Serrures</button>
<button class="nav-tab" id="btn-config" onclick="switchTab('config')">Configuration</button>
</div>

<div class="tab-content active" id="tab-locks">
<div style="background:white; border-radius:12px; border:1px solid #e5e7eb; padding:20px;">
<div id="locksContent">
<div class="empty-state">
<div class="empty-state-icon">‚è≥</div>
<div class="empty-state-title">Chargement...</div>
</div>
</div>
</div>
</div>

<div class="tab-content" id="tab-config">
<div style="background:white; border-radius:12px; border:1px solid #e5e7eb; padding:20px;">
<div id="configContent"></div>
</div>
</div>

</main>
</div>

<!-- Modal : Connecter API -->
<div class="modal-overlay" id="connectModal">
  <div class="modal-content">
    <div class="modal-title">Connecter Igloohome</div>
    <div class="modal-subtitle">Connectez votre compte Igloohome pour g√©rer vos serrures</div>

    <div class="form-group">
      <label>Client ID (API ID)</label>
      <input type="text" class="form-control" id="clientId" placeholder="Ex: 72BZWrP540hDO3reWsGorF"/>
      <div class="form-help">Copiez l'"API ID" depuis votre portail iglooaccess</div>
    </div>

    <div class="form-group">
      <label>Client Secret (API Key)</label>
      <input type="password" class="form-control" id="clientSecret" placeholder="Cliquez sur les *** pour r√©v√©ler la cl√©"/>
      <div class="form-help">Copiez l'"API Key" (cliquez sur les *** pour l'afficher)</div>
    </div>

    <div class="alert-box">
      <div class="alert-content">
        <strong>üì± Nouveau syst√®me iglooaccess</strong><br>
        1Ô∏è‚É£ Cr√©ez un compte sur <a href="https://developer.igloocompany.co" target="_blank">developer.igloocompany.co</a><br>
        2Ô∏è‚É£ Connectez-vous et cliquez sur "API Access" dans le menu<br>
        3Ô∏è‚É£ Copiez votre Client ID et Client Secret<br>
        <small style="margin-top:8px;display:block;opacity:0.8;">üí° 30 jours d'essai gratuit, puis $2/serrure/mois</small>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeConnectModal()">Annuler</button>
      <button class="btn btn-primary" onclick="connectIgloohome()">
        <i class="fa fa-plug"></i> Connecter
      </button>
    </div>
  </div>
</div>

<!-- Modal : Associer -->
<div class="modal-overlay" id="assignModal">
  <div class="modal-content">
    <div class="modal-title">Associer √† un logement</div>
    <div class="modal-subtitle" id="assignLockName"></div>

    <div class="form-group">
      <label>S√©lectionner un logement</label>
      <select class="form-control" id="propertySelect">
        <option value="">-- Choisir un logement --</option>
      </select>
    </div>

    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeAssignModal()">Annuler</button>
      <button class="btn btn-primary" onclick="assignLockToProperty()">
        <i class="fa fa-check"></i> Associer
      </button>
    </div>
  </div>
</div>

<script>
// Pas de v√©rification du token ici, bh-layout.js s'en charge
const token = localStorage.getItem('lcc_token');
let apiConnection = null;
let locks = [];
let properties = [];
let selectedLock = null;

async function init() {
  // Initialiser l'app
  await loadApiStatus();
  await loadProperties();
  await loadLocks();
}

function switchTab(id) {
  document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(e => e.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  document.getElementById('btn-'+id).classList.add('active');
}

async function loadApiStatus() {
  try {
    const res = await fetch('/api/smart-locks/status', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    const data = await res.json();
    
    apiConnection = data.connection;
    
    if (data.connected) {
      document.getElementById('apiStatus').innerHTML = '<span class="status-badge status-connected"><i class="fa fa-check-circle"></i> Connect√©</span>';
      loadConfigTab(true);
    } else {
      document.getElementById('apiStatus').innerHTML = '<span class="status-badge status-disconnected"><i class="fa fa-times-circle"></i> Non connect√©</span>';
      loadConfigTab(false);
    }
  } catch (err) {
    console.error('Erreur:', err);
  }
}

function loadConfigTab(isConnected) {
  const html = isConnected ? `
    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">API Igloohome Connect√©e</h3>
    <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">Votre API Igloohome est active</p>
    <button class="btn btn-primary" onclick="syncLocks()">
      <i class="fa fa-sync"></i> Synchroniser les serrures
    </button>
    <button class="btn btn-danger" onclick="disconnectApi()" style="margin-left: 10px;">
      <i class="fa fa-unlink"></i> D√©connecter
    </button>
  ` : `
    <div class="empty-state">
      <div class="empty-state-icon">üîå</div>
      <div class="empty-state-title">API non connect√©e</div>
      <div class="empty-state-text">Connectez votre API Igloohome pour commencer</div>
      <button class="btn btn-primary" onclick="openConnectModal()">
        <i class="fa fa-plug"></i> Connecter maintenant
      </button>
    </div>
  `;
  document.getElementById('configContent').innerHTML = html;
}

async function loadLocks() {
  try {
    const res = await fetch('/api/smart-locks', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    const data = await res.json();
    
    locks = data.locks || [];
    document.getElementById('lockCount').textContent = locks.length;
    
    if (locks.length === 0) {
      document.getElementById('locksContent').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üîí</div>
          <div class="empty-state-title">Aucune serrure</div>
          <div class="empty-state-text">
            ${apiConnection ? 'Synchronisez pour r√©cup√©rer vos serrures' : 'Connectez d\'abord votre API'}
          </div>
        </div>
      `;
    } else {
      renderLocks();
    }
  } catch (err) {
    console.error('Erreur:', err);
    document.getElementById('locksContent').innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon" style="color: #ef4444;">‚ö†Ô∏è</div>
        <div class="empty-state-title">Erreur de chargement</div>
      </div>
    `;
  }
}

function renderLocks() {
  const html = locks.map(lock => {
    const assignment = lock.assignment;
    const propertyName = assignment ? assignment.property_name : null;
    
    return `
      <div class="lock-item" onclick="openAssignModal(${lock.id})">
        <div class="lock-item-header">
          <div style="flex: 1;">
            <div class="lock-name">${lock.lock_name}</div>
            <div class="lock-type">${lock.lock_type || 'Serrure connect√©e'}</div>
            ${lock.serial_number ? `<div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">S/N: ${lock.serial_number}</div>` : ''}
          </div>
          <div class="lock-icon">
            <i class="fa fa-lock"></i>
          </div>
        </div>
        
        ${propertyName ? `
          <div class="lock-property">
            <i class="fa fa-home" style="color: #9ca3af; font-size: 12px;"></i>
            <span class="property-badge">${propertyName}</span>
          </div>
        ` : `
          <div class="lock-property">
            <i class="fa fa-exclamation-circle" style="color: #F59E0B;"></i>
            <span style="font-size: 12px; color: #F59E0B; font-weight: 600;">Non associ√©e</span>
          </div>
        `}
      </div>
    `;
  }).join('');
  
  document.getElementById('locksContent').innerHTML = `<div class="lock-list">${html}</div>`;
}

async function syncLocks() {
  try {
    const res = await fetch('/api/smart-locks/sync', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + token }
    });
    const data = await res.json();
    
    if (res.ok) {
      alert(`‚úÖ Synchronisation r√©ussie !\n${data.added || 0} serrure(s) ajout√©e(s)`);
      await loadLocks();
    } else {
      alert('‚ùå ' + (data.error || 'Erreur'));
    }
  } catch (err) {
    alert('‚ùå Erreur de synchronisation');
  }
}

async function loadProperties() {
  try {
    const res = await fetch('/api/properties', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    const data = await res.json();
    properties = data.properties || [];
  } catch (err) {
    console.error('Erreur:', err);
  }
}

function openConnectModal() {
  document.getElementById('connectModal').classList.add('active');
}

function closeConnectModal() {
  document.getElementById('connectModal').classList.remove('active');
  document.getElementById('clientId').value = '';
  document.getElementById('clientSecret').value = '';
}

async function connectIgloohome() {
  const clientId = document.getElementById('clientId').value.trim();
  const clientSecret = document.getElementById('clientSecret').value.trim();
  
  if (!clientId || !clientSecret) {
    return alert('‚ö†Ô∏è Veuillez remplir tous les champs');
  }
  
  try {
    const res = await fetch('/api/smart-locks/connect', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({ clientId, clientSecret })
    });
    
    const data = await res.json();
    
    if (res.ok) {
      alert('‚úÖ Connexion r√©ussie !');
      closeConnectModal();
      await loadApiStatus();
      await loadLocks();
    } else {
      alert('‚ùå ' + (data.error || 'Erreur'));
    }
  } catch (err) {
    alert('‚ùå Erreur de connexion');
  }
}

async function disconnectApi() {
  if (!confirm('‚ö†Ô∏è D√©connecter l\'API Igloohome ?')) return;
  
  try {
    const res = await fetch('/api/smart-locks/disconnect', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + token }
    });
    
    if (res.ok) {
      alert('‚úÖ API d√©connect√©e');
      await loadApiStatus();
      await loadLocks();
    }
  } catch (err) {
    alert('‚ùå Erreur');
  }
}

function openAssignModal(lockId) {
  selectedLock = locks.find(l => l.id === lockId);
  if (!selectedLock) return;
  
  document.getElementById('assignLockName').textContent = selectedLock.lock_name;
  
  const select = document.getElementById('propertySelect');
  select.innerHTML = '<option value="">-- Choisir un logement --</option>' +
    properties.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
  
  if (selectedLock.assignment) {
    select.value = selectedLock.assignment.property_id;
  }
  
  document.getElementById('assignModal').classList.add('active');
}

function closeAssignModal() {
  document.getElementById('assignModal').classList.remove('active');
  selectedLock = null;
}

async function assignLockToProperty() {
  const propertyId = document.getElementById('propertySelect').value;
  
  if (!propertyId) {
    return alert('‚ö†Ô∏è Veuillez s√©lectionner un logement');
  }
  
  try {
    const res = await fetch('/api/smart-locks/assign', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({
        lockId: selectedLock.id,
        propertyId: propertyId
      })
    });
    
    const data = await res.json();
    
    if (res.ok) {
      alert('‚úÖ Serrure associ√©e !');
      closeAssignModal();
      await loadLocks();
    } else {
      alert('‚ùå ' + (data.error || 'Erreur'));
    }
  } catch (err) {
    alert('‚ùå Erreur');
  }
}

// Init au chargement de la page
window.addEventListener('DOMContentLoaded', init);

</script>

<script src="/js/bh-layout.js"></script>
<script src="/js/mobile-native-experience.js"></script>
<script src="/js/mobile-tabs-handler.js"></script>
<script src="/js/messages-badge-desktop-mobile.js"></script>
</body>
</html>
