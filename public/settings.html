<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Boostinghost – Mes logements</title>

  <!-- Fonts (même que le reste de l'app) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- CSS plateforme -->
  <link rel="stylesheet" href="/css/style.css">

  <style>
    html, body {
      margin: 0 !important;
      padding: 0 !important;
    }

    .main-content {
      padding-top: 24px !important;
    }

    .page-content {
      margin-top: 0 !important;
    }

    .settings-container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0;
    }

    .properties-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .properties-grid {
      display: grid;
      gap: 16px;
    }

    .property-card {
      background: var(--bg-primary);
      border-radius: 18px;
      box-shadow: var(--shadow-sm);
      padding: 16px 18px;
      border-left: 4px solid var(--primary-color, #059669);
      transition: var(--transition, all .15s ease);
    }

    .property-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .property-header {
      display: flex;
      justify-content: space_between;
      align-items: flex-start;
      margin-bottom: 10px;
      gap: 12px;
    }

    .property-info {
      flex: 1;
      min-width: 0;
    }

    .property-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .color-badge {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid #fff;
      box-shadow: 0 0 0 1px rgba(15,23,42,.12);
      flex-shrink: 0;
    }

    .property-meta {
      color: var(--text-secondary);
      font-size: 13px;
    }

    .property-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .btn-icon-action {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      transition: var(--transition, all .15s ease);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .btn-edit {
      background: var(--bg-secondary, #f3f4f6);
      color: var(--primary-color, #059669);
    }

    .btn-edit:hover {
      background: var(--primary-color, #059669);
      color: #fff;
    }

    .btn-delete {
      background: var(--bg-secondary, #f3f4f6);
      color: #e11d48;
    }

    .btn-delete:hover {
      background: #e11d48;
      color: #fff;
    }

    .ical-urls {
      margin-top: 8px;
    }

    .ical-url-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      background: var(--bg-secondary, #f9fafb);
      border-radius: 12px;
      margin-bottom: 6px;
      font-size: 12px;
    }

    .ical-url-item i {
      color: var(--primary-color, #059669);
      font-size: 12px;
    }

    .ical-source {
      font-weight: 600;
      color: var(--text-primary);
      min-width: 80px;
      font-size: 12px;
    }

    .ical-url-text {
      flex: 1;
      color: var(--text-secondary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
    }

    
    .property-ical-export {
      margin-top: 10px;
      padding: 10px 12px;
      background: var(--bg-secondary, #f3f4f6);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .ical-export-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .ical-export-label i {
      font-size: 13px;
    }

    .ical-export-body {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ical-export-url {
      flex: 1;
      padding: 4px 8px;
      border-radius: 8px;
      background: #ffffff;
      border: 1px dashed rgba(148, 163, 184, 0.8);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      color: var(--text-primary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .btn-copy-ical {
      border: none;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(5, 150, 105, 0.08);
      color: var(--primary-color, #059669);
      cursor: pointer;
      white-space: nowrap;
      transition: var(--transition, all 0.15s ease);
    }

    .btn-copy-ical i {
      font-size: 12px;
    }

    .btn-copy-ical:hover {
      background: var(--primary-color, #059669);
      color: #ffffff;
    }

.btn-test-url {
      background: transparent;
      border: none;
      color: var(--primary-color, #059669);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
      transition: var(--transition, all .15s ease);
      white-space: nowrap;
    }

    .btn-test-url:hover {
      background: rgba(5,150,105,.08);
      color: var(--primary-color, #059669);
    }

    .btn-add-property {
      background: linear-gradient(135deg, var(--primary-color, #059669) 0%, var(--accent-color, #0ea5e9) 100%);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition, all .15s ease);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: var(--shadow-sm);
      white-space: nowrap;
    }

    .btn-add-property i {
      font-size: 13px;
    }

    .btn-add-property:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    /* Modal */

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.55);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-primary, #ffffff);
      border-radius: 18px;
      max-width: 520px;
      width: 94%;
      box-shadow: var(--shadow-xl, 0 24px 60px rgba(15,23,42,.35));
      overflow: hidden;
    }

    .modal-header {
      padding: 14px 18px;
      border-bottom: 1px solid var(--border-color, #e5e7eb);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .modal-header h2 {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-body {
      padding: 16px 18px 18px;
    }

    .modal-close {
      border: none;
      background: transparent;
      cursor: pointer;
      color: var(--text-secondary, #6b7280);
      padding: 4px;
    }

    .modal-close i {
      font-size: 14px;
    }

    .modal-form {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }

    .form-group label {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .form-group label i {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .form-group input,
    .form-group textarea {
      padding: 8px 10px;
      border: 1px solid var(--border-color, #e5e7eb);
      border-radius: 10px;
      font-size: 13px;
      font-family: inherit;
      transition: var(--transition, all .15s ease);
      background: var(--bg-secondary, #f9fafb);
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary-color, #059669);
      box-shadow: 0 0 0 1px rgba(5,150,105,.12);
      background: #ffffff;
    }

    .color-picker-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .color-picker {
      width: 52px;
      height: 32px;
      border: 1px solid var(--border-color, #e5e7eb);
      border-radius: 10px;
      cursor: pointer;
      padding: 0;
    }

    .color-preview {
      flex: 1;
      padding: 8px 10px;
      background: var(--bg-secondary, #f3f4f6);
      border-radius: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .url-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .url-input-group {
      display: flex;
      gap: 6px;
    }

    .url-input-group input {
      flex: 1;
    }

    .btn-remove-url {
      background: #fee2e2;
      color: #b91c1c;
      border: none;
      width: 34px;
      height: 34px;
      border-radius: 999px;
      cursor: pointer;
      transition: var(--transition, all .15s ease);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
    }

    .btn-remove-url:hover {
      background: #dc2626;
      color: #fff;
    }

    .btn-add-url {
      background: var(--bg-secondary, #f3f4f6);
      color: var(--primary-color, #059669);
      border: none;
      padding: 7px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 500;
      font-size: 12px;
      transition: var(--transition, all .15s ease);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }

    .btn-add-url:hover {
      background: var(--primary-color, #059669);
      color: #ffffff;
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 10px;
    }

    .btn-cancel {
      background: var(--bg-secondary, #f3f4f6);
      color: var(--text-primary);
      border: none;
      padding: 8px 14px;
      border-radius: 999px;
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      transition: var(--transition, all .15s ease);
    }

    .btn-cancel:hover {
      background: var(--border-color, #e5e7eb);
    }

    .btn-save {
      background: var(--primary-color, #059669);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: var(--transition, all .15s ease);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-save:hover {
      background: #047857;
    }

    .empty-state {
      text-align: center;
      padding: 32px 12px;
      color: var(--text-secondary);
      font-size: 13px;
    }

    .empty-state i {
      font-size: 40px;
      opacity: 0.25;
      margin-bottom: 8px;
    }

    .test-result {
      padding: 8px 10px;
      border-radius: 10px;
      margin-top: 6px;
      font-size: 12px;
    }

    .test-result.success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #22c55e;
    }

    .test-result.error {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #f97373;
    }

    .toast-container {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 1200;
    }

    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1100;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-spinner {
      background: var(--bg-primary, #fff);
      padding: 14px 16px;
      border-radius: 999px;
      box-shadow: var(--shadow-lg, 0 18px 40px rgba(15,23,42,.25));
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .loading-spinner i {
      font-size: 16px;
    }


    /* Améliorations UI pour les logements (photo, adresse, horaires, caution) */
    .photo-input-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .photo-preview {
      width: 72px;
      height: 72px;
      border-radius: 16px;
      background: var(--bg-secondary, #f3f4f6);
      border: 1px dashed var(--border-color, #e5e7eb);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      flex-shrink: 0;
    }

    .photo-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-placeholder {
      font-size: 20px;
      color: var(--text-secondary);
      opacity: 0.7;
    }

    .photo-input-actions input[type="file"] {
      font-size: 12px;
    }

    .field-help-text {
      display: block;
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .form-group-inline {
      flex-direction: row;
      gap: 10px;
    }

    .form-group-inline .form-group-inner {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .deposit-input-wrapper {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .deposit-input-wrapper input {
      flex: 1;
    }

    .deposit-suffix {
      font-size: 13px;
      color: var(--text-secondary);
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--bg-secondary, #f3f4f6);
    }

    .property-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 10px;
      margin-top: 4px;
      color: var(--text-secondary);
      font-size: 12px;
    }

    .property-meta-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--bg-secondary, #f3f4f6);
    }

    .property-meta-item i {
      font-size: 11px;
    }

    .property-photo {
      width: 72px;
      height: 72px;
      border-radius: 16px;
      background: var(--bg-secondary, #f3f4f6);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .property-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .property-header {
      display: flex;
      justify-content: space-between;
      align-items: stretch;
      gap: 12px;
    }

    .property-header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }

    .badge-no-deposit {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: var(--bg-secondary, #f3f4f6);
      color: var(--text-secondary);
    }

    .badge-deposit {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(5, 150, 105, 0.08);
      color: var(--primary-color, #059669);
    }

    .toast {
      background: var(--bg-primary, #fff);
      border-radius: 999px;
      box-shadow: var(--shadow-lg, 0 18px 40px rgba(15,23,42,.25));
      padding: 8px 12px;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-primary);
      animation: toast-in 0.2s ease-out;
    }

    .toast-success {
      border-left: 3px solid #16a34a;
    }

    .toast-error {
      border-left: 3px solid #dc2626;
    }

    .toast i {
      font-size: 13px;
    }

    @keyframes toast-in {
      from {
        opacity: 0;
        transform: translateY(4px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 640px) {
      .form-group-inline {
        flex-direction: column;
      }

      .property-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .property-header-right {
        align-items: flex-start;
      }
    }

    @media (max-width: 900px) {
      .settings-container {
        padding-top: 0;
      }
    }
  </style>

  <!-- Script auth + user + logout -->
  <script>
    (function () {
      const token = localStorage.getItem('lcc_token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      const rawUser = localStorage.getItem('lcc_user');
      let user = null;

      try {
        user = rawUser ? JSON.parse(rawUser) : null;
      } catch (e) {
        console.error('Impossible de lire lcc_user', e);
      }

      window.addEventListener('DOMContentLoaded', () => {
        if (user) {
          const nameEl = document.getElementById('sidebarUserName');
          const companyEl = document.getElementById('sidebarUserCompany');
          const avatarEl = document.getElementById('sidebarUserAvatar');

          if (nameEl) {
            nameEl.textContent = user.firstName
              ? user.firstName + (user.lastName ? ' ' + user.lastName : '')
              : (user.email || 'Mon compte');
          }

          if (companyEl) {
            companyEl.textContent = user.company || 'Mon espace';
          }

          if (avatarEl) {
            const initial = (user.firstName || user.email || '?').trim()[0] || 'U';
            avatarEl.textContent = initial.toUpperCase();
          }
        }

        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', function () {
            localStorage.removeItem('lcc_token');
            localStorage.removeItem('lcc_user');
            window.location.href = '/login.html';
          });
        }
      });
    })();
  </script>
</head>
<body data-page="settings">
  <!-- MOBILE HEADER -->
  <div class="mobile-header">
    <a href="/app.html" class="mobile-logo">
      <i class="fas fa-calendar-check"></i>
      <span class="mobile-logo-text">Bookingmanage</span>
    </a>
    <button class="mobile-menu-btn" id="mobileMenuBtn">
      <i class="fas fa-bars"></i>
    </button>
  </div>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div class="app-container">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="/" class="sidebar-logo">
          <i class="fas fa-calendar-check"></i>
          <div class="sidebar-logo-text">
            <span class="sidebar-logo-title">Bookingmanage</span>
            <span class="sidebar-logo-subtitle">Property Manager</span>
          </div>
        </a>
      </div>

      <nav class="sidebar-nav">
  <!-- PRINCIPAL -->
  <div class="nav-section">
    <div class="nav-section-title">Principal</div>

    <a href="/app.html" class="nav-item" data-page="app">
      <i class="fas fa-th-large"></i>
      <span>Dashboard</span>
    </a>

    <a href="/app.html#calendarSection" class="nav-item" id="navCalendarLink">
      <i class="fas fa-calendar"></i>
      <span>Calendrier</span>
      <span class="nav-badge" id="navTotalReservations">0</span>
    </a>

    <a href="/messages.html" class="nav-item" data-page="messages">
      <i class="fas fa-comment-dots"></i>
      <span>Messages</span>
    </a>
  </div>

  <!-- GESTION -->
  <div class="nav-section">
    <div class="nav-section-title">Gestion</div>

    <a href="/settings.html" class="nav-item active" data-page="settings">
      <i class="fas fa-home"></i>
      <span>Mes logements</span>
    </a>

    <a href="/welcome.html" class="nav-item" data-page="welcome">
      <i class="fas fa-book-open"></i>
      <span>Livret d'accueil</span>
    </a>

    <a href="/cleaning.html" class="nav-item" data-page="cleaning">
      <i class="fas fa-broom"></i>
      <span>Gestion du ménage</span>
      <span class="nav-badge">Nouveau</span>
    </a>

    <div class="nav-section">
  <div class="nav-section-title">Facturation</div>
  <a href="/factures.html" class="nav-item">
    <i class="fas fa-file-invoice"></i>
    <span>Factures clients</span>
  </a>
  <a href="/factures-proprietaires.html" class="nav-item">
    <i class="fas fa-file-invoice-dollar"></i>
    <span>Factures propriétaires</span>
  </a>
</div>


    <a href="/deposits.html" class="nav-item" data-page="deposits">
      <i class="fas fa-shield-alt"></i>
      <span>Cautions</span>
    </a>

    <a href="/notifications.html" class="nav-item" data-page="notifications">
      <i class="fas fa-bell"></i>
      <span>Notifications</span>
    </a>
  </div>

  <!-- PARAMÈTRES -->
  <div class="nav-section">
    <div class="nav-section-title">Paramètres</div>

    <a href="/settings-account.html" class="nav-item" data-page="settings-account">
      <i class="fas fa-cog"></i>
      <span>Paramètres</span>
    </a>

    <a href="/help.html" class="nav-item" data-page="help">
      <i class="fas fa-question-circle"></i>
      <span>Aide</span>
    </a>
  </div>
</nav>

      <div class="sidebar-footer">
        <div class="user-profile">
          <div class="user-avatar" id="sidebarUserAvatar">C</div>
          <div class="user-info">
            <div class="user-name" id="sidebarUserName">Utilisateur</div>
            <div class="user-email" id="sidebarUserCompany">Mon espace</div>
          </div>

          <button class="btn btn-ghost btn-xs" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main-content">
      <header class="main-header">
        <div class="header-left">
          <div class="page-kicker">Configuration</div>
          <h1 class="page-title">Mes logements</h1>
          <p class="page-subtitle">
            Gérez les logements de votre conciergerie et leurs connexions iCal (Airbnb, Booking, etc.).
          </p>
        </div>

        <div class="header-actions">
          <button class="btn btn-primary" onclick="openAddPropertyModal()">
            <i class="fas fa-plus"></i>
            <span>Ajouter un logement</span>
          </button>
        </div>
      </header>

      <div class="page-content">
        <section class="card">
          <div class="properties-header">
            <h2 class="card-title" style="display:flex;align-items:center;gap:8px;font-size:15px;font-weight:600;">
              <i class="fas fa-home"></i>
              <span>Logements configurés</span>
            </h2>
          </div>

          <div class="properties-grid" id="propertiesGrid">
            <!-- Les logements seront injectés ici par /js/settings.js -->
          </div>

          <div class="empty-state" id="propertiesEmptyState" style="display:none;">
            <i class="fas fa-home"></i>
            <p>Aucun logement configuré pour le moment.</p>
            <p>Commencez par ajouter votre premier logement.</p>
          </div>

          <div style="margin-top:10px;">
            <button class="btn-add-property" onclick="openAddPropertyModal()">
              <i class="fas fa-plus"></i>
              Ajouter un logement
            </button>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- MODAL: Éditer / Ajouter un logement -->
  <div class="modal" id="editPropertyModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">
          <i class="fas fa-home"></i>
          <span>Modifier le logement</span>
        </h2>
        <button class="modal-close" onclick="closeEditModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form class="modal-form" id="propertyForm" onsubmit="saveProperty(event)">
          <input type="hidden" id="propertyId">

          <div class="form-group">
            <label for="propertyName">
              <i class="fas fa-home"></i>
              <span>Nom du logement</span>
            </label>
            <input type="text" id="propertyName" required placeholder="Ex: Saint-Gratien - RDC">
          </div>

          <div class="form-group">
            <label for="propertyColor">
              <i class="fas fa-palette"></i>
              <span>Couleur</span>
            </label>
            <div class="color-picker-wrapper">
              <input type="color" id="propertyColor" class="color-picker" value="#E67E50">
              <div class="color-preview" id="colorPreview">#E67E50</div>
            </div>
          </div>

          <div class="form-group">
            <label>
              <i class="fas fa-link"></i>
              <span>URLs iCal</span>
            </label>
            <div class="url-list" id="urlList">
              <!-- URLs ajoutées ici via JS -->
            </div>
            <button type="button" class="btn-add-url" onclick="addUrlField()">
              <i class="fas fa-plus"></i>
              <span>Ajouter une URL</span>
            </button>
          </div>


          <!-- Détails du logement -->
          <div class="form-group">
            <label for="propertyPhoto">
              <i class="fas fa-image"></i>
              <span>Photo du logement</span>
            </label>
            <div class="photo-input-wrapper">
              <div class="photo-preview" id="photoPreview">
                <span class="photo-placeholder">
                  <i class="fas fa-image"></i>
                </span>
              </div>
              <div class="photo-input-actions">
                <input type="file" id="propertyPhoto" accept="image/*">
                <small class="field-help-text">Format JPG ou PNG, taille raisonnable recommandée.</small>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="propertyAddress">
              <i class="fas fa-map-marker-alt"></i>
              <span>Adresse du logement</span>
            </label>
            <input type="text" id="propertyAddress" placeholder="Ex: 25 boulevard de la République, 95210 Saint-Gratien">
          </div>

          <div class="form-group form-group-inline">
            <div class="form-group-inner">
              <label for="propertyCheckIn">
                <i class="fas fa-sign-in-alt"></i>
                <span>Heure d'arrivée</span>
              </label>
              <input type="time" id="propertyCheckIn" placeholder="16:00">
            </div>
            <div class="form-group-inner">
              <label for="propertyCheckOut">
                <i class="fas fa-sign-out-alt"></i>
                <span>Heure de départ</span>
              </label>
              <input type="time" id="propertyCheckOut" placeholder="11:00">
            </div>
          </div>

          <div class="form-group">
            <label for="propertyDeposit">
              <i class="fas fa-shield-alt"></i>
              <span>Montant de la caution</span>
            </label>
            <div class="deposit-input-wrapper">
              <input type="number" id="propertyDeposit" min="0" step="50" placeholder="Ex: 500">
              <span class="deposit-suffix">€</span>
            </div>
            <small class="field-help-text">Laissez vide si aucune caution n'est demandée.</small>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-cancel" onclick="closeEditModal()">Annuler</button>
            <button type="submit" class="btn-save">
              <i class="fas fa-save"></i>
              <span>Enregistrer</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast & Loading -->
  <div class="toast-container" id="toastContainer"></div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Chargement...</p>
    </div>
  </div>

  <!-- JS page (logique Mes logements améliorée) -->
  <script>
    (function() {
      const STORAGE_KEY = 'bookingmanage_properties_v2';

      let properties = [];
      let currentPhotoDataUrl = null;

      const gridEl = document.getElementById('propertiesGrid');
      const emptyStateEl = document.getElementById('propertiesEmptyState');
      const modalEl = document.getElementById('editPropertyModal');
      const modalTitleEl = document.getElementById('modalTitle');
      const formEl = document.getElementById('propertyForm');
      const propertyIdEl = document.getElementById('propertyId');
      const nameEl = document.getElementById('propertyName');
      const colorEl = document.getElementById('propertyColor');
      const colorPreviewEl = document.getElementById('colorPreview');
      const urlListEl = document.getElementById('urlList');
      const addressEl = document.getElementById('propertyAddress');
      const checkInEl = document.getElementById('propertyCheckIn');
      const checkOutEl = document.getElementById('propertyCheckOut');
      const depositEl = document.getElementById('propertyDeposit');
      const photoInputEl = document.getElementById('propertyPhoto');
      const photoPreviewEl = document.getElementById('photoPreview');
      const toastContainer = document.getElementById('toastContainer');

      function escapeHtml(str) {
        if (!str) return '';
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function createId(prefix) {
        return prefix + '_' + Date.now().toString(36) + '_' + Math.floor(Math.random() * 1e6).toString(36);
      }

      function showToast(message, type) {
        if (!toastContainer) return;
        const toast = document.createElement('div');
        toast.className = 'toast ' + (type === 'error' ? 'toast-error' : 'toast-success');
        const iconClass = type === 'error' ? 'fas fa-exclamation-circle' : 'fas fa-check-circle';
        toast.innerHTML = '<i class="' + iconClass + '"></i><span>' + escapeHtml(message) + '</span>';
        toastContainer.appendChild(toast);
        setTimeout(function() {
          toast.style.opacity = '0';
          toast.style.transform = 'translateY(4px)';
          setTimeout(function() {
            toast.remove();
          }, 200);
        }, 2800);
      }

      function savePropertiesToStorage() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(properties));
        } catch (e) {
          console.error('Erreur lors de la sauvegarde des logements', e);
        }
      }

      function loadPropertiesFromStorage() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          properties = raw ? JSON.parse(raw) : [];
        } catch (e) {
          console.error('Erreur lors du chargement des logements', e);
          properties = [];
        }
      }

      function formatDeposit(amount) {
        if (typeof amount !== 'number' || isNaN(amount) || amount <= 0) return '';
        try {
          return amount.toLocaleString('fr-FR', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
          }) + ' €';
        } catch (e) {
          return amount + ' €';
        }
      }

      function formatTimes(checkIn, checkOut) {
        const parts = [];
        if (checkIn) parts.push('Arrivée ' + checkIn);
        if (checkOut) parts.push('Départ ' + checkOut);
        return parts.join(' · ');
      }

      function updatePhotoPreview() {
        if (!photoPreviewEl) return;
        photoPreviewEl.innerHTML = '';
        if (currentPhotoDataUrl) {
          const img = document.createElement('img');
          img.src = currentPhotoDataUrl;
          img.alt = 'Photo du logement';
          photoPreviewEl.appendChild(img);
        } else {
          const span = document.createElement('span');
          span.className = 'photo-placeholder';
          span.innerHTML = '<i class="fas fa-image"></i>';
          photoPreviewEl.appendChild(span);
        }
      }

      function renderPropertyCard(prop) {
        const card = document.createElement('article');
        card.className = 'property-card';
        if (prop.color) {
          card.style.setProperty('--primary-color', prop.color);
        }

        const addressHtml = prop.address
          ? '<span class="property-meta-item"><i class="fas fa-map-marker-alt"></i><span>' +
            escapeHtml(prop.address) + '</span></span>'
          : '';

        const timesLabel = formatTimes(prop.checkIn, prop.checkOut);
        const timesHtml = timesLabel
          ? '<span class="property-meta-item"><i class="far fa-clock"></i><span>' +
            escapeHtml(timesLabel) + '</span></span>'
          : '';

        const hasDeposit = typeof prop.deposit === 'number' && !isNaN(prop.deposit) && prop.deposit > 0;
        const depositLabel = hasDeposit ? formatDeposit(prop.deposit) : '';
        const depositHtml = hasDeposit
          ? '<span class="property-meta-item badge-deposit"><i class="fas fa-shield-alt"></i><span>Caution ' +
            escapeHtml(depositLabel) + '</span></span>'
          : '<span class="property-meta-item badge-no-deposit"><i class="far fa-circle"></i><span>Pas de caution</span></span>';

        const photoHtml = prop.photoDataUrl
          ? '<div class="property-photo"><img src="' + prop.photoDataUrl + '" alt="Photo du logement ' +
            escapeHtml(prop.name || '') + '"></div>'
          : '<div class="property-photo"><span class="photo-placeholder"><i class="fas fa-image"></i></span></div>';

        let icalHtml = '';
        if (prop.icals && prop.icals.length) {
          icalHtml = prop.icals.map(function(entry) {
            const source = entry.source && entry.source.trim() ? entry.source : 'iCal';
            const url = entry.url || '';
            return (
              '<div class="ical-url-item">' +
                '<i class="fas fa-calendar-plus"></i>' +
                '<div class="ical-source">' + escapeHtml(source) + '</div>' +
                '<div class="ical-url-text" title="' + escapeHtml(url) + '">' + escapeHtml(url) + '</div>' +
                '<button type="button" class="btn-test-url">Tester</button>' +
                '<button type="button" class="btn-copy-ical"><i class="far fa-copy"></i>Copier</button>' +
              '</div>'
            );
          }).join('');
        } else {
          icalHtml =
            '<div class="ical-url-item">' +
              '<i class="fas fa-info-circle"></i>' +
              '<div class="ical-url-text">Aucune URL iCal configurée pour ce logement.</div>' +
            '</div>';
        }

        card.innerHTML =
          '<div class="property-header">' +
            '<div class="property-info">' +
              '<div class="property-name">' +
                '<span class="color-badge" style="background:' + escapeHtml(prop.color || '#059669') + ';"></span>' +
                '<span>' + escapeHtml(prop.name || 'Sans nom') + '</span>' +
              '</div>' +
              '<div class="property-meta">' +
                addressHtml +
                timesHtml +
                depositHtml +
              '</div>' +
            '</div>' +
            '<div class="property-header-right">' +
              photoHtml +
              '<div class="property-actions">' +
                '<button class="btn-icon-action btn-edit" type="button" title="Modifier">' +
                  '<i class="fas fa-pen"></i>' +
                '</button>' +
                '<button class="btn-icon-action btn-delete" type="button" title="Supprimer">' +
                  '<i class="fas fa-trash"></i>' +
                '</button>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<div class="ical-urls">' + icalHtml + '</div>';

        const editBtn = card.querySelector('.btn-edit');
        const deleteBtn = card.querySelector('.btn-delete');
        if (editBtn) {
          editBtn.addEventListener('click', function() {
            openEditPropertyModalInternal(prop.id);
          });
        }
        if (deleteBtn) {
          deleteBtn.addEventListener('click', function() {
            deletePropertyInternal(prop.id);
          });
        }

        const testButtons = card.querySelectorAll('.btn-test-url');
        const copyButtons = card.querySelectorAll('.btn-copy-ical');

        testButtons.forEach(function(btn, index) {
          btn.addEventListener('click', function() {
            if (prop.icals && prop.icals[index] && prop.icals[index].url) {
              testIcalUrlInternal(prop.icals[index].url);
            }
          });
        });

        copyButtons.forEach(function(btn, index) {
          btn.addEventListener('click', function() {
            if (prop.icals && prop.icals[index] && prop.icals[index].url) {
              copyIcalUrlInternal(prop.icals[index].url);
            }
          });
        });

        return card;
      }

      function renderProperties() {
        if (!gridEl || !emptyStateEl) return;
        gridEl.innerHTML = '';
        if (!properties.length) {
          emptyStateEl.style.display = 'block';
          return;
        }
        emptyStateEl.style.display = 'none';
        properties.forEach(function(prop) {
          const card = renderPropertyCard(prop);
          gridEl.appendChild(card);
        });
      }

      function resetForm() {
        if (!formEl) return;
        formEl.reset();
        propertyIdEl.value = '';
        currentPhotoDataUrl = null;
        updatePhotoPreview();
        if (urlListEl) {
          urlListEl.innerHTML = '';
          addUrlField();
        }
        if (colorEl && colorPreviewEl) {
          colorPreviewEl.textContent = colorEl.value || '#E67E50';
          colorPreviewEl.style.background = colorEl.value || '#E67E50';
        }
      }

      function openAddPropertyModalInternal() {
        if (!modalEl) return;
        if (modalTitleEl) {
          const span = modalTitleEl.querySelector('span');
          if (span) span.textContent = 'Ajouter un logement';
        }
        resetForm();
        modalEl.classList.add('active');
        if (nameEl) {
          setTimeout(function() {
            nameEl.focus();
          }, 60);
        }
      }

      function openEditPropertyModalInternal(id) {
        if (!modalEl) return;
        const prop = properties.find(function(p) { return p.id === id; });
        if (!prop) return;

        if (modalTitleEl) {
          const span = modalTitleEl.querySelector('span');
          if (span) span.textContent = 'Modifier le logement';
        }

        propertyIdEl.value = prop.id || '';
        nameEl.value = prop.name || '';
        addressEl.value = prop.address || '';
        checkInEl.value = prop.checkIn || '';
        checkOutEl.value = prop.checkOut || '';
        if (typeof prop.deposit === 'number' && !isNaN(prop.deposit) && prop.deposit > 0) {
          depositEl.value = prop.deposit;
        } else {
          depositEl.value = '';
        }
        colorEl.value = prop.color || '#E67E50';
        if (colorPreviewEl) {
          colorPreviewEl.textContent = colorEl.value;
          colorPreviewEl.style.background = colorEl.value;
        }

        currentPhotoDataUrl = prop.photoDataUrl || null;
        updatePhotoPreview();

        if (urlListEl) {
          urlListEl.innerHTML = '';
          if (prop.icals && prop.icals.length) {
            prop.icals.forEach(function(entry) {
              addUrlField(entry);
            });
          } else {
            addUrlField();
          }
        }

        modalEl.classList.add('active');
      }

      function closeEditModalInternal() {
        if (!modalEl) return;
        modalEl.classList.remove('active');
      }

      function addUrlField(data) {
        if (!urlListEl) return;
        const sourceVal = data && data.source ? data.source : '';
        const urlVal = data && data.url ? data.url : '';

        const wrapper = document.createElement('div');
        wrapper.className = 'url-input-group';

        const sourceInput = document.createElement('input');
        sourceInput.type = 'text';
        sourceInput.className = 'url-source-input';
        sourceInput.placeholder = 'Plateforme (Airbnb, Booking, etc.)';
        sourceInput.value = sourceVal;

        const urlInput = document.createElement('input');
        urlInput.type = 'url';
        urlInput.className = 'url-value-input';
        urlInput.placeholder = 'URL iCal (https://...)';
        urlInput.value = urlVal;

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn-remove-url';
        removeBtn.title = 'Supprimer cette URL';
        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
        removeBtn.addEventListener('click', function() {
          urlListEl.removeChild(wrapper);
          if (!urlListEl.children.length) {
            addUrlField();
          }
        });

        wrapper.appendChild(sourceInput);
        wrapper.appendChild(urlInput);
        wrapper.appendChild(removeBtn);

        urlListEl.appendChild(wrapper);
      }

      function savePropertyInternal(event) {
        if (event && event.preventDefault) event.preventDefault();
        if (!nameEl || !colorEl) return;

        const name = nameEl.value.trim();
        if (!name) {
          showToast('Merci de renseigner un nom de logement.', 'error');
          nameEl.focus();
          return false;
        }

        const icals = [];
        if (urlListEl) {
          const groups = urlListEl.querySelectorAll('.url-input-group');
          groups.forEach(function(group) {
            const sourceInput = group.querySelector('.url-source-input');
            const urlInput = group.querySelector('.url-value-input');
            const url = urlInput && urlInput.value ? urlInput.value.trim() : '';
            const source = sourceInput && sourceInput.value ? sourceInput.value.trim() : '';
            if (url) {
              icals.push({
                source: source,
                url: url
              });
            }
          });
        }

        const depositRaw = depositEl && depositEl.value ? depositEl.value.trim() : '';
        let deposit = null;
        if (depositRaw) {
          const normalized = depositRaw.replace(',', '.');
          const parsed = Number(normalized);
          if (!isNaN(parsed) && parsed > 0) {
            deposit = parsed;
          }
        }

        const data = {
          id: propertyIdEl && propertyIdEl.value ? propertyIdEl.value : createId('property'),
          name: name,
          color: colorEl.value || '#E67E50',
          address: addressEl && addressEl.value ? addressEl.value.trim() : '',
          checkIn: checkInEl && checkInEl.value ? checkInEl.value : '',
          checkOut: checkOutEl && checkOutEl.value ? checkOutEl.value : '',
          deposit: deposit,
          photoDataUrl: currentPhotoDataUrl,
          icals: icals
        };

        const existingIndex = properties.findIndex(function(p) { return p.id === data.id; });
        if (existingIndex >= 0) {
          properties[existingIndex] = data;
        } else {
          properties.push(data);
        }

        savePropertiesToStorage();
        renderProperties();
        closeEditModalInternal();
        showToast('Logement enregistré.');
        return false;
      }

      function deletePropertyInternal(id) {
        const prop = properties.find(function(p) { return p.id === id; });
        const label = prop && prop.name ? '"' + prop.name + '"' : 'ce logement';
        if (!window.confirm('Supprimer ' + label + ' ?')) return;
        properties = properties.filter(function(p) { return p.id !== id; });
        savePropertiesToStorage();
        renderProperties();
        showToast('Logement supprimé.');
      }

      function testIcalUrlInternal(url) {
        if (!url) return;
        try {
          const finalUrl = url.trim();
          if (!finalUrl) return;
          window.open(finalUrl, '_blank', 'noopener');
        } catch (e) {
          console.error('Erreur lors de l\'ouverture de l\'URL iCal', e);
        }
      }

      function copyIcalUrlInternal(url) {
        if (!url) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url)
            .then(function() {
              showToast('URL copiée dans le presse-papiers.');
            })
            .catch(function() {
              showToast('Impossible de copier l\'URL.', 'error');
            });
        } else {
          const textarea = document.createElement('textarea');
          textarea.value = url;
          document.body.appendChild(textarea);
          textarea.select();
          try {
            document.execCommand('copy');
            showToast('URL copiée dans le presse-papiers.');
          } catch (e) {
            showToast('Impossible de copier l\'URL.', 'error');
          }
          document.body.removeChild(textarea);
        }
      }

      // Expose required functions to the global scope for HTML handlers
      window.openAddPropertyModal = openAddPropertyModalInternal;
      window.openEditPropertyModal = openEditPropertyModalInternal;
      window.closeEditModal = closeEditModalInternal;
      window.addUrlField = addUrlField;
      window.saveProperty = savePropertyInternal;
      window.deleteProperty = deletePropertyInternal;
      window.testIcalUrl = testIcalUrlInternal;
      window.copyIcalUrl = copyIcalUrlInternal;

      if (colorEl && colorPreviewEl) {
        colorPreviewEl.textContent = colorEl.value || '#E67E50';
        colorPreviewEl.style.background = colorEl.value || '#E67E50';
        colorEl.addEventListener('input', function() {
          colorPreviewEl.textContent = colorEl.value;
          colorPreviewEl.style.background = colorEl.value;
        });
      }

      if (photoInputEl) {
        photoInputEl.addEventListener('change', function() {
          const file = this.files && this.files[0];
          if (!file) return;
          if (!file.type || file.type.indexOf('image/') !== 0) {
            showToast('Merci de sélectionner une image.', 'error');
            this.value = '';
            return;
          }
          const reader = new FileReader();
          reader.onload = function(e) {
            currentPhotoDataUrl = e.target && e.target.result ? e.target.result : null;
            updatePhotoPreview();
          };
          reader.readAsDataURL(file);
        });
      }

      if (modalEl) {
        modalEl.addEventListener('click', function(event) {
          if (event.target === modalEl) {
            closeEditModalInternal();
          }
        });
      }

      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && modalEl && modalEl.classList.contains('active')) {
          closeEditModalInternal();
        }
      });

      // Initialisation
      loadPropertiesFromStorage();
      renderProperties();
      if (urlListEl && !urlListEl.children.length) {
        addUrlField();
      }
    })();
  </script>

  <!-- MOBILE MENU SCRIPT -->
  <script>
    (function() {
      const menuBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      
      if (menuBtn && sidebar && overlay) {
        menuBtn.addEventListener('click', function() {
          sidebar.classList.toggle('active');
          overlay.classList.toggle('active');
          
          const icon = menuBtn.querySelector('i');
          if (sidebar.classList.contains('active')) {
            icon.classList.remove('fa-bars');
            icon.classList.add('fa-times');
          } else {
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
          }
        });
        
        overlay.addEventListener('click', function() {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          const icon = menuBtn.querySelector('i');
          icon.classList.remove('fa-times');
          icon.classList.add('fa-bars');
        });
        
        if (window.innerWidth <= 1024) {
          document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
              sidebar.classList.remove('active');
              overlay.classList.remove('active');
              const icon = menuBtn.querySelector('i');
              icon.classList.remove('fa-times');
              icon.classList.add('fa-bars');
            });
          });
        }
      }
    })();
    
    (function() {
      const currentPage = document.body.getAttribute('data-page');
      if (currentPage) {
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.remove('active');
        });
        const activeLink = document.querySelector('.nav-item[data-page="settings"]');
        if (activeLink) {
          activeLink.classList.add('active');
        }
      }
    })();
    
    document.getElementById('logoutBtn')?.addEventListener('click', function() {
      localStorage.removeItem('lcc_token');
      localStorage.removeItem('lcc_user');
      window.location.href = '/login.html';
    });
    
    (function() {
      const user = JSON.parse(localStorage.getItem('lcc_user') || '{}');
      if (user.firstName) {
        const nameEl = document.getElementById('sidebarUserName');
        const avatarEl = document.getElementById('sidebarUserAvatar');
        if (nameEl) nameEl.textContent = user.firstName + ' ' + (user.lastName || '');
        if (avatarEl) avatarEl.textContent = user.firstName.charAt(0).toUpperCase();
      }
      if (user.company) {
        const companyEl = document.getElementById('sidebarUserCompany');
        if (companyEl) companyEl.textContent = user.company;
      }
    })();
  </script>
</body>
</html>
