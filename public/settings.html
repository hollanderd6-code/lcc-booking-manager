<!DOCTYPE html>

<html data-theme="light" lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
<title>Boostinghost ‚Äì Mes logements</title>
<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>
<!-- Global CSS de l'app -->
<link href="/css/style.css" rel="stylesheet"/><link href="/css/bh-shared.css?v=1" rel="stylesheet"/><link href="/css/bottom-bar-enhanced.css" rel="stylesheet"/>
<link href="/css/tablet-bottom-bar-fix.css" rel="stylesheet"/>
<link href="/css/messages-badge-fix.css" rel="stylesheet"/>
<link rel="stylesheet" href="/css/messages-badge-red.css">
<link rel="stylesheet" href="/css/messages-badge-desktop.css">    
    <style>
    html, body {
      margin: 0 !important;
      }

    /* (patched) removed inline .main-content padding override for iOS safe-area */

    .page-content {
      margin-top: 0 !important;
    }

    .settings-container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0;
    }

    .properties-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .properties-grid {
      display: grid;
      gap: 16px;
    }

    .property-card {
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.06);
      padding: 18px 20px;
      border-left: 4px solid var(--primary-color, #059669);
      transition: var(--transition, all .15s ease);
    }

    .property-card:hover {
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.12);
      transform: translateY(-2px);
    }

    .property-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
      gap: 12px;
    }

    .property-info {
      flex: 1;
      min-width: 0;
    }

    .property-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .color-badge {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid #fff;
      box-shadow: 0 0 0 1px rgba(15,23,42,.12);
      flex-shrink: 0;
    }

    .property-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .meta-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--bg-secondary, #f3f4f6);
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .meta-badge i {
      font-size: 11px;
    }

    .property-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
      margin-bottom: 8px;
    }

    .btn-icon-action {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      transition: var(--transition, all .15s ease);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .btn-edit {
      background: var(--bg-secondary, #f3f4f6);
      color: var(--primary-color, #059669);
    }

    .btn-edit:hover {
      background: var(--primary-color, #059669);
      color: #fff;
    }

    .btn-delete {
      background: var(--bg-secondary, #f3f4f6);
      color: #e11d48;
    }

    .btn-delete:hover {
      background: #e11d48;
      color: #fff;
    }

    .property-photo-wrapper {
      width: 150px;
      height: 100px;
      border-radius: 14px;
      overflow: hidden;
      background: var(--bg-secondary, #f3f4f6);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      position: relative;
    }

    .property-photo-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .property-photo-placeholder {
      font-size: 22px;
      color: var(--text-secondary);
      opacity: 0.6;
    }

    .ical-urls {
      margin-top: 10px;
    }

    .ical-url-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      background: var(--bg-secondary, #f9fafb);
      border-radius: 12px;
      margin-bottom: 6px;
      font-size: 12px;
    }

    .ical-source {
      font-weight: 600;
      color: var(--text-primary);
      min-width: 90px;
      font-size: 12px;
    }

    .ical-url-text {
      flex: 1;
      color: var(--text-secondary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
    }

    .btn-test-url {
      background: transparent;
      border: none;
      color: var(--primary-color, #059669);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
      transition: var(--transition, all .15s ease);
      white-space: nowrap;
    }

    .btn-test-url:hover {
      background: rgba(5,150,105,.08);
      color: var(--primary-color, #059669);
    }

    .btn-copy-ical {
      border: none;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(5, 150, 105, 0.08);
      color: var(--primary-color, #059669);
      cursor: pointer;
      white-space: nowrap;
      transition: var(--transition, all 0.15s ease);
    }

    .btn-copy-ical:hover {
      background: var(--primary-color, #059669);
      color: #ffffff;
    }

    .boostinghost-ical {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 12px;
      background: #fefce8;
      border: 1px solid #facc15;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      flex-wrap: wrap;
    }

    .boostinghost-ical-label {
      font-weight: 600;
      color: #854d0e;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .boostinghost-ical-url {
      flex: 1;
      min-width: 0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      color: #713f12;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .btn-copy-boostinghost {
      border: none;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #fef3c7;
      color: #b45309;
      cursor: pointer;
      white-space: nowrap;
      transition: var(--transition, all 0.15s ease);
    }

    .btn-copy-boostinghost:hover {
      background: #facc15;
      color: #713f12;
    }

    .btn-add-property {
      background: linear-gradient(135deg, var(--primary-color, #059669) 0%, var(--accent-color, #0ea5e9) 100%);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition, all .15s ease);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: var(--shadow-sm);
      white-space: nowrap;
    }

    .btn-add-property i {
      font-size: 13px;
    }

    .btn-add-property:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    /* Modal */

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.55);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-primary, #ffffff);
      border-radius: 18px;
      max-width: 620px;
      width: 94%;
      box-shadow: var(--shadow-xl, 0 24px 60px rgba(15,23,42,.35));
      overflow: hidden;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }
    
    .modal-body {
      padding: 16px 18px 18px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-close {
      border: none;
      background: transparent;
      cursor: pointer;
      color: var(--text-secondary, #6b7280);
      padding: 4px;
    }

    .modal-close i {
      font-size: 14px;
    }

    .modal-form {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .form-grid-2 {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 12px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }

    .form-group label {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .form-group label i {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .form-group input,
    .form-group textarea {
      padding: 8px 10px;
      border: 1px solid var(--border-color, #e5e7eb);
      border-radius: 10px;
      font-size: 13px;
      font-family: inherit;
      transition: var(--transition, all .15s ease);
      background: var(--bg-secondary, #f9fafb);
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary-color, #059669);
      box-shadow: 0 0 0 1px rgba(5,150,105,.12);
      background: #ffffff;
    }

    .color-picker-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .color-picker {
      width: 52px;
      height: 32px;
      border: 1px solid var(--border-color, #e5e7eb);
      border-radius: 10px;
      cursor: pointer;
      padding: 0;
    }

    .color-preview {
      flex: 1;
      padding: 8px 10px;
      background: var(--bg-secondary, #f3f4f6);
      border-radius: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .photo-preview-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .photo-preview-box {
      width: 96px;
      height: 72px;
      border-radius: 14px;
      overflow: hidden;
      background: var(--bg-secondary, #f3f4f6);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      flex-shrink: 0;
    }

    .photo-preview-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-preview-placeholder {
      font-size: 22px;
      color: var(--text-secondary);
      opacity: 0.6;
    }

    .photo-preview-text {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .input-with-suffix {
      display: flex;
      align-items: center;
      border-radius: 10px;
      border: 1px solid var(--border-color, #e5e7eb);
      overflow: hidden;
      background: var(--bg-secondary, #f9fafb);
    }

    .input-with-suffix input {
      border: none;
      background: transparent;
      flex: 1;
      padding: 8px 10px;
    }

    .input-with-suffix span {
      padding: 8px 10px;
      font-size: 12px;
      color: var(--text-secondary);
      border-left: 1px solid var(--border-color, #e5e7eb);
      background: #f3f4f6;
    }

    .url-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .url-input-group {
      display: grid;
      grid-template-columns: 140px minmax(0, 1fr) 36px;
      gap: 6px;
      align-items: center;
    }

    .url-input-group input {
      width: 100%;
    }

    .btn-remove-url {
      background: #fee2e2;
      color: #b91c1c;
      border: none;
      width: 34px;
      height: 34px;
      border-radius: 999px;
      cursor: pointer;
      transition: var(--transition, all .15s ease);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
    }

    .btn-remove-url:hover {
      background: #dc2626;
      color: #fff;
    }

    .btn-add-url {
      background: var(--bg-secondary, #f3f4f6);
      color: var(--primary-color, #059669);
      border: none;
      padding: 7px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 500;
      font-size: 12px;
      transition: var(--transition, all .15s ease);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }

    .btn-add-url:hover {
      background: var(--primary-color, #059669);
      color: #ffffff;
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 10px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color, #e5e7eb);
      background: var(--bg-primary, #ffffff);
      position: sticky;
      bottom: 0;
      margin-left: -18px;
      margin-right: -18px;
      margin-bottom: -18px;
      padding-left: 18px;
      padding-right: 18px;
      padding-bottom: 18px;
    }

    .btn-cancel {
      background: var(--bg-secondary, #f3f4f6);
      color: var(--text-primary);
      border: none;
      padding: 8px 14px;
      border-radius: 999px;
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      transition: var(--transition, all .15s ease);
    }

    .btn-cancel:hover {
      background: var(--border-color, #e5e7eb);
    }

    .btn-save {
      background: var(--primary-color, #059669);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: var(--transition, all .15s ease);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-save:hover {
      background: #047857;
    }

    .empty-state {
      text-align: center;
      padding: 32px 12px;
      color: var(--text-secondary);
      font-size: 13px;
    }

    .empty-state i {
      font-size: 40px;
      opacity: 0.25;
      margin-bottom: 8px;
    }

    .toast-container {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 1200;
    }

    .toast {
      min-width: 220px;
      max-width: 320px;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: 0 18px 40px rgba(15,23,42,.25);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      margin-top: 8px;
      color: #0f172a;
      background: #ffffff;
    }

    .toast-success {
      border-left: 4px solid #16a34a;
    }

    .toast-error {
      border-left: 4px solid #ef4444;
    }

    .toast i {
      font-size: 14px;
    }

    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1100;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-spinner {
      background: var(--bg-primary, #fff);
      padding: 14px 16px;
      border-radius: 999px;
      box-shadow: var(--shadow-lg, 0 18px 40px rgba(15,23,42,.25));
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .loading-spinner i {
      font-size: 16px;
    }

/* ========================================
   CORRECTIONS MOBILE ULTRA-COMPL√àTES
   ======================================== */

@media (max-width: 768px) {
  /* RESET containers */
  body {
    overflow-x: hidden !important;
  }
  
  .settings-container {
    padding: 8px !important;
    width: 100% !important;
    max-width: 100% !important;
    overflow-x: hidden !important;
  }
  
  /* Header */
  .properties-header {
    flex-direction: column !important;
    align-items: stretch !important;
    gap: 12px !important;
    margin-bottom: 12px !important;
  }
  
  .properties-header h1 {
    font-size: 22px !important;
    margin-bottom: 0 !important;
  }
  
  .properties-header .btn {
    width: 100% !important;
    justify-content: center !important;
    padding: 12px 16px !important;
  }
  
  /* Cards */
  .property-card {
    padding: 12px !important;
    margin-bottom: 12px !important;
    overflow: hidden !important;
  }
  
  .property-header {
    flex-direction: column !important;
    gap: 10px !important;
  }
  
  .property-info {
    width: 100% !important;
  }
  
  .property-name {
    font-size: 16px !important;
    word-break: break-word !important;
  }
  
  .property-meta {
    flex-wrap: wrap !important;
    gap: 6px !important;
  }
  
  .meta-badge {
    font-size: 11px !important;
    padding: 4px 8px !important;
    white-space: nowrap !important;
  }
  
  /* Actions */
  .property-actions {
    display: flex !important;
    flex-direction: column !important;
    gap: 8px !important;
    width: 100% !important;
  }
  
  .property-actions .btn {
    width: 100% !important;
    padding: 10px 12px !important;
    font-size: 14px !important;
    justify-content: center !important;
  }
  
  /* URLs et liens - FIX CRITIQUE */
  .url-copy-section {
    display: flex !important;
    flex-direction: column !important;
    gap: 8px !important;
    width: 100% !important;
    overflow: hidden !important;
  }
  
  .url-copy-section input,
  .url-copy-section .form-input {
    width: 100% !important;
    font-size: 12px !important;
    padding: 10px !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    white-space: nowrap !important;
  }
  
  .url-copy-section button,
  .url-copy-section .btn {
    width: 100% !important;
    padding: 10px !important;
  }
  
  /* Chat section verte - FIX IMPORTANT */
  .chat-link-section,
  .url-display-section {
    padding: 12px !important;
    margin: 10px 0 !important;
    overflow: hidden !important;
  }
  
  .chat-link-section input,
  .url-display-section input {
    width: 100% !important;
    max-width: 100% !important;
    font-size: 11px !important;
    padding: 8px !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
  }
  
  /* URL groups */
  .url-input-group {
    flex-direction: column !important;
    gap: 8px !important;
    margin-bottom: 10px !important;
  }
  
  .url-input-group input,
  .url-input-group select {
    width: 100% !important;
    max-width: 100% !important;
    font-size: 14px !important;
  }
  
  .platform-input {
    width: 100% !important;
  }
  
  .url-input {
    width: 100% !important;
    font-size: 12px !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
  }
  
  /* Modal */
  .modal {
    padding: 0 !important;
  }
  
  .modal-content {
    width: 100% !important;
    max-width: 100% !important;
    height: 100vh !important;
    max-height: 100vh !important;
    margin: 0 !important;
    border-radius: 0 !important;
    overflow-y: auto !important;
  }
  
  .modal-header {
    padding: 14px 16px !important;
    position: sticky !important;
    top: 0 !important;
    background: white !important;
    z-index: 10 !important;
  }
  
  .modal-header h2 {
    font-size: 18px !important;
  }
  
  .modal-body {
    padding: 16px !important;
    overflow-x: hidden !important;
  }
  
  .modal-footer {
    padding: 14px 16px !important;
    position: sticky !important;
    bottom: 0 !important;
    background: white !important;
    border-top: 1px solid #e5e7eb !important;
    flex-direction: column-reverse !important;
    gap: 10px !important;
  }
  
  .modal-footer .btn {
    width: 100% !important;
    margin: 0 !important;
  }
  
  /* Forms */
  .form-grid-2 {
    grid-template-columns: 1fr !important;
    gap: 14px !important;
  }
  
  .form-group {
    margin-bottom: 14px !important;
    width: 100% !important;
  }
  
  .form-label {
    font-size: 14px !important;
    margin-bottom: 6px !important;
  }
  
  .form-input,
  .form-select,
  .form-textarea {
    width: 100% !important;
    font-size: 16px !important; /* Anti-zoom iOS */
    padding: 12px !important;
  }
  
  .form-textarea {
    min-height: 100px !important;
  }
  
  /* Checkboxes */
  .checkbox-grid {
    grid-template-columns: 1fr !important;
    gap: 10px !important;
  }
  
  .checkbox-item {
    padding: 12px !important;
    width: 100% !important;
  }
  
  /* Photo */
  .photo-upload-box,
  .photo-preview-box {
    height: 180px !important;
  }
  
  /* Sections */
  .form-section-header {
    margin-top: 20px !important;
    font-size: 15px !important;
  }
  
  /* Toggle */
  .toggle-section {
    flex-direction: column !important;
    align-items: flex-start !important;
    gap: 10px !important;
  }
  
  /* Info box */
  .info-box {
    padding: 12px !important;
    font-size: 13px !important;
  }
  
  /* Boutons g√©n√©raux */
  .btn {
    font-size: 14px !important;
    padding: 10px 14px !important;
  }
  
  .btn-primary {
    width: 100% !important;
  }
}

/* Tr√®s petits √©crans */
@media (max-width: 480px) {
  .settings-container {
    padding: 6px !important;
  }
  
  .property-card {
    padding: 10px !important;
  }
  
  .properties-header h1 {
    font-size: 20px !important;
  }
  
  .property-name {
    font-size: 15px !important;
  }
  
  .url-copy-section input,
  .chat-link-section input {
    font-size: 10px !important;
    padding: 8px !important;
  }
  
  .meta-badge {
    font-size: 10px !important;
    padding: 3px 6px !important;
  }
}
  </style>
<!-- Script auth + user + logout -->
<script src="/js/auth-fetch.js"></script>
<script>
    (function () {
      const token = localStorage.getItem('lcc_token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      const rawUser = localStorage.getItem('lcc_user');
      let user = null;

      try {
        user = rawUser ? JSON.parse(rawUser) : null;
      } catch (e) {
        console.error('Impossible de lire lcc_user', e);
      }

      window.addEventListener('DOMContentLoaded', () => {
        if (user) {
          const nameEl = document.getElementById('sidebarUserName');
          const companyEl = document.getElementById('sidebarUserCompany');
          const avatarEl = document.getElementById('sidebarUserAvatar');

          if (nameEl) {
            nameEl.textContent = user.firstName
              ? user.firstName + (user.lastName ? ' ' + user.lastName : '')
              : (user.email || 'Mon compte');
          }

          if (companyEl) {
            companyEl.textContent = user.company || 'Mon espace';
          }

          if (avatarEl) {
            const initial = (user.firstName || user.email || '?').trim()[0] || 'U';
            avatarEl.textContent = initial.toUpperCase();
          }
        }

        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', function () {
            localStorage.removeItem('lcc_token');
            localStorage.removeItem('lcc_user');
            window.location.href = '/login.html';
          });
        }
      });
    })();
  </script>
<link rel="stylesheet" href="/css/mobile-native-styles.css">
</head>
<body data-back-href="/app.html" data-back-label="Retour au dashboard" data-kicker="Gestion" data-page="settings" data-subtitle="Ajoutez, modifiez et organisez vos logements." data-title="Mes logements">
<!-- MOBILE HEADER -->
<div class="mobile-header">
<a class="mobile-logo" href="/app.html">
<i class="fas fa-calendar-check"></i>
<span class="mobile-logo-text">Bookingmanage</span>
</a>
<button class="mobile-menu-btn" id="mobileMenuBtn">
<i class="fas fa-bars"></i>
</button>
</div>
<div class="sidebar-overlay" id="sidebarOverlay"></div>
<div class="app-container">
<!-- Sidebar -->
<div id="bhSidebar"></div>
<!-- MAIN -->
<main class="main-content"><div id="bhHeader"></div>

<div class="page-content">
<section class="card settings-container">
<div class="properties-header">
<h2 class="card-title" style="display:flex;align-items:center;gap:8px;font-size:15px;font-weight:600;">
<i class="fas fa-home"></i>
<span>Logements configur√©s</span>
</h2>
</div>
<div class="properties-grid" id="propertiesGrid">
<!-- Logements inject√©s ici par settings.js -->
</div>
<div class="empty-state" id="propertiesEmptyState" style="display:none;">
<i class="fas fa-home"></i>
<p>Aucun logement configur√© pour le moment.</p>
<p>Commencez par ajouter votre premier logement.</p>
</div>
<div style="margin-top:10px;">
<button class="btn-add-property" id="btnAddProperty" onclick="handleAddPropertyClick()">
<i class="fas fa-plus"></i>
  Ajouter un logement
</button>
<span id="propertyQuotaBadge" style="display:none; margin-left:10px; font-size:13px; color:#6b7280;"></span>
</div>

<!-- MODAL CONFIRMATION logement suppl√©mentaire payant -->
<div id="extraPropertyModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:16px; padding:32px; max-width:420px; width:90%; box-shadow:0 20px 60px rgba(0,0,0,0.2);">
    <div style="text-align:center; margin-bottom:20px;">
      <div style="width:56px;height:56px;background:#fef3c7;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;">
        <i class="fas fa-home" style="color:#f59e0b;font-size:22px;"></i>
      </div>
      <h3 style="font-size:18px;font-weight:700;color:#111827;margin:0 0 8px;">Logement suppl√©mentaire</h3>
      <p id="extraPropertyModalText" style="color:#6b7280;font-size:14px;margin:0;line-height:1.5;"></p>
    </div>
    <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:14px;margin-bottom:20px;text-align:center;">
      <p id="extraPropertyPriceText" style="font-weight:700;color:#059669;font-size:16px;margin:0;"></p>
      <p style="color:#6b7280;font-size:12px;margin:4px 0 0;">Ajout√© automatiquement √† votre abonnement</p>
    </div>
    <div style="display:flex;gap:12px;">
      <button onclick="closeExtraPropertyModal()" style="flex:1;padding:12px;border:2px solid #e5e7eb;background:#fff;border-radius:10px;font-weight:600;cursor:pointer;font-size:14px;">Annuler</button>
      <button onclick="confirmAddExtraProperty()" id="btnConfirmExtra" style="flex:1;padding:12px;background:#10b981;color:#fff;border:none;border-radius:10px;font-weight:600;cursor:pointer;font-size:14px;">Confirmer</button>
    </div>
  </div>
</div>
</section>
</div>
</main>
</div>
<!-- MODAL: √âditer / Ajouter un logement -->
<div class="modal" id="editPropertyModal">
<div class="modal-content">
<div class="modal-header">
<h2 id="modalTitle">
<i class="fas fa-home"></i>
<span>Modifier le logement</span>
</h2>
<button class="modal-close" onclick="closeEditModal()">
<i class="fas fa-times"></i>
</button>
</div>
<div class="modal-body">
<form class="modal-form" id="propertyForm" onsubmit="saveProperty(event)">
<input id="propertyId" type="hidden"/>
<input id="propertyPhotoUrl" type="hidden"/>
<div class="form-grid-2">
<div class="form-group">
<label for="propertyName">
<i class="fas fa-home"></i>
<span>Nom du logement</span>
</label>
<input id="propertyName" placeholder="Ex: Saint-Gratien - RDC" required="" type="text"/>
</div>
<div class="form-group">
<label for="propertyOwnerId">
<i class="fas fa-user"></i>
<span>Propri√©taire (optionnel)</span>
</label>
<select class="form-control" id="propertyOwnerId">
<option value="">Aucun propri√©taire</option>
<!-- Options remplies dynamiquement -->
</select>
<small style="display:block;margin-top:4px;font-size:12px;color:#64748b;">
    Lier ce logement √† un client propri√©taire
  </small>
</div>
<div class="form-group">
<label for="propertyAddress">
<i class="fas fa-location-dot"></i>
<span>Adresse</span>
</label>
<input id="propertyAddress" placeholder="Ex : 25 boulevard de la R√©publique, Saint-Gratien" type="text"/>
</div>
</div>
<div class="form-grid-2">
<div class="form-group">
<label for="propertyArrivalTime">
<i class="fas fa-sign-in-alt"></i>
<span>Heure d‚Äôarriv√©e</span>
</label>
<input id="propertyArrivalTime" placeholder="16:00" type="time"/>
</div>
<div class="form-group">
<label for="propertyDepartureTime">
<i class="fas fa-sign-out-alt"></i>
<span>Heure de d√©part</span>
</label>
<input id="propertyDepartureTime" placeholder="11:00" type="time"/>
</div>
</div>
<div class="form-grid-2">
<div class="form-group">
<label for="propertyDeposit">
<i class="fas fa-shield-alt"></i>
<span>Montant de la caution</span>
</label>
<div class="input-with-suffix">
<input id="propertyDeposit" min="0" placeholder="Laisser vide si aucune" step="1" type="number"/>
<span>‚Ç¨</span>
</div>
</div>
<div class="form-group">
<label for="propertyColor">
<i class="fas fa-palette"></i>
<span>Couleur</span>
</label>
<div class="color-picker-wrapper">
<input class="color-picker" id="propertyColor" type="color" value="#E67E50"/>
<div class="color-preview" id="colorPreview">#E67E50</div>
</div>
</div>
</div>
<!-- ‚úÖ SECTION : LIVRET D'ACCUEIL -->
<div class="form-group">
<label for="propertyWelcomeBookUrl">
<i class="fas fa-book"></i>
<span>URL du livret d'accueil</span>
</label>
<input id="propertyWelcomeBookUrl" placeholder="https://monsite.com/livret-appartement-paris" type="url"/>
<small style="display:block;margin-top:4px;font-size:12px;color:#64748b;">
              Lien vers le livret d'accueil que vous avez cr√©√© pour vos voyageurs
            </small>
</div>
<!-- ‚úÖ SECTION : ACC√àS AU LOGEMENT -->
<div class="form-group">
<label for="propertyAccessCode">
<i class="fas fa-key"></i>
<span>Code d'acc√®s</span>
</label>
<input id="propertyAccessCode" placeholder="Ex: 1234# ou code bo√Æte √† cl√©s" type="text"/>
<small style="display:block;margin-top:4px;font-size:12px;color:#64748b;">
              Code de la serrure connect√©e ou de la bo√Æte √† cl√©s
            </small>
</div>
<div class="form-group">
<label for="propertyAccessInstructions">
<i class="fas fa-route"></i>
<span>Instructions d'acc√®s</span>
</label>
<textarea id="propertyAccessInstructions" placeholder="Ex: Prenez l'ascenseur jusqu'au 3√®me √©tage, porte √† droite..." rows="3"></textarea>
<small style="display:block;margin-top:4px;font-size:12px;color:#64748b;">
              D√©tails pour acc√©der au logement (√©tage, porte, etc.)
            </small>
</div>

<!-- ‚úÖ SECTION : MESSAGE D'ARRIV√âE AUTOMATIQUE -->
<div class="form-group" style="background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%); padding: 20px; border-radius: 12px; border: 2px solid #667eea40;">
<label for="propertyArrivalMessage" style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
<i class="fas fa-paper-plane" style="color: #667eea;"></i>
<span style="font-weight: 600; color: #1e293b;">Message d'arriv√©e automatique</span>
<span style="background: #667eea; color: white; font-size: 11px; padding: 2px 8px; border-radius: 12px; font-weight: 600;">AUTO</span>
</label>

<div style="margin-bottom: 12px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
  <div style="font-size: 12px; color: #64748b; margin-bottom: 8px; font-weight: 600;">
    üìã Cliquez pour ins√©rer :
  </div>
  <div style="display: flex; flex-wrap: wrap; gap: 6px;">
    <button type="button" class="variable-btn" onclick="insertVariable('propertyArrivalMessage', '{guestName}', event)" style="background: #f1f5f9; border: 1px solid #cbd5e1; padding: 4px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; font-family: 'Courier New', monospace; transition: all 0.2s;">
      {guestName}
    </button>
    <button type="button" class="variable-btn" onclick="insertVariable('propertyArrivalMessage', '{propertyName}', event)" style="background: #f1f5f9; border: 1px solid #cbd5e1; padding: 4px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; font-family: 'Courier New', monospace; transition: all 0.2s;">
      {propertyName}
    </button>
    <button type="button" class="variable-btn" onclick="insertVariable('propertyArrivalMessage', '{address}', event)" style="background: #f1f5f9; border: 1px solid #cbd5e1; padding: 4px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; font-family: 'Courier New', monospace; transition: all 0.2s;">
      {address}
    </button>
    <button type="button" class="variable-btn" onclick="insertVariable('propertyArrivalMessage', '{arrivalTime}', event)" style="background: #f1f5f9; border: 1px solid #cbd5e1; padding: 4px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; font-family: 'Courier New', monospace; transition: all 0.2s;">
      {arrivalTime}
    </button>
    <button type="button" class="variable-btn" onclick="insertVariable('propertyArrivalMessage', '{departureTime}', event)" style="background: #f1f5f9; border: 1px solid #cbd5e1; padding: 4px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; font-family: 'Courier New', monospace; transition: all 0.2s;">
      {departureTime}
    </button>
    <button type="button" class="variable-btn" onclick="insertVariable('propertyArrivalMessage', '{accessCode}', event)" style="background: #f1f5f9; border: 1px solid #cbd5e1; padding: 4px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; font-family: 'Courier New', monospace; transition: all 0.2s;">
      {accessCode}
    </button>
    <button type="button" class="variable-btn" onclick="insertVariable('propertyArrivalMessage', '{wifiName}', event)" style="background: #f1f5f9; border: 1px solid #cbd5e1; padding: 4px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; font-family: 'Courier New', monospace; transition: all 0.2s;">
      {wifiName}
    </button>
    <button type="button" class="variable-btn" onclick="insertVariable('propertyArrivalMessage', '{wifiPassword}', event)" style="background: #f1f5f9; border: 1px solid #cbd5e1; padding: 4px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; font-family: 'Courier New', monospace; transition: all 0.2s;">
      {wifiPassword}
    </button>
    <button type="button" class="variable-btn" onclick="insertVariable('propertyArrivalMessage', '{accessInstructions}', event)" style="background: #f1f5f9; border: 1px solid #cbd5e1; padding: 4px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; font-family: 'Courier New', monospace; transition: all 0.2s;">
      {accessInstructions}
    </button>
    <button type="button" class="variable-btn" onclick="insertVariable('propertyArrivalMessage', '{welcomeBookUrl}', event)" style="background: #f1f5f9; border: 1px solid #cbd5e1; padding: 4px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; font-family: 'Courier New', monospace; transition: all 0.2s;">
      {welcomeBookUrl}
    </button>
  </div>
</div>

<textarea 
  id="propertyArrivalMessage" 
  rows="8" 
  style="font-family: 'Inter', sans-serif; line-height: 1.6;"
  placeholder="Bienvenue {guestName} ! üè†

Voici les informations pour votre arriv√©e :

üìç Adresse : {address}
üïê Heure d'arriv√©e : {arrivalTime}
üîë Code d'acc√®s : {accessCode}

üì∂ WiFi :
  ‚Ä¢ R√©seau : {wifiName}
  ‚Ä¢ Mot de passe : {wifiPassword}

üìñ Livret d'accueil : {welcomeBookUrl}

{accessInstructions}

Bon s√©jour ! üòä"
></textarea>
<small style="display:block;margin-top:8px;font-size:12px;color:#64748b; line-height: 1.5;">
  <strong style="color: #667eea;">üì® Envoy√© automatiquement le jour de l'arriv√©e √† 7h00</strong><br/>
  (ou imm√©diatement si r√©servation le jour m√™me)
</small>
</div>

<style>
.variable-btn:hover {
  background: #667eea !important;
  color: white !important;
  border-color: #667eea !important;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}
</style>

<script>
// Fonction pour ins√©rer une variable √† la position du curseur
function insertVariable(textareaId, variable, event) {
  const textarea = document.getElementById(textareaId);
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const text = textarea.value;
  
  // Ins√©rer la variable √† la position du curseur
  textarea.value = text.substring(0, start) + variable + text.substring(end);
  
  // Repositionner le curseur apr√®s la variable ins√©r√©e
  const newPosition = start + variable.length;
  textarea.setSelectionRange(newPosition, newPosition);
  textarea.focus();
  
  // Animation du bouton (si event fourni)
  if (event && event.target) {
    event.target.style.transform = 'scale(0.95)';
    setTimeout(() => {
      event.target.style.transform = '';
    }, 100);
  }
}
</script>
<!-- ‚úÖ SECTION : WIFI -->
<div class="form-grid-2">
<div class="form-group">
<label for="propertyWifiName">
<i class="fas fa-wifi"></i>
<span>Nom du r√©seau WiFi</span>
</label>
<input id="propertyWifiName" placeholder="Ex: FreeWiFi_Secure" type="text"/>
</div>
<div class="form-group">
<label for="propertyWifiPassword">
<i class="fas fa-lock"></i>
<span>Mot de passe WiFi</span>
</label>
<input id="propertyWifiPassword" placeholder="Ex: MonMotDePasse123" type="text"/>
</div>
</div>
<div class="form-group">
<label for="propertyPhoto">
<i class="fas fa-image"></i>
<span>Photo du logement</span>
</label>
<div class="photo-preview-wrapper">
<div class="photo-preview-box" id="photoPreviewBox">
<span class="photo-preview-placeholder" id="photoPreviewPlaceholder">
<i class="fas fa-image"></i>
</span>
</div>
<div>
<input accept="image/*" id="propertyPhoto" type="file"/>
<div class="photo-preview-text">
                  Ajoutez une photo pour la vignette de la carte logement.
                </div>
</div>
</div>
</div>

<!-- ===== SECTION : √âQUIPEMENTS ===== -->
<div class="form-section-header">
  <i class="fas fa-home"></i>
  <h3>√âquipements du logement</h3>
  <small>Ces informations permettent de r√©pondre automatiquement aux questions fr√©quentes des voyageurs</small>
</div>

<div class="checkbox-grid">
  <label class="checkbox-item">
    <input type="checkbox" id="amenityDraps" />
    <div class="checkbox-content">
      <i class="fas fa-bed"></i>
      <span>Draps fournis</span>
    </div>
  </label>
  
  <label class="checkbox-item">
    <input type="checkbox" id="amenityServiettes" />
    <div class="checkbox-content">
      <i class="fas fa-bath"></i>
      <span>Serviettes fournies</span>
    </div>
  </label>
  
  <label class="checkbox-item">
    <input type="checkbox" id="amenityCuisine" />
    <div class="checkbox-content">
      <i class="fas fa-utensils"></i>
      <span>Cuisine √©quip√©e</span>
    </div>
  </label>
  
  <label class="checkbox-item">
    <input type="checkbox" id="amenityLaveLinge" />
    <div class="checkbox-content">
      <i class="fas fa-tshirt"></i>
      <span>Lave-linge</span>
    </div>
  </label>
  
  <label class="checkbox-item">
    <input type="checkbox" id="amenityLaveVaisselle" />
    <div class="checkbox-content">
      <i class="fas fa-sink"></i>
      <span>Lave-vaisselle</span>
    </div>
  </label>
  
  <label class="checkbox-item">
    <input type="checkbox" id="amenityTelevision" />
    <div class="checkbox-content">
      <i class="fas fa-tv"></i>
      <span>T√©l√©vision</span>
    </div>
  </label>
  
  <label class="checkbox-item">
    <input type="checkbox" id="amenityParking" />
    <div class="checkbox-content">
      <i class="fas fa-car"></i>
      <span>Parking</span>
    </div>
  </label>
  
  <label class="checkbox-item">
    <input type="checkbox" id="amenityClimatisation" />
    <div class="checkbox-content">
      <i class="fas fa-snowflake"></i>
      <span>Climatisation</span>
    </div>
  </label>
</div>

<!-- ===== SECTION : R√àGLES DE LA MAISON ===== -->
<div class="form-section-header">
  <i class="fas fa-list-check"></i>
  <h3>R√®gles de la maison</h3>
  <small>D√©finissez ce qui est autoris√© ou non dans votre logement</small>
</div>

<div class="checkbox-grid">
  <label class="checkbox-item">
    <input type="checkbox" id="ruleAnimaux" />
    <div class="checkbox-content">
      <i class="fas fa-dog"></i>
      <span>Animaux accept√©s</span>
    </div>
  </label>
  
  <label class="checkbox-item">
    <input type="checkbox" id="ruleFumeurs" />
    <div class="checkbox-content">
      <i class="fas fa-smoking-ban"></i>
      <span>Fumeurs accept√©s</span>
    </div>
  </label>
  
  <label class="checkbox-item">
    <input type="checkbox" id="ruleFetes" />
    <div class="checkbox-content">
      <i class="fas fa-music"></i>
      <span>F√™tes autoris√©es</span>
    </div>
  </label>
  
  <label class="checkbox-item">
    <input type="checkbox" id="ruleEnfants" checked />
    <div class="checkbox-content">
      <i class="fas fa-baby"></i>
      <span>Enfants bienvenus</span>
    </div>
  </label>
</div>

<!-- ===== SECTION : INFOS PRATIQUES ===== -->
<div class="form-section-header">
  <i class="fas fa-circle-info"></i>
  <h3>Informations pratiques</h3>
  <small>D√©tails utiles pour vos voyageurs</small>
</div>

<div class="form-group">
  <label for="practicalParking">
    <i class="fas fa-car"></i>
    <span>D√©tails parking</span>
  </label>
  <textarea id="practicalParking" placeholder="Ex: Parking gratuit dans la rue, place r√©serv√©e n¬∞5 au sous-sol..." rows="2"></textarea>
</div>

<div class="form-group">
  <label for="practicalTrash">
    <i class="fas fa-trash"></i>
    <span>Jour des poubelles</span>
  </label>
  <input id="practicalTrash" placeholder="Ex: Mardi et vendredi soir" type="text" />
</div>

<div class="form-group">
  <label for="practicalShops">
    <i class="fas fa-store"></i>
    <span>Commerces √† proximit√©</span>
  </label>
  <textarea id="practicalShops" placeholder="Ex: Supermarch√© Carrefour √† 200m, boulangerie en bas de la rue..." rows="2"></textarea>
</div>

<div class="form-group">
  <label for="practicalTransport">
    <i class="fas fa-bus"></i>
    <span>Transports en commun</span>
  </label>
  <textarea id="practicalTransport" placeholder="Ex: M√©tro ligne 13 √† 5min √† pied, bus 261 devant l'immeuble..." rows="2"></textarea>
</div>

<!-- ===== SECTION : R√âPONSES AUTOMATIQUES ===== -->
<div class="form-section-header">
  <i class="fas fa-broom"></i>
  <h3>M√©nage r√©gulier</h3>
  <small>Assignez une personne de m√©nage par d√©faut pour ce logement. Elle sera automatiquement assign√©e √† chaque nouvelle r√©servation.</small>
</div>

<div class="form-group">
  <label for="defaultCleanerSelect">
    <i class="fas fa-user-check"></i>
    <span>Personne de m√©nage r√©guli√®re</span>
  </label>
  <select id="defaultCleanerSelect" class="form-input" style="width:100%;">
    <option value="">Aucune ‚Äî assignation manuelle</option>
  </select>
  <div class="info-box" id="defaultCleanerInfo" style="display:none; margin-top:8px;">
    <i class="fas fa-info-circle"></i>
    <p id="defaultCleanerInfoText"></p>
  </div>
</div>

<div class="form-section-header">
  <i class="fas fa-robot"></i>
  <h3>R√©ponses automatiques</h3>
  <small>Activez pour que le syst√®me r√©ponde automatiquement aux questions fr√©quentes bas√©es sur les informations ci-dessus</small>
</div>

<div class="form-group">
  <label class="toggle-switch">
    <input type="checkbox" id="autoResponsesEnabled" checked />
    <span class="toggle-slider"></span>
    <span class="toggle-label">Activer les r√©ponses automatiques</span>
  </label>
  <div class="info-box">
    <i class="fas fa-lightbulb"></i>
    <p>Lorsqu'activ√©, le syst√®me r√©pondra automatiquement aux questions comme "√Ä quelle heure je peux arriver ?", "Y a-t-il des draps ?", etc. Si la r√©ponse n'est pas trouv√©e, vous recevrez une notification.</p>
  </div>
</div>

<div class="form-group">
<label>
<i class="fas fa-link"></i>
<span>URLs iCal (Airbnb, Booking, etc.)</span>
</label>
<div class="url-list" id="urlList">
<!-- URLs ajout√©es ici via JS -->
</div>
<button class="btn-add-url" onclick="addUrlField()" type="button">
<i class="fas fa-plus"></i>
<span>Ajouter une URL iCal</span>
</button>
</div>
<div class="modal-actions">
<button class="btn-cancel" onclick="closeEditModal()" type="button">Annuler</button>
<button class="btn-save" type="submit">
<i class="fas fa-save"></i>
<span>Enregistrer</span>
</button>
</div>
</form>
</div>
</div>
</div>
<!-- Toast & Loading -->
<div class="toast-container" id="toastContainer"></div>
<div class="loading-overlay" id="loadingOverlay">
<div class="loading-spinner">
<i class="fas fa-spinner fa-spin"></i>
<p>Chargement...</p>
</div>
</div>
<!-- JS page -->
<script src="/js/settings.js"></script>
<!-- MOBILE MENU SCRIPT + nav active -->
<script>
    (function() {
      const menuBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      if (menuBtn && sidebar && overlay) {
        menuBtn.addEventListener('click', function() {
          sidebar.classList.toggle('active');
          overlay.classList.toggle('active');
          const icon = menuBtn.querySelector('i');
          if (sidebar.classList.contains('active')) {
            icon.classList.remove('fa-bars');
            icon.classList.add('fa-times');
          } else {
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
          }
        });

        overlay.addEventListener('click', function() {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          const icon = menuBtn.querySelector('i');
          icon.classList.remove('fa-times');
          icon.classList.add('fa-bars');
        });

        if (window.innerWidth <= 1024) {
          document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
              sidebar.classList.remove('active');
              overlay.classList.remove('active');
              const icon = menuBtn.querySelector('i');
              icon.classList.remove('fa-times');
              icon.classList.add('fa-bars');
            });
          });
        }
      }
    })();

    (function() {
      const currentPage = document.body.getAttribute('data-page');
      if (currentPage) {
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.remove('active');
        });
        const activeLink = document.querySelector('.nav-item[data-page="' + currentPage + '"]');
        if (activeLink) {
          activeLink.classList.add('active');
        }
      }
    })();
  </script>
<!-- üÜï PATCH OWNER_ID -->
<script>
  // ============================================
// PATCH AM√âLIOR√â : Correction du owner_id
// Remplace le patch pr√©c√©dent par celui-ci
// ============================================

(function() {
  console.log('üîß Patch owner_id V2 activ√©');

  // ============================================
  // 1. CHARGER LES PROPRI√âT√âS
  // ============================================
  async function loadAllProperties() {
    try {
      const token = localStorage.getItem('lcc_token');
      if (!token) return;

      const res = await fetch('https://lcc-booking-manager.onrender.com/api/properties', {
        headers: { 
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        }
      });

      if (!res.ok) {
        console.warn('Impossible de charger les propri√©t√©s');
        return;
      }

      const data = await res.json();
      const properties = data.properties || [];
      
      // Stocker en global
      window.allProperties = properties;
      
      console.log('‚úÖ Propri√©t√©s charg√©es:', properties.length);
      
    } catch (err) {
      console.error('‚ùå Erreur chargement propri√©t√©s:', err);
    }
  }

  // ============================================
  // 2. CHARGER LA LISTE DES PROPRI√âTAIRES
  // ============================================
  async function loadOwnerClients() {
    try {
      const token = localStorage.getItem('lcc_token');
      if (!token) return;

      const res = await fetch('https://lcc-booking-manager.onrender.com/api/owner-clients', {
        headers: { 
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        }
      });

      if (!res.ok) {
        console.warn('Impossible de charger les propri√©taires');
        return;
      }

      const data = await res.json();
      const clients = data.clients || [];
      
      console.log('‚úÖ Propri√©taires charg√©s:', clients.length);
      
      // Stocker en global pour r√©utilisation
      window.ownerClients = clients;
      
      // Remplir le select
      fillOwnerSelect(clients);
      
    } catch (err) {
      console.error('‚ùå Erreur chargement propri√©taires:', err);
    }
  }

  // ============================================
  // 3. REMPLIR LE SELECT AVEC LES PROPRI√âTAIRES
  // ============================================
  function fillOwnerSelect(clients) {
    const select = document.getElementById('propertyOwnerId');
    if (!select) {
      console.warn('Select propertyOwnerId introuvable');
      return;
    }

    // Vider les options existantes (sauf la premi√®re "Aucun propri√©taire")
    select.innerHTML = '<option value="">Aucun propri√©taire</option>';
    
    // Ajouter chaque propri√©taire
    clients.forEach(client => {
      const option = document.createElement('option');
      option.value = client.id;
      option.textContent = client.name || client.email || `Propri√©taire ${client.id}`;
      select.appendChild(option);
    });
    
    console.log('‚úÖ Select rempli avec', clients.length, 'propri√©taires');
  }

  // ============================================
  // 4. INTERCEPTER L'OUVERTURE DU MODAL
  // ============================================
  
  // Surveiller les changements sur le modal
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      const modal = document.getElementById('editPropertyModal');
      if (modal && modal.classList.contains('active')) {
        onModalOpened();
      }
    });
  });

  // D√©marrer l'observation
  window.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('editPropertyModal');
    if (modal) {
      observer.observe(modal, { 
        attributes: true, 
        attributeFilter: ['class'] 
      });
    }
  });

  // Fonction appel√©e quand le modal s'ouvre
  function onModalOpened() {
    console.log('üìù Modal ouvert, pr√©-remplissage owner_id...');
    
    // Attendre un peu que le modal soit compl√®tement rempli
    setTimeout(() => {
      // R√©cup√©rer l'ID de la propri√©t√© en cours d'√©dition
      const propertyIdInput = document.getElementById('propertyId');
      if (!propertyIdInput || !propertyIdInput.value) {
        console.log('Aucune propri√©t√© en cours d\'√©dition');
        return;
      }

      const propertyId = propertyIdInput.value;
      
      // Trouver la propri√©t√© dans la liste globale
      const allProperties = window.allProperties || [];
      
      // Chercher avec plusieurs formats d'ID possibles
      let property = allProperties.find(p => String(p.id) === String(propertyId));
      
      // Si pas trouv√©, essayer avec property_id
      if (!property) {
        property = allProperties.find(p => String(p.property_id) === String(propertyId));
      }
      
      // Si toujours pas trouv√©, logger pour debug
      if (!property) {
        console.warn('Propri√©t√©', propertyId, 'introuvable dans allProperties');
        console.log('IDs disponibles:', allProperties.map(p => p.id));
        // On continue quand m√™me, le select reste vide c'est pas grave
        return;
      }

      // Pr√©-remplir le select avec owner_id
      const select = document.getElementById('propertyOwnerId');
      if (select && (property.ownerId || property.owner_id)) {
        select.value = property.ownerId || property.owner_id;
        console.log('‚úÖ owner_id pr√©-rempli:', property.owner_id);
      } else if (select) {
        select.value = '';
        console.log('‚úÖ Aucun propri√©taire pour cette propri√©t√©');
      }
    }, 100);
  }

  // ============================================
  // 5. INTERCEPTER LA SAUVEGARDE
  // ============================================
  
  // Sauvegarder la fonction saveProperty originale
  const originalSaveProperty = window.saveProperty;
  
  // Remplacer par une version am√©lior√©e
  window.saveProperty = async function(event) {
    if (event) event.preventDefault();
    
    console.log('üíæ Sauvegarde de la propri√©t√©...');
    
    // R√©cup√©rer la valeur du select owner_id
    const ownerSelect = document.getElementById('propertyOwnerId');
    const ownerId = ownerSelect ? ownerSelect.value : null;
    
    console.log('üìå owner_id s√©lectionn√©:', ownerId || '(aucun)');
    
    // Si la fonction originale existe, l'appeler
    if (typeof originalSaveProperty === 'function') {
      // Ajouter l'ownerId avant d'appeler la fonction originale
      // On va intercepter le fetch
      interceptNextFetch(ownerId);
      return originalSaveProperty(event);
    }
    
    // Sinon, faire la sauvegarde nous-m√™mes
    return savePropertyManually(ownerId);
  };

  // ============================================
  // 6. INTERCEPTER LE FETCH POUR AJOUTER OWNER_ID
  // ============================================
  let nextFetchOwnerId = null;
  
  function interceptNextFetch(ownerId) {
    nextFetchOwnerId = ownerId;
  }

  // Sauvegarder le fetch original
  const originalFetch = window.fetch;
  
  // Remplacer fetch pour intercepter les requ√™tes vers /api/properties
  window.fetch = async function(...args) {
    const [url, options] = args;
    
    // Si c'est une requ√™te vers /api/properties avec un body
    if (url && url.includes('/api/properties') && options && options.body) {
      try {
        const body = JSON.parse(options.body);
        
        // Si on a un ownerId en attente, l'ajouter
        if (nextFetchOwnerId !== null) {
          body.ownerId = nextFetchOwnerId || null;
          options.body = JSON.stringify(body);
          console.log('‚úÖ owner_id ajout√© √† la requ√™te:', body.ownerId);
          nextFetchOwnerId = null; // Reset
        }
      } catch (e) {
        // Si le body n'est pas JSON, on ignore
      }
    }
    
    // Appeler le fetch original
    return originalFetch.apply(this, args);
  };

  // ============================================
  // 7. SAUVEGARDE MANUELLE (fallback)
  // ============================================
  async function savePropertyManually(ownerId) {
    const token = localStorage.getItem('lcc_token');
    if (!token) {
      alert('Non authentifi√©');
      return;
    }

    const propertyId = document.getElementById('propertyId').value;
    const name = document.getElementById('propertyName').value;
    const color = document.getElementById('propertyColor').value;
    const address = document.getElementById('propertyAddress').value;
    const arrivalTime = document.getElementById('propertyArrivalTime').value;
    const departureTime = document.getElementById('propertyDepartureTime').value;
    const deposit = document.getElementById('propertyDeposit').value;
    const photoUrl = document.getElementById('propertyPhotoUrl').value;
    const welcomeBookUrl = document.getElementById('propertyWelcomeBookUrl').value;
    const accessCode = document.getElementById('propertyAccessCode').value;
    const accessInstructions = document.getElementById('propertyAccessInstructions').value;
    const arrivalMessage = document.getElementById('propertyArrivalMessage').value;  // ‚úÖ NOUVEAU
    const wifiName = document.getElementById('propertyWifiName').value;
    const wifiPassword = document.getElementById('propertyWifiPassword').value;

    const payload = {
      name,
      color,
      address: address || null,
      arrivalTime: arrivalTime || null,
      departureTime: departureTime || null,
      depositAmount: deposit ? parseFloat(deposit) : null,
      photoUrl: photoUrl || null,
      welcomeBookUrl: welcomeBookUrl || null,
      accessCode: accessCode || null,
      accessInstructions: accessInstructions || null,
      arrivalMessage: arrivalMessage || null,  // ‚úÖ CORRIG√â : camelCase comme le serveur l'attend
      wifiName: wifiName || null,
      wifiPassword: wifiPassword || null,
      ownerId: ownerId || null
    };

    console.log('üì¶ Payload envoy√©:', payload);
    console.log('üîç arrivalMessage value:', arrivalMessage);

    try {
      const url = propertyId 
        ? `https://lcc-booking-manager.onrender.com/api/properties/${propertyId}`
        : 'https://lcc-booking-manager.onrender.com/api/properties';
      
      const method = propertyId ? 'PUT' : 'POST';

      const res = await fetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      if (!res.ok) {
        // Gestion sp√©cifique des erreurs de quota
        if (res.status === 403 && data.code === 'PLAN_LIMIT_SOLO') {
          showPlanLimitModal('solo');
          return;
        }
        if (res.status === 402 && data.code === 'STRIPE_ERROR') {
          alert('‚ùå Erreur de facturation Stripe : ' + (data.message || 'Contactez le support.'));
          return;
        }
        if (res.status === 400 && data.code === 'NO_SUBSCRIPTION') {
          alert('‚ùå Aucun abonnement actif trouv√©. V√©rifiez votre abonnement dans les param√®tres.');
          return;
        }
        throw new Error(data.error || data.message || 'Erreur serveur');
      }

      console.log('‚úÖ Propri√©t√© sauvegard√©e avec owner_id');
      alert('‚úÖ Propri√©t√© sauvegard√©e avec succ√®s !');
      
      // Fermer le modal
      if (typeof closeEditModal === 'function') {
        closeEditModal();
      }
      
      // D√©clencher l'√©v√©nement pour mettre √† jour le badge quota
      document.dispatchEvent(new CustomEvent('propertySaved'));

      // Recharger la page
      location.reload();

    } catch (err) {
      console.error('‚ùå Erreur sauvegarde:', err);
      alert('‚ùå Erreur : ' + err.message);
    }
  }

  // ============================================
  // 8. INITIALISATION AU CHARGEMENT
  // ============================================
  window.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initialisation du patch owner_id V2');
    
    // Charger les propri√©t√©s ET les propri√©taires
    Promise.all([
      loadAllProperties(),
      loadOwnerClients()
    ]).then(() => {
      console.log('‚úÖ Toutes les donn√©es charg√©es');
    });
    
    // Recharger √† chaque fois que la page des propri√©taires est affich√©e
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        loadAllProperties();
        loadOwnerClients();
      }
    });
  });

  // ============================================
  // 9. EXPOSER LES FONCTIONS POUR DEBUG
  // ============================================
  window.debugOwnerPatch = {
    loadAllProperties,
    loadOwnerClients,
    fillOwnerSelect,
    properties: () => window.allProperties,
    clients: () => window.ownerClients
  };

  console.log('‚úÖ Patch owner_id V2 install√© avec succ√®s');
  console.log('üí° Debug disponible via window.debugOwnerPatch');

})();

// ============================================
// GESTION QUOTA LOGEMENTS
// ============================================
(function() {
  const API = 'https://lcc-booking-manager.onrender.com';

  // Config des plans
  const PLAN_LIMITS = {
    solo:     { included: 1,  extraPrice: null, extraPriceAnnual: null },
    standard: { included: 3,  extraPrice: 7,    extraPriceAnnual: 70 },
    pro:      { included: 6,  extraPrice: 5,    extraPriceAnnual: 50 }
  };

  function getBasePlan(planType) {
    const p = (planType || '').toLowerCase();
    if (p.includes('solo')) return 'solo';
    if (p.includes('standard')) return 'standard';
    if (p.includes('pro')) return 'pro';
    return 'solo';
  }

  // Donn√©es charg√©es au d√©marrage
  let userPlanType = 'solo';
  let propertyCount = 0;

  async function loadQuotaInfo() {
    const token = localStorage.getItem('lcc_token');
    if (!token) return;

    try {
      // R√©cup√©rer le plan
      const subRes = await fetch(`${API}/api/subscription/status`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (subRes.ok) {
        const subData = await subRes.json();
        userPlanType = subData.planType || 'solo';
      }

      // R√©cup√©rer le nombre de logements
      const propRes = await fetch(`${API}/api/properties`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (propRes.ok) {
        const propData = await propRes.json();
        propertyCount = (propData.properties || []).length;
      }

      updateQuotaBadge();
    } catch (err) {
      console.warn('Impossible de charger le quota:', err);
    }
  }

  function updateQuotaBadge() {
    const badge = document.getElementById('propertyQuotaBadge');
    if (!badge) return;

    const basePlan = getBasePlan(userPlanType);
    const limits = PLAN_LIMITS[basePlan];

    if (basePlan === 'solo') {
      if (propertyCount >= 1) {
        badge.textContent = '‚ö†Ô∏è Limite atteinte (plan Solo : 1 logement max)';
        badge.style.color = '#dc2626';
      } else {
        badge.textContent = `${propertyCount}/1 logement inclus`;
        badge.style.color = '#6b7280';
      }
    } else {
      const remaining = Math.max(0, limits.included - propertyCount);
      if (remaining > 0) {
        badge.textContent = `${propertyCount}/${limits.included} logements inclus`;
        badge.style.color = '#6b7280';
      } else {
        const extraCount = propertyCount - limits.included;
        badge.textContent = `${propertyCount} logements (${extraCount} suppl√©mentaire${extraCount > 1 ? 's' : ''} factur√©${extraCount > 1 ? 's' : ''})`;
        badge.style.color = '#f59e0b';
      }
    }
    badge.style.display = 'inline';
  }

  // Clic sur "Ajouter un logement"
  window.handleAddPropertyClick = function() {
    const basePlan = getBasePlan(userPlanType);
    const limits = PLAN_LIMITS[basePlan];
    const isAnnual = (userPlanType || '').toLowerCase().includes('annual');

    // Plan Solo : bloquer si d√©j√† 1 logement
    if (basePlan === 'solo' && propertyCount >= 1) {
      showPlanLimitModal('solo');
      return;
    }

    // Standard/Pro : avertir si au-del√† du quota inclus
    if (limits.extraPrice !== null && propertyCount >= limits.included) {
      const price = isAnnual ? limits.extraPriceAnnual : limits.extraPrice;
      const period = isAnnual ? 'an' : 'mois';
      const planName = basePlan.charAt(0).toUpperCase() + basePlan.slice(1);
      document.getElementById('extraPropertyModalText').textContent =
        `Vous avez atteint les ${limits.included} logements inclus dans votre plan ${planName}. Un logement suppl√©mentaire peut √™tre ajout√©.`;
      document.getElementById('extraPropertyPriceText').textContent =
        `+${price}‚Ç¨/${period} par logement suppl√©mentaire`;
      document.getElementById('extraPropertyModal').style.display = 'flex';
      return;
    }

    // Dans le quota : ouvrir directement le modal
    if (typeof openAddPropertyModal === 'function') openAddPropertyModal();
  };

  window.closeExtraPropertyModal = function() {
    document.getElementById('extraPropertyModal').style.display = 'none';
  };

  window.confirmAddExtraProperty = function() {
    document.getElementById('extraPropertyModal').style.display = 'none';
    if (typeof openAddPropertyModal === 'function') openAddPropertyModal();
  };

  // Modal upgrade Solo
  window.showPlanLimitModal = function(plan) {
    const msg = plan === 'solo'
      ? 'Le plan Solo est limit√© √† 1 logement.\n\nPour g√©rer plusieurs logements, passez au plan Standard (29‚Ç¨/mois, 3 logements inclus) ou Pro (49‚Ç¨/mois, 6 logements inclus).'
      : 'Vous avez atteint la limite de votre plan.';
    if (confirm(msg + '\n\nVoulez-vous voir les plans disponibles ?')) {
      window.location.href = '/pricing.html';
    }
  };

  // Mettre √† jour le quota apr√®s ajout r√©ussi d'une propri√©t√©
  const origReload = window.location.reload.bind(window.location);
  // √âcouter les sauvegardes r√©ussies pour incr√©menter le compteur local
  document.addEventListener('propertySaved', function() {
    propertyCount++;
    updateQuotaBadge();
  });

  // Init au chargement
  document.addEventListener('DOMContentLoaded', loadQuotaInfo);
})();
    </script>

  <!-- Script pour g√©rer les √©quipements, r√®gles et r√©ponses auto -->
  <script>
  // ============================================
  // GESTION DES NOUVELLES DONN√âES PROPRI√âT√âS
  // ============================================

  // Fonction utilitaire pour charger les donn√©es dans le formulaire
  window.loadPropertyExtendedData = function(property) {
    if (!property) return;
    
    console.log('üì¶ Chargement des donn√©es √©tendues:', property);
    
    // === √âQUIPEMENTS ===
    try {
      const amenities = typeof property.amenities === 'string' 
        ? JSON.parse(property.amenities) 
        : (property.amenities || {});
      
      document.getElementById('amenityDraps').checked = amenities.draps || false;
      document.getElementById('amenityServiettes').checked = amenities.serviettes || false;
      document.getElementById('amenityCuisine').checked = amenities.cuisine_equipee || false;
      document.getElementById('amenityLaveLinge').checked = amenities.lave_linge || false;
      document.getElementById('amenityLaveVaisselle').checked = amenities.lave_vaisselle || false;
      document.getElementById('amenityTelevision').checked = amenities.television || false;
      document.getElementById('amenityParking').checked = amenities.parking || false;
      document.getElementById('amenityClimatisation').checked = amenities.climatisation || false;
    } catch (e) {
      console.error('Erreur chargement amenities:', e);
    }
    
    // === R√àGLES ===
    try {
      const rules = typeof property.house_rules === 'string'
        ? JSON.parse(property.house_rules)
        : (property.house_rules || {});
      
      document.getElementById('ruleAnimaux').checked = rules.animaux || false;
      document.getElementById('ruleFumeurs').checked = rules.fumeurs || false;
      document.getElementById('ruleFetes').checked = rules.fetes || false;
      document.getElementById('ruleEnfants').checked = rules.enfants !== undefined ? rules.enfants : true;
    } catch (e) {
      console.error('Erreur chargement house_rules:', e);
    }
    
    // === INFOS PRATIQUES ===
    try {
      const practical = typeof property.practical_info === 'string'
        ? JSON.parse(property.practical_info)
        : (property.practical_info || {});
      
      document.getElementById('practicalParking').value = practical.parking_details || '';
      document.getElementById('practicalTrash').value = practical.trash_day || '';
      document.getElementById('practicalShops').value = practical.nearby_shops || '';
      document.getElementById('practicalTransport').value = practical.public_transport || '';
    } catch (e) {
      console.error('Erreur chargement practical_info:', e);
    }
    
    // === R√âPONSES AUTO ===
    document.getElementById('autoResponsesEnabled').checked = property.auto_responses_enabled !== undefined 
      ? property.auto_responses_enabled 
      : true;
  };

  // Fonction pour r√©cup√©rer les donn√©es du formulaire
  window.getPropertyExtendedData = function() {
    // === √âQUIPEMENTS ===
    const amenities = {
      draps: document.getElementById('amenityDraps').checked,
      serviettes: document.getElementById('amenityServiettes').checked,
      cuisine_equipee: document.getElementById('amenityCuisine').checked,
      lave_linge: document.getElementById('amenityLaveLinge').checked,
      lave_vaisselle: document.getElementById('amenityLaveVaisselle').checked,
      television: document.getElementById('amenityTelevision').checked,
      parking: document.getElementById('amenityParking').checked,
      climatisation: document.getElementById('amenityClimatisation').checked
    };
    
    // === R√àGLES ===
    const houseRules = {
      animaux: document.getElementById('ruleAnimaux').checked,
      fumeurs: document.getElementById('ruleFumeurs').checked,
      fetes: document.getElementById('ruleFetes').checked,
      enfants: document.getElementById('ruleEnfants').checked
    };
    
    // === INFOS PRATIQUES ===
    const practicalInfo = {
      parking_details: document.getElementById('practicalParking').value.trim(),
      trash_day: document.getElementById('practicalTrash').value.trim(),
      nearby_shops: document.getElementById('practicalShops').value.trim(),
      public_transport: document.getElementById('practicalTransport').value.trim()
    };
    
    // === R√âPONSES AUTO ===
    const autoResponsesEnabled = document.getElementById('autoResponsesEnabled').checked;
    
    return {
      amenities: JSON.stringify(amenities),
      house_rules: JSON.stringify(houseRules),
      practical_info: JSON.stringify(practicalInfo),
      auto_responses_enabled: autoResponsesEnabled
    };
  };

  // Intercepter l'ouverture de la modal d'√©dition
  // Cette fonction doit √™tre appel√©e quand tu charges une propri√©t√©
  const originalEditProperty = window.editProperty;
  if (typeof originalEditProperty === 'function') {
    window.editProperty = function(propertyData) {
      // Appeler la fonction originale
      originalEditProperty(propertyData);
      
      // ‚úÖ CHARGER LE MESSAGE D'ARRIV√âE
      const arrivalMessageField = document.getElementById('propertyArrivalMessage');
      if (arrivalMessageField && propertyData.arrival_message) {
        arrivalMessageField.value = propertyData.arrival_message;
      }
      
      // Charger les donn√©es √©tendues
      loadPropertyExtendedData(propertyData);
    };
  }

  console.log('‚úÖ Module auto-r√©ponses charg√©');
  </script>

<!-- ============================================ -->
<!-- üßπ MODULE CLEANER PAR D√âFAUT PAR LOGEMENT    -->
<!-- ============================================ -->
<script>
(function() {
  var API_URL = window.API_URL || '';
  var allCleaners = [];
  var defaultCleanersMap = {};
  var lastPopulatedForProperty = null;

  function loadCleanersList() {
    var token = localStorage.getItem('lcc_token');
    if (!token) return Promise.resolve();
    return fetch(API_URL + '/api/cleaners', {
      headers: { 'Authorization': 'Bearer ' + token }
    }).then(function(res) {
      if (res.ok) return res.json();
      throw new Error('status ' + res.status);
    }).then(function(data) {
      allCleaners = data.cleaners || data || [];
      console.log('üßπ Cleaners charg√©s:', allCleaners.length, allCleaners.map(function(c){return c.name;}));
    }).catch(function(e) { console.error('Erreur cleaners:', e); });
  }

  function loadDefaultCleaners() {
    var token = localStorage.getItem('lcc_token');
    if (!token) return Promise.resolve();
    return fetch(API_URL + '/api/cleaning/default-cleaners', {
      headers: { 'Authorization': 'Bearer ' + token }
    }).then(function(res) {
      if (res.ok) return res.json();
      throw new Error('status ' + res.status);
    }).then(function(data) {
      defaultCleanersMap = data.defaults || {};
      console.log('üßπ Cleaners par d√©faut:', Object.keys(defaultCleanersMap).length);
    }).catch(function() { /* normal si table pas encore cr√©√©e */ });
  }

  function populateCleanerSelect(propertyId) {
    var select = document.getElementById('defaultCleanerSelect');
    if (!select) return;
    if (allCleaners.length === 0) return;

    console.log('üßπ ‚ñ∂ Remplissage select pour', propertyId, '‚Äî cleaners:', allCleaners.length);

    select.innerHTML = '<option value="">Aucune ‚Äî assignation manuelle</option>';
    for (var i = 0; i < allCleaners.length; i++) {
      var c = allCleaners[i];
      if (c.is_active === false) continue;
      var opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = c.name + (c.phone ? ' (' + c.phone + ')' : '');
      select.appendChild(opt);
    }

    var defaultData = defaultCleanersMap[propertyId];
    if (defaultData && defaultData.cleanerId) {
      select.value = defaultData.cleanerId;
      showCleanerInfo(defaultData.cleanerName);
    } else {
      select.value = '';
      hideCleanerInfo();
    }

    select.onchange = function() {
      if (this.value) {
        var found = null;
        for (var j = 0; j < allCleaners.length; j++) {
          if (allCleaners[j].id === this.value) { found = allCleaners[j]; break; }
        }
        showCleanerInfo(found ? found.name : '');
      } else {
        hideCleanerInfo();
      }
    };

    lastPopulatedForProperty = propertyId;
    console.log('üßπ ‚úÖ Select rempli avec', select.options.length - 1, 'cleaners');
  }

  function showCleanerInfo(name) {
    var box = document.getElementById('defaultCleanerInfo');
    var text = document.getElementById('defaultCleanerInfoText');
    if (box && text) {
      text.textContent = (name || 'Cette personne') + ' sera automatiquement assign√©(e) √† chaque nouveau m√©nage. Changement ponctuel possible dans la page M√©nage.';
      box.style.display = 'flex';
    }
  }

  function hideCleanerInfo() {
    var box = document.getElementById('defaultCleanerInfo');
    if (box) box.style.display = 'none';
  }

  function saveDefaultCleaner(propertyId) {
    var select = document.getElementById('defaultCleanerSelect');
    if (!select) return;
    var cleanerId = select.value || null;
    var currentDefault = defaultCleanersMap[propertyId];
    if (!cleanerId && !currentDefault) return;
    if (cleanerId && currentDefault && currentDefault.cleanerId === cleanerId) return;
    var token = localStorage.getItem('lcc_token');
    fetch(API_URL + '/api/cleaning/default-cleaner/' + propertyId, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
      body: JSON.stringify({ cleanerId: cleanerId })
    }).then(function(res) { if (res.ok) return res.json(); }).then(function(data) {
      if (data) {
        if (cleanerId) { defaultCleanersMap[propertyId] = data.default || { cleanerId: cleanerId }; }
        else { delete defaultCleanersMap[propertyId]; }
        console.log('‚úÖ Cleaner par d√©faut sauvegard√© pour', propertyId);
      }
    }).catch(function(e) { console.error('Erreur save:', e); });
  }

  // D√âTECTION MODALE : interval simple toutes les 300ms
  setInterval(function() {
    var modal = document.getElementById('editPropertyModal');
    if (!modal) return;
    var isVisible = modal.classList.contains('active');
    if (!isVisible) { lastPopulatedForProperty = null; return; }
    var pidInput = document.getElementById('propertyId');
    var propertyId = pidInput ? pidInput.value : null;
    if (!propertyId) return;
    if (lastPopulatedForProperty === propertyId) return;
    if (allCleaners.length === 0) return;
    populateCleanerSelect(propertyId);
  }, 300);

  // ======================================================
  // INJECTION BADGES "Cleaner r√©gulier" dans les cards de logement
  // ======================================================

  function injectCleanerBadges() {
    if (Object.keys(defaultCleanersMap).length === 0) return;

    var cards = document.querySelectorAll('.property-card');
    if (cards.length === 0) return;

    cards.forEach(function(card) {
      // Ne pas re-injecter
      if (card.querySelector('.cleaner-badge-injected')) return;

      // Trouver le propertyId via le data-id du bouton edit
      var editBtn = card.querySelector('.btn-edit[data-id]');
      if (!editBtn) return;

      var propertyId = editBtn.getAttribute('data-id');
      if (!propertyId) return;

      var defaultData = defaultCleanersMap[propertyId];
      if (!defaultData || !defaultData.cleanerName) return;

      // Trouver le container .property-meta
      var metaContainer = card.querySelector('.property-meta');
      if (!metaContainer) return;

      // Cr√©er le badge vert
      var badge = document.createElement('span');
      badge.className = 'meta-badge cleaner-badge-injected';
      badge.style.cssText = 'display:inline-flex; align-items:center; gap:4px; padding:2px 8px; border-radius:6px; font-size:12px; font-weight:600; background:#d1fae5; color:#059669;';
      badge.innerHTML = '<i class="fas fa-broom" style="font-size:10px;"></i> ' + defaultData.cleanerName;
      metaContainer.appendChild(badge);
    });
  }

  // V√©rifier r√©guli√®rement si les cards sont rendues pour injecter les badges
  setInterval(function() {
    if (Object.keys(defaultCleanersMap).length === 0) return;
    var cards = document.querySelectorAll('.property-card');
    if (cards.length === 0) return;
    var needsInjection = false;
    cards.forEach(function(c) {
      if (!c.querySelector('.cleaner-badge-injected')) needsInjection = true;
    });
    if (needsInjection) injectCleanerBadges();
  }, 1000);

  // SAVE : √©couter le submit
  function setupFormListener() {
    var form = document.getElementById('propertyForm');
    if (form) {
      form.addEventListener('submit', function() {
        var pid = document.getElementById('propertyId');
        var propertyId = pid ? pid.value : null;
        if (propertyId) { setTimeout(function() { saveDefaultCleaner(propertyId); }, 800); }
      });
      console.log('üßπ Listener submit install√©');
    } else { setTimeout(setupFormListener, 500); }
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupFormListener);
  } else { setupFormListener(); }

  // Init
  Promise.all([loadCleanersList(), loadDefaultCleaners()]).then(function() {
    console.log('‚úÖ Module cleaner par d√©faut pr√™t ‚Äî cleaners:', allCleaners.length);
  });
})();
</script>

<script src="/js/bh-layout.js"></script>
<script src="/js/mobile-native-experience.js"></script>
<script src="/js/mobile-tabs-handler.js"></script>
<script src="/js/messages-badge-desktop-mobile.js"></script>
<!-- Socket.io pour le temps r√©el -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>    
</body>
</html>
