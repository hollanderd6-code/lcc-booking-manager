<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bookingmanage ‚Äì Mes logements</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Global CSS de l'app -->
  <link rel="stylesheet" href="/css/style.css">

  <style>
    html, body {
      margin: 0 !important;
      padding: 0 !important;
    }

    .main-content {
      padding-top: 24px !important;
    }

    .page-content {
      margin-top: 0 !important;
    }

    .settings-container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0;
    }

    .properties-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .properties-grid {
      display: grid;
      gap: 16px;
    }

    .property-card {
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.06);
      padding: 18px 20px;
      border-left: 4px solid var(--primary-color, #059669);
      transition: var(--transition, all .15s ease);
    }

    .property-card:hover {
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.12);
      transform: translateY(-2px);
    }

    .property-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
      gap: 12px;
    }

    .property-info {
      flex: 1;
      min-width: 0;
    }

    .property-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .color-badge {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid #fff;
      box-shadow: 0 0 0 1px rgba(15,23,42,.12);
      flex-shrink: 0;
    }

    .property-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .meta-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--bg-secondary, #f3f4f6);
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .meta-badge i {
      font-size: 11px;
    }

    .property-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
      margin-bottom: 8px;
    }

    .btn-icon-action {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      transition: var(--transition, all .15s ease);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .btn-edit {
      background: var(--bg-secondary, #f3f4f6);
      color: var(--primary-color, #059669);
    }

    .btn-edit:hover {
      background: var(--primary-color, #059669);
      color: #fff;
    }

    .btn-delete {
      background: var(--bg-secondary, #f3f4f6);
      color: #e11d48;
    }

    .btn-delete:hover {
      background: #e11d48;
      color: #fff;
    }

    .property-photo-wrapper {
      width: 150px;
      height: 100px;
      border-radius: 14px;
      overflow: hidden;
      background: var(--bg-secondary, #f3f4f6);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      position: relative;
    }

    .property-photo-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .property-photo-placeholder {
      font-size: 22px;
      color: var(--text-secondary);
      opacity: 0.6;
    }

    .ical-urls {
      margin-top: 10px;
    }

    .ical-url-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      background: var(--bg-secondary, #f9fafb);
      border-radius: 12px;
      margin-bottom: 6px;
      font-size: 12px;
    }

    .ical-source {
      font-weight: 600;
      color: var(--text-primary);
      min-width: 90px;
      font-size: 12px;
    }

    .ical-url-text {
      flex: 1;
      color: var(--text-secondary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
    }

    .btn-test-url {
      background: transparent;
      border: none;
      color: var(--primary-color, #059669);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
      transition: var(--transition, all .15s ease);
      white-space: nowrap;
    }

    .btn-test-url:hover {
      background: rgba(5,150,105,.08);
      color: var(--primary-color, #059669);
    }

    .btn-copy-ical {
      border: none;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(5, 150, 105, 0.08);
      color: var(--primary-color, #059669);
      cursor: pointer;
      white-space: nowrap;
      transition: var(--transition, all 0.15s ease);
    }

    .btn-copy-ical:hover {
      background: var(--primary-color, #059669);
      color: #ffffff;
    }

    .boostinghost-ical {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 12px;
      background: #fefce8;
      border: 1px solid #facc15;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      flex-wrap: wrap;
    }

    .boostinghost-ical-label {
      font-weight: 600;
      color: #854d0e;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .boostinghost-ical-url {
      flex: 1;
      min-width: 0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      color: #713f12;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .btn-copy-boostinghost {
      border: none;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #fef3c7;
      color: #b45309;
      cursor: pointer;
      white-space: nowrap;
      transition: var(--transition, all 0.15s ease);
    }

    .btn-copy-boostinghost:hover {
      background: #facc15;
      color: #713f12;
    }

    .btn-add-property {
      background: linear-gradient(135deg, var(--primary-color, #059669) 0%, var(--accent-color, #0ea5e9) 100%);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition, all .15s ease);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: var(--shadow-sm);
      white-space: nowrap;
    }

    .btn-add-property i {
      font-size: 13px;
    }

    .btn-add-property:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    /* Modal */

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.55);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-primary, #ffffff);
      border-radius: 18px;
      max-width: 620px;
      width: 94%;
      box-shadow: var(--shadow-xl, 0 24px 60px rgba(15,23,42,.35));
      overflow: hidden;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }
    
    .modal-body {
      padding: 16px 18px 18px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-close {
      border: none;
      background: transparent;
      cursor: pointer;
      color: var(--text-secondary, #6b7280);
      padding: 4px;
    }

    .modal-close i {
      font-size: 14px;
    }

    .modal-form {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .form-grid-2 {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 12px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }

    .form-group label {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .form-group label i {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .form-group input,
    .form-group textarea {
      padding: 8px 10px;
      border: 1px solid var(--border-color, #e5e7eb);
      border-radius: 10px;
      font-size: 13px;
      font-family: inherit;
      transition: var(--transition, all .15s ease);
      background: var(--bg-secondary, #f9fafb);
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary-color, #059669);
      box-shadow: 0 0 0 1px rgba(5,150,105,.12);
      background: #ffffff;
    }

    .color-picker-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .color-picker {
      width: 52px;
      height: 32px;
      border: 1px solid var(--border-color, #e5e7eb);
      border-radius: 10px;
      cursor: pointer;
      padding: 0;
    }

    .color-preview {
      flex: 1;
      padding: 8px 10px;
      background: var(--bg-secondary, #f3f4f6);
      border-radius: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .photo-preview-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .photo-preview-box {
      width: 96px;
      height: 72px;
      border-radius: 14px;
      overflow: hidden;
      background: var(--bg-secondary, #f3f4f6);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      flex-shrink: 0;
    }

    .photo-preview-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-preview-placeholder {
      font-size: 22px;
      color: var(--text-secondary);
      opacity: 0.6;
    }

    .photo-preview-text {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .input-with-suffix {
      display: flex;
      align-items: center;
      border-radius: 10px;
      border: 1px solid var(--border-color, #e5e7eb);
      overflow: hidden;
      background: var(--bg-secondary, #f9fafb);
    }

    .input-with-suffix input {
      border: none;
      background: transparent;
      flex: 1;
      padding: 8px 10px;
    }

    .input-with-suffix span {
      padding: 8px 10px;
      font-size: 12px;
      color: var(--text-secondary);
      border-left: 1px solid var(--border-color, #e5e7eb);
      background: #f3f4f6;
    }

    .url-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .url-input-group {
      display: grid;
      grid-template-columns: 140px minmax(0, 1fr) 36px;
      gap: 6px;
      align-items: center;
    }

    .url-input-group input {
      width: 100%;
    }

    .btn-remove-url {
      background: #fee2e2;
      color: #b91c1c;
      border: none;
      width: 34px;
      height: 34px;
      border-radius: 999px;
      cursor: pointer;
      transition: var(--transition, all .15s ease);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
    }

    .btn-remove-url:hover {
      background: #dc2626;
      color: #fff;
    }

    .btn-add-url {
      background: var(--bg-secondary, #f3f4f6);
      color: var(--primary-color, #059669);
      border: none;
      padding: 7px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 500;
      font-size: 12px;
      transition: var(--transition, all .15s ease);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }

    .btn-add-url:hover {
      background: var(--primary-color, #059669);
      color: #ffffff;
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 10px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color, #e5e7eb);
      background: var(--bg-primary, #ffffff);
      position: sticky;
      bottom: 0;
      margin-left: -18px;
      margin-right: -18px;
      margin-bottom: -18px;
      padding-left: 18px;
      padding-right: 18px;
      padding-bottom: 18px;
    }

    .btn-cancel {
      background: var(--bg-secondary, #f3f4f6);
      color: var(--text-primary);
      border: none;
      padding: 8px 14px;
      border-radius: 999px;
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      transition: var(--transition, all .15s ease);
    }

    .btn-cancel:hover {
      background: var(--border-color, #e5e7eb);
    }

    .btn-save {
      background: var(--primary-color, #059669);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: var(--transition, all .15s ease);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-save:hover {
      background: #047857;
    }

    .empty-state {
      text-align: center;
      padding: 32px 12px;
      color: var(--text-secondary);
      font-size: 13px;
    }

    .empty-state i {
      font-size: 40px;
      opacity: 0.25;
      margin-bottom: 8px;
    }

    .toast-container {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 1200;
    }

    .toast {
      min-width: 220px;
      max-width: 320px;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: 0 18px 40px rgba(15,23,42,.25);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      margin-top: 8px;
      color: #0f172a;
      background: #ffffff;
    }

    .toast-success {
      border-left: 4px solid #16a34a;
    }

    .toast-error {
      border-left: 4px solid #ef4444;
    }

    .toast i {
      font-size: 14px;
    }

    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1100;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-spinner {
      background: var(--bg-primary, #fff);
      padding: 14px 16px;
      border-radius: 999px;
      box-shadow: var(--shadow-lg, 0 18px 40px rgba(15,23,42,.25));
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .loading-spinner i {
      font-size: 16px;
    }

    @media (max-width: 900px) {
      .settings-container {
        padding-top: 0;
      }

      .form-grid-2 {
        grid-template-columns: minmax(0, 1fr);
      }

      .property-header {
        flex-direction: column;
      }

      .property-photo-wrapper {
        width: 100%;
        height: 160px;
      }
    }
  </style>

  <!-- Script auth + user + logout -->
  <script src="/js/auth-fetch.js"></script>
<script>
    (function () {
      const token = localStorage.getItem('lcc_token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      const rawUser = localStorage.getItem('lcc_user');
      let user = null;

      try {
        user = rawUser ? JSON.parse(rawUser) : null;
      } catch (e) {
        console.error('Impossible de lire lcc_user', e);
      }

      window.addEventListener('DOMContentLoaded', () => {
        if (user) {
          const nameEl = document.getElementById('sidebarUserName');
          const companyEl = document.getElementById('sidebarUserCompany');
          const avatarEl = document.getElementById('sidebarUserAvatar');

          if (nameEl) {
            nameEl.textContent = user.firstName
              ? user.firstName + (user.lastName ? ' ' + user.lastName : '')
              : (user.email || 'Mon compte');
          }

          if (companyEl) {
            companyEl.textContent = user.company || 'Mon espace';
          }

          if (avatarEl) {
            const initial = (user.firstName || user.email || '?').trim()[0] || 'U';
            avatarEl.textContent = initial.toUpperCase();
          }
        }

        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', function () {
            localStorage.removeItem('lcc_token');
            localStorage.removeItem('lcc_user');
            window.location.href = '/login.html';
          });
        }
      });
    })();
  </script>
</head>
<body data-page="settings">
  <!-- MOBILE HEADER -->
  <div class="mobile-header">
    <a href="/app.html" class="mobile-logo">
      <i class="fas fa-calendar-check"></i>
      <span class="mobile-logo-text">Bookingmanage</span>
    </a>
    <button class="mobile-menu-btn" id="mobileMenuBtn">
      <i class="fas fa-bars"></i>
    </button>
  </div>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div class="app-container">

  <!-- Sidebar -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <a href="/" class="sidebar-logo">
      <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink:0;">
        <path d="M8 20V34C8 35.1046 8.89543 36 10 36H30C31.1046 36 32 35.1046 32 34V20"
              stroke="#3B82F6" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M16 36V26H24V36"
              stroke="#3B82F6" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M20 4L4 18H10V22H30V18H36L20 4Z"
              fill="#10B981" stroke="#10B981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M20 9L24 14H16L20 9Z" fill="white"/>
      </svg>

      <div class="sidebar-logo-text" style="display:flex; flex-direction:column; justify-content:center; margin-left:10px;">
        <span class="sidebar-logo-title" style="font-family:'Inter',sans-serif; font-size:17px; line-height:1.1;">
          <span style="color:#10B981; font-weight:800;">Boosting</span><span style="color:#111827; font-weight:600;">host</span>
        </span>
        <span class="sidebar-logo-subtitle" style="font-size:10px; color:#6B7280; font-weight:500; letter-spacing:0.5px;">
          Smart Property Manager
        </span>
      </div>
    </a>
  </div> <!-- ‚úÖ IMPORTANT -->

  <nav class="sidebar-nav">
    <!-- PRINCIPAL -->
    <div class="nav-section">
      <div class="nav-section-title">Principal</div>

      <a href="/app.html" class="nav-item" data-page="app">
        <i class="fas fa-th-large"></i>
        <span>Dashboard</span>
      </a>

      <a href="/app.html#calendarSection" class="nav-item" id="navCalendarLink">
        <i class="fas fa-calendar"></i>
        <span>Calendrier</span>
        <span class="nav-badge" id="navTotalReservations">0</span>
      </a>

      <a href="/messages.html" class="nav-item" data-page="messages">
        <i class="fas fa-comment-dots"></i>
        <span>Messages</span>
      </a>
    </div>

    <!-- GESTION -->
    <div class="nav-section">
      <div class="nav-section-title">Gestion</div>

      <a href="/settings.html" class="nav-item active" data-page="settings">
        <i class="fas fa-home"></i>
        <span>Mes logements</span>
      </a>

      <a href="/welcome.html" class="nav-item" data-page="welcome">
        <i class="fas fa-book-open"></i>
        <span>Livret d'accueil</span>
      </a>

      <a href="/cleaning.html" class="nav-item" data-page="cleaning">
        <i class="fas fa-broom"></i>
        <span>Gestion du m√©nage</span>
      </a>
    </div>

    <!-- FACTURATION (propre) -->
    <div class="nav-section">
      <div class="nav-section-title">Facturation</div>

      <a href="/factures.html" class="nav-item" data-page="factures">
        <i class="fas fa-file-invoice"></i>
        <span>Factures clients</span>
      </a>

      <a href="/factures-proprietaires.html" class="nav-item" data-page="factures-proprietaires">
        <i class="fas fa-file-invoice-dollar"></i>
        <span>Factures propri√©taires</span>
      </a>
    </div>

    <!-- AUTRES -->
    <div class="nav-section">
      <div class="nav-section-title">Autres</div>

      <a href="/deposits.html" class="nav-item" data-page="deposits">
        <i class="fas fa-shield-alt"></i>
        <span>Cautions</span>
      </a>

      <a href="/notifications.html" class="nav-item" data-page="notifications">
        <i class="fas fa-bell"></i>
        <span>Notifications</span>
      </a>
    </div>

    <!-- PARAM√àTRES -->
    <div class="nav-section">
      <div class="nav-section-title">Param√®tres</div>

      <a href="/settings-account.html" class="nav-item" data-page="settings-account">
        <i class="fas fa-cog"></i>
        <span>Param√®tres</span>
      </a>

      <a href="/help.html" class="nav-item" data-page="help">
        <i class="fas fa-question-circle"></i>
        <span>Aide</span>
      </a>
    </div>
  </nav>

  <div class="sidebar-footer">
    <div class="user-profile">
      <div class="user-avatar" id="sidebarUserAvatar">C</div>
      <div class="user-info">
        <div class="user-name" id="sidebarUserName">Utilisateur</div>
        <div class="user-email" id="sidebarUserCompany">Mon espace</div>
      </div>

      <button class="btn btn-ghost btn-xs" id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </div>
  </div>
</aside>


    <!-- MAIN -->
    <main class="main-content">
      <header class="main-header">
        <div class="header-left">
          <div class="page-kicker">Configuration</div>
          <h1 class="page-title">Mes logements</h1>
          <p class="page-subtitle">
            G√©rez les logements de votre conciergerie et leurs connexions iCal (Airbnb, Booking, etc.).
          </p>
        </div>

        <div class="header-actions">
          <button class="btn btn-primary" onclick="openAddPropertyModal()">
            <i class="fas fa-plus"></i>
            <span>Ajouter un logement</span>
          </button>
        </div>
      </header>

      <div class="page-content">
        <section class="card settings-container">
          <div class="properties-header">
            <h2 class="card-title" style="display:flex;align-items:center;gap:8px;font-size:15px;font-weight:600;">
              <i class="fas fa-home"></i>
              <span>Logements configur√©s</span>
            </h2>
          </div>

          <div class="properties-grid" id="propertiesGrid">
            <!-- Logements inject√©s ici par settings.js -->
          </div>

          <div class="empty-state" id="propertiesEmptyState" style="display:none;">
            <i class="fas fa-home"></i>
            <p>Aucun logement configur√© pour le moment.</p>
            <p>Commencez par ajouter votre premier logement.</p>
          </div>

          <div style="margin-top:10px;">
            <button class="btn-add-property" onclick="openAddPropertyModal()">
              <i class="fas fa-plus"></i>
              Ajouter un logement
            </button>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- MODAL: √âditer / Ajouter un logement -->
  <div class="modal" id="editPropertyModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">
          <i class="fas fa-home"></i>
          <span>Modifier le logement</span>
        </h2>
        <button class="modal-close" onclick="closeEditModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form class="modal-form" id="propertyForm" onsubmit="saveProperty(event)">
          <input type="hidden" id="propertyId">
          <input type="hidden" id="propertyPhotoUrl">

          <div class="form-grid-2">
            <div class="form-group">
              <label for="propertyName">
                <i class="fas fa-home"></i>
                <span>Nom du logement</span>
              </label>
              <input type="text" id="propertyName" required placeholder="Ex: Saint-Gratien - RDC">
            </div>
<div class="form-group">
  <label for="propertyOwnerId">
    <i class="fas fa-user"></i>
    <span>Propri√©taire (optionnel)</span>
  </label>
  <select id="propertyOwnerId" class="form-control">
    <option value="">Aucun propri√©taire</option>
    <!-- Options remplies dynamiquement -->
  </select>
  <small style="display:block;margin-top:4px;font-size:12px;color:#64748b;">
    Lier ce logement √† un client propri√©taire
  </small>
</div>
            <div class="form-group">
              <label for="propertyAddress">
                <i class="fas fa-location-dot"></i>
                <span>Adresse</span>
              </label>
              <input type="text" id="propertyAddress" placeholder="Ex : 25 boulevard de la R√©publique, Saint-Gratien">
            </div>
          </div>

          <div class="form-grid-2">
            <div class="form-group">
              <label for="propertyArrivalTime">
                <i class="fas fa-sign-in-alt"></i>
                <span>Heure d‚Äôarriv√©e</span>
              </label>
              <input type="time" id="propertyArrivalTime" placeholder="16:00">
            </div>

            <div class="form-group">
              <label for="propertyDepartureTime">
                <i class="fas fa-sign-out-alt"></i>
                <span>Heure de d√©part</span>
              </label>
              <input type="time" id="propertyDepartureTime" placeholder="11:00">
            </div>
          </div>

          <div class="form-grid-2">
            <div class="form-group">
              <label for="propertyDeposit">
                <i class="fas fa-shield-alt"></i>
                <span>Montant de la caution</span>
              </label>
              <div class="input-with-suffix">
                <input type="number" id="propertyDeposit" min="0" step="1" placeholder="Laisser vide si aucune">
                <span>‚Ç¨</span>
              </div>
            </div>

            <div class="form-group">
              <label for="propertyColor">
                <i class="fas fa-palette"></i>
                <span>Couleur</span>
              </label>
              <div class="color-picker-wrapper">
                <input type="color" id="propertyColor" class="color-picker" value="#E67E50">
                <div class="color-preview" id="colorPreview">#E67E50</div>
              </div>
            </div>
          </div>

          <!-- ‚úÖ SECTION : LIVRET D'ACCUEIL -->
          <div class="form-group">
            <label for="propertyWelcomeBookUrl">
              <i class="fas fa-book"></i>
              <span>URL du livret d'accueil</span>
            </label>
            <input 
              type="url" 
              id="propertyWelcomeBookUrl" 
              placeholder="https://monsite.com/livret-appartement-paris">
            <small style="display:block;margin-top:4px;font-size:12px;color:#64748b;">
              Lien vers le livret d'accueil que vous avez cr√©√© pour vos voyageurs
            </small>
          </div>

          <!-- ‚úÖ SECTION : ACC√àS AU LOGEMENT -->
          <div class="form-group">
            <label for="propertyAccessCode">
              <i class="fas fa-key"></i>
              <span>Code d'acc√®s</span>
            </label>
            <input 
              type="text" 
              id="propertyAccessCode" 
              placeholder="Ex: 1234# ou code bo√Æte √† cl√©s">
            <small style="display:block;margin-top:4px;font-size:12px;color:#64748b;">
              Code de la serrure connect√©e ou de la bo√Æte √† cl√©s
            </small>
          </div>

          <div class="form-group">
            <label for="propertyAccessInstructions">
              <i class="fas fa-route"></i>
              <span>Instructions d'acc√®s</span>
            </label>
            <textarea 
              id="propertyAccessInstructions" 
              rows="3" 
              placeholder="Ex: Prenez l'ascenseur jusqu'au 3√®me √©tage, porte √† droite..."></textarea>
            <small style="display:block;margin-top:4px;font-size:12px;color:#64748b;">
              D√©tails pour acc√©der au logement (√©tage, porte, etc.)
            </small>
          </div>

          <!-- ‚úÖ SECTION : WIFI -->
          <div class="form-grid-2">
            <div class="form-group">
              <label for="propertyWifiName">
                <i class="fas fa-wifi"></i>
                <span>Nom du r√©seau WiFi</span>
              </label>
              <input 
                type="text" 
                id="propertyWifiName" 
                placeholder="Ex: FreeWiFi_Secure">
            </div>

            <div class="form-group">
              <label for="propertyWifiPassword">
                <i class="fas fa-lock"></i>
                <span>Mot de passe WiFi</span>
              </label>
              <input 
                type="text" 
                id="propertyWifiPassword" 
                placeholder="Ex: MonMotDePasse123">
            </div>
          </div>

          <div class="form-group">
            <label for="propertyPhoto">
              <i class="fas fa-image"></i>
              <span>Photo du logement</span>
            </label>
            <div class="photo-preview-wrapper">
              <div class="photo-preview-box" id="photoPreviewBox">
                <span class="photo-preview-placeholder" id="photoPreviewPlaceholder">
                  <i class="fas fa-image"></i>
                </span>
              </div>
              <div>
                <input type="file" id="propertyPhoto" accept="image/*">
                <div class="photo-preview-text">
                  Ajoutez une photo pour la vignette de la carte logement.
                </div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label>
              <i class="fas fa-link"></i>
              <span>URLs iCal (Airbnb, Booking, etc.)</span>
            </label>
            <div class="url-list" id="urlList">
              <!-- URLs ajout√©es ici via JS -->
            </div>
            <button type="button" class="btn-add-url" onclick="addUrlField()">
              <i class="fas fa-plus"></i>
              <span>Ajouter une URL iCal</span>
            </button>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-cancel" onclick="closeEditModal()">Annuler</button>
            <button type="submit" class="btn-save">
              <i class="fas fa-save"></i>
              <span>Enregistrer</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast & Loading -->
  <div class="toast-container" id="toastContainer"></div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Chargement...</p>
    </div>
  </div>

  <!-- JS page -->
  <script src="/js/settings.js"></script>

  <!-- MOBILE MENU SCRIPT + nav active -->
  <script>
    (function() {
      const menuBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      if (menuBtn && sidebar && overlay) {
        menuBtn.addEventListener('click', function() {
          sidebar.classList.toggle('active');
          overlay.classList.toggle('active');
          const icon = menuBtn.querySelector('i');
          if (sidebar.classList.contains('active')) {
            icon.classList.remove('fa-bars');
            icon.classList.add('fa-times');
          } else {
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
          }
        });

        overlay.addEventListener('click', function() {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          const icon = menuBtn.querySelector('i');
          icon.classList.remove('fa-times');
          icon.classList.add('fa-bars');
        });

        if (window.innerWidth <= 1024) {
          document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
              sidebar.classList.remove('active');
              overlay.classList.remove('active');
              const icon = menuBtn.querySelector('i');
              icon.classList.remove('fa-times');
              icon.classList.add('fa-bars');
            });
          });
        }
      }
    })();

    (function() {
      const currentPage = document.body.getAttribute('data-page');
      if (currentPage) {
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.remove('active');
        });
        const activeLink = document.querySelector('.nav-item[data-page="' + currentPage + '"]');
        if (activeLink) {
          activeLink.classList.add('active');
        }
      }
    })();
  </script>
    <!-- üÜï PATCH OWNER_ID -->
  <script>
  // ============================================
// PATCH AM√âLIOR√â : Correction du owner_id
// Remplace le patch pr√©c√©dent par celui-ci
// ============================================

(function() {
  console.log('üîß Patch owner_id V2 activ√©');

  // ============================================
  // 1. CHARGER LES PROPRI√âT√âS
  // ============================================
  async function loadAllProperties() {
    try {
      const token = localStorage.getItem('lcc_token');
      if (!token) return;

      const res = await fetch('https://lcc-booking-manager.onrender.com/api/properties', {
        headers: { 
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        }
      });

      if (!res.ok) {
        console.warn('Impossible de charger les propri√©t√©s');
        return;
      }

      const data = await res.json();
      const properties = data.properties || [];
      
      // Stocker en global
      window.allProperties = properties;
      
      console.log('‚úÖ Propri√©t√©s charg√©es:', properties.length);
      
    } catch (err) {
      console.error('‚ùå Erreur chargement propri√©t√©s:', err);
    }
  }

  // ============================================
  // 2. CHARGER LA LISTE DES PROPRI√âTAIRES
  // ============================================
  async function loadOwnerClients() {
    try {
      const token = localStorage.getItem('lcc_token');
      if (!token) return;

      const res = await fetch('https://lcc-booking-manager.onrender.com/api/owner-clients', {
        headers: { 
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        }
      });

      if (!res.ok) {
        console.warn('Impossible de charger les propri√©taires');
        return;
      }

      const data = await res.json();
      const clients = data.clients || [];
      
      console.log('‚úÖ Propri√©taires charg√©s:', clients.length);
      
      // Stocker en global pour r√©utilisation
      window.ownerClients = clients;
      
      // Remplir le select
      fillOwnerSelect(clients);
      
    } catch (err) {
      console.error('‚ùå Erreur chargement propri√©taires:', err);
    }
  }

  // ============================================
  // 3. REMPLIR LE SELECT AVEC LES PROPRI√âTAIRES
  // ============================================
  function fillOwnerSelect(clients) {
    const select = document.getElementById('propertyOwnerId');
    if (!select) {
      console.warn('Select propertyOwnerId introuvable');
      return;
    }

    // Vider les options existantes (sauf la premi√®re "Aucun propri√©taire")
    select.innerHTML = '<option value="">Aucun propri√©taire</option>';
    
    // Ajouter chaque propri√©taire
    clients.forEach(client => {
      const option = document.createElement('option');
      option.value = client.id;
      option.textContent = client.name || client.email || `Propri√©taire ${client.id}`;
      select.appendChild(option);
    });
    
    console.log('‚úÖ Select rempli avec', clients.length, 'propri√©taires');
  }

  // ============================================
  // 4. INTERCEPTER L'OUVERTURE DU MODAL
  // ============================================
  
  // Surveiller les changements sur le modal
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      const modal = document.getElementById('editPropertyModal');
      if (modal && modal.classList.contains('active')) {
        onModalOpened();
      }
    });
  });

  // D√©marrer l'observation
  window.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('editPropertyModal');
    if (modal) {
      observer.observe(modal, { 
        attributes: true, 
        attributeFilter: ['class'] 
      });
    }
  });

  // Fonction appel√©e quand le modal s'ouvre
  function onModalOpened() {
    console.log('üìù Modal ouvert, pr√©-remplissage owner_id...');
    
    // Attendre un peu que le modal soit compl√®tement rempli
    setTimeout(() => {
      // R√©cup√©rer l'ID de la propri√©t√© en cours d'√©dition
      const propertyIdInput = document.getElementById('propertyId');
      if (!propertyIdInput || !propertyIdInput.value) {
        console.log('Aucune propri√©t√© en cours d\'√©dition');
        return;
      }

      const propertyId = propertyIdInput.value;
      
      // Trouver la propri√©t√© dans la liste globale
      const allProperties = window.allProperties || [];
      
      // Chercher avec plusieurs formats d'ID possibles
      let property = allProperties.find(p => String(p.id) === String(propertyId));
      
      // Si pas trouv√©, essayer avec property_id
      if (!property) {
        property = allProperties.find(p => String(p.property_id) === String(propertyId));
      }
      
      // Si toujours pas trouv√©, logger pour debug
      if (!property) {
        console.warn('Propri√©t√©', propertyId, 'introuvable dans allProperties');
        console.log('IDs disponibles:', allProperties.map(p => p.id));
        // On continue quand m√™me, le select reste vide c'est pas grave
        return;
      }

      // Pr√©-remplir le select avec owner_id
      const select = document.getElementById('propertyOwnerId');
      if (select && property.owner_id) {
        select.value = property.owner_id;
        console.log('‚úÖ owner_id pr√©-rempli:', property.owner_id);
      } else if (select) {
        select.value = '';
        console.log('‚úÖ Aucun propri√©taire pour cette propri√©t√©');
      }
    }, 100);
  }

  // ============================================
  // 5. INTERCEPTER LA SAUVEGARDE
  // ============================================
  
  // Sauvegarder la fonction saveProperty originale
  const originalSaveProperty = window.saveProperty;
  
  // Remplacer par une version am√©lior√©e
  window.saveProperty = async function(event) {
    if (event) event.preventDefault();
    
    console.log('üíæ Sauvegarde de la propri√©t√©...');
    
    // R√©cup√©rer la valeur du select owner_id
    const ownerSelect = document.getElementById('propertyOwnerId');
    const ownerId = ownerSelect ? ownerSelect.value : null;
    
    console.log('üìå owner_id s√©lectionn√©:', ownerId || '(aucun)');
    
    // Si la fonction originale existe, l'appeler
    if (typeof originalSaveProperty === 'function') {
      // Ajouter l'ownerId avant d'appeler la fonction originale
      // On va intercepter le fetch
      interceptNextFetch(ownerId);
      return originalSaveProperty(event);
    }
    
    // Sinon, faire la sauvegarde nous-m√™mes
    return savePropertyManually(ownerId);
  };

  // ============================================
  // 6. INTERCEPTER LE FETCH POUR AJOUTER OWNER_ID
  // ============================================
  let nextFetchOwnerId = null;
  
  function interceptNextFetch(ownerId) {
    nextFetchOwnerId = ownerId;
  }

  // Sauvegarder le fetch original
  const originalFetch = window.fetch;
  
  // Remplacer fetch pour intercepter les requ√™tes vers /api/properties
  window.fetch = async function(...args) {
    const [url, options] = args;
    
    // Si c'est une requ√™te vers /api/properties avec un body
    if (url && url.includes('/api/properties') && options && options.body) {
      try {
        const body = JSON.parse(options.body);
        
        // Si on a un ownerId en attente, l'ajouter
        if (nextFetchOwnerId !== null) {
          body.ownerId = nextFetchOwnerId || null;
          options.body = JSON.stringify(body);
          console.log('‚úÖ owner_id ajout√© √† la requ√™te:', body.ownerId);
          nextFetchOwnerId = null; // Reset
        }
      } catch (e) {
        // Si le body n'est pas JSON, on ignore
      }
    }
    
    // Appeler le fetch original
    return originalFetch.apply(this, args);
  };

  // ============================================
  // 7. SAUVEGARDE MANUELLE (fallback)
  // ============================================
  async function savePropertyManually(ownerId) {
    const token = localStorage.getItem('lcc_token');
    if (!token) {
      alert('Non authentifi√©');
      return;
    }

    const propertyId = document.getElementById('propertyId').value;
    const name = document.getElementById('propertyName').value;
    const color = document.getElementById('propertyColor').value;
    const address = document.getElementById('propertyAddress').value;
    const arrivalTime = document.getElementById('propertyArrivalTime').value;
    const departureTime = document.getElementById('propertyDepartureTime').value;
    const deposit = document.getElementById('propertyDeposit').value;
    const photoUrl = document.getElementById('propertyPhotoUrl').value;
    const welcomeBookUrl = document.getElementById('propertyWelcomeBookUrl').value;
    const accessCode = document.getElementById('propertyAccessCode').value;
    const accessInstructions = document.getElementById('propertyAccessInstructions').value;
    const wifiName = document.getElementById('propertyWifiName').value;
    const wifiPassword = document.getElementById('propertyWifiPassword').value;

    const payload = {
      name,
      color,
      address: address || null,
      arrival_time: arrivalTime || null,
      departure_time: departureTime || null,
      deposit_amount: deposit ? parseFloat(deposit) : null,
      photo_url: photoUrl || null,
      welcome_book_url: welcomeBookUrl || null,
      access_code: accessCode || null,
      access_instructions: accessInstructions || null,
      wifi_name: wifiName || null,
      wifi_password: wifiPassword || null,
      ownerId: ownerId || null  // üÜï AJOUT DU OWNER_ID
    };

    console.log('üì¶ Payload envoy√©:', payload);

    try {
      const url = propertyId 
        ? `https://lcc-booking-manager.onrender.com/api/properties/${propertyId}`
        : 'https://lcc-booking-manager.onrender.com/api/properties';
      
      const method = propertyId ? 'PUT' : 'POST';

      const res = await fetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.error || data.message || 'Erreur serveur');
      }

      console.log('‚úÖ Propri√©t√© sauvegard√©e avec owner_id');
      alert('‚úÖ Propri√©t√© sauvegard√©e avec succ√®s !');
      
      // Fermer le modal
      if (typeof closeEditModal === 'function') {
        closeEditModal();
      }
      
      // Recharger la page
      location.reload();

    } catch (err) {
      console.error('‚ùå Erreur sauvegarde:', err);
      alert('‚ùå Erreur : ' + err.message);
    }
  }

  // ============================================
  // 8. INITIALISATION AU CHARGEMENT
  // ============================================
  window.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initialisation du patch owner_id V2');
    
    // Charger les propri√©t√©s ET les propri√©taires
    Promise.all([
      loadAllProperties(),
      loadOwnerClients()
    ]).then(() => {
      console.log('‚úÖ Toutes les donn√©es charg√©es');
    });
    
    // Recharger √† chaque fois que la page des propri√©taires est affich√©e
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        loadAllProperties();
        loadOwnerClients();
      }
    });
  });

  // ============================================
  // 9. EXPOSER LES FONCTIONS POUR DEBUG
  // ============================================
  window.debugOwnerPatch = {
    loadAllProperties,
    loadOwnerClients,
    fillOwnerSelect,
    properties: () => window.allProperties,
    clients: () => window.ownerClients
  };

  console.log('‚úÖ Patch owner_id V2 install√© avec succ√®s');
  console.log('üí° Debug disponible via window.debugOwnerPatch');

})();
    </script>
</body>
</html>
