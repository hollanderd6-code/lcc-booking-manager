// cron/auto-release-deposits.js
// ============================================
// ü§ñ LIB√âRATION AUTOMATIQUE DES CAUTIONS
// ============================================
// Tourne tous les jours √† 10h :
// - J+6 : Envoie notification push d'avertissement
// - J+7 : Lib√®re automatiquement la caution

const { sendNotification } = require('../services/notifications-service');

/**
 * Fonction principale du cron
 * @param {Pool} pool - PostgreSQL pool
 * @param {Function} releaseDeposit - Fonction pour lib√©rer une caution
 */
async function checkAndReleaseDeposits(pool, releaseDeposit) {
  console.log('ü§ñ [CRON] V√©rification des cautions √† lib√©rer...');
  
  try {
    const now = new Date();
    
    // ============================================
    // 1Ô∏è‚É£ CAUTIONS √Ä LIB√âRER (J+7)
    // ============================================
    
    // R√©cup√©rer les cautions qui ont plus de 7 jours
    const depositsToRelease = await pool.query(`
      SELECT d.*, p.name as property_name
      FROM deposits d
      LEFT JOIN properties p ON d.property_id = p.id
      WHERE d.status = 'authorized'
        AND d.created_at <= NOW() - INTERVAL '7 days'
    `);
    
    console.log(`üìä [CRON] ${depositsToRelease.rows.length} cautions √† lib√©rer`);
    
    for (const deposit of depositsToRelease.rows) {
      try {
        console.log(`üîì [CRON] Lib√©ration caution ${deposit.id}...`);
        
        // Lib√©rer la caution
        const success = await releaseDeposit(deposit.id);
        
        if (success) {
          console.log(`‚úÖ [CRON] Caution ${deposit.id} lib√©r√©e automatiquement`);
          
          // Envoyer notification push au propri√©taire
          try {
            const tokensResult = await pool.query(
              'SELECT fcm_token FROM user_fcm_tokens WHERE user_id = $1',
              [deposit.user_id]
            );
            
            if (tokensResult.rows.length > 0) {
              const propertyName = deposit.property_name || 'Votre logement';
              const amount = (deposit.amount_cents / 100).toFixed(2);
              
              await sendNotification(
                tokensResult.rows[0].fcm_token,
                '‚úÖ Caution lib√©r√©e',
                `${propertyName} - ${amount}‚Ç¨ lib√©r√©s automatiquement apr√®s 7 jours`,
                {
                  type: 'deposit_auto_released',
                  deposit_id: deposit.id,
                  property_name: propertyName,
                  amount_cents: deposit.amount_cents
                }
              );
              
              console.log(`üì≤ [CRON] Notification envoy√©e pour caution ${deposit.id}`);
            }
          } catch (notifError) {
            console.error(`‚ùå [CRON] Erreur notification lib√©ration ${deposit.id}:`, notifError.message);
          }
        } else {
          console.error(`‚ùå [CRON] √âchec lib√©ration caution ${deposit.id}`);
        }
      } catch (err) {
        console.error(`‚ùå [CRON] Erreur traitement caution ${deposit.id}:`, err);
      }
    }
    
    // ============================================
    // 2Ô∏è‚É£ RAPPELS AVANT LIB√âRATION (J+6)
    // ============================================
    
    // R√©cup√©rer les cautions qui ont 6 jours (lib√©ration demain)
    const depositsToRemind = await pool.query(`
      SELECT d.*, p.name as property_name
      FROM deposits d
      LEFT JOIN properties p ON d.property_id = p.id
      WHERE d.status = 'authorized'
        AND d.created_at <= NOW() - INTERVAL '6 days'
        AND d.created_at > NOW() - INTERVAL '7 days'
        AND (d.reminder_sent IS NULL OR d.reminder_sent = FALSE)
    `);
    
    console.log(`üìä [CRON] ${depositsToRemind.rows.length} rappels √† envoyer`);
    
    for (const deposit of depositsToRemind.rows) {
      try {
        console.log(`‚è∞ [CRON] Envoi rappel caution ${deposit.id}...`);
        
        // R√©cup√©rer les tokens FCM du propri√©taire
        const tokensResult = await pool.query(
          'SELECT fcm_token FROM user_fcm_tokens WHERE user_id = $1',
          [deposit.user_id]
        );
        
        if (tokensResult.rows.length > 0) {
          const propertyName = deposit.property_name || 'Votre logement';
          const amount = (deposit.amount_cents / 100).toFixed(2);
          
          await sendNotification(
            tokensResult.rows[0].fcm_token,
            '‚è∞ Rappel caution',
            `${propertyName} - La caution de ${amount}‚Ç¨ sera lib√©r√©e demain √† 10h`,
            {
              type: 'deposit_reminder',
              deposit_id: deposit.id,
              property_name: propertyName,
              amount_cents: deposit.amount_cents,
              release_time: 'demain √† 10h'
            }
          );
          
          // Marquer le rappel comme envoy√©
          await pool.query(
            'UPDATE deposits SET reminder_sent = TRUE WHERE id = $1',
            [deposit.id]
          );
          
          console.log(`‚úÖ [CRON] Rappel envoy√© pour caution ${deposit.id}`);
        } else {
          console.log(`‚ö†Ô∏è  [CRON] Pas de token FCM pour user ${deposit.user_id}`);
        }
      } catch (err) {
        console.error(`‚ùå [CRON] Erreur rappel caution ${deposit.id}:`, err);
      }
    }
    
    console.log('‚úÖ [CRON] V√©rification termin√©e');
    
  } catch (error) {
    console.error('‚ùå [CRON] Erreur globale:', error);
  }
}

module.exports = { checkAndReleaseDeposits };
